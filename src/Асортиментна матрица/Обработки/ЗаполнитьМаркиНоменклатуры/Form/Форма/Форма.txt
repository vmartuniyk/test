
&НаКлиенте
Процедура ВыполнитьКоманду(Команда)
	СписокНоменклатуры.Очистить();
	ЗаполнитьМаркуБрендНаСервере();
КонецПроцедуры

&НаСервере
Процедура ЗаполнитьМаркуБрендНаСервере()
	УстановитьПривилегированныйРежим(Истина);
	Запрос = Новый Запрос(ПолучитьТекстЗапроса());
	РезультатЗапроса = Запрос.Выполнить();
	ВыборкаИзРезультатаЗапроса = РезультатЗапроса.Выбрать();
	
	Пока ВыборкаИзРезультатаЗапроса.Следующий() Цикл  
		ДокументСсылка = ВыборкаИзРезультатаЗапроса.Ссылка;
		ДокументОбъект = ДокументСсылка.ПолучитьОбъект();
		Если Не ВыборкаИзРезультатаЗапроса.Марка = Справочники.Марки.ПустаяСсылка() Тогда 
			ДокументОбъект.Марка = ВыборкаИзРезультатаЗапроса.Марка;
		Иначе 
			Марка = СоздатьМаркуБрендСправочник(ВыборкаИзРезультатаЗапроса.Производитель);
			ДокументОбъект.Марка = Марка;
		КонецЕсли;
		
		Если ДокументОбъект.Марка.Пустая() Тогда 
			СписокНоменклатуры.Добавить(ДокументСсылка, "Проверте марку/бренд номенклатуры");
			Продолжить;
		КонецЕсли;
		
		Попытка
			ДокументОбъект.Записать();	
		Исключение
			СписокНоменклатуры.Добавить(ДокументСсылка, ОписаниеОшибки());
		КонецПопытки;
	КонецЦикла;
КонецПроцедуры

&НаСервере
Функция ПолучитьТекстЗапроса()
	ТекстЗапроса =
		"ВЫБРАТЬ  ПЕРВЫЕ 100
		|	Номенклатура.Ссылка 											КАК Ссылка,
		|	Номенклатура.Производитель										КАК Производитель,
		|	ЕСТЬNULL(Марки.Ссылка, ЗНАЧЕНИЕ(Справочник.Марки.ПустаяСсылка))	КАК Марка
		|ИЗ
		|	Справочник.Номенклатура КАК Номенклатура
		|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.Марки КАК Марки
		|		ПО Номенклатура.Производитель = Марки.Производитель
		|			И (НЕ Марки.ПометкаУдаления)
		|ГДЕ
		|	НЕ Номенклатура.ПометкаУдаления
		|	И НЕ Номенклатура.ЭтоГруппа
		|	И НЕ Номенклатура.Производитель = ЗНАЧЕНИЕ(Справочник.Производители.ПустаяСсылка)
		|	И Номенклатура.Марка = ЗНАЧЕНИЕ(Справочник.Марки.ПустаяСсылка)";
	Возврат ТекстЗапроса;
КонецФункции

&НаСервере
Функция  СоздатьМаркуБрендСправочник(Источник)
	
	НовыйЭлементСправочника 				= Справочники.Марки.СоздатьЭлемент();
	НовыйЭлементСправочника.Наименование	= Источник.Наименование;
	НовыйЭлементСправочника.Производитель	= Источник.Ссылка;
	
	Попытка
		НовыйЭлементСправочника.Записать();
	Исключение
	КонецПопытки;
	
	Возврат ?(Не НовыйЭлементСправочника.Ссылка.Пустая(), НовыйЭлементСправочника.Ссылка, Справочники.Марки.ПустаяСсылка());
	
КонецФункции
