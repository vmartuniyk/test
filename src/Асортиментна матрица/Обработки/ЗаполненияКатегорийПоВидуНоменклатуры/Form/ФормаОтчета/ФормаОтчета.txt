
&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	СформироватьОтчетНаСервере();
КонецПроцедуры

&НаСервере
Процедура СформироватьОтчетНаСервере()
	УстановитьПривилегированныйРежим(Истина);
	Результат.Очистить();
	
	Запрос 			= Новый Запрос;
	Запрос.Текст 	= СформироватьТексЗапроса();
	РезультатЗапроса= Запрос.Выполнить();
	Если НЕ РезультатЗапроса.Пустой() Тогда
		ВывестиРезультатыЗапроса(РезультатЗапроса.Выгрузить());
	КонецЕсли;	
КонецПроцедуры // СформироватьОтчетНаСервере()


&НаСервере
Функция СформироватьТексЗапроса()
	ТекстЗапроса ="	ВЫБРАТЬ
	|		КОЛИЧЕСТВО(РАЗЛИЧНЫЕ Номенклатура.Ссылка) КАК Количество,
	|		Номенклатура.Наименование
	|	ПОМЕСТИТЬ КешНоменклатура
	|	ИЗ
	|		Справочник.Номенклатура КАК Номенклатура
	|	ГДЕ
	|		НЕ Номенклатура.ПометкаУдаления
	|		И НЕ Номенклатура.ЭтоГруппа

	|	СГРУППИРОВАТЬ ПО
	|		Номенклатура.Наименование
	|	;

	|	////////////////////////////////////////////////////////////////////////////////
	|	ВЫБРАТЬ
	|		Ном.Код,
	|		Ном.Ссылка КАК Номенклатура,
	|		КешНоменклатура.Наименование,
	|		КешНоменклатура.Количество КАК КоличествоКлонов,
	|		ЕСТЬNULL(СвободныеОстаткиОстатки.ВНаличииОстаток, 0) КАК СвОст
	|	ИЗ
	|		Справочник.Номенклатура КАК Ном
	|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ КешНоменклатура КАК КешНоменклатура
	|			ПО Ном.Наименование = КешНоменклатура.Наименование
	|			ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.СвободныеОстатки.Остатки КАК СвободныеОстаткиОстатки
	|			ПО Ном.Ссылка = СвободныеОстаткиОстатки.Номенклатура
	|	ГДЕ
	|		КешНоменклатура.Количество > 1";		
   Возврат ТекстЗапроса;
	
КонецФункции



&НаСервере
Процедура ВывестиРезультатыЗапроса(СписокНоменклатуры)
	
	ВнешниеНаборыДанных = Новый Структура;
	ВнешниеНаборыДанных.Вставить("СписокНоменклатуры", СписокНоменклатуры);
	
	ОбъектОбработки 		= РеквизитФормыВЗначение("Объект");
	СхемаКомпоновкиДанных   = ОбъектОбработки.ПолучитьМакет("КлоныНоменклатуры");
	ЗначениеВРеквизитФормы(ОбъектОбработки, "Объект");
	
	Настройки 					= СхемаКомпоновкиДанных.НастройкиПоУмолчанию;
	
	КомпоновщикМакета 			= Новый КомпоновщикМакетаКомпоновкиДанных;
	ДанныеРасшифровки			= Новый ДанныеРасшифровкиКомпоновкиДанных;
	МакетКомпоновки				= КомпоновщикМакета.Выполнить(СхемаКомпоновкиДанных, Настройки, ДанныеРасшифровки);
	
	ПроцессорКомпоновкиДанны    = Новый ПроцессорКомпоновкиДанных;
	ПроцессорКомпоновкиДанны.Инициализировать(МакетКомпоновки, ВнешниеНаборыДанных, ДанныеРасшифровки);
	
	ПроцессорВывода				= Новый ПроцессорВыводаРезультатаКомпоновкиДанныхВТабличныйДокумент;
	ПроцессорВывода.УстановитьДокумент(Результат);
	ПроцессорВывода.Вывести(ПроцессорКомпоновкиДанны);
	
КонецПроцедуры
