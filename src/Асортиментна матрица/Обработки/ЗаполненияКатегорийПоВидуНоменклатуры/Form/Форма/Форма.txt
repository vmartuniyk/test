&НаКлиенте
Процедура ПриОткрытии(Отказ)
	Элементы.ГруппаДляРучногоОтбора.Видимость 	= 	Истина;
	Элементы.ГруппаАвтоЗаполнения.Видимость		=	Ложь;
	Элементы.ГруппаТаблицаСписок.Видимость		=	Ложь;
КонецПроцедуры

///////////////////////////////////////////////////////////////////////////////////////
// ФУНКЦИИ ДЛЯ ОБРАБОТКИ  ЭЛЕМЕНТОВ ФОРМЫ
 
&НаКлиенте
Процедура ТоварнаяКатегорияПриИзменении(Элемент)
	ТоварнаяКатегорияПриИзмененииНаСервере();
КонецПроцедуры

&НаКлиенте
Процедура ВсяНоменклатураБезКатегорииПриИзменении(Элемент)
	ВидНоменклатурыПриИзмененииНаСервере();	
КонецПроцедуры

&НаКлиенте
Процедура ПоискПриИзменении(Элемент)
	ВидНоменклатурыПриИзмененииНаСервере();	
КонецПроцедуры

&НаКлиенте
Процедура ОтборПоКатегориямПриИзменении(Элемент)
	ВидНоменклатурыПриИзмененииНаСервере();
КонецПроцедуры

&НаКлиенте
Процедура АвтоЗаполнения(Команда)
	АвтоЗаполненияНаСервере();
КонецПроцедуры



/////////////////////////////////////////////
//КОМАНДЫ ФОРМЫ
&НаКлиенте
Процедура УстановитьФлаги(Команда)
	УстановитьФлагиНаСервере(Истина);
КонецПроцедуры
&НаКлиенте
Процедура СнятьВсеФлаги(Команда)
	УстановитьФлагиНаСервере(Ложь);
КонецПроцедуры
&НаКлиенте
Процедура Заполнить(Команда)
	ЗаполнитьНаСервере();
КонецПроцедуры

&НаКлиенте
Процедура Обновить(Команда)
	ОбновитьНаСервере();
КонецПроцедуры


/////////////////////////////////////////////
// СЛУЖЕБНЫЕ ФУНКЦИИЯ
//НА СЕРВЕРЕ
&НаСервере
Процедура ВидНоменклатурыПриИзмененииНаСервере()
	Запрос			= Новый Запрос;
	ТекстЗапроса	= ПолучитьТекстЗапроса();
	Отбор			= ?(ОтборПоКатегориям,"И  Номенклатура.ТоварнаяКатегория=Значение(Справочник.ТоварныеКатегории.ПустаяСсылка)", "");
	Если ЗначениеЗаполнено(НайтиСтроку) Тогда
		ТекстЗапроса    = СтрЗаменить(ТекстЗапроса,"%Отбор%",Отбор+"И Номенклатура.Наименование ПОДОБНО ""%"+НайтиСтроку+"%""") ;
	Иначе 
		ТекстЗапроса    = СтрЗаменить(ТекстЗапроса,"%Отбор%",Отбор+" ");
	КонецЕсли;
	
	Запрос.Текст	=  ТекстЗапроса;
	Запрос.УстановитьПараметр("ВидНоменклатуры",ВидНоменклатуры);

	Результат				= Запрос.Выполнить(); 
	СписокНоменклатуры		= Таблица.НайтиСтроки(Новый Структура("Флаг",Ложь));
	
	Если НЕ Результат.Пустой() Тогда 
		Таблица.Загрузить(Результат.Выгрузить());
	КонецЕсли;
	

	Если НЕ СписокНоменклатуры.Количество()>0 Тогда
		 УстановитьФлагиНаСервере(Истина);
	КонецЕсли;
	
КонецПроцедуры
&НаСервере
Функция ПолучитьТекстЗапроса()
	ТекстЗапроса= "ВЫБРАТЬ
	              |	Номенклатура.Ссылка КАК Номенклатура,
	              |	Номенклатура.ТоварнаяКатегория как ТоварнаяКатегория
	         	  |ИЗ
	              |	Справочник.Номенклатура КАК Номенклатура
	              |ГДЕ
			 	  |	Номенклатура.ВидНоменклатуры = &ВидНоменклатуры
	              |	И НЕ Номенклатура.ПометкаУдаления
				  |	И Номенклатура.ЭтоГруппа = ЛОЖЬ 
				  | %Отбор%";
	Возврат ТекстЗапроса;
КонецФункции // ПолучитьТекстЗапроса()


&НаСервере
Процедура ТоварнаяКатегорияПриИзмененииНаСервере()
	Если ТоварнаяКатегория.Владелец<>Неопределено Тогда
		ВидНоменклатуры =  ТоварнаяКатегория.Владелец;
		ОтборПоКатегориям = Истина;
	КонецЕсли;
	ВидНоменклатурыПриИзмененииНаСервере();
КонецПроцедуры


&НаСервере
Процедура УстановитьФлагиНаСервере(Флаг)
	Для каждого Строка Из Таблица Цикл
		Строка.Флаг =Флаг;
	КонецЦикла;
	КонецПроцедуры

&НаСервере
Процедура ЗаполнитьНаСервере()
	СписокНоменклатуры = Таблица.НайтиСтроки(Новый Структура("Флаг",Истина));
	Для каждого Строка Из СписокНоменклатуры  Цикл
			НоменклатураСсылка					=	Строка.Номенклатура;
			СправочникОбъект					=	НоменклатураСсылка.ПолучитьОбъект();
			СправочникОбъект.ТоварнаяКатегория  =	ТоварнаяКатегория;
			Попытка
        		СправочникОбъект.Записать();
			Исключение
				 Сообщить("Не удалось записать объект " + НоменклатураСсылка + "",СтатусСообщения.Внимание);
		    КонецПопытки;
	КонецЦикла;
	ВидНоменклатурыПриИзмененииНаСервере();
КонецПроцедуры


&НаСервере
Процедура ОбновитьНаСервере()
	ВидНоменклатурыПриИзмененииНаСервере();	
КонецПроцедуры


///////////////////////////////////////////////////////////////////////////////////////////////
//АВТОЗАПОЛЕНИЯ

&НаСервере
Процедура АвтоЗаполненияНаСервере()
	Если ПустаяСтрока(НаименованиеКатегории) Тогда
		Возврат;	
	КонецЕсли;
	Запрос			 = Новый Запрос;
	Запрос.Текст 	 = ПолучитьТекстЗапросаСписокВидовНоменклатуры();
	Запрос.УстановитьПараметр("Строка",НаименованиеКатегории);
	РезультатЗапроса = Запрос.Выполнить(); 
	Если НЕ РезультатЗапроса.Пустой()  Тогда
	    Выборка		 = РезультатЗапроса.Выбрать();
		Пока Выборка.Следующий() Цикл
		 	ВидНоменклатуры = Выборка.ВидыНоменклатуры;
			Категория		= Выборка.Категория;
			Запрос			= Новый Запрос;
			Запрос.Текст    = ПолучитьСписокНоменклатуры();
			Запрос.УстановитьПараметр("ВидНоменклатуры",ВидНоменклатуры);
			РезультатЗапроса = Запрос.Выполнить(); 
			Если НЕ РезультатЗапроса.Пустой()  Тогда
			    ВыборкаНоменклатура		 = РезультатЗапроса.Выбрать();
						
				Пока ВыборкаНоменклатура.Следующий() Цикл
					НоменклатураСсылка 					=  	ВыборкаНоменклатура.Ссылка;
			        СправочникОбъект					=	НоменклатураСсылка.ПолучитьОбъект();
					СправочникОбъект.ТоварнаяКатегория  =	Категория;
					Попытка
		        		СправочникОбъект.Записать();
					Исключение
						 Сообщить("Не удалось записать объект " + НоменклатураСсылка + "",СтатусСообщения.Внимание);
			    КонецПопытки;

					
				КонецЦикла;
			КонецЕсли;
		КонецЦикла;	
	КонецЕсли;
		
КонецПроцедуры




&НаСервере
Функция ПолучитьТекстЗапросаСписокВидовНоменклатуры()
ТекстЗапроса = "ВЫБРАТЬ
               |	ТоварныеКатегории.Ссылка КАК Категория,
               |	ТоварныеКатегории.Владелец КАК ВидыНоменклатуры
               |ИЗ
               |	Справочник.ТоварныеКатегории КАК ТоварныеКатегории
               |ГДЕ
               |	НЕ ТоварныеКатегории.ПометкаУдаления
               |	И ТоварныеКатегории.Наименование ПОДОБНО &Строка
               |	И ТоварныеКатегории.ЭтоГруппа = ЛОЖЬ";
Возврат ТекстЗапроса;
КонецФункции // ПолучитьТекстЗапросаАвтоЗаполнения()


&НаСервере
Функция ПолучитьСписокНоменклатуры()
ТекстЗапроса = "ВЫБРАТЬ
               |	Номенклатура.Ссылка КАК Ссылка
               |ИЗ
               |	Справочник.Номенклатура КАК Номенклатура
               |ГДЕ
               |	Номенклатура.ВидНоменклатуры = &ВидНоменклатуры
               |	И НЕ Номенклатура.ПометкаУдаления
               |	И Номенклатура.ТоварнаяКатегория = ЗНАЧЕНИЕ(Справочник.ТоварныеКатегории.ПустаяСсылка)
               |	И Номенклатура.ЭтоГруппа = ЛОЖЬ";
Возврат ТекстЗапроса;
КонецФункции // ПолучитьТекстЗапросаАвтоЗаполнения()

&НаКлиенте
Процедура ОткритьОтчет(Команда)
	ФормаОчета = ПолучитьФорму("ВнешняяОбработка.ЗаполненияКатегорийПоВидуНоменклатуры.Форма.ФормаОтчета");
	ОткрытьФорму(ФормаОчета);
КонецПроцедуры

&НаКлиенте
Процедура ЗагрузитьНоменклатуруБезКатегории(Команда)
	Элементы.ГруппаДляРучногоОтбора.Видимость 	= 	Ложь;
	Элементы.ГруппаАвтоЗаполнения.Видимость		=	Истина;
	Элементы.ГруппаТаблицаСписок.Видимость		=	Ложь;

КонецПроцедуры

&НаКлиенте
Процедура ЗагрузитьНоменклатуруПоВидам(Команда)
	Элементы.ГруппаДляРучногоОтбора.Видимость 	= 	Истина;
	Элементы.ГруппаАвтоЗаполнения.Видимость		=	Ложь;
	Элементы.ГруппаТаблицаСписок.Видимость		=	Ложь;
	Таблица.Очистить();
КонецПроцедуры

&НаКлиенте
Процедура СформироватьСписокНоменклатурыБезКатегории(Команда)
	Элементы.ГруппаДляРучногоОтбора.Видимость 	= 	Ложь;
	Элементы.ГруппаАвтоЗаполнения.Видимость		=	Ложь;
	Элементы.ГруппаТаблицаСписок.Видимость		=	Истина;
КонецПроцедуры


&НаКлиенте
Процедура Сформировать(Команда)
	СформироватьТаблицуБезКатегорийНаСервере();
КонецПроцедуры

&НаСервере
Процедура СформироватьТаблицуБезКатегорийНаСервере()
	Запрос			= Новый Запрос;
	ТекстЗапроса	= ПолучитьТекстЗапроса();
	Отбор			= "И  Номенклатура.ТоварнаяКатегория=Значение(Справочник.ТоварныеКатегории.ПустаяСсылка)";
	ОтборПоВиду		= "Номенклатура.ВидНоменклатуры = &ВидНоменклатуры
               			|	И ";	
	ТекстЗапроса    = СтрЗаменить(ТекстЗапроса,ОтборПоВиду," ");
	ТекстЗапроса    = СтрЗаменить(ТекстЗапроса,"%Отбор%",Отбор);
	
	Запрос.Текст	=  ТекстЗапроса;
	Результат				= Запрос.Выполнить(); 
	
	Если НЕ Результат.Пустой() Тогда 
		Таблица.Загрузить(Результат.Выгрузить());
	КонецЕсли;
КонецПроцедуры








