///////////////////////////////////////////////////////////////////////////////////////
// ФУНКЦИИ ДЛЯ ОБРАБОТКИ  ЭЛЕМЕНТОВ ФОРМЫ
 
&НаКлиенте
Процедура ТоварнаяКатегорияПриИзменении(Элемент)
	ТоварнаяКатегорияПриИзмененииНаСервере();
КонецПроцедуры

&НаКлиенте
Процедура ВсяНоменклатураБезКатегорииПриИзменении(Элемент)
	ВидНоменклатурыПриИзмененииНаСервере();	
КонецПроцедуры

&НаКлиенте
Процедура ПоискПриИзменении(Элемент)
	ВидНоменклатурыПриИзмененииНаСервере();	
КонецПроцедуры

&НаКлиенте
Процедура ОтборПоКатегориямПриИзменении(Элемент)
	ВидНоменклатурыПриИзмененииНаСервере();
КонецПроцедуры


/////////////////////////////////////////////
//КОМАНДЫ ФОРМЫ
&НаКлиенте
Процедура УстановитьФлаги(Команда)
	УстановитьФлагиНаСервере(Истина);
КонецПроцедуры
&НаКлиенте
Процедура СнятьВсеФлаги(Команда)
	УстановитьФлагиНаСервере(Ложь);
КонецПроцедуры
&НаКлиенте
Процедура Заполнить(Команда)
	ЗаполнитьНаСервере();
КонецПроцедуры



/////////////////////////////////////////////
// СЛУЖЕБНЫЕ ФУНКЦИИЯ
//НА СЕРВЕРЕ
&НаСервере
Процедура ВидНоменклатурыПриИзмененииНаСервере()
	Запрос			= Новый Запрос();
	ТекстЗапроса	= ПолучитьТекстЗапроса();
	Отбор			= ?(ОтборПоКатегориям,"И  Номенклатура.ТоварнаяКатегория=Значение(Справочник.ТоварныеКатегории.ПустаяСсылка)", "");
	Если ЗначениеЗаполнено(НайтиСтроку) Тогда
		ТекстЗапроса    = СтрЗаменить(ТекстЗапроса,"%Отбор%",Отбор+"И Номенклатура.Наименование ПОДОБНО """+НайтиСтроку+"""") ;
	Иначе 
		ТекстЗапроса    = СтрЗаменить(ТекстЗапроса,"%Отбор%",Отбор+" ");
	КонецЕсли;
	Запрос.Текст	=  ТекстЗапроса;
	Запрос.УстановитьПараметр("ВидНоменклатуры",ВидНоменклатуры);

	Результат		= Запрос.Выполнить();
	Если НЕ Результат.Пустой() Тогда 
		ТаблицаЗнч		= Результат.Выгрузить();
		Таблица.Загрузить(ТаблицаЗнч);
	КонецЕсли
	
КонецПроцедуры
&НаСервере
Функция ПолучитьТекстЗапроса()
	ТекстЗапроса= "ВЫБРАТЬ
	              |	Номенклатура.Ссылка КАК Номенклатура,
	              |	Номенклатура.ТоварнаяКатегория,
	              |	ИСТИНА КАК Флаг
	              |ИЗ
	              |	Справочник.Номенклатура КАК Номенклатура
	              |ГДЕ
	              |	НЕ Номенклатура.ПометкаУдаления
 	              |	И Номенклатура.ВидНоменклатуры = &ВидНоменклатуры
				  | %Отбор%";
	Возврат ТекстЗапроса;
КонецФункции // ПолучитьТекстЗапроса()


&НаСервере
Процедура ТоварнаяКатегорияПриИзмененииНаСервере()
	Если ТоварнаяКатегория.Владелец<>Неопределено Тогда
		ВидНоменклатуры =  ТоварнаяКатегория.Владелец;
		ОтборПоКатегориям = Истина;
	КонецЕсли;
	ВидНоменклатурыПриИзмененииНаСервере();
КонецПроцедуры


&НаСервере
Процедура УстановитьФлагиНаСервере(Флаг)
	Для каждого Строка Из Таблица Цикл
		Строка.Флаг =Флаг;
	КонецЦикла;	
КонецПроцедуры

&НаСервере
Процедура ЗаполнитьНаСервере()
	СписокНоменклатуры = Таблица.НайтиСтроки(Новый Структура("Флаг",Истина));
	Если СписокНоменклатуры.Количество()>0  Тогда
		Для каждого Строка Из СписокНоменклатуры  Цикл
			НоменклатураСсылка					=	Строка.Номенклатура;
			СправочникОбъект					=	НоменклатураСсылка.ПолучитьОбъект();
			СправочникОбъект.ТоварнаяКатегория  =	ТоварнаяКатегория;
			Попытка
        		СправочникОбъект.Записать();
			Исключение
		    КонецПопытки;
		КонецЦикла;
	КонецЕсли; 
	ВидНоменклатурыПриИзмененииНаСервере();
КонецПроцедуры






