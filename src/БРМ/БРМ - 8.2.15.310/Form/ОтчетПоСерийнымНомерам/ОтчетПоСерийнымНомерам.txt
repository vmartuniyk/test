#Область ИнтерфейсАвтоматическихТестов

&НаКлиенте
Перем ЮнитТест;

&НаКлиенте
Функция ПолучитьСписокТестов(ЮнитТестирование) Экспорт
	
	ЮнитТест = ЮнитТестирование;
	
	СписокТестов = Новый Массив;
	СписокТестов.Добавить("Тест_ПроверитьВалидностьЗапросаПоискПоНоменклатуре");
	СписокТестов.Добавить("Тест_ПроверитьВалидностьЗапросаПоискПоСН");
	Возврат СписокТестов;
	
КонецФункции

&НаКлиенте
Процедура Тест_ПроверитьВалидностьЗапросаПоискПоНоменклатуре() Экспорт   	
	ТекстЗапроса = ПолучитьТекстЗапросаПоискПоНоменклатуре();
	ЮнитТест.ПроверитьТип(ТекстЗапроса, Тип("Строка"));
	Тест_ПроверитьТекстЗапросНаОшибки(ТекстЗапроса);
КонецПроцедуры

&НаКлиенте
Процедура Тест_ПроверитьВалидностьЗапросаПоискПоСН() Экспорт   	

	ТекстЗапроса = ПолучитьТекстЗапросаПоискПоСН();
	ЮнитТест.ПроверитьТип(ТекстЗапроса, Тип("Строка"));
	Тест_ПроверитьТекстЗапросНаОшибки(ТекстЗапроса);
КонецПроцедуры

&НаСервере
Процедура Тест_ПроверитьТекстЗапросНаОшибки(ТекстЗапроса) Экспорт
	
	СхемаКомпоновкиДанных = Новый СхемаКомпоновкиДанных;
	
	ИсточникДанных 					  = СхемаКомпоновкиДанных.ИсточникиДанных.Добавить(); 
	ИсточникДанных.Имя                = "ИсточникДанных";
	ИсточникДанных.СтрокаСоединения   = "";
	ИсточникДанных.ТипИсточникаДанных = "Local";
	
	НаборДанных 							 = СхемаКомпоновкиДанных.НаборыДанных.Добавить(Тип("НаборДанныхЗапросСхемыКомпоновкиДанных"));
	НаборДанных.Имя            				 = "НаборДанных";
	НаборДанных.ИсточникДанных 				 = "ИсточникДанных";
	НаборДанных.АвтоЗаполнениеДоступныхПолей = Истина;
	НаборДанных.Запрос 						 = ТекстЗапроса;
	
	КомпоновщикНастроек = Новый КомпоновщикНастроекКомпоновкиДанных;
	КомпоновщикНастроек.Инициализировать(Новый ИсточникДоступныхНастроекКомпоновкиДанных(СхемаКомпоновкиДанных));
 

КонецПроцедуры // Тест_ПроверитьТекстЗапросНаОшибки(ТекстЗапроса)


#КонецОбласти

#Область ОбработчикиСобытийФормы
&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	Если Параметры.Свойство("АвтоТест") Тогда
		Возврат;	
	КонецЕсли;
	
	// Устанавливаем переключатель в положение Точный поиск
	Флаг = "ТочныйПоиск";
	ДатаОкончания = ТекущаяДата();
	СписокДоступныхСерийныхНомеров.Очистить();
	
КонецПроцедуры

#КонецОбласти

#Область ОбработчикиСобытийЭлементовШапкиФормы

&НаКлиенте
Процедура НоменклатураПриИзменении(Элемент)
	
	СерийныеНомера = Неопределено;
	ктсОбновитьСписокСН();
	
КонецПроцедуры

&НаКлиенте
Процедура СериыйныеНомераНачалоВыбора(Элемент, ДанныеВыбора, СтандартнаяОбработка)
	
	СтандартнаяОбработка = Ложь;
	ДанныеВыбора = СписокДоступныхСерийныхНомеров.Скопировать();
	
КонецПроцедуры
#КонецОбласти

#Область  ОбработчикиСобытийТаблициФормыРезультата

&НаКлиенте
Процедура ТаблицаРезультатПередУдалением(Элемент, Отказ)
	Отказ = Истина;
КонецПроцедуры

&НаКлиенте
Процедура ТаблицаРезультатПередНачаломДобавления(Элемент, Отказ, Копирование, Родитель, Группа, Параметр)
	Отказ = Истина;
КонецПроцедуры

&НаКлиенте
Процедура ТаблицаРезультатВыбор(Элемент, ВыбраннаяСтрока, Поле, СтандартнаяОбработка)
	
	Колонка = СтрЗаменить(Поле.Имя,"ТаблицаРезультат","");
  	Значение =Неопределено;
	Выполнить("Значение = Элемент.ТекущиеДанные."+Колонка+";");
	ТипКолонки = ТипЗнч(Значение);
	Если ТипКолонки = Тип("Строка") Или ТипКолонки = Тип("Дата") Тогда 
		ОткрытьЗначение(Элемент.ТекущиеДанные.ДокументСсылка);
	Иначе 
		ОткрытьЗначение(Значение);
	КонецЕсли;
КонецПроцедуры

#КонецОбласти

#Область ОбработчикиКомандФормы

// Формируем период
&НаКлиенте
Процедура УправлениеМагазиномПериод(Команда)
	
	Диалог = Новый ДиалогРедактированияСтандартногоПериода;
	Если Диалог.Редактировать() Тогда
		Период 			= Диалог.Период;
		ДатаНачала 		= Период.ДатаНачала;
		ДатаОкончания 	= Период.ДатаОкончания;
		ктсУстановитьПериод(ДатаНачала, ДатаОкончания);
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура СформироватьПоНоменклатуре(Команда)
	
	Если Номенклатура.Пустая() Тогда
		Сообщение = Новый СообщениеПользователю;
		Сообщение.Текст = "Поле номенклатуры обезательно к заполнению";
		Сообщение.Поле = "Номенклатура";
		Сообщение.Сообщить();
		Возврат;
	КонецЕсли;
	
	СформироватьПоНоменклатуреНаСервере();
	
КонецПроцедуры

&НаКлиенте
Процедура СформироватьПоСерийномуНомеру(Команда)
	
	Если Не ЗначениеЗаполнено(ПоискСерийника) Тогда
		Сообщение = Новый СообщениеПользователю;
		Сообщение.Текст = "Поле поиск серийника обезательно к заполнению";
		Сообщение.Поле = "ПоискСерийника";
		Сообщение.Сообщить();
		Возврат;
	КонецЕсли;
	СформироватьПоСННаСервере();
КонецПроцедуры

&НаКлиенте
Процедура СортироватьПоВозрастанию(Команда)
	СтруктураПередачи = ПолучитьИдентификаторИмяКолонки("ТаблицаРезультат");
	
	ПолеСортировки 		= СтрЗаменить(СтруктураПередачи.Имя,"ТаблицаРезультат", " ");
	ПорядокСортировки	= " Возр"; 
	
	Если НЕ СтруктураПередачи.Отказ Тогда
		ТаблицаРезультатСортировкаНаСервере();
	КонецЕсли;
КонецПроцедуры

&НаКлиенте
Процедура СортироватьПоУбыванию(Команда)
	
	СтруктураПередачи	= ПолучитьИдентификаторИмяКолонки("ТаблицаРезультат");
	ПолеСортировки 		= СтрЗаменить(СтруктураПередачи.Имя,"ТаблицаРезультат", " ");
	ПорядокСортировки	= " УБЫВ"; 
	
	Если НЕ СтруктураПередачи.Отказ Тогда
		ТаблицаРезультатСортировкаНаСервере()
	КонецЕсли;
	
КонецПроцедуры
#КонецОбласти

#Область СлужебныеПроцедурыИФункции

&НаСервере
Процедура ктсУстановитьПериод(ктсДатаНачала, ктсДатаОкончания)
	
	ДатаНачала 		= ктсДатаНачала;
	ДатаОкончания 	= ктсДатаОкончания;
	
КонецПроцедуры

&НаСервере
Процедура ктсОбновитьСписокСН()
	
	СписокДоступныхСерийныхНомеров.Очистить();
	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("Номенклатура", Номенклатура);
	Запрос.Текст = 
	"ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	Ссылка 			КАК СерийныйНомер
	|ИЗ
	|	Справочник.СерийныеНомераНоменклатуры 
	|ГДЕ
	|	Владелец = &Номенклатура
	|	И НЕ ПометкаУдаления
	|
	|УПОРЯДОЧИТЬ ПО
	|	СерийныйНомер УБЫВ ";
	
	РезультатыЗапроса = Запрос.Выполнить();
	Таблица = РезультатыЗапроса.Выгрузить();
	
	СписокДоступныхСерийныхНомеров.ЗагрузитьЗначения(Таблица.ВыгрузитьКолонку("СерийныйНомер"));
	
КонецПроцедуры

&НаСервере
Функция СформироватьПоНоменклатуреНаСервере()
	
	УстановитьПривилегированныйРежим(Истина);
	
	Если ДатаОкончания = Дата(1,1,1) Тогда 
		ДатаОкончания = ТекущаяДата();
	КонецЕсли;
	Запрос = Новый Запрос(ПолучитьТекстЗапросаПоискПоНоменклатуре());	
	Запрос.УстановитьПараметр("ДатаНач", 		НачалоДня(ДатаНачала));
	Запрос.УстановитьПараметр("ДатаКон", 	 	КонецДня(ДатаОкончания));
	Запрос.УстановитьПараметр("Контрагент", 	Контрагенты);
	Запрос.УстановитьПараметр("Номенклатура", 	Номенклатура);
	Запрос.УстановитьПараметр("СерийныйНомер",	СерийныеНомера);
	
	УникальныйИдентификаторГарантия = Новый УникальныйИдентификатор("a3e0fd0e-4712-11e0-9f98-001517115d85");
	Гарантия  = ПланыВидовХарактеристик.ДополнительныеРеквизитыИСведения.ПолучитьСсылку(УникальныйИдентификаторГарантия);
	Запрос.УстановитьПараметр("Свойство", 		Гарантия);

	РезультатЗапроса = Запрос.Выполнить();
	
	ТаблицаРезультат.Очистить();
	ТаблицаРезультат.Загрузить(РезультатЗапроса.Выгрузить());
	
	Если ПривилегированныйРежим() ТОгда
		УстановитьПривилегированныйРежим(Ложь);
	КонецЕсли;	
	
КонецФункции

&НаСервере
Функция ПолучитьТекстЗапросаПоискПоНоменклатуре() 
	ТекстЗапроса		 = 

		"ВЫБРАТЬ
		|	&Номенклатура КАК Номенклатура,
		|	НоменклатураДополнительныеРеквизиты.Значение КАК Значение
		|ПОМЕСТИТЬ КешГарантия
		|ИЗ
		|	Справочник.Номенклатура.ДополнительныеРеквизиты КАК НоменклатураДополнительныеРеквизиты
		|ГДЕ
		|	НоменклатураДополнительныеРеквизиты.Ссылка = &Номенклатура
		|	И НоменклатураДополнительныеРеквизиты.Свойство = &Свойство
		|;

		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ОбеспечениеЗаказовОбороты.Регистратор,
		|	ОбеспечениеЗаказовОбороты.Назначение,
		|	ОбеспечениеЗаказовОбороты.НаличиеСоСкладаОборот,
		|	ОбеспечениеЗаказовОбороты.ПотребностьОборот,
		|	ОбеспечениеЗаказовОбороты.КЗаказуОборот,
		|	ОбеспечениеЗаказовОбороты.ЗаказаноОборот,
		|	ОбеспечениеЗаказовОбороты.НаличиеПодЗаказОборот
		|ПОМЕСТИТЬ КешНазначения
		|ИЗ
		|	РегистрНакопления.ОбеспечениеЗаказов.Обороты(, &ДатаКон, Регистратор, Номенклатура = &Номенклатура) КАК ОбеспечениеЗаказовОбороты
		|ГДЕ
		| ОбеспечениеЗаказовОбороты.Регистратор <> ОбеспечениеЗаказовОбороты.Назначение.Заказ
		| И
		| (ОбеспечениеЗаказовОбороты.Регистратор Ссылка Документ.ЗаказПоставщику
		| Или ОбеспечениеЗаказовОбороты.Регистратор Ссылка Документ.ЗаказНаПеремещение
		| Или ОбеспечениеЗаказовОбороты.Регистратор Ссылка Документ.ПоступлениеТоваровУслуг
		| Или ОбеспечениеЗаказовОбороты.Регистратор Ссылка Документ.ЗаказНаСборку
		| Или ОбеспечениеЗаказовОбороты.Регистратор Ссылка Документ.ПеремещениеТоваров)
		
		//|	ОбеспечениеЗаказовОбороты.НаличиеСоСкладаОборот = 0

		|ОБЪЕДИНИТЬ ВСЕ

		|ВЫБРАТЬ
		|	КТС_ТоварыКПоступлениюПодОбеспечениеОбороты.Регистратор,
		|	КТС_ТоварыКПоступлениюПодОбеспечениеОбороты.Назначение,
		|	NULL,
		|	NULL,
		|	NULL,
		|	NULL,
		|	NULL
		|ИЗ
		|	РегистрНакопления.КТС_ТоварыКПоступлениюПодОбеспечение.Обороты(, &ДатаКон, Регистратор, Номенклатура = &Номенклатура) КАК КТС_ТоварыКПоступлениюПодОбеспечениеОбороты
		|;

		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ТоварДвижения.Период КАК Дата,
		|	ТоварДвижения.Регистратор КАК ДокументСсылка,
		|	ВЫБОР
		|		КОГДА ТоварДвижения.Регистратор ССЫЛКА Документ.ВводОстатков
		|			ТОГДА ВЫРАЗИТЬ(ТоварДвижения.Регистратор КАК Документ.ВводОстатков).Номер
		|		КОГДА ТоварДвижения.Регистратор ССЫЛКА Документ.ВнутреннееПотреблениеТоваров
		|			ТОГДА ВЫРАЗИТЬ(ТоварДвижения.Регистратор КАК Документ.ВнутреннееПотреблениеТоваров).Номер
		|		КОГДА ТоварДвижения.Регистратор ССЫЛКА Документ.ВозвратТоваровОтКлиента
		|			ТОГДА ВЫРАЗИТЬ(ТоварДвижения.Регистратор КАК Документ.ВозвратТоваровОтКлиента).Номер
		|		КОГДА ТоварДвижения.Регистратор ССЫЛКА Документ.ВозвратТоваровПоставщику
		|			ТОГДА ВЫРАЗИТЬ(ТоварДвижения.Регистратор КАК Документ.ВозвратТоваровПоставщику).Номер
		|		КОГДА ТоварДвижения.Регистратор ССЫЛКА Документ.ОприходованиеИзлишковТоваров
		|			ТОГДА ВЫРАЗИТЬ(ТоварДвижения.Регистратор КАК Документ.ОприходованиеИзлишковТоваров).Номер
		|		КОГДА ТоварДвижения.Регистратор ССЫЛКА Документ.ПеремещениеТоваров
		|			ТОГДА ВЫРАЗИТЬ(ТоварДвижения.Регистратор КАК Документ.ПеремещениеТоваров).Номер
		|		КОГДА ТоварДвижения.Регистратор ССЫЛКА Документ.ПересортицаТоваров
		|			ТОГДА ВЫРАЗИТЬ(ТоварДвижения.Регистратор КАК Документ.ПересортицаТоваров).Номер
		|		КОГДА ТоварДвижения.Регистратор ССЫЛКА Документ.ПоступлениеТоваровУслуг
		|			ТОГДА ВЫРАЗИТЬ(ТоварДвижения.Регистратор КАК Документ.ПоступлениеТоваровУслуг).Номер
		|		КОГДА ТоварДвижения.Регистратор ССЫЛКА Документ.ПриходныйОрдерНаТовары
		|			ТОГДА ВЫРАЗИТЬ(ТоварДвижения.Регистратор КАК Документ.ПриходныйОрдерНаТовары).Номер
		|		КОГДА ТоварДвижения.Регистратор ССЫЛКА Документ.РасходныйОрдерНаТовары
		|			ТОГДА ВЫРАЗИТЬ(ТоварДвижения.Регистратор КАК Документ.РасходныйОрдерНаТовары).Номер
		|		КОГДА ТоварДвижения.Регистратор ССЫЛКА Документ.РеализацияТоваровУслуг
		|			ТОГДА ВЫРАЗИТЬ(ТоварДвижения.Регистратор КАК Документ.РеализацияТоваровУслуг).Номер
		|		КОГДА ТоварДвижения.Регистратор ССЫЛКА Документ.СборкаТоваров
		|			ТОГДА ВЫРАЗИТЬ(ТоварДвижения.Регистратор КАК Документ.СборкаТоваров).Номер
		|		КОГДА ТоварДвижения.Регистратор ССЫЛКА Документ.СписаниеНедостачТоваров
		|			ТОГДА ВЫРАЗИТЬ(ТоварДвижения.Регистратор КАК Документ.СписаниеНедостачТоваров).Номер
		|	КОНЕЦ КАК НомерДок,
		|	ВЫБОР
		|		КОГДА ТоварДвижения.Регистратор ССЫЛКА Документ.ПриходныйОрдерНаТовары
		|			ТОГДА ВЫРАЗИТЬ(ТоварДвижения.Регистратор КАК Документ.ПриходныйОрдерНаТовары).Распоряжение
		|		КОГДА ТоварДвижения.Регистратор ССЫЛКА Документ.РасходныйОрдерНаТовары
		|			ТОГДА ВЫРАЗИТЬ(ТоварДвижения.Регистратор КАК Документ.РасходныйОрдерНаТовары).Распоряжение
		|		КОГДА ТоварДвижения.Регистратор ССЫЛКА Документ.РеализацияТоваровУслуг
		|			ТОГДА ВЫРАЗИТЬ(ТоварДвижения.Регистратор КАК Документ.РеализацияТоваровУслуг).ЗаказКлиента
		|		КОГДА ТоварДвижения.Регистратор ССЫЛКА Документ.ПоступлениеТоваровУслуг
		|			ТОГДА ВЫРАЗИТЬ(ТоварДвижения.Регистратор КАК Документ.ПоступлениеТоваровУслуг).ЗаказПоставщику
		|		КОГДА ТоварДвижения.Регистратор ССЫЛКА Документ.ВозвратТоваровОтКлиента
		|			ТОГДА ВЫРАЗИТЬ(ТоварДвижения.Регистратор КАК Документ.ВозвратТоваровОтКлиента).ЗаявкаНаВозвратТоваровОтКлиента
		|		КОГДА ТоварДвижения.Регистратор ССЫЛКА Документ.ОприходованиеИзлишковТоваров
		|			ТОГДА ВЫРАЗИТЬ(ТоварДвижения.Регистратор КАК Документ.ОприходованиеИзлишковТоваров).ДокументОснование
		|		КОГДА ТоварДвижения.Регистратор ССЫЛКА Документ.ПеремещениеТоваров
		|			ТОГДА ВЫРАЗИТЬ(ТоварДвижения.Регистратор КАК Документ.ПеремещениеТоваров).ЗаказНаПеремещение
		|		КОГДА ТоварДвижения.Регистратор ССЫЛКА Документ.ПересортицаТоваров
		|			ТОГДА ВЫРАЗИТЬ(ТоварДвижения.Регистратор КАК Документ.ПересортицаТоваров).ДокументОснование
		|		КОГДА ТоварДвижения.Регистратор ССЫЛКА Документ.СборкаТоваров
		|			ТОГДА ВЫРАЗИТЬ(ТоварДвижения.Регистратор КАК Документ.СборкаТоваров).ЗаказНаСборку
		|		КОГДА ТоварДвижения.Регистратор ССЫЛКА Документ.СписаниеНедостачТоваров
		|			ТОГДА ВЫРАЗИТЬ(ТоварДвижения.Регистратор КАК Документ.СписаниеНедостачТоваров).ДокументОснование
		|		КОГДА ТоварДвижения.Регистратор ССЫЛКА Документ.ВнутреннееПотреблениеТоваров
		|			ТОГДА ВЫРАЗИТЬ(ТоварДвижения.Регистратор КАК Документ.ВнутреннееПотреблениеТоваров).ЗаказНаВнутреннееПотребление
		|		ИНАЧЕ NULL
		|	КОНЕЦ КАК ДокументОснование,
		|	ВЫБОР
		|		КОГДА ТоварДвижения.Регистратор ССЫЛКА Документ.РасходныйОрдерНаТовары
		|			ТОГДА ВЫРАЗИТЬ(ТоварДвижения.Регистратор КАК Документ.РасходныйОрдерНаТовары).Распоряжение.Контрагент
		|		КОГДА ТоварДвижения.Регистратор ССЫЛКА Документ.ВозвратТоваровОтКлиента
		|			ТОГДА ВЫРАЗИТЬ(ТоварДвижения.Регистратор КАК Документ.ВозвратТоваровОтКлиента).Контрагент
		|		КОГДА ТоварДвижения.Регистратор ССЫЛКА Документ.ВозвратТоваровПоставщику
		|			ТОГДА ВЫРАЗИТЬ(ТоварДвижения.Регистратор КАК Документ.ВозвратТоваровПоставщику).Контрагент
		|		КОГДА ТоварДвижения.Регистратор ССЫЛКА Документ.ПоступлениеТоваровУслуг
		|			ТОГДА ВЫРАЗИТЬ(ТоварДвижения.Регистратор КАК Документ.ПоступлениеТоваровУслуг).Контрагент
		|		КОГДА ТоварДвижения.Регистратор ССЫЛКА Документ.ПриходныйОрдерНаТовары
		|			ТОГДА ВЫРАЗИТЬ(ТоварДвижения.Регистратор КАК Документ.ПриходныйОрдерНаТовары).Распоряжение.Контрагент
		|		КОГДА ТоварДвижения.Регистратор ССЫЛКА Документ.РеализацияТоваровУслуг
		|			ТОГДА ВЫРАЗИТЬ(ТоварДвижения.Регистратор КАК Документ.РеализацияТоваровУслуг).Контрагент
		|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
		|	КОНЕЦ КАК Контрагент,
		|	ВЫБОР
		|		КОГДА ТоварДвижения.Регистратор ССЫЛКА Документ.ВводОстатков
		|			ТОГДА ВЫРАЗИТЬ(ТоварДвижения.Регистратор КАК Документ.ВводОстатков).Ответственный
		|		КОГДА ТоварДвижения.Регистратор ССЫЛКА Документ.ВнутреннееПотреблениеТоваров
		|			ТОГДА ВЫРАЗИТЬ(ТоварДвижения.Регистратор КАК Документ.ВнутреннееПотреблениеТоваров).Ответственный
		|		КОГДА ТоварДвижения.Регистратор ССЫЛКА Документ.ВозвратТоваровОтКлиента
		|			ТОГДА ВЫРАЗИТЬ(ТоварДвижения.Регистратор КАК Документ.ВозвратТоваровОтКлиента).Менеджер
		|		КОГДА ТоварДвижения.Регистратор ССЫЛКА Документ.ВозвратТоваровПоставщику
		|			ТОГДА ВЫРАЗИТЬ(ТоварДвижения.Регистратор КАК Документ.ВозвратТоваровПоставщику).Менеджер
		|		КОГДА ТоварДвижения.Регистратор ССЫЛКА Документ.ОприходованиеИзлишковТоваров
		|			ТОГДА ВЫРАЗИТЬ(ТоварДвижения.Регистратор КАК Документ.ОприходованиеИзлишковТоваров).Ответственный
		|		КОГДА ТоварДвижения.Регистратор ССЫЛКА Документ.ПеремещениеТоваров
		|			ТОГДА ВЫРАЗИТЬ(ТоварДвижения.Регистратор КАК Документ.ПеремещениеТоваров).Ответственный
		|		КОГДА ТоварДвижения.Регистратор ССЫЛКА Документ.ПересортицаТоваров
		|			ТОГДА ВЫРАЗИТЬ(ТоварДвижения.Регистратор КАК Документ.ПересортицаТоваров).Ответственный
		|		КОГДА ТоварДвижения.Регистратор ССЫЛКА Документ.ПоступлениеТоваровУслуг
		|			ТОГДА ВЫРАЗИТЬ(ТоварДвижения.Регистратор КАК Документ.ПоступлениеТоваровУслуг).Менеджер
		|		КОГДА ТоварДвижения.Регистратор ССЫЛКА Документ.ПриходныйОрдерНаТовары
		|			ТОГДА ВЫРАЗИТЬ(ТоварДвижения.Регистратор КАК Документ.ПриходныйОрдерНаТовары).Ответственный
		|		КОГДА ТоварДвижения.Регистратор ССЫЛКА Документ.РасходныйОрдерНаТовары
		|			ТОГДА ВЫРАЗИТЬ(ТоварДвижения.Регистратор КАК Документ.РасходныйОрдерНаТовары).Ответственный
		|		КОГДА ТоварДвижения.Регистратор ССЫЛКА Документ.РеализацияТоваровУслуг
		|			ТОГДА ВЫРАЗИТЬ(ТоварДвижения.Регистратор КАК Документ.РеализацияТоваровУслуг).Менеджер
		|		КОГДА ТоварДвижения.Регистратор ССЫЛКА Документ.СборкаТоваров
		|			ТОГДА ВЫРАЗИТЬ(ТоварДвижения.Регистратор КАК Документ.СборкаТоваров).Ответственный
		|		КОГДА ТоварДвижения.Регистратор ССЫЛКА Документ.СписаниеНедостачТоваров
		|			ТОГДА ВЫРАЗИТЬ(ТоварДвижения.Регистратор КАК Документ.СписаниеНедостачТоваров).Ответственный
		|	КОНЕЦ КАК Ответственный,
		|	КешГарантия.Значение КАК Гарантия,
		|	СерийныеНомераНоменклатурыОбороты.СерийныеНомера КАК СерийныйНомер
		|ПОМЕСТИТЬ ОсновнойКеш
		|ИЗ
		|	РегистрНакопления.ТоварыНаСкладах.Обороты(&ДатаНач, &ДатаКон, Регистратор, Номенклатура = &Номенклатура) КАК ТоварДвижения"
		+?(СерийныеНомера.Пустая()," ЛЕВОЕ ", " ВНУТРЕННЕЕ ")+"
		|		СОЕДИНЕНИЕ РегистрНакопления.СерийныеНомераНоменклатуры.Обороты(&ДатаНач, &ДатаКон, Регистратор, Номенклатура = &Номенклатура "
		+?(СерийныеНомера.Пустая()," "," И СерийныеНомера = &СерийныйНомер ")+"
		|							) КАК СерийныеНомераНоменклатурыОбороты
		|	ПО  ТоварДвижения.Номенклатура	= СерийныеНомераНоменклатурыОбороты.Номенклатура
		|		И ТоварДвижения.Регистратор = СерийныеНомераНоменклатурыОбороты.Регистратор
		|		ЛЕВОЕ СОЕДИНЕНИЕ КешГарантия КАК КешГарантия
		|			ПО ТоварДвижения.Номенклатура = КешГарантия.Номенклатура "
		+?(Контрагенты.Пустая()," ","  ГДЕ
		|	ВЫБОР
		|		КОГДА ТоварДвижения.Регистратор ССЫЛКА Документ.РасходныйОрдерНаТовары
		|			ТОГДА ВЫРАЗИТЬ(ТоварДвижения.Регистратор КАК Документ.РасходныйОрдерНаТовары).Распоряжение.Контрагент = &Контрагент
		|		КОГДА ТоварДвижения.Регистратор ССЫЛКА Документ.ВозвратТоваровОтКлиента
		|			ТОГДА ВЫРАЗИТЬ(ТоварДвижения.Регистратор КАК Документ.ВозвратТоваровОтКлиента).Контрагент = &Контрагент
		|		КОГДА ТоварДвижения.Регистратор ССЫЛКА Документ.ВозвратТоваровПоставщику
		|			ТОГДА ВЫРАЗИТЬ(ТоварДвижения.Регистратор КАК Документ.ВозвратТоваровПоставщику).Контрагент  = &Контрагент
		|		КОГДА ТоварДвижения.Регистратор ССЫЛКА Документ.ПоступлениеТоваровУслуг
		|			ТОГДА ВЫРАЗИТЬ(ТоварДвижения.Регистратор КАК Документ.ПоступлениеТоваровУслуг).Контрагент = &Контрагент
		|		КОГДА ТоварДвижения.Регистратор ССЫЛКА Документ.ПриходныйОрдерНаТовары
		|			ТОГДА ВЫРАЗИТЬ(ТоварДвижения.Регистратор КАК Документ.ПриходныйОрдерНаТовары).Распоряжение.Контрагент = &Контрагент
		|		КОГДА ТоварДвижения.Регистратор ССЫЛКА Документ.РеализацияТоваровУслуг
		|			ТОГДА ВЫРАЗИТЬ(ТоварДвижения.Регистратор КАК Документ.РеализацияТоваровУслуг).Контрагент  = &Контрагент
		|	КОНЕЦ 	")+" 		
		|;

		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	ОсновнойКеш.Дата,
		|	ОсновнойКеш.ДокументСсылка,
		|	ОсновнойКеш.НомерДок,
		|	ОсновнойКеш.ДокументОснование,
		|	ОсновнойКеш.Контрагент,
		|	ОсновнойКеш.Ответственный,
		|	ОсновнойКеш.Гарантия,
		|	ОсновнойКеш.СерийныйНомер,
		|	ТИПЗначения(ОсновнойКеш.ДокументОснование) КАК ТипДокумента,
		|	IsNull(КешНазначения.Назначение, ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка)) КАК Назначение
		|ИЗ
		|	ОсновнойКеш КАК ОсновнойКеш
		|		ЛЕВОЕ СОЕДИНЕНИЕ КешНазначения КАК КешНазначения
		|		ПО  ОсновнойКеш.ДокументОснование = КешНазначения.Регистратор
		|		ИЛИ ОсновнойКеш.ДокументСсылка    = КешНазначения.Регистратор
		| УПОРЯДОЧИТЬ ПО ДАТА УБЫВ ";
								
		
		Возврат ТекстЗапроса;
	
КонецФункции

&НаСервере
Функция СформироватьПоСННаСервере()
	
	УстановитьПривилегированныйРежим(Истина);
	
	УмоваПоискаСН = СформироватьУмовуПоискСН();
	
	Если ДатаОкончания = Дата(1,1,1) Тогда 
		ДатаОкончания = ТекущаяДата();
	КонецЕсли;
	
			
	Запрос = Новый Запрос(ПолучитьТекстЗапросаПоискПоСН());	
	Запрос.УстановитьПараметр("ДатаНач", 				НачалоДня(ДатаНачала));
	Запрос.УстановитьПараметр("ДатаКон", 	 			КонецДня(ДатаОкончания));
	Запрос.УстановитьПараметр("Контрагент", 			Контрагенты);
	Запрос.УстановитьПараметр("СерийныйНомер",			УмоваПоискаСН);
	
	УникальныйИдентификаторГарантия = Новый УникальныйИдентификатор("a3e0fd0e-4712-11e0-9f98-001517115d85");
	Гарантия  = ПланыВидовХарактеристик.ДополнительныеРеквизитыИСведения.ПолучитьСсылку(УникальныйИдентификаторГарантия);
	Запрос.УстановитьПараметр("Свойство", 				Гарантия);

	РезультатЗапроса = Запрос.Выполнить();
	
	ТаблицаРезультат.Очистить();
	ТаблицаРезультат.Загрузить(РезультатЗапроса.Выгрузить());
	
	Если ПривилегированныйРежим() ТОгда
		УстановитьПривилегированныйРежим(Ложь);
	КонецЕсли;	
	
КонецФункции

&НаСервере
Функция ПолучитьТекстЗапросаПоискПоСН() 
	
	ТекстЗапроса	= 
		"ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	СерийныеНомераНоменклатурыОбороты.Номенклатура КАК Номенклатура
		|ПОМЕСТИТЬ КешНоменклатуры
		|ИЗ
		|	РегистрНакопления.СерийныеНомераНоменклатуры.Обороты(&ДатаНач, 
		|														 &ДатаКон, 
		|														 Регистратор, 
		|														 %УсловиеСН%
		|														 ) КАК СерийныеНомераНоменклатурыОбороты
		|"
		+?(Контрагенты.Пустая()," ","  ГДЕ
		|	ВЫБОР
		|		КОГДА СерийныеНомераНоменклатурыОбороты.Регистратор ССЫЛКА Документ.РасходныйОрдерНаТовары
		|			ТОГДА ВЫРАЗИТЬ(СерийныеНомераНоменклатурыОбороты.Регистратор КАК Документ.РасходныйОрдерНаТовары).Распоряжение.Контрагент = &Контрагент
		|		КОГДА СерийныеНомераНоменклатурыОбороты.Регистратор ССЫЛКА Документ.ВозвратТоваровОтКлиента
		|			ТОГДА ВЫРАЗИТЬ(СерийныеНомераНоменклатурыОбороты.Регистратор КАК Документ.ВозвратТоваровОтКлиента).Контрагент = &Контрагент
		|		КОГДА СерийныеНомераНоменклатурыОбороты.Регистратор ССЫЛКА Документ.ВозвратТоваровПоставщику
		|			ТОГДА ВЫРАЗИТЬ(СерийныеНомераНоменклатурыОбороты.Регистратор КАК Документ.ВозвратТоваровПоставщику).Контрагент  = &Контрагент
		|		КОГДА СерийныеНомераНоменклатурыОбороты.Регистратор ССЫЛКА Документ.ПоступлениеТоваровУслуг
		|			ТОГДА ВЫРАЗИТЬ(СерийныеНомераНоменклатурыОбороты.Регистратор КАК Документ.ПоступлениеТоваровУслуг).Контрагент = &Контрагент
		|		КОГДА СерийныеНомераНоменклатурыОбороты.Регистратор ССЫЛКА Документ.ПриходныйОрдерНаТовары
		|			ТОГДА ВЫРАЗИТЬ(СерийныеНомераНоменклатурыОбороты.Регистратор КАК Документ.ПриходныйОрдерНаТовары).Распоряжение.Контрагент = &Контрагент
		|		КОГДА СерийныеНомераНоменклатурыОбороты.Регистратор ССЫЛКА Документ.РеализацияТоваровУслуг
		|			ТОГДА ВЫРАЗИТЬ(СерийныеНомераНоменклатурыОбороты.Регистратор КАК Документ.РеализацияТоваровУслуг).Контрагент  = &Контрагент
		|	КОНЕЦ 	")+" 
		|
		|ИНДЕКСИРОВАТЬ ПО
		|	Номенклатура
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	КешНоменклатуры.Номенклатура КАК Номенклатура,
		|	НоменклатураДополнительныеРеквизиты.Значение
		|ПОМЕСТИТЬ КешГарантия
		|ИЗ
		|	КешНоменклатуры КАК КешНоменклатуры
		|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.Номенклатура.ДополнительныеРеквизиты КАК НоменклатураДополнительныеРеквизиты
		|		ПО КешНоменклатуры.Номенклатура = НоменклатураДополнительныеРеквизиты.Ссылка
		|ГДЕ
		|	НоменклатураДополнительныеРеквизиты.Свойство = &Свойство
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ОбеспечениеЗаказовОбороты.Регистратор,
		|	ОбеспечениеЗаказовОбороты.Назначение,
		|	ОбеспечениеЗаказовОбороты.НаличиеСоСкладаОборот,
		|	ОбеспечениеЗаказовОбороты.ПотребностьОборот,
		|	ОбеспечениеЗаказовОбороты.КЗаказуОборот,
		|	ОбеспечениеЗаказовОбороты.ЗаказаноОборот,
		|	ОбеспечениеЗаказовОбороты.НаличиеПодЗаказОборот
		|ПОМЕСТИТЬ КешНазначения
		|ИЗ
		|	РегистрНакопления.ОбеспечениеЗаказов.Обороты(, &ДатаКон, Регистратор, Номенклатура В (ВЫБРАТЬ Номенклатура ИЗ КешНоменклатуры)) КАК ОбеспечениеЗаказовОбороты
		|ГДЕ
		| ОбеспечениеЗаказовОбороты.Регистратор <> ОбеспечениеЗаказовОбороты.Назначение.Заказ
		| И
		| (ОбеспечениеЗаказовОбороты.Регистратор Ссылка Документ.ЗаказПоставщику
		| Или ОбеспечениеЗаказовОбороты.Регистратор Ссылка Документ.ЗаказНаПеремещение
		| Или ОбеспечениеЗаказовОбороты.Регистратор Ссылка Документ.ПоступлениеТоваровУслуг
		| Или ОбеспечениеЗаказовОбороты.Регистратор Ссылка Документ.ЗаказНаСборку
		| Или ОбеспечениеЗаказовОбороты.Регистратор Ссылка Документ.ПеремещениеТоваров)
		|ОБЪЕДИНИТЬ ВСЕ
		|ВЫБРАТЬ
		|	КТС_ТоварыКПоступлениюПодОбеспечениеОбороты.Регистратор,
		|	КТС_ТоварыКПоступлениюПодОбеспечениеОбороты.Назначение,
		|	NULL,
		|	NULL,
		|	NULL,
		|	NULL,
		|	NULL
		|ИЗ
		|	РегистрНакопления.КТС_ТоварыКПоступлениюПодОбеспечение.Обороты(, &ДатаКон, Регистратор, Номенклатура  В (ВЫБРАТЬ Номенклатура ИЗ КешНоменклатуры)) КАК КТС_ТоварыКПоступлениюПодОбеспечениеОбороты
		|;
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	СерийныеНомераНоменклатурыОбороты.Период КАК Дата,
		|	СерийныеНомераНоменклатурыОбороты.Регистратор КАК ДокументСсылка,
		|	ВЫБОР
		|		КОГДА СерийныеНомераНоменклатурыОбороты.Регистратор ССЫЛКА Документ.ВводОстатков
		|			ТОГДА ВЫРАЗИТЬ(СерийныеНомераНоменклатурыОбороты.Регистратор КАК Документ.ВводОстатков).Номер
		|		КОГДА СерийныеНомераНоменклатурыОбороты.Регистратор ССЫЛКА Документ.ВнутреннееПотреблениеТоваров
		|			ТОГДА ВЫРАЗИТЬ(СерийныеНомераНоменклатурыОбороты.Регистратор КАК Документ.ВнутреннееПотреблениеТоваров).Номер
		|		КОГДА СерийныеНомераНоменклатурыОбороты.Регистратор ССЫЛКА Документ.ВозвратТоваровОтКлиента
		|			ТОГДА ВЫРАЗИТЬ(СерийныеНомераНоменклатурыОбороты.Регистратор КАК Документ.ВозвратТоваровОтКлиента).Номер
		|		КОГДА СерийныеНомераНоменклатурыОбороты.Регистратор ССЫЛКА Документ.ВозвратТоваровПоставщику
		|			ТОГДА ВЫРАЗИТЬ(СерийныеНомераНоменклатурыОбороты.Регистратор КАК Документ.ВозвратТоваровПоставщику).Номер
		|		КОГДА СерийныеНомераНоменклатурыОбороты.Регистратор ССЫЛКА Документ.ОприходованиеИзлишковТоваров
		|			ТОГДА ВЫРАЗИТЬ(СерийныеНомераНоменклатурыОбороты.Регистратор КАК Документ.ОприходованиеИзлишковТоваров).Номер
		|		КОГДА СерийныеНомераНоменклатурыОбороты.Регистратор ССЫЛКА Документ.ПеремещениеТоваров
		|			ТОГДА ВЫРАЗИТЬ(СерийныеНомераНоменклатурыОбороты.Регистратор КАК Документ.ПеремещениеТоваров).Номер
		|		КОГДА СерийныеНомераНоменклатурыОбороты.Регистратор ССЫЛКА Документ.ПересортицаТоваров
		|			ТОГДА ВЫРАЗИТЬ(СерийныеНомераНоменклатурыОбороты.Регистратор КАК Документ.ПересортицаТоваров).Номер
		|		КОГДА СерийныеНомераНоменклатурыОбороты.Регистратор ССЫЛКА Документ.ПоступлениеТоваровУслуг
		|			ТОГДА ВЫРАЗИТЬ(СерийныеНомераНоменклатурыОбороты.Регистратор КАК Документ.ПоступлениеТоваровУслуг).Номер
		|		КОГДА СерийныеНомераНоменклатурыОбороты.Регистратор ССЫЛКА Документ.ПриходныйОрдерНаТовары
		|			ТОГДА ВЫРАЗИТЬ(СерийныеНомераНоменклатурыОбороты.Регистратор КАК Документ.ПриходныйОрдерНаТовары).Номер
		|		КОГДА СерийныеНомераНоменклатурыОбороты.Регистратор ССЫЛКА Документ.РасходныйОрдерНаТовары
		|			ТОГДА ВЫРАЗИТЬ(СерийныеНомераНоменклатурыОбороты.Регистратор КАК Документ.РасходныйОрдерНаТовары).Номер
		|		КОГДА СерийныеНомераНоменклатурыОбороты.Регистратор ССЫЛКА Документ.РеализацияТоваровУслуг
		|			ТОГДА ВЫРАЗИТЬ(СерийныеНомераНоменклатурыОбороты.Регистратор КАК Документ.РеализацияТоваровУслуг).Номер
		|		КОГДА СерийныеНомераНоменклатурыОбороты.Регистратор ССЫЛКА Документ.СборкаТоваров
		|			ТОГДА ВЫРАЗИТЬ(СерийныеНомераНоменклатурыОбороты.Регистратор КАК Документ.СборкаТоваров).Номер
		|		КОГДА СерийныеНомераНоменклатурыОбороты.Регистратор ССЫЛКА Документ.СписаниеНедостачТоваров
		|			ТОГДА ВЫРАЗИТЬ(СерийныеНомераНоменклатурыОбороты.Регистратор КАК Документ.СписаниеНедостачТоваров).Номер
		|	КОНЕЦ КАК НомерДок,
		|	ВЫБОР
		|		КОГДА СерийныеНомераНоменклатурыОбороты.Регистратор ССЫЛКА Документ.ПриходныйОрдерНаТовары
		|			ТОГДА ВЫРАЗИТЬ(СерийныеНомераНоменклатурыОбороты.Регистратор КАК Документ.ПриходныйОрдерНаТовары).Распоряжение
		|		КОГДА СерийныеНомераНоменклатурыОбороты.Регистратор ССЫЛКА Документ.РасходныйОрдерНаТовары
		|			ТОГДА ВЫРАЗИТЬ(СерийныеНомераНоменклатурыОбороты.Регистратор КАК Документ.РасходныйОрдерНаТовары).Распоряжение
		|		КОГДА СерийныеНомераНоменклатурыОбороты.Регистратор ССЫЛКА Документ.РеализацияТоваровУслуг
		|			ТОГДА ВЫРАЗИТЬ(СерийныеНомераНоменклатурыОбороты.Регистратор КАК Документ.РеализацияТоваровУслуг).ЗаказКлиента
		|		КОГДА СерийныеНомераНоменклатурыОбороты.Регистратор ССЫЛКА Документ.ПоступлениеТоваровУслуг
		|			ТОГДА ВЫРАЗИТЬ(СерийныеНомераНоменклатурыОбороты.Регистратор КАК Документ.ПоступлениеТоваровУслуг).ЗаказПоставщику
		|		КОГДА СерийныеНомераНоменклатурыОбороты.Регистратор ССЫЛКА Документ.ВозвратТоваровОтКлиента
		|			ТОГДА ВЫРАЗИТЬ(СерийныеНомераНоменклатурыОбороты.Регистратор КАК Документ.ВозвратТоваровОтКлиента).ЗаявкаНаВозвратТоваровОтКлиента
		|		КОГДА СерийныеНомераНоменклатурыОбороты.Регистратор ССЫЛКА Документ.ОприходованиеИзлишковТоваров
		|			ТОГДА ВЫРАЗИТЬ(СерийныеНомераНоменклатурыОбороты.Регистратор КАК Документ.ОприходованиеИзлишковТоваров).ДокументОснование
		|		КОГДА СерийныеНомераНоменклатурыОбороты.Регистратор ССЫЛКА Документ.ПеремещениеТоваров
		|			ТОГДА ВЫРАЗИТЬ(СерийныеНомераНоменклатурыОбороты.Регистратор КАК Документ.ПеремещениеТоваров).ЗаказНаПеремещение
		|		КОГДА СерийныеНомераНоменклатурыОбороты.Регистратор ССЫЛКА Документ.ПересортицаТоваров
		|			ТОГДА ВЫРАЗИТЬ(СерийныеНомераНоменклатурыОбороты.Регистратор КАК Документ.ПересортицаТоваров).ДокументОснование
		|		КОГДА СерийныеНомераНоменклатурыОбороты.Регистратор ССЫЛКА Документ.СборкаТоваров
		|			ТОГДА ВЫРАЗИТЬ(СерийныеНомераНоменклатурыОбороты.Регистратор КАК Документ.СборкаТоваров).ЗаказНаСборку
		|		КОГДА СерийныеНомераНоменклатурыОбороты.Регистратор ССЫЛКА Документ.СписаниеНедостачТоваров
		|			ТОГДА ВЫРАЗИТЬ(СерийныеНомераНоменклатурыОбороты.Регистратор КАК Документ.СписаниеНедостачТоваров).ДокументОснование
		|		КОГДА СерийныеНомераНоменклатурыОбороты.Регистратор ССЫЛКА Документ.ВнутреннееПотреблениеТоваров
		|			ТОГДА ВЫРАЗИТЬ(СерийныеНомераНоменклатурыОбороты.Регистратор КАК Документ.ВнутреннееПотреблениеТоваров).ЗаказНаВнутреннееПотребление
		|		ИНАЧЕ NULL
		|	КОНЕЦ КАК ДокументОснование,
		|	ВЫБОР
		|		КОГДА СерийныеНомераНоменклатурыОбороты.Регистратор ССЫЛКА Документ.РасходныйОрдерНаТовары
		|			ТОГДА ВЫРАЗИТЬ(СерийныеНомераНоменклатурыОбороты.Регистратор КАК Документ.РасходныйОрдерНаТовары).Распоряжение.Контрагент
		|		КОГДА СерийныеНомераНоменклатурыОбороты.Регистратор ССЫЛКА Документ.ВозвратТоваровОтКлиента
		|			ТОГДА ВЫРАЗИТЬ(СерийныеНомераНоменклатурыОбороты.Регистратор КАК Документ.ВозвратТоваровОтКлиента).Контрагент
		|		КОГДА СерийныеНомераНоменклатурыОбороты.Регистратор ССЫЛКА Документ.ВозвратТоваровПоставщику
		|			ТОГДА ВЫРАЗИТЬ(СерийныеНомераНоменклатурыОбороты.Регистратор КАК Документ.ВозвратТоваровПоставщику).Контрагент
		|		КОГДА СерийныеНомераНоменклатурыОбороты.Регистратор ССЫЛКА Документ.ПоступлениеТоваровУслуг
		|			ТОГДА ВЫРАЗИТЬ(СерийныеНомераНоменклатурыОбороты.Регистратор КАК Документ.ПоступлениеТоваровУслуг).Контрагент
		|		КОГДА СерийныеНомераНоменклатурыОбороты.Регистратор ССЫЛКА Документ.ПриходныйОрдерНаТовары
		|			ТОГДА ВЫРАЗИТЬ(СерийныеНомераНоменклатурыОбороты.Регистратор КАК Документ.ПриходныйОрдерНаТовары).Распоряжение.Контрагент
		|		КОГДА СерийныеНомераНоменклатурыОбороты.Регистратор ССЫЛКА Документ.РеализацияТоваровУслуг
		|			ТОГДА ВЫРАЗИТЬ(СерийныеНомераНоменклатурыОбороты.Регистратор КАК Документ.РеализацияТоваровУслуг).Контрагент
		|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
		|	КОНЕЦ КАК Контрагент,
		|	ВЫБОР
		|		КОГДА СерийныеНомераНоменклатурыОбороты.Регистратор ССЫЛКА Документ.ВводОстатков
		|			ТОГДА ВЫРАЗИТЬ(СерийныеНомераНоменклатурыОбороты.Регистратор КАК Документ.ВводОстатков).Ответственный
		|		КОГДА СерийныеНомераНоменклатурыОбороты.Регистратор ССЫЛКА Документ.ВнутреннееПотреблениеТоваров
		|			ТОГДА ВЫРАЗИТЬ(СерийныеНомераНоменклатурыОбороты.Регистратор КАК Документ.ВнутреннееПотреблениеТоваров).Ответственный
		|		КОГДА СерийныеНомераНоменклатурыОбороты.Регистратор ССЫЛКА Документ.ВозвратТоваровОтКлиента
		|			ТОГДА ВЫРАЗИТЬ(СерийныеНомераНоменклатурыОбороты.Регистратор КАК Документ.ВозвратТоваровОтКлиента).Менеджер
		|		КОГДА СерийныеНомераНоменклатурыОбороты.Регистратор ССЫЛКА Документ.ВозвратТоваровПоставщику
		|			ТОГДА ВЫРАЗИТЬ(СерийныеНомераНоменклатурыОбороты.Регистратор КАК Документ.ВозвратТоваровПоставщику).Менеджер
		|		КОГДА СерийныеНомераНоменклатурыОбороты.Регистратор ССЫЛКА Документ.ОприходованиеИзлишковТоваров
		|			ТОГДА ВЫРАЗИТЬ(СерийныеНомераНоменклатурыОбороты.Регистратор КАК Документ.ОприходованиеИзлишковТоваров).Ответственный
		|		КОГДА СерийныеНомераНоменклатурыОбороты.Регистратор ССЫЛКА Документ.ПеремещениеТоваров
		|			ТОГДА ВЫРАЗИТЬ(СерийныеНомераНоменклатурыОбороты.Регистратор КАК Документ.ПеремещениеТоваров).Ответственный
		|		КОГДА СерийныеНомераНоменклатурыОбороты.Регистратор ССЫЛКА Документ.ПересортицаТоваров
		|			ТОГДА ВЫРАЗИТЬ(СерийныеНомераНоменклатурыОбороты.Регистратор КАК Документ.ПересортицаТоваров).Ответственный
		|		КОГДА СерийныеНомераНоменклатурыОбороты.Регистратор ССЫЛКА Документ.ПоступлениеТоваровУслуг
		|			ТОГДА ВЫРАЗИТЬ(СерийныеНомераНоменклатурыОбороты.Регистратор КАК Документ.ПоступлениеТоваровУслуг).Менеджер
		|		КОГДА СерийныеНомераНоменклатурыОбороты.Регистратор ССЫЛКА Документ.ПриходныйОрдерНаТовары
		|			ТОГДА ВЫРАЗИТЬ(СерийныеНомераНоменклатурыОбороты.Регистратор КАК Документ.ПриходныйОрдерНаТовары).Ответственный
		|		КОГДА СерийныеНомераНоменклатурыОбороты.Регистратор ССЫЛКА Документ.РасходныйОрдерНаТовары
		|			ТОГДА ВЫРАЗИТЬ(СерийныеНомераНоменклатурыОбороты.Регистратор КАК Документ.РасходныйОрдерНаТовары).Ответственный
		|		КОГДА СерийныеНомераНоменклатурыОбороты.Регистратор ССЫЛКА Документ.РеализацияТоваровУслуг
		|			ТОГДА ВЫРАЗИТЬ(СерийныеНомераНоменклатурыОбороты.Регистратор КАК Документ.РеализацияТоваровУслуг).Менеджер
		|		КОГДА СерийныеНомераНоменклатурыОбороты.Регистратор ССЫЛКА Документ.СборкаТоваров
		|			ТОГДА ВЫРАЗИТЬ(СерийныеНомераНоменклатурыОбороты.Регистратор КАК Документ.СборкаТоваров).Ответственный
		|		КОГДА СерийныеНомераНоменклатурыОбороты.Регистратор ССЫЛКА Документ.СписаниеНедостачТоваров
		|			ТОГДА ВЫРАЗИТЬ(СерийныеНомераНоменклатурыОбороты.Регистратор КАК Документ.СписаниеНедостачТоваров).Ответственный
		|	КОНЕЦ КАК Ответственный,
		|	КешГарантия.Значение КАК Гарантия,
		|	СерийныеНомераНоменклатурыОбороты.СерийныеНомера КАК СерийныйНомер
		| ПОМЕСТИТЬ ОсновнойКеш
		|ИЗ
		|	РегистрНакопления.СерийныеНомераНоменклатуры.Обороты(&ДатаНач, 
		|														 &ДатаКон, 
		|														 Регистратор, 
		|														 %УсловиеСН%
		|														) КАК СерийныеНомераНоменклатурыОбороты
		|		ЛЕВОЕ СОЕДИНЕНИЕ КешГарантия КАК КешГарантия
		|		ПО СерийныеНомераНоменклатурыОбороты.Номенклатура = КешГарантия.Номенклатура
		| "
		+?(Контрагенты.Пустая()," ","  ГДЕ
		|	ВЫБОР
		|		КОГДА СерийныеНомераНоменклатурыОбороты.Регистратор ССЫЛКА Документ.РасходныйОрдерНаТовары
		|			ТОГДА ВЫРАЗИТЬ(СерийныеНомераНоменклатурыОбороты.Регистратор КАК Документ.РасходныйОрдерНаТовары).Распоряжение.Контрагент = &Контрагент
		|		КОГДА СерийныеНомераНоменклатурыОбороты.Регистратор ССЫЛКА Документ.ВозвратТоваровОтКлиента
		|			ТОГДА ВЫРАЗИТЬ(СерийныеНомераНоменклатурыОбороты.Регистратор КАК Документ.ВозвратТоваровОтКлиента).Контрагент = &Контрагент
		|		КОГДА СерийныеНомераНоменклатурыОбороты.Регистратор ССЫЛКА Документ.ВозвратТоваровПоставщику
		|			ТОГДА ВЫРАЗИТЬ(СерийныеНомераНоменклатурыОбороты.Регистратор КАК Документ.ВозвратТоваровПоставщику).Контрагент  = &Контрагент
		|		КОГДА СерийныеНомераНоменклатурыОбороты.Регистратор ССЫЛКА Документ.ПоступлениеТоваровУслуг
		|			ТОГДА ВЫРАЗИТЬ(СерийныеНомераНоменклатурыОбороты.Регистратор КАК Документ.ПоступлениеТоваровУслуг).Контрагент = &Контрагент
		|		КОГДА СерийныеНомераНоменклатурыОбороты.Регистратор ССЫЛКА Документ.ПриходныйОрдерНаТовары
		|			ТОГДА ВЫРАЗИТЬ(СерийныеНомераНоменклатурыОбороты.Регистратор КАК Документ.ПриходныйОрдерНаТовары).Распоряжение.Контрагент = &Контрагент
		|		КОГДА СерийныеНомераНоменклатурыОбороты.Регистратор ССЫЛКА Документ.РеализацияТоваровУслуг
		|			ТОГДА ВЫРАЗИТЬ(СерийныеНомераНоменклатурыОбороты.Регистратор КАК Документ.РеализацияТоваровУслуг).Контрагент  = &Контрагент
		|	КОНЕЦ 	")+"  
		|;
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ   РАЗЛИЧНЫЕ
		|	ОсновнойКеш.Дата,
		|	ОсновнойКеш.ДокументСсылка,
		|	ОсновнойКеш.НомерДок,
		|	ОсновнойКеш.ДокументОснование,
		|	ОсновнойКеш.Контрагент,
		|	ОсновнойКеш.Ответственный,
		|	ОсновнойКеш.Гарантия,
		|	ОсновнойКеш.СерийныйНомер,
		|	ТИПЗначения(ОсновнойКеш.ДокументОснование) КАК ТипДокумента,
		|	ЕСТЬNULL(КешНазначения.Назначение, ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка)) КАК Назначение
		|ИЗ
		|	ОсновнойКеш КАК ОсновнойКеш
		|		ЛЕВОЕ СОЕДИНЕНИЕ КешНазначения КАК КешНазначения
		|		ПО  ОсновнойКеш.ДокументОснование = КешНазначения.Регистратор
		|		ИЛИ ОсновнойКеш.ДокументСсылка    = КешНазначения.Регистратор
		|		
		|УПОРЯДОЧИТЬ ПО
		|	ОсновнойКеш.Дата УБЫВ";
		
		Если Флаг = "ТочныйПоиск" Тогда
			УсловиеСН = " СерийныеНомера.Код = &СерийныйНомер";
		Иначе 
			УсловиеСН = " СерийныеНомера.Код ПОДОБНО &СерийныйНомер";
		КонецЕсли;
		
		ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "%УсловиеСН%", УсловиеСН);	
	Возврат ТекстЗапроса;	
КонецФункции

&НаСервере
Функция СформироватьУмовуПоискСН()

	Если Флаг = "ПоискПоЧасти" Тогда
		
		Поиск = "%" + ПоискСерийника + "%";
		
	ИначеЕсли Флаг = "ПоискПохожих" Тогда
		
		Строка = ПоискСерийника;
		Длина = СтрДлина(Строка);
		Поиск = "";
		Для Инд = 1 По Длина Цикл
			Поиск = Поиск + "%" + Лев(Строка, 1);
			Строка = Прав(Строка, Длина - Инд);
		КонецЦикла;
		Поиск = Поиск + "%";
	Иначе 
		Поиск = ПоискСерийника;
	КонецЕсли;
	
	Возврат Поиск;
	
КонецФункции

&НаСервере
Процедура ТаблицаРезультатСортировкаНаСервере()
	Если ПолеСортировки = "" Или ПорядокСортировки = "" Тогда 
		Возврат;
	КонецЕсли;
	ТаблицаРезультат.Сортировать(ПолеСортировки +ПорядокСортировки); 	
КонецПроцедуры
	
&НаКлиенте
Функция ПолучитьИдентификаторИмяКолонки(ИмяКоллекцииЗначений)
	ТДанные  = Элементы[ИмяКоллекцииЗначений].ТекущиеДанные;
	ТЭлемент = Элементы[ИмяКоллекцииЗначений].ТекущийЭлемент;
	Возврат Новый Структура("Отказ, Идентификатор, Имя",  ТДанные = Неопределено ИЛИ ТЭлемент = Неопределено, 
														?(ТДанные = Неопределено, Неопределено, ТДанные.ПолучитьИдентификатор()), 
														?(ТЭлемент= Неопределено, Неопределено, ТЭлемент.Имя));		
КонецФункции
#КонецОбласти
