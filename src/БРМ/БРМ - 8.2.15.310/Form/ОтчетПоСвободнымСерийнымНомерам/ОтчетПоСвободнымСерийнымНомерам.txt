#Область ИнтерфейсАвтоматическихТестов
&НаКлиенте
Перем ЮнитТест;

&НаКлиенте
Функция ПолучитьСписокТестов(ЮнитТестирование) Экспорт
	
	ЮнитТест 		= ЮнитТестирование;
	СпиcокТестов 	= Новый Массив;
	СпиcокТестов.Добавить("Тест_ПроверитьВалидностьЗапроса");
	СпиcокТестов.Добавить("Тест_ПроверитьФормированияОтчета");

	Возврат СпиcокТестов;
	
КонецФункции

&НаКлиенте
Процедура Тест_ПроверитьВалидностьЗапроса() Экспорт   	
	
	ТекстЗапроса = СформироватьТекстЗапроса();
	ЮнитТест.ПроверитьТип(ТекстЗапроса, Тип("Строка"));
	Тест_ПроверитьТекстЗапросНаОшибки(ТекстЗапроса);
КонецПроцедуры

&НаСервере
Процедура Тест_ПроверитьТекстЗапросНаОшибки(ТекстЗапроса) Экспорт
	
	СхемаКомпоновкиДанных = Новый СхемаКомпоновкиДанных;
	
	ИсточникДанных 					  = СхемаКомпоновкиДанных.ИсточникиДанных.Добавить(); 
	ИсточникДанных.Имя                = "ИсточникДанных";
	ИсточникДанных.СтрокаСоединения   = "";
	ИсточникДанных.ТипИсточникаДанных = "Local";
	
	НаборДанных 							 = СхемаКомпоновкиДанных.НаборыДанных.Добавить(Тип("НаборДанныхЗапросСхемыКомпоновкиДанных"));
	НаборДанных.Имя            				 = "НаборДанных";
	НаборДанных.ИсточникДанных 				 = "ИсточникДанных";
	НаборДанных.АвтоЗаполнениеДоступныхПолей = Истина;
	НаборДанных.Запрос 						 = ТекстЗапроса;
	
	КомпоновщикНастроек = Новый КомпоновщикНастроекКомпоновкиДанных;
	КомпоновщикНастроек.Инициализировать(Новый ИсточникДоступныхНастроекКомпоновкиДанных(СхемаКомпоновкиДанных));
 

КонецПроцедуры // Тест_ПроверитьТекстЗапросНаОшибки(ТекстЗапроса)

&НаКлиенте
Процедура Тест_ПроверитьФормированияОтчета() Экспорт   	
	СформироватьОтчетНаСервере();
КонецПроцедуры

#КонецОбласти


#Область ОбработчикиСобытийФормы

&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	Номенклатура = Параметры.Номенклатура;
	СформироватьОтчетНаСервере();
КонецПроцедуры

#КонецОбласти




#Область ОбработчикиСобытийЭлементовШапкиФормы

&НаКлиенте
Процедура СкладПриИзменении(Элемент)
	СформироватьОтчетНаСервере();
КонецПроцедуры

&НаКлиенте
Процедура НоменклатураПриИзменении(Элемент)
	СформироватьОтчетНаСервере();
КонецПроцедуры
#КонецОбласти

#Область ОбработчикиТаблициРезультат
&НаКлиенте
Процедура РезультатОбработкаРасшифровки(Элемент, Расшифровка, СтандартнаяОбработка)
	Перем ВыполненноеДействие;
	Перем ПараметрВыполненногоДействия;
	
	СтандартнаяОбработка = Ложь;
	
	Режим = РежимДиалогаВопрос.ДаНет;
	Ответ = Вопрос(НСтр("ru = 'Вы уверены , что хотите обозначить распакованный товар?'"), Режим);
	Если Ответ = КодВозвратаДиалога.Нет Тогда
	    Возврат;
	КонецЕсли;

	РезультатРасшифровки = ПолучитьДанныеРасшифровки(Расшифровка);
	
	Если РезультатРасшифровки=Неопределено Тогда 		
		СообщенияОбОшибке = НСтр("ru='Для установки распакованого товару нужно выбрать строку из серийным номером.'", ОбщегоНазначенияКлиентСервер.КодОсновногоЯзыка());
        ОбщегоНазначенияКлиентСервер.СообщитьПользователю(СообщенияОбОшибке); 
		Возврат;	
	КонецЕсли;
	
	Если ТипЗнч(РезультатРасшифровки)= Тип("СправочникСсылка.СерийныеНомераНоменклатуры") Тогда
		Если ЭтотТоварРаспакован(РезультатРасшифровки) = ЛОЖЬ Тогда
			УИДФормы	= Новый УникальныйИдентификатор;
			Оповещение 	= Новый ОписаниеОповещения("ВыдаватьСообщенияПослеЗакрытияФормы",ЭтаФорма);
			ОткрытьФорму("ВнешняяОбработка.МногофунциональноеРабочееМесто.Форма.ФормаРаспакованогоТовараПоСерийнымНомерам",
					Новый Структура("СерийныеНомераНоменклатуры",РезультатРасшифровки),
					ЭтаФорма,
					УИДФормы,
					,
					,
					Оповещение,
					РежимОткрытияОкнаФормы.БлокироватьОкноВладельца
					);

		
		Иначе
			СообщенияОбОшибке = НСтр("ru='Товар по данному серийнку распакован.'", ОбщегоНазначенияКлиентСервер.КодОсновногоЯзыка());
	        ОбщегоНазначенияКлиентСервер.СообщитьПользователю(СообщенияОбОшибке); 
			Возврат;  		
		КонецЕсли;
		
	Иначе
		СообщенияОбОшибке = НСтр("ru='Значение данных расшифровки отсутствует, либо имеет неправильный тип.'", ОбщегоНазначенияКлиентСервер.КодОсновногоЯзыка());
        ОбщегоНазначенияКлиентСервер.СообщитьПользователю(СообщенияОбОшибке); 
		Возврат; 	
	КонецЕсли;

КонецПроцедуры

&НаКлиенте
Процедура ВыдаватьСообщенияПослеЗакрытияФормы(Результат, ДополнительныеПараметры)Экспорт
	СформироватьОтчетНаСервере(); 
КонецПроцедуры // ВыдаватьСообщенияПослеЗакрытияФормы()




#КонецОбласти

#Область ОбработчикиКомандФормы

&НаКлиенте
Процедура СформироватьОтчет(Команда)
	СформироватьОтчетНаСервере();
КонецПроцедуры

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

&НаСервере
Функция ПолучитьДанныеРасшифровки(Расшифровка)

	УстановитьПривилегированныйРежим(Истина);
	
	ДанныеРасшифровкиИзХранилища 	= ПолучитьИзВременногоХранилища(АдресХранилища);
	Расшифровки    					= ДанныеРасшифровкиИзХранилища.Элементы[Расшифровка];
	ПоляРасшифровки					= Расшифровки.ПолучитьПоля();
	
	Если ПоляРасшифровки[0].Поле = "СерийныйНомер" Тогда
		Возврат ПоляРасшифровки[0].Значение;
	ИначеЕсли  ПоляРасшифровки[0].Поле = "Ответственный" Тогда
		КоллекцияРасшифровки    = ДанныеРасшифровкиИзХранилища.Элементы[Расшифровка-2];
		ПоляРасшифровки			= КоллекцияРасшифровки.ПолучитьПоля();
		Возврат ПоляРасшифровки[0].Значение;
	ИначеЕсли  ПоляРасшифровки[0].Поле = "Распакован" Тогда
		КоллекцияРасшифровки    = ДанныеРасшифровкиИзХранилища.Элементы[Расшифровка-1];
		ПоляРасшифровки			= КоллекцияРасшифровки.ПолучитьПоля();
		Возврат ПоляРасшифровки[0].Значение;
	ИначеЕсли  ПоляРасшифровки[0].Поле = "Комментарий" Тогда
		КоллекцияРасшифровки    = ДанныеРасшифровкиИзХранилища.Элементы[Расшифровка-4];
		ПоляРасшифровки			= КоллекцияРасшифровки.ПолучитьПоля();
		Возврат ПоляРасшифровки[0].Значение;  
	ИначеЕсли  ПоляРасшифровки[0].Поле = "Подразделение" Тогда
		КоллекцияРасшифровки    = ДанныеРасшифровкиИзХранилища.Элементы[Расшифровка-3];
		ПоляРасшифровки			= КоллекцияРасшифровки.ПолучитьПоля();
		Возврат ПоляРасшифровки[0].Значение; 
	Иначе
		Возврат Неопределено;                  
	КонецЕсли;
	
КонецФункции // ПолучитьДанныеРасшифровки()

&НаСервере
Процедура СформироватьОтчетНаСервере()

	УстановитьПривилегированныйРежим(Истина);
	
	Результат.Очистить();
	
	Запрос = Новый Запрос;
	Запрос.Текст = СформироватьТекстЗапроса();
	
	Если Не Номенклатура.Пустая() Тогда
		Запрос.УстановитьПараметр("Номенклатура", Номенклатура);
	КонецЕсли;
	
	СписокНоменклатуры = Запрос.Выполнить().Выгрузить();
	
	ВнешниеНаборыДанных = Новый Структура;
	ВнешниеНаборыДанных.Вставить("СписокНоменклатуры", СписокНоменклатуры);
	
	ОбъектОбработки 		= РеквизитФормыВЗначение("Объект");
	СхемаКомпоновкиДанных   = ОбъектОбработки.ПолучитьМакет("СКД_СерийныеНомера");
	ЗначениеВРеквизитФормы(ОбъектОбработки, "Объект");
	
	Настройки 					= СхемаКомпоновкиДанных.НастройкиПоУмолчанию;
	
	КомпоновщикМакета 			= Новый КомпоновщикМакетаКомпоновкиДанных;
	ДанныеРасшифровкиКД			= Новый ДанныеРасшифровкиКомпоновкиДанных;
	МакетКомпоновки				= КомпоновщикМакета.Выполнить(СхемаКомпоновкиДанных, Настройки, ДанныеРасшифровкиКД);
	
	ПроцессорКомпоновкиДанны    = Новый ПроцессорКомпоновкиДанных;
	ПроцессорКомпоновкиДанны.Инициализировать(МакетКомпоновки, ВнешниеНаборыДанных, ДанныеРасшифровкиКД);
	
	ПроцессорВывода				= Новый ПроцессорВыводаРезультатаКомпоновкиДанныхВТабличныйДокумент;
	ПроцессорВывода.УстановитьДокумент(Результат);
	ПроцессорВывода.Вывести(ПроцессорКомпоновкиДанны);
	
	АдресХранилища = ПоместитьВоВременноеХранилище(ДанныеРасшифровкиКД,ЭтаФорма.УникальныйИдентификатор);


КонецПроцедуры // СформироватьОтчетНаСервере()

&НаСервере
Функция СформироватьТекстЗапроса()

	ТекстЗапроса = "ВЫБРАТЬ
	               |	СерийныеНомераНоменклатуры.Склад КАК Склад,
	               |	СерийныеНомераНоменклатуры.Номенклатура КАК Номенклатура,
	               |	СерийныеНомераНоменклатуры.СерийныеНомера КАК СерийныйНомер
	               |ПОМЕСТИТЬ СерийныеНомера
	               |ИЗ
				   |	РегистрНакопления.СерийныеНомераНоменклатуры.Остатки(
				   |			,
				   |			%ОтборПоНоменклатуре%) КАК СерийныеНомераНоменклатуры
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |ВЫБРАТЬ
	               |	СерийныеНомера.Склад,
	               |	СерийныеНомера.Номенклатура,
	               |	СерийныеНомера.СерийныйНомер,
				   |	СерийныеНомераНоменклатуры.Комментарий КАК Комментарий,
	               |	СерийныеНомераНоменклатуры.Распакован КАК Распакован,
	               |	СерийныеНомераНоменклатуры.Ответственный КАК Ответственный,
	               |	СерийныеНомераНоменклатуры.Ответственный.ТекущееПодразделение  КАК Подразделение
	               |ИЗ
	               |	СерийныеНомера КАК СерийныеНомера
				   |
	               |ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.СерийныеНомераНоменклатуры КАК СерийныеНомераНоменклатуры
	               |ПО СерийныеНомера.СерийныйНомер = СерийныеНомераНоменклатуры.Ссылка";				   			
	
	Если Не Номенклатура.Пустая() Тогда
		ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "%ОтборПоНоменклатуре%", "Номенклатура = &Номенклатура");
	Иначе
		ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "%ОтборПоНоменклатуре%", "");
	КонецЕсли;
	
	Возврат ТекстЗапроса;

КонецФункции // СформироватьТекстЗапроса()

&НаСервере
Функция ЭтотТоварРаспакован(СерийныеНомераНоменклатуры)
	Если СерийныеНомераНоменклатуры.Пустая() Тогда
		Возврат ЛОЖЬ;	
	КонецЕсли; 
	Возврат   СерийныеНомераНоменклатуры.Распакован;
КонецФункции // ()

#КонецОбласти






 