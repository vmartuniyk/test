

////////////////////////////////////////////////////////////////////////////////
// ОБРАБОТЧИКИ СОБЫТИЙ ФОРМЫ

&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	Номенклатура = Параметры.Номенклатура;
	СформироватьОтчетНаСервере();
КонецПроцедуры







////////////////////////////////////////////////////////////////////////////////
// ОБРАБОТЧИКИ СОБЫТИЙ ЭЛЕМЕНТОВ ШАПКИ ФОРМЫ

&НаКлиенте
Процедура СкладПриИзменении(Элемент)
	СформироватьОтчетНаСервере();
КонецПроцедуры

&НаКлиенте
Процедура НоменклатураПриИзменении(Элемент)
	СформироватьОтчетНаСервере();
КонецПроцедуры





////////////////////////////////////////////////////////////////////////////////
// ОБРАБОТЧИКИ КОМАНД ФОРМЫ

&НаКлиенте
Процедура СформироватьОтчет(Команда)
	СформироватьОтчетНаСервере();
КонецПроцедуры







////////////////////////////////////////////////////////////////////////////////
// СЛУЖЕБНЫЕ ПРОЦЕДУРЫ И ФУНКЦИИ

&НаСервере
Процедура СформироватьОтчетНаСервере()

	УстановитьПривилегированныйРежим(Истина);
	
	Результат.Очистить();
	
	Запрос = Новый Запрос;
	Запрос.Текст = СформироватьТекстЗапроса();
	
	Если Не Номенклатура.Пустая() Тогда
		Запрос.УстановитьПараметр("Номенклатура", Номенклатура);
	КонецЕсли;
	
	СписокНоменклатуры = Запрос.Выполнить().Выгрузить();
	
	ВнешниеНаборыДанных = Новый Структура;
	ВнешниеНаборыДанных.Вставить("СписокНоменклатуры", СписокНоменклатуры);
	
	ОбъектОбработки 		= РеквизитФормыВЗначение("Объект");
	СхемаКомпоновкиДанных   = ОбъектОбработки.ПолучитьМакет("СКД_СерийныеНомера");
	ЗначениеВРеквизитФормы(ОбъектОбработки, "Объект");
	
	Настройки 					= СхемаКомпоновкиДанных.НастройкиПоУмолчанию;
	
	КомпоновщикМакета 			= Новый КомпоновщикМакетаКомпоновкиДанных;
	ДанныеРасшифровкиКД			= Новый ДанныеРасшифровкиКомпоновкиДанных;
	МакетКомпоновки				= КомпоновщикМакета.Выполнить(СхемаКомпоновкиДанных, Настройки, ДанныеРасшифровкиКД);
	
	ПроцессорКомпоновкиДанны    = Новый ПроцессорКомпоновкиДанных;
	ПроцессорКомпоновкиДанны.Инициализировать(МакетКомпоновки, ВнешниеНаборыДанных, ДанныеРасшифровкиКД);
	
	ПроцессорВывода				= Новый ПроцессорВыводаРезультатаКомпоновкиДанныхВТабличныйДокумент;
	ПроцессорВывода.УстановитьДокумент(Результат);
	ПроцессорВывода.Вывести(ПроцессорКомпоновкиДанны);

КонецПроцедуры // СформироватьОтчетНаСервере()

&НаСервере
Функция СформироватьТекстЗапроса()

	ТекстЗапроса = "ВЫБРАТЬ
	               |	СерийныеНомераНоменклатуры.Склад КАК Склад,
	               |	СерийныеНомераНоменклатуры.Номенклатура КАК Номенклатура,
	               |	СерийныеНомераНоменклатуры.СерийныеНомера КАК СерийныйНомер
	               |ИЗ
	               |	РегистрНакопления.СерийныеНомераНоменклатуры.Остатки(
	               |			,
	               |			%ОтборПоНоменклатуре%) КАК СерийныеНомераНоменклатуры";
				   			
	
	Если Не Номенклатура.Пустая() Тогда
		ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "%ОтборПоНоменклатуре%", "Номенклатура = &Номенклатура");
	Иначе
		ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "%ОтборПоНоменклатуре%", "");
	КонецЕсли;
	
	Возврат ТекстЗапроса;

КонецФункции // СформироватьТекстЗапроса()






 