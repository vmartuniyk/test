
////////////////////////////////////////////////////////////////////////////////
// ОБРАБОТЧИКИ СОБЫТИЙ ФОРМЫ 

&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	
	СкладОтправитель		= Параметры.Склад;
	СкладОтправительСтрока 	= СкладОтправитель;
	
	УстановитьПривилегированныйРежим(Истина);
	Запрос = Новый Запрос;
	Запрос.Текст = "
		|ВЫБРАТЬ 
		|	ВидЦены 
		|ИЗ 
		|	РегистрСведений.ALPS_ВидыЦен 
		|ГДЕ
		|	Входная";
	Выборка = Запрос.Выполнить().Выбрать();
	ВидЦены = ?(Выборка.Следующий(), Выборка.ВидЦены, ВидЦены);	

	ТекущаяДата = ТекущаяДата();
	
КонецПроцедуры



&НаКлиенте
Процедура ТекущаяДатаПриИзменении(Элемент)
	ВыполнитьРасчетДоставки();
КонецПроцедуры



&НаКлиенте
Процедура СкладОтправительНачалоВыбораИзСписка(Элемент, СтандартнаяОбработка)
	ВыбораИзСписка("СкладОтправитель");
КонецПроцедуры

&НаКлиенте
Процедура СкладОтправительОбработкаВыбора(Элемент, ВыбранноеЗначение, СтандартнаяОбработка)
	СтандартнаяОбработка 	= Ложь;
	СкладОтправитель 		= ВыбранноеЗначение;
	СкладОтправительСтрока 	= Элементы.СкладОтправитель.СписокВыбора.НайтиПоЗначению(ВыбранноеЗначение).Представление;
	ВыполнитьРасчетДоставки();
КонецПроцедуры



&НаКлиенте
Процедура СкладПолучательНачалоВыбораИзСписка(Элемент, СтандартнаяОбработка)
	ВыбораИзСписка("СкладПолучатель");
КонецПроцедуры

&НаКлиенте
Процедура СкладПолучательОбработкаВыбора(Элемент, ВыбранноеЗначение, СтандартнаяОбработка)
	СтандартнаяОбработка 	= Ложь;
	СкладПолучатель 		= ВыбранноеЗначение;
	СкладПолучательСтрока 	= Элементы.СкладПолучатель.СписокВыбора.НайтиПоЗначению(ВыбранноеЗначение).Представление;
	ВыполнитьРасчетДоставки();
КонецПроцедуры









////////////////////////////////////////////////////////////////////////////////
// ОБРАБОТЧИКИ КОМАНД ФОРМЫ

&НаКлиенте
Процедура ВыполнитьПрямоеПеремещение(Команда)
	
	Если НЕ СкладОтправитель.Пустая() И НЕ СкладПолучатель.Пустая() Тогда
		
		Если ВыездОтОтправителя = Дата(1,1,1) Тогда
			Если Вопрос("Данное перемещение не попадает в доставку, продолжить?", РежимДиалогаВопрос.ДаНет) = КодВозвратаДиалога.Нет Тогда
				Возврат;	
			КонецЕсли;	
		КонецЕсли;
		
		Если ВыездКПолучателю = Дата(1,1,1) ИЛИ Телепорт Тогда
			Закрыть(Новый Структура("СкладОтправитель, СкладПолучатель, ВидЦены", 
								СкладОтправитель,  
								СкладПолучатель,
								ВидЦены
								)
			   		);		 
		КонецЕсли;
				
		Если НЕ ТранзитныйСклад.Пустая() Тогда
			Закрыть(Новый Структура("СкладОтправитель, ТранзитныйСклад, СкладПолучатель, ВидЦены", 
								СкладОтправитель, 
								ТранзитныйСклад, 
								СкладПолучатель,
								ВидЦены
								)
			   		);	
		КонецЕсли;
		
	КонецЕсли;
			   
КонецПроцедуры



////////////////////////////////////////////////////////////////////////////////
// СЛУЖЕБНЫЕ ПРОЦЕДУРЫ И ФУНКЦИИ

&НаКлиенте
Процедура ВыполнитьРасчетДоставки()	
	Если НЕ СкладОтправитель.Пустая() ИЛИ НЕ СкладПолучатель.Пустая() Тогда
		ВыполнитьРасчетДоставкиНаСервере();	
	КонецЕсли;
КонецПроцедуры

&НаКлиенте
Процедура ВыбораИзСписка(ИмяЭлемента)
	СписокЭлементов = ПолучитьСписокСкладов(ИмяЭлемента);
	Элементы[ИмяЭлемента].СписокВыбора.Очистить();
	Для Каждого ЭлементСписка Из СписокЭлементов Цикл 
		Элементы[ИмяЭлемента].СписокВыбора.Добавить(ЭлементСписка.Значение, ЭлементСписка.Представление); 
	КонецЦикла;
КонецПроцедуры

&НаСервере
Функция ПолучитьСписокСкладов(ИмяЭлемента)
	
	УстановитьПривилегированныйРежим(Истина);
	Запрос = Новый Запрос(?(ИмяЭлемента = "СкладПолучатель","ВЫБРАТЬ Ссылка, Наименование ИЗ Справочник.Склады ГДЕ НЕ ЭтоГруппа", "ВЫБРАТЬ Ссылка, Наименование ИЗ Справочник.Склады ГДЕ (Ссылка = &Склад ИЛИ Ссылка.ИспользоватьОрдернуюСхемуПриОтгрузке) И НЕ ЭтоГруппа"));
	Запрос.УстановитьПараметр("Склад", СкладОтправитель);
	Выборка = Запрос.Выполнить().Выбрать();
	СписокЗначений = Новый СписокЗначений;
	Пока Выборка.Следующий() Цикл
		СписокЗначений.Добавить(Выборка.Ссылка, Выборка.Наименование) 
	КонецЦикла;
	
	Возврат СписокЗначений;
	
КонецФункции

&НаСервере
Процедура ВыполнитьРасчетДоставкиНаСервере()

	УстановитьПривилегированныйРежим(Истина);
	
	ПрямойВыезд 	= Дата(1,1,1);
	ТранзитВыездОт  = Дата(1,1,1);
	ТранзитВыездК 	= Дата(1,1,1);
	
	ТранзитныйСклад 	  				= Неопределено;
	ВыездОтОтправителя 					= Неопределено;
	ВыездКПолучателю		 			= Неопределено;	
		
	Запрос = Новый Запрос;
	Запрос.МенеджерВременныхТаблиц = Новый МенеджерВременныхТаблиц;
	Запрос.Текст = ПолучитьТекстЗапросаТранзитногоСклада();
	Запрос.УстановитьПараметр("ДатаСеанса", ТекущаяДата);	
	Запрос.УстановитьПараметр("СкладОтправитель", СкладОтправитель);
	Запрос.УстановитьПараметр("СкладПолучатель", СкладПолучатель);
	РезультатПакета = Запрос.ВыполнитьПакет();	
	
	Выборка = РезультатПакета[4].Выбрать();
	Если Выборка.Следующий() Тогда
		ПрямойВыезд = Выборка.ДатаВремяВыезда;
		ПрямойВариантМаршрута = Выборка.Маршрут;
	КонецЕсли;
	
	Выборка = РезультатПакета[13].Выбрать();
	Если Выборка.Следующий() Тогда
		ТранзитныйСклад = Выборка.СкладТранзит;
		ТранзитВыездОт = Выборка.ДатаВремяВыездаОтОтправителя;
		ТранзитВыездК = Выборка.ДатаВремяВыездаКПолучателю;
	КонецЕсли;
	
	Если ПрямойВариантМаршрута = Неопределено
	 ИЛИ (ТранзитВыездК <> Дата(1,1,1) И ТранзитВыездК < ПрямойВыезд)Тогда
		ВыездОтОтправителя = ТранзитВыездОт;
		ВыездКПолучателю   = ТранзитВыездК;
		Если ВыездОтОтправителя = ВыездКПолучателю   
		  И	 ВыездОтОтправителя <> Дата(1,1,1) Тогда
			ВыездКПолучателю = ВыездКПолучателю + 86400;		
		КонецЕсли;
	Иначе	
		ВыездОтОтправителя = ПрямойВыезд;
		ТранзитныйСклад	   = Неопределено;
	КонецЕсли; 
	
КонецПроцедуры // ВыполнитьРасчетДоставкиНаСервере()

&НаСервереБезКонтекста
Функция ПолучитьТекстЗапросаТранзитногоСклада()

	ТекстЗапроса = "
		////////////////////////////////////////////////////////////////////////////////
		//
		|ВЫБРАТЬ
		|	Ссылка			КАК Склад,
		|	Представление   КАК Представление
		|ПОМЕСТИТЬ АдресаСкладов
		|ИЗ
		|	Справочник.Склады.КонтактнаяИнформация
		|ГДЕ
		|	Тип = ЗНАЧЕНИЕ(Перечисление.ТипыКонтактнойИнформации.Адрес)
		|;
		////////////////////////////////////////////////////////////////////////////////
		//
		|ВЫБРАТЬ
		|	Ссылка КАК Маршрут
		|ПОМЕСТИТЬ МаршрутыОтОтправителя	
		|ИЗ
		|	Справочник.ВариантыМаршрутов.СкладыОтгрузки
		|ГДЕ
		|	Склад = &СкладОтправитель
        |
		|ОБЪЕДИНИТЬ
        |
		|ВЫБРАТЬ
		|	Ссылка КАК Маршрут
		|ИЗ
		|	Справочник.ВариантыМаршрутов.ВозвратнаяДоставка
		|ГДЕ
		|	СкладПолучатель  = &СкладПолучатель
		|И	СкладОтправитель = &СкладОтправитель	
		|;
		////////////////////////////////////////////////////////////////////////////////
		//
		|ВЫБРАТЬ
		|	Ссылка КАК Маршрут
		|ПОМЕСТИТЬ МаршрутыКПолучателю
		|ИЗ
		|	Справочник.ВариантыМаршрутов.СписокАдресов
		|ГДЕ
		|	ГородСклад = &СкладПолучатель
        |
		|ОБЪЕДИНИТЬ
        |
		|ВЫБРАТЬ
		|	Ссылка КАК Маршрут
		|ИЗ
		|	Справочник.ВариантыМаршрутов.ВозвратнаяДоставка
		|ГДЕ
		|	СкладПолучатель  = &СкладПолучатель
		|И	СкладОтправитель = &СкладОтправитель
		|;
		////////////////////////////////////////////////////////////////////////////////
		//
		|ВЫБРАТЬ
		|	&СкладОтправитель								КАК СкладОтправитель,
		|	&СкладПолучатель								КАК СкладПолучатель,
		|	МаршрутыКПолучателю.Маршрут 					КАК Маршрут,
		|	МаршрутыКПолучателю.Маршрут.КалендарьМаршрута 	КАК КалендарьМаршрута,
		|	
		|	IsNull(СкладыОтгрузки.ПН, СкладыОтгрузкиРезерв.ПН) КАК ПН,
		|	IsNull(СкладыОтгрузки.ВТ, СкладыОтгрузкиРезерв.ВТ) КАК ВТ,
		|	IsNull(СкладыОтгрузки.СР, СкладыОтгрузкиРезерв.СР) КАК СР,
		|	IsNull(СкладыОтгрузки.ЧТ, СкладыОтгрузкиРезерв.ЧТ) КАК ЧТ,
		|	IsNull(СкладыОтгрузки.ПТ, СкладыОтгрузкиРезерв.ПТ) КАК ПТ,
		|	IsNull(СкладыОтгрузки.СБ, СкладыОтгрузкиРезерв.СБ) КАК СБ,
		|	IsNull(СкладыОтгрузки.ВС, СкладыОтгрузкиРезерв.ВС) КАК ВС,
		|	
		|	IsNull(СкладыОтгрузки.ВремяВыездаПН, СкладыОтгрузкиРезерв.ВремяВыездаПН) КАК ВремяВыездаПН,
		|	IsNull(СкладыОтгрузки.ВремяВыездаВТ, СкладыОтгрузкиРезерв.ВремяВыездаВТ) КАК ВремяВыездаВТ,
		|	IsNull(СкладыОтгрузки.ВремяВыездаСР, СкладыОтгрузкиРезерв.ВремяВыездаСР) КАК ВремяВыездаСР,
		|	IsNull(СкладыОтгрузки.ВремяВыездаЧТ, СкладыОтгрузкиРезерв.ВремяВыездаЧТ) КАК ВремяВыездаЧТ,
		|	IsNull(СкладыОтгрузки.ВремяВыездаПТ, СкладыОтгрузкиРезерв.ВремяВыездаПТ) КАК ВремяВыездаПТ,
		|	IsNull(СкладыОтгрузки.ВремяВыездаСБ, СкладыОтгрузкиРезерв.ВремяВыездаСБ) КАК ВремяВыездаСБ,
		|	IsNull(СкладыОтгрузки.ВремяВыездаВС, СкладыОтгрузкиРезерв.ВремяВыездаВС) КАК ВремяВыездаВС
		|	
		|ПОМЕСТИТЬ МаршрутПрямойДоставки
		|ИЗ
		|	МаршрутыКПолучателю КАК МаршрутыКПолучателю
		|	
		|ВНУТРЕННЕЕ СОЕДИНЕНИЕ МаршрутыОтОтправителя КАК МаршрутыОтОтправителя
		|ПО МаршрутыОтОтправителя.Маршрут = МаршрутыКПолучателю.Маршрут
        |
		|ЛЕВОЕ СОЕДИНЕНИЕ АдресаСкладов КАК АдресаСкладаПолучателя 
		|ПО	АдресаСкладаПолучателя.Склад = &СкладПолучатель 
        |
		|ЛЕВОЕ СОЕДИНЕНИЕ АдресаСкладов КАК АдресаСкладаОтправителя 
		|ПО	АдресаСкладаОтправителя.Склад = &СкладОтправитель
        |
		|ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ВариантыМаршрутов.СкладыОтгрузки КАК СкладыОтгрузки 
		|ПО	СкладыОтгрузки.Ссылка = МаршрутыКПолучателю.Маршрут	
		|И	СкладыОтгрузки.Склад  = &СкладОтправитель
		|
		|ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ВариантыМаршрутов.СкладыОтгрузки КАК СкладыОтгрузкиРезерв 
		|ПО	СкладыОтгрузкиРезерв.Ссылка = МаршрутыКПолучателю.Маршрут	
		|И	СкладыОтгрузкиРезерв.Склад  = &СкладПолучатель
        |
		|ГДЕ
		|	АдресаСкладаПолучателя.Представление <> АдресаСкладаОтправителя.Представление		 
		|;
		////////////////////////////////////////////////////////////////////////////////
		//
		|ВЫБРАТЬ
		|	МаршрутПрямойДоставки.СкладОтправитель,
		|	МаршрутПрямойДоставки.СкладПолучатель,
		|	МаршрутПрямойДоставки.Маршрут,
		|	//МаршрутПрямойДоставки.КалендарьМаршрута, 
		|	Минимум(ДОБАВИТЬКДАТЕ(
		|				ДОБАВИТЬКДАТЕ(
		|							КалендарныеГрафики.ДатаГрафика, ЧАС, ЧАС(	
		|																	ВЫБОР ДЕНЬНЕДЕЛИ(КалендарныеГрафики.ДатаГрафика)
		|																		КОГДА 1
		|																		ТОГДА МаршрутПрямойДоставки.ВремяВыездаПН
		|																		КОГДА 2
		|																		ТОГДА МаршрутПрямойДоставки.ВремяВыездаВТ
		|																		КОГДА 3
		|																		ТОГДА МаршрутПрямойДоставки.ВремяВыездаСР
		|																		КОГДА 4
		|																		ТОГДА МаршрутПрямойДоставки.ВремяВыездаЧТ
		|																		КОГДА 5
		|																		ТОГДА МаршрутПрямойДоставки.ВремяВыездаПТ
		|																		КОГДА 6
		|																		ТОГДА МаршрутПрямойДоставки.ВремяВыездаСБ
		|																		КОГДА 7
		|																		ТОГДА МаршрутПрямойДоставки.ВремяВыездаВС
		|																	КОНЕЦ
		|																	)
		|						), МИНУТА, МИНУТА(	ВЫБОР ДЕНЬНЕДЕЛИ(КалендарныеГрафики.ДатаГрафика)
		|												КОГДА 1
		|												ТОГДА МаршрутПрямойДоставки.ВремяВыездаПН
		|												КОГДА 2
		|												ТОГДА МаршрутПрямойДоставки.ВремяВыездаВТ
		|												КОГДА 3
		|												ТОГДА МаршрутПрямойДоставки.ВремяВыездаСР
		|												КОГДА 4
		|												ТОГДА МаршрутПрямойДоставки.ВремяВыездаЧТ
		|												КОГДА 5
		|												ТОГДА МаршрутПрямойДоставки.ВремяВыездаПТ
		|												КОГДА 6
		|												ТОГДА МаршрутПрямойДоставки.ВремяВыездаСБ
		|												КОГДА 7
		|												ТОГДА МаршрутПрямойДоставки.ВремяВыездаВС
		|											КОНЕЦ
		|											)
		|				)
		|			)	КАК ДатаВремяВыезда
		|ИЗ
		|	МаршрутПрямойДоставки КАК МаршрутПрямойДоставки
		|	
		|	
		|ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.КалендарныеГрафики КАК КалендарныеГрафики
		|ПО	КалендарныеГрафики.Календарь 	= МаршрутПрямойДоставки.КалендарьМаршрута
		|И	КалендарныеГрафики.ДатаГрафика >= НАЧАЛОПЕРИОДА(&ДатаСеанса, День)
		|И	КалендарныеГрафики.ДеньВключенВГрафик
		|И	(ВЫБОР	ДЕНЬНЕДЕЛИ(КалендарныеГрафики.ДатаГрафика)
		|		КОГДА 1
		|		ТОГДА 	ВЫБОР
		|					КОГДА МаршрутПрямойДоставки.ПН
		|					ТОГДА Истина
		|					ИНАЧЕ ЛОЖЬ
		|				КОНЕЦ
		|		КОГДА 2
		|		ТОГДА 	ВЫБОР
		|					КОГДА МаршрутПрямойДоставки.ВТ
		|					ТОГДА Истина
		|					ИНАЧЕ ЛОЖЬ
		|				КОНЕЦ
		|		КОГДА 3
		|		ТОГДА 	ВЫБОР
		|					КОГДА МаршрутПрямойДоставки.СР
		|					ТОГДА Истина
		|					ИНАЧЕ ЛОЖЬ
		|				КОНЕЦ
		|		КОГДА 4
		|		ТОГДА 	ВЫБОР
		|					КОГДА МаршрутПрямойДоставки.ЧТ
		|					ТОГДА Истина
		|					ИНАЧЕ ЛОЖЬ
		|				КОНЕЦ
		|		КОГДА 5
		|		ТОГДА 	ВЫБОР
		|					КОГДА МаршрутПрямойДоставки.ПТ
		|					ТОГДА Истина
		|					ИНАЧЕ ЛОЖЬ
		|				КОНЕЦ
		|		КОГДА 6
		|		ТОГДА 	ВЫБОР
		|					КОГДА МаршрутПрямойДоставки.СБ
		|					ТОГДА Истина
		|					ИНАЧЕ ЛОЖЬ
		|				КОНЕЦ
		|		КОГДА 7
		|		ТОГДА 	ВЫБОР
		|					КОГДА МаршрутПрямойДоставки.ВС
		|					ТОГДА Истина
		|					ИНАЧЕ ЛОЖЬ
		|				КОНЕЦ
		|	КОНЕЦ)
        |
		|ГДЕ
		|	&ДатаСеанса < КалендарныеГрафики.ДатаГрафика	
		|ИЛИ
		|	ЧАС(&ДатаСеанса) < ЧАС(	ВЫБОР ДЕНЬНЕДЕЛИ(КалендарныеГрафики.ДатаГрафика)
		|									КОГДА 1
		|									ТОГДА МаршрутПрямойДоставки.ВремяВыездаПН
		|									КОГДА 2
		|									ТОГДА МаршрутПрямойДоставки.ВремяВыездаВТ
		|									КОГДА 3
		|									ТОГДА МаршрутПрямойДоставки.ВремяВыездаСР
		|									КОГДА 4
		|									ТОГДА МаршрутПрямойДоставки.ВремяВыездаЧТ
		|									КОГДА 5
		|									ТОГДА МаршрутПрямойДоставки.ВремяВыездаПТ
		|									КОГДА 6
		|									ТОГДА МаршрутПрямойДоставки.ВремяВыездаСБ
		|									КОГДА 7
		|									ТОГДА МаршрутПрямойДоставки.ВремяВыездаВС
		|								КОНЕЦ
		|							 )
		|ИЛИ
		|	(ЧАС(&ДатаСеанса) = ЧАС(	ВЫБОР ДЕНЬНЕДЕЛИ(КалендарныеГрафики.ДатаГрафика)
		|									КОГДА 1
		|									ТОГДА МаршрутПрямойДоставки.ВремяВыездаПН
		|									КОГДА 2
		|									ТОГДА МаршрутПрямойДоставки.ВремяВыездаВТ
		|									КОГДА 3
		|									ТОГДА МаршрутПрямойДоставки.ВремяВыездаСР
		|									КОГДА 4
		|									ТОГДА МаршрутПрямойДоставки.ВремяВыездаЧТ
		|									КОГДА 5
		|									ТОГДА МаршрутПрямойДоставки.ВремяВыездаПТ
		|									КОГДА 6
		|									ТОГДА МаршрутПрямойДоставки.ВремяВыездаСБ
		|									КОГДА 7
		|									ТОГДА МаршрутПрямойДоставки.ВремяВыездаВС
		|								КОНЕЦ
		|							 )
		|	И МИНУТА(&ДатаСеанса) <= МИНУТА(ВЫБОР ДЕНЬНЕДЕЛИ(КалендарныеГрафики.ДатаГрафика)
		|										КОГДА 1
		|										ТОГДА МаршрутПрямойДоставки.ВремяВыездаПН
		|										КОГДА 2
		|										ТОГДА МаршрутПрямойДоставки.ВремяВыездаВТ
		|										КОГДА 3
		|										ТОГДА МаршрутПрямойДоставки.ВремяВыездаСР
		|										КОГДА 4
		|										ТОГДА МаршрутПрямойДоставки.ВремяВыездаЧТ
		|										КОГДА 5
		|										ТОГДА МаршрутПрямойДоставки.ВремяВыездаПТ
		|										КОГДА 6
		|										ТОГДА МаршрутПрямойДоставки.ВремяВыездаСБ
		|										КОГДА 7
		|										ТОГДА МаршрутПрямойДоставки.ВремяВыездаВС
		|									КОНЕЦ
		|								) 	
		|	)		
        |
		|СГРУППИРОВАТЬ ПО
		|	МаршрутПрямойДоставки.СкладОтправитель,
		|	МаршрутПрямойДоставки.СкладПолучатель,
		|	МаршрутПрямойДоставки.Маршрут
		|	//,МаршрутПрямойДоставки.КалендарьМаршрута
		|;
		////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ МаршрутыОтОтправителя;
		////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ МаршрутыКПолучателю;
		////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ МаршрутПрямойДоставки;
		////////////////////////////////////////////////////////////////////////////////
		//
		|ВЫБРАТЬ
		|	СкладыОтгрузки.Ссылка 										КАК МаршрутТранзит,
		|	ВЫРАЗИТЬ(СписокАдресов.ГородСклад КАК Справочник.Склады) 	КАК СкладТранзит
		|ПОМЕСТИТЬ МаршрутыОтОтправителяТранзит	
		|ИЗ
		|	Справочник.ВариантыМаршрутов.СкладыОтгрузки КАК СкладыОтгрузки
		|	
		|ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.ВариантыМаршрутов.СписокАдресов КАК СписокАдресов
		|ПО СписокАдресов.Ссылка = СкладыОтгрузки.Ссылка
		|И  ВЫРАЗИТЬ(СписокАдресов.ГородСклад КАК Справочник.Склады) <> &СкладПолучатель
		|И	ВЫРАЗИТЬ(СписокАдресов.ГородСклад КАК Справочник.Склады) <> &СкладОтправитель
		|	
		|ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.Модуль_ДоступныеСклады КАК ДоступныеСклады
		|ПО ДоступныеСклады.Склад = СкладыОтгрузки.Ссылка
		|И  ДоступныеСклады.Транзитный
        |
		|ГДЕ
		|	СкладыОтгрузки.Склад = &СкладОтправитель	
		|	
		|ОБЪЕДИНИТЬ
        |
		|ВЫБРАТЬ
		|	Ссылка 			КАК МаршрутТранзит,
		|	СкладПолучатель КАК СкладТранзит
		|ИЗ
		|	Справочник.ВариантыМаршрутов.ВозвратнаяДоставка
		|ГДЕ
		|	СкладОтправитель = &СкладОтправитель	
		|;
		////////////////////////////////////////////////////////////////////////////////
		//
		|ВЫБРАТЬ
		|	&СкладОтправитель										КАК СкладОтправитель,
		|	СкладыОтгрузки.Склад									КАК СкладТранзит,
		|	&СкладПолучатель										КАК СкладПолучатель,
		|	МаршрутОтОтправителя.МаршрутТранзит						КАК МаршрутОтОтправителя,
		|	МаршрутОтОтправителя.МаршрутТранзит.КалендарьМаршрута	КАК КалендарьМаршрутаОтОтправителя,
		|	СкладыОтгрузки.Ссылка 									КАК МаршрутКПолучателю,
		|	СкладыОтгрузки.Ссылка.КалендарьМаршрута 				КАК КалендарьМаршрутаКПолучателю,
		|	
		|	СкладыТранзита.ПН,
		|	СкладыТранзита.ВТ,
		|	СкладыТранзита.СР,
		|	СкладыТранзита.ЧТ,
		|	СкладыТранзита.ПТ,
		|	СкладыТранзита.СБ,
		|	СкладыТранзита.ВС,
		|	
		|	СкладыТранзита.ВремяВыездаПН,
		|	СкладыТранзита.ВремяВыездаВТ,
		|	СкладыТранзита.ВремяВыездаСР,
		|	СкладыТранзита.ВремяВыездаЧТ,
		|	СкладыТранзита.ВремяВыездаПТ,
		|	СкладыТранзита.ВремяВыездаСБ,
		|	СкладыТранзита.ВремяВыездаВС,
		|	
		|	СкладыОтгрузки.ПН 				КАК тПН,
		|	СкладыОтгрузки.ВТ 				КАК тВТ,
		|	СкладыОтгрузки.СР 				КАК тСР,
		|	СкладыОтгрузки.ЧТ 				КАК тЧТ,
		|	СкладыОтгрузки.ПТ 				КАК тПТ,
		|	СкладыОтгрузки.СБ 				КАК тСБ,
		|	СкладыОтгрузки.ВС 				КАК тВС,
		|	
		|	СкладыОтгрузки.ВремяВыездаПН 	КАК тВремяВыездаПН,
		|	СкладыОтгрузки.ВремяВыездаВТ 	КАК тВремяВыездаВТ,
		|	СкладыОтгрузки.ВремяВыездаСР 	КАК тВремяВыездаСР,
		|	СкладыОтгрузки.ВремяВыездаЧТ 	КАК тВремяВыездаЧТ,
		|	СкладыОтгрузки.ВремяВыездаПТ 	КАК тВремяВыездаПТ,
		|	СкладыОтгрузки.ВремяВыездаСБ 	КАК тВремяВыездаСБ,
		|	СкладыОтгрузки.ВремяВыездаВС 	КАК тВремяВыездаВС
		|	
		|ПОМЕСТИТЬ МаршрутыКПолучателюТранзит	
		|ИЗ
		|	Справочник.ВариантыМаршрутов.СкладыОтгрузки КАК СкладыОтгрузки
		|	
		|ВНУТРЕННЕЕ СОЕДИНЕНИЕ МаршрутыОтОтправителяТранзит КАК МаршрутОтОтправителя
		|ПО МаршрутОтОтправителя.СкладТранзит = СкладыОтгрузки.Склад
        |
		|ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.ВариантыМаршрутов.СписокАдресов КАК СписокАдресов
		|ПО СписокАдресов.Ссылка = СкладыОтгрузки.Ссылка
		|И	ВЫРАЗИТЬ(СписокАдресов.ГородСклад КАК Справочник.Склады) = &СкладПолучатель
        |
		|ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ВариантыМаршрутов.СкладыОтгрузки КАК СкладыТранзита 
		|ПО	СкладыТранзита.Ссылка = МаршрутОтОтправителя.МаршрутТранзит	
		|И	СкладыТранзита.Склад  = &СкладОтправитель
        |
		//|ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ВариантыМаршрутов.СкладыОтгрузки КАК СкладыТранзита 
		//|ПО	СкладыТранзита.Ссылка = МаршрутОтОтправителя.МаршрутТранзит	
		//|И	СкладыТранзита.Склад  = СкладыОтгрузки.Склад
        |
		|ЛЕВОЕ СОЕДИНЕНИЕ АдресаСкладов КАК АдресаСкладаПолучателя 
		|ПО	АдресаСкладаПолучателя.Склад = &СкладПолучатель
        |
		|ЛЕВОЕ СОЕДИНЕНИЕ АдресаСкладов КАК АдресаСкладаТранзита 
		|ПО	АдресаСкладаТранзита.Склад = СкладыОтгрузки.Склад 
        |
		|ЛЕВОЕ СОЕДИНЕНИЕ АдресаСкладов КАК АдресаСкладаОтправителя 
		|ПО	АдресаСкладаОтправителя.Склад = &СкладОтправитель 
        |
		|ГДЕ
		|	АдресаСкладаОтправителя.Представление <> АдресаСкладаПолучателя.Представление
		|И   АдресаСкладаОтправителя.Представление <> АдресаСкладаТранзита.Представление 	
		|;
		////////////////////////////////////////////////////////////////////////////////
		//
		|ВЫБРАТЬ
		|	МаршрутыКПолучателюТранзит.СкладОтправитель,
		|	МаршрутыКПолучателюТранзит.МаршрутОтОтправителя,
		|	МаршрутыКПолучателюТранзит.СкладТранзит, 
		|	Минимум(ДОБАВИТЬКДАТЕ(
		|				ДОБАВИТЬКДАТЕ(
		|							КалендарныеГрафикиОтправителя.ДатаГрафика, ЧАС, ЧАС(	
		|																	ВЫБОР ДЕНЬНЕДЕЛИ(КалендарныеГрафикиОтправителя.ДатаГрафика)
		|																		КОГДА 1
		|																		ТОГДА МаршрутыКПолучателюТранзит.ВремяВыездаПН
		|																		КОГДА 2
		|																		ТОГДА МаршрутыКПолучателюТранзит.ВремяВыездаВТ
		|																		КОГДА 3
		|																		ТОГДА МаршрутыКПолучателюТранзит.ВремяВыездаСР
		|																		КОГДА 4
		|																		ТОГДА МаршрутыКПолучателюТранзит.ВремяВыездаЧТ
		|																		КОГДА 5
		|																		ТОГДА МаршрутыКПолучателюТранзит.ВремяВыездаПТ
		|																		КОГДА 6
		|																		ТОГДА МаршрутыКПолучателюТранзит.ВремяВыездаСБ
		|																		КОГДА 7
		|																		ТОГДА МаршрутыКПолучателюТранзит.ВремяВыездаВС
		|																	КОНЕЦ
		|																	)
		|						), МИНУТА, МИНУТА(	ВЫБОР ДЕНЬНЕДЕЛИ(КалендарныеГрафикиОтправителя.ДатаГрафика)
		|												КОГДА 1
		|												ТОГДА МаршрутыКПолучателюТранзит.ВремяВыездаПН
		|												КОГДА 2
		|												ТОГДА МаршрутыКПолучателюТранзит.ВремяВыездаВТ
		|												КОГДА 3
		|												ТОГДА МаршрутыКПолучателюТранзит.ВремяВыездаСР
		|												КОГДА 4
		|												ТОГДА МаршрутыКПолучателюТранзит.ВремяВыездаЧТ
		|												КОГДА 5
		|												ТОГДА МаршрутыКПолучателюТранзит.ВремяВыездаПТ
		|												КОГДА 6
		|												ТОГДА МаршрутыКПолучателюТранзит.ВремяВыездаСБ
		|												КОГДА 7
		|												ТОГДА МаршрутыКПолучателюТранзит.ВремяВыездаВС
		|											КОНЕЦ
		|											)
		|				)
		|			)	КАК ДатаВремяВыездаОтОтправителя
		|ПОМЕСТИТЬ ТаблицаПрибытияНаТранзитныйСклад
		|ИЗ
		|	МаршрутыКПолучателюТранзит КАК МаршрутыКПолучателюТранзит
		|	
		|	
		|ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.КалендарныеГрафики КАК КалендарныеГрафикиОтправителя
		|ПО	КалендарныеГрафикиОтправителя.Календарь 	= МаршрутыКПолучателюТранзит.КалендарьМаршрутаОтОтправителя
		|И	КалендарныеГрафикиОтправителя.ДатаГрафика  >= НАЧАЛОПЕРИОДА(&ДатаСеанса, День)
		|И	КалендарныеГрафикиОтправителя.ДеньВключенВГрафик
		|И	(ВЫБОР	ДЕНЬНЕДЕЛИ(КалендарныеГрафикиОтправителя.ДатаГрафика)
		|		КОГДА 1
		|		ТОГДА 	ВЫБОР
		|					КОГДА МаршрутыКПолучателюТранзит.ПН
		|					ТОГДА Истина
		|					ИНАЧЕ ЛОЖЬ
		|				КОНЕЦ
		|		КОГДА 2
		|		ТОГДА 	ВЫБОР
		|					КОГДА МаршрутыКПолучателюТранзит.ВТ
		|					ТОГДА Истина
		|					ИНАЧЕ ЛОЖЬ
		|				КОНЕЦ
		|		КОГДА 3
		|		ТОГДА 	ВЫБОР
		|					КОГДА МаршрутыКПолучателюТранзит.СР
		|					ТОГДА Истина
		|					ИНАЧЕ ЛОЖЬ
		|				КОНЕЦ
		|		КОГДА 4
		|		ТОГДА 	ВЫБОР
		|					КОГДА МаршрутыКПолучателюТранзит.ЧТ
		|					ТОГДА Истина
		|					ИНАЧЕ ЛОЖЬ
		|				КОНЕЦ
		|		КОГДА 5
		|		ТОГДА 	ВЫБОР
		|					КОГДА МаршрутыКПолучателюТранзит.ПТ
		|					ТОГДА Истина
		|					ИНАЧЕ ЛОЖЬ
		|				КОНЕЦ
		|		КОГДА 6
		|		ТОГДА 	ВЫБОР
		|					КОГДА МаршрутыКПолучателюТранзит.СБ
		|					ТОГДА Истина
		|					ИНАЧЕ ЛОЖЬ
		|				КОНЕЦ
		|		КОГДА 7
		|		ТОГДА 	ВЫБОР
		|					КОГДА МаршрутыКПолучателюТранзит.ВС
		|					ТОГДА Истина
		|					ИНАЧЕ ЛОЖЬ
		|				КОНЕЦ
		|	КОНЕЦ)
        |
		|ГДЕ
		|	&ДатаСеанса < КалендарныеГрафикиОтправителя.ДатаГрафика	
		|ИЛИ
		|	ЧАС(&ДатаСеанса) < ЧАС(	ВЫБОР ДЕНЬНЕДЕЛИ(КалендарныеГрафикиОтправителя.ДатаГрафика)
		|									КОГДА 1
		|									ТОГДА МаршрутыКПолучателюТранзит.ВремяВыездаПН
		|									КОГДА 2
		|									ТОГДА МаршрутыКПолучателюТранзит.ВремяВыездаВТ
		|									КОГДА 3
		|									ТОГДА МаршрутыКПолучателюТранзит.ВремяВыездаСР
		|									КОГДА 4
		|									ТОГДА МаршрутыКПолучателюТранзит.ВремяВыездаЧТ
		|									КОГДА 5
		|									ТОГДА МаршрутыКПолучателюТранзит.ВремяВыездаПТ
		|									КОГДА 6
		|									ТОГДА МаршрутыКПолучателюТранзит.ВремяВыездаСБ
		|									КОГДА 7
		|									ТОГДА МаршрутыКПолучателюТранзит.ВремяВыездаВС
		|								КОНЕЦ
		|							 )
		|ИЛИ
		|	(ЧАС(&ДатаСеанса) = ЧАС(	ВЫБОР ДЕНЬНЕДЕЛИ(КалендарныеГрафикиОтправителя.ДатаГрафика)
		|									КОГДА 1
		|									ТОГДА МаршрутыКПолучателюТранзит.ВремяВыездаПН
		|									КОГДА 2
		|									ТОГДА МаршрутыКПолучателюТранзит.ВремяВыездаВТ
		|									КОГДА 3
		|									ТОГДА МаршрутыКПолучателюТранзит.ВремяВыездаСР
		|									КОГДА 4
		|									ТОГДА МаршрутыКПолучателюТранзит.ВремяВыездаЧТ
		|									КОГДА 5
		|									ТОГДА МаршрутыКПолучателюТранзит.ВремяВыездаПТ
		|									КОГДА 6
		|									ТОГДА МаршрутыКПолучателюТранзит.ВремяВыездаСБ
		|									КОГДА 7
		|									ТОГДА МаршрутыКПолучателюТранзит.ВремяВыездаВС
		|								КОНЕЦ
		|							 )
		|	И МИНУТА(&ДатаСеанса) <= МИНУТА(ВЫБОР ДЕНЬНЕДЕЛИ(КалендарныеГрафикиОтправителя.ДатаГрафика)
		|										КОГДА 1
		|										ТОГДА МаршрутыКПолучателюТранзит.ВремяВыездаПН
		|										КОГДА 2
		|										ТОГДА МаршрутыКПолучателюТранзит.ВремяВыездаВТ
		|										КОГДА 3
		|										ТОГДА МаршрутыКПолучателюТранзит.ВремяВыездаСР
		|										КОГДА 4
		|										ТОГДА МаршрутыКПолучателюТранзит.ВремяВыездаЧТ
		|										КОГДА 5
		|										ТОГДА МаршрутыКПолучателюТранзит.ВремяВыездаПТ
		|										КОГДА 6
		|										ТОГДА МаршрутыКПолучателюТранзит.ВремяВыездаСБ
		|										КОГДА 7
		|										ТОГДА МаршрутыКПолучателюТранзит.ВремяВыездаВС
		|									КОНЕЦ
		|								) 	
		|	)		
        |
		|СГРУППИРОВАТЬ ПО
		|	МаршрутыКПолучателюТранзит.СкладОтправитель,
		|	МаршрутыКПолучателюТранзит.МаршрутОтОтправителя,
		|	МаршрутыКПолучателюТранзит.СкладТранзит
		|;
		////////////////////////////////////////////////////////////////////////////////
		//
		|ВЫБРАТЬ
		|	МаршрутыКПолучателюТранзит.СкладОтправитель,
		|	МаршрутыКПолучателюТранзит.МаршрутОтОтправителя,
		|	ТаблицаПрибытияНаТранзитныйСклад.ДатаВремяВыездаОтОтправителя,
		|	
		|	МаршрутыКПолучателюТранзит.СкладТранзит,
		|	
		|	МаршрутыКПолучателюТранзит.СкладПолучатель,
		|	МаршрутыКПолучателюТранзит.МаршрутКПолучателю,
		|	Минимум(ДОБАВИТЬКДАТЕ(
		|				ДОБАВИТЬКДАТЕ(
		|							КалендарныеГрафикиПолучателя.ДатаГрафика, ЧАС, ЧАС(	
		|																	ВЫБОР ДЕНЬНЕДЕЛИ(КалендарныеГрафикиПолучателя.ДатаГрафика)
		|																		КОГДА 1
		|																		ТОГДА МаршрутыКПолучателюТранзит.тВремяВыездаПН
		|																		КОГДА 2
		|																		ТОГДА МаршрутыКПолучателюТранзит.тВремяВыездаВТ
		|																		КОГДА 3
		|																		ТОГДА МаршрутыКПолучателюТранзит.тВремяВыездаСР
		|																		КОГДА 4
		|																		ТОГДА МаршрутыКПолучателюТранзит.тВремяВыездаЧТ
		|																		КОГДА 5
		|																		ТОГДА МаршрутыКПолучателюТранзит.тВремяВыездаПТ
		|																		КОГДА 6
		|																		ТОГДА МаршрутыКПолучателюТранзит.тВремяВыездаСБ
		|																		КОГДА 7
		|																		ТОГДА МаршрутыКПолучателюТранзит.тВремяВыездаВС
		|																	КОНЕЦ
		|																	)
		|						), МИНУТА, МИНУТА(	ВЫБОР ДЕНЬНЕДЕЛИ(КалендарныеГрафикиПолучателя.ДатаГрафика)
		|												КОГДА 1
		|												ТОГДА МаршрутыКПолучателюТранзит.тВремяВыездаПН
		|												КОГДА 2
		|												ТОГДА МаршрутыКПолучателюТранзит.тВремяВыездаВТ
		|												КОГДА 3
		|												ТОГДА МаршрутыКПолучателюТранзит.тВремяВыездаСР
		|												КОГДА 4
		|												ТОГДА МаршрутыКПолучателюТранзит.тВремяВыездаЧТ
		|												КОГДА 5
		|												ТОГДА МаршрутыКПолучателюТранзит.тВремяВыездаПТ
		|												КОГДА 6
		|												ТОГДА МаршрутыКПолучателюТранзит.тВремяВыездаСБ
		|												КОГДА 7
		|												ТОГДА МаршрутыКПолучателюТранзит.тВремяВыездаВС
		|											КОНЕЦ
		|											)
		|				)
		|			)	КАК ДатаВремяВыездаКПолучателю
		|ПОМЕСТИТЬ ВариантыТранзитов		
		|ИЗ
		|	МаршрутыКПолучателюТранзит КАК МаршрутыКПолучателюТранзит
		|	
		|ВНУТРЕННЕЕ СОЕДИНЕНИЕ ТаблицаПрибытияНаТранзитныйСклад КАК ТаблицаПрибытияНаТранзитныйСклад
		|ПО	ТаблицаПрибытияНаТранзитныйСклад.МаршрутОтОтправителя 	= МаршрутыКПолучателюТранзит.МаршрутОтОтправителя
		|И	ТаблицаПрибытияНаТранзитныйСклад.СкладТранзит 			= МаршрутыКПолучателюТранзит.СкладТранзит
        |
		|ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.КалендарныеГрафики КАК КалендарныеГрафикиПолучателя
		|ПО	КалендарныеГрафикиПолучателя.Календарь 	= МаршрутыКПолучателюТранзит.КалендарьМаршрутаКПолучателю
		|И	КалендарныеГрафикиПолучателя.ДатаГрафика  >= НачалоПериода(ТаблицаПрибытияНаТранзитныйСклад.ДатаВремяВыездаОтОтправителя, День)
		|И	КалендарныеГрафикиПолучателя.ДеньВключенВГрафик
		|И	(ВЫБОР	ДЕНЬНЕДЕЛИ(КалендарныеГрафикиПолучателя.ДатаГрафика)
		|		КОГДА 1
		|		ТОГДА 	ВЫБОР
		|					КОГДА МаршрутыКПолучателюТранзит.тПН
		|					ТОГДА Истина
		|					ИНАЧЕ ЛОЖЬ
		|				КОНЕЦ
		|		КОГДА 2
		|		ТОГДА 	ВЫБОР
		|					КОГДА МаршрутыКПолучателюТранзит.тВТ
		|					ТОГДА Истина
		|					ИНАЧЕ ЛОЖЬ
		|				КОНЕЦ
		|		КОГДА 3
		|		ТОГДА 	ВЫБОР
		|					КОГДА МаршрутыКПолучателюТранзит.тСР
		|					ТОГДА Истина
		|					ИНАЧЕ ЛОЖЬ
		|				КОНЕЦ
		|		КОГДА 4
		|		ТОГДА 	ВЫБОР
		|					КОГДА МаршрутыКПолучателюТранзит.тЧТ
		|					ТОГДА Истина
		|					ИНАЧЕ ЛОЖЬ
		|				КОНЕЦ
		|		КОГДА 5
		|		ТОГДА 	ВЫБОР
		|					КОГДА МаршрутыКПолучателюТранзит.тПТ
		|					ТОГДА Истина
		|					ИНАЧЕ ЛОЖЬ
		|				КОНЕЦ
		|		КОГДА 6
		|		ТОГДА 	ВЫБОР
		|					КОГДА МаршрутыКПолучателюТранзит.тСБ
		|					ТОГДА Истина
		|					ИНАЧЕ ЛОЖЬ
		|				КОНЕЦ
		|		КОГДА 7
		|		ТОГДА 	ВЫБОР
		|					КОГДА МаршрутыКПолучателюТранзит.тВС
		|					ТОГДА Истина
		|					ИНАЧЕ ЛОЖЬ
		|				КОНЕЦ
		|	КОНЕЦ)
        |
		|ГДЕ
		|	ТаблицаПрибытияНаТранзитныйСклад.ДатаВремяВыездаОтОтправителя < КалендарныеГрафикиПолучателя.ДатаГрафика	
		|ИЛИ
		|	ЧАС(ТаблицаПрибытияНаТранзитныйСклад.ДатаВремяВыездаОтОтправителя) < ЧАС(	ВЫБОР ДЕНЬНЕДЕЛИ(КалендарныеГрафикиПолучателя.ДатаГрафика)
		|																					КОГДА 1
		|																					ТОГДА МаршрутыКПолучателюТранзит.тВремяВыездаПН
		|																					КОГДА 2
		|																					ТОГДА МаршрутыКПолучателюТранзит.тВремяВыездаВТ
		|																					КОГДА 3
		|																					ТОГДА МаршрутыКПолучателюТранзит.тВремяВыездаСР
		|																					КОГДА 4
		|																					ТОГДА МаршрутыКПолучателюТранзит.тВремяВыездаЧТ
		|																					КОГДА 5
		|																					ТОГДА МаршрутыКПолучателюТранзит.тВремяВыездаПТ
		|																					КОГДА 6
		|																					ТОГДА МаршрутыКПолучателюТранзит.тВремяВыездаСБ
		|																					КОГДА 7
		|																					ТОГДА МаршрутыКПолучателюТранзит.тВремяВыездаВС
		|																				КОНЕЦ
		|																			 )
		|ИЛИ
		|	(ЧАС(ТаблицаПрибытияНаТранзитныйСклад.ДатаВремяВыездаОтОтправителя) = ЧАС(	ВЫБОР ДЕНЬНЕДЕЛИ(КалендарныеГрафикиПолучателя.ДатаГрафика)
		|																					КОГДА 1
		|																					ТОГДА МаршрутыКПолучателюТранзит.тВремяВыездаПН
		|																					КОГДА 2
		|																					ТОГДА МаршрутыКПолучателюТранзит.тВремяВыездаВТ
		|																					КОГДА 3
		|																					ТОГДА МаршрутыКПолучателюТранзит.тВремяВыездаСР
		|																					КОГДА 4
		|																					ТОГДА МаршрутыКПолучателюТранзит.тВремяВыездаЧТ
		|																					КОГДА 5
		|																					ТОГДА МаршрутыКПолучателюТранзит.тВремяВыездаПТ
		|																					КОГДА 6
		|																					ТОГДА МаршрутыКПолучателюТранзит.тВремяВыездаСБ
		|																					КОГДА 7
		|																					ТОГДА МаршрутыКПолучателюТранзит.тВремяВыездаВС
		|																				КОНЕЦ
		|																			 )
		|	И МИНУТА(ТаблицаПрибытияНаТранзитныйСклад.ДатаВремяВыездаОтОтправителя) < МИНУТА(	ВЫБОР ДЕНЬНЕДЕЛИ(КалендарныеГрафикиПолучателя.ДатаГрафика)
		|																							КОГДА 1
		|																							ТОГДА МаршрутыКПолучателюТранзит.тВремяВыездаПН
		|																							КОГДА 2
		|																							ТОГДА МаршрутыКПолучателюТранзит.тВремяВыездаВТ
		|																							КОГДА 3
		|																							ТОГДА МаршрутыКПолучателюТранзит.тВремяВыездаСР
		|																							КОГДА 4
		|																							ТОГДА МаршрутыКПолучателюТранзит.тВремяВыездаЧТ
		|																							КОГДА 5
		|																							ТОГДА МаршрутыКПолучателюТранзит.тВремяВыездаПТ
		|																							КОГДА 6
		|																							ТОГДА МаршрутыКПолучателюТранзит.тВремяВыездаСБ
		|																							КОГДА 7
		|																							ТОГДА МаршрутыКПолучателюТранзит.тВремяВыездаВС
		|																						КОНЕЦ
		|																					) 	
		|	)		
        |
		|СГРУППИРОВАТЬ ПО
		|	МаршрутыКПолучателюТранзит.СкладОтправитель,
		|	МаршрутыКПолучателюТранзит.МаршрутОтОтправителя,
		|	ТаблицаПрибытияНаТранзитныйСклад.ДатаВремяВыездаОтОтправителя,
		|	
		|	МаршрутыКПолучателюТранзит.СкладТранзит,
		|	
		|	МаршрутыКПолучателюТранзит.СкладПолучатель,
		|	МаршрутыКПолучателюТранзит.МаршрутКПолучателю
		|;
		////////////////////////////////////////////////////////////////////////////////
		//
		|ВЫБРАТЬ
		|	МИНИМУМ(ДатаВремяВыездаКПолучателю) КАК ДатаВремяВыездаКПолучателю
		|ПОМЕСТИТЬ КраткаяДоставкаТранзита
		|ИЗ
		|	ВариантыТранзитов
		|;
		////////////////////////////////////////////////////////////////////////////////
		//
		|ВЫБРАТЬ
		|	ВариантыТранзитов.СкладОтправитель,
		|	ВариантыТранзитов.МаршрутОтОтправителя,
		|	ВариантыТранзитов.ДатаВремяВыездаОтОтправителя,
		|	ВариантыТранзитов.СкладТранзит,
		|	ВариантыТранзитов.СкладПолучатель,
		|	ВариантыТранзитов.МаршрутКПолучателю,
		|	ВариантыТранзитов.ДатаВремяВыездаКПолучателю		
		|ИЗ
		|	ВариантыТранзитов КАК ВариантыТранзитов
		|	
		|ВНУТРЕННЕЕ СОЕДИНЕНИЕ КраткаяДоставкаТранзита КАК КраткаяДоставкаТранзита
		|ПО КраткаяДоставкаТранзита.ДатаВремяВыездаКПолучателю = ВариантыТранзитов.ДатаВремяВыездаКПолучателю
		|; 
		////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ ВариантыТранзитов;
		////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ КраткаяДоставкаТранзита; 		
		////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ АдресаСкладов;
		////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ МаршрутыОтОтправителяТранзит;
		////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ МаршрутыКПолучателюТранзит;
		////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ ТаблицаПрибытияНаТранзитныйСклад;
		////////////////////////////////////////////////////////////////////////////////	
		|";
	Возврат ТекстЗапроса;

КонецФункции // ПолучитьТекстЗапросаТранзитногоСклада()










