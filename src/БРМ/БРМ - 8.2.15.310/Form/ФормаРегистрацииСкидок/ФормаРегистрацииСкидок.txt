
&НаКлиенте
Процедура Сформировать(Команда)
	Если (НЕ ТипСкидки.Пустая()) И РазмерСкидки > 0 И Количество > 0 Тогда
		СформироватьНаСервере();
	КонецЕсли;
КонецПроцедуры

&НаСервере
Процедура СформироватьНаСервере()	
	Перем Код;
	ТЗ_Скидки.Очистить();
	
	Запрос = Новый Запрос("Выбрать Код Из РегистрСведений.СкидочныеКарты ГДЕ Код = &Код");
	Для Инд = 1 По Количество Цикл
		
		СоздатьКодНаСервере(Код, Запрос);
		Пока НЕ Запрос.Выполнить().Пустой() Цикл СоздатьКодНаСервере(Код, Запрос); КонецЦикла;
		Запись = ТЗ_Скидки.Добавить();
		Запись.Код 		= Код;
		
		Если 		ТипСкидки = Перечисления.ТипыСкидочныхКарт.КартаПовышенияОборотаКлиента Тогда
			Запись.Скидка 	= РазмерСкидки * 1000;
		ИначеЕсли   ТипСкидки = Перечисления.ТипыСкидочныхКарт.КарткаРазовайСкидки Тогда
			Запись.Скидка 	= РазмерСкидки;
		ИначеЕсли   ТипСкидки = Перечисления.ТипыСкидочныхКарт.КартаБонус Тогда
			Запись.Скидка 	= РазмерСкидки * 10;
		КонецЕсли;
		
	КонецЦикла;
КонецПроцедуры

&НаСервере
Процедура СоздатьКодНаСервере(Код, Запрос)
	
	Если 		ТипСкидки = Перечисления.ТипыСкидочныхКарт.КартаПовышенияОборотаКлиента Тогда
		Символ 	= "0";
	ИначеЕсли   ТипСкидки = Перечисления.ТипыСкидочныхКарт.КарткаРазовайСкидки Тогда
		Символ 	= "d";
	ИначеЕсли   ТипСкидки = Перечисления.ТипыСкидочныхКарт.КартаБонус Тогда
		Символ 	= "b";
	КонецЕсли;
		
	Код = Символ + Лев(СтрЗаменить(Новый УникальныйИдентификатор, "_", ""), 6);
	Запрос.УстановитьПараметр("Код", Код);
КонецПроцедуры


&НаКлиенте
Процедура Записать(Команда)
	ЗаписатьНаСервере();	
КонецПроцедуры

&НаСервере
Процедура ЗаписатьНаСервере()
	
	УстановитьПривилегированныйРежим(Истина);
	
	Для Каждого Элемент Из ТЗ_Скидки Цикл
		НаборЗаписей = РегистрыСведений.СкидочныеКарты.СоздатьНаборЗаписей();
		НаборЗаписей.Отбор.Код.Установить(Элемент.Код);
		
		Запись = НаборЗаписей.Добавить();
		Запись.Код 				= Элемент.Код;
		Запись.Создана 			= ПараметрыСеанса.ТекущийПользователь;
		Запись.ТипСкидочнойКарты= ТипСкидки;
		
		Если 		ТипСкидки = Перечисления.ТипыСкидочныхКарт.КартаПовышенияОборотаКлиента Тогда
			Запись.Скидка 	= Элемент.Скидка / 1000;
		ИначеЕсли   ТипСкидки = Перечисления.ТипыСкидочныхКарт.КарткаРазовайСкидки Тогда
			Запись.Скидка 	= Элемент.Скидка;
		ИначеЕсли   ТипСкидки = Перечисления.ТипыСкидочныхКарт.КартаБонус Тогда
			Запись.Скидка 	= Элемент.Скидка / 10;
		КонецЕсли;
			
		НаборЗаписей.Записать();
		
	КонецЦикла;
	
	УстановитьПривилегированныйРежим(Ложь);
	
КонецПроцедуры

&НаКлиенте
Процедура ТипСкидкиПриИзменении(Элемент)
	ТЗ_Скидки.Очистить();
	Элементы.ТЗ_СкидкиСкидка.Заголовок = ТипСкидки; 
КонецПроцедуры
