#Область ИнтерфейсАвтоматическихТестов
&НаКлиенте
Перем ЮнитТест;

&НаКлиенте
Функция ПолучитьСписокТестов(ЮнитТестирование) Экспорт
	
	ЮнитТест 		= ЮнитТестирование;
	СпиcокТестов 	= Новый Массив;
	СпиcокТестов.Добавить("Тест_ПроверитьВалидностьЗапроса");
	СпиcокТестов.Добавить("Тест_ПроверитьФормированияОтчета");

	Возврат СпиcокТестов;
	
КонецФункции

&НаКлиенте
Процедура Тест_ПроверитьВалидностьЗапроса() Экспорт   	
	
	ТекстЗапроса = СформироватьТексЗапроса();
	ЮнитТест.ПроверитьТип(ТекстЗапроса, Тип("Строка"));
	Тест_ПроверитьТекстЗапросНаОшибки(ТекстЗапроса);
КонецПроцедуры

&НаСервере
Процедура Тест_ПроверитьТекстЗапросНаОшибки(ТекстЗапроса) Экспорт
	
	СхемаКомпоновкиДанных = Новый СхемаКомпоновкиДанных;
	
	ИсточникДанных 					  = СхемаКомпоновкиДанных.ИсточникиДанных.Добавить(); 
	ИсточникДанных.Имя                = "ИсточникДанных";
	ИсточникДанных.СтрокаСоединения   = "";
	ИсточникДанных.ТипИсточникаДанных = "Local";
	
	НаборДанных 							 = СхемаКомпоновкиДанных.НаборыДанных.Добавить(Тип("НаборДанныхЗапросСхемыКомпоновкиДанных"));
	НаборДанных.Имя            				 = "НаборДанных";
	НаборДанных.ИсточникДанных 				 = "ИсточникДанных";
	НаборДанных.АвтоЗаполнениеДоступныхПолей = Истина;
	НаборДанных.Запрос 						 = ТекстЗапроса;
	
	КомпоновщикНастроек = Новый КомпоновщикНастроекКомпоновкиДанных;
	КомпоновщикНастроек.Инициализировать(Новый ИсточникДоступныхНастроекКомпоновкиДанных(СхемаКомпоновкиДанных));
 

КонецПроцедуры // Тест_ПроверитьТекстЗапросНаОшибки(ТекстЗапроса)

&НаКлиенте
Процедура Тест_ПроверитьФормированияОтчета() Экспорт   	
	СформироватьОтчетНаСервере();
КонецПроцедуры

#КонецОбласти

#Область ОбработчикиСобытийФормы
&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	Если Параметры.Свойство("АвтоТест") Тогда
		Возврат;	
	КонецЕсли;
	Номенклатура = Параметры.Номенклатура;
	СформироватьОтчетНаСервере();
КонецПроцедуры
#КонецОбласти

#Область  ОбработчикиКомандФормы
&НаКлиенте
Процедура СформироватьОтчет(Команда)
	СформироватьОтчетНаСервере();
КонецПроцедуры
#КонецОбласти


#Область  СлужебныеПроцедурыИФункции

&НаСервере
Процедура СформироватьОтчетНаСервере()
	УстановитьПривилегированныйРежим(Истина);
	Результат.Очистить();
	Запрос 			= Новый Запрос;
	Запрос.Текст 	= СформироватьТексЗапроса();
	Если НЕ Номенклатура.Пустая() Тогда
		Запрос.УстановитьПараметр("Номенклатура", Номенклатура);
	КонецЕсли;
	
	СписокНоменклатуры = Запрос.Выполнить().Выгрузить();
	ВывестиРезультатыЗапроса(СписокНоменклатуры);
	
КонецПроцедуры

&НаСервере
Функция СформироватьТексЗапроса()
	ТекстЗапроса ="ВЫБРАТЬ
				|	ТоварыКПоступлениюОстатки.ДокументПоступления,
				|	ТоварыКПоступлениюОстатки.Номенклатура,
				|	ТоварыКПоступлениюОстатки.Номенклатура.Код,
				|	ТоварыКПоступлениюОстатки.Склад,
				|	ЗаказНаПеремещениеТовары.Назначение,
				|	ТоварыКПоступлениюОстатки.КПоступлениюОстаток,
				|	ТоварыКПоступлениюОстатки.ДокументПоступления.Ответственный
				|ПОМЕСТИТЬ КешЗаказНаПеремещение
				|ИЗ
				|	РегистрНакопления.ТоварыКПоступлению.Остатки(
				|			,
				|			ДокументПоступления ССЫЛКА Документ.ЗаказНаПеремещение
				|				" + ?(Номенклатура.Пустая(), "", " И Номенклатура = &Номенклатура") + ") КАК ТоварыКПоступлениюОстатки
				|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ЗаказНаПеремещение.Товары КАК ЗаказНаПеремещениеТовары
				|		ПО ТоварыКПоступлениюОстатки.ДокументПоступления = ЗаказНаПеремещениеТовары.Ссылка
				|			И ТоварыКПоступлениюОстатки.Характеристика = ЗаказНаПеремещениеТовары.Характеристика
				|			И ТоварыКПоступлениюОстатки.Номенклатура = ЗаказНаПеремещениеТовары.Номенклатура
				|;

				|////////////////////////////////////////////////////////////////////////////////
				|ВЫБРАТЬ
				|	ТоварыКПоступлениюОстатки.ДокументПоступления,
				|	ТоварыКПоступлениюОстатки.Номенклатура,
				|	ТоварыКПоступлениюОстатки.Номенклатура.Код,
				|	ТоварыКПоступлениюОстатки.Склад,
				|	ЗаказПоставщикуТовары.Назначение,
				|	ЗаказПоставщикуТовары.КоличествоУпаковок,
				|	ТоварыКПоступлениюОстатки.ДокументПоступления.Ответственный
				|ПОМЕСТИТЬ КешЗаказПоставщику
				|ИЗ
				|	РегистрНакопления.ТоварыКПоступлению.Остатки(
				|			,
				|			ДокументПоступления ССЫЛКА Документ.ЗаказПоставщику
				|				" + ?(Номенклатура.Пустая(), "", " И Номенклатура = &Номенклатура") + ") КАК ТоварыКПоступлениюОстатки
				|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ЗаказПоставщику.Товары КАК ЗаказПоставщикуТовары
				|		ПО ТоварыКПоступлениюОстатки.ДокументПоступления = ЗаказПоставщикуТовары.Ссылка
				|			И ТоварыКПоступлениюОстатки.Номенклатура = ЗаказПоставщикуТовары.Номенклатура
				|			И ТоварыКПоступлениюОстатки.Характеристика = ЗаказПоставщикуТовары.Характеристика
				|;

				|////////////////////////////////////////////////////////////////////////////////
				|ВЫБРАТЬ
				|	ТоварыКПоступлениюОстатки.ДокументПоступления,
				|	ТоварыКПоступлениюОстатки.Номенклатура,
				|	ТоварыКПоступлениюОстатки.Номенклатура.Код,
				|	ТоварыКПоступлениюОстатки.Склад,
				|	ПеремещениеТоваровТовары.Назначение,
				|	ПеремещениеТоваровТовары.КоличествоУпаковок,
				|	ТоварыКПоступлениюОстатки.ДокументПоступления.Ответственный
				|ПОМЕСТИТЬ КешПеремещение
				|ИЗ
				|	РегистрНакопления.ТоварыКПоступлению.Остатки(
				|			,
				|			ДокументПоступления ССЫЛКА Документ.ПеремещениеТоваров
				|           " + ?(Номенклатура.Пустая(), "", " И Номенклатура = &Номенклатура") + "
				|			) КАК ТоварыКПоступлениюОстатки
				|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ПеремещениеТоваров.Товары КАК ПеремещениеТоваровТовары
				|		ПО ТоварыКПоступлениюОстатки.ДокументПоступления = ПеремещениеТоваровТовары.Ссылка
				|			И ТоварыКПоступлениюОстатки.Номенклатура = ПеремещениеТоваровТовары.Номенклатура
				|			И ТоварыКПоступлениюОстатки.Характеристика = ПеремещениеТоваровТовары.Характеристика
				|;

				|////////////////////////////////////////////////////////////////////////////////
				|ВЫБРАТЬ
				|	ТоварыКПоступлениюОстатки.ДокументПоступления,
				|	ТоварыКПоступлениюОстатки.Номенклатура,
				|	ТоварыКПоступлениюОстатки.Номенклатура.Код,
				|	ТоварыКПоступлениюОстатки.Склад,
				|	ПоступлениеТоваровУслугТовары.Назначение,
				|	ПоступлениеТоваровУслугТовары.КоличествоУпаковок,
				|	ТоварыКПоступлениюОстатки.ДокументПоступления.Ответственный
				|ПОМЕСТИТЬ КешПоступлениеТоваровУслуг
				|ИЗ
				|	РегистрНакопления.ТоварыКПоступлению.Остатки(
				|			,
				|			ДокументПоступления ССЫЛКА Документ.ПоступлениеТоваровУслуг 
				|			" + ?(Номенклатура.Пустая(), "", " И Номенклатура = &Номенклатура") + "
				|			) КАК ТоварыКПоступлениюОстатки
				|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ПоступлениеТоваровУслуг.Товары КАК ПоступлениеТоваровУслугТовары
				|		ПО ТоварыКПоступлениюОстатки.ДокументПоступления = ПоступлениеТоваровУслугТовары.Ссылка
				|			И ТоварыКПоступлениюОстатки.Номенклатура = ПоступлениеТоваровУслугТовары.Номенклатура
				|			И ТоварыКПоступлениюОстатки.Характеристика = ПоступлениеТоваровУслугТовары.Характеристика
				|;

				|////////////////////////////////////////////////////////////////////////////////
				|ВЫБРАТЬ
				|	ТоварыКПоступлениюОстатки.ДокументПоступления КАК ДокументПоступления,
				|	ТоварыКПоступлениюОстатки.Номенклатура КАК Номенклатура,
				|	ТоварыКПоступлениюОстатки.Номенклатура.Код КАК Код,
				|	ТоварыКПоступлениюОстатки.Склад КАК Склад,
				|	ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка) КАК Назначение,
				|	ТоварыКПоступлениюОстатки.КПоступлениюОстаток КАК КПоступлению,
				|	ВЫБОР
				|		КОГДА ТоварыКПоступлениюОстатки.ДокументПоступления ССЫЛКА Документ.ВозвратТоваровОтКлиента
				|				ИЛИ ТоварыКПоступлениюОстатки.ДокументПоступления ССЫЛКА Документ.ЗаказПоставщику
				|				ИЛИ ТоварыКПоступлениюОстатки.ДокументПоступления ССЫЛКА Документ.ЗаявкаНаВозвратТоваровОтКлиента
				|				ИЛИ ТоварыКПоступлениюОстатки.ДокументПоступления ССЫЛКА Документ.ПоступлениеТоваровУслуг
				|			ТОГДА ТоварыКПоступлениюОстатки.ДокументПоступления.Менеджер
				|		ИНАЧЕ ТоварыКПоступлениюОстатки.ДокументПоступления.Ответственный
				|	КОНЕЦ КАК Менеджер
				|ИЗ
				|	РегистрНакопления.ТоварыКПоступлению.Остатки(
				|			,
				|			(ДокументПоступления ССЫЛКА Документ.ВозвратТоваровОтКлиента
				|				ИЛИ ДокументПоступления ССЫЛКА Документ.ЗаявкаНаВозвратТоваровОтКлиента
				|				ИЛИ ДокументПоступления ССЫЛКА Справочник.СоглашенияСПоставщиками
				|				ИЛИ ДокументПоступления ССЫЛКА Документ.ПрочееОприходованиеТоваров)
				|				" + ?(Номенклатура.Пустая(), "", " И Номенклатура = &Номенклатура") + ") КАК ТоварыКПоступлениюОстатки

				|ОБЪЕДИНИТЬ ВСЕ

				|ВЫБРАТЬ
				|	ТоварыКПоступлениюОстатки.ДокументПоступления,
				|	ТоварыКПоступлениюОстатки.Номенклатура,
				|	ТоварыКПоступлениюОстатки.Номенклатура.Код,
				|	ТоварыКПоступлениюОстатки.Склад,
				|	ЕСТЬNULL(КТС_ТоварыКПоступлениюПодОбеспечениеОстатки.Назначение, Значение(Справочник.Назначения.ПустаяСсылка)),
				|	ВЫБОР
				|		КОГДА ЕСТЬNULL(КТС_ТоварыКПоступлениюПодОбеспечениеОстатки.КПоступлениюОстаток, 0) > 0
				|			ТОГДА ЕСТЬNULL(КТС_ТоварыКПоступлениюПодОбеспечениеОстатки.КПоступлениюОстаток, 0)
				|		ИНАЧЕ ТоварыКПоступлениюОстатки.КПоступлениюОстаток
				|	КОНЕЦ,
				|	ВЫБОР
				|		КОГДА ТоварыКПоступлениюОстатки.ДокументПоступления ССЫЛКА Документ.ВозвратТоваровОтКлиента
				|				ИЛИ ТоварыКПоступлениюОстатки.ДокументПоступления ССЫЛКА Документ.ЗаказПоставщику
				|				ИЛИ ТоварыКПоступлениюОстатки.ДокументПоступления ССЫЛКА Документ.ЗаявкаНаВозвратТоваровОтКлиента
				|				ИЛИ ТоварыКПоступлениюОстатки.ДокументПоступления ССЫЛКА Документ.ПоступлениеТоваровУслуг
				|			ТОГДА ТоварыКПоступлениюОстатки.ДокументПоступления.Менеджер
				|		ИНАЧЕ ТоварыКПоступлениюОстатки.ДокументПоступления.Ответственный
				|	КОНЕЦ
				|ИЗ
				|	РегистрНакопления.ТоварыКПоступлению.Остатки(
				|			,
				|			(ДокументПоступления ССЫЛКА Документ.ЗаказНаСборку
				|				ИЛИ ДокументПоступления ССЫЛКА Документ.СборкаТоваров)
				|				" + ?(Номенклатура.Пустая(), "", " И Номенклатура = &Номенклатура") + ") КАК ТоварыКПоступлениюОстатки
				|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.КТС_ТоварыКПоступлениюПодОбеспечение.Остатки" + ?(Номенклатура.Пустая(), "", "(, Номенклатура = &Номенклатура)") + " КАК КТС_ТоварыКПоступлениюПодОбеспечениеОстатки
				|		ПО ТоварыКПоступлениюОстатки.Номенклатура = КТС_ТоварыКПоступлениюПодОбеспечениеОстатки.Номенклатура
				|			И ТоварыКПоступлениюОстатки.Характеристика = КТС_ТоварыКПоступлениюПодОбеспечениеОстатки.Характеристика
				|			И ТоварыКПоступлениюОстатки.Склад = КТС_ТоварыКПоступлениюПодОбеспечениеОстатки.Склад
				|			И ТоварыКПоступлениюОстатки.ДокументПоступления.Назначение = КТС_ТоварыКПоступлениюПодОбеспечениеОстатки.Назначение

				|ОБЪЕДИНИТЬ ВСЕ

				|ВЫБРАТЬ
				|	КешЗаказНаПеремещение.ДокументПоступления,
				|	КешЗаказНаПеремещение.Номенклатура,
				|	КешЗаказНаПеремещение.НоменклатураКод,
				|	КешЗаказНаПеремещение.Склад,
				|	КешЗаказНаПеремещение.Назначение,
				|	КешЗаказНаПеремещение.КПоступлениюОстаток,
				|	КешЗаказНаПеремещение.ДокументПоступленияОтветственный
				|ИЗ
				|	КешЗаказНаПеремещение КАК КешЗаказНаПеремещение
				|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.КТС_ТоварыКПоступлениюПодОбеспечение.Остатки" + ?(Номенклатура.Пустая(), "", "(, Номенклатура = &Номенклатура)") + " КАК КТС_ТоварыКПоступлениюПодОбеспечениеОстатки
				|		ПО КешЗаказНаПеремещение.Номенклатура = КТС_ТоварыКПоступлениюПодОбеспечениеОстатки.Номенклатура
				|			И КешЗаказНаПеремещение.Склад = КТС_ТоварыКПоступлениюПодОбеспечениеОстатки.Склад
				|			И КешЗаказНаПеремещение.Назначение = КТС_ТоварыКПоступлениюПодОбеспечениеОстатки.Назначение

				|ОБЪЕДИНИТЬ ВСЕ

				|ВЫБРАТЬ
				|	КешЗаказПоставщику.ДокументПоступления,
				|	КешЗаказПоставщику.Номенклатура,
				|	КешЗаказПоставщику.НоменклатураКод,
				|	КешЗаказПоставщику.Склад,
				|	КешЗаказПоставщику.Назначение,
				|	КешЗаказПоставщику.КоличествоУпаковок,
				|	КешЗаказПоставщику.ДокументПоступленияОтветственный
				|ИЗ
				|	КешЗаказПоставщику КАК КешЗаказПоставщику
				|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.КТС_ТоварыКПоступлениюПодОбеспечение.Остатки" + ?(Номенклатура.Пустая(), "", "(, Номенклатура = &Номенклатура)") + " КАК КТС_ТоварыКПоступлениюПодОбеспечениеОстатки
				|		ПО КешЗаказПоставщику.Номенклатура = КТС_ТоварыКПоступлениюПодОбеспечениеОстатки.Номенклатура
				|			И КешЗаказПоставщику.Склад = КТС_ТоварыКПоступлениюПодОбеспечениеОстатки.Склад
				|			И КешЗаказПоставщику.Назначение = КТС_ТоварыКПоступлениюПодОбеспечениеОстатки.Назначение

				|ОБЪЕДИНИТЬ ВСЕ

				|ВЫБРАТЬ
				|	КешПеремещение.ДокументПоступления,
				|	КешПеремещение.Номенклатура,
				|	КешПеремещение.НоменклатураКод,
				|	КешПеремещение.Склад,
				|	КешПеремещение.Назначение,
				|	КешПеремещение.КоличествоУпаковок,
				|	КешПеремещение.ДокументПоступленияОтветственный
				|ИЗ
				|	КешПеремещение КАК КешПеремещение
				|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.КТС_ТоварыКПоступлениюПодОбеспечение.Остатки" + ?(Номенклатура.Пустая(), "", "(, Номенклатура = &Номенклатура)") + " КАК КТС_ТоварыКПоступлениюПодОбеспечениеОстатки
				|		ПО КешПеремещение.Номенклатура = КТС_ТоварыКПоступлениюПодОбеспечениеОстатки.Номенклатура
				|			И КешПеремещение.Склад = КТС_ТоварыКПоступлениюПодОбеспечениеОстатки.Склад
				|			И КешПеремещение.Назначение = КТС_ТоварыКПоступлениюПодОбеспечениеОстатки.Назначение

				|ОБЪЕДИНИТЬ ВСЕ

				|ВЫБРАТЬ
				|	КешПоступлениеТоваровУслуг.ДокументПоступления,
				|	КешПоступлениеТоваровУслуг.Номенклатура,
				|	КешПоступлениеТоваровУслуг.НоменклатураКод,
				|	КешПоступлениеТоваровУслуг.Склад,
				|	КешПоступлениеТоваровУслуг.Назначение,
				|	КешПоступлениеТоваровУслуг.КоличествоУпаковок,
				|	КешПоступлениеТоваровУслуг.ДокументПоступленияОтветственный
				|ИЗ
				|	КешПоступлениеТоваровУслуг КАК КешПоступлениеТоваровУслуг
				|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.КТС_ТоварыКПоступлениюПодОбеспечение.Остатки" + ?(Номенклатура.Пустая(), "", "(, Номенклатура = &Номенклатура)") + " КАК КТС_ТоварыКПоступлениюПодОбеспечениеОстатки
				|		ПО КешПоступлениеТоваровУслуг.Номенклатура = КТС_ТоварыКПоступлениюПодОбеспечениеОстатки.Номенклатура
				|			И КешПоступлениеТоваровУслуг.Склад = КТС_ТоварыКПоступлениюПодОбеспечениеОстатки.Склад
				|			И КешПоступлениеТоваровУслуг.Назначение = КТС_ТоварыКПоступлениюПодОбеспечениеОстатки.Назначение";
		
   Возврат ТекстЗапроса;
	
КонецФункции

&НаСервере
Процедура ВывестиРезультатыЗапроса(СписокНоменклатуры)
	
	ВнешниеНаборыДанных = Новый Структура;
	ВнешниеНаборыДанных.Вставить("СписокНоменклатуры", СписокНоменклатуры);
	
	ОбъектОбработки 		= РеквизитФормыВЗначение("Объект");
	СхемаКомпоновкиДанных   = ОбъектОбработки.ПолучитьМакет("СКД_ОжидаемыеТовары");
	ЗначениеВРеквизитФормы(ОбъектОбработки, "Объект");
	
	Настройки 					= СхемаКомпоновкиДанных.НастройкиПоУмолчанию;
	
	КомпоновщикМакета 			= Новый КомпоновщикМакетаКомпоновкиДанных;
	ДанныеРасшифровки			= Новый ДанныеРасшифровкиКомпоновкиДанных;
	МакетКомпоновки				= КомпоновщикМакета.Выполнить(СхемаКомпоновкиДанных, Настройки, ДанныеРасшифровки);
	
	ПроцессорКомпоновкиДанны    = Новый ПроцессорКомпоновкиДанных;
	ПроцессорКомпоновкиДанны.Инициализировать(МакетКомпоновки, ВнешниеНаборыДанных, ДанныеРасшифровки);
	
	ПроцессорВывода				= Новый ПроцессорВыводаРезультатаКомпоновкиДанныхВТабличныйДокумент;
	ПроцессорВывода.УстановитьДокумент(Результат);
	ПроцессорВывода.Вывести(ПроцессорКомпоновкиДанны);
	
КонецПроцедуры

#КонецОбласти
