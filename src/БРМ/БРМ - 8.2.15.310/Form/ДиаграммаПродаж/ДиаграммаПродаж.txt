#Область ИнтерфейсАвтоматическихТестов

&НаКлиенте
Перем ЮнитТест;

&НаКлиенте
Функция ПолучитьСписокТестов(ЮнитТестирование) Экспорт
	
	ЮнитТест = ЮнитТестирование;
	
	СписокТестов = Новый Массив;	
	
	ПараметрыТеста = Новый Структура("ИмяТеста, Транзакция, Параметр", "Тест_Заглушка");
	СписокТестов.Добавить(ПараметрыТеста);
	
	Возврат СписокТестов;
	
КонецФункции

&НаКлиенте
Функция Тест_Заглушка(Параметр) Экспорт
	ЮнитТест.ПроверитьИстину(Истина,);
КонецФункции // Тест_Заглушка()


#КонецОбласти

&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	
	Если Параметры.Свойство("АвтоТест") Тогда
		Возврат;	
	КонецЕсли;

	ВидЦены 		= Параметры.ВидЦены;
	КонецПериода 	= Параметры.КонецПериода;
    НачалоПериода 	= Параметры.НачалоПериода;
	Номенклатура 	= Параметры.Номенклатура;
	
	Запрос = Новый Запрос("
		|ВЫБРАТЬ
		|	Период,
		|	Цена,
		|	ВидЦены
		|	
		|ПОМЕСТИТЬ КешЦен
		|ИЗ
		|	РегистрСведений.ЦеныНоменклатуры КАК Цены
		|ГДЕ
		|	ВидЦены 	 = &ВидЦены
		|И	Номенклатура = &Номенклатура
		|;
		|ВЫБРАТЬ
		|	КешЦен.Период 	 		  КАК ПериодНачало,
		|	Минимум(КешЦенНар.Период) КАК ПериодКонец,
		|	КешЦен.Цена,
		|	КешЦен.ВидЦены
		|	
		|ПОМЕСТИТЬ ГрафикЦен		
		|ИЗ
		|	КешЦен КАК КешЦен
		|	
		|ЛЕВОЕ СОЕДИНЕНИЕ КешЦен КАК КешЦенНар
		|ПО	КешЦен.Период < КешЦенНар.Период 	
        |
		|СГРУППИРОВАТЬ ПО
		|	КешЦен.Период,
		|	КешЦен.Цена,
		|	КешЦен.ВидЦены	
		|;
        |
		|УНИЧТОЖИТЬ КешЦен;
        |
		|ВЫБРАТЬ
		|	ВИС.Период КАК Дата,
		|	ГрафикЦен.ВидЦены, 
		|	ГрафикЦен.Цена, 
		|	ВНаличииКонечныйОстаток КАК ВНаличии,
		|	ВИС.КоличествоОборот	КАК Продажи,
		|	СуммаВыручкиОборот - СебестоимостьОборот - СуммаДополнительныхРасходовОборот КАК ВаловаяПрибыль
        |
		|ИЗ
		|	РегистрНакопления.ВыручкаИСебестоимостьПродаж.Обороты(&НачПериодаТенденции, &КонПериодаАнализа, Неделя,
		|		  АналитикаУчетаПоПартнерам  В (ВЫБРАТЬ КлючАналитики ИЗ РегистрСведений.АналитикаУчетаПоПартнерам  ГДЕ Партнер <> Значение(Справочник.Партнеры.НашеПредприятие)) 
		|		И АналитикаУчетаНоменклатуры.Номенклатура = &Номенклатура) КАК ВИС	
		|	
		|	
		|ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.СвободныеОстатки.ОстаткиИОбороты(&НачПериодаТенденции, &КонПериодаАнализа, Неделя, , Номенклатура = &Номенклатура) КАК Товары
		|ПО  ВИС.Период = Товары.Период	
		|	
		|ЛЕВОЕ СОЕДИНЕНИЕ ГрафикЦен КАК ГрафикЦен
		|ПО ВИС.Период >= ГрафикЦен.ПериодНачало
		|И  (ВИС.Период <  ГрафикЦен.ПериодКонец ИЛИ ЕСТЬNULL(ГрафикЦен.ПериодКонец, 0) = 0)
        |
		|УПОРЯДОЧИТЬ ПО ВИС.Период Возр 
		|");
	Запрос.УстановитьПараметр("ВидЦены",      		ВидЦены);
	Запрос.УстановитьПараметр("Номенклатура", 		Номенклатура);
	Запрос.УстановитьПараметр("НачПериодаТенденции",НачалоПериода);
	Запрос.УстановитьПараметр("КонПериодаАнализа", 	КонецПериода);
	Выборка = Запрос.Выполнить().Выбрать();
	
	СерияВидЦены = Диаграмма.УстановитьСерию(Строка(ВидЦены) + ": ");
	СерияНаличие = Диаграмма.УстановитьСерию("В наличии: ");
	СерияПродано = Диаграмма.УстановитьСерию("Продано: ");
    СерияПрибыль = Диаграмма.УстановитьСерию("Прибыль: ");
	Пока Выборка.Следующий() Цикл	
		ТекущаяТочка = Диаграмма.УстановитьТочку(Формат(Выборка.Дата, "ДФ=dd.MM.yy"));
		Диаграмма.УстановитьЗначение(ТекущаяТочка, СерияВидЦены, Выборка.Цена);
		Диаграмма.УстановитьЗначение(ТекущаяТочка, СерияНаличие, Выборка.ВНаличии);
		Диаграмма.УстановитьЗначение(ТекущаяТочка, СерияПродано, Выборка.Продажи);
		Диаграмма.УстановитьЗначение(ТекущаяТочка, СерияПрибыль, Выборка.ВаловаяПрибыль);
	КонецЦикла;
	
	Диаграмма.ТипДиаграммы = ТипДиаграммы.График;
	Диаграмма.ВидПодписей = ВидПодписейКДиаграмме.СерияЗначение;
	
КонецПроцедуры

&НаКлиенте
Процедура ДиаграммаВыбор(Элемент, ЗначениеДиаграммы, СтандартнаяОбработка)
	// Вставить содержимое обработчика.
КонецПроцедуры

