

#Область ОбработчикиСобытийФормы

&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	УстановитьПривилегированныйРежим(Истина);
	Если Параметры.Свойство("СерийныеНомераНоменклатуры") = Истина Тогда
		СерийныеНомераНоменклатуры = Параметры.СерийныеНомераНоменклатуры;
		Комментарий = СерийныеНомераНоменклатуры.Комментарий;
	КонецЕсли;
КонецПроцедуры

#КонецОбласти

#Область ОбработчикиКомандФормы


&НаКлиенте
Процедура Записать(Команда)
	Если ЗаписатьНаСервере() Тогда
		Закрыть();	
	КонецЕсли;
КонецПроцедуры

#КонецОбласти


#Область СлужебныеПроцедурыИФункции
&НаСервере
Функция ЗаписатьНаСервере()
	
	УстановитьПривилегированныйРежим(Истина);
	
	Ответственный = ПараметрыСеанса.ТекущийПользователь;
	ТДата		  = ТекущаяДатаСеанса();
 
	НачатьТранзакцию(РежимУправленияБлокировкойДанных.Управляемый);
	
		СпрОбъект 				= СерийныеНомераНоменклатуры.ПолучитьОбъект();
		СпрОбъект.Распакован 	= Истина;
		СпрОбъект.Ответственный = Ответственный;
		СпрОбъект.Дата 			= ТДата;
		СпрОбъект.Комментарий = Комментарий;
		Попытка
		    СпрОбъект.Записать();
		Исключение
			СообщенияОбОшибке = НСтр("ru='Не удалось записать элемент справочника  Серийные номера номенклатуры.'"+ ОписаниеОшибки(), ОбщегоНазначенияКлиентСервер.КодОсновногоЯзыка());
		    ОбщегоНазначенияКлиентСервер.СообщитьПользователю(СообщенияОбОшибке);   
			ОтменитьТранзакцию();
			Возврат ЛОЖЬ;
		КонецПопытки;   

		НаборЗаписей = РегистрыСведений.КТС_СерийныеНомераНоменклатурыИстория.СоздатьНаборЗаписей();
		НаборЗаписей.Отбор.Период.Установить(ТДата); 
		НаборЗаписей.Отбор.Номенклатура.Установить(СерийныеНомераНоменклатуры.Владелец);
		НаборЗаписей.Отбор.СерийныйНомер.Установить(СерийныеНомераНоменклатуры);

		Запись 						= НаборЗаписей.Добавить();
		Запись.Период 				= ТДата;
		Запись.Номенклатура 		= СерийныеНомераНоменклатуры.Владелец;
		Запись.СерийныйНомер 		= СерийныеНомераНоменклатуры;
		Запись.Ответственный 		= Ответственный;
		Запись.Комментарий 			= Комментарий;

		Попытка
			НаборЗаписей.Записать();    					
		Исключение
			СообщенияОбОшибке = НСтр("ru='Не удалось записать историю по с/н.'"+ ОписаниеОшибки(), ОбщегоНазначенияКлиентСервер.КодОсновногоЯзыка());
			ОбщегоНазначенияКлиентСервер.СообщитьПользователю(СообщенияОбОшибке);
			ОтменитьТранзакцию();
			Возврат ЛОЖЬ;  
		КонецПопытки; 
	
	ЗафиксироватьТранзакцию();
	Возврат ИСТИНА; 

КонецФункции // ЗаписатьНаСервере()


#КонецОбласти