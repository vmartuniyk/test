
&НаКлиенте
Функция ПроверитьКлючСвязи(Объект, КлючСвязиНоменклатуры) Экспорт
	ПараметрОтбора = Новый Структура("КлючСвязиСерийныхНомеров", КлючСвязиНоменклатуры);
	РезультатОтбора = Объект.Товары.НайтиСтроки(ПараметрОтбора);	
	Если КлючСвязиНоменклатуры = 0 Тогда
		Возврат СоздатьКлючСвязи(Объект);
	ИначеЕсли НЕ РезультатОтбора.Количество() = 1 Тогда
		Возврат СоздатьКлючСвязи(Объект);
	Иначе
		Возврат КлючСвязиНоменклатуры;
	КонецЕсли; 	
КонецФункции

&НаКлиенте
Функция СоздатьКлючСвязи(Объект)
	НовыйКлючСвязи = 0;
	ПроходПоЗначениям = 1;
	ПараметрОтбора = Новый Структура("КлючСвязиСерийныхНомеров", ПроходПоЗначениям);		
	Пока НовыйКлючСвязи = 0 Цикл
		РезТовары = Объект.Товары.НайтиСтроки(ПараметрОтбора);
		РезСерийныеНомера = Объект.СерийныеНомера.НайтиСтроки(ПараметрОтбора);
		Если РезТовары.Количество() = 0 И РезСерийныеНомера.Количество() = 0 Тогда
			НовыйКлючСвязи = ПроходПоЗначениям;
		Иначе
			ПроходПоЗначениям = ПроходПоЗначениям + 1;
			ПараметрОтбора.КлючСвязиСерийныхНомеров = ПроходПоЗначениям;
		КонецЕсли;	
	КонецЦикла;	
	Возврат НовыйКлючСвязи;
КонецФункции

&НаКлиенте
Функция ПроверитьКоличествоСерийныхНомеров(Объект, Количество, КлючСвязи, КоличествоВвода = 1) Экспорт
	Если Количество < Объект.СерийныеНомера.НайтиСтроки(Новый Структура("КлючСвязиСерийныхНомеров", КлючСвязи)).Количество() + КоличествоВвода Тогда
		Возврат Истина;
	КонецЕсли;
	Возврат Ложь;
КонецФункции

&НаКлиенте
Функция ПроверитьКоличествоСерийныхНомеровКомплект(Объект, Количество, КлючСвязи, КоличествоВвода = 1, СерийныйНомер) Экспорт
	Если Количество < Объект.СерийныеНомера.НайтиСтроки(Новый Структура("КлючСвязиСерийныхНомеров, СерийныйНомерКомплекта", КлючСвязи, СерийныйНомер)).Количество() + КоличествоВвода Тогда
		Возврат Истина;
	КонецЕсли;
	Возврат Ложь;
КонецФункции

&НаКлиенте
Функция ПроверитьКоличествоСерийныхНомеровДляКомплекта(Объект, Количество, КоличествоВвода = 1) Экспорт
	Если Количество < Объект.СерийныеНомераКомплектов.Количество() + КоличествоВвода Тогда
		Возврат Истина;
	КонецЕсли;
	Возврат Ложь;
КонецФункции

&НаКлиенте 
Процедура ОбновитьОтображениеСтраниц(Элементы, Структура) Экспорт
	Если Структура.НужноВводитьСерийныеНомера Тогда
		Если Структура.ИспользоватьСерийныеНомера Тогда
			Элементы.Pages.ТекущаяСтраница = Элементы.СтраницаУчетИспользуется;	
		Иначе
			Элементы.Pages.ТекущаяСтраница = Элементы.СтраницаОбщие;	
		КонецЕсли;
	Иначе
		Элементы.Pages.ТекущаяСтраница = Элементы.СтраницаУчетНеИспользуется;		
	КонецЕсли;		
КонецПроцедуры

&НаКлиенте 
Процедура ОбновитьИндикаторы(ЭтаФорма, Объект, КлючСвязи) Экспорт
	Если ЭтаФорма.Элементы.Pages.ТекущаяСтраница = ЭтаФорма.Элементы.СтраницаУчетИспользуется Тогда
		Если НЕ ЭтаФорма.Элементы.Найти("ТаблицаРасходSN") = Неопределено Тогда
			ЭтаФорма.ДоступноSN = ЭтаФорма.ТаблицаРасходSN.Количество();
		КонецЕсли;
		ЭтаФорма.ВыбраноSN  = Объект.СерийныеНомера.НайтиСтроки(Новый Структура("КлючСвязиСерийныхНомеров", КлючСвязи)).Количество();
		Если НЕ ЭтаФорма.Элементы.Найти("ТаблицаВыбранныеSNкомплекта") = Неопределено Тогда
			ЭтаФорма.ДоступноSNКомплект = Объект.СерийныеНомераКомплектов.Количество();
		Иначе
			ЭтаФорма.ТекущийЭлемент = ЭтаФорма.Элементы.СтрокаСканерSN;	
		КонецЕсли;
	КонецЕсли;
КонецПроцедуры



&НаСервере
Функция ПолучитьСерийныйНомер(Номенклатура, Строка) Экспорт
	Строка = ВРег(Строка);
	Ссылка = Справочники.СерийныеНомераНоменклатуры.НайтиПоКоду(Строка, , , Номенклатура);
	Если НЕ ЗначениеЗаполнено(Ссылка) Тогда
		НовыйОбъект = Справочники.СерийныеНомераНоменклатуры.СоздатьЭлемент();
		НовыйОбъект.Владелец = Номенклатура;
		НовыйОбъект.Код = Строка;
		НовыйОбъект.Записать();
		Ссылка = НовыйОбъект.Ссылка;
	КонецЕсли;
	Возврат Ссылка;	
КонецФункции



