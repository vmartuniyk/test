#Область ИнтерфейсАвтоматическихТестов

&НаКлиенте
Перем ЮнитТест;

&НаКлиенте
Функция ПолучитьСписокТестов(ЮнитТестирование) Экспорт
	
	ЮнитТест = ЮнитТестирование;
	
	СписокТестов = Новый Массив;	
	Возврат СписокТестов;
	
КонецФункции

#КонецОбласти

#Область ОбработчикиСобытийФормы

&НаКлиенте
Процедура ПриОткрытии(Отказ)
	ПринтерQR 			 = ВладелецФормы.ПринтерQR;
	ПринтерА4 			 = ВладелецФормы.ПринтерА4;
	ПринтерТоварногоЧека = ВладелецФормы.ПринтерТоварногоЧека;
	СформироватьСписокПринтеров();
КонецПроцедуры

&НаКлиенте
Процедура ПередЗакрытием(Отказ, СтандартнаяОбработка)
	
	Если Не Модифицированность Тогда
	    Возврат;			
	КонецЕсли; 
	
	Ответ = Вопрос(НСтр("ru='Настройки были изменены, сохранить изменения'", ОбщегоНазначенияКлиентСервер.КодОсновногоЯзыка()), РежимДиалогаВопрос.ДаНетОтмена);
	
	Если Ответ = КодВозвратаДиалога.Да Тогда
		ЗаписатьНастройкиПриемки();
	ИначеЕсли Ответ = КодВозвратаДиалога.Нет Тогда
		Модифицированность = Ложь;
	Иначе
		Отказ = Истина;
	КонецЕсли;
	
КонецПроцедуры
#КонецОбласти

#Область ОбработчикиСобытийЭлементовШапкиФормы

&НаКлиенте
Процедура ПринтерQRПриИзменении(Элемент)
	Модифицированность=Истина;
КонецПроцедуры

&НаКлиенте
Процедура ПринтерQRНачалоВыбора(Элемент, ДанныеВыбора, СтандартнаяОбработка)
	
	СтандартнаяОбработка = Ложь;	
	
	ВыбЭлемент = СписокПринтеров.ВыбратьЭлемент("Выберите принтер печати QR кода: ", ВыбЭлемент);
	Если ВыбЭлемент = Неопределено Тогда
		Если ПустаяСтрока(ПринтерQR) Тогда 
			Сообщить("Не выбран принтер печати QR кода ");
		КонецЕсли;
	Иначе
		ПринтерQR = ВыбЭлемент.Значение;
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура ПринтерА4ПриИзменении(Элемент)
	Модифицированность=Истина;
КонецПроцедуры

&НаКлиенте
Процедура ПринтерА4НачалоВыбора(Элемент, ДанныеВыбора, СтандартнаяОбработка)
	
	СтандартнаяОбработка = Ложь;	
	
	ВыбЭлемент = СписокПринтеров.ВыбратьЭлемент("Выберите принтер печати А4: ", ВыбЭлемент);
	Если ВыбЭлемент = Неопределено Тогда
		Если ПустаяСтрока(ПринтерА4) Тогда 
			Сообщить("Не выбран принтер печати А4");
		КонецЕсли;
	Иначе
		ПринтерА4 = ВыбЭлемент.Значение;
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура ПринтерТоварногоЧекаПриИзменении(Элемент)
	Модифицированность=Истина;
КонецПроцедуры

&НаКлиенте
Процедура ПринтерТоварногоЧекаНачалоВыбора(Элемент, ДанныеВыбора, СтандартнаяОбработка)
	
	СтандартнаяОбработка = Ложь;	
	
	ВыбЭлемент = СписокПринтеров.ВыбратьЭлемент("Выберите принтер печати товарного чека: ", ВыбЭлемент);
	Если ВыбЭлемент = Неопределено Тогда
		Если ПустаяСтрока(ПринтерТоварногоЧека) Тогда 
			Сообщить("Не выбран принтер печати товарного чека");
		КонецЕсли;
	Иначе
		ПринтерТоварногоЧека = ВыбЭлемент.Значение;
	КонецЕсли;
	
КонецПроцедуры

#КонецОбласти

#Область ОбработчикиКомандФормы

&НаКлиенте
Процедура Записать(Команда)
	ЗаписатьНастройкиПриемки();
КонецПроцедуры

&НаКлиенте
Процедура ЗаписатьИЗакрыть(Команда)
	ЗаписатьНастройкиПриемки();
	Закрыть();
КонецПроцедуры
#КонецОбласти




////////////////////////////////////////////////////////////////////////////////
// СЛУЖЕБНЫЕ ПРОЦЕДУРЫ И ФУНКЦИИ

&НаКлиенте
Процедура ЗаписатьНастройкиПриемки()
	Модифицированность		= Ложь;
	ВладелецФормы.ПринтерQR = ПринтерQR;
	ВладелецФормы.ПринтерА4 = ПринтерА4;
	ВладелецФормы.ПринтерТоварногоЧека = ПринтерТоварногоЧека;
КонецПроцедуры // ЗаписатьНастройкиПриемки()

&НаКлиенте
Процедура СформироватьСписокПринтеров()
	
	ИмяКомпьютера=".";
	ServiceSet=GetCOMObject("winmgmts:{impersonationLevel=impersonate}!\\"+ИмяКомпьютера+"\root\cimv2");
	PrinterSet=ServiceSet.Get("Win32_Printer");
	
	Попытка
		mItems=ServiceSet.ExecQuery("Select * from Win32_Printer");
	Исключение
		Сообщить(ОписаниеОшибки());
		Отказ=Истина;
		Возврат;
	КонецПопытки;
	
	Для каждого Принтер Из mItems Цикл
		НоваяСтрока 				= СписокПринтеров.Добавить();
		НоваяСтрока.Значение 		= Принтер.Name;
		НоваяСтрока.Представление	= Принтер.Name;
	КонецЦикла; 
	
КонецПроцедуры
