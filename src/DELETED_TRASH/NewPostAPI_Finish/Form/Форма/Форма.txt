//Данилюк Андрей
// www.danila.org.ua

&НаСервере
Функция ПодготовитьСимволыВТексте(ТекстДляЗамены) Экспорт
	Результат = ТекстДляЗамены;
	Результат = СтрЗаменить(Результат, "&", "&amp;");
	Результат = СтрЗаменить(Результат, """", "&quot;");
	Результат = СтрЗаменить(Результат, "<", "&lt;");
	Результат = СтрЗаменить(Результат, ">", "&gt;");
	Результат = СтрЗаменить(Результат, "'", "&#0039;");
	Возврат Результат;
КонецФункции

&НаСервере
Функция ВыгрузитьЗаказСервер()
	СтруктураЗаказа = Новый Структура;
	СтруктураЗаказа.Вставить("order_id", ПодготовитьСимволыВТексте(ВнутреннийНомерЗаказа));
	СтруктураЗаказа.Вставить("sender_city", ПодготовитьСимволыВТексте(ГородОтправитель));
	СтруктураЗаказа.Вставить("sender_company",  ПодготовитьСимволыВТексте(КомпанияОтправитель));
	СтруктураЗаказа.Вставить("sender_address",ПодготовитьСимволыВТексте(НомерОтделенияОтправитель));
	СтруктураЗаказа.Вставить("sender_contact", ПодготовитьСимволыВТексте(КонтактноеЛицоОтправитель));
	СтруктураЗаказа.Вставить("sender_phone", ПодготовитьСимволыВТексте(ТелефонОтправитель));
	СтруктураЗаказа.Вставить("rcpt_city_name",ПодготовитьСимволыВТексте(ГородПолучатель));
	СтруктураЗаказа.Вставить("rcpt_name",ПодготовитьСимволыВТексте(ПолучательНаименование));
	СтруктураЗаказа.Вставить("rcpt_warehouse",ПодготовитьСимволыВТексте(НомерОтделенияПолучатель));
	СтруктураЗаказа.Вставить("rcpt_contact", ПодготовитьСимволыВТексте(КонтактноеЛицоПолучатель));
	СтруктураЗаказа.Вставить("rcpt_phone_num",ПодготовитьСимволыВТексте(ТелефонПолучатель));
	СтруктураЗаказа.Вставить("pack_type", ПодготовитьСимволыВТексте(ВидУпаковки));
	СтруктураЗаказа.Вставить("description", ПодготовитьСимволыВТексте(Описание));
	СтруктураЗаказа.Вставить("pay_type", ПодготовитьСимволыВТексте(ВидОплаты));
	СтруктураЗаказа.Вставить("payer", ПодготовитьСимволыВТексте(ВидПлательщика));
	СтруктураЗаказа.Вставить("cost", ПодготовитьСимволыВТексте(ЗаявленнаяСтоимость));
	СтруктураЗаказа.Вставить("redelivery_type ", ПодготовитьСимволыВТексте(ЗворотняДоставка));
	СтруктураЗаказа.Вставить("delivery_in_out", ПодготовитьСимволыВТексте(ДодатковаИнформация));
	СтруктураЗаказа.Вставить("redelivery_payment_city", ПодготовитьСимволыВТексте(ГородПлатника));
	СтруктураЗаказа.Вставить("length", ПодготовитьСимволыВТексте(Длина));
    СтруктураЗаказа.Вставить("width", ПодготовитьСимволыВТексте(глубина));
    СтруктураЗаказа.Вставить("height", ПодготовитьСимволыВТексте(Висота));
	СтруктураЗаказа.Вставить("redelivery_payment_payer", ПодготовитьСимволыВТексте(ПлатникЗВ));
	 СтруктураЗаказа.Вставить("loadType_id", ПодготовитьСимволыВТексте(ВидВантажу));
	СтруктураЗаказа.Вставить("weight", ПодготовитьСимволыВТексте(Вес));
    МассивМест = МестаВЗаказе.Выгрузить().ВыгрузитьКолонку("Место");
	СтруктураЗаказа.Вставить("order_cont",МассивМест);
	
	ОбработкаОбъект = РеквизитФормыВЗначение("Объект");
	НомерЗаказаВСистеме = ОбработкаОбъект.ВыгрузитьЗаказ(СтруктураЗаказа);
	
	Если Не НомерЗаказаВСистеме = Неопределено Тогда 
		Сообщить("Заказ выгружен. Ему присвоен номер: " + НомерЗаказаВСистеме);
	Иначе 
		Сообщить("Заказ не был выгружен", СтатусСообщения.Важное);
	КонецЕсли;
	ЗначениеВРеквизитФормы(ОбработкаОбъект,"Объект");
КонецФункции

&НаКлиенте
Процедура Выгрузить(Команда)
	ВыгрузитьЗаказСервер();
КонецПроцедуры

&НаСервере
Процедура ОбновитьСписокОтделенийСервер()
	ОбработкаОбъект = РеквизитФормыВЗначение("Объект");
	ОбработкаОбъект.ТаблицаОтделений.Загрузить(ОбработкаОбъект.ПолучитьТаблицуОтделений());
	ОбработкаАдресСтрока = ПоместитьВоВременноеХранилище(ОбработкаОбъект,УникальныйИдентификатор);
	ЗначениеВРеквизитФормы(ОбработкаОбъект,"Объект");
КонецПроцедуры

&НаКлиенте
Процедура ОбновитьСписокОтделений(Команда)
	ОбновитьСписокОтделенийСервер()
КонецПроцедуры

&НаКлиенте
Процедура ВыбратьОтделениеОтправитель(Команда)
	СтруктураОтделения = Новый Структура("Город, НомерОтделения", ГородОтправитель, НомерОтделенияОтправитель);
	РезультатВыбора = ВыбратьОтделение(СтруктураОтделения);
	Если Не РезультатВыбора = Неопределено Тогда 
		ГородОтправитель = РезультатВыбора.Город;
		НомерОтделенияОтправитель = РезультатВыбора.НомерОтделения;
	КонецЕсли;
КонецПроцедуры

&НаКлиенте
Процедура ВыбратьОтделениеПолучатель(Команда)
	СтруктураОтделения = Новый Структура("Город, НомерОтделения", ГородПолучатель, НомерОтделенияПолучатель);
	РезультатВыбора = ВыбратьОтделение(СтруктураОтделения);
	Если Не РезультатВыбора = Неопределено Тогда 
		ГородПолучатель = РезультатВыбора.Город;
		НомерОтделенияПолучатель = РезультатВыбора.НомерОтделения;
	КонецЕсли;
КонецПроцедуры

&НаКлиенте
Функция ВыбратьОтделение(СтруктураВыбранногоОтделения)
	Если Объект.ТаблицаОтделений.Количество() = 0 Тогда 
		ОбновитьСписокОтделенийСервер();
	КонецЕсли;
	
	ПараметрыФормы = Новый Структура;
	ПараметрыФормы.Вставить("ОбработкаАдрес",ОбработкаАдресСтрока);
	ПараметрыФормы.Вставить("СтруктураОтделения",СтруктураВыбранногоОтделения);
	//ФормаВыбора = ПолучитьФорму("ВнешняяОбработка.NewPostAPI.Форма.ФормаВыбораОтделения", ПараметрыФормы);
	ФормаВыбора = ПолучитьФорму("ВнешняяОбработка.NewPostAPI_KTC.Форма.ФормаВыбораОтделения", ПараметрыФормы);
	Возврат ФормаВыбора.ОткрытьМодально();
КонецФункции

&НаКлиенте
Процедура АПИКлючПриИзменении(Элемент)
	ТекДоступность = Не (Объект.АПИКлюч = "");
	Для Каждого ТекЭлемент Из Элементы.Страницы.ПодчиненныеЭлементы Цикл
		ТекЭлемент.Доступность = ТекДоступность;
	КонецЦикла;
	
КонецПроцедуры

&НаКлиенте
Процедура ПечатьЗаказа(Команда)
	Адрес = "http://orders.novaposhta.ua/pformn.php?o=" + НомерЗаказаПечать + "&num_copy=1&token=" + Объект.АПИКлюч;
	ПечатнаяФормаЗаказа = Адрес;
КонецПроцедуры

&НаСервере
Процедура СостояниеЗаказаСервер()
	ОбработкаОбъект = РеквизитФормыВЗначение("Объект");
	СостояниеЗаказа = ОбработкаОбъект.ПолучитьСостояниеЗаказа(НомерЗаказаСостояние);
	ЗначениеВРеквизитФормы(ОбработкаОбъект,"Объект");
КонецПроцедуры

&НаКлиенте
Процедура СостояниеЗаказа(Команда)
	СостояниеЗаказаСервер();
КонецПроцедуры

&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	Объект.АПИКлюч = "936cdce41f1ea16e738b301ecb772f7b";
КонецПроцедуры

&НаКлиенте
Процедура ГородПлатникаНачалоВыбораИзСписка(Элемент, СтандартнаяОбработка)
	СписокЗначений = Новый СписокЗначений;
	СписокЗначений.Добавить( ГородОтправитель);
	СписокЗначений.Добавить( ГородПолучатель);
	Элементы.ГородПлатника.СписокВыбора.ЗагрузитьЗначения( СписокЗначений.ВыгрузитьЗначения());
	
КонецПроцедуры

&НаКлиенте
Процедура Отправить(Команда)
	Ссилка = "http://orders.novaposhta.ua/pformn.php?o=" + НомерЗаказаПечать + "&num_copy=1&token=" + Объект.АПИКлюч;
	 Силка= Ссилка;
	КонецПроцедуры
