
&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	
	УстановитьПривилегированныйРежим(Истина);
	
	ИспользоватьХарактеристикиНоменклатуры = ПолучитьФункциональнуюОпцию("ИспользоватьХарактеристикиНоменклатуры");
	
	Заголовок = Заголовок + ": "+ Параметры.Номенклатура;
	
	Если НЕ ИспользоватьХарактеристикиНоменклатуры Тогда
		Элементы.СписокХарактеристика.Видимость = Ложь;
		Заголовок = Заголовок + " ("+ Параметры.Характеристика + ")";
	КонецЕсли;
	
	Номенклатура = Параметры.Номенклатура;
	Характеристика = Параметры.Характеристика;
	
	//ОтборыСписковКлиентСервер.ИзменитьЭлементОтбораСписка(
	//	Список,
	//	"Номенклатура",
	//	Параметры.Номенклатура,
	//	Истина, ВидСравненияКомпоновкиДанных.Равно
	//);
	
	Запрос = Новый Запрос;
	Запрос.Текст = "
	|ВЫБРАТЬ 
	|	СвободныеОстаткиОстатки.Номенклатура,
	|	СвободныеОстаткиОстатки.Характеристика,
	|	СвободныеОстаткиОстатки.Склад.Наименование КАК Склад,
	|	СвободныеОстаткиОстатки.ВНаличииОстаток,
	|	СвободныеОстаткиОстатки.ВРезервеОстаток
	|ИЗ
	|	РегистрНакопления.СвободныеОстатки.Остатки КАК СвободныеОстаткиОстатки
	|ГДЕ
	|	СвободныеОстаткиОстатки.Номенклатура = &Номенклатура";
	
	Если ИспользоватьХарактеристикиНоменклатуры И ЗначениеЗаполнено(Параметры.Характеристика) Тогда
		Запрос.Текст = Запрос.Текст = "
		|И	СвободныеОстаткиОстатки.Характеристика = &Характеристика";
		Запрос.УстановитьПараметр("Характеристика", Параметры.Характеристика);
	КонецЕсли;
	
	Запрос.УстановитьПараметр("Номенклатура", Параметры.Номенклатура);
	
	РезультатЗапроса = Запрос.Выполнить();
	
	Список.Загрузить(РезультатЗапроса.Выгрузить());	
	
КонецПроцедуры // ПриСозданииНаСервере()

&НаКлиенте
Процедура ЗакрытьОкно(Команда)
	
	Закрыть();
	
КонецПроцедуры

&НаКлиенте
Процедура СписокПриАктивизацииСтроки(Элемент)
	
	ТекущиеДанные = Элементы.Список.ТекущиеДанные;
	
	Если ТекущиеДанные <> Неопределено Тогда
		
		ПриАктивизацииСтрокиНаСервере(ТекущиеДанные.Номенклатура, ТекущиеДанные.Характеристика, ТекущиеДанные.Склад);
		
	КонецЕсли;
	
	
КонецПроцедуры

&НаСервере
Процедура ПриАктивизацииСтрокиНаСервере(НоменклатураСсылка, ХарактеристикаСсылка, СкладСсылка)
	
	УстановитьПривилегированныйРежим(Истина);
	
	Запрос = Новый Запрос;
	Запрос.Текст = "
	|ВЫБРАТЬ 
	|	ДоступностьТоваровДляВнешнихПользователей.Период,
	|	ДоступностьТоваровДляВнешнихПользователей.Номенклатура,
	|	ДоступностьТоваровДляВнешнихПользователей.Характеристика,
	|	ДоступностьТоваровДляВнешнихПользователей.Склад.Наименование КАК Склад,
	|	ДоступностьТоваровДляВнешнихПользователей.Доступно
	|ИЗ
	|	РегистрСведений.ДоступностьТоваровДляВнешнихПользователей КАК ДоступностьТоваровДляВнешнихПользователей
	|ГДЕ
	|	ДоступностьТоваровДляВнешнихПользователей.Номенклатура = &Номенклатура
	|И	ДоступностьТоваровДляВнешнихПользователей.Характеристика = &Характеристика
	|И	ДоступностьТоваровДляВнешнихПользователей.Склад = &Склад";
	
	Запрос.УстановитьПараметр("Номенклатура", НоменклатураСсылка);
	Запрос.УстановитьПараметр("Характеристика", ХарактеристикаСсылка);
	Запрос.УстановитьПараметр("Склад", Справочники.Склады.НайтиПоНаименованию(СкладСсылка));
	
	РезультатЗапрса = Запрос.Выполнить();
	
	ГрафикДоступностиТоваров.Загрузить(РезультатЗапрса.Выгрузить());
	
КонецПроцедуры