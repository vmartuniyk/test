

&НаКлиенте
Процедура ФайлКартинкиНачалоВыбора(Элемент, ДанныеВыбора, СтандартнаяОбработка)
	
	СтандартнаяОбработка = Ложь;
	
	ПараметрыФормы = Новый Структура;
	ПараметрыФормы.Вставить("ВладелецФайла", ВладелецФайла);	
	
	ДиалогВыбораФайла = Новый ДиалогВыбораФайла(РежимДиалогаВыбораФайла.Открытие);
	ДиалогВыбораФайла.ПолноеИмяФайла = "";
	Фильтр = "(*.bmp)|*.bmp; (*.jpeg)|*.jpeg; (*.jpg)|*.jpg; (*.gif)|*.gif";
	ДиалогВыбораФайла.Фильтр = Фильтр;
	ДиалогВыбораФайла.ПредварительныйПросмотр = Истина;
	ДиалогВыбораФайла.МножественныйВыбор = Ложь;
	ДиалогВыбораФайла.Заголовок = "Выберите файл картинки номенклатуры:";
	Если ДиалогВыбораФайла.Выбрать() Тогда
		
		ИмяФайла = ДиалогВыбораФайла.ВыбранныеФайлы[0];
		
		Файл = Новый Файл(ИмяФайла);
		ЗапретЗагрузкиФайловПоРасширению = РаботаСФайламиКлиентПовтИсп.ПолучитьПерсональныеНастройкиРаботыСФайлами().ЗапретЗагрузкиФайловПоРасширению;
		СписокЗапрещенныхРасширений = РаботаСФайламиКлиентПовтИсп.ПолучитьПерсональныеНастройкиРаботыСФайлами().СписокЗапрещенныхРасширений;
		РасширениеФайла = Файл.Расширение;
		
		Если Не РаботаСФайламиКлиентСервер.РасширениеФайлаРазрешеноДляЗагрузки(ЗапретЗагрузкиФайловПоРасширению, СписокЗапрещенныхРасширений, РасширениеФайла) Тогда
			ВызватьИсключение
			   СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(НСтр("ru = 'Загрузка файлов с расширением ""%1"" запрещена. Обратитесь к администратору системы.'"),РасширениеФайла);
			Возврат;
		КонецЕсли;
		
		Если Файл.Размер() > 80000 Тогда
			ВызватьИсключение
			   СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(НСтр("ru = 'Размер файла ""%1"" больше 80 кбайт.'"), Файл.Имя);
			   Возврат;
		КонецЕсли;
		   
		АдресВременногоХранилищаТекста = ФайловыеФункцииКлиент.ИзвлечьТекстВоВременноеХранилище(Файл.ПолноеИмя, УникальныйИдентификатор);   
		
		ВремяИзменения = Файл.ПолучитьВремяИзменения();
		ВремяИзмененияУниверсальное = Файл.ПолучитьУниверсальноеВремяИзменения();
		
		ИмяСоздания = Файл.ИмяБезРасширения;
		
		ИмяФайла = ИмяСоздания + Файл.Расширение;
		РазмерВМб = Файл.Размер() / (1024 * 1024);
	
		ТекстПояснения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(НСтр("ru = 'Идет сохранение файла ""%1"" (%2 Мб).|Пожалуйста, подождите...'"), ИмяФайла, ?(РазмерВМб >= 1, Формат(РазмерВМб, "ЧДЦ=0"), Формат(РазмерВМб, "ЧДЦ=1; ЧН=0")));
		Состояние(ТекстПояснения);

		// Поместим Файл в ВременноеХранилище
		АдресВременногоХранилищаФайла = "";
		
		ПомещаемыеФайлы = Новый Массив;
		Описание = Новый ОписаниеПередаваемогоФайла(Файл.ПолноеИмя, "");
		ПомещаемыеФайлы.Добавить(Описание);
		
		ПомещенныеФайлы = Новый Массив;

		Если НЕ ПоместитьФайлы(ПомещаемыеФайлы, ПомещенныеФайлы, , Ложь, УникальныйИдентификатор) Тогда		
			ВызватьИсключение
			  СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
				НСтр("ru = 'Ошибка при помещении файла в хранилище: %1'"), Файл.ПолноеИмя);
		КонецЕсли;
		
		Если ПомещенныеФайлы.Количество() = 1 Тогда
			АдресВременногоХранилищаФайла = ПомещенныеФайлы[0].Хранение;
		КонецЕсли;
		
		ктсУдалитьПрисоедененныеФайлы();
		
		// Создадим карточку Файла в БД
		Док = РаботаСФайлами.СоздатьФайлСВерсией(ВладелецФайла, ИмяСоздания, ФайловыеФункцииКлиентСервер.РасширениеБезТочки(Файл.Расширение), ВремяИзменения, ВремяИзмененияУниверсальное, Файл.Размер(), АдресВременногоХранилищаФайла, АдресВременногоХранилищаТекста, Ложь); // это не веб клиент
		Состояние();
		
		ПараметрыОповещения = Новый Структура("Владелец, Файл", ВладелецФайла, Док);
		Оповестить("СозданФайл", ПараметрыОповещения);
		
		НавигационнаяСсылка = ПолучитьНавигационнуюСсылку(Док);
		ПоказатьОповещениеПользователя(НСтр("ru = 'Создание:'"), НавигационнаяСсылка, Док, БиблиотекаКартинок.Информация32);
		
		ПараметрыНовогоФайла = Новый Структура("Ключ, КарточкаОткрытаПослеСозданияФайла, НовыйФайл", Док, Истина, Истина);
		
		ктсПолучитьФайлКартинки();
		
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура Сохранить(Команда)
	
	ктсСохранитьКартинкуНоменклатурыВСправочник();
	Закрыть(Картинка);
	
КонецПроцедуры

&НаСервере
Процедура ктсСохранитьКартинкуНоменклатурыВСправочник()
	
	ОбъектСправочника = ВладелецФайла.ПолучитьОбъект();
	ОбъектСправочника.ФайлКартинки = ФайлКартинки;
	ОбъектСправочника.Записать();
	
КонецПроцедуры

&НаСервере
Процедура ктсУдалитьПрисоедененныеФайлы()
	
	Запрос = Новый Запрос;
	ТекстЗапроса = "
	|ВЫБРАТЬ
	|	Файлы.Ссылка
	|ИЗ
	|	Справочник.Файлы КАК Файлы
	|ГДЕ
	|	Файлы.ВладелецФайла = &Владелец";
	
	Запрос.УстановитьПараметр("Владелец", ВладелецФайла);
	Запрос.Текст = ТекстЗапроса;
	
	РезультатыЗапроса = Запрос.Выполнить().Выбрать(ОбходРезультатаЗапроса.Прямой);
	
	Пока РезультатыЗапроса.Следующий() Цикл
		ОбъектСправочника = РезультатыЗапроса.Ссылка.ПолучитьОбъект();
		ОбъектСправочника.Удалить();
	КонецЦикла;
	
КонецПроцедуры

&НаСервере
Процедура ктсПолучитьФайлКартинки()
	
	Запрос = Новый Запрос;
	ТекстЗапроса = "
	|ВЫБРАТЬ
	|	Файлы.Ссылка
	|ИЗ
	|	Справочник.Файлы КАК Файлы
	|ГДЕ
	|	Файлы.ВладелецФайла = &Владелец";
	
	Запрос.УстановитьПараметр("Владелец", ВладелецФайла);
	Запрос.Текст = ТекстЗапроса;
	
	РезультатыЗапроса = Запрос.Выполнить().Выбрать(ОбходРезультатаЗапроса.Прямой);
	
	ФайлКартинкиНоменклатуры = "";
	Если РезультатыЗапроса.Следующий() Тогда
		ФайлКартинки = РезультатыЗапроса.Ссылка; 
		Если ФайлКартинки <> Неопределено ИЛИ ФайлКартинки <> NULL Тогда
			Картинка = РаботаСФайлами.ПолучитьНавигационнуюСсылкуВоВременномХранилище(ФайлКартинки.ТекущаяВерсия, Неопределено);
		Иначе
			Картинка = "";
		КонецЕсли;
	КонецЕсли;
	
	
КонецПроцедуры

&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	
	ктсПолучитьФайлКартинки();
	
КонецПроцедуры
