
&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	
	УстановитьПривилегированныйРежим(Истина);
	
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ
	               |	СерийныеНомераНоменклатурыОстатки.СерийныеНомера КАК СерийныйНомер
	               |ИЗ
	               |	РегистрНакопления.СерийныеНомераНоменклатуры.Остатки(
	               |			,
	               |			Номенклатура = &Номенклатура
	               |				И Характеристика = &Характеристика
	               |				И Склад = &Склад) КАК СерийныеНомераНоменклатурыОстатки
				   |ГДЕ
				   |	СерийныеНомераНоменклатурыОстатки.СерийныеНомера НЕ В (&МассивСН)";
				   
	Запрос.УстановитьПараметр("Номенклатура", Параметры.Номенклатура);
	Запрос.УстановитьПараметр("Характеристика", Параметры.Характеристика);
	Запрос.УстановитьПараметр("Склад", Справочники.Склады.НайтиПоНаименованию(Параметры.Склад));
	Запрос.УстановитьПараметр("МассивСН", Параметры.МассивСН);
	
	РезультатЗапроса = Запрос.Выполнить();
	
	ДоступныеСерийныеНомера.Загрузить(РезультатЗапроса.Выгрузить());
	
	
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ
	               |	СерийныеНомераНоменклатурыОстатки.СерийныеНомера КАК СерийныйНомер
	               |ИЗ
	               |	РегистрНакопления.СерийныеНомераНоменклатуры.Остатки(
	               |			,
	               |			Номенклатура = &Номенклатура
	               |				И Характеристика = &Характеристика
	               |				И Склад = &Склад) КАК СерийныеНомераНоменклатурыОстатки
				   |ГДЕ
				   |	СерийныеНомераНоменклатурыОстатки.СерийныеНомера В (&МассивСН)";
				   
	Запрос.УстановитьПараметр("Номенклатура", Параметры.Номенклатура);
	Запрос.УстановитьПараметр("Характеристика", Параметры.Характеристика);
	Запрос.УстановитьПараметр("Склад", Справочники.Склады.НайтиПоНаименованию(Параметры.Склад));
	Запрос.УстановитьПараметр("МассивСН", Параметры.МассивСН);
	
	РезультатЗапроса = Запрос.Выполнить();
	
	ВыбранныеСерийныеНомера.Загрузить(РезультатЗапроса.Выгрузить());	
	
	
	КоличествоНоменклатуры = Параметры.КоличествоНоменклатуры;
	
	
		
	
КонецПроцедуры




&НаКлиенте
Процедура Применить(Команда)
	
	Закрыть(ВыгрузитьМассивСерийников());
	
КонецПроцедуры

&НаСервере
Функция ВыгрузитьМассивСерийников()
	
	ТЗСН = РеквизитФормыВЗначение("ВыбранныеСерийныеНомера", Тип("ТаблицаЗначений"));
	Возврат ТЗСН.ВыгрузитьКолонку("СерийныйНомер");
	
КонецФункции






&НаКлиенте
Процедура ДоступныеСерийныеНомераВыбор(Элемент, ВыбраннаяСтрока, Поле, СтандартнаяОбработка)
	
	Если ВыбранныеСерийныеНомера.Количество() >= КоличествоНоменклатуры Тогда
		
		Сообщение = Новый СообщениеПользователю;
		Сообщение.Текст = "Количество серийных номеров превышает количество номенклатуры.";
		
		Сообщение.Сообщить();
		
		Возврат;
		
	КонецЕсли;
	
	НоваяСтрока 				= ВыбранныеСерийныеНомера.Добавить();
	НоваяСтрока.СерийныйНомер 	= Элемент.ТекущиеДанные.СерийныйНомер;
	
	СтруктураПоиска = Новый Структура("СерийныйНомер", Элемент.ТекущиеДанные.СерийныйНомер);
	НайденныеСтроки = ДоступныеСерийныеНомера.НайтиСтроки(СтруктураПоиска);
	
	Для Каждого НайденнаяСтрока ИЗ НайденныеСтроки Цикл
	
		ДоступныеСерийныеНомера.Удалить(НайденнаяСтрока);
		
	КонецЦикла;
		
КонецПроцедуры

&НаКлиенте
Процедура ВыбранныеСерийныеНомераВыбор(Элемент, ВыбраннаяСтрока, Поле, СтандартнаяОбработка)
	
	НоваяСтрока 				= ДоступныеСерийныеНомера.Добавить();
	НоваяСтрока.СерийныйНомер 	= Элемент.ТекущиеДанные.СерийныйНомер;
	
	
	СтруктураПоиска = Новый Структура("СерийныйНомер", Элемент.ТекущиеДанные.СерийныйНомер);
	НайденныеСтроки = ВыбранныеСерийныеНомера.НайтиСтроки(СтруктураПоиска);
	
	Для Каждого НайденнаяСтрока ИЗ НайденныеСтроки Цикл
	
		ВыбранныеСерийныеНомера.Удалить(НайденнаяСтрока);
		
	КонецЦикла;
	
КонецПроцедуры



