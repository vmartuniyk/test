#Область ИнтейрфейсАвтоматическихТестов
Перем ЮнитТест;
Функция ПолучитьСписокТестов(ЮнитТестирование) Экспорт
	
	ЮнитТест = ЮнитТестирование;
	
	СпиокТестов = Новый Массив;	
	Возврат СпиокТестов;
	
КонецФункции
#КонецОбласти 


#Область ПрограммныйИнтерфейс

// Подготавливает форму документа к работе с DDP 
//
// Параметры:
//  ЭтаФорма 		- УправляемаяФорма 				- Форма документа
//  ВнешнийОбъект 	- Неопределено, ОбработкаОбъект - Внешний объект для переопределения событий формы
//  ИмяОбработки 	- Строка           				- Имя внешней обработки DDP для подключения методов на клиенте
//
Процедура ПодготовитьDDPКРаботе(ЭтаФорма, ВнешнийОбъект, ИмяОбработки = "") Экспорт
	
	ОбъектСсылка = ЭтаФорма.Объект.Ссылка;	
	Если ТипЗнч(ОбъектСсылка) = Тип("ДокументСсылка.ЗаказПоставщику") Тогда
		ПодготовитьДокументСсылка(ЭтаФорма, ВнешнийОбъект, ИмяОбработки);
	ИначеЕсли ТипЗнч(ОбъектСсылка) = Тип("ДокументСсылка.ПоступлениеТоваровУслуг") Тогда
		ПодготовитьДокументСсылка(ЭтаФорма, ВнешнийОбъект, ИмяОбработки);
	КонецЕсли;
	
	
КонецПроцедуры // ПодготовитьDDPКРаботе()

// Расчитывает DDP табличной части "Товары" в заказе поставщику 
//
// Параметры:
//  ОбъектДокумента - ДокументОбъект.ЗаказПоставщику 
//	ЭтаФорма		- УправляемаяФорма				 - Форма доумента заказ поставщику
//  ИмяОбработки    - ???????????
Процедура ТоварыDDPПриИзмененииНаСервере(ЭтаФорма, ОбъектДокумента) Экспорт 
	УслугаDDP 		= Справочники.Номенклатура.ПолучитьСсылку(Новый УникальныйИдентификатор("8014b949-4cca-4dc2-808e-e6fb286406d2"));	
	ВалютаDDP		= Справочники.Валюты.ПолучитьСсылку(Новый УникальныйИдентификатор("f255395e-a9e2-11e3-80c2-001e676b0174"));
	
	КурсыВалюты 	= РаботаСКурсамиВалют.ПолучитьКурсВалюты(ВалютаDDP, ОбъектДокумента.Дата);
	КурсDDP 		= КурсыВалюты.Курс / КурсыВалюты.Кратность;				
	
	КурсыВалюты		= РаботаСКурсамиВалют.ПолучитьКурсВалюты(Константы.ВалютаУправленческогоУчета.Получить(), ОбъектДокумента.Дата);
	КурсУпр 		= КурсыВалюты.Курс / КурсыВалюты.Кратность;	
	
	Если КурсDDP>=КурсУпр Тогда 
		Возврат;       
	КонецЕсли;

	Запрос = Новый Запрос;
	Если ТипЗнч(ОбъектДокумента.Ссылка) = Тип("ДокументСсылка.ЗаказПоставщику") Тогда  
		Запрос.Текст = ПолучитьТекстЗапросаРасчетыDDPВЗаказеПоставщику();
	Иначе                                  
		Запрос.Текст = ПолучитьТекстЗапросаРасчетыDDPВПТиУ();
	КонецЕсли;
	
	Запрос.УстановитьПараметр("Товары"				,ОбъектДокумента.Товары.Выгрузить());
	Запрос.УстановитьПараметр("НалогообложениеНДС"	,ОбъектДокумента.НалогообложениеНДС);
	Запрос.УстановитьПараметр("ЦенаВключаетНДС"		,ОбъектДокумента.ЦенаВключаетНДС);
	Запрос.УстановитьПараметр("КурсDDP"				,КурсDDP);
	Запрос.УстановитьПараметр("КурсУпр"				,КурсУпр);
	Запрос.УстановитьПараметр("Номенклатура"		,УслугаDDP);
	Запрос.УстановитьПараметр("Ссылка"				,ОбъектДокумента.Ссылка);
	
	ОбъектДокумента.Товары.Загрузить(Запрос.Выполнить().Выгрузить());
	Для Каждого Элемент Из ОбъектДокумента.Товары Цикл 
		ПриИзменениеЦеныОбработатьСтрокуТЧ(Элемент,ОбъектДокумента);
	КонецЦикла;
	
	РасчитатьУслугуDDP(УслугаDDP,ОбъектДокумента);
	
КонецПроцедуры	

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

// Подготавливает форму документа к работе с DDP 
//
// Параметры:
//  ЭтаФорма 		- УправляемаяФорма 				- Форма документа
//  ВнешнийОбъект 	- Неопределено, ОбработкаОбъект - Внешний объект для переопределения событий формы
//  ИмяОбработки 	- Строка           				- Имя внешней обработки DDP для подключения методов на клиенте
//
Процедура ПодготовитьДокументСсылка(ЭтаФорма, ВнешнийОбъект, ИмяОбработки)
	
	ПодменитьДействиеУправляемоеПриложение(ВнешнийОбъект, ЭтаФорма, "ПриИзменении", "Товары", "ПриИзмененииТЗТоваров");
	ПодменитьДействиеУправляемоеПриложение(ВнешнийОбъект, ЭтаФорма, "ПередНачаломДобавления", "Товары", "ПередНачаломДобавленияТЗТоваров");
	
	Команды = ЭтаФорма.Команды;
	Элементы = ЭтаФорма.Элементы;
	
	Реквизиты = Новый Массив; 
	Реквизиты.Добавить(Новый РеквизитФормы("РасботаСDDP", Новый ОписаниеТипов("Строка")));
	Реквизиты.Добавить(Новый РеквизитФормы("DDPКопирование", Новый ОписаниеТипов("Булево")));
	ЭтаФорма.ИзменитьРеквизиты(Реквизиты);	
	ЭтаФорма.РасботаСDDP = ИмяОбработки;
	ВалютаРеглУчета      = Константы.ВалютаРегламентированногоУчета.Получить();

	
	Товары = Элементы.Найти("Товары");
	// Создание элемента страницы DDP
	Параметры = Новый Структура;
	Параметры.Вставить("Имя"				,"ТоварыDDP");
	Параметры.Вставить("Вид"				,ВидПоляФормы.ПолеФлажка);
	Параметры.Вставить("ПоложениеЗаголовка"	,ПоложениеЗаголовкаЭлементаФормы.Нет);
	Параметры.Вставить("ПутьКДанным"		,"Объект.Товары.DDP");
	Параметры.Вставить("Подсказка"			,"Расчитать для товара DDP");
	Параметры.Вставить("ТипЭлемента"		,Тип("ПолеФормы"));
	ДобавитьЭлементВКоллекциюЭлементовФормы(ВнешнийОбъект, Элементы, Параметры, Товары);         	
	ПереместитьЭлементВКоллекциюЭлементовФормы(ВнешнийОбъект, Элементы, "ТоварыDDP", "Товары", "ТоварыНомерСтроки");
		
	// Создание элемента страницы СуммаСDDP
	Параметры = Новый Структура;
	Параметры.Вставить("Имя"				,"ТоварыСуммаСDDP");
	Параметры.Вставить("Вид"				,ВидПоляФормы.ПолеВвода);
	Параметры.Вставить("ПоложениеЗаголовка"	,ПоложениеЗаголовкаЭлементаФормы.Авто);
	Параметры.Вставить("ПутьКДанным"		,"Объект.Товары.СуммаСDDP");
	Параметры.Вставить("ТолькоПросмотр"		,Истина);
	Параметры.Вставить("Подсказка"			,"Сумма с учетом DDP");
	Параметры.Вставить("ТипЭлемента"		,Тип("ПолеФормы"));
	Параметры.Вставить("Ширина"				,7);
	ДобавитьЭлементВКоллекциюЭлементовФормы(ВнешнийОбъект, Элементы, Параметры, Товары);         	
	ПереместитьЭлементВКоллекциюЭлементовФормы(ВнешнийОбъект, Элементы, "ТоварыСуммаСDDP", "Товары", "ТоварыСуммаСНДС");

	// Создание элемента страницы КурсоваяРазницаDDP
	Параметры = Новый Структура;
	Параметры.Вставить("Имя"				,"ТоварыКурсоваяРазницаDDP");
	Параметры.Вставить("Вид"				,ВидПоляФормы.ПолеВвода);
	Параметры.Вставить("ПоложениеЗаголовка"	,ПоложениеЗаголовкаЭлементаФормы.Авто);
	Параметры.Вставить("ПутьКДанным"		,"Объект.Товары.КурсоваяРазницаDDP");
	Параметры.Вставить("ТолькоПросмотр"		,Истина);
	Параметры.Вставить("Подсказка"			,"Курсовая разница с учетом DDP");
	Параметры.Вставить("ТипЭлемента"		,Тип("ПолеФормы"));
	Параметры.Вставить("Ширина"				,7);
	ДобавитьЭлементВКоллекциюЭлементовФормы(ВнешнийОбъект, Элементы, Параметры, Товары);         	
	ПереместитьЭлементВКоллекциюЭлементовФормы(ВнешнийОбъект, Элементы, "ТоварыКурсоваяРазницаDDP", "Товары", "ТоварыСуммаСDDP");
	
		
	// Условное оформление
	ЭлементУсловногоОформления 		= ЭтаФорма.УсловноеОформление.Элементы.Добавить();       	
	ОформляемоеПоле 				= ЭлементУсловногоОформления.Поля.Элементы.Добавить();
	ОформляемоеПоле.Поле 			= Новый ПолеКомпоновкиДанных("Товары");
	ЭлементОтбора 					= ЭлементУсловногоОформления.Отбор.Элементы.Добавить(Тип("ЭлементОтбораКомпоновкиДанных"));
	ЭлементОтбора.ЛевоеЗначение 	= Новый ПолеКомпоновкиДанных("Объект.Товары.DDP");
	ЭлементОтбора.ВидСравнения 		= ВидСравненияКомпоновкиДанных.Равно;
	ЭлементОтбора.ПравоеЗначение	= Истина;
	ЭлементУсловногоОформления.Оформление.УстановитьЗначениеПараметра("ЦветФона", WebЦвета.Лимонный);
	ЭлементУсловногоОформления.Оформление.УстановитьЗначениеПараметра("ТолькоПросмотр", Истина);
	
	ЭлементУсловногоОформления 		= ЭтаФорма.УсловноеОформление.Элементы.Добавить();       	
	ОформляемоеПоле 				= ЭлементУсловногоОформления.Поля.Элементы.Добавить();
	ОформляемоеПоле.Поле 			= Новый ПолеКомпоновкиДанных("ТоварыDDP");
	ЭлементОтбора 					= ЭлементУсловногоОформления.Отбор.Элементы.Добавить(Тип("ЭлементОтбораКомпоновкиДанных"));
	ЭлементОтбора.ЛевоеЗначение 	= Новый ПолеКомпоновкиДанных("Объект.Товары.ТипНоменклатуры");
	ЭлементОтбора.ВидСравнения 		= ВидСравненияКомпоновкиДанных.Равно;
	ЭлементОтбора.ПравоеЗначение 	= Перечисления.ТипыНоменклатуры.Услуга;
	ЭлементУсловногоОформления.Оформление.УстановитьЗначениеПараметра("ТолькоПросмотр", Истина);
	
	ЭлементУсловногоОформления 		= ЭтаФорма.УсловноеОформление.Элементы.Добавить();       	
	ОформляемоеПоле 				= ЭлементУсловногоОформления.Поля.Элементы.Добавить();
	ОформляемоеПоле.Поле 			= Новый ПолеКомпоновкиДанных("ТоварыDDP");
	ЭлементОтбора 					= ЭлементУсловногоОформления.Отбор.Элементы.Добавить(Тип("ЭлементОтбораКомпоновкиДанных"));
	ЭлементОтбора.ЛевоеЗначение 	= Новый ПолеКомпоновкиДанных("Объект.Товары.DDP");
	ЭлементОтбора.ВидСравнения 		= ВидСравненияКомпоновкиДанных.Равно;
	ЭлементОтбора.ПравоеЗначение	= Истина;
	ЭлементУсловногоОформления.Оформление.УстановитьЗначениеПараметра("ТолькоПросмотр", Ложь);

	ЭлементУсловногоОформления 		= ЭтаФорма.УсловноеОформление.Элементы.Добавить();       	
	ОформляемоеПоле 				= ЭлементУсловногоОформления.Поля.Элементы.Добавить();
	ОформляемоеПоле.Поле 			= Новый ПолеКомпоновкиДанных("Товары");
	ЭлементОтбора 					= ЭлементУсловногоОформления.Отбор.Элементы.Добавить(Тип("ЭлементОтбораКомпоновкиДанных"));
	ЭлементОтбора.ЛевоеЗначение 	= Новый ПолеКомпоновкиДанных("Объект.Товары.Номенклатура");
	ЭлементОтбора.ВидСравнения 		= ВидСравненияКомпоновкиДанных.Равно;                                    
	ЭлементОтбора.ПравоеЗначение	= Справочники.Номенклатура.ПолучитьСсылку(Новый УникальныйИдентификатор("8014b949-4cca-4dc2-808e-e6fb286406d2"));
	ЭлементУсловногоОформления.Оформление.УстановитьЗначениеПараметра("ТолькоПросмотр", Истина);
	
	ЭлементУсловногоОформления 		= ЭтаФорма.УсловноеОформление.Элементы.Добавить();       	
	ОформляемоеПоле 				= ЭлементУсловногоОформления.Поля.Элементы.Добавить();
	ОформляемоеПоле.Поле 			= Новый ПолеКомпоновкиДанных("ТоварыDDP");
	ЭлементОтбора 					= ЭлементУсловногоОформления.Отбор.Элементы.Добавить(Тип("ЭлементОтбораКомпоновкиДанных"));
	ЭлементОтбора.ЛевоеЗначение 	= Новый ПолеКомпоновкиДанных("Объект.Валюта");
	ЭлементОтбора.ВидСравнения 		= ВидСравненияКомпоновкиДанных.Равно;                                    
	ЭлементОтбора.ПравоеЗначение	= ВалютаРеглУчета;
	ЭлементУсловногоОформления.Оформление.УстановитьЗначениеПараметра("ТолькоПросмотр", Истина);
	
	Если ТипЗнч(ЭтаФорма.Объект.Ссылка) = Тип("ДокументСсылка.ЗаказПоставщику") Тогда 
		ЭлементУсловногоОформления 		= ЭтаФорма.УсловноеОформление.Элементы.Добавить();       	
		ОформляемоеПоле 				= ЭлементУсловногоОформления.Поля.Элементы.Добавить();
		ОформляемоеПоле.Поле 			= Новый ПолеКомпоновкиДанных("ТоварыDDP");
		ЭлементОтбора 					= ЭлементУсловногоОформления.Отбор.Элементы.Добавить(Тип("ЭлементОтбораКомпоновкиДанных"));
		ЭлементОтбора.ЛевоеЗначение 	= Новый ПолеКомпоновкиДанных("Объект.Товары.Отменено");
		ЭлементОтбора.ВидСравнения 		= ВидСравненияКомпоновкиДанных.Равно;
		ЭлементОтбора.ПравоеЗначение	= Истина;
		ЭлементУсловногоОформления.Оформление.УстановитьЗначениеПараметра("ТолькоПросмотр", Истина);
	КонецЕсли;
	
	
	// Меню работы с DDP
	КоманднаяПанель = Элементы.Товары.КоманднаяПанель;
	Если КоманднаяПанель <> Неопределено Тогда
		Параметры = Новый Структура;
		Параметры.Вставить("Имя", "ПапкаDDP");
		Параметры.Вставить("Заголовок", "DDP");
		Параметры.Вставить("Вид", ВидГруппыФормы.Подменю);
		Параметры.Вставить("Картинка", БиблиотекаКартинок.ОсновнаяВалюта);
		Параметры.Вставить("Подсказка", "Команды для работы с DDP");
		Параметры.Вставить("ТипЭлемента", Тип("ГруппаФормы"));
		Параметры.Вставить("Отображение", ОтображениеКнопки.КартинкаИТекст);
		ПапкаКомандDDP = ДобавитьЭлементВКоллекциюЭлементовФормы(ВнешнийОбъект, Элементы, Параметры, КоманднаяПанель);
				
		Параметры = Новый Структура;
		Параметры.Вставить("Имя", "ОтметитьВсеСтрокиDDP");
		Параметры.Вставить("Действие", "ОтметитьDDP");
		Параметры.Вставить("Заголовок", "Отметить все строки как DDP");
		ДобавитьКомандуВКоллекциюКомандФормы(ВнешнийОбъект, Команды, Параметры);
		
		Параметры = Новый Структура; 
		Параметры.Вставить("Имя", "ОтметитьВсеСтрокиDDP");
		Параметры.Вставить("ИмяКоманды", "ОтметитьВсеСтрокиDDP");
		Параметры.Вставить("Заголовок", "Отметить все строки как DDP");
		Параметры.Вставить("Вид", ВидКнопкиФормы.КнопкаКоманднойПанели);
		Параметры.Вставить("ТипЭлемента", Тип("КнопкаФормы"));
		ДобавитьЭлементВКоллекциюЭлементовФормы(ВнешнийОбъект, Элементы, Параметры, ПапкаКомандDDP);
		ПереместитьЭлементВКоллекциюЭлементовФормыБезПоиска(ВнешнийОбъект, Элементы, ПапкаКомандDDP, КоманднаяПанель, Элементы.Найти("ГруппаТоварыЦены"));
	КонецЕсли;

	
КонецПроцедуры // ПодготовитьЗаказПоставщику()


// Расчитывает DDP табличной части "Товары" в заказе поставщику 
//
// Параметры:
//  
//Возвращаемое значение:
//   Строка 		- Текст запроса для расчета DDP табличной части "Товары" в заказе поставщику
// 
Функция ПолучитьТекстЗапросаРасчетыDDPВЗаказеПоставщику()
	ТекстЗапроса =
	"ВЫБРАТЬ
	|	ЗаказПоставщикуТовары.НомерСтроки,
	|	ЗаказПоставщикуТовары.НоменклатураПоставщика,
	|	ЗаказПоставщикуТовары.Номенклатура,
	|	ЗаказПоставщикуТовары.КодСтроки,
	|	ЗаказПоставщикуТовары.Характеристика,
	|	ЗаказПоставщикуТовары.Упаковка,
	|	ЗаказПоставщикуТовары.КоличествоУпаковок,
	|	ЗаказПоставщикуТовары.Количество,
	|	ЗаказПоставщикуТовары.ДатаПоступления,
	|	ЗаказПоставщикуТовары.УсловиеЦеныПоставщика,
	|	ЗаказПоставщикуТовары.Цена,
	|	ЗаказПоставщикуТовары.Сумма,
	|	ЗаказПоставщикуТовары.ПроцентРучнойСкидки,
	|	ЗаказПоставщикуТовары.СуммаРучнойСкидки,
	|	ЗаказПоставщикуТовары.СтавкаНДС,
	|	ЗаказПоставщикуТовары.СуммаНДС,
	|	ЗаказПоставщикуТовары.СуммаСНДС,
	|	ЗаказПоставщикуТовары.Отменено,
	|	ЗаказПоставщикуТовары.СтатьяРасходов,
	|	ЗаказПоставщикуТовары.АналитикаРасходов,
	|	ЗаказПоставщикуТовары.ПричинаОтмены,
	|	ЗаказПоставщикуТовары.Склад,
	|	ЗаказПоставщикуТовары.Назначение,
	|	ЗаказПоставщикуТовары.DDP,
	|	ЗаказПоставщикуТовары.КурсоваяРазницаDDP,
	|	ЗаказПоставщикуТовары.СуммаСDDP
	|ПОМЕСТИТЬ КешТовары
	|ИЗ
	|	&Товары КАК ЗаказПоставщикуТовары
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	КешТовары.НомерСтроки,
	|	КешТовары.НоменклатураПоставщика,
	|	КешТовары.Номенклатура,
	|	КешТовары.Характеристика,
	|	КешТовары.Упаковка,
	|	КешТовары.КоличествоУпаковок,
	|	КешТовары.Количество,
	|	КешТовары.ДатаПоступления,
	|	КешТовары.УсловиеЦеныПоставщика,
	|	КешТовары.Цена,
	|	КешТовары.Сумма,
	|	КешТовары.ПроцентРучнойСкидки,
	|	КешТовары.СуммаРучнойСкидки,
	|	КешТовары.СтавкаНДС,
	|	КешТовары.СуммаНДС,
	|	КешТовары.СуммаСНДС,
	|	КешТовары.КодСтроки,
	|	КешТовары.Отменено,
	|	КешТовары.СтатьяРасходов,
	|	КешТовары.АналитикаРасходов,
	|	КешТовары.ПричинаОтмены,
	|	КешТовары.Склад,
	|	КешТовары.Назначение,
	|	КешТовары.DDP,
	|	КешТовары.КурсоваяРазницаDDP,
	|	КешТовары.СуммаСDDP
	|ПОМЕСТИТЬ КешОтменены
	|ИЗ
	|	КешТовары КАК КешТовары
	|ГДЕ
	|	КешТовары.Отменено = ИСТИНА
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ВЫБОР
	|		КОГДА СтавкиНДС.Ссылка = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС10)
	|				ИЛИ СтавкиНДС.Ссылка = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС10_110)
	|			ТОГДА 0.1
	|		КОГДА СтавкиНДС.Ссылка = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС18)
	|				ИЛИ СтавкиНДС.Ссылка = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС18_118)
	|			ТОГДА 0.18
	|		КОГДА СтавкиНДС.Ссылка = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС20)
	|				ИЛИ СтавкиНДС.Ссылка = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС20_120)
	|			ТОГДА 0.2
	|		ИНАЧЕ 0
	|	КОНЕЦ КАК Процент,
	|	СтавкиНДС.Ссылка КАК СтавкаНДС
	|ПОМЕСТИТЬ СтавкиНДС
	|ИЗ
	|	Перечисление.СтавкиНДС КАК СтавкиНДС
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	КешТовары.КодСтроки,
	|	ВЫБОР
	|		КОГДА &НалогообложениеНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПродажаОблагаетсяНДС)
	|				И НЕ &ЦенаВключаетНДС И КешТовары.КоличествоУпаковок<>0
	|			ТОГДА ВЫРАЗИТЬ((КешТовары.СуммаСDDP - КешТовары.СуммаСDDP * СтавкиНДС.Процент / (СтавкиНДС.Процент + 1)) / КешТовары.КоличествоУпаковок КАК ЧИСЛО(15, 2))
	|		КОГДА КешТовары.КоличествоУпаковок<>0 ТОГДА
	|		ВЫРАЗИТЬ(КешТовары.СуммаСDDP / КешТовары.КоличествоУпаковок КАК ЧИСЛО(15, 2))
	|		ИНАЧЕ 0
	|	КОНЕЦ КАК ЦенаБезDDP,
	|	КешТовары.НомерСтроки,
	|	КешТовары.Номенклатура,
	|	КешТовары.Количество,
	|	КешТовары.Цена,
	|	КешТовары.Сумма,
	|	КешТовары.СтавкаНДС,
	|	КешТовары.СуммаНДС,
	|	КешТовары.СуммаСНДС,
	|	КешТовары.DDP,
	|	КешТовары.КурсоваяРазницаDDP,
	|	КешТовары.СуммаСDDP,
	|	ВЫБОР
	|		КОГДА КешТовары.КодСтроки <> 0
	|					И КешТовары.Количество <> ЕСТЬNULL(ЗаказыПоставщикамОстатки.ЗаказаноОстаток, 0)
	|				ИЛИ НЕ КешТовары.DDP
	|					И КешТовары.СуммаСDDP = 0
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ КАК ЗапретИзменения,
	|	ВЫБОР
	|		КОГДА &НалогообложениеНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПродажаОблагаетсяНДС)
	|				И &ЦенаВключаетНДС
	|			ТОГДА ВЫРАЗИТЬ(КешТовары.СуммаСDDP КАК ЧИСЛО(15, 2))
	|		ИНАЧЕ ВЫРАЗИТЬ(КешТовары.СуммаСDDP - КешТовары.СуммаСDDP * СтавкиНДС.Процент / (СтавкиНДС.Процент + 1) КАК ЧИСЛО(15, 2))
	|	КОНЕЦ КАК СуммаБезDDP,
	|	КешТовары.КоличествоУпаковок,
	|	КешТовары.НоменклатураПоставщика,
	|	КешТовары.Характеристика,
	|	КешТовары.Упаковка,
	|	КешТовары.ДатаПоступления,
	|	КешТовары.УсловиеЦеныПоставщика,
	|	КешТовары.ПроцентРучнойСкидки,
	|	КешТовары.СуммаРучнойСкидки,
	|	КешТовары.Отменено,
	|	КешТовары.СтатьяРасходов,
	|	КешТовары.АналитикаРасходов,
	|	КешТовары.ПричинаОтмены,
	|	КешТовары.Склад,
	|	КешТовары.Назначение
	|ПОМЕСТИТЬ КешЗапретИзменения
	|ИЗ
	|	КешТовары КАК КешТовары
	|		ЛЕВОЕ СОЕДИНЕНИЕ СтавкиНДС КАК СтавкиНДС
	|		ПО КешТовары.СтавкаНДС = СтавкиНДС.СтавкаНДС
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.ЗаказыПоставщикам.Остатки(, ЗаказПоставщику = &Ссылка) КАК ЗаказыПоставщикамОстатки
	|		ПО КешТовары.КодСтроки = ЗаказыПоставщикамОстатки.КодСтроки
	|			И КешТовары.Номенклатура = ЗаказыПоставщикамОстатки.Номенклатура
	|ГДЕ
	|	КешТовары.Номенклатура <> &Номенклатура
	|	И НЕ КешТовары.Отменено
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	КешЗапретИзменения.КодСтроки,
	|	КешЗапретИзменения.ЦенаБезDDP,
	|	КешЗапретИзменения.НомерСтроки,
	|	КешЗапретИзменения.Номенклатура,
	|	КешЗапретИзменения.КоличествоУпаковок,
	|	КешЗапретИзменения.Количество,
	|	КешЗапретИзменения.Цена,
	|	КешЗапретИзменения.Сумма,
	|	КешЗапретИзменения.СтавкаНДС,
	|	КешЗапретИзменения.СуммаНДС,
	|	КешЗапретИзменения.СуммаСНДС,
	|	ВЫБОР
	|		КОГДА КешЗапретИзменения.СуммаСDDP = 0
	|			ТОГДА ЛОЖЬ
	|		ИНАЧЕ ИСТИНА
	|	КОНЕЦ КАК DDP,
	|	КешЗапретИзменения.КурсоваяРазницаDDP,
	|	КешЗапретИзменения.СуммаСDDP,
	|	КешЗапретИзменения.ЗапретИзменения,
	|	КешЗапретИзменения.СуммаБезDDP,
	|	КешЗапретИзменения.НоменклатураПоставщика,
	|	КешЗапретИзменения.Характеристика,
	|	КешЗапретИзменения.Упаковка,
	|	КешЗапретИзменения.ДатаПоступления,
	|	КешЗапретИзменения.УсловиеЦеныПоставщика,
	|	КешЗапретИзменения.ПроцентРучнойСкидки,
	|	КешЗапретИзменения.СуммаРучнойСкидки,
	|	КешЗапретИзменения.Отменено,
	|	КешЗапретИзменения.СтатьяРасходов,
	|	КешЗапретИзменения.АналитикаРасходов,
	|	КешЗапретИзменения.ПричинаОтмены,
	|	КешЗапретИзменения.Склад,
	|	КешЗапретИзменения.Назначение
	|ПОМЕСТИТЬ ТаблицаБезИзменений
	|ИЗ
	|	КешЗапретИзменения КАК КешЗапретИзменения
	|ГДЕ
	|	КешЗапретИзменения.ЗапретИзменения
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	КешРасчетЦеныБезDDP.КодСтроки,
	|	КешРасчетЦеныБезDDP.Номенклатура,
	|	КешРасчетЦеныБезDDP.Количество,
	|	КешРасчетЦеныБезDDP.Цена,
	|	КешРасчетЦеныБезDDP.Сумма,
	|	КешРасчетЦеныБезDDP.СтавкаНДС,
	|	КешРасчетЦеныБезDDP.СуммаНДС,
	|	КешРасчетЦеныБезDDP.СуммаСНДС,
	|	КешРасчетЦеныБезDDP.DDP,
	|	ВЫБОР
	|		КОГДА НЕ КешРасчетЦеныБезDDP.DDP
	|				И КешРасчетЦеныБезDDP.КурсоваяРазницаDDP <> 0
	|			ТОГДА 0
	|		ИНАЧЕ КешРасчетЦеныБезDDP.КурсоваяРазницаDDP
	|	КОНЕЦ КАК КурсоваяРазницаDDP,
	|	ВЫБОР
	|		КОГДА НЕ КешРасчетЦеныБезDDP.DDP
	|				И КешРасчетЦеныБезDDP.СуммаСDDP <> 0
	|			ТОГДА 0
	|		ИНАЧЕ КешРасчетЦеныБезDDP.СуммаСDDP
	|	КОНЕЦ КАК СуммаСDDP,
	|	КешРасчетЦеныБезDDP.ЦенаБезDDP,
	|	КешРасчетЦеныБезDDP.СуммаБезDDP,
	|	ВЫБОР
	|		КОГДА &ЦенаВключаетНДС
	|			ТОГДА КешРасчетЦеныБезDDP.СуммаБезDDP * СтавкиНДС.Процент / (СтавкиНДС.Процент + 1)
	|		ИНАЧЕ КешРасчетЦеныБезDDP.СуммаБезDDP * СтавкиНДС.Процент
	|	КОНЕЦ КАК СуммаНДСБезDDP,
	|	ВЫБОР
	|		КОГДА &ЦенаВключаетНДС
	|			ТОГДА КешРасчетЦеныБезDDP.СуммаБезDDP
	|		ИНАЧЕ КешРасчетЦеныБезDDP.СуммаБезDDP + КешРасчетЦеныБезDDP.СуммаБезDDP * СтавкиНДС.Процент
	|	КОНЕЦ КАК СуммаСНДСБезDDP,
	|	КешРасчетЦеныБезDDP.КоличествоУпаковок,
	|	КешРасчетЦеныБезDDP.НомерСтроки,
	|	КешРасчетЦеныБезDDP.ЗапретИзменения,
	|	КешРасчетЦеныБезDDP.НоменклатураПоставщика,
	|	КешРасчетЦеныБезDDP.Характеристика,
	|	КешРасчетЦеныБезDDP.Упаковка,
	|	КешРасчетЦеныБезDDP.ДатаПоступления,
	|	КешРасчетЦеныБезDDP.УсловиеЦеныПоставщика,
	|	КешРасчетЦеныБезDDP.ПроцентРучнойСкидки,
	|	КешРасчетЦеныБезDDP.СуммаРучнойСкидки,
	|	КешРасчетЦеныБезDDP.Отменено,
	|	КешРасчетЦеныБезDDP.СтатьяРасходов,
	|	КешРасчетЦеныБезDDP.АналитикаРасходов,
	|	КешРасчетЦеныБезDDP.ПричинаОтмены,
	|	КешРасчетЦеныБезDDP.Склад,
	|	КешРасчетЦеныБезDDP.Назначение
	|ПОМЕСТИТЬ КешДляРасчета
	|ИЗ
	|	КешЗапретИзменения КАК КешРасчетЦеныБезDDP
	|		ЛЕВОЕ СОЕДИНЕНИЕ СтавкиНДС КАК СтавкиНДС
	|		ПО КешРасчетЦеныБезDDP.СтавкаНДС = СтавкиНДС.СтавкаНДС
	|ГДЕ
	|	НЕ КешРасчетЦеныБезDDP.ЗапретИзменения
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	КешДляРасчета.КодСтроки,
	|	КешДляРасчета.Номенклатура,
	|	КешДляРасчета.Количество,
	|	ВЫБОР
	|		КОГДА КешДляРасчета.ЦенаБезDDP = 0
	|			ТОГДА КешДляРасчета.Цена
	|		ИНАЧЕ КешДляРасчета.ЦенаБезDDP
	|	КОНЕЦ КАК Цена,
	|	ВЫБОР
	|		КОГДА КешДляРасчета.СуммаБезDDP = 0
	|			ТОГДА КешДляРасчета.Сумма
	|		ИНАЧЕ КешДляРасчета.СуммаБезDDP
	|	КОНЕЦ КАК Сумма,
	|	КешДляРасчета.СтавкаНДС,
	|	ВЫБОР
	|		КОГДА КешДляРасчета.СуммаНДСБезDDP = 0
	|			ТОГДА КешДляРасчета.СуммаНДС
	|		ИНАЧЕ КешДляРасчета.СуммаНДСБезDDP
	|	КОНЕЦ КАК СуммаНДС,
	|	ВЫБОР
	|		КОГДА КешДляРасчета.СуммаСНДСБезDDP = 0
	|			ТОГДА КешДляРасчета.СуммаСНДС
	|		ИНАЧЕ КешДляРасчета.СуммаСНДСБезDDP
	|	КОНЕЦ КАК СуммаСНДС,
	|	КешДляРасчета.DDP,
	|	0 КАК КурсоваяРазницаDDP,
	|	0 КАК СуммаСDDP,
	|	КешДляРасчета.КоличествоУпаковок,
	|	КешДляРасчета.ЦенаБезDDP,
	|	КешДляРасчета.СуммаБезDDP,
	|	КешДляРасчета.СуммаНДСБезDDP,
	|	КешДляРасчета.СуммаСНДСБезDDP,
	|	КешДляРасчета.НомерСтроки,
	|	КешДляРасчета.ЗапретИзменения,
	|	КешДляРасчета.НоменклатураПоставщика,
	|	КешДляРасчета.Характеристика,
	|	КешДляРасчета.Упаковка,
	|	КешДляРасчета.ДатаПоступления,
	|	КешДляРасчета.УсловиеЦеныПоставщика,
	|	КешДляРасчета.ПроцентРучнойСкидки,
	|	КешДляРасчета.СуммаРучнойСкидки,
	|	КешДляРасчета.Отменено,
	|	КешДляРасчета.СтатьяРасходов,
	|	КешДляРасчета.АналитикаРасходов,
	|	КешДляРасчета.ПричинаОтмены,
	|	КешДляРасчета.Склад,
	|	КешДляРасчета.Назначение
	|ПОМЕСТИТЬ КешОтменыDDP
	|ИЗ
	|	КешДляРасчета КАК КешДляРасчета
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	КешОтменыDDP.КодСтроки,
	|	КешОтменыDDP.Номенклатура,
	|	КешОтменыDDP.КоличествоУпаковок,
	|	КешОтменыDDP.Количество,
	|	ВЫРАЗИТЬ(КешОтменыDDP.Цена * &КурсDDP / &КурсУпр КАК ЧИСЛО(15, 2)) КАК Цена,
	|	ВЫРАЗИТЬ(КешОтменыDDP.Цена * &КурсDDP * КешОтменыDDP.КоличествоУпаковок / &КурсУпр КАК ЧИСЛО(15, 2)) КАК Сумма,
	|	КешОтменыDDP.СтавкаНДС,
	|	0 КАК СуммаНДС,
	|	0 КАК СуммаСНДС,
	|	КешОтменыDDP.DDP,
	|	КешОтменыDDP.КурсоваяРазницаDDP,
	|	КешОтменыDDP.СуммаСНДС КАК СуммаСDDP,
	|	КешОтменыDDP.ЦенаБезDDP,
	|	КешОтменыDDP.СуммаБезDDP,
	|	КешОтменыDDP.СуммаНДСБезDDP,
	|	КешОтменыDDP.СуммаСНДСБезDDP,
	|	КешОтменыDDP.НомерСтроки,
	|	КешОтменыDDP.ЗапретИзменения,
	|	КешОтменыDDP.НоменклатураПоставщика,
	|	КешОтменыDDP.Характеристика,
	|	КешОтменыDDP.Упаковка,
	|	КешОтменыDDP.ДатаПоступления,
	|	КешОтменыDDP.УсловиеЦеныПоставщика,
	|	КешОтменыDDP.ПроцентРучнойСкидки,
	|	КешОтменыDDP.СуммаРучнойСкидки,
	|	КешОтменыDDP.Отменено,
	|	КешОтменыDDP.СтатьяРасходов,
	|	КешОтменыDDP.АналитикаРасходов,
	|	КешОтменыDDP.ПричинаОтмены,
	|	КешОтменыDDP.Склад,
	|	КешОтменыDDP.Назначение
	|ПОМЕСТИТЬ КешРасчетаDDP
	|ИЗ
	|	КешОтменыDDP КАК КешОтменыDDP
	|		ЛЕВОЕ СОЕДИНЕНИЕ СтавкиНДС КАК СтавкиНДС
	|		ПО КешОтменыDDP.СтавкаНДС = СтавкиНДС.СтавкаНДС
	|ГДЕ
	|	КешОтменыDDP.DDP
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	КешРасчетаDDP.КодСтроки,
	|	КешРасчетаDDP.Номенклатура,
	|	КешРасчетаDDP.КоличествоУпаковок,
	|	КешРасчетаDDP.Количество,
	|	КешРасчетаDDP.Цена,
	|	КешРасчетаDDP.Сумма,
	|	КешРасчетаDDP.СтавкаНДС,
	|	ВЫБОР
	|		КОГДА &ЦенаВключаетНДС
	|			ТОГДА КешРасчетаDDP.Сумма * СтавкиНДС.Процент / (СтавкиНДС.Процент + 1)
	|		ИНАЧЕ КешРасчетаDDP.Сумма * СтавкиНДС.Процент
	|	КОНЕЦ КАК СуммаНДС,
	|	ВЫБОР
	|		КОГДА &ЦенаВключаетНДС
	|			ТОГДА КешРасчетаDDP.Сумма
	|		ИНАЧЕ КешРасчетаDDP.Сумма + КешРасчетаDDP.Сумма * СтавкиНДС.Процент
	|	КОНЕЦ КАК СуммаCНДС,
	|	КешРасчетаDDP.DDP,
	|	ВЫБОР
	|		КОГДА &ЦенаВключаетНДС
	|			ТОГДА КешРасчетаDDP.СуммаСDDP - КешРасчетаDDP.Сумма
	|		ИНАЧЕ КешРасчетаDDP.СуммаСDDP - (КешРасчетаDDP.Сумма + КешРасчетаDDP.Сумма * СтавкиНДС.Процент)
	|	КОНЕЦ КАК КурсоваяРазницаDDP,
	|	КешРасчетаDDP.СуммаСDDP,
	|	КешРасчетаDDP.ЦенаБезDDP,
	|	КешРасчетаDDP.СуммаБезDDP,
	|	КешРасчетаDDP.СуммаНДСБезDDP,
	|	КешРасчетаDDP.СуммаСНДСБезDDP,
	|	КешРасчетаDDP.НомерСтроки,
	|	КешРасчетаDDP.ЗапретИзменения,
	|	КешРасчетаDDP.НоменклатураПоставщика,
	|	КешРасчетаDDP.Характеристика,
	|	КешРасчетаDDP.Упаковка,
	|	КешРасчетаDDP.ДатаПоступления,
	|	КешРасчетаDDP.УсловиеЦеныПоставщика,
	|	КешРасчетаDDP.ПроцентРучнойСкидки,
	|	КешРасчетаDDP.СуммаРучнойСкидки,
	|	КешРасчетаDDP.Отменено,
	|	КешРасчетаDDP.СтатьяРасходов,
	|	КешРасчетаDDP.АналитикаРасходов,
	|	КешРасчетаDDP.ПричинаОтмены,
	|	КешРасчетаDDP.Склад,
	|	КешРасчетаDDP.Назначение
	|ПОМЕСТИТЬ КешDDP
	|ИЗ
	|	КешРасчетаDDP КАК КешРасчетаDDP
	|		ЛЕВОЕ СОЕДИНЕНИЕ СтавкиНДС КАК СтавкиНДС
	|		ПО КешРасчетаDDP.СтавкаНДС = СтавкиНДС.СтавкаНДС
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	КешОтменены.НомерСтроки КАК НомерСтроки,
	|	КешОтменены.Номенклатура,
	|	КешОтменены.КоличествоУпаковок,
	|	КешОтменены.Количество,
	|	КешОтменены.Цена,
	|	КешОтменены.Сумма,
	|	КешОтменены.СтавкаНДС,
	|	КешОтменены.СуммаНДС,
	|	КешОтменены.СуммаСНДС,
	|	КешОтменены.КодСтроки,
	|	КешОтменены.DDP,
	|	КешОтменены.КурсоваяРазницаDDP,
	|	КешОтменены.СуммаСDDP,
	|	КешОтменены.НоменклатураПоставщика,
	|	КешОтменены.Характеристика,
	|	КешОтменены.Упаковка,
	|	КешОтменены.ДатаПоступления,
	|	КешОтменены.УсловиеЦеныПоставщика,
	|	КешОтменены.ПроцентРучнойСкидки,
	|	КешОтменены.СуммаРучнойСкидки,
	|	КешОтменены.Отменено,
	|	КешОтменены.СтатьяРасходов,
	|	КешОтменены.АналитикаРасходов,
	|	КешОтменены.ПричинаОтмены,
	|	КешОтменены.Склад,
	|	КешОтменены.Назначение
	|ИЗ
	|	КешОтменены КАК КешОтменены
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ТаблицаБезИзменений.НомерСтроки,
	|	ТаблицаБезИзменений.Номенклатура,
	|	ТаблицаБезИзменений.КоличествоУпаковок,
	|	ТаблицаБезИзменений.Количество,
	|	ТаблицаБезИзменений.Цена,
	|	ТаблицаБезИзменений.Сумма,
	|	ТаблицаБезИзменений.СтавкаНДС,
	|	ТаблицаБезИзменений.СуммаНДС,
	|	ТаблицаБезИзменений.СуммаСНДС,
	|	ТаблицаБезИзменений.КодСтроки,
	|	ТаблицаБезИзменений.DDP,
	|	ТаблицаБезИзменений.КурсоваяРазницаDDP,
	|	ТаблицаБезИзменений.СуммаСDDP,
	|	ТаблицаБезИзменений.НоменклатураПоставщика,
	|	ТаблицаБезИзменений.Характеристика,
	|	ТаблицаБезИзменений.Упаковка,
	|	ТаблицаБезИзменений.ДатаПоступления,
	|	ТаблицаБезИзменений.УсловиеЦеныПоставщика,
	|	ТаблицаБезИзменений.ПроцентРучнойСкидки,
	|	ТаблицаБезИзменений.СуммаРучнойСкидки,
	|	ТаблицаБезИзменений.Отменено,
	|	ТаблицаБезИзменений.СтатьяРасходов,
	|	ТаблицаБезИзменений.АналитикаРасходов,
	|	ТаблицаБезИзменений.ПричинаОтмены,
	|	ТаблицаБезИзменений.Склад,
	|	ТаблицаБезИзменений.Назначение
	|ИЗ
	|	ТаблицаБезИзменений КАК ТаблицаБезИзменений
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	КешОтменыDDP.НомерСтроки,
	|	КешОтменыDDP.Номенклатура,
	|	КешОтменыDDP.КоличествоУпаковок,
	|	КешОтменыDDP.Количество,
	|	КешОтменыDDP.Цена,
	|	КешОтменыDDP.Сумма,
	|	КешОтменыDDP.СтавкаНДС,
	|	КешОтменыDDP.СуммаНДС,
	|	КешОтменыDDP.СуммаСНДС,
	|	КешОтменыDDP.КодСтроки,
	|	КешОтменыDDP.DDP,
	|	КешОтменыDDP.КурсоваяРазницаDDP,
	|	КешОтменыDDP.СуммаСDDP,
	|	КешОтменыDDP.НоменклатураПоставщика,
	|	КешОтменыDDP.Характеристика,
	|	КешОтменыDDP.Упаковка,
	|	КешОтменыDDP.ДатаПоступления,
	|	КешОтменыDDP.УсловиеЦеныПоставщика,
	|	КешОтменыDDP.ПроцентРучнойСкидки,
	|	КешОтменыDDP.СуммаРучнойСкидки,
	|	КешОтменыDDP.Отменено,
	|	КешОтменыDDP.СтатьяРасходов,
	|	КешОтменыDDP.АналитикаРасходов,
	|	КешОтменыDDP.ПричинаОтмены,
	|	КешОтменыDDP.Склад,
	|	КешОтменыDDP.Назначение
	|ИЗ
	|	КешОтменыDDP КАК КешОтменыDDP
	|ГДЕ
	|	НЕ КешОтменыDDP.DDP
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	КешDDP.НомерСтроки,
	|	КешDDP.Номенклатура,
	|	КешDDP.КоличествоУпаковок,
	|	КешDDP.Количество,
	|	КешDDP.Цена,
	|	КешDDP.Сумма,
	|	КешDDP.СтавкаНДС,
	|	КешDDP.СуммаНДС,
	|	КешDDP.СуммаCНДС,
	|	КешDDP.КодСтроки,
	|	КешDDP.DDP,
	|	КешDDP.КурсоваяРазницаDDP,
	|	КешDDP.СуммаСDDP,
	|	КешDDP.НоменклатураПоставщика,
	|	КешDDP.Характеристика,
	|	КешDDP.Упаковка,
	|	КешDDP.ДатаПоступления,
	|	КешDDP.УсловиеЦеныПоставщика,
	|	КешDDP.ПроцентРучнойСкидки,
	|	КешDDP.СуммаРучнойСкидки,
	|	КешDDP.Отменено,
	|	КешDDP.СтатьяРасходов,
	|	КешDDP.АналитикаРасходов,
	|	КешDDP.ПричинаОтмены,
	|	КешDDP.Склад,
	|	КешDDP.Назначение
	|ИЗ
	|	КешDDP КАК КешDDP
	|
	|УПОРЯДОЧИТЬ ПО
	|	НомерСтроки";
	Возврат ТекстЗапроса;
КонецФункции

// Расчитывает DDP табличной части "Товары" в поступлении товаров и услуг 
//
// Параметры:
//  
//Возвращаемое значение:
//   Строка 		- Текст запроса для расчета DDP табличной части "Товары" в заказе поставщику
// 
Функция ПолучитьТекстЗапросаРасчетыDDPВПТиУ()
	ТекстЗапроса =
	"ВЫБРАТЬ
	|	ПоступлениеТоваровУслугТовары.НомерСтроки,
	|	ПоступлениеТоваровУслугТовары.Номенклатура,
	|	ПоступлениеТоваровУслугТовары.НоменклатураПоставщика,
	|	ПоступлениеТоваровУслугТовары.Характеристика,
	|	ПоступлениеТоваровУслугТовары.Упаковка,
	|	ПоступлениеТоваровУслугТовары.КоличествоУпаковок,
	|	ПоступлениеТоваровУслугТовары.Количество,
	|	ПоступлениеТоваровУслугТовары.Цена,
	|	ПоступлениеТоваровУслугТовары.УсловиеЦеныПоставщика,
	|	ПоступлениеТоваровУслугТовары.ПроцентРучнойСкидки,
	|	ПоступлениеТоваровУслугТовары.СуммаРучнойСкидки,
	|	ПоступлениеТоваровУслугТовары.Сумма,
	|	ПоступлениеТоваровУслугТовары.СтавкаНДС,
	|	ПоступлениеТоваровУслугТовары.СуммаНДС,
	|	ПоступлениеТоваровУслугТовары.СуммаСНДС,
	|	ПоступлениеТоваровУслугТовары.СтатьяРасходов,
	|	ПоступлениеТоваровУслугТовары.АналитикаРасходов,
	|	ПоступлениеТоваровУслугТовары.КлючСвязиСерийныхНомеров,
	|	ПоступлениеТоваровУслугТовары.КодСтроки,
	|	ПоступлениеТоваровУслугТовары.НомерГТД,
	|	ПоступлениеТоваровУслугТовары.Склад,
	|	ПоступлениеТоваровУслугТовары.ЗаказПоставщику,
	|	ПоступлениеТоваровУслугТовары.НомерСтрокиДокументаПоставщика,
	|	ПоступлениеТоваровУслугТовары.Сертификат,
	|	ПоступлениеТоваровУслугТовары.НомерПаспорта,
	|	ПоступлениеТоваровУслугТовары.СтатусУказанияСерий,
	|	ПоступлениеТоваровУслугТовары.Сделка,
	|	ПоступлениеТоваровУслугТовары.СуммаВзаиморасчетов,
	|	ПоступлениеТоваровУслугТовары.СуммаНДСВзаиморасчетов,
	|	ПоступлениеТоваровУслугТовары.ВидЗапасов,
	|	ПоступлениеТоваровУслугТовары.АналитикаУчетаПартий,
	|	ПоступлениеТоваровУслугТовары.Назначение,
	|	ПоступлениеТоваровУслугТовары.DDP,
	|	ПоступлениеТоваровУслугТовары.КурсоваяРазницаDDP,
	|	ПоступлениеТоваровУслугТовары.СуммаСDDP
	|ПОМЕСТИТЬ КешТовары
	|ИЗ
	|	&Товары КАК ПоступлениеТоваровУслугТовары
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ВЫБОР
	|		КОГДА СтавкиНДС.Ссылка = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС10)
	|				ИЛИ СтавкиНДС.Ссылка = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС10_110)
	|			ТОГДА 0.1
	|		КОГДА СтавкиНДС.Ссылка = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС18)
	|				ИЛИ СтавкиНДС.Ссылка = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС18_118)
	|			ТОГДА 0.18
	|		КОГДА СтавкиНДС.Ссылка = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС20)
	|				ИЛИ СтавкиНДС.Ссылка = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС20_120)
	|			ТОГДА 0.2
	|		ИНАЧЕ 0
	|	КОНЕЦ КАК Процент,
	|	СтавкиНДС.Ссылка КАК СтавкаНДС
	|ПОМЕСТИТЬ СтавкиНДС
	|ИЗ
	|	Перечисление.СтавкиНДС КАК СтавкиНДС
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	КешТовары.КодСтроки,
	|	ВЫБОР
	|		КОГДА &НалогообложениеНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПродажаОблагаетсяНДС)
	|				И НЕ &ЦенаВключаетНДС
	|			ТОГДА ВЫРАЗИТЬ((КешТовары.СуммаСDDP - КешТовары.СуммаСDDP * СтавкиНДС.Процент / (СтавкиНДС.Процент + 1)) / КешТовары.КоличествоУпаковок КАК ЧИСЛО(15, 2))
	|		КОГДА КешТовары.КоличествоУпаковок<>0 ТОГДА
	|	          ВЫРАЗИТЬ(КешТовары.СуммаСDDP / КешТовары.КоличествоУпаковок КАК ЧИСЛО(15, 2))
	|		ИНАЧЕ 0
	|	КОНЕЦ КАК ЦенаБезDDP,
	|	КешТовары.НомерСтроки,
	|	КешТовары.Номенклатура,
	|	КешТовары.Количество,
	|	КешТовары.Цена,
	|	КешТовары.Сумма,
	|	КешТовары.СтавкаНДС,
	|	КешТовары.СуммаНДС,
	|	КешТовары.СуммаСНДС,
	|	КешТовары.DDP,
	|	КешТовары.КурсоваяРазницаDDP,
	|	КешТовары.СуммаСDDP,
	|	ВЫБОР
	|		КОГДА НЕ КешТовары.DDP
	|				И КешТовары.СуммаСDDP = 0
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ КАК ЗапретИзменения,
	|	ВЫБОР
	|		КОГДА &НалогообложениеНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПродажаОблагаетсяНДС)
	|				И &ЦенаВключаетНДС
	|			ТОГДА ВЫРАЗИТЬ(КешТовары.СуммаСDDP КАК ЧИСЛО(15, 2))
	|		ИНАЧЕ ВЫРАЗИТЬ(КешТовары.СуммаСDDP - КешТовары.СуммаСDDP * СтавкиНДС.Процент / (СтавкиНДС.Процент + 1) КАК ЧИСЛО(15, 2))
	|	КОНЕЦ КАК СуммаБезDDP,
	|	КешТовары.КоличествоУпаковок,
	|	КешТовары.НоменклатураПоставщика,
	|	КешТовары.Характеристика,
	|	КешТовары.Упаковка,
	|	КешТовары.УсловиеЦеныПоставщика,
	|	КешТовары.ПроцентРучнойСкидки,
	|	КешТовары.СуммаРучнойСкидки,
	|	КешТовары.СтатьяРасходов,
	|	КешТовары.АналитикаРасходов,
	|	КешТовары.Склад,
	|	КешТовары.Назначение,
	|	КешТовары.КлючСвязиСерийныхНомеров,
	|	КешТовары.НомерГТД,
	|	КешТовары.ЗаказПоставщику,
	|	КешТовары.НомерСтрокиДокументаПоставщика,
	|	КешТовары.Сертификат,
	|	КешТовары.НомерПаспорта,
	|	КешТовары.СтатусУказанияСерий,
	|	КешТовары.Сделка,
	|	КешТовары.СуммаВзаиморасчетов,
	|	КешТовары.СуммаНДСВзаиморасчетов,
	|	КешТовары.ВидЗапасов,
	|	КешТовары.АналитикаУчетаПартий
	|ПОМЕСТИТЬ КешЗапретИзменения
	|ИЗ
	|	КешТовары КАК КешТовары
	|		ЛЕВОЕ СОЕДИНЕНИЕ СтавкиНДС КАК СтавкиНДС
	|		ПО КешТовары.СтавкаНДС = СтавкиНДС.СтавкаНДС
	|ГДЕ
	|	КешТовары.Номенклатура <> &Номенклатура
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	КешЗапретИзменения.КодСтроки,
	|	КешЗапретИзменения.ЦенаБезDDP,
	|	КешЗапретИзменения.НомерСтроки,
	|	КешЗапретИзменения.Номенклатура,
	|	КешЗапретИзменения.КоличествоУпаковок,
	|	КешЗапретИзменения.Количество,
	|	КешЗапретИзменения.Цена,
	|	КешЗапретИзменения.Сумма,
	|	КешЗапретИзменения.СтавкаНДС,
	|	КешЗапретИзменения.СуммаНДС,
	|	КешЗапретИзменения.СуммаСНДС,
	|	ВЫБОР
	|		КОГДА КешЗапретИзменения.СуммаСDDP = 0
	|			ТОГДА ЛОЖЬ
	|		ИНАЧЕ ИСТИНА
	|	КОНЕЦ КАК DDP,
	|	КешЗапретИзменения.КурсоваяРазницаDDP,
	|	КешЗапретИзменения.СуммаСDDP,
	|	КешЗапретИзменения.ЗапретИзменения,
	|	КешЗапретИзменения.СуммаБезDDP,
	|	КешЗапретИзменения.НоменклатураПоставщика,
	|	КешЗапретИзменения.Характеристика,
	|	КешЗапретИзменения.Упаковка,
	|	КешЗапретИзменения.УсловиеЦеныПоставщика,
	|	КешЗапретИзменения.ПроцентРучнойСкидки,
	|	КешЗапретИзменения.СуммаРучнойСкидки,
	|	КешЗапретИзменения.СтатьяРасходов,
	|	КешЗапретИзменения.АналитикаРасходов,
	|	КешЗапретИзменения.Склад,
	|	КешЗапретИзменения.Назначение,
	|	КешЗапретИзменения.КлючСвязиСерийныхНомеров,
	|	КешЗапретИзменения.НомерГТД,
	|	КешЗапретИзменения.ЗаказПоставщику,
	|	КешЗапретИзменения.НомерСтрокиДокументаПоставщика,
	|	КешЗапретИзменения.Сертификат,
	|	КешЗапретИзменения.НомерПаспорта,
	|	КешЗапретИзменения.СтатусУказанияСерий,
	|	КешЗапретИзменения.Сделка,
	|	КешЗапретИзменения.СуммаВзаиморасчетов,
	|	КешЗапретИзменения.СуммаНДСВзаиморасчетов,
	|	КешЗапретИзменения.ВидЗапасов,
	|	КешЗапретИзменения.АналитикаУчетаПартий
	|ПОМЕСТИТЬ ТаблицаБезИзменений
	|ИЗ
	|	КешЗапретИзменения КАК КешЗапретИзменения
	|ГДЕ
	|	КешЗапретИзменения.ЗапретИзменения
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	КешРасчетЦеныБезDDP.КодСтроки,
	|	КешРасчетЦеныБезDDP.Номенклатура,
	|	КешРасчетЦеныБезDDP.Количество,
	|	КешРасчетЦеныБезDDP.Цена,
	|	КешРасчетЦеныБезDDP.Сумма,
	|	КешРасчетЦеныБезDDP.СтавкаНДС,
	|	КешРасчетЦеныБезDDP.СуммаНДС,
	|	КешРасчетЦеныБезDDP.СуммаСНДС,
	|	КешРасчетЦеныБезDDP.DDP,
	|	ВЫБОР
	|		КОГДА НЕ КешРасчетЦеныБезDDP.DDP
	|				И КешРасчетЦеныБезDDP.КурсоваяРазницаDDP <> 0
	|			ТОГДА 0
	|		ИНАЧЕ КешРасчетЦеныБезDDP.КурсоваяРазницаDDP
	|	КОНЕЦ КАК КурсоваяРазницаDDP,
	|	ВЫБОР
	|		КОГДА НЕ КешРасчетЦеныБезDDP.DDP
	|				И КешРасчетЦеныБезDDP.СуммаСDDP <> 0
	|			ТОГДА 0
	|		ИНАЧЕ КешРасчетЦеныБезDDP.СуммаСDDP
	|	КОНЕЦ КАК СуммаСDDP,
	|	КешРасчетЦеныБезDDP.ЦенаБезDDP,
	|	КешРасчетЦеныБезDDP.СуммаБезDDP,
	|	ВЫБОР
	|		КОГДА &ЦенаВключаетНДС
	|			ТОГДА КешРасчетЦеныБезDDP.СуммаБезDDP * СтавкиНДС.Процент / (СтавкиНДС.Процент + 1)
	|		ИНАЧЕ КешРасчетЦеныБезDDP.СуммаБезDDP * СтавкиНДС.Процент
	|	КОНЕЦ КАК СуммаНДСБезDDP,
	|	ВЫБОР
	|		КОГДА &ЦенаВключаетНДС
	|			ТОГДА КешРасчетЦеныБезDDP.СуммаБезDDP
	|		ИНАЧЕ КешРасчетЦеныБезDDP.СуммаБезDDP + КешРасчетЦеныБезDDP.СуммаБезDDP * СтавкиНДС.Процент
	|	КОНЕЦ КАК СуммаСНДСБезDDP,
	|	КешРасчетЦеныБезDDP.КоличествоУпаковок,
	|	КешРасчетЦеныБезDDP.НомерСтроки,
	|	КешРасчетЦеныБезDDP.ЗапретИзменения,
	|	КешРасчетЦеныБезDDP.НоменклатураПоставщика,
	|	КешРасчетЦеныБезDDP.Характеристика,
	|	КешРасчетЦеныБезDDP.Упаковка,
	|	КешРасчетЦеныБезDDP.УсловиеЦеныПоставщика,
	|	КешРасчетЦеныБезDDP.ПроцентРучнойСкидки,
	|	КешРасчетЦеныБезDDP.СуммаРучнойСкидки,
	|	КешРасчетЦеныБезDDP.СтатьяРасходов,
	|	КешРасчетЦеныБезDDP.АналитикаРасходов,
	|	КешРасчетЦеныБезDDP.Склад,
	|	КешРасчетЦеныБезDDP.Назначение,
	|	КешРасчетЦеныБезDDP.КлючСвязиСерийныхНомеров,
	|	КешРасчетЦеныБезDDP.НомерГТД,
	|	КешРасчетЦеныБезDDP.ЗаказПоставщику,
	|	КешРасчетЦеныБезDDP.НомерСтрокиДокументаПоставщика,
	|	КешРасчетЦеныБезDDP.Сертификат,
	|	КешРасчетЦеныБезDDP.НомерПаспорта,
	|	КешРасчетЦеныБезDDP.СтатусУказанияСерий,
	|	КешРасчетЦеныБезDDP.Сделка,
	|	КешРасчетЦеныБезDDP.СуммаВзаиморасчетов,
	|	КешРасчетЦеныБезDDP.СуммаНДСВзаиморасчетов,
	|	КешРасчетЦеныБезDDP.ВидЗапасов,
	|	КешРасчетЦеныБезDDP.АналитикаУчетаПартий
	|ПОМЕСТИТЬ КешДляРасчета
	|ИЗ
	|	КешЗапретИзменения КАК КешРасчетЦеныБезDDP
	|		ЛЕВОЕ СОЕДИНЕНИЕ СтавкиНДС КАК СтавкиНДС
	|		ПО КешРасчетЦеныБезDDP.СтавкаНДС = СтавкиНДС.СтавкаНДС
	|ГДЕ
	|	НЕ КешРасчетЦеныБезDDP.ЗапретИзменения
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	КешДляРасчета.КодСтроки,
	|	КешДляРасчета.Номенклатура,
	|	КешДляРасчета.Количество,
	|	ВЫБОР
	|		КОГДА КешДляРасчета.ЦенаБезDDP = 0
	|			ТОГДА КешДляРасчета.Цена
	|		ИНАЧЕ КешДляРасчета.ЦенаБезDDP
	|	КОНЕЦ КАК Цена,
	|	ВЫБОР
	|		КОГДА КешДляРасчета.СуммаБезDDP = 0
	|			ТОГДА КешДляРасчета.Сумма
	|		ИНАЧЕ КешДляРасчета.СуммаБезDDP
	|	КОНЕЦ КАК Сумма,
	|	КешДляРасчета.СтавкаНДС,
	|	ВЫБОР
	|		КОГДА КешДляРасчета.СуммаНДСБезDDP = 0
	|			ТОГДА КешДляРасчета.СуммаНДС
	|		ИНАЧЕ КешДляРасчета.СуммаНДСБезDDP
	|	КОНЕЦ КАК СуммаНДС,
	|	ВЫБОР
	|		КОГДА КешДляРасчета.СуммаСНДСБезDDP = 0
	|			ТОГДА КешДляРасчета.СуммаСНДС
	|		ИНАЧЕ КешДляРасчета.СуммаСНДСБезDDP
	|	КОНЕЦ КАК СуммаСНДС,
	|	КешДляРасчета.DDP,
	|	0 КАК КурсоваяРазницаDDP,
	|	0 КАК СуммаСDDP,
	|	КешДляРасчета.КоличествоУпаковок,
	|	КешДляРасчета.ЦенаБезDDP,
	|	КешДляРасчета.СуммаБезDDP,
	|	КешДляРасчета.СуммаНДСБезDDP,
	|	КешДляРасчета.СуммаСНДСБезDDP,
	|	КешДляРасчета.НомерСтроки,
	|	КешДляРасчета.ЗапретИзменения,
	|	КешДляРасчета.НоменклатураПоставщика,
	|	КешДляРасчета.Характеристика,
	|	КешДляРасчета.Упаковка,
	|	КешДляРасчета.УсловиеЦеныПоставщика,
	|	КешДляРасчета.ПроцентРучнойСкидки,
	|	КешДляРасчета.СуммаРучнойСкидки,
	|	КешДляРасчета.СтатьяРасходов,
	|	КешДляРасчета.АналитикаРасходов,
	|	КешДляРасчета.Склад,
	|	КешДляРасчета.Назначение,
	|	КешДляРасчета.КлючСвязиСерийныхНомеров,
	|	КешДляРасчета.НомерГТД,
	|	КешДляРасчета.ЗаказПоставщику,
	|	КешДляРасчета.НомерСтрокиДокументаПоставщика,
	|	КешДляРасчета.Сертификат,
	|	КешДляРасчета.НомерПаспорта,
	|	КешДляРасчета.СтатусУказанияСерий,
	|	КешДляРасчета.Сделка,
	|	КешДляРасчета.СуммаВзаиморасчетов,
	|	КешДляРасчета.СуммаНДСВзаиморасчетов,
	|	КешДляРасчета.ВидЗапасов,
	|	КешДляРасчета.АналитикаУчетаПартий
	|ПОМЕСТИТЬ КешОтменыDDP
	|ИЗ
	|	КешДляРасчета КАК КешДляРасчета
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	КешОтменыDDP.КодСтроки,
	|	КешОтменыDDP.Номенклатура,
	|	КешОтменыDDP.КоличествоУпаковок,
	|	КешОтменыDDP.Количество,
	|	ВЫРАЗИТЬ(КешОтменыDDP.Цена * &КурсDDP / &КурсУпр КАК ЧИСЛО(15, 2)) КАК Цена,
	|	ВЫРАЗИТЬ(КешОтменыDDP.Цена * &КурсDDP * КешОтменыDDP.КоличествоУпаковок / &КурсУпр КАК ЧИСЛО(15, 2)) КАК Сумма,
	|	КешОтменыDDP.СтавкаНДС,
	|	0 КАК СуммаНДС,
	|	0 КАК СуммаСНДС,
	|	КешОтменыDDP.DDP,
	|	КешОтменыDDP.КурсоваяРазницаDDP,
	|	КешОтменыDDP.СуммаСНДС КАК СуммаСDDP,
	|	КешОтменыDDP.ЦенаБезDDP,
	|	КешОтменыDDP.СуммаБезDDP,
	|	КешОтменыDDP.СуммаНДСБезDDP,
	|	КешОтменыDDP.СуммаСНДСБезDDP,
	|	КешОтменыDDP.НомерСтроки,
	|	КешОтменыDDP.ЗапретИзменения,
	|	КешОтменыDDP.НоменклатураПоставщика,
	|	КешОтменыDDP.Характеристика,
	|	КешОтменыDDP.Упаковка,
	|	КешОтменыDDP.УсловиеЦеныПоставщика,
	|	КешОтменыDDP.ПроцентРучнойСкидки,
	|	КешОтменыDDP.СуммаРучнойСкидки,
	|	КешОтменыDDP.СтатьяРасходов,
	|	КешОтменыDDP.АналитикаРасходов,
	|	КешОтменыDDP.Склад,
	|	КешОтменыDDP.Назначение,
	|	КешОтменыDDP.Назначение КАК Назначение1,
	|	КешОтменыDDP.КлючСвязиСерийныхНомеров,
	|	КешОтменыDDP.НомерГТД,
	|	КешОтменыDDP.ЗаказПоставщику,
	|	КешОтменыDDP.НомерСтрокиДокументаПоставщика,
	|	КешОтменыDDP.Сертификат,
	|	КешОтменыDDP.НомерПаспорта,
	|	КешОтменыDDP.СтатусУказанияСерий,
	|	КешОтменыDDP.Сделка,
	|	КешОтменыDDP.СуммаВзаиморасчетов,
	|	КешОтменыDDP.СуммаНДСВзаиморасчетов,
	|	КешОтменыDDP.ВидЗапасов,
	|	КешОтменыDDP.АналитикаУчетаПартий
	|ПОМЕСТИТЬ КешРасчетаDDP
	|ИЗ
	|	КешОтменыDDP КАК КешОтменыDDP
	|		ЛЕВОЕ СОЕДИНЕНИЕ СтавкиНДС КАК СтавкиНДС
	|		ПО КешОтменыDDP.СтавкаНДС = СтавкиНДС.СтавкаНДС
	|ГДЕ
	|	КешОтменыDDP.DDP
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	КешРасчетаDDP.КодСтроки,
	|	КешРасчетаDDP.Номенклатура,
	|	КешРасчетаDDP.КоличествоУпаковок,
	|	КешРасчетаDDP.Количество,
	|	КешРасчетаDDP.Цена,
	|	КешРасчетаDDP.Сумма,
	|	КешРасчетаDDP.СтавкаНДС,
	|	ВЫБОР
	|		КОГДА &ЦенаВключаетНДС
	|			ТОГДА КешРасчетаDDP.Сумма * СтавкиНДС.Процент / (СтавкиНДС.Процент + 1)
	|		ИНАЧЕ КешРасчетаDDP.Сумма * СтавкиНДС.Процент
	|	КОНЕЦ КАК СуммаНДС,
	|	ВЫБОР
	|		КОГДА &ЦенаВключаетНДС
	|			ТОГДА КешРасчетаDDP.Сумма
	|		ИНАЧЕ КешРасчетаDDP.Сумма + КешРасчетаDDP.Сумма * СтавкиНДС.Процент
	|	КОНЕЦ КАК СуммаCНДС,
	|	КешРасчетаDDP.DDP,
	|	ВЫБОР
	|		КОГДА &ЦенаВключаетНДС
	|			ТОГДА КешРасчетаDDP.СуммаСDDP - КешРасчетаDDP.Сумма
	|		ИНАЧЕ КешРасчетаDDP.СуммаСDDP - (КешРасчетаDDP.Сумма + КешРасчетаDDP.Сумма * СтавкиНДС.Процент)
	|	КОНЕЦ КАК КурсоваяРазницаDDP,
	|	КешРасчетаDDP.СуммаСDDP,
	|	КешРасчетаDDP.ЦенаБезDDP,
	|	КешРасчетаDDP.СуммаБезDDP,
	|	КешРасчетаDDP.СуммаНДСБезDDP,
	|	КешРасчетаDDP.СуммаСНДСБезDDP,
	|	КешРасчетаDDP.НомерСтроки,
	|	КешРасчетаDDP.ЗапретИзменения,
	|	КешРасчетаDDP.НоменклатураПоставщика,
	|	КешРасчетаDDP.Характеристика,
	|	КешРасчетаDDP.Упаковка,
	|	КешРасчетаDDP.УсловиеЦеныПоставщика,
	|	КешРасчетаDDP.ПроцентРучнойСкидки,
	|	КешРасчетаDDP.СуммаРучнойСкидки,
	|	КешРасчетаDDP.СтатьяРасходов,
	|	КешРасчетаDDP.АналитикаРасходов,
	|	КешРасчетаDDP.Склад,
	|	КешРасчетаDDP.Назначение,
	|	КешРасчетаDDP.КлючСвязиСерийныхНомеров,
	|	КешРасчетаDDP.НомерГТД,
	|	КешРасчетаDDP.ЗаказПоставщику,
	|	КешРасчетаDDP.НомерСтрокиДокументаПоставщика,
	|	КешРасчетаDDP.Сертификат,
	|	КешРасчетаDDP.НомерПаспорта,
	|	КешРасчетаDDP.СтатусУказанияСерий,
	|	КешРасчетаDDP.Сделка,
	|	КешРасчетаDDP.СуммаВзаиморасчетов,
	|	КешРасчетаDDP.СуммаНДСВзаиморасчетов,
	|	КешРасчетаDDP.ВидЗапасов,
	|	КешРасчетаDDP.АналитикаУчетаПартий
	|ПОМЕСТИТЬ КешDDP
	|ИЗ
	|	КешРасчетаDDP КАК КешРасчетаDDP
	|		ЛЕВОЕ СОЕДИНЕНИЕ СтавкиНДС КАК СтавкиНДС
	|		ПО КешРасчетаDDP.СтавкаНДС = СтавкиНДС.СтавкаНДС
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ТаблицаБезИзменений.НомерСтроки КАК НомерСтроки,
	|	ТаблицаБезИзменений.Номенклатура,
	|	ТаблицаБезИзменений.КоличествоУпаковок,
	|	ТаблицаБезИзменений.Количество,
	|	ТаблицаБезИзменений.Цена,
	|	ТаблицаБезИзменений.Сумма,
	|	ТаблицаБезИзменений.СтавкаНДС,
	|	ТаблицаБезИзменений.СуммаНДС,
	|	ТаблицаБезИзменений.СуммаСНДС,
	|	ТаблицаБезИзменений.КодСтроки,
	|	ТаблицаБезИзменений.DDP,
	|	ТаблицаБезИзменений.КурсоваяРазницаDDP,
	|	ТаблицаБезИзменений.СуммаСDDP,
	|	ТаблицаБезИзменений.НоменклатураПоставщика,
	|	ТаблицаБезИзменений.Характеристика,
	|	ТаблицаБезИзменений.Упаковка,
	|	ТаблицаБезИзменений.УсловиеЦеныПоставщика,
	|	ТаблицаБезИзменений.ПроцентРучнойСкидки,
	|	ТаблицаБезИзменений.СуммаРучнойСкидки,
	|	ТаблицаБезИзменений.СтатьяРасходов,
	|	ТаблицаБезИзменений.АналитикаРасходов,
	|	ТаблицаБезИзменений.Склад,
	|	ТаблицаБезИзменений.Назначение,
	|	ТаблицаБезИзменений.КлючСвязиСерийныхНомеров,
	|	ТаблицаБезИзменений.НомерГТД,
	|	ТаблицаБезИзменений.ЗаказПоставщику,
	|	ТаблицаБезИзменений.НомерСтрокиДокументаПоставщика,
	|	ТаблицаБезИзменений.Сертификат,
	|	ТаблицаБезИзменений.НомерПаспорта,
	|	ТаблицаБезИзменений.СтатусУказанияСерий,
	|	ТаблицаБезИзменений.Сделка,
	|	ТаблицаБезИзменений.СуммаВзаиморасчетов,
	|	ТаблицаБезИзменений.СуммаНДСВзаиморасчетов,
	|	ТаблицаБезИзменений.ВидЗапасов,
	|	ТаблицаБезИзменений.АналитикаУчетаПартий
	|ИЗ
	|	ТаблицаБезИзменений КАК ТаблицаБезИзменений
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	КешОтменыDDP.НомерСтроки,
	|	КешОтменыDDP.Номенклатура,
	|	КешОтменыDDP.КоличествоУпаковок,
	|	КешОтменыDDP.Количество,
	|	КешОтменыDDP.Цена,
	|	КешОтменыDDP.Сумма,
	|	КешОтменыDDP.СтавкаНДС,
	|	КешОтменыDDP.СуммаНДС,
	|	КешОтменыDDP.СуммаСНДС,
	|	КешОтменыDDP.КодСтроки,
	|	КешОтменыDDP.DDP,
	|	КешОтменыDDP.КурсоваяРазницаDDP,
	|	КешОтменыDDP.СуммаСDDP,
	|	КешОтменыDDP.НоменклатураПоставщика,
	|	КешОтменыDDP.Характеристика,
	|	КешОтменыDDP.Упаковка,
	|	КешОтменыDDP.УсловиеЦеныПоставщика,
	|	КешОтменыDDP.ПроцентРучнойСкидки,
	|	КешОтменыDDP.СуммаРучнойСкидки,
	|	КешОтменыDDP.СтатьяРасходов,
	|	КешОтменыDDP.АналитикаРасходов,
	|	КешОтменыDDP.Склад,
	|	КешОтменыDDP.Назначение,
	|	КешОтменыDDP.КлючСвязиСерийныхНомеров,
	|	КешОтменыDDP.НомерГТД,
	|	КешОтменыDDP.ЗаказПоставщику,
	|	КешОтменыDDP.НомерСтрокиДокументаПоставщика,
	|	КешОтменыDDP.Сертификат,
	|	КешОтменыDDP.НомерПаспорта,
	|	КешОтменыDDP.СтатусУказанияСерий,
	|	КешОтменыDDP.Сделка,
	|	КешОтменыDDP.СуммаВзаиморасчетов,
	|	КешОтменыDDP.СуммаНДСВзаиморасчетов,
	|	КешОтменыDDP.ВидЗапасов,
	|	КешОтменыDDP.АналитикаУчетаПартий
	|ИЗ
	|	КешОтменыDDP КАК КешОтменыDDP
	|ГДЕ
	|	НЕ КешОтменыDDP.DDP
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	КешDDP.НомерСтроки,
	|	КешDDP.Номенклатура,
	|	КешDDP.КоличествоУпаковок,
	|	КешDDP.Количество,
	|	КешDDP.Цена,
	|	КешDDP.Сумма,
	|	КешDDP.СтавкаНДС,
	|	КешDDP.СуммаНДС,
	|	КешDDP.СуммаCНДС,
	|	КешDDP.КодСтроки,
	|	КешDDP.DDP,
	|	КешDDP.КурсоваяРазницаDDP,
	|	КешDDP.СуммаСDDP,
	|	КешDDP.НоменклатураПоставщика,
	|	КешDDP.Характеристика,
	|	КешDDP.Упаковка,
	|	КешDDP.УсловиеЦеныПоставщика,
	|	КешDDP.ПроцентРучнойСкидки,
	|	КешDDP.СуммаРучнойСкидки,
	|	КешDDP.СтатьяРасходов,
	|	КешDDP.АналитикаРасходов,
	|	КешDDP.Склад,
	|	КешDDP.Назначение,
	|	КешDDP.КлючСвязиСерийныхНомеров,
	|	КешDDP.НомерГТД,
	|	КешDDP.ЗаказПоставщику,
	|	КешDDP.НомерСтрокиДокументаПоставщика,
	|	КешDDP.Сертификат,
	|	КешDDP.НомерПаспорта,
	|	КешDDP.СтатусУказанияСерий,
	|	КешDDP.Сделка,
	|	КешDDP.СуммаВзаиморасчетов,
	|	КешDDP.СуммаНДСВзаиморасчетов,
	|	КешDDP.ВидЗапасов,
	|	КешDDP.АналитикаУчетаПартий
	|ИЗ
	|	КешDDP КАК КешDDP
	|
	|УПОРЯДОЧИТЬ ПО
	|	НомерСтроки";
	Возврат ТекстЗапроса;
КонецФункции

// Расчитывает или удаляет услугу DDP табличной части "Товары" в заказе поставщику 
//
// Параметры:
//  ОбъектДокумента	- ДокументОбъект.ЗаказПоставщику         - заказ поставщику
//	УслугаDDP		- СправочникСсылка.Номенклатура			 - ссылка на услугу DDP, елемент справочника номенклатуры
//
Процедура РасчитатьУслугуDDP(УслугаDDP,ОбъектДокумента) 
		КурсоваяРазницаDDP = ОбъектДокумента.Товары.Итог("КурсоваяРазницаDDP");
	
		Если Не КурсоваяРазницаDDP = 0 Тогда
			СтрокаУслугаDDP 						= ОбъектДокумента.Товары.Добавить();
			СтрокаУслугаDDP.Номенклатура			= УслугаDDP;
			СтатьяРасходовУникальныйИдентификатор	= Новый УникальныйИдентификатор("c18cfac8-ae9b-11e3-80c2-001e676b0174");
			СтрокаУслугаDDP.СтатьяРасходов			= ПланыВидовХарактеристик.СтатьиРасходов.ПолучитьСсылку(СтатьяРасходовУникальныйИдентификатор);
			СтрокаУслугаDDP.Цена  					= КурсоваяРазницаDDP;
			СтрокаУслугаDDP.СтавкаНДС				= Перечисления.СтавкиНДС.БезНДС;
			СтрокаУслугаDDP.КоличествоУпаковок		= 1;
			СтрокаУслугаDDP.Количество 				= 1;
			Если ТипЗнч(ОбъектДокумента.Ссылка) = Тип("ДокументСсылка.ЗаказПоставщику") Тогда  
				СтрокаУслугаDDP.ДатаПоступления			= ТекущаяДата();
			КонецЕсли;
			ПриИзменениеЦеныОбработатьСтрокуТЧ(СтрокаУслугаDDP,ОбъектДокумента);
		КонецЕсли;
КонецПроцедуры

// Расчитывает данные у строке табличной части "Товары"  
//
// Параметры:
//  ОбъектДокумента	- ДокументОбъект.ЗаказПоставщику        - заказ поставщику
//	ТекущаяСтрока	- ДанныеФормыЭлементКоллекции	        - строка табличной части "Товары"
//
Процедура ПриИзменениеЦеныОбработатьСтрокуТЧ(ТекущаяСтрока,ОбъектДокумента)
	СтруктураДействий = Новый Структура;	
	ЗаполнитьСтруктуруДействий(СтруктураДействий					,ОбъектДокумента);
	СтруктураДействий.Вставить("ПроверитьСтатьюАналитикуРасходов"	,ТекущаяСтрока.Номенклатура);
	ОбработкаТабличнойЧастиСервер.ОбработатьСтрокуТЧ(ТекущаяСтрока	,СтруктураДействий, Неопределено);
КонецПроцедуры	

// Формирует структуру действий над строкой табличной части "Товары" 
//
// Параметры:
//  ОбъектДокумента 	- ДокументОбъект.ЗаказПоставщику,ДокументОбъект.ПоступлениеТоваровУслуг	- ссылка на документ 
//	СтруктураДействий	- Структура    				 	    									- Структура действий над строкой табличной части "Товары"
//
Процедура ЗаполнитьСтруктуруДействий(СтруктураДействий,ОбъектДокумента)
	СтруктураПересчетаСуммы = ОбработкаТабличнойЧастиКлиентСервер.ПолучитьСтруктуруПересчетаСуммыНДСВСтрокеТЧ(ОбъектДокумента);
	СтруктураДействий.Вставить("ПересчитатьСуммуНДС"					,СтруктураПересчетаСуммы);
	СтруктураДействий.Вставить("ПересчитатьСуммуСНДС"					,СтруктураПересчетаСуммы);
	СтруктураДействий.Вставить("ПересчитатьСумму");
	СтруктураДействий.Вставить("ПересчитатьСуммуСУчетомРучнойСкидки"	,Новый Структура("Очищать", Ложь));
	СтруктураДействий.Вставить("ЗаполнитьПризнакТипНоменклатуры"		,Новый Структура("Номенклатура", "ТипНоменклатуры"));
	
	Если ТипЗнч(ОбъектДокумента.Ссылка) = Тип("ДокументСсылка.ЗаказПоставщику") Тогда  
		СтруктураДействий.Вставить("ЗаполнитьДубликатыЗависимыхРеквизитов"	,ПолучитьСтруктуруЗависимыхРеквизитов());
	Иначе                                  
		СтруктураДействий.Вставить("ОчиститьСуммуВзаиморасчетов");
		СтруктураДействий.Вставить("ЗаполнитьПризнакВедетсяУчетПоГТД"		, Новый Структура("Номенклатура", "ВедетсяУчетПоГТД"));
		СтруктураДействий.Вставить("ЗаполнитьПризнакАртикул"				, Новый Структура("Номенклатура", "Артикул"));
	КонецЕсли;
КонецПроцедуры

// Дубликаты зависимых реквизитов табличной части "Товары" в заказе поставщику 
//
// Параметры:
//  
//Возвращаемое значение:
//	Структура 			- структура зависимых реквизитов табличной части "Товары" в заказе поставщику
// 
Функция ПолучитьСтруктуруЗависимыхРеквизитов()
	
	Возврат Новый Структура("Отменено", "Сумма, СуммаНДС, СуммаСНДС, СуммаРучнойСкидки");
	
КонецФункции

#КонецОбласти

#Область СведенияОВнешнейОбработке

Функция СведенияОВнешнейОбработке() Экспорт
	
	//Версия обработки
	Версия = "1.0.3";
	
	// Объявим переменную, в которой мы сохраним и вернем "наружу" необходимые данные
    ПараметрыРегистрации = Новый Структура;

    // Объявим еще одну переменную, которая нам потребуется ниже
    МассивНазначений = Новый Массив;
    
    // Первый параметр, который мы должны указать - это какой вид обработки системе должна зарегистрировать. 
    // Допустимые типы: ДополнительнаяОбработка, ДополнительныйОтчет, ЗаполнениеОбъекта, Отчет, ПечатнаяФорма, СозданиеСвязанныхОбъектов
    ПараметрыРегистрации.Вставить("Вид", "ДополнительнаяОбработка");

    // Теперь нам необходимо передать в виде массива имен, к чему будет подключена наша ВПФ
    // Имейте ввиду, что можно задать имя в таком виде: Документ.* - в этом случае обработка будет подключена ко всем документам в системе, 
    // которые поддерживают механизм ВПФ
	//СчитатьДокументыНазначений(МассивНазначений);
	
	
	ПараметрыРегистрации.Вставить("Назначение", Новый Массив);
    
    // Теперь зададим имя, под которым ВПФ будет зарегистрирована в справочнике внешних обработок
    ПараметрыРегистрации.Вставить("Наименование", "Работа с DDP");
    
    // Зададим право обработке на использование безопасного режима. Более подробно можно узнать в справке к платформе (метод УстановитьБезопасныйРежим)
    ПараметрыРегистрации.Вставить("БезопасныйРежим", Ложь);

	
    // Следующие два параметра играют больше информационную роль, т.е. это то, что будет видеть пользователь в информации к обработке
    ПараметрыРегистрации.Вставить("Версия", Версия);    
    ПараметрыРегистрации.Вставить("Информация", "Работа с DDP [" + Версия + "]");
    
    // Создадим таблицу команд (подробнее смотрим ниже)
    ТаблицаКоманд = ПолучитьТаблицуКоманд();
    
    // Добавим команду в таблицу
	ДобавитьКоманду(ТаблицаКоманд, "Работа с DDP [" + Версия + "]", "Форма", "ОткрытиеФормы", Ложь, "РСDDP");
    
    // Сохраним таблицу команд в параметры регистрации обработки
    ПараметрыРегистрации.Вставить("Команды", ТаблицаКоманд);
    
    // Теперь вернем системе наши параметры
    Возврат ПараметрыРегистрации;
	
КонецФункции

Функция ПолучитьТаблицуКоманд()

   // Создадим пустую таблицу команд и колонки в ней
   Команды = Новый ТаблицаЗначений;

   // Как будет выглядеть описание печатной формы для пользователя
   Команды.Колонки.Добавить("Представление", Новый ОписаниеТипов("Строка")); 

   // Имя нашего макета, что бы могли отличить вызванную команду в обработке печати
   Команды.Колонки.Добавить("Идентификатор", Новый ОписаниеТипов("Строка"));

   // Тут задается, как должна вызваться команда обработки
   // Возможные варианты:
   // - ОткрытиеФормы - в этом случае в колонке идентификатор должно быть указано имя формы, которое должна будет открыть система
   // - ВызовКлиентскогоМетода - вызвать клиентскую экспортную процедуру из модуля формы обработки
   // - ВызовСерверногоМетода - вызвать серверную экспортную процедуру из модуля объекта обработки
   Команды.Колонки.Добавить("Использование", Новый ОписаниеТипов("Строка"));

   // Следующий параметр указывает, необходимо ли показывать оповещение при начале и завершению работы обработки. Не имеет смысла при открытии формы
   Команды.Колонки.Добавить("ПоказыватьОповещение", Новый ОписаниеТипов("Булево"));

   // Для печатной формы должен содержать строку ПечатьMXL 
   Команды.Колонки.Добавить("Модификатор", Новый ОписаниеТипов("Строка"));
   
   Возврат Команды;
   
КонецФункции

Процедура ДобавитьКоманду(ТаблицаКоманд, Представление, Идентификатор, Использование, ПоказыватьОповещение = Ложь, Модификатор = "")
  // Добавляем команду в таблицу команд по переданному описанию.
  // Параметры и их значения можно посмотреть в функции ПолучитьТаблицуКоманд
  НоваяКоманда = ТаблицаКоманд.Добавить();
  НоваяКоманда.Представление = Представление;
  НоваяКоманда.Идентификатор = Идентификатор;
  НоваяКоманда.Использование = Использование;
  НоваяКоманда.ПоказыватьОповещение = ПоказыватьОповещение;
  НоваяКоманда.Модификатор = Модификатор;

КонецПроцедуры

#КонецОбласти

#Область СлужебныеПроцедурыИФункцииПереопределенияОбработчиков

// Только для внутреннего использования
Процедура ПодменитьДействиеУправляемоеПриложение(ВнешнийОбъект, Форма, ИмяСобытияФормы = "", ПолноеИмяЭлементаФормы = "", НовоеДействие, ОбработкаИсключений = Ложь)

	Если ВнешнийОбъект = Неопределено Тогда
		git_ПереопределениеОбработчиковСервер.ПодменитьДействиеУправляемоеПриложение(Форма, ИмяСобытияФормы, ПолноеИмяЭлементаФормы, НовоеДействие, ОбработкаИсключений);
	Иначе
		ВнешнийОбъект.ПодменитьДействиеУправляемоеПриложение(Форма, ИмяСобытияФормы, ПолноеИмяЭлементаФормы, НовоеДействие, ОбработкаИсключений);
	КонецЕсли;
		
КонецПроцедуры

// Только для внутреннего использования
Процедура ПереместитьЭлементВКоллекциюЭлементовФормы(ВнешнийОбъект, Элементы, ИмяЭлемента, ИмяРодителя, МестоРасположения)
	
	Если ВнешнийОбъект = Неопределено Тогда
		git_ПереопределениеОбработчиковСервер.ПереместитьЭлементВКоллекциюЭлементовФормы(Элементы, ИмяЭлемента, ИмяРодителя, МестоРасположения);
	Иначе
		ВнешнийОбъект.ПереместитьЭлементВКоллекциюЭлементовФормы(Элементы, ИмяЭлемента, ИмяРодителя, МестоРасположения);
	КонецЕсли;
	
КонецПроцедуры // ПереместитьЭлементВКоллекциюЭлементовФормы()

// Только для внутреннего использования
Процедура ПереместитьЭлементВКоллекциюЭлементовФормыБезПоиска(ВнешнийОбъект, Элементы, Элемент, Родитель, МестоРасположения = Неопределено)
	
	Если ВнешнийОбъект = Неопределено Тогда
		git_ПереопределениеОбработчиковСервер.ПереместитьЭлементВКоллекциюЭлементовФормыБезПоиска(Элементы, Элемент, Родитель, МестоРасположения);
	Иначе
		ВнешнийОбъект.ПереместитьЭлементВКоллекциюЭлементовФормыБезПоиска(Элементы, Элемент, Родитель, МестоРасположения);
	КонецЕсли;
	
КонецПроцедуры // ПереместитьЭлементВКоллекциюЭлементовФормыБезПоиска()



// Только для внутреннего использования
Функция ДобавитьЭлементВКоллекциюЭлементовФормы(ВнешнийОбъект, Элементы, Параметры, Родитель = Неопределено)
	
	Если ВнешнийОбъект = Неопределено Тогда
		Возврат git_ПереопределениеОбработчиковСервер.ДобавитьЭлементВКоллекциюЭлементовФормы(Элементы, Параметры, Родитель);
	Иначе
		Возврат ВнешнийОбъект.ДобавитьЭлементВКоллекциюЭлементовФормы(Элементы, Параметры, Родитель);
	КонецЕсли;
	
КонецФункции // ДобавитьЭлементВКоллекциюЭлементовФормы()

// Только для внутреннего использования
Функция ДобавитьКомандуВКоллекциюКомандФормы(ВнешнийОбъект, Команды, Параметры) 
		
	Если ВнешнийОбъект = Неопределено Тогда
		Возврат git_ПереопределениеОбработчиковСервер.ДобавитьКомандуВКоллекциюКомандФормы(Команды, Параметры);
	Иначе
		Возврат ВнешнийОбъект.ДобавитьКомандуВКоллекциюКомандФормы(Команды, Параметры);
	КонецЕсли;
		
КонецФункции // ДобавитьКомандуВКоллекциюКомандФормы()

#КонецОбласти

