
////////////////////////////////////////////////////////////////////////////////
// ПРОГРАММНЫЙ ИНТЕРФЕЙС

Процедура ВыполнитьДвиженияПоПартиям(Дата = Неопределено, ПоМесяцам = Ложь) Экспорт
	
	ДатаНачала = ?(Дата = Неопределено, НачалоМесяца(ТекущаяДата()), Дата);
	ДатаОкончания = КонецМесяца(ДатаНачала) + 1;
	
	ВыполнитьДвиженияПриход(ДатаНачала);
	Если ПоМесяцам = Истина Тогда
		ВыполнитьДвиженияРасход(ДатаНачала, ПоМесяцам);		
	Иначе
		Пока ДатаНачала <> ДатаОкончания Цикл	
			ВыполнитьДвиженияРасход(ДатаНачала, ПоМесяцам);
			ДатаНачала = КонецДня(ДатаНачала) + 1;
		КонецЦикла;
	КонецЕсли;
	
КонецПроцедуры



////////////////////////////////////////////////////////////////////////////////
// СЛУЖЕБНЫЕ ПРОЦЕДУРЫ И ФУНКЦИИ

Процедура ВыполнитьДвиженияПриход(Дата)

	Запрос 			= Новый Запрос;
	Запрос.Текст    = ПолучитьТекстЗапросаДвиженияПриход();
	Запрос.УстановитьПараметр("НачалоПериода", 	НачалоДня(Дата));
	Запрос.УстановитьПараметр("КонецПериода", 	КонецМесяца(Дата));
	Запрос.УстановитьПараметр("ВалютаУпрУчета", Константы.ВалютаУправленческогоУчета.Получить());
	РезультатПакета = Запрос.ВыполнитьПакет();
	
	Индекс = 29;
	НаборЗаписей = РегистрыНакопления.КТС_ДвижениеТоваровПоставщиков.СоздатьНаборЗаписей();
	Пока Индекс < 59 Цикл

		РезультатЗапроса = РезультатПакета[Индекс];
		Если РезультатЗапроса.Пустой() = Ложь Тогда
			
			ВыборкаДокументы = РезультатЗапроса.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
			Пока ВыборкаДокументы.Следующий() Цикл
				НаборЗаписей.Отбор.Регистратор.Установить(ВыборкаДокументы.ДокументПоступления);
				ВыборкаДетальныеЗаписи = ВыборкаДокументы.Выбрать();
				Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
					Запись = НаборЗаписей.Добавить();
					ЗаполнитьЗначенияСвойств(Запись, ВыборкаДетальныеЗаписи);
				КонецЦикла;
				НаборЗаписей.Записать();
				НаборЗаписей.Очистить();		
			КонецЦикла;
			
		КонецЕсли;
		
		Индекс = Индекс + 5;
		
	КонецЦикла;
 

КонецПроцедуры

Процедура ВыполнитьДвиженияРасход(Дата, ПоМесяцам)
	
	Запрос = Новый Запрос;
	МенеджерВременныхТаблиц = Новый МенеджерВременныхТаблиц;
	Запрос.МенеджерВременныхТаблиц = МенеджерВременныхТаблиц;
	Запрос.Текст = ПолучитьТекстЗапросаНачальныеДвижения();
	Запрос.УстановитьПараметр("НачалоПериода", НачалоДня(Дата));
	Если ПоМесяцам = Истина Тогда
		Запрос.УстановитьПараметр("КонецПериода", КонецМесяца(Дата));
	Иначе
		Запрос.УстановитьПараметр("КонецПериода", КонецДня(Дата));
	КонецЕсли;
		
	РезультатЗапроса = Запрос.Выполнить();
	
	Запрос.Текст = ПолучитьТекстЗапросаРекурсивныеДвижения();
	Попытки = 0;
	Пока ПроверитьКонечностьПартий(МенеджерВременныхТаблиц, Попытки) Цикл
		Запрос.Выполнить();		
	КонецЦикла;
	
	
	Запрос.Текст = ПолучитьТекстЗапросаДвиженийРасход();
	РезультатПакета = Запрос.ВыполнитьПакет();
	
	
	Индекс = 0;
	НаборЗаписей = РегистрыНакопления.КТС_ДвижениеТоваровПоставщиков.СоздатьНаборЗаписей();
	Пока Индекс <= 25 Цикл

		РезультатЗапроса = РезультатПакета[Индекс];
		Если РезультатЗапроса.Пустой() = Ложь Тогда
			
			ВыборкаДокументы = РезультатЗапроса.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
			Пока ВыборкаДокументы.Следующий() Цикл
				НаборЗаписей.Отбор.Регистратор.Установить(ВыборкаДокументы.Регистратор);
				ВыборкаДетальныеЗаписи = ВыборкаДокументы.Выбрать();
				Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
					Запись = НаборЗаписей.Добавить();
					ЗаполнитьЗначенияСвойств(Запись, ВыборкаДетальныеЗаписи);
				КонецЦикла;
				НаборЗаписей.Записать();
				НаборЗаписей.Очистить();		
			КонецЦикла;
			
		КонецЕсли;
		
		Индекс = Индекс + 5;
		
	КонецЦикла;

	МенеджерВременныхТаблиц.Закрыть();
		
КонецПроцедуры



Функция ПолучитьТекстЗапросаДвиженияПриход()

	ТекстЗапроса = "
		////////////////////////////////////////////////////////////////////////////////
		// 0.
		|ВЫБРАТЬ
		|	ВЫРАЗИТЬ(КурсыВалют.Курс / КурсыВалют.Кратность КАК ЧИСЛО(15, 4)) КАК Курс,
		|	КурсыВалют.Валюта КАК Валюта,
		|	КурсыВалют.Период КАК Период
		|ПОМЕСТИТЬ КурсыВалют
		|ИЗ
		|	РегистрСведений.КурсыВалют КАК КурсыВалют
		|	
		|ИНДЕКСИРОВАТЬ ПО
		|	Период,
		|	Валюта		
		|;
		////////////////////////////////////////////////////////////////////////////////
		// 1.
		|ВЫБРАТЬ
		|	КурсыВалют.Курс,
		|	КурсыВалют.Валюта,
		|	КурсыВалют.Период КАК НачалоПериода,
		|	МИНИМУМ(ЕСТЬNULL(КурсыВалютКопия.Период, ДАТАВРЕМЯ(3999, 1, 1))) КАК КонецПериода
		|ПОМЕСТИТЬ ТаблицаКурсов
		|ИЗ
		|	КурсыВалют КАК КурсыВалют
		|
		|ЛЕВОЕ СОЕДИНЕНИЕ КурсыВалют КАК КурсыВалютКопия
		|ПО КурсыВалютКопия.Период > КурсыВалют.Период
		|И 	КурсыВалютКопия.Валюта = КурсыВалют.Валюта
		|
		|СГРУППИРОВАТЬ ПО
		|	КурсыВалют.Период,
		|	КурсыВалют.Курс,
		|	КурсыВалют.Валюта
		|
		|ИНДЕКСИРОВАТЬ ПО
		|	КурсыВалют.Валюта,
		|	НачалоПериода,
		|	КонецПериода	
		|;
		////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ КурсыВалют;
		////////////////////////////////////////////////////////////////////////////////
		// 3.
		|ВЫБРАТЬ
		|	ДвижениеТоваров.Период,
		|	ДвижениеТоваров.Регистратор,
		|	ДвижениеТоваров.НомерСтроки,
		|	ДвижениеТоваров.Активность,
		|	ДвижениеТоваров.ВидДвижения,
		|	ДвижениеТоваров.АналитикаУчетаНоменклатуры,
		|	ДвижениеТоваров.Поставщик,
		|	ДвижениеТоваров.ДокументПоступления,
		|	ДвижениеТоваров.Количество,
		|	ДвижениеТоваров.ДатаПрихода,
		|	ДвижениеТоваров.ДатаПлановойОплаты,
		|	ДвижениеТоваров.ДатаПродажи,
		|	ДвижениеТоваров.ВалютаПрихода,
		|	ДвижениеТоваров.ЦенаПрихода,
		|	ДвижениеТоваров.ЦенаПослеОплаты
		|ПОМЕСТИТЬ ДвижениеТоваров
		|ИЗ
		|	РегистрНакопления.КТС_ДвижениеТоваровПоставщиков КАК ДвижениеТоваров
		|ГДЕ
		|	ДвижениеТоваров.Период 		>= &НачалоПериода
		|И 	ДвижениеТоваров.Период 		<= &КонецПериода
		|И 	ДвижениеТоваров.ВидДвижения  = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
		|;
		////////////////////////////////////////////////////////////////////////////////
		// 4.
		|ВЫБРАТЬ
		|	ПТиУ.Период КАК Период,
		|	ВЫРАЗИТЬ(ПТиУ.Регистратор КАК Документ.ПоступлениеТоваровУслуг) 				КАК Регистратор,
		|	ПТиУ.АналитикаУчетаНоменклатуры 												КАК АналитикаУчетаНоменклатуры,
		|	ВЫРАЗИТЬ(ПТиУ.Регистратор КАК Документ.ПоступлениеТоваровУслуг).Партнер 		КАК Поставщик,
		|	ВЫРАЗИТЬ(ПТиУ.Регистратор КАК Документ.ПоступлениеТоваровУслуг).Валюта			КАК Валюта,
		|	ВЫРАЗИТЬ(ПТиУ.Регистратор КАК Документ.ПоступлениеТоваровУслуг).ЗаказПоставщику КАК ЗаказПоставщику,
		|	ВЫБОР
		|		КОГДА ВЫРАЗИТЬ(ПТиУ.Регистратор КАК Документ.ПоступлениеТоваровУслуг).ДатаПлатежа = ДАТАВРЕМЯ(1, 1, 1)
		|			ТОГДА НАЧАЛОПЕРИОДА(ПТиУ.Период, ДЕНЬ)
		|		ИНАЧЕ ВЫРАЗИТЬ(ПТиУ.Регистратор КАК Документ.ПоступлениеТоваровУслуг).ДатаПлатежа
		|	КОНЕЦ 																			КАК ДатаПлатежа,
		|	ВЫРАЗИТЬ(ПТиУ.Регистратор КАК Документ.ПоступлениеТоваровУслуг) 				КАК ДокументПоступления,
		|	ПТиУ.КоличествоОборот 															КАК Количество,
		|	ВЫРАЗИТЬ(ПТиУ.СтоимостьОборот / ПТиУ.КоличествоОборот КАК ЧИСЛО(15, 2)) 		КАК ЦенаПрихода,
		|	ПТиУ.Период 																	КАК ДатаПрихода
		|ПОМЕСТИТЬ ПредварительныйКешПТиУ_1
		|ИЗ
		|	РегистрНакопления.СебестоимостьТоваров.Обороты(&НачалоПериода, &КонецПериода, Регистратор, ) КАК ПТиУ
		|ГДЕ
		|	ПТиУ.Регистратор ССЫЛКА Документ.ПоступлениеТоваровУслуг
		|
		|ИНДЕКСИРОВАТЬ ПО
		|	Регистратор,
		|	АналитикаУчетаНоменклатуры
		|;
		////////////////////////////////////////////////////////////////////////////////
		// 5.
		|ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	АУПП.Партнер,
		|	АУПП.КлючАналитики
		|ПОМЕСТИТЬ АналитикаПоПартнерам
		|ИЗ
		|	РегистрСведений.АналитикаУчетаПоПартнерам КАК АУПП
		|
		|ВНУТРЕННЕЕ СОЕДИНЕНИЕ ПредварительныйКешПТиУ_1 КАК КешПТиУ
		|ПО 	КешПТиУ.Поставщик = АУПП.Партнер
		|
		|ИНДЕКСИРОВАТЬ ПО
		|	АУПП.КлючАналитики
		|;
		//////////////////////////////////////////////////////////////////////////////////////////
		// 6. ГрафикОплат
		|ВЫБРАТЬ
		|	Ссылка,
		|	МИНИМУМ(ДатаПлатежа) КАК ДатаПлатежа
		|	
		|ПОМЕСТИТЬ ГрафикОплат
		|ИЗ
		|	Документ.ЗаказПоставщику.ЭтапыГрафикаОплаты
		|	
		|ВНУТРЕННЕЕ СОЕДИНЕНИЕ АналитикаПоПартнерам КАК Аналитика
		|ПО	Аналитика.Партнер = Ссылка.Партнер
		| 
		|СГРУППИРОВАТЬ ПО 
		|	Ссылка
		|;
		//////////////////////////////////////////////////////////////////////////////////////////
		// 7.
		|ВЫБРАТЬ
		|	Обороты.Период 						КАК Период,
		|	Обороты.Регистратор					КАК Регистратор,
		|	Обороты.АналитикаУчетаНоменклатуры 	КАК АналитикаУчетаНоменклатуры,
		|	Обороты.Поставщик	                КАК Поставщик,
		|	Обороты.Валюта						КАК Валюта,
		|	Обороты.ДокументПоступления	        КАК ДокументПоступления,
		|	Обороты.Количество                  КАК Количество,
		|	Обороты.ЦенаПрихода                 КАК ЦенаПрихода,
		|	Обороты.ДатаПрихода	                КАК ДатаПрихода,
		|	ВЫБОР
		|		КОГДА Обороты.ЗаказПоставщику = Значение(Документ.ЗаказПоставщику.ПустаяСсылка) 
		|		  ИЛИ Обороты.ЗаказПоставщику = Неопределено
		|		  ИЛИ Обороты.ЗаказПоставщику = NULL
		|		ТОГДА Обороты.ДатаПлатежа
		|		ИНАЧЕ ГрафикОплат.ДатаПлатежа
		|	КОНЕЦ 								КАК ДатаПлановойОплаты
		|ПОМЕСТИТЬ ПредварительныйКешПТиУ_2
		|ИЗ
		|	ПредварительныйКешПТиУ_1 КАК Обороты	
		|
		|ЛЕВОЕ СОЕДИНЕНИЕ ГрафикОплат КАК ГрафикОплат
		|ПО 	ГрафикОплат.Ссылка = Обороты.ЗаказПоставщику
		|;	
		//////////////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ ГрафикОплат;
		//////////////////////////////////////////////////////////////////////////////////////////
		// 9.
		|ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	Обороты.Регистратор 		КАК Регистратор,
		|	Обороты.ДатаПлановойОплаты 	КАК ДатаПлановойОплаты 		
		|ПОМЕСТИТЬ ПредварительныйКешПТиУ_3
		|ИЗ
		|	ПредварительныйКешПТиУ_2 КАК Обороты
		|
		|ИНДЕКСИРОВАТЬ ПО
		|	Обороты.Регистратор				
		|;	
		//////////////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ ПредварительныйКешПТиУ_1;
		//////////////////////////////////////////////////////////////////////////////////////////
		// 11. Оплаты поставщику
		|ВЫБРАТЬ
		|	НАЧАЛОПЕРИОДА(РасчетыСКлиентами.Период, День)	КАК Период,
		|	РасчетыСКлиентами.Регистратор					КАК Регистратор,
		|	АналитикаПоПартнерам.Партнер					КАК Партнер,
		|	РасчетыСКлиентами.Валюта						КАК Валюта,
		|	РасчетыСКлиентами.Сумма							КАК Сумма
		|ПОМЕСТИТЬ КешОплатПоставщику	
		|ИЗ
		|	РегистрНакопления.РасчетыСКлиентами КАК РасчетыСКлиентами
		|	
		|ВНУТРЕННЕЕ СОЕДИНЕНИЕ АналитикаПоПартнерам КАК АналитикаПоПартнерам
		|ПО	АналитикаПоПартнерам.КлючАналитики = РасчетыСКлиентами.АналитикаУчетаПоПартнерам 
		|
		|ГДЕ	
		|	РасчетыСКлиентами.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
		|И	РасчетыСКлиентами.Сумма > 0
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ
		|	НАЧАЛОПЕРИОДА(РасчетыСКлиентами.Период, День)	КАК Период,
		|	РасчетыСКлиентами.Регистратор					КАК Регистратор,
		|	АналитикаПоПартнерам.Партнер				 	КАК Партнер,
		|	РасчетыСКлиентами.Валюта						КАК Валюта,
		|	-РасчетыСКлиентами.Сумма						КАК Сумма	
		|ИЗ
		|	РегистрНакопления.РасчетыСКлиентами КАК РасчетыСКлиентами
		|	
		|ВНУТРЕННЕЕ СОЕДИНЕНИЕ АналитикаПоПартнерам КАК АналитикаПоПартнерам
		|ПО	АналитикаПоПартнерам.КлючАналитики = РасчетыСКлиентами.АналитикаУчетаПоПартнерам 
		|
		|ГДЕ	
		|	РасчетыСКлиентами.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
		|И	РасчетыСКлиентами.Сумма < 0
		|	
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ
		|	НАЧАЛОПЕРИОДА(РасчетыСПоставщиками.Период, День)КАК Период,
		|	РасчетыСПоставщиками.Регистратор	            КАК Регистратор,
		|	АналитикаПоПартнерам.Партнер 					КАК Партнер,
		|	РасчетыСПоставщиками.Валюта						КАК Валюта,
		|	РасчетыСПоставщиками.Сумма						КАК Сумма	
		|ИЗ
		|	РегистрНакопления.РасчетыСПоставщиками КАК РасчетыСПоставщиками
		|
		|ВНУТРЕННЕЕ СОЕДИНЕНИЕ АналитикаПоПартнерам КАК АналитикаПоПартнерам
		|ПО	АналитикаПоПартнерам.КлючАналитики = РасчетыСПоставщиками.АналитикаУчетаПоПартнерам
		|
		|ГДЕ
		|	РасчетыСПоставщиками.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
		|И	РасчетыСПоставщиками.Сумма > 0
		|;
		//////////////////////////////////////////////////////////////////////////////////////////
		// 12. Оплаты поставщику
		|ВЫБРАТЬ
		|	ОплатыПоставщику.Период			КАК Период,
		|	ОплатыПоставщику.Партнер		КАК Партнер,
		|	ОплатыПоставщику.Валюта			КАК Валюта,
		|	СУММА(ОплатыПоставщику.Сумма) 	КАК Сумма 	
		|ПОМЕСТИТЬ ОплатыПоставщику
		|ИЗ
		|	КешОплатПоставщику КАК ОплатыПоставщику
		|
		|СГРУППИРОВАТЬ ПО
		|	ОплатыПоставщику.Период,
		|	ОплатыПоставщику.Партнер,
		|	ОплатыПоставщику.Валюта	
		|
		|ИНДЕКСИРОВАТЬ ПО
		|	ОплатыПоставщику.Партнер,
		|	ОплатыПоставщику.Период	
		|;
		//////////////////////////////////////////////////////////////////////////////////////////
		// 13. Оплаты поставщику наростающие
		|ВЫБРАТЬ
		|	ОплатыПоставщику.Период			КАК Период,
		|	ОплатыПоставщику.Партнер		КАК Партнер,
		|	ОплатыПоставщику.Валюта			КАК Валюта,
		|	ОплатыПоставщику.Сумма		 	КАК Сумма,
		|	СУММА(ОплатыПоставщикуКопия.Сумма) КАК СуммаПосле,
		|	СУММА(ОплатыПоставщикуКопия.Сумма) - ОплатыПоставщику.Сумма КАК СуммаДо
		| 	
		|ПОМЕСТИТЬ ОплатыПоставщикуНаростающие
		|ИЗ
		|	ОплатыПоставщику КАК ОплатыПоставщику
		|
		|   
		|ВНУТРЕННЕЕ СОЕДИНЕНИЕ ОплатыПоставщику КАК ОплатыПоставщикуКопия
		|ПО 	ОплатыПоставщику.Партнер = ОплатыПоставщикуКопия.Партнер
		|И	ОплатыПоставщику.Валюта  = ОплатыПоставщикуКопия.Валюта
		|И  	ОплатыПоставщику.Период >= ОплатыПоставщикуКопия.Период
		|
		|СГРУППИРОВАТЬ ПО
		|	ОплатыПоставщику.Период,
		|	ОплатыПоставщику.Партнер,
		|	ОплатыПоставщику.Валюта,
		|	ОплатыПоставщику.Сумма
		|;
		//////////////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ КешОплатПоставщику;
		//////////////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ ОплатыПоставщику;
		//////////////////////////////////////////////////////////////////////////////////////////
		// 16. Долги поставщику
		|ВЫБРАТЬ
		|	НАЧАЛОПЕРИОДА(РасчетыСКлиентами.Период, День)	КАК Период,
		|	РасчетыСКлиентами.Регистратор					КАК Регистратор,
		|	АналитикаПоПартнерам.Партнер					КАК Партнер,
		|	РасчетыСКлиентами.Валюта						КАК Валюта,
		|	РасчетыСКлиентами.Сумма							КАК Сумма
		|ПОМЕСТИТЬ КешДолговПоставщику	
		|ИЗ
		|	РегистрНакопления.РасчетыСКлиентами КАК РасчетыСКлиентами
		|	
		|ВНУТРЕННЕЕ СОЕДИНЕНИЕ АналитикаПоПартнерам КАК АналитикаПоПартнерам
		|ПО	АналитикаПоПартнерам.КлючАналитики = РасчетыСКлиентами.АналитикаУчетаПоПартнерам
		|
		|ГДЕ
		|	РасчетыСКлиентами.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
		|И	РасчетыСКлиентами.Сумма > 0
		|	
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ
		|	ВЫБОР
		|		КОГДА КешПоступлений.ДатаПлановойОплаты ЕСТЬ NULL
		|		ТОГДА НАЧАЛОПЕРИОДА(РасчетыСПоставщиками.Период, День)
		|		ИНАЧЕ КешПоступлений.ДатаПлановойОплаты
		|	КОНЕЦ								КАК Период,
		|	РасчетыСПоставщиками.Регистратор	КАК Регистратор,
		|	АналитикаПоПартнерам.Партнер 		КАК Партнер,
		|	РасчетыСПоставщиками.Валюта			КАК Валюта,
		|	РасчетыСПоставщиками.Сумма			КАК Сумма	
		|ИЗ
		|	РегистрНакопления.РасчетыСПоставщиками КАК РасчетыСПоставщиками
		|
		|ВНУТРЕННЕЕ СОЕДИНЕНИЕ АналитикаПоПартнерам КАК АналитикаПоПартнерам
		|ПО	АналитикаПоПартнерам.КлючАналитики = РасчетыСПоставщиками.АналитикаУчетаПоПартнерам
		|
		|ЛЕВОЕ СОЕДИНЕНИЕ ПредварительныйКешПТиУ_3 КАК КешПоступлений
		|ПО	КешПоступлений.Регистратор = ВЫРАЗИТЬ(РасчетыСПоставщиками.Регистратор КАК Документ.ПоступлениеТоваровУслуг)
		|
		|ГДЕ
		|	РасчетыСПоставщиками.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
		|И	РасчетыСПоставщиками.Сумма > 0
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ
		|	НАЧАЛОПЕРИОДА(РасчетыСПоставщиками.Период, День)КАК Период,
		|	РасчетыСПоставщиками.Регистратор				КАК Регистратор,
		|	АналитикаПоПартнерам.Партнер 					КАК Партнер,
		|	РасчетыСПоставщиками.Валюта						КАК Валюта,
		|	-РасчетыСПоставщиками.Сумма						КАК Сумма	
		|ИЗ
		|	РегистрНакопления.РасчетыСПоставщиками КАК РасчетыСПоставщиками
		|	
		|ВНУТРЕННЕЕ СОЕДИНЕНИЕ АналитикаПоПартнерам КАК АналитикаПоПартнерам
		|ПО	АналитикаПоПартнерам.КлючАналитики = РасчетыСПоставщиками.АналитикаУчетаПоПартнерам
		|
		|ГДЕ
		|	РасчетыСПоставщиками.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
		|И	РасчетыСПоставщиками.Сумма < 0
		|;
		//////////////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ ПредварительныйКешПТиУ_3;
		//////////////////////////////////////////////////////////////////////////////////////////
		// 18. Долги поставщику
		|ВЫБРАТЬ
		|	ДолгиПоставщику.Период			КАК Период,
		|	ДолгиПоставщику.Партнер			КАК Партнер,
		|	ДолгиПоставщику.Валюта			КАК Валюта,
		|	СУММА(ДолгиПоставщику.Сумма) 	КАК Сумма 	
		|ПОМЕСТИТЬ ДолгиПоставщику
		|ИЗ
		|	КешДолговПоставщику КАК ДолгиПоставщику
		|
		|СГРУППИРОВАТЬ ПО
		|	ДолгиПоставщику.Период,
		|	ДолгиПоставщику.Партнер,
		|	ДолгиПоставщику.Валюта	
		|
		|ИНДЕКСИРОВАТЬ ПО
		|	ДолгиПоставщику.Партнер,
		|	ДолгиПоставщику.Период	
		|;
		//////////////////////////////////////////////////////////////////////////////////////////
		// 19. Оплаты поставщику наростающие
		|ВЫБРАТЬ
		|	ДолгиПоставщику.Период			КАК Период,
		|	ДолгиПоставщику.Партнер			КАК Партнер,
		|	ДолгиПоставщику.Валюта			КАК Валюта,
		|	ДолгиПоставщику.Сумма		 	КАК Сумма,
		|	СУММА(ДолгиПоставщикуКопия.Сумма) КАК СуммаПосле,
		|	СУММА(ДолгиПоставщикуКопия.Сумма) - ДолгиПоставщику.Сумма КАК СуммаДо
		| 	
		|ПОМЕСТИТЬ ДолгиПоставщикуНаростающие
		|ИЗ
		|	ДолгиПоставщику КАК ДолгиПоставщику
		|   
		|ВНУТРЕННЕЕ СОЕДИНЕНИЕ ДолгиПоставщику КАК ДолгиПоставщикуКопия
		|ПО 	ДолгиПоставщику.Партнер = ДолгиПоставщикуКопия.Партнер
		|И	ДолгиПоставщику.Валюта 	= ДолгиПоставщикуКопия.Валюта
		|И  	ДолгиПоставщику.Период >= ДолгиПоставщикуКопия.Период
		|
		|СГРУППИРОВАТЬ ПО
		|	ДолгиПоставщику.Период,
		|	ДолгиПоставщику.Партнер,
		|	ДолгиПоставщику.Валюта,
		|	ДолгиПоставщику.Сумма
		|;
		//////////////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ КешДолговПоставщику;
		//////////////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ ДолгиПоставщику;
		//////////////////////////////////////////////////////////////////////////////////////////
		// 22.
		|ВЫБРАТЬ
		|	Долги.Период	КАК	ДатаПокупки,
		|	Оплаты.Период 	КАК ДатаОплаты,
		|	Долги.Партнер	КАК Партнер,
		|	Долги.Валюта	КАК Валюта
		|ПОМЕСТИТЬ ДатыПроведенныхОплат 	
		|ИЗ
		|	ДолгиПоставщикуНаростающие КАК Долги
		|		
		|ЛЕВОЕ СОЕДИНЕНИЕ ОплатыПоставщикуНаростающие КАК Оплаты
		|ПО	Оплаты.Партнер = Долги.Партнер
		|И	Оплаты.Валюта  = Долги.Валюта
		|И	Долги.СуммаПосле <= Оплаты.СуммаПосле
		|И	Долги.СуммаПосле >	Оплаты.СуммаДо
		|;
		//////////////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ АналитикаПоПартнерам;
		//////////////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ ДолгиПоставщикуНаростающие; 
		//////////////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ ОплатыПоставщикуНаростающие;	
		//////////////////////////////////////////////////////////////////////////////////////////
		// 26. 
		|ВЫБРАТЬ
		|	Обороты.Период 						КАК Период,
		|	Обороты.Регистратор					КАК Регистратор,
		|	Обороты.АналитикаУчетаНоменклатуры 	КАК АналитикаУчетаНоменклатуры,
		|	Обороты.Поставщик	                КАК Поставщик,
		|	Обороты.Валюта						КАК ВалютаПрихода,
		|	Обороты.ДокументПоступления	        КАК ДокументПоступления,
		|	Обороты.Количество                  КАК Количество,
		|	Обороты.ЦенаПрихода                 КАК ЦенаПрихода,
		|	Обороты.ДатаПрихода	                КАК ДатаПрихода,
		|	Обороты.ДатаПлановойОплаты	 		КАК ДатаПлановойОплаты,
		|	ДатыПроведенныхОплат.ДатаОплаты     КАК ДатаОплаты,
		|	ВЫБОР
		|		КОГДА &ВалютаУпрУчета = Обороты.Валюта
		|		ТОГДА Обороты.ЦенаПрихода 
		|		ИНАЧЕ ВЫРАЗИТЬ(Обороты.ЦенаПрихода * КурсыВалютНачалоПериода.Курс / КурсыВалютПослеОплаты.Курс  КАК Число(15, 2))
		|	КОНЕЦ 								КАК ЦенаПослеОплаты
		|ПОМЕСТИТЬ КешПТиУ
		|ИЗ
		|	ПредварительныйКешПТиУ_2 КАК Обороты
		|	
		|ЛЕВОЕ СОЕДИНЕНИЕ ДатыПроведенныхОплат КАК ДатыПроведенныхОплат
		|ПО	ДатыПроведенныхОплат.Партнер 	 = Обороты.Поставщик
		|И  ДатыПроведенныхОплат.Валюта	 	 = Обороты.Валюта
		|И	ДатыПроведенныхОплат.ДатаПокупки = Обороты.ДатаПлановойОплаты
		|
		|ЛЕВОЕ СОЕДИНЕНИЕ ТаблицаКурсов КАК КурсыВалютНачалоПериода
		|ПО КурсыВалютНачалоПериода.Валюта 	  	  =  &ВалютаУпрУчета
		|И 	КурсыВалютНачалоПериода.НачалоПериода <= Обороты.Период
		|И	КурсыВалютНачалоПериода.КонецПериода  >  Обороты.Период
		|
		|ЛЕВОЕ СОЕДИНЕНИЕ ТаблицаКурсов КАК КурсыВалютПослеОплаты
		|ПО КурсыВалютПослеОплаты.Валюта     	= 	&ВалютаУпрУчета
		|И	КурсыВалютПослеОплаты.НачалоПериода	<= 	ДатыПроведенныхОплат.ДатаОплаты
		|И	КурсыВалютПослеОплаты.КонецПериода 	>  	ДатыПроведенныхОплат.ДатаОплаты 
		|;
		//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ ДатыПроведенныхОплат; 
		//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		// 28.
		|ВЫБРАТЬ
		|	ПТиУ.Регистратор
		|ПОМЕСТИТЬ ДокументыДляЗаписиПТиУ		
		|ИЗ
		|	КешПТиУ КАК ПТиУ
		|		
		|ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.КТС_ДвижениеТоваровПоставщиков КАК ДвижениеТоваров
		|ПО	ВЫРАЗИТЬ(ДвижениеТоваров.Регистратор КАК Документ.ПоступлениеТоваровУслуг) 	= ПТиУ.Регистратор
		|И	ДвижениеТоваров.АналитикаУчетаНоменклатуры 									= ПТиУ.АналитикаУчетаНоменклатуры
		|
		|ГДЕ
		|	 	IsNull(ПТиУ.Поставщик, 0) 			<> IsNull(ДвижениеТоваров.Поставщик, 0) 
		|ИЛИ 	IsNull(ПТиУ.ДокументПоступления, 0)	<> IsNull(ДвижениеТоваров.ДокументПоступления, 0) 
		|ИЛИ 	IsNull(ПТиУ.Количество, 0) 			<> IsNull(ДвижениеТоваров.Количество, 0) 
		|ИЛИ 	IsNull(ПТиУ.ЦенаПрихода, 0) 		<> IsNull(ДвижениеТоваров.ЦенаПрихода, 0)
		|ИЛИ 	IsNull(ПТиУ.ДатаПрихода, 0) 		<> IsNull(ДвижениеТоваров.ДатаПрихода, 0)
		|ИЛИ 	IsNull(ПТиУ.ВалютаПрихода, 0) 		<> IsNull(ДвижениеТоваров.ВалютаПрихода, 0)
		|ИЛИ 	IsNull(ПТиУ.ЦенаПослеОплаты, 0) 	<> IsNull(ДвижениеТоваров.ЦенаПослеОплаты, 0)
		|ИЛИ 	IsNull(ПТиУ.ДатаПлановойОплаты, 0) 	<> IsNull(ДвижениеТоваров.ДатаПлановойОплаты, 0)
		|
		|ОБЪЕДИНИТЬ 
		|
		|ВЫБРАТЬ
		|	ВЫРАЗИТЬ(ДвижениеТоваров.Регистратор КАК Документ.ПоступлениеТоваровУслуг)		
		|ИЗ
		|	ДвижениеТоваров КАК ДвижениеТоваров
		|		
		|ЛЕВОЕ СОЕДИНЕНИЕ КешПТиУ КАК ПТиУ
		|ПО	ПТиУ.Регистратор 				= ВЫРАЗИТЬ(ДвижениеТоваров.Регистратор КАК Документ.ПоступлениеТоваровУслуг)
		|И	ПТиУ.АналитикаУчетаНоменклатуры = ДвижениеТоваров.АналитикаУчетаНоменклатуры
		|
		|ГДЕ
		|	ДвижениеТоваров.Регистратор	Ссылка	Документ.ПоступлениеТоваровУслуг
		|И (	IsNull(ПТиУ.Поставщик, 0) 			<> 	IsNull(ДвижениеТоваров.Поставщик, 0) 
		|ИЛИ 	IsNull(ПТиУ.ДокументПоступления, 0) <> 	IsNull(ДвижениеТоваров.ДокументПоступления, 0) 
		|ИЛИ 	IsNull(ПТиУ.Количество, 0) 			<> 	IsNull(ДвижениеТоваров.Количество, 0) 
		|ИЛИ 	IsNull(ПТиУ.ЦенаПрихода, 0) 		<> 	IsNull(ДвижениеТоваров.ЦенаПрихода, 0)
		|ИЛИ 	IsNull(ПТиУ.ДатаПрихода, 0) 		<> 	IsNull(ДвижениеТоваров.ДатаПрихода, 0)
		|ИЛИ 	IsNull(ПТиУ.ВалютаПрихода, 0) 		<>  IsNull(ДвижениеТоваров.ВалютаПрихода, 0)
		|ИЛИ 	IsNull(ПТиУ.ЦенаПослеОплаты, 0) 	<>  IsNull(ДвижениеТоваров.ЦенаПослеОплаты, 0)
		|ИЛИ 	IsNull(ПТиУ.ДатаПлановойОплаты, 0) 	<>  IsNull(ДвижениеТоваров.ДатаПлановойОплаты, 0)
		|  )
		|
		|ИНДЕКСИРОВАТЬ ПО
		|	ПТиУ.Регистратор	
		|;
		//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		// 29. 
		|ВЫБРАТЬ
		|	ПТиУ.Период,
		|	ПТиУ.Регистратор,
		|	ПТиУ.АналитикаУчетаНоменклатуры,
		|	ПТиУ.Поставщик,
		|	ПТиУ.ДокументПоступления,
		|	ПТиУ.Количество,
		|	ПТиУ.ЦенаПрихода,
		|	ПТиУ.ДатаПрихода,
		|	ПТиУ.ДатаПлановойОплаты,
		|   ПТиУ.ВалютаПрихода,
		|   ПТиУ.ЦенаПослеОплаты
		|ИЗ
		|	КешПТиУ КАК ПТиУ
		|	
		|ВНУТРЕННЕЕ СОЕДИНЕНИЕ ДокументыДляЗаписиПТиУ КАК ДокументыДляЗаписи
		|ПО	ДокументыДляЗаписи.Регистратор = ПТиУ.Регистратор
		|
		|ИТОГИ ПО
		|	ДокументПоступления
		|;
		//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ КешПТиУ;
		//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ ДокументыДляЗаписиПТиУ;
		//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		// 32.
		|ВЫБРАТЬ
		|	ВТоК.Период														КАК Период,
		|	ВЫРАЗИТЬ(ВТоК.Регистратор КАК Документ.ВозвратТоваровОтКлиента)	КАК Регистратор,
		|	ВТоК.АналитикаУчетаНоменклатуры 								КАК АналитикаУчетаНоменклатуры,
		|	ЗНАЧЕНИЕ(Справочник.Партнеры.ПустаяСсылка) 						КАК Поставщик,
		|	ВЫРАЗИТЬ(ВТоК.Регистратор КАК Документ.ВозвратТоваровОтКлиента)	КАК ДокументПоступления,
		|	ВТоК.КоличествоОборот											КАК Количество,
		|	ВЫБОР
		|		КОГДА ВЫРАЗИТЬ(ВТоК.Регистратор КАК Документ.ВозвратТоваровОтКлиента).Валюта = &ВалютаУпрУчета
		|		ТОГДА ВЫРАЗИТЬ(Товары.СуммаСНДС / Товары.Количество КАК Число(15, 2))
		|		ИНАЧЕ ВЫРАЗИТЬ(Товары.СуммаСНДС / Товары.Количество / ТаблицаКурсов.Курс КАК Число(15, 2))
		|	КОНЕЦ 															КАК ЦенаПрихода,	
		|	ВТоК.Период														КАК ДатаПрихода,
		|	ВТоК.Период														КАК ДатаПлановойОплаты,
		|	&ВалютаУпрУчета													КАК ВалютаПрихода,
		|	ВЫБОР
		|		КОГДА ВЫРАЗИТЬ(ВТоК.Регистратор КАК Документ.ВозвратТоваровОтКлиента).Валюта = &ВалютаУпрУчета
		|		ТОГДА ВЫРАЗИТЬ(Товары.СуммаСНДС / Товары.Количество КАК Число(15, 2))
		|		ИНАЧЕ ВЫРАЗИТЬ(Товары.СуммаСНДС / Товары.Количество / ТаблицаКурсов.Курс КАК Число(15, 2))
		|	КОНЕЦ															КАК ЦенаПослеОплаты
		|ПОМЕСТИТЬ КешВТоК	
		|ИЗ
		|	РегистрНакопления.СебестоимостьТоваров.Обороты(&НачалоПериода, &КонецПериода, Регистратор) КАК ВТоК						
		|
		|ЛЕВОЕ СОЕДИНЕНИЕ (	ВЫБРАТЬ
		|						Ссылка,
		|						Номенклатура,
		|						СУММА(Количество)КАК Количество,
		|						СУММА(СуммаСНДС) КАК СуммаСНДС
		|					ИЗ
		|						Документ.ВозвратТоваровОтКлиента.Товары
		|					
		|					СГРУППИРОВАТЬ ПО
		|						Ссылка,
		|						Номенклатура	
		|				  ) КАК Товары
		|ПО	Товары.Ссылка 		= ВЫРАЗИТЬ(ВТоК.Регистратор КАК Документ.ВозвратТоваровОтКлиента)
		|И	Товары.Номенклатура = ВТоК.АналитикаУчетаНоменклатуры.Номенклатура
		|
		|ЛЕВОЕ СОЕДИНЕНИЕ ТаблицаКурсов КАК ТаблицаКурсов
		|ПО 	ТаблицаКурсов.Валюта     	= 	&ВалютаУпрУчета
		|И	ТаблицаКурсов.НачалоПериода	<= 	ВТоК.Период
		|И	ТаблицаКурсов.КонецПериода 	>  	ВТоК.Период 
		|		
		|ГДЕ
		|	ВТоК.Регистратор Ссылка Документ.ВозвратТоваровОтКлиента
		|;
		//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		// 33.
		|ВЫБРАТЬ
		|	ВТоК.Регистратор
		|ПОМЕСТИТЬ ДокументыДляЗаписиВТоК		
		|ИЗ
		|	КешВТоК КАК ВТоК
		|		
		|ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.КТС_ДвижениеТоваровПоставщиков КАК ДвижениеТоваров
		|ПО	ВЫРАЗИТЬ(ДвижениеТоваров.Регистратор КАК Документ.ВозвратТоваровОтКлиента) 	= ВТоК.Регистратор
		|И	ДвижениеТоваров.АналитикаУчетаНоменклатуры 									= ВТоК.АналитикаУчетаНоменклатуры
		|
		|ГДЕ
		|		IsNull(ВТоК.Поставщик, 0) 			<> IsNull(ДвижениеТоваров.Поставщик, 0) 
		|ИЛИ 	IsNull(ВТоК.ДокументПоступления, 0) <> IsNull(ДвижениеТоваров.ДокументПоступления, 0) 
		|ИЛИ 	IsNull(ВТоК.Количество, 0) 			<> IsNull(ДвижениеТоваров.Количество, 0) 
		|ИЛИ 	IsNull(ВТоК.ЦенаПрихода, 0) 		<> IsNull(ДвижениеТоваров.ЦенаПрихода, 0)
		|ИЛИ 	IsNull(ВТоК.ДатаПрихода, 0) 		<> IsNull(ДвижениеТоваров.ДатаПрихода, 0)
		|ИЛИ 	IsNull(ВТоК.ВалютаПрихода, 0) 		<> IsNull(ДвижениеТоваров.ВалютаПрихода, 0)
		|ИЛИ 	IsNull(ВТоК.ЦенаПослеОплаты, 0) 	<> IsNull(ДвижениеТоваров.ЦенаПослеОплаты, 0)
		|ИЛИ 	IsNull(ВТоК.ДатаПлановойОплаты, 0) 	<> IsNull(ДвижениеТоваров.ДатаПлановойОплаты, 0)
		|
		|ОБЪЕДИНИТЬ 
		|
		|ВЫБРАТЬ
		|	ВЫРАЗИТЬ(ДвижениеТоваров.Регистратор КАК Документ.ВозвратТоваровОтКлиента)		
		|ИЗ
		|	ДвижениеТоваров КАК ДвижениеТоваров
		|		
		|ЛЕВОЕ СОЕДИНЕНИЕ КешВТоК КАК ВТоК
		|ПО	ВТоК.Регистратор 				= ВЫРАЗИТЬ(ДвижениеТоваров.Регистратор КАК Документ.ВозвратТоваровОтКлиента)
		|И	ВТоК.АналитикаУчетаНоменклатуры = ДвижениеТоваров.АналитикаУчетаНоменклатуры
		|
		|ГДЕ
		|	ДвижениеТоваров.Регистратор			Ссылка	Документ.ВозвратТоваровОтКлиента
		|И (	IsNull(ВТоК.Поставщик, 0) 			<> 	IsNull(ДвижениеТоваров.Поставщик, 0) 
		|ИЛИ 	IsNull(ВТоК.ДокументПоступления, 0) <> 	IsNull(ДвижениеТоваров.ДокументПоступления, 0) 
		|ИЛИ 	IsNull(ВТоК.Количество, 0) 			<> 	IsNull(ДвижениеТоваров.Количество, 0) 
		|ИЛИ 	IsNull(ВТоК.ЦенаПрихода, 0) 		<> 	IsNull(ДвижениеТоваров.ЦенаПрихода, 0)
		|ИЛИ 	IsNull(ВТоК.ДатаПрихода, 0) 		<> 	IsNull(ДвижениеТоваров.ДатаПрихода, 0)
		|ИЛИ 	IsNull(ВТоК.ВалютаПрихода, 0) 		<>  IsNull(ДвижениеТоваров.ВалютаПрихода, 0)
		|ИЛИ 	IsNull(ВТоК.ЦенаПослеОплаты, 0) 	<>  IsNull(ДвижениеТоваров.ЦенаПослеОплаты, 0)
		|ИЛИ 	IsNull(ВТоК.ДатаПлановойОплаты, 0) 	<> 	IsNull(ДвижениеТоваров.ДатаПлановойОплаты, 0)
		|  )
		|
		|ИНДЕКСИРОВАТЬ ПО
		|	ВТоК.Регистратор	
		|;
		//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		// 34. 
		|ВЫБРАТЬ
		|	ВТоК.Период,
		|	ВТоК.Регистратор,
		|	ВТоК.АналитикаУчетаНоменклатуры,
		|	ВТоК.Поставщик,
		|	ВТоК.ДокументПоступления,
		|	ВТоК.Количество,
		|	ВТоК.ЦенаПрихода,
		|	ВТоК.ДатаПрихода,
		|	ВТоК.ДатаПлановойОплаты,
		|   ВТоК.ВалютаПрихода,
		|   ВТоК.ЦенаПослеОплаты
		|ИЗ
		|	КешВТоК КАК ВТоК
		|	
		|ВНУТРЕННЕЕ СОЕДИНЕНИЕ ДокументыДляЗаписиВТоК КАК ДокументыДляЗаписи
		|ПО	ДокументыДляЗаписи.Регистратор = ВТоК.Регистратор
		|
		|ИТОГИ ПО
		|	ДокументПоступления
		|;
		//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ КешВТоК;
		|УНИЧТОЖИТЬ ДокументыДляЗаписиВТоК;
		//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		// 37.
		|ВЫБРАТЬ
		|	ВО.Период															КАК Период,
		|	ВЫРАЗИТЬ(ВО.Регистратор КАК Документ.ВводОстатков)					КАК Регистратор,
		|	ВО.АналитикаУчетаНоменклатуры 										КАК АналитикаУчетаНоменклатуры,
		|	ЗНАЧЕНИЕ(Справочник.Партнеры.ПустаяСсылка) 							КАК Поставщик,
		|	ВЫРАЗИТЬ(ВО.Регистратор КАК Документ.ВводОстатков)					КАК ДокументПоступления,
		|	ВО.КоличествоОборот													КАК Количество,
		|	ВЫРАЗИТЬ(ВО.СтоимостьОборот / ВО.КоличествоОборот КАК ЧИСЛО(15, 2))	КАК ЦенаПрихода,
		|	ВО.Период															КАК ДатаПрихода,
		|	ВО.Период															КАК ДатаПлановойОплаты,
		|	&ВалютаУпрУчета														КАК ВалютаПрихода,
		|	ВЫРАЗИТЬ(ВО.СтоимостьОборот / ВО.КоличествоОборот КАК ЧИСЛО(15, 2))	КАК ЦенаПослеОплаты
		|ПОМЕСТИТЬ КешВО	
		|ИЗ
		|	РегистрНакопления.СебестоимостьТоваров.Обороты(&НачалоПериода, &КонецПериода, Регистратор) КАК ВО						
		|
		|ГДЕ
		|	Регистратор Ссылка Документ.ВводОстатков
		|	
		|ИНДЕКСИРОВАТЬ ПО
		|	Регистратор,
		|	АналитикаУчетаНоменклатуры	
		|;
		//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		// 38.
		|ВЫБРАТЬ
		|	ВО.Регистратор
		|ПОМЕСТИТЬ ДокументыДляЗаписиВО		
		|ИЗ
		|	КешВО КАК ВО
		|		
		|ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.КТС_ДвижениеТоваровПоставщиков КАК ДвижениеТоваров
		|ПО	ВЫРАЗИТЬ(ДвижениеТоваров.Регистратор КАК Документ.ВводОстатков) = ВО.Регистратор
		|И	ДвижениеТоваров.АналитикаУчетаНоменклатуры 						= ВО.АналитикаУчетаНоменклатуры
		|
		|ГДЕ
		|		IsNull(ВО.Поставщик, 0) 			<> IsNull(ДвижениеТоваров.Поставщик, 0) 
		|ИЛИ 	IsNull(ВО.ДокументПоступления, 0) 	<> IsNull(ДвижениеТоваров.ДокументПоступления, 0) 
		|ИЛИ 	IsNull(ВО.Количество, 0) 			<> IsNull(ДвижениеТоваров.Количество, 0) 
		|ИЛИ 	IsNull(ВО.ЦенаПрихода, 0) 			<> IsNull(ДвижениеТоваров.ЦенаПрихода, 0)
		|ИЛИ 	IsNull(ВО.ДатаПрихода, 0) 			<> IsNull(ДвижениеТоваров.ДатаПрихода, 0)
		|ИЛИ 	IsNull(ВО.ВалютаПрихода, 0) 		<> IsNull(ДвижениеТоваров.ВалютаПрихода, 0)
		|ИЛИ 	IsNull(ВО.ЦенаПослеОплаты, 0) 		<> IsNull(ДвижениеТоваров.ЦенаПослеОплаты, 0)
		|ИЛИ 	IsNull(ВО.ДатаПлановойОплаты, 0) 	<> IsNull(ДвижениеТоваров.ДатаПлановойОплаты, 0)
		|
		|ОБЪЕДИНИТЬ 
		|
		|ВЫБРАТЬ
		|	ВЫРАЗИТЬ(ДвижениеТоваров.Регистратор КАК Документ.ВводОстатков)		
		|ИЗ
		|	ДвижениеТоваров КАК ДвижениеТоваров
		|		
		|ЛЕВОЕ СОЕДИНЕНИЕ КешВО КАК ВО
		|ПО	ВО.Регистратор 				  = ВЫРАЗИТЬ(ДвижениеТоваров.Регистратор КАК Документ.ВводОстатков)
		|И	ВО.АналитикаУчетаНоменклатуры = ДвижениеТоваров.АналитикаУчетаНоменклатуры
		|
		|ГДЕ
		|	ДвижениеТоваров.Регистратор			Ссылка	Документ.ВводОстатков
		|И (	IsNull(ВО.Поставщик, 0) 			<> 	IsNull(ДвижениеТоваров.Поставщик, 0) 
		|ИЛИ 	IsNull(ВО.ДокументПоступления, 0) 	<> 	IsNull(ДвижениеТоваров.ДокументПоступления, 0) 
		|ИЛИ 	IsNull(ВО.Количество, 0) 			<> 	IsNull(ДвижениеТоваров.Количество, 0) 
		|ИЛИ 	IsNull(ВО.ЦенаПрихода, 0) 			<> 	IsNull(ДвижениеТоваров.ЦенаПрихода, 0)
		|ИЛИ 	IsNull(ВО.ДатаПрихода, 0) 			<> 	IsNull(ДвижениеТоваров.ДатаПрихода, 0)
		|ИЛИ 	IsNull(ВО.ВалютаПрихода, 0) 		<>  IsNull(ДвижениеТоваров.ВалютаПрихода, 0)
		|ИЛИ 	IsNull(ВО.ЦенаПослеОплаты, 0) 		<>  IsNull(ДвижениеТоваров.ЦенаПослеОплаты, 0)
		|ИЛИ 	IsNull(ВО.ДатаПлановойОплаты, 0) 	<>  IsNull(ДвижениеТоваров.ДатаПлановойОплаты, 0)
		|  )
		|
		|ИНДЕКСИРОВАТЬ ПО
		|	ВО.Регистратор	
		|;
		//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		// 39. 
		|ВЫБРАТЬ
		|	ВО.Период,
		|	ВО.Регистратор,
		|	ВО.АналитикаУчетаНоменклатуры,
		|	ВО.Поставщик,
		|	ВО.ДокументПоступления,
		|	ВО.Количество,
		|	ВО.ЦенаПрихода,
		|	ВО.ДатаПрихода,
		|	ВО.ДатаПлановойОплаты,
		|   ВО.ВалютаПрихода,
		|	ВО.ЦенаПослеОплаты
		|ИЗ
		|	КешВО КАК ВО
		|	
		|ВНУТРЕННЕЕ СОЕДИНЕНИЕ ДокументыДляЗаписиВО КАК ДокументыДляЗаписи
		|ПО	ДокументыДляЗаписи.Регистратор = ВО.Регистратор
		|
		|ИТОГИ ПО
		|	ДокументПоступления
		|;
		//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ КешВО;
		|УНИЧТОЖИТЬ ДокументыДляЗаписиВО;
		//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		// 42.
		|ВЫБРАТЬ
		|	ОИТ.Период																КАК Период,
		|	ВЫРАЗИТЬ(ОИТ.Регистратор КАК Документ.ОприходованиеИзлишковТоваров)		КАК Регистратор,
		|	ОИТ.АналитикаУчетаНоменклатуры 											КАК АналитикаУчетаНоменклатуры,
		|	ЗНАЧЕНИЕ(Справочник.Партнеры.ПустаяСсылка) 								КАК Поставщик,
		|	ВЫРАЗИТЬ(ОИТ.Регистратор КАК Документ.ОприходованиеИзлишковТоваров)		КАК ДокументПоступления,
		|	ОИТ.КоличествоОборот													КАК Количество,
		|	ВЫРАЗИТЬ(ОИТ.СтоимостьОборот / ОИТ.КоличествоОборот КАК ЧИСЛО(15, 2))	КАК ЦенаПрихода,
		|	ОИТ.Период																КАК ДатаПрихода,
		|	ОИТ.Период																КАК ДатаПлановойОплаты,
		|	&ВалютаУпрУчета															КАК ВалютаПрихода,
		|	ВЫРАЗИТЬ(ОИТ.СтоимостьОборот / ОИТ.КоличествоОборот КАК ЧИСЛО(15, 2))	КАК ЦенаПослеОплаты
		|ПОМЕСТИТЬ КешОИТ	
		|ИЗ
		|	РегистрНакопления.СебестоимостьТоваров.Обороты(&НачалоПериода, &КонецПериода, Регистратор) КАК ОИТ						
		|
		|ГДЕ
		|	Регистратор Ссылка Документ.ОприходованиеИзлишковТоваров
		|	
		|ИНДЕКСИРОВАТЬ ПО
		|	Регистратор,
		|	АналитикаУчетаНоменклатуры	
		|;
		//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		// 43.
		|ВЫБРАТЬ
		|	ОИТ.Регистратор
		|ПОМЕСТИТЬ ДокументыДляЗаписиОИТ		
		|ИЗ
		|	КешОИТ КАК ОИТ
		|		
		|ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.КТС_ДвижениеТоваровПоставщиков КАК ДвижениеТоваров
		|ПО	ВЫРАЗИТЬ(ДвижениеТоваров.Регистратор КАК Документ.ОприходованиеИзлишковТоваров) = ОИТ.Регистратор
		|И	ДвижениеТоваров.АналитикаУчетаНоменклатуры 										= ОИТ.АналитикаУчетаНоменклатуры
		|	
		|ГДЕ
		|		IsNull(ОИТ.Поставщик, 0) 			<> IsNull(ДвижениеТоваров.Поставщик, 0) 
		|ИЛИ 	IsNull(ОИТ.ДокументПоступления, 0) 	<> IsNull(ДвижениеТоваров.ДокументПоступления, 0) 
		|ИЛИ 	IsNull(ОИТ.Количество, 0) 			<> IsNull(ДвижениеТоваров.Количество, 0) 
		|ИЛИ 	IsNull(ОИТ.ЦенаПрихода, 0) 			<> IsNull(ДвижениеТоваров.ЦенаПрихода, 0)
		|ИЛИ 	IsNull(ОИТ.ДатаПрихода, 0) 			<> IsNull(ДвижениеТоваров.ДатаПрихода, 0)
		|ИЛИ 	IsNull(ОИТ.ВалютаПрихода, 0) 		<> IsNull(ДвижениеТоваров.ВалютаПрихода, 0)
		|ИЛИ 	IsNull(ОИТ.ЦенаПослеОплаты, 0) 		<> IsNull(ДвижениеТоваров.ЦенаПослеОплаты, 0)
		|ИЛИ 	IsNull(ОИТ.ДатаПлановойОплаты, 0) 	<> IsNull(ДвижениеТоваров.ДатаПлановойОплаты, 0)
		|
		|ОБЪЕДИНИТЬ 
		|
		|ВЫБРАТЬ
		|	ВЫРАЗИТЬ(ДвижениеТоваров.Регистратор КАК Документ.ОприходованиеИзлишковТоваров)		
		|ИЗ
		|	ДвижениеТоваров КАК ДвижениеТоваров
		|		
		|ЛЕВОЕ СОЕДИНЕНИЕ КешОИТ КАК ОИТ
		|ПО	ОИТ.Регистратор 			   = ВЫРАЗИТЬ(ДвижениеТоваров.Регистратор КАК Документ.ОприходованиеИзлишковТоваров)
		|И	ОИТ.АналитикаУчетаНоменклатуры = ДвижениеТоваров.АналитикаУчетаНоменклатуры
		|
		|ГДЕ
		|	ДвижениеТоваров.Регистратор			Ссылка	Документ.ОприходованиеИзлишковТоваров
		|И (	IsNull(ОИТ.Поставщик, 0) 			<> 	IsNull(ДвижениеТоваров.Поставщик, 0) 
		|ИЛИ 	IsNull(ОИТ.ДокументПоступления, 0) 	<> 	IsNull(ДвижениеТоваров.ДокументПоступления, 0) 
		|ИЛИ 	IsNull(ОИТ.Количество, 0) 			<> 	IsNull(ДвижениеТоваров.Количество, 0) 
		|ИЛИ 	IsNull(ОИТ.ЦенаПрихода, 0) 			<> 	IsNull(ДвижениеТоваров.ЦенаПрихода, 0)
		|ИЛИ 	IsNull(ОИТ.ДатаПрихода, 0) 			<> 	IsNull(ДвижениеТоваров.ДатаПрихода, 0)
		|ИЛИ 	IsNull(ОИТ.ВалютаПрихода, 0) 		<>  IsNull(ДвижениеТоваров.ВалютаПрихода, 0)
		|ИЛИ 	IsNull(ОИТ.ЦенаПослеОплаты, 0) 		<>  IsNull(ДвижениеТоваров.ЦенаПослеОплаты, 0)
		|ИЛИ 	IsNull(ОИТ.ДатаПлановойОплаты, 0) 	<>  IsNull(ДвижениеТоваров.ДатаПлановойОплаты, 0)
		|  )
		|
		|ИНДЕКСИРОВАТЬ ПО
		|	ОИТ.Регистратор	
		|;
		//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		// 44. 
		|ВЫБРАТЬ
		|	ОИТ.Период,
		|	ОИТ.Регистратор,
		|	ОИТ.АналитикаУчетаНоменклатуры,
		|	ОИТ.Поставщик,
		|	ОИТ.ДокументПоступления,
		|	ОИТ.Количество,
		|	ОИТ.ЦенаПрихода,
		|	ОИТ.ДатаПрихода,
		|	ОИТ.ДатаПлановойОплаты,
		|   ОИТ.ВалютаПрихода,
		|	ОИТ.ЦенаПослеОплаты
		|ИЗ
		|	КешОИТ КАК ОИТ
		|	
		|ВНУТРЕННЕЕ СОЕДИНЕНИЕ ДокументыДляЗаписиОИТ КАК ДокументыДляЗаписи
		|ПО	ДокументыДляЗаписи.Регистратор = ОИТ.Регистратор
		|
		|ИТОГИ ПО
		|	ДокументПоступления
		|;
		//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ КешОИТ;
		|УНИЧТОЖИТЬ ДокументыДляЗаписиОИТ;
		//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		// 47.
		|ВЫБРАТЬ
		|	СБ.Период											КАК Период,
		|	ВЫРАЗИТЬ(СБ.Регистратор КАК Документ.СборкаТоваров)	КАК Регистратор,
		|	СБ.АналитикаУчетаНоменклатуры 						КАК АналитикаУчетаНоменклатуры,
		|	ЗНАЧЕНИЕ(Справочник.Партнеры.ПустаяСсылка) 			КАК Поставщик,
		|	ВЫРАЗИТЬ(СБ.Регистратор КАК Документ.СборкаТоваров)	КАК ДокументПоступления,
		|	СБ.КоличествоОборот									КАК Количество,
		|	СБ1.СтоимостьПриход / СБ1.КоличествоПриход			КАК ЦенаПрихода,
		|	СБ.Период											КАК ДатаПрихода,
		|	СБ.Период											КАК ДатаПлановойОплаты,
		|	&ВалютаУпрУчета										КАК ВалютаПрихода,
		|	СБ1.СтоимостьПриход / СБ1.КоличествоПриход			КАК ЦенаПослеОплаты
		|ПОМЕСТИТЬ КешСБ	
		|ИЗ
		|	РегистрНакопления.СебестоимостьТоваров.Обороты(&НачалоПериода, &КонецПериода, Регистратор) КАК СБ
		|
		|ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.СебестоимостьТоваров.Обороты(&НачалоПериода, &КонецПериода) КАК СБ1
		|ПО	СБ1.АналитикаУчетаНоменклатуры = СБ.АналитикаУчетаНоменклатуры	
		|
		|ГДЕ
		|	СБ.Регистратор Ссылка Документ.СборкаТоваров
		|И	СБ.КоличествоОборот > 0
		|	
		|ИНДЕКСИРОВАТЬ ПО
		|	Регистратор,
		|	АналитикаУчетаНоменклатуры	
		|;
		//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		// 48.
		|ВЫБРАТЬ
		|	СБ.Регистратор
		|ПОМЕСТИТЬ ДокументыДляЗаписиСБ		
		|ИЗ
		|	КешСБ КАК СБ
		|		
		|ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.КТС_ДвижениеТоваровПоставщиков КАК ДвижениеТоваров
		|ПО	ВЫРАЗИТЬ(ДвижениеТоваров.Регистратор КАК Документ.СборкаТоваров) = СБ.Регистратор
		|И	ДвижениеТоваров.АналитикаУчетаНоменклатуры 						 = СБ.АналитикаУчетаНоменклатуры
		|
		|ГДЕ
		|		IsNull(СБ.Поставщик, 0) 			<> IsNull(ДвижениеТоваров.Поставщик, 0) 
		|ИЛИ 	IsNull(СБ.ДокументПоступления, 0) 	<> IsNull(ДвижениеТоваров.ДокументПоступления, 0) 
		|ИЛИ 	IsNull(СБ.Количество, 0) 			<> IsNull(ДвижениеТоваров.Количество, 0) 
		|ИЛИ 	IsNull(СБ.ЦенаПрихода, 0) 			<> IsNull(ДвижениеТоваров.ЦенаПрихода, 0)
		|ИЛИ 	IsNull(СБ.ДатаПрихода, 0) 			<> IsNull(ДвижениеТоваров.ДатаПрихода, 0)
		|ИЛИ 	IsNull(СБ.ВалютаПрихода, 0) 		<> IsNull(ДвижениеТоваров.ВалютаПрихода, 0)
		|ИЛИ 	IsNull(СБ.ЦенаПослеОплаты, 0) 		<> IsNull(ДвижениеТоваров.ЦенаПослеОплаты, 0)
		|ИЛИ 	IsNull(СБ.ДатаПлановойОплаты, 0) 	<> IsNull(ДвижениеТоваров.ДатаПлановойОплаты, 0)
		|
		|ОБЪЕДИНИТЬ 
		|
		|ВЫБРАТЬ
		|	ВЫРАЗИТЬ(ДвижениеТоваров.Регистратор КАК Документ.СборкаТоваров)		
		|ИЗ
		|	ДвижениеТоваров КАК ДвижениеТоваров
		|		
		|ЛЕВОЕ СОЕДИНЕНИЕ КешСБ КАК СБ
		|ПО	СБ.Регистратор 			   	  = ВЫРАЗИТЬ(ДвижениеТоваров.Регистратор КАК Документ.СборкаТоваров)
		|И	СБ.АналитикаУчетаНоменклатуры = ДвижениеТоваров.АналитикаУчетаНоменклатуры
		|
		|ГДЕ
		|	ДвижениеТоваров.Регистратор			Ссылка	Документ.СборкаТоваров
		|И (	IsNull(СБ.Поставщик, 0) 			<> 	IsNull(ДвижениеТоваров.Поставщик, 0) 
		|ИЛИ 	IsNull(СБ.ДокументПоступления, 0) 	<> 	IsNull(ДвижениеТоваров.ДокументПоступления, 0) 
		|ИЛИ 	IsNull(СБ.Количество, 0) 			<> 	IsNull(ДвижениеТоваров.Количество, 0) 
		|ИЛИ 	IsNull(СБ.ЦенаПрихода, 0) 			<> 	IsNull(ДвижениеТоваров.ЦенаПрихода, 0)
		|ИЛИ 	IsNull(СБ.ДатаПрихода, 0) 			<> 	IsNull(ДвижениеТоваров.ДатаПрихода, 0)
		|ИЛИ 	IsNull(СБ.ВалютаПрихода, 0) 		<> 	IsNull(ДвижениеТоваров.ВалютаПрихода, 0)
		|ИЛИ 	IsNull(СБ.ЦенаПослеОплаты, 0) 		<> 	IsNull(ДвижениеТоваров.ЦенаПослеОплаты, 0)
		|ИЛИ 	IsNull(СБ.ДатаПлановойОплаты, 0) 	<>  IsNull(ДвижениеТоваров.ДатаПлановойОплаты, 0)
		|  )
		|
		|ИНДЕКСИРОВАТЬ ПО
		|	СБ.Регистратор	
		|;
		//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		// 49. 
		|ВЫБРАТЬ
		|	СБ.Период,
		|	СБ.Регистратор,
		|	СБ.АналитикаУчетаНоменклатуры,
		|	СБ.Поставщик,
		|	СБ.ДокументПоступления,
		|	СБ.Количество,
		|	СБ.ЦенаПрихода,
		|	СБ.ДатаПрихода,
		|	СБ.ДатаПлановойОплаты,
		|   СБ.ВалютаПрихода,
		|	СБ.ЦенаПослеОплаты
		|ИЗ
		|	КешСБ КАК СБ
		|	
		|ВНУТРЕННЕЕ СОЕДИНЕНИЕ ДокументыДляЗаписиСБ КАК ДокументыДляЗаписи
		|ПО	ДокументыДляЗаписи.Регистратор = СБ.Регистратор
		|
		|ИТОГИ ПО
		|	ДокументПоступления
		|;
		//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ КешСБ;
		|УНИЧТОЖИТЬ ДокументыДляЗаписиСБ;
		//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		// 52.
		|ВЫБРАТЬ
		|	ПОТ.Период															КАК Период,
		|	ВЫРАЗИТЬ(ПОТ.Регистратор КАК Документ.ПрочееОприходованиеТоваров)	КАК Регистратор,
		|	ПОТ.АналитикаУчетаНоменклатуры 										КАК АналитикаУчетаНоменклатуры,
		|	ЗНАЧЕНИЕ(Справочник.Партнеры.ПустаяСсылка) 							КАК Поставщик,
		|	ВЫРАЗИТЬ(ПОТ.Регистратор КАК Документ.ПрочееОприходованиеТоваров)	КАК ДокументПоступления,
		|	ПОТ.КоличествоОборот												КАК Количество,
		|	ВЫРАЗИТЬ(ПОТ.СтоимостьОборот/ПОТ.КоличествоОборот КАК ЧИСЛО(15, 2))	КАК ЦенаПрихода,
		|	ПОТ.Период															КАК ДатаПрихода,
		|	ПОТ.Период															КАК ДатаПлановойОплаты,
		|	&ВалютаУпрУчета														КАК ВалютаПрихода,
		|	ВЫРАЗИТЬ(ПОТ.СтоимостьОборот/ПОТ.КоличествоОборот КАК ЧИСЛО(15, 2))	КАК ЦенаПослеОплаты
		|ПОМЕСТИТЬ КешПОТ	
		|ИЗ
		|	РегистрНакопления.СебестоимостьТоваров.Обороты(&НачалоПериода, &КонецПериода, Регистратор) КАК ПОТ						
		|
		|ГДЕ
		|	Регистратор Ссылка Документ.ПрочееОприходованиеТоваров
		|	
		|ИНДЕКСИРОВАТЬ ПО
		|	Регистратор,
		|	АналитикаУчетаНоменклатуры	
		|;
		//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		// 53.
		|ВЫБРАТЬ
		|	ПОТ.Регистратор
		|ПОМЕСТИТЬ ДокументыДляЗаписиПОТ		
		|ИЗ
		|	КешПОТ КАК ПОТ
		|		
		|ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.КТС_ДвижениеТоваровПоставщиков КАК ДвижениеТоваров
		|ПО	ВЫРАЗИТЬ(ДвижениеТоваров.Регистратор КАК Документ.ПрочееОприходованиеТоваров) 	= ПОТ.Регистратор
		|И	ДвижениеТоваров.АналитикаУчетаНоменклатуры 						 				= ПОТ.АналитикаУчетаНоменклатуры
		|
		|ГДЕ
		|		IsNull(ПОТ.Поставщик, 0) 			<> IsNull(ДвижениеТоваров.Поставщик, 0) 
		|ИЛИ 	IsNull(ПОТ.ДокументПоступления, 0) 	<> IsNull(ДвижениеТоваров.ДокументПоступления, 0) 
		|ИЛИ 	IsNull(ПОТ.Количество, 0) 			<> IsNull(ДвижениеТоваров.Количество, 0) 
		|ИЛИ 	IsNull(ПОТ.ЦенаПрихода, 0) 			<> IsNull(ДвижениеТоваров.ЦенаПрихода, 0)
		|ИЛИ 	IsNull(ПОТ.ДатаПрихода, 0) 			<> IsNull(ДвижениеТоваров.ДатаПрихода, 0)
		|ИЛИ 	IsNull(ПОТ.ВалютаПрихода, 0) 		<> 	IsNull(ДвижениеТоваров.ВалютаПрихода, 0)
		|ИЛИ 	IsNull(ПОТ.ЦенаПослеОплаты, 0) 		<> 	IsNull(ДвижениеТоваров.ЦенаПослеОплаты, 0)
		|ИЛИ 	IsNull(ПОТ.ДатаПлановойОплаты, 0) 	<> IsNull(ДвижениеТоваров.ДатаПлановойОплаты, 0)
		|
		|ОБЪЕДИНИТЬ 
		|
		|ВЫБРАТЬ
		|	ВЫРАЗИТЬ(ДвижениеТоваров.Регистратор КАК Документ.ПрочееОприходованиеТоваров)		
		|ИЗ
		|	ДвижениеТоваров КАК ДвижениеТоваров
		|		
		|ЛЕВОЕ СОЕДИНЕНИЕ КешПОТ КАК ПОТ
		|ПО	ПОТ.Регистратор 			   = ВЫРАЗИТЬ(ДвижениеТоваров.Регистратор КАК Документ.ПрочееОприходованиеТоваров)
		|И	ПОТ.АналитикаУчетаНоменклатуры = ДвижениеТоваров.АналитикаУчетаНоменклатуры
		|
		|ГДЕ
		|	ДвижениеТоваров.Регистратор				Ссылка	Документ.ПрочееОприходованиеТоваров
		|И (	IsNull(ПОТ.Поставщик, 0) 			<> 	IsNull(ДвижениеТоваров.Поставщик, 0) 
		|ИЛИ 	IsNull(ПОТ.ДокументПоступления, 0) 	<> 	IsNull(ДвижениеТоваров.ДокументПоступления, 0) 
		|ИЛИ 	IsNull(ПОТ.Количество, 0) 			<> 	IsNull(ДвижениеТоваров.Количество, 0) 
		|ИЛИ 	IsNull(ПОТ.ЦенаПрихода, 0) 			<> 	IsNull(ДвижениеТоваров.ЦенаПрихода, 0)
		|ИЛИ 	IsNull(ПОТ.ДатаПрихода, 0) 			<> 	IsNull(ДвижениеТоваров.ДатаПрихода, 0)
		|ИЛИ 	IsNull(ПОТ.ВалютаПрихода, 0) 		<> 	IsNull(ДвижениеТоваров.ВалютаПрихода, 0)
		|ИЛИ 	IsNull(ПОТ.ЦенаПослеОплаты, 0) 		<> 	IsNull(ДвижениеТоваров.ЦенаПослеОплаты, 0)
		|ИЛИ 	IsNull(ПОТ.ДатаПлановойОплаты, 0) 	<>  IsNull(ДвижениеТоваров.ДатаПлановойОплаты, 0)
		|  )
		|
		|ИНДЕКСИРОВАТЬ ПО
		|	ПОТ.Регистратор	
		|;
		//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		// 54. 
		|ВЫБРАТЬ
		|	ПОТ.Период,
		|	ПОТ.Регистратор,
		|	ПОТ.АналитикаУчетаНоменклатуры,
		|	ПОТ.Поставщик,
		|	ПОТ.ДокументПоступления,
		|	ПОТ.Количество,
		|	ПОТ.ЦенаПрихода,
		|	ПОТ.ДатаПрихода,
		|	ПОТ.ДатаПлановойОплаты,
		|   ПОТ.ВалютаПрихода,
		|	ПОТ.ЦенаПослеОплаты
		|ИЗ
		|	КешПОТ КАК ПОТ
		|	
		|ВНУТРЕННЕЕ СОЕДИНЕНИЕ ДокументыДляЗаписиПОТ КАК ДокументыДляЗаписи
		|ПО	ДокументыДляЗаписи.Регистратор = ПОТ.Регистратор
		|
		|ИТОГИ ПО
		|	ДокументПоступления
		|;
		//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ КешПОТ;
		//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ ТаблицаКурсов;
		//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ ДокументыДляЗаписиПОТ;
		|";
	Возврат ТекстЗапроса;

КонецФункции // ПолучитьТекстЗапросаДвиженияПьриход()

Функция ПолучитьТекстЗапросаНачальныеДвижения()
	
	ТекстЗапроса = "
		//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		//0.
		|ВЫБРАТЬ 
		|	&НачалоПериода					КАК Период,
		|	АналитикаУчетаНоменклатуры		КАК АналитикаУчетаНоменклатуры,
		|	Поставщик						КАК Поставщик,
		|	ДокументПоступления				КАК ДокументПоступления,
		|	КоличествоОстаток				КАК Количество	
		|ПОМЕСТИТЬ ОстаткиТоваровПоставщиков
		|ИЗ
		|	РегистрНакопления.КТС_ДвижениеТоваровПоставщиков.Остатки(&НачалоПериода) КАК ДвижениеТоваров
		|
		|ОБЪЕДИНИТЬ
		|
		|ВЫБРАТЬ
		|	Период,
		|	АналитикаУчетаНоменклатуры,
		|	Поставщик,
		|	ДокументПоступления,
		|	Количество	
		|ИЗ
		|	РегистрНакопления.КТС_ДвижениеТоваровПоставщиков КАК ДвижениеТоваров	
		|ГДЕ
		|	ДвижениеТоваров.Период 		>= &НачалоПериода
		|И	ДвижениеТоваров.Период 		<= &КонецПериода
		|И	ДвижениеТоваров.ВидДвижения  = Значение(ВидДвиженияНакопления.Приход)
		|И (	
		|		ДвижениеТоваров.Регистратор Ссылка Документ.ВводОстатков
		|ИЛИ	ДвижениеТоваров.Регистратор Ссылка Документ.СборкаТоваров
		|ИЛИ	ДвижениеТоваров.Регистратор Ссылка Документ.ВозвратТоваровОтКлиента
		|ИЛИ	ДвижениеТоваров.Регистратор Ссылка Документ.ПоступлениеТоваровУслуг
		|ИЛИ	ДвижениеТоваров.Регистратор Ссылка Документ.ПрочееОприходованиеТоваров
		|ИЛИ	ДвижениеТоваров.Регистратор Ссылка Документ.ОприходованиеИзлишковТоваров
		|  )
		|
		|ОБЪЕДИНИТЬ
		|
		|ВЫБРАТЬ
		|	Период,
		|	АналитикаУчетаНоменклатуры,
		|	Неопределено,
		|	Регистратор,
		|	КоличествоОборот		
		|ИЗ
		|	РегистрНакопления.СебестоимостьТоваров.Обороты(&НачалоПериода, &КонецПериода, Регистратор) 
		|ГДЕ
		|	Регистратор Ссылка Документ.ПеремещениеТоваров
		|И	КоличествоОборот > 0
		|;
		//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		//1.
		|ВЫБРАТЬ
		|	ОстаткиТоваровПоставщиков.Период 						КАК Период,
		|	ОстаткиТоваровПоставщиков.АналитикаУчетаНоменклатуры	КАК АналитикаУчетаНоменклатуры,
		|	ОстаткиТоваровПоставщиков.Поставщик						КАК Поставщик,
		|	ОстаткиТоваровПоставщиков.ДокументПоступления   		КАК ДокументПоступления,
		|	СУММА(ОстаткиТоваровПоставщиковКопия.Количество)    									КАК КоличествоПосле,
		|	СУММА(ОстаткиТоваровПоставщиковКопия.Количество) - ОстаткиТоваровПоставщиков.Количество КАК КоличествоДо
		|ПОМЕСТИТЬ ОстаткиТоваровПоставщиковНаростающие
		|ИЗ
		|	ОстаткиТоваровПоставщиков КАК ОстаткиТоваровПоставщиков
		|		
		|ВНУТРЕННЕЕ СОЕДИНЕНИЕ ОстаткиТоваровПоставщиков КАК ОстаткиТоваровПоставщиковКопия
		|ПО 	ОстаткиТоваровПоставщиковКопия.АналитикаУчетаНоменклатуры = ОстаткиТоваровПоставщиков.АналитикаУчетаНоменклатуры
		|И	ВЫБОР
		|		КОГДА ОстаткиТоваровПоставщиковКопия.Период 			 = 	ОстаткиТоваровПоставщиков.Период
		|		ТОГДА ОстаткиТоваровПоставщиковКопия.ДокументПоступления <= ОстаткиТоваровПоставщиков.ДокументПоступления
		|		ИНАЧЕ ОстаткиТоваровПоставщиковКопия.Период 			 <=	ОстаткиТоваровПоставщиков.Период
		|	КОНЕЦ
		|				
		|СГРУППИРОВАТЬ ПО
		|	ОстаткиТоваровПоставщиков.Период,
		|	ОстаткиТоваровПоставщиков.АналитикаУчетаНоменклатуры,
		|	ОстаткиТоваровПоставщиков.Поставщик,
		|	ОстаткиТоваровПоставщиков.ДокументПоступления,
		|	ОстаткиТоваровПоставщиков.Количество	
		|;
		//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		//2.
		|ВЫБРАТЬ
		|	РТиУ.Период						КАК Период,
		|	РТиУ.Регистратор				КАК Регистратор,
		|	РТиУ.АналитикаУчетаНоменклатуры	КАК АналитикаУчетаНоменклатуры,
		|	РТиУ.КоличествоОборот			КАК Количество
		|ПОМЕСТИТЬ ДвиженияТоваров	
		|ИЗ
		|	РегистрНакопления.ВыручкаИСебестоимостьПродаж.Обороты(&НачалоПериода, &КонецПериода, Регистратор) КАК РТиУ
		|ГДЕ
		|	РТиУ.Регистратор Ссылка Документ.РеализацияТоваровУслуг
		|
		|ОБЪЕДИНИТЬ
		|
		|ВЫБРАТЬ
		|	Период,
		|	Регистратор,
		|	АналитикаУчетаНоменклатуры,
		|	-КоличествоОборот		
		|ИЗ
		|	РегистрНакопления.СебестоимостьТоваров.Обороты(&НачалоПериода, &КонецПериода, Регистратор) 
		|ГДЕ
		|	 Регистратор Ссылка Документ.ВозвратТоваровПоставщику
		|ИЛИ Регистратор Ссылка Документ.СписаниеНедостачТоваров
		|ИЛИ Регистратор Ссылка Документ.ВнутреннееПотреблениеТоваров
		|
		|ОБЪЕДИНИТЬ
		|
		|ВЫБРАТЬ
		|	Период,
		|	Регистратор,
		|	АналитикаУчетаНоменклатуры,
		|	-КоличествоОборот		
		|ИЗ
		|	РегистрНакопления.СебестоимостьТоваров.Обороты(&НачалоПериода, &КонецПериода, Регистратор) 
		|ГДЕ
		|	Регистратор Ссылка Документ.СборкаТоваров
		|И	КоличествоОборот < 0
		|
		|ОБЪЕДИНИТЬ
		|
		|ВЫБРАТЬ
		|	Период,
		|	Регистратор,
		|	АналитикаУчетаНоменклатуры,
		|	-КоличествоОборот		
		|ИЗ
		|	РегистрНакопления.СебестоимостьТоваров.Обороты(&НачалоПериода, &КонецПериода, Регистратор) 
		|ГДЕ
		|	Регистратор Ссылка Документ.ПеремещениеТоваров
		|И	КоличествоОборот < 0
		|;	
		//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		//3.
		|ВЫБРАТЬ
		|	ДвиженияТоваров.Период 												КАК Период,
		|	ДвиженияТоваров.Регистратор											КАК Регистратор,
		|	ДвиженияТоваров.АналитикаУчетаНоменклатуры							КАК АналитикаУчетаНоменклатуры,
		|	СУММА(ДвиженияТоваровКопия.Количество)    							КАК КоличествоПосле,
		|	СУММА(ДвиженияТоваровКопия.Количество) - ДвиженияТоваров.Количество КАК КоличествоДо
		|ПОМЕСТИТЬ ДвиженияТоваровНаростающие
		|ИЗ
		|	ДвиженияТоваров КАК ДвиженияТоваров
		|		
		|ВНУТРЕННЕЕ СОЕДИНЕНИЕ ДвиженияТоваров КАК ДвиженияТоваровКопия
		|ПО 	ДвиженияТоваровКопия.АналитикаУчетаНоменклатуры = ДвиженияТоваров.АналитикаУчетаНоменклатуры
		|И	ВЫБОР
		|		КОГДА ДвиженияТоваровКопия.Период 		 = ДвиженияТоваров.Период
		|		ТОГДА ДвиженияТоваровКопия.Регистратор 	<= ДвиженияТоваров.Регистратор
		|		ИНАЧЕ ДвиженияТоваровКопия.Период 		<= ДвиженияТоваров.Период
		|	КОНЕЦ
		|				
		|СГРУППИРОВАТЬ ПО
		|	ДвиженияТоваров.Период,
		|	ДвиженияТоваров.Регистратор,
		|	ДвиженияТоваров.АналитикаУчетаНоменклатуры,
		|	ДвиженияТоваров.Количество	
		|;
		//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		//4. Точки по аналитике
		|ВЫБРАТЬ
		|	АналитикаУчетаНоменклатуры	КАК АналитикаУчетаНоменклатуры,
		|	КоличествоПосле 			КАК Точка
		|ПОМЕСТИТЬ ТочкиАналитики		
		|ИЗ
		|	ОстаткиТоваровПоставщиковНаростающие
		|	
		|ОБЪЕДИНИТЬ
		|
		|ВЫБРАТЬ
		|	АналитикаУчетаНоменклатуры,
		|	КоличествоПосле		
		|ИЗ
		|	ДвиженияТоваровНаростающие		
		|;
		//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		//5.	
		|ВЫБРАТЬ
		|	ДвиженияТоваровНаростающие.Период,	
		|   ДвиженияТоваровНаростающие.Регистратор,
		|	ТочкиАналитики.АналитикаУчетаНоменклатуры,
		|	ОстаткиТоваровПоставщиковНаростающие.Поставщик,
		|	ОстаткиТоваровПоставщиковНаростающие.ДокументПоступления,
		|	ТочкиАналитики.Точка - ВЫБОР
		|								КОГДА ДвиженияТоваровНаростающие.КоличествоДо < ОстаткиТоваровПоставщиковНаростающие.КоличествоДо
		|								ТОГДА ОстаткиТоваровПоставщиковНаростающие.КоличествоДо
		|								ИНАЧЕ ДвиженияТоваровНаростающие.КоличествоДо
		|							КОНЕЦ КАК Количество
		|ПОМЕСТИТЬ КешПервогоУровня				
		|ИЗ
		|	ТочкиАналитики КАК ТочкиАналитики
		|
		|ВНУТРЕННЕЕ СОЕДИНЕНИЕ ОстаткиТоваровПоставщиковНаростающие КАК ОстаткиТоваровПоставщиковНаростающие
		|ПО	ОстаткиТоваровПоставщиковНаростающие.АналитикаУчетаНоменклатуры = 	ТочкиАналитики.АналитикаУчетаНоменклатуры
		|И  ОстаткиТоваровПоставщиковНаростающие.КоличествоПосле 			>= 	ТочкиАналитики.Точка
		|И  ОстаткиТоваровПоставщиковНаростающие.КоличествоДо 				< 	ТочкиАналитики.Точка
		|
		|ВНУТРЕННЕЕ СОЕДИНЕНИЕ ДвиженияТоваровНаростающие КАК ДвиженияТоваровНаростающие
		|ПО	ДвиженияТоваровНаростающие.АналитикаУчетаНоменклатуры 	= 	ТочкиАналитики.АналитикаУчетаНоменклатуры
		|И  ДвиженияТоваровНаростающие.КоличествоПосле 				>= 	ТочкиАналитики.Точка
		|И  ДвиженияТоваровНаростающие.КоличествоДо 				< 	ТочкиАналитики.Точка
		|
		|;
		//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ ОстаткиТоваровПоставщиковНаростающие;
		|УНИЧТОЖИТЬ ДвиженияТоваров;
		|УНИЧТОЖИТЬ ТочкиАналитики;
		//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		//11.
		|ВЫБРАТЬ
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)									КАК ВидДвижения, 
		|	КешПервогоУровня.Период													КАК Период,
		|	ВЫРАЗИТЬ(КешПервогоУровня.Регистратор КАК Документ.ПеремещениеТоваров) 	КАК Регистратор,
		|	КешПервогоУровня.АналитикаУчетаНоменклатуры								КАК АналитикаУчетаНоменклатуры,
		|	КешПервогоУровня.Поставщик												КАК Поставщик,
		|	КешПервогоУровня.ДокументПоступления									КАК ДокументПоступления,
		|	КешПервогоУровня.Количество												КАК Количество	
		|ПОМЕСТИТЬ КешВторогоУровня
		|ИЗ
		|	КешПервогоУровня КАК КешПервогоУровня	
		|ГДЕ
		|	КешПервогоУровня.Регистратор Ссылка Документ.ПеремещениеТоваров
		|И (	
		| 		КешПервогоУровня.ДокументПоступления Ссылка Документ.ВводОстатков
		|ИЛИ	КешПервогоУровня.ДокументПоступления Ссылка Документ.СборкаТоваров
		|ИЛИ	КешПервогоУровня.ДокументПоступления Ссылка Документ.ВозвратТоваровОтКлиента
		|ИЛИ	КешПервогоУровня.ДокументПоступления Ссылка Документ.ПоступлениеТоваровУслуг 
		|ИЛИ	КешПервогоУровня.ДокументПоступления Ссылка Документ.ПрочееОприходованиеТоваров
		|ИЛИ	КешПервогоУровня.ДокументПоступления Ссылка Документ.ОприходованиеИзлишковТоваров
		| )
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход),
		|	КешПервогоУровня.Период,
		|	ВЫРАЗИТЬ(КешПервогоУровня.Регистратор КАК Документ.ПеремещениеТоваров),
		|	СБ.АналитикаУчетаНоменклатуры,
		|	КешПервогоУровня.Поставщик,
		|	КешПервогоУровня.ДокументПоступления,
		|	КешПервогоУровня.Количество		
		|ИЗ
		|	РегистрНакопления.СебестоимостьТоваров.Обороты(&НачалоПериода, &КонецПериода, Регистратор) КАК СБ
		|
		|ВНУТРЕННЕЕ СОЕДИНЕНИЕ КешПервогоУровня КАК КешПервогоУровня
		|ПО	ВЫРАЗИТЬ(КешПервогоУровня.Регистратор КАК Документ.ПеремещениеТоваров) = ВЫРАЗИТЬ(СБ.Регистратор КАК Документ.ПеремещениеТоваров)
		|И	КешПервогоУровня.АналитикаУчетаНоменклатуры.Номенклатура = СБ.АналитикаУчетаНоменклатуры.Номенклатура
		|И (
		|		КешПервогоУровня.ДокументПоступления Ссылка Документ.ВводОстатков
		|ИЛИ	КешПервогоУровня.ДокументПоступления Ссылка Документ.СборкаТоваров
		|ИЛИ	КешПервогоУровня.ДокументПоступления Ссылка Документ.ВозвратТоваровОтКлиента
		|ИЛИ	КешПервогоУровня.ДокументПоступления Ссылка Документ.ПоступлениеТоваровУслуг
		|ИЛИ	КешПервогоУровня.ДокументПоступления Ссылка Документ.ПрочееОприходованиеТоваров
		|ИЛИ	КешПервогоУровня.ДокументПоступления Ссылка Документ.ОприходованиеИзлишковТоваров 
		|  )
		|
		|ГДЕ
		|	СБ.Регистратор Ссылка Документ.ПеремещениеТоваров
		|И	СБ.КоличествоОборот > 0
		|;";
	Возврат ТекстЗапроса;
	
КонецФункции // ПолучитьТекстЗапросаНачальныеДвиженияПеремещений()

Функция ПолучитьТекстЗапросаРекурсивныеДвижения()
	
	ТекстЗапроса = "
		//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		//0. 
		|ВЫБРАТЬ
		|	ОТП.Период,
		|	ОТП.АналитикаУчетаНоменклатуры,
		|	IsNull(КешВторогоУровня.Поставщик, ОТП.Поставщик)						КАК Поставщик,
		|	IsNull(КешВторогоУровня.ДокументПоступления, ОТП.ДокументПоступления) 	КАК ДокументПоступления,
		|	IsNull(КешВторогоУровня.Количество, ОТП.Количество)						КАК Количество
		|ПОМЕСТИТЬ ДополненыеОТП
		|ИЗ
		|	ОстаткиТоваровПоставщиков КАК ОТП
		|
		|ЛЕВОЕ СОЕДИНЕНИЕ КешВторогоУровня КАК КешВторогоУровня
		|ПО	КешВторогоУровня.Регистратор = ВЫРАЗИТЬ(ОТП.ДокументПоступления КАК Документ.ПеремещениеТоваров)
		|И	КешВторогоУровня.АналитикаУчетаНоменклатуры.Номенклатура = ОТП.АналитикаУчетаНоменклатуры.Номенклатура
		|И	КешВторогоУровня.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
		|;
		//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ КешПервогоУровня;
		|УНИЧТОЖИТЬ КешВторогоУровня;
		|УНИЧТОЖИТЬ ОстаткиТоваровПоставщиков;
		//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		//4.
		|ВЫБРАТЬ
		|	*
		|ПОМЕСТИТЬ ОстаткиТоваровПоставщиков	
		|ИЗ
		|	ДополненыеОТП
		|;
		//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ ДополненыеОТП;
		//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		//6.
		|ВЫБРАТЬ
		|	ОстаткиТоваровПоставщиков.Период 						КАК Период,
		|	ОстаткиТоваровПоставщиков.АналитикаУчетаНоменклатуры	КАК АналитикаУчетаНоменклатуры,
		|	ОстаткиТоваровПоставщиков.Поставщик						КАК Поставщик,
		|	ОстаткиТоваровПоставщиков.ДокументПоступления   		КАК ДокументПоступления,
		|	СУММА(ОстаткиТоваровПоставщиковКопия.Количество)    									КАК КоличествоПосле,
		|	СУММА(ОстаткиТоваровПоставщиковКопия.Количество) - ОстаткиТоваровПоставщиков.Количество КАК КоличествоДо
		|ПОМЕСТИТЬ ОстаткиТоваровПоставщиковНаростающие
		|ИЗ
		|	ОстаткиТоваровПоставщиков КАК ОстаткиТоваровПоставщиков
		|		
		|ВНУТРЕННЕЕ СОЕДИНЕНИЕ ОстаткиТоваровПоставщиков КАК ОстаткиТоваровПоставщиковКопия
		|ПО 	ОстаткиТоваровПоставщиковКопия.АналитикаУчетаНоменклатуры = ОстаткиТоваровПоставщиков.АналитикаУчетаНоменклатуры
		|И	ВЫБОР
		|		КОГДА ОстаткиТоваровПоставщиковКопия.Период 			 = 	ОстаткиТоваровПоставщиков.Период
		|		ТОГДА ОстаткиТоваровПоставщиковКопия.ДокументПоступления <= ОстаткиТоваровПоставщиков.ДокументПоступления
		|		ИНАЧЕ ОстаткиТоваровПоставщиковКопия.Период 			 <=	ОстаткиТоваровПоставщиков.Период
		|	КОНЕЦ
		|				
		|СГРУППИРОВАТЬ ПО
		|	ОстаткиТоваровПоставщиков.Период,
		|	ОстаткиТоваровПоставщиков.АналитикаУчетаНоменклатуры,
		|	ОстаткиТоваровПоставщиков.Поставщик,
		|	ОстаткиТоваровПоставщиков.ДокументПоступления,
		|	ОстаткиТоваровПоставщиков.Количество	
		|;		
		//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		//7. Точки по аналитике
		|ВЫБРАТЬ
		|	АналитикаУчетаНоменклатуры	КАК АналитикаУчетаНоменклатуры,
		|	КоличествоПосле 			КАК Точка
		|ПОМЕСТИТЬ ТочкиАналитики		
		|ИЗ
		|	ОстаткиТоваровПоставщиковНаростающие
		|	
		|ОБЪЕДИНИТЬ
		|
		|ВЫБРАТЬ
		|	АналитикаУчетаНоменклатуры,
		|	КоличествоПосле		
		|ИЗ
		|	ДвиженияТоваровНаростающие		
		|;
		//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		//8.
		|ВЫБРАТЬ
		|	ДвиженияТоваровНаростающие.Период,	
		|	ДвиженияТоваровНаростающие.Регистратор,
		|	ТочкиАналитики.АналитикаУчетаНоменклатуры,
		|	ОстаткиТоваровПоставщиковНаростающие.Поставщик,
		|	ОстаткиТоваровПоставщиковНаростающие.ДокументПоступления,
		|	СУММА(ТочкиАналитики.Точка - ВЫБОР
		|								КОГДА ДвиженияТоваровНаростающие.КоличествоДо < ОстаткиТоваровПоставщиковНаростающие.КоличествоДо
		|								ТОГДА ОстаткиТоваровПоставщиковНаростающие.КоличествоДо
		|								ИНАЧЕ ДвиженияТоваровНаростающие.КоличествоДо
		|							КОНЕЦ) КАК Количество
		|ПОМЕСТИТЬ КешПервогоУровня				
		|ИЗ
		|	ТочкиАналитики КАК ТочкиАналитики
		|
		|ВНУТРЕННЕЕ СОЕДИНЕНИЕ ОстаткиТоваровПоставщиковНаростающие КАК ОстаткиТоваровПоставщиковНаростающие
		|ПО	ОстаткиТоваровПоставщиковНаростающие.АналитикаУчетаНоменклатуры = 	ТочкиАналитики.АналитикаУчетаНоменклатуры
		|И   ОстаткиТоваровПоставщиковНаростающие.КоличествоПосле 			>= 	ТочкиАналитики.Точка
		|И   ОстаткиТоваровПоставщиковНаростающие.КоличествоДо 				< 	ТочкиАналитики.Точка
		|
		|ВНУТРЕННЕЕ СОЕДИНЕНИЕ ДвиженияТоваровНаростающие КАК ДвиженияТоваровНаростающие
		|ПО	ДвиженияТоваровНаростающие.АналитикаУчетаНоменклатуры 	= 	ТочкиАналитики.АналитикаУчетаНоменклатуры
		|И   ДвиженияТоваровНаростающие.КоличествоПосле 				>= 	ТочкиАналитики.Точка
		|И   ДвиженияТоваровНаростающие.КоличествоДо 				< 	ТочкиАналитики.Точка
		|
		|СГРУППИРОВАТЬ ПО
		|	ДвиженияТоваровНаростающие.Период,	
		|	ДвиженияТоваровНаростающие.Регистратор,
		|	ТочкиАналитики.АналитикаУчетаНоменклатуры,
		|	ОстаткиТоваровПоставщиковНаростающие.Поставщик,
		|	ОстаткиТоваровПоставщиковНаростающие.ДокументПоступления
		|;
		//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ ОстаткиТоваровПоставщиковНаростающие;
		|УНИЧТОЖИТЬ ТочкиАналитики;
		//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		//11.
		|ВЫБРАТЬ
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)									КАК ВидДвижения, 
		|	КешПервогоУровня.Период													КАК Период,
		|	ВЫРАЗИТЬ(КешПервогоУровня.Регистратор КАК Документ.ПеремещениеТоваров) 	КАК Регистратор,
		|	КешПервогоУровня.АналитикаУчетаНоменклатуры								КАК АналитикаУчетаНоменклатуры,
		|	КешПервогоУровня.Поставщик												КАК Поставщик,
		|	КешПервогоУровня.ДокументПоступления									КАК ДокументПоступления,
		|	КешПервогоУровня.Количество												КАК Количество	
		|ПОМЕСТИТЬ КешВторогоУровня
		|ИЗ
		|	КешПервогоУровня КАК КешПервогоУровня	
		|ГДЕ
		|	КешПервогоУровня.Регистратор Ссылка Документ.ПеремещениеТоваров
		|И (	
		| 		КешПервогоУровня.ДокументПоступления Ссылка Документ.ВводОстатков
		|ИЛИ	КешПервогоУровня.ДокументПоступления Ссылка Документ.СборкаТоваров
		|ИЛИ	КешПервогоУровня.ДокументПоступления Ссылка Документ.ВозвратТоваровОтКлиента
		|ИЛИ	КешПервогоУровня.ДокументПоступления Ссылка Документ.ПоступлениеТоваровУслуг
		|ИЛИ	КешПервогоУровня.ДокументПоступления Ссылка Документ.ПрочееОприходованиеТоваров
		|ИЛИ	КешПервогоУровня.ДокументПоступления Ссылка Документ.ОприходованиеИзлишковТоваров
		| )
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход),
		|	КешПервогоУровня.Период,
		|	ВЫРАЗИТЬ(КешПервогоУровня.Регистратор КАК Документ.ПеремещениеТоваров),
		|	СБ.АналитикаУчетаНоменклатуры,
		|	КешПервогоУровня.Поставщик,
		|	КешПервогоУровня.ДокументПоступления,
		|	КешПервогоУровня.Количество		
		|ИЗ
		|	РегистрНакопления.СебестоимостьТоваров.Обороты(&НачалоПериода, &КонецПериода, Регистратор) КАК СБ
		|
		|ВНУТРЕННЕЕ СОЕДИНЕНИЕ КешПервогоУровня КАК КешПервогоУровня
		|ПО	ВЫРАЗИТЬ(КешПервогоУровня.Регистратор КАК Документ.ПеремещениеТоваров) = ВЫРАЗИТЬ(СБ.Регистратор КАК Документ.ПеремещениеТоваров)
		|И	КешПервогоУровня.АналитикаУчетаНоменклатуры.Номенклатура = СБ.АналитикаУчетаНоменклатуры.Номенклатура
		|И (
		|		КешПервогоУровня.ДокументПоступления Ссылка Документ.ВводОстатков
		|ИЛИ	КешПервогоУровня.ДокументПоступления Ссылка Документ.СборкаТоваров
		|ИЛИ	КешПервогоУровня.ДокументПоступления Ссылка Документ.ВозвратТоваровОтКлиента
		|ИЛИ	КешПервогоУровня.ДокументПоступления Ссылка Документ.ПоступлениеТоваровУслуг
		|ИЛИ	КешПервогоУровня.ДокументПоступления Ссылка Документ.ПрочееОприходованиеТоваров
		|ИЛИ	КешПервогоУровня.ДокументПоступления Ссылка Документ.ОприходованиеИзлишковТоваров 
		|  )
		|
		|ГДЕ
		|	СБ.Регистратор Ссылка Документ.ПеремещениеТоваров
		|И	СБ.КоличествоОборот > 0
		|;";
	Возврат ТекстЗапроса;
	
КонецФункции // ПолучитьТекстЗапросаРекурсивныеДвижения() 

Функция ПолучитьТекстЗапросаДвиженийРасход()
	
	ТекстЗапроса = "
		//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		//Z0.
		|ВЫБРАТЬ
		|	*
		|ИЗ
		|	КешВторогоУровня	
		|ИТОГИ ПО
		|	Регистратор
		|;
		//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ КешВторогоУровня;
		//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		//Z2.
		|ВЫБРАТЬ
		|	*
		|ПОМЕСТИТЬ ДвижениеТоваров
		|ИЗ
		|	РегистрНакопления.КТС_ДвижениеТоваровПоставщиков КАК ДвижениеТоваров	
		|ГДЕ
		|	ДвижениеТоваров.Период 		>= &НачалоПериода
		|И	ДвижениеТоваров.Период 		<= &КонецПериода
		|И	ДвижениеТоваров.ВидДвижения  = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
		|;	
		//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		//Z3.
		|ВЫБРАТЬ
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)							КАК ВидДвижения,
		|	РТиУ.Период														КАК Период,
		|	ВЫРАЗИТЬ(РТиУ.Регистратор КАК Документ.РеализацияТоваровУслуг)	КАК Регистратор,
		|	РТиУ.АналитикаУчетаНоменклатуры 								КАК АналитикаУчетаНоменклатуры,
		|	РТиУ.Поставщик						 							КАК Поставщик,
		|	РТиУ.ДокументПоступления										КАК ДокументПоступления,
		|	РТиУ.Количество													КАК Количество
		|ПОМЕСТИТЬ КешРТиУ							
		|ИЗ
		|	КешПервогоУровня КАК РТиУ						
		|
		|ГДЕ
		|	Регистратор Ссылка Документ.РеализацияТоваровУслуг
		|	
		|ИНДЕКСИРОВАТЬ ПО
		|	Регистратор,
		|	АналитикаУчетаНоменклатуры	
		|;
		//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		//Z4.
		|ВЫБРАТЬ
		|	РТиУ.Регистратор
		|ПОМЕСТИТЬ ДокументыДляЗаписиРТиУ		
		|ИЗ
		|	КешРТиУ КАК РТиУ
		|		
		|ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.КТС_ДвижениеТоваровПоставщиков КАК ДвижениеТоваров
		|ПО	ВЫРАЗИТЬ(ДвижениеТоваров.Регистратор КАК Документ.РеализацияТоваровУслуг) 	= РТиУ.Регистратор
		|И	ДвижениеТоваров.АналитикаУчетаНоменклатуры 						 			= РТиУ.АналитикаУчетаНоменклатуры
		|
		|ГДЕ
		|		IsNull(РТиУ.Поставщик, 0) 			<> IsNull(ДвижениеТоваров.Поставщик, 0)  
		|ИЛИ	IsNull(РТиУ.ДокументПоступления, 0) <> IsNull(ДвижениеТоваров.ДокументПоступления, 0) 
		|ИЛИ	IsNull(РТиУ.Количество, 0) 			<> IsNull(ДвижениеТоваров.Количество, 0) 
		|
		|ОБЪЕДИНИТЬ 
		|
		|ВЫБРАТЬ
		|	ВЫРАЗИТЬ(ДвижениеТоваров.Регистратор КАК Документ.РеализацияТоваровУслуг)		
		|ИЗ
		|	ДвижениеТоваров КАК ДвижениеТоваров
		|		
		|ЛЕВОЕ СОЕДИНЕНИЕ КешРТиУ КАК РТиУ
		|ПО	РТиУ.Регистратор 			   	= ВЫРАЗИТЬ(ДвижениеТоваров.Регистратор КАК Документ.РеализацияТоваровУслуг)
		|И	РТиУ.АналитикаУчетаНоменклатуры = ДвижениеТоваров.АналитикаУчетаНоменклатуры
		|
		|ГДЕ
		|	ДвижениеТоваров.Регистратор			Ссылка	Документ.РеализацияТоваровУслуг
		|И (	IsNull(РТиУ.Поставщик, 0) 			<> 	IsNull(ДвижениеТоваров.Поставщик, 0)
		|ИЛИ	IsNull(РТиУ.ДокументПоступления, 0) <> 	IsNull(ДвижениеТоваров.ДокументПоступления, 0) 
		|ИЛИ	IsNull(РТиУ.Количество, 0) 			<> 	IsNull(ДвижениеТоваров.Количество, 0)
		|  ) 
		|
		|ИНДЕКСИРОВАТЬ ПО
		|	РТиУ.Регистратор	
		|;
		////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		//Z5. 
		|ВЫБРАТЬ
		|	РТиУ.ВидДвижения,
		|	РТиУ.Период,
		|	РТиУ.Регистратор,
		|	РТиУ.АналитикаУчетаНоменклатуры,
		|	РТиУ.Поставщик,
		|	РТиУ.ДокументПоступления,
		|	РТиУ.Количество
		|ИЗ
		|	КешРТиУ КАК РТиУ
		|	
		|ВНУТРЕННЕЕ СОЕДИНЕНИЕ ДокументыДляЗаписиРТиУ КАК ДокументыДляЗаписи
		|ПО	ДокументыДляЗаписи.Регистратор = РТиУ.Регистратор
		|
		|ИТОГИ ПО
		|	РТиУ.Регистратор
		|;
		//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ КешРТиУ;
		|УНИЧТОЖИТЬ ДокументыДляЗаписиРТиУ;
		//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		//Z8.
		|ВЫБРАТЬ
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)				КАК ВидДвижения,
		|	СТ.Период											КАК Период,
		|	ВЫРАЗИТЬ(СТ.Регистратор КАК Документ.СборкаТоваров)	КАК Регистратор,
		|	СТ.АналитикаУчетаНоменклатуры 						КАК АналитикаУчетаНоменклатуры,
		|	СТ.Поставщик						 				КАК Поставщик,
		|	СТ.ДокументПоступления								КАК ДокументПоступления,
		|	СТ.Количество										КАК Количество
		|ПОМЕСТИТЬ КешСТ							
		|ИЗ
		|	КешПервогоУровня КАК СТ						
		|
		|ГДЕ
		|	Регистратор Ссылка Документ.СборкаТоваров
		|	
		|ИНДЕКСИРОВАТЬ ПО
		|	Регистратор,
		|	АналитикаУчетаНоменклатуры	
		|;
		//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		//Z9.
		|ВЫБРАТЬ
		|	СТ.Регистратор
		|ПОМЕСТИТЬ ДокументыДляЗаписиСТ		
		|ИЗ
		|	КешСТ КАК СТ
		|		
		|ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.КТС_ДвижениеТоваровПоставщиков КАК ДвижениеТоваров
		|ПО	ВЫРАЗИТЬ(ДвижениеТоваров.Регистратор КАК Документ.СборкаТоваров) = СТ.Регистратор
		|И	ДвижениеТоваров.АналитикаУчетаНоменклатуры 						 = СТ.АналитикаУчетаНоменклатуры
		|
		|ГДЕ
		|		IsNull(СТ.Поставщик, 0) 			<> IsNull(ДвижениеТоваров.Поставщик, 0)
		|ИЛИ	IsNull(СТ.ДокументПоступления, 0) 	<> IsNull(ДвижениеТоваров.ДокументПоступления, 0) 
		|ИЛИ	IsNull(СТ.Количество, 0) 			<> IsNull(ДвижениеТоваров.Количество, 0) 
		|
		|ОБЪЕДИНИТЬ 
		|
		|ВЫБРАТЬ
		|	ВЫРАЗИТЬ(ДвижениеТоваров.Регистратор КАК Документ.СборкаТоваров)		
		|ИЗ
		|	ДвижениеТоваров КАК ДвижениеТоваров
		|		
		|ЛЕВОЕ СОЕДИНЕНИЕ КешСТ КАК СТ
		|ПО	СТ.Регистратор 			   		= ВЫРАЗИТЬ(ДвижениеТоваров.Регистратор КАК Документ.СборкаТоваров)
		|И	СТ.АналитикаУчетаНоменклатуры 	= ДвижениеТоваров.АналитикаУчетаНоменклатуры
		|
		|ГДЕ
		|	ДвижениеТоваров.Регистратор			Ссылка	Документ.СборкаТоваров
		|И (	IsNull(СТ.Поставщик, 0) 			<> 	IsNull(ДвижениеТоваров.Поставщик, 0) 
		|ИЛИ	IsNull(СТ.ДокументПоступления, 0) 	<> 	IsNull(ДвижениеТоваров.ДокументПоступления, 0) 
		|ИЛИ	IsNull(СТ.Количество, 0) 			<> 	IsNull(ДвижениеТоваров.Количество, 0)
		|  ) 
		|
		|ИНДЕКСИРОВАТЬ ПО
		|	СТ.Регистратор	
		|;
		////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		//Z10. 
		|ВЫБРАТЬ
		|	СТ.ВидДвижения,
		|	СТ.Период,
		|	СТ.Регистратор,
		|	СТ.АналитикаУчетаНоменклатуры,
		|	СТ.Поставщик,
		|	СТ.ДокументПоступления,
		|	СТ.Количество,
		|	0					КАК ЦенаПрихода,
		|	ДАТАВРЕМЯ(1, 1, 1) 	КАК ДатаПрихода,
		|	Неопределено		КАК ВалютаПрихода,
		|	ДАТАВРЕМЯ(1, 1, 1) 	КАК ДатаПлановойОплаты,
		|	0					КАК ЦенаПослеОплаты
		|ИЗ
		|	КешСТ КАК СТ
		|	
		|ВНУТРЕННЕЕ СОЕДИНЕНИЕ ДокументыДляЗаписиСТ КАК ДокументыДляЗаписи
		|ПО	ДокументыДляЗаписи.Регистратор = СТ.Регистратор
		|
		|ОБЪЕДИНИТЬ 
		|
		|ВЫБРАТЬ
		|	ДвижениеТоваров.ВидДвижения,
		|	ДвижениеТоваров.Период,
		|	ВЫРАЗИТЬ(ДвижениеТоваров.Регистратор КАК Документ.СборкаТоваров),
		|	ДвижениеТоваров.АналитикаУчетаНоменклатуры,
		|	ДвижениеТоваров.Поставщик,
		|	ДвижениеТоваров.ДокументПоступления,
		|	ДвижениеТоваров.Количество,
		|	ДвижениеТоваров.ЦенаПрихода,
		|	ДвижениеТоваров.ДатаПрихода,
		|	ДвижениеТоваров.ВалютаПрихода,
		|	ДвижениеТоваров.ДатаПлановойОплаты,
		|	ДвижениеТоваров.ЦенаПослеОплаты
		|ИЗ
		|	РегистрНакопления.КТС_ДвижениеТоваровПоставщиков КАК ДвижениеТоваров
		|
		|ВНУТРЕННЕЕ СОЕДИНЕНИЕ ДокументыДляЗаписиСТ КАК ДокументыДляЗаписи
		|ПО	ДокументыДляЗаписи.Регистратор = ВЫРАЗИТЬ(ДвижениеТоваров.Регистратор КАК Документ.СборкаТоваров)
		|
		|ГДЕ
		|	ДвижениеТоваров.Регистратор	 Ссылка	Документ.СборкаТоваров
		|И	ДвижениеТоваров.ВидДвижения  = Значение(ВидДвиженияНакопления.Приход)		
		|
		|ИТОГИ ПО
		|	СТ.Регистратор
		|;
		//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ КешСТ;
		|УНИЧТОЖИТЬ ДокументыДляЗаписиСТ;
		//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		//Z13.
		|ВЫБРАТЬ
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)							КАК ВидДвижения,
		|	ВТП.Период														КАК Период,
		|	ВЫРАЗИТЬ(ВТП.Регистратор КАК Документ.ВозвратТоваровПоставщику)	КАК Регистратор,
		|	ВТП.АналитикаУчетаНоменклатуры 									КАК АналитикаУчетаНоменклатуры,
		|	ВТП.Поставщик						 							КАК Поставщик,
		|	ВТП.ДокументПоступления											КАК ДокументПоступления,
		|	ВТП.Количество													КАК Количество
		|ПОМЕСТИТЬ КешВТП							
		|ИЗ
		|	КешПервогоУровня КАК ВТП						
		|
		|ГДЕ
		|	Регистратор Ссылка Документ.ВозвратТоваровПоставщику
		|	
		|ИНДЕКСИРОВАТЬ ПО
		|	Регистратор,
		|	АналитикаУчетаНоменклатуры	
		|;
		//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		//Z14.
		|ВЫБРАТЬ
		|	ВТП.Регистратор
		|ПОМЕСТИТЬ ДокументыДляЗаписиВТП		
		|ИЗ
		|	КешВТП КАК ВТП
		|		
		|ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.КТС_ДвижениеТоваровПоставщиков КАК ДвижениеТоваров
		|ПО	ВЫРАЗИТЬ(ДвижениеТоваров.Регистратор КАК Документ.ВозвратТоваровПоставщику) = ВТП.Регистратор
		|И	ДвижениеТоваров.АналитикаУчетаНоменклатуры 						 			= ВТП.АналитикаУчетаНоменклатуры
		|
		|ГДЕ
		|		IsNull(ВТП.Поставщик, 0) 			<> IsNull(ДвижениеТоваров.Поставщик, 0)  
		|ИЛИ	IsNull(ВТП.ДокументПоступления, 0) 	<> IsNull(ДвижениеТоваров.ДокументПоступления, 0) 
		|ИЛИ	IsNull(ВТП.Количество, 0) 			<> IsNull(ДвижениеТоваров.Количество, 0) 
		|
		|ОБЪЕДИНИТЬ 
		|
		|ВЫБРАТЬ
		|	ВЫРАЗИТЬ(ДвижениеТоваров.Регистратор КАК Документ.ВозвратТоваровПоставщику)		
		|ИЗ
		|	ДвижениеТоваров КАК ДвижениеТоваров
		|		
		|ЛЕВОЕ СОЕДИНЕНИЕ КешВТП КАК ВТП
		|ПО	ВТП.Регистратор 			   	= ВЫРАЗИТЬ(ДвижениеТоваров.Регистратор КАК Документ.ВозвратТоваровПоставщику)
		|И	ВТП.АналитикаУчетаНоменклатуры 	= ДвижениеТоваров.АналитикаУчетаНоменклатуры
		|
		|ГДЕ
		|	ДвижениеТоваров.Регистратор			Ссылка	Документ.ВозвратТоваровПоставщику
		|И (	IsNull(ВТП.Поставщик, 0) 			<> 	IsNull(ДвижениеТоваров.Поставщик, 0) 
		|ИЛИ	IsNull(ВТП.ДокументПоступления, 0) 	<> 	IsNull(ДвижениеТоваров.ДокументПоступления, 0) 
		|ИЛИ	IsNull(ВТП.Количество, 0) 			<> 	IsNull(ДвижениеТоваров.Количество, 0)
		|  ) 
		|
		|ИНДЕКСИРОВАТЬ ПО
		|	ВТП.Регистратор	
		|;
		////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		//Z15. 
		|ВЫБРАТЬ
		|	ВТП.ВидДвижения,
		|	ВТП.Период,
		|	ВТП.Регистратор,
		|	ВТП.АналитикаУчетаНоменклатуры,
		|	ВТП.Поставщик,
		|	ВТП.ДокументПоступления,
		|	ВТП.Количество
		|ИЗ
		|	КешВТП КАК ВТП
		|	
		|ВНУТРЕННЕЕ СОЕДИНЕНИЕ ДокументыДляЗаписиВТП КАК ДокументыДляЗаписи
		|ПО	ДокументыДляЗаписи.Регистратор = ВТП.Регистратор
		|
		|ИТОГИ ПО
		|	ВТП.Регистратор
		|;
		//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ КешВТП;
		|УНИЧТОЖИТЬ ДокументыДляЗаписиВТП;
		//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		//Z18.
		|ВЫБРАТЬ
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)							КАК ВидДвижения,
		|	СНТ.Период														КАК Период,
		|	ВЫРАЗИТЬ(СНТ.Регистратор КАК Документ.СписаниеНедостачТоваров)	КАК Регистратор,
		|	СНТ.АналитикаУчетаНоменклатуры 									КАК АналитикаУчетаНоменклатуры,
		|	СНТ.Поставщик						 							КАК Поставщик,
		|	СНТ.ДокументПоступления											КАК ДокументПоступления,
		|	СНТ.Количество													КАК Количество
		|ПОМЕСТИТЬ КешСНТ							
		|ИЗ
		|	КешПервогоУровня КАК СНТ						
		|
		|ГДЕ
		|	Регистратор Ссылка Документ.СписаниеНедостачТоваров
		|	
		|ИНДЕКСИРОВАТЬ ПО
		|	Регистратор,
		|	АналитикаУчетаНоменклатуры	
		|;
		//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		//Z19.
		|ВЫБРАТЬ
		|	СНТ.Регистратор
		|ПОМЕСТИТЬ ДокументыДляЗаписиСНТ		
		|ИЗ
		|	КешСНТ КАК СНТ
		|		
		|ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.КТС_ДвижениеТоваровПоставщиков КАК ДвижениеТоваров
		|ПО	ВЫРАЗИТЬ(ДвижениеТоваров.Регистратор КАК Документ.СписаниеНедостачТоваров) 	= СНТ.Регистратор
		|И	ДвижениеТоваров.АналитикаУчетаНоменклатуры 						 			= СНТ.АналитикаУчетаНоменклатуры
		|
		|ГДЕ
		|		IsNull(СНТ.Поставщик, 0) 			<> IsNull(ДвижениеТоваров.Поставщик, 0) 
		|ИЛИ	IsNull(СНТ.ДокументПоступления, 0) 	<> IsNull(ДвижениеТоваров.ДокументПоступления, 0) 
		|ИЛИ	IsNull(СНТ.Количество, 0) 			<> IsNull(ДвижениеТоваров.Количество, 0) 
		|
		|ОБЪЕДИНИТЬ 
		|
		|ВЫБРАТЬ
		|	ВЫРАЗИТЬ(ДвижениеТоваров.Регистратор КАК Документ.СписаниеНедостачТоваров)		
		|ИЗ
		|	ДвижениеТоваров КАК ДвижениеТоваров
		|		
		|ЛЕВОЕ СОЕДИНЕНИЕ КешСНТ КАК СНТ
		|ПО	СНТ.Регистратор 			   	= ВЫРАЗИТЬ(ДвижениеТоваров.Регистратор КАК Документ.СписаниеНедостачТоваров)
		|И	СНТ.АналитикаУчетаНоменклатуры 	= ДвижениеТоваров.АналитикаУчетаНоменклатуры
		|
		|ГДЕ
		|	ДвижениеТоваров.Регистратор			Ссылка	Документ.СписаниеНедостачТоваров
		|И (	IsNull(СНТ.Поставщик, 0) 			<> 	IsNull(ДвижениеТоваров.Поставщик, 0) 
		|ИЛИ	IsNull(СНТ.ДокументПоступления, 0) 	<> 	IsNull(ДвижениеТоваров.ДокументПоступления, 0) 
		|ИЛИ	IsNull(СНТ.Количество, 0) 			<> 	IsNull(ДвижениеТоваров.Количество, 0)
		|  ) 
		|
		|ИНДЕКСИРОВАТЬ ПО
		|	СНТ.Регистратор	
		|;
		////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		//Z20. 
		|ВЫБРАТЬ
		|	СНТ.ВидДвижения,
		|	СНТ.Период,
		|	СНТ.Регистратор,
		|	СНТ.АналитикаУчетаНоменклатуры,
		|	СНТ.Поставщик,
		|	СНТ.ДокументПоступления,
		|	СНТ.Количество
		|ИЗ
		|	КешСНТ КАК СНТ
		|	
		|ВНУТРЕННЕЕ СОЕДИНЕНИЕ ДокументыДляЗаписиСНТ КАК ДокументыДляЗаписи
		|ПО	ДокументыДляЗаписи.Регистратор = СНТ.Регистратор
		|
		|ИТОГИ ПО
		|	СНТ.Регистратор
		|;
		//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ КешСНТ;
		|УНИЧТОЖИТЬ ДокументыДляЗаписиСНТ;
		//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		//Z23.
		|ВЫБРАТЬ
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)								КАК ВидДвижения,
		|	ВПТ.Период															КАК Период,
		|	ВЫРАЗИТЬ(ВПТ.Регистратор КАК Документ.ВнутреннееПотреблениеТоваров)	КАК Регистратор,
		|	ВПТ.АналитикаУчетаНоменклатуры 										КАК АналитикаУчетаНоменклатуры,
		|	ВПТ.Поставщик						 								КАК Поставщик,
		|	ВПТ.ДокументПоступления												КАК ДокументПоступления,
		|	ВПТ.Количество														КАК Количество
		|ПОМЕСТИТЬ КешВПТ							
		|ИЗ
		|	КешПервогоУровня КАК ВПТ						
		|
		|ГДЕ
		|	Регистратор Ссылка Документ.ВнутреннееПотреблениеТоваров
		|	
		|ИНДЕКСИРОВАТЬ ПО
		|	Регистратор,
		|	АналитикаУчетаНоменклатуры	
		|;
		//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		//Z24.
		|ВЫБРАТЬ
		|	ВПТ.Регистратор
		|ПОМЕСТИТЬ ДокументыДляЗаписиВПТ		
		|ИЗ
		|	КешВПТ КАК ВПТ
		|		
		|ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.КТС_ДвижениеТоваровПоставщиков КАК ДвижениеТоваров
		|ПО	ВЫРАЗИТЬ(ДвижениеТоваров.Регистратор КАК Документ.ВнутреннееПотреблениеТоваров) = ВПТ.Регистратор
		|И	ДвижениеТоваров.АналитикаУчетаНоменклатуры 						 				= ВПТ.АналитикаУчетаНоменклатуры
		|
		|ГДЕ
		|		IsNull(ВПТ.Поставщик, 0) 			<> IsNull(ДвижениеТоваров.Поставщик, 0) 
		|ИЛИ	IsNull(ВПТ.ДокументПоступления, 0) 	<> IsNull(ДвижениеТоваров.ДокументПоступления, 0) 
		|ИЛИ	IsNull(ВПТ.Количество, 0) 			<> IsNull(ДвижениеТоваров.Количество, 0) 
		|
		|ОБЪЕДИНИТЬ 
		|
		|ВЫБРАТЬ
		|	ВЫРАЗИТЬ(ДвижениеТоваров.Регистратор КАК Документ.ВнутреннееПотреблениеТоваров)		
		|ИЗ
		|	ДвижениеТоваров КАК ДвижениеТоваров
		|		
		|ЛЕВОЕ СОЕДИНЕНИЕ КешВПТ КАК ВПТ
		|ПО	ВПТ.Регистратор 			   	= ВЫРАЗИТЬ(ДвижениеТоваров.Регистратор КАК Документ.ВнутреннееПотреблениеТоваров)
		|И	ВПТ.АналитикаУчетаНоменклатуры 	= ДвижениеТоваров.АналитикаУчетаНоменклатуры
		|
		|ГДЕ
		|	ДвижениеТоваров.Регистратор			Ссылка	Документ.ВнутреннееПотреблениеТоваров
		|И (	IsNull(ВПТ.Поставщик, 0) 			<> 	IsNull(ДвижениеТоваров.Поставщик, 0) 
		|ИЛИ	IsNull(ВПТ.ДокументПоступления, 0) 	<> 	IsNull(ДвижениеТоваров.ДокументПоступления, 0) 
		|ИЛИ	IsNull(ВПТ.Количество, 0) 			<> 	IsNull(ДвижениеТоваров.Количество, 0)
		|  ) 
		|
		|ИНДЕКСИРОВАТЬ ПО
		|	ВПТ.Регистратор	
		|;
		////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		//Z25. 
		|ВЫБРАТЬ
		|	ВПТ.ВидДвижения,
		|	ВПТ.Период,
		|	ВПТ.Регистратор,
		|	ВПТ.АналитикаУчетаНоменклатуры,
		|	ВПТ.Поставщик,
		|	ВПТ.ДокументПоступления,
		|	ВПТ.Количество
		|ИЗ
		|	КешВПТ КАК ВПТ
		|	
		|ВНУТРЕННЕЕ СОЕДИНЕНИЕ ДокументыДляЗаписиВПТ КАК ДокументыДляЗаписи
		|ПО	ДокументыДляЗаписи.Регистратор = ВПТ.Регистратор
		|
		|ИТОГИ ПО
		|	ВПТ.Регистратор
		|;
		//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ КешВПТ;
		|УНИЧТОЖИТЬ ДокументыДляЗаписиВПТ;
		|УНИЧТОЖИТЬ КешПервогоУровня;
		|УНИЧТОЖИТЬ ДвижениеТоваров;
		|";
	Возврат ТекстЗапроса;
	
КонецФункции // ПолучитьТекстЗапросаДвиженийРасход() 

Функция ПроверитьКонечностьПартий(МенеджерВременныхТаблиц, Попытки)
	
	Запрос = Новый Запрос;
	Запрос.МенеджерВременныхТаблиц = МенеджерВременныхТаблиц;
	Запрос.Текст = "
		|ВЫБРАТЬ ПЕРВЫЕ 1
		|	АналитикаУчетаНоменклатуры,
		|	ДокументПоступления
		|ИЗ
		|	КешПервогоУровня
		|ГДЕ
		|	ДокументПоступления Ссылка Документ.ПеремещениеТоваров
		|";
	Попытки = Попытки + 1;
	Если Попытки = 20 Тогда
		Выгрузка = Запрос.Выполнить().Выгрузить();
		ВызватьИсключение Выгрузка[0].АналитикаУчетаНоменклатуры.Номенклатура.Код + "/" + Выгрузка[0].АналитикаУчетаНоменклатуры.Склад;
	КонецЕсли; 
	Возврат НЕ Запрос.Выполнить().Пустой();
	
КонецФункции // ПроверитьКонечностьПартий()





// Сведения о внешней обработке

Функция СведенияОВнешнейОбработке() Экспорт
	
	//Версия
	Версия = "2.1.3";            
	
	// Объявим переменную, в которой мы сохраним и вернем "наружу" необходимые данные
    ПараметрыРегистрации = Новый Структура;

    // Объявим еще одну переменную, которая нам потребуется ниже
    МассивНазначений = Новый Массив;
    
    // Первый параметр, который мы должны указать - это какой вид обработки системе должна зарегистрировать. 
    // Допустимые типы: ДополнительнаяОбработка, ДополнительныйОтчет, ЗаполнениеОбъекта, Отчет, ПечатнаяФорма, СозданиеСвязанныхОбъектов
    ПараметрыРегистрации.Вставить("Вид", "ДополнительнаяОбработка");	
	ПараметрыРегистрации.Вставить("Назначение", Новый Массив);
    
    // Теперь зададим имя, под которым ВПФ будет зарегистрирована в справочнике внешних обработок
    ПараметрыРегистрации.Вставить("Наименование", "Движение товаров поставщиков");
    
    // Зададим право обработке на использование безопасного режима. Более подробно можно узнать в справке к платформе (метод УстановитьБезопасныйРежим)
    ПараметрыРегистрации.Вставить("БезопасныйРежим", Ложь);

    // Следующие два параметра играют больше информационную роль, т.е. это то, что будет видеть пользователь в информации к обработке
    ПараметрыРегистрации.Вставить("Версия", Версия);    
    ПараметрыРегистрации.Вставить("Информация", "Движение товаров поставщиков [" + Версия + "]");
    
    // Создадим таблицу команд (подробнее смотрим ниже)
    ТаблицаКоманд = ПолучитьТаблицуКоманд();
    
    // Добавим команду в таблицу
    ДобавитьКоманду(ТаблицаКоманд, "Движение товаров поставщиков [" + Версия + "]", "Движение товаров поставщиков", "ОткрытиеФормы", Ложь, "Движение товаров поставщиков");
	ДобавитьКоманду(ТаблицаКоманд, "Регл. обновление движений по партиям [" + Версия + "]", "ВыполнитьДвиженияПоПартиям();", "ВызовСерверногоМетода");
    
    // Сохраним таблицу команд в параметры регистрации обработки
    ПараметрыРегистрации.Вставить("Команды", ТаблицаКоманд);
    
    // Теперь вернем системе наши параметры
    Возврат ПараметрыРегистрации;
	
КонецФункции

Функция ПолучитьТаблицуКоманд()

   // Создадим пустую таблицу команд и колонки в ней
   Команды = Новый ТаблицаЗначений;

   // Как будет выглядеть описание печатной формы для пользователя
   Команды.Колонки.Добавить("Представление", Новый ОписаниеТипов("Строка")); 

   // Имя нашего макета, что бы могли отличить вызванную команду в обработке печати
   Команды.Колонки.Добавить("Идентификатор", Новый ОписаниеТипов("Строка"));

   // Тут задается, как должна вызваться команда обработки
   // Возможные варианты:
   // - ОткрытиеФормы - в этом случае в колонке идентификатор должно быть указано имя формы, которое должна будет открыть система
   // - ВызовКлиентскогоМетода - вызвать клиентскую экспортную процедуру из модуля формы обработки
   // - ВызовСерверногоМетода - вызвать серверную экспортную процедуру из модуля объекта обработки
   Команды.Колонки.Добавить("Использование", Новый ОписаниеТипов("Строка"));

   // Следующий параметр указывает, необходимо ли показывать оповещение при начале и завершению работы обработки. Не имеет смысла при открытии формы
   Команды.Колонки.Добавить("ПоказыватьОповещение", Новый ОписаниеТипов("Булево"));

   // Для печатной формы должен содержать строку ПечатьMXL 
   Команды.Колонки.Добавить("Модификатор", Новый ОписаниеТипов("Строка"));
   
   Возврат Команды;
   
КонецФункции

Процедура ДобавитьКоманду(ТаблицаКоманд, Представление, Идентификатор, Использование, ПоказыватьОповещение = Ложь, Модификатор = "")
	
  // Добавляем команду в таблицу команд по переданному описанию.
  // Параметры и их значения можно посмотреть в функции ПолучитьТаблицуКоманд
  НоваяКоманда = ТаблицаКоманд.Добавить();
  НоваяКоманда.Представление = Представление;
  НоваяКоманда.Идентификатор = Идентификатор;
  НоваяКоманда.Использование = Использование;
  НоваяКоманда.ПоказыватьОповещение = ПоказыватьОповещение;
  НоваяКоманда.Модификатор = Модификатор;

КонецПроцедуры

Процедура ВыполнитьКоманду(ИдентификаторКоманды) Экспорт
	Если ТипЗнч(ИдентификаторКоманды) = Тип("Строка") Тогда
		Выполнить(ИдентификаторКоманды);
	КонецЕсли;
КонецПроцедуры
