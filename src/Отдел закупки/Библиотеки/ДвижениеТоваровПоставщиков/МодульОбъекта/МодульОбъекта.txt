
////////////////////////////////////////////////////////////////////////////////
// ПРОГРАММНЫЙ ИНТЕРФЕЙС

Процедура ВыполнитьДвиженияПоПартиям(Дата) Экспорт
	
	ДатаНачала = Дата;
	ДатаОкончания = КонецМесяца(ДатаНачала) + 1;
	
	Пока ДатаНачала <> ДатаОкончания Цикл	
		ВыполнитьДвиженияПриход_1(ДатаНачала);
		ВыполнитьДвиженияРасход_1(ДатаНачала);
		ДатаНачала = КонецМесяца(ДатаНачала) + 1;
	КонецЦикла;
	
КонецПроцедуры



////////////////////////////////////////////////////////////////////////////////
// СЛУЖЕБНЫЕ ПРОЦЕДУРЫ И ФУНКЦИИ

Процедура ВыполнитьДвиженияПриход_1(Дата)

	Запрос 			= Новый Запрос;
	Запрос.Текст    = ПолучитьТекстЗапросаДвиженияПриход();
	Запрос.УстановитьПараметр("НачалоПериода", 	НачалоДня(Дата));
	Запрос.УстановитьПараметр("КонецПериода", 	КонецМесяца(Дата));
	РезультатПакета = Запрос.ВыполнитьПакет();
	
	Индекс = 3;
	НаборЗаписей = РегистрыНакопления.КТС_ДвижениеТоваровПоставщиков.СоздатьНаборЗаписей();
	Пока Индекс < 24 Цикл

		РезультатЗапроса = РезультатПакета[Индекс];
		Если РезультатЗапроса.Пустой() = Ложь Тогда
			
			ВыборкаДокументы = РезультатЗапроса.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
			Пока ВыборкаДокументы.Следующий() Цикл
				НаборЗаписей.Отбор.Регистратор.Установить(ВыборкаДокументы.ДокументПоступления);
				ВыборкаДетальныеЗаписи = ВыборкаДокументы.Выбрать();
				Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
					Запись = НаборЗаписей.Добавить();
					ЗаполнитьЗначенияСвойств(Запись, ВыборкаДетальныеЗаписи);
				КонецЦикла;
				НаборЗаписей.Записать();
				НаборЗаписей.Очистить();		
			КонецЦикла;
			
		КонецЕсли;
		
		Индекс = Индекс + 5;
		
	КонецЦикла;
 

КонецПроцедуры

Процедура ВыполнитьДвиженияРасход_1(Дата)
	
	Запрос = Новый Запрос;
	МенеджерВременныхТаблиц = Новый МенеджерВременныхТаблиц;
	Запрос.МенеджерВременныхТаблиц = МенеджерВременныхТаблиц;
	Запрос.Текст = ПолучитьТекстЗапросаНачальныеДвижения();
	Запрос.УстановитьПараметр("НачалоПериода", НачалоДня(Дата));
	Запрос.УстановитьПараметр("КонецПериода", КонецМесяца(Дата));
	РезультатЗапроса = Запрос.Выполнить();
	
	Запрос.Текст = ПолучитьТекстЗапросаРекурсивныеДвижения();
	Пока ПроверитьКонечностьПартий(МенеджерВременныхТаблиц) Цикл
		Запрос.Выполнить();		
	КонецЦикла;
	
	
	Запрос.Текст = ПолучитьТекстЗапросаДвиженийРасход();
	РезультатПакета = Запрос.ВыполнитьПакет();
	
	
	Индекс = 0;
	НаборЗаписей = РегистрыНакопления.КТС_ДвижениеТоваровПоставщиков.СоздатьНаборЗаписей();
	Пока Индекс <= 25 Цикл

		РезультатЗапроса = РезультатПакета[Индекс];
		Если РезультатЗапроса.Пустой() = Ложь Тогда
			
			ВыборкаДокументы = РезультатЗапроса.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
			Пока ВыборкаДокументы.Следующий() Цикл
				НаборЗаписей.Отбор.Регистратор.Установить(ВыборкаДокументы.Регистратор);
				ВыборкаДетальныеЗаписи = ВыборкаДокументы.Выбрать();
				Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
					Запись = НаборЗаписей.Добавить();
					ЗаполнитьЗначенияСвойств(Запись, ВыборкаДетальныеЗаписи);
				КонецЦикла;
				НаборЗаписей.Записать();
				НаборЗаписей.Очистить();		
			КонецЦикла;
			
		КонецЕсли;
		
		Индекс = Индекс + 5;
		
	КонецЦикла;

	МенеджерВременныхТаблиц.Закрыть();
		
КонецПроцедуры



Функция ПолучитьТекстЗапросаДвиженияПриход()

	ТекстЗапроса = "
		//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		//0.
		|ВЫБРАТЬ
		|	*
		|ПОМЕСТИТЬ ДвижениеТоваров
		|ИЗ
		|	РегистрНакопления.КТС_ДвижениеТоваровПоставщиков КАК ДвижениеТоваров	
		|ГДЕ
		|	ДвижениеТоваров.Период 		>= &НачалоПериода
		|И	ДвижениеТоваров.Период 		<= &КонецПериода
		|И	ДвижениеТоваров.ВидДвижения  = Значение(ВидДвиженияНакопления.Приход)
		|;
		//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		//1.
		|ВЫБРАТЬ
		|	ПТиУ.Период																КАК Период,
		|	ВЫРАЗИТЬ(ПТиУ.Регистратор КАК Документ.ПоступлениеТоваровУслуг)			КАК Регистратор,
		|	ПТиУ.АналитикаУчетаНоменклатуры 										КАК АналитикаУчетаНоменклатуры,
		|	ВЫРАЗИТЬ(ПТиУ.Регистратор КАК Документ.ПоступлениеТоваровУслуг).Партнер КАК Поставщик,
		|	ВЫРАЗИТЬ(ПТиУ.Регистратор КАК Документ.ПоступлениеТоваровУслуг)			КАК ДокументПоступления,
		|	ПТиУ.КоличествоОборот													КАК Количество,
		|	ВЫРАЗИТЬ(ПТиУ.СтоимостьОборот / ПТиУ.КоличествоОборот КАК ЧИСЛО(15, 2))	КАК ЦенаПрихода,
		|	ПТиУ.Период																КАК ДатаПрихода
		|ПОМЕСТИТЬ КешПТиУ	
		|ИЗ
		|	РегистрНакопления.СебестоимостьТоваров.Обороты(&НачалоПериода, &КонецПериода, Регистратор) КАК ПТиУ						
		|
		|ГДЕ
		|	Регистратор Ссылка Документ.ПоступлениеТоваровУслуг
		|	
		|ИНДЕКСИРОВАТЬ ПО
		|	Регистратор,
		|	АналитикаУчетаНоменклатуры	
		|;
		//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		//2.
		|ВЫБРАТЬ
		|	ПТиУ.Регистратор
		|ПОМЕСТИТЬ ДокументыДляЗаписиПТиУ		
		|ИЗ
		|	КешПТиУ КАК ПТиУ
		|		
		|ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.КТС_ДвижениеТоваровПоставщиков КАК ДвижениеТоваров
		|ПО	ВЫРАЗИТЬ(ДвижениеТоваров.Регистратор КАК Документ.ПоступлениеТоваровУслуг) 	= ПТиУ.Регистратор
		|И	ДвижениеТоваров.АналитикаУчетаНоменклатуры 									= ПТиУ.АналитикаУчетаНоменклатуры
		|
		|ГДЕ
		|	 	IsNull(ПТиУ.Поставщик, 0) 			<> IsNull(ДвижениеТоваров.Поставщик, 0) 
		|ИЛИ 	IsNull(ПТиУ.ДокументПоступления, 0)	<> IsNull(ДвижениеТоваров.ДокументПоступления, 0) 
		|ИЛИ 	IsNull(ПТиУ.Количество, 0) 			<> IsNull(ДвижениеТоваров.Количество, 0) 
		|ИЛИ 	IsNull(ПТиУ.ЦенаПрихода, 0) 		<> IsNull(ДвижениеТоваров.ЦенаПрихода, 0)
		|ИЛИ 	IsNull(ПТиУ.ДатаПрихода, 0) 		<> IsNull(ДвижениеТоваров.ДатаПрихода, 0)
		|
		|ОБЪЕДИНИТЬ 
		|
		|ВЫБРАТЬ
		|	ВЫРАЗИТЬ(ДвижениеТоваров.Регистратор КАК Документ.ПоступлениеТоваровУслуг)		
		|ИЗ
		|	ДвижениеТоваров КАК ДвижениеТоваров
		|		
		|ЛЕВОЕ СОЕДИНЕНИЕ КешПТиУ КАК ПТиУ
		|ПО	ПТиУ.Регистратор 				= ВЫРАЗИТЬ(ДвижениеТоваров.Регистратор КАК Документ.ПоступлениеТоваровУслуг)
		|И	ПТиУ.АналитикаУчетаНоменклатуры = ДвижениеТоваров.АналитикаУчетаНоменклатуры
		|
		|ГДЕ
		|	ДвижениеТоваров.Регистратор			Ссылка	Документ.ПоступлениеТоваровУслуг
		|И (	IsNull(ПТиУ.Поставщик, 0) 			<> 	IsNull(ДвижениеТоваров.Поставщик, 0) 
		|ИЛИ 	IsNull(ПТиУ.ДокументПоступления, 0) <> 	IsNull(ДвижениеТоваров.ДокументПоступления, 0) 
		|ИЛИ 	IsNull(ПТиУ.Количество, 0) 			<> 	IsNull(ДвижениеТоваров.Количество, 0) 
		|ИЛИ 	IsNull(ПТиУ.ЦенаПрихода, 0) 		<> 	IsNull(ДвижениеТоваров.ЦенаПрихода, 0)
		|ИЛИ 	IsNull(ПТиУ.ДатаПрихода, 0) 		<> 	IsNull(ДвижениеТоваров.ДатаПрихода, 0)
		|  )
		|
		|ИНДЕКСИРОВАТЬ ПО
		|	ПТиУ.Регистратор	
		|;
		//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		//3. 
		|ВЫБРАТЬ
		|	ПТиУ.Период,
		|	ПТиУ.Регистратор,
		|	ПТиУ.АналитикаУчетаНоменклатуры,
		|	ПТиУ.Поставщик,
		|	ПТиУ.ДокументПоступления,
		|	ПТиУ.Количество,
		|	ПТиУ.ЦенаПрихода,
		|	ПТиУ.ДатаПрихода
		|ИЗ
		|	КешПТиУ КАК ПТиУ
		|	
		|ВНУТРЕННЕЕ СОЕДИНЕНИЕ ДокументыДляЗаписиПТиУ КАК ДокументыДляЗаписи
		|ПО	ДокументыДляЗаписи.Регистратор = ПТиУ.Регистратор
		|
		|ИТОГИ ПО
		|	ДокументПоступления
		|;
		//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ КешПТиУ;
		|УНИЧТОЖИТЬ ДокументыДляЗаписиПТиУ;
		//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		//6.
		|ВЫБРАТЬ
		|	ВТоК.Период														КАК Период,
		|	ВЫРАЗИТЬ(ВТоК.Регистратор КАК Документ.ВозвратТоваровОтКлиента)	КАК Регистратор,
		|	ВТоК.АналитикаУчетаНоменклатуры 								КАК АналитикаУчетаНоменклатуры,
		|	ЗНАЧЕНИЕ(Справочник.Партнеры.ПустаяСсылка) 						КАК Поставщик,
		|	ВЫРАЗИТЬ(ВТоК.Регистратор КАК Документ.ВозвратТоваровОтКлиента)	КАК ДокументПоступления,
		|	ВТоК.КоличествоОборот											КАК Количество,
		//|	ВЫРАЗИТЬ(ВТоК.СуммаВыручкиОборот / ВТоК.КоличествоОборот КАК ЧИСЛО(15, 2))	КАК ЦенаПрихода,
		|	IsNull(СтоимостьТоваров.Стоимость, 0) 							КАК ЦенаПрихода,	
		|	ВТоК.Период														КАК ДатаПрихода
		|ПОМЕСТИТЬ КешВТоК	
		|ИЗ
		|	РегистрНакопления.СебестоимостьТоваров.Обороты(&НачалоПериода, &КонецПериода, Регистратор) КАК ВТоК						
		|
		|ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.СтоимостьТоваров КАК СтоимостьТоваров
		|ПО	СтоимостьТоваров.Период						= НАЧАЛОПЕРИОДА(ВТоК.Период, МЕСЯЦ)
		|И	СтоимостьТоваров.АналитикаУчетаНоменклатуры = ВТоК.АналитикаУчетаНоменклатуры
		|И	СтоимостьТоваров.Организация				= ВТоК.Организация
		|
		|ГДЕ
		|	ВТоК.Регистратор Ссылка Документ.ВозвратТоваровОтКлиента
		|	
		|ИНДЕКСИРОВАТЬ ПО
		|	Регистратор,
		|	АналитикаУчетаНоменклатуры	
		|;
		//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		//7.
		|ВЫБРАТЬ
		|	ВТоК.Регистратор
		|ПОМЕСТИТЬ ДокументыДляЗаписиВТоК		
		|ИЗ
		|	КешВТоК КАК ВТоК
		|		
		|ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.КТС_ДвижениеТоваровПоставщиков КАК ДвижениеТоваров
		|ПО	ВЫРАЗИТЬ(ДвижениеТоваров.Регистратор КАК Документ.ВозвратТоваровОтКлиента) 	= ВТоК.Регистратор
		|И	ДвижениеТоваров.АналитикаУчетаНоменклатуры 									= ВТоК.АналитикаУчетаНоменклатуры
		|
		|ГДЕ
		|		IsNull(ВТоК.Поставщик, 0) 			<> IsNull(ДвижениеТоваров.Поставщик, 0) 
		|ИЛИ 	IsNull(ВТоК.ДокументПоступления, 0) <> IsNull(ДвижениеТоваров.ДокументПоступления, 0) 
		|ИЛИ 	IsNull(ВТоК.Количество, 0) 			<> IsNull(ДвижениеТоваров.Количество, 0) 
		|ИЛИ 	IsNull(ВТоК.ЦенаПрихода, 0) 		<> IsNull(ДвижениеТоваров.ЦенаПрихода, 0)
		|ИЛИ 	IsNull(ВТоК.ДатаПрихода, 0) 		<> IsNull(ДвижениеТоваров.ДатаПрихода, 0)
		|
		|ОБЪЕДИНИТЬ 
		|
		|ВЫБРАТЬ
		|	ВЫРАЗИТЬ(ДвижениеТоваров.Регистратор КАК Документ.ВозвратТоваровОтКлиента)		
		|ИЗ
		|	ДвижениеТоваров КАК ДвижениеТоваров
		|		
		|ЛЕВОЕ СОЕДИНЕНИЕ КешВТоК КАК ВТоК
		|ПО	ВТоК.Регистратор 				= ВЫРАЗИТЬ(ДвижениеТоваров.Регистратор КАК Документ.ВозвратТоваровОтКлиента)
		|И	ВТоК.АналитикаУчетаНоменклатуры = ДвижениеТоваров.АналитикаУчетаНоменклатуры
		|
		|ГДЕ
		|	ДвижениеТоваров.Регистратор			Ссылка	Документ.ВозвратТоваровОтКлиента
		|И (	IsNull(ВТоК.Поставщик, 0) 			<> 	IsNull(ДвижениеТоваров.Поставщик, 0) 
		|ИЛИ 	IsNull(ВТоК.ДокументПоступления, 0) <> 	IsNull(ДвижениеТоваров.ДокументПоступления, 0) 
		|ИЛИ 	IsNull(ВТоК.Количество, 0) 			<> 	IsNull(ДвижениеТоваров.Количество, 0) 
		|ИЛИ 	IsNull(ВТоК.ЦенаПрихода, 0) 		<> 	IsNull(ДвижениеТоваров.ЦенаПрихода, 0)
		|ИЛИ 	IsNull(ВТоК.ДатаПрихода, 0) 		<> 	IsNull(ДвижениеТоваров.ДатаПрихода, 0)
		|  )
		|
		|ИНДЕКСИРОВАТЬ ПО
		|	ВТоК.Регистратор	
		|;
		//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		//8. 
		|ВЫБРАТЬ
		|	ВТоК.Период,
		|	ВТоК.Регистратор,
		|	ВТоК.АналитикаУчетаНоменклатуры,
		|	ВТоК.Поставщик,
		|	ВТоК.ДокументПоступления,
		|	ВТоК.Количество,
		|	ВТоК.ЦенаПрихода,
		|	ВТоК.ДатаПрихода
		|ИЗ
		|	КешВТоК КАК ВТоК
		|	
		|ВНУТРЕННЕЕ СОЕДИНЕНИЕ ДокументыДляЗаписиВТоК КАК ДокументыДляЗаписи
		|ПО	ДокументыДляЗаписи.Регистратор = ВТоК.Регистратор
		|
		|ИТОГИ ПО
		|	ДокументПоступления
		|;
		//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ КешВТоК;
		|УНИЧТОЖИТЬ ДокументыДляЗаписиВТоК;
		//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		//11.
		|ВЫБРАТЬ
		|	ВО.Период															КАК Период,
		|	ВЫРАЗИТЬ(ВО.Регистратор КАК Документ.ВводОстатков)					КАК Регистратор,
		|	ВО.АналитикаУчетаНоменклатуры 										КАК АналитикаУчетаНоменклатуры,
		|	ЗНАЧЕНИЕ(Справочник.Партнеры.ПустаяСсылка) 							КАК Поставщик,
		|	ВЫРАЗИТЬ(ВО.Регистратор КАК Документ.ВводОстатков)					КАК ДокументПоступления,
		|	ВО.КоличествоОборот													КАК Количество,
		|	ВЫРАЗИТЬ(ВО.СтоимостьОборот / ВО.КоличествоОборот КАК ЧИСЛО(15, 2))	КАК ЦенаПрихода,
		|	ВО.Период															КАК ДатаПрихода
		|ПОМЕСТИТЬ КешВО	
		|ИЗ
		|	РегистрНакопления.СебестоимостьТоваров.Обороты(&НачалоПериода, &КонецПериода, Регистратор) КАК ВО						
		|
		|ГДЕ
		|	Регистратор Ссылка Документ.ВводОстатков
		|	
		|ИНДЕКСИРОВАТЬ ПО
		|	Регистратор,
		|	АналитикаУчетаНоменклатуры	
		|;
		//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		//12.
		|ВЫБРАТЬ
		|	ВО.Регистратор
		|ПОМЕСТИТЬ ДокументыДляЗаписиВО		
		|ИЗ
		|	КешВО КАК ВО
		|		
		|ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.КТС_ДвижениеТоваровПоставщиков КАК ДвижениеТоваров
		|ПО	ВЫРАЗИТЬ(ДвижениеТоваров.Регистратор КАК Документ.ВводОстатков) = ВО.Регистратор
		|И	ДвижениеТоваров.АналитикаУчетаНоменклатуры 						= ВО.АналитикаУчетаНоменклатуры
		|
		|ГДЕ
		|		IsNull(ВО.Поставщик, 0) 			<> IsNull(ДвижениеТоваров.Поставщик, 0) 
		|ИЛИ 	IsNull(ВО.ДокументПоступления, 0) 	<> IsNull(ДвижениеТоваров.ДокументПоступления, 0) 
		|ИЛИ 	IsNull(ВО.Количество, 0) 			<> IsNull(ДвижениеТоваров.Количество, 0) 
		|ИЛИ 	IsNull(ВО.ЦенаПрихода, 0) 			<> IsNull(ДвижениеТоваров.ЦенаПрихода, 0)
		|ИЛИ 	IsNull(ВО.ДатаПрихода, 0) 			<> IsNull(ДвижениеТоваров.ДатаПрихода, 0)
		|
		|ОБЪЕДИНИТЬ 
		|
		|ВЫБРАТЬ
		|	ВЫРАЗИТЬ(ДвижениеТоваров.Регистратор КАК Документ.ВводОстатков)		
		|ИЗ
		|	ДвижениеТоваров КАК ДвижениеТоваров
		|		
		|ЛЕВОЕ СОЕДИНЕНИЕ КешВО КАК ВО
		|ПО	ВО.Регистратор 				  = ВЫРАЗИТЬ(ДвижениеТоваров.Регистратор КАК Документ.ВводОстатков)
		|И	ВО.АналитикаУчетаНоменклатуры = ДвижениеТоваров.АналитикаУчетаНоменклатуры
		|
		|ГДЕ
		|	ДвижениеТоваров.Регистратор			Ссылка	Документ.ВводОстатков
		|И (	IsNull(ВО.Поставщик, 0) 			<> 	IsNull(ДвижениеТоваров.Поставщик, 0) 
		|ИЛИ 	IsNull(ВО.ДокументПоступления, 0) 	<> 	IsNull(ДвижениеТоваров.ДокументПоступления, 0) 
		|ИЛИ 	IsNull(ВО.Количество, 0) 			<> 	IsNull(ДвижениеТоваров.Количество, 0) 
		|ИЛИ 	IsNull(ВО.ЦенаПрихода, 0) 			<> 	IsNull(ДвижениеТоваров.ЦенаПрихода, 0)
		|ИЛИ 	IsNull(ВО.ДатаПрихода, 0) 			<> 	IsNull(ДвижениеТоваров.ДатаПрихода, 0)
		|  )
		|
		|ИНДЕКСИРОВАТЬ ПО
		|	ВО.Регистратор	
		|;
		//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		//13. 
		|ВЫБРАТЬ
		|	ВО.Период,
		|	ВО.Регистратор,
		|	ВО.АналитикаУчетаНоменклатуры,
		|	ВО.Поставщик,
		|	ВО.ДокументПоступления,
		|	ВО.Количество,
		|	ВО.ЦенаПрихода,
		|	ВО.ДатаПрихода
		|ИЗ
		|	КешВО КАК ВО
		|	
		|ВНУТРЕННЕЕ СОЕДИНЕНИЕ ДокументыДляЗаписиВО КАК ДокументыДляЗаписи
		|ПО	ДокументыДляЗаписи.Регистратор = ВО.Регистратор
		|
		|ИТОГИ ПО
		|	ДокументПоступления
		|;
		//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ КешВО;
		|УНИЧТОЖИТЬ ДокументыДляЗаписиВО;
		//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		//16.
		|ВЫБРАТЬ
		|	ОИТ.Период																КАК Период,
		|	ВЫРАЗИТЬ(ОИТ.Регистратор КАК Документ.ОприходованиеИзлишковТоваров)		КАК Регистратор,
		|	ОИТ.АналитикаУчетаНоменклатуры 											КАК АналитикаУчетаНоменклатуры,
		|	ЗНАЧЕНИЕ(Справочник.Партнеры.ПустаяСсылка) 								КАК Поставщик,
		|	ВЫРАЗИТЬ(ОИТ.Регистратор КАК Документ.ОприходованиеИзлишковТоваров)		КАК ДокументПоступления,
		|	ОИТ.КоличествоОборот													КАК Количество,
		|	ВЫРАЗИТЬ(ОИТ.СтоимостьОборот / ОИТ.КоличествоОборот КАК ЧИСЛО(15, 2))	КАК ЦенаПрихода,
		|	ОИТ.Период																КАК ДатаПрихода
		|ПОМЕСТИТЬ КешОИТ	
		|ИЗ
		|	РегистрНакопления.СебестоимостьТоваров.Обороты(&НачалоПериода, &КонецПериода, Регистратор) КАК ОИТ						
		|
		|ГДЕ
		|	Регистратор Ссылка Документ.ОприходованиеИзлишковТоваров
		|	
		|ИНДЕКСИРОВАТЬ ПО
		|	Регистратор,
		|	АналитикаУчетаНоменклатуры	
		|;
		//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		//17.
		|ВЫБРАТЬ
		|	ОИТ.Регистратор
		|ПОМЕСТИТЬ ДокументыДляЗаписиОИТ		
		|ИЗ
		|	КешОИТ КАК ОИТ
		|		
		|ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.КТС_ДвижениеТоваровПоставщиков КАК ДвижениеТоваров
		|ПО	ВЫРАЗИТЬ(ДвижениеТоваров.Регистратор КАК Документ.ОприходованиеИзлишковТоваров) = ОИТ.Регистратор
		|И	ДвижениеТоваров.АналитикаУчетаНоменклатуры 										= ОИТ.АналитикаУчетаНоменклатуры
		|	
		|ГДЕ
		|		IsNull(ОИТ.Поставщик, 0) 			<> IsNull(ДвижениеТоваров.Поставщик, 0) 
		|ИЛИ 	IsNull(ОИТ.ДокументПоступления, 0) 	<> IsNull(ДвижениеТоваров.ДокументПоступления, 0) 
		|ИЛИ 	IsNull(ОИТ.Количество, 0) 			<> IsNull(ДвижениеТоваров.Количество, 0) 
		|ИЛИ 	IsNull(ОИТ.ЦенаПрихода, 0) 			<> IsNull(ДвижениеТоваров.ЦенаПрихода, 0)
		|ИЛИ 	IsNull(ОИТ.ДатаПрихода, 0) 			<> IsNull(ДвижениеТоваров.ДатаПрихода, 0)
		|
		|ОБЪЕДИНИТЬ 
		|
		|ВЫБРАТЬ
		|	ВЫРАЗИТЬ(ДвижениеТоваров.Регистратор КАК Документ.ОприходованиеИзлишковТоваров)		
		|ИЗ
		|	ДвижениеТоваров КАК ДвижениеТоваров
		|		
		|ЛЕВОЕ СОЕДИНЕНИЕ КешОИТ КАК ОИТ
		|ПО	ОИТ.Регистратор 			   = ВЫРАЗИТЬ(ДвижениеТоваров.Регистратор КАК Документ.ОприходованиеИзлишковТоваров)
		|И	ОИТ.АналитикаУчетаНоменклатуры = ДвижениеТоваров.АналитикаУчетаНоменклатуры
		|
		|ГДЕ
		|	ДвижениеТоваров.Регистратор			Ссылка	Документ.ОприходованиеИзлишковТоваров
		|И (	IsNull(ОИТ.Поставщик, 0) 			<> 	IsNull(ДвижениеТоваров.Поставщик, 0) 
		|ИЛИ 	IsNull(ОИТ.ДокументПоступления, 0) 	<> 	IsNull(ДвижениеТоваров.ДокументПоступления, 0) 
		|ИЛИ 	IsNull(ОИТ.Количество, 0) 			<> 	IsNull(ДвижениеТоваров.Количество, 0) 
		|ИЛИ 	IsNull(ОИТ.ЦенаПрихода, 0) 			<> 	IsNull(ДвижениеТоваров.ЦенаПрихода, 0)
		|ИЛИ 	IsNull(ОИТ.ДатаПрихода, 0) 			<> 	IsNull(ДвижениеТоваров.ДатаПрихода, 0)
		|  )
		|
		|ИНДЕКСИРОВАТЬ ПО
		|	ОИТ.Регистратор	
		|;
		//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		//18. 
		|ВЫБРАТЬ
		|	ОИТ.Период,
		|	ОИТ.Регистратор,
		|	ОИТ.АналитикаУчетаНоменклатуры,
		|	ОИТ.Поставщик,
		|	ОИТ.ДокументПоступления,
		|	ОИТ.Количество,
		|	ОИТ.ЦенаПрихода,
		|	ОИТ.ДатаПрихода
		|ИЗ
		|	КешОИТ КАК ОИТ
		|	
		|ВНУТРЕННЕЕ СОЕДИНЕНИЕ ДокументыДляЗаписиОИТ КАК ДокументыДляЗаписи
		|ПО	ДокументыДляЗаписи.Регистратор = ОИТ.Регистратор
		|
		|ИТОГИ ПО
		|	ДокументПоступления
		|;
		//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ КешОИТ;
		|УНИЧТОЖИТЬ ДокументыДляЗаписиОИТ;
		//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		//21.
		|ВЫБРАТЬ
		|	СБ.Период															КАК Период,
		|	ВЫРАЗИТЬ(СБ.Регистратор КАК Документ.СборкаТоваров)					КАК Регистратор,
		|	СБ.АналитикаУчетаНоменклатуры 										КАК АналитикаУчетаНоменклатуры,
		|	ЗНАЧЕНИЕ(Справочник.Партнеры.ПустаяСсылка) 							КАК Поставщик,
		|	ВЫРАЗИТЬ(СБ.Регистратор КАК Документ.СборкаТоваров)					КАК ДокументПоступления,
		|	СБ.КоличествоОборот													КАК Количество,
		|	ВЫРАЗИТЬ(СБ.СтоимостьОборот / СБ.КоличествоОборот КАК ЧИСЛО(15, 2))	КАК ЦенаПрихода,
		|	СБ.Период															КАК ДатаПрихода
		|ПОМЕСТИТЬ КешСБ	
		|ИЗ
		|	РегистрНакопления.СебестоимостьТоваров.Обороты(&НачалоПериода, &КонецПериода, Регистратор) КАК СБ						
		|
		|ГДЕ
		|	Регистратор Ссылка Документ.СборкаТоваров
		|И	СБ.КоличествоОборот > 0
		|	
		|ИНДЕКСИРОВАТЬ ПО
		|	Регистратор,
		|	АналитикаУчетаНоменклатуры	
		|;
		//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		//22.
		|ВЫБРАТЬ
		|	СБ.Регистратор
		|ПОМЕСТИТЬ ДокументыДляЗаписиСБ		
		|ИЗ
		|	КешСБ КАК СБ
		|		
		|ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.КТС_ДвижениеТоваровПоставщиков КАК ДвижениеТоваров
		|ПО	ВЫРАЗИТЬ(ДвижениеТоваров.Регистратор КАК Документ.СборкаТоваров) = СБ.Регистратор
		|И	ДвижениеТоваров.АналитикаУчетаНоменклатуры 						 = СБ.АналитикаУчетаНоменклатуры
		|
		|ГДЕ
		|		IsNull(СБ.Поставщик, 0) 			<> IsNull(ДвижениеТоваров.Поставщик, 0) 
		|ИЛИ 	IsNull(СБ.ДокументПоступления, 0) 	<> IsNull(ДвижениеТоваров.ДокументПоступления, 0) 
		|ИЛИ 	IsNull(СБ.Количество, 0) 			<> IsNull(ДвижениеТоваров.Количество, 0) 
		|ИЛИ 	IsNull(СБ.ЦенаПрихода, 0) 			<> IsNull(ДвижениеТоваров.ЦенаПрихода, 0)
		|ИЛИ 	IsNull(СБ.ДатаПрихода, 0) 			<> IsNull(ДвижениеТоваров.ДатаПрихода, 0)
		|
		|ОБЪЕДИНИТЬ 
		|
		|ВЫБРАТЬ
		|	ВЫРАЗИТЬ(ДвижениеТоваров.Регистратор КАК Документ.СборкаТоваров)		
		|ИЗ
		|	ДвижениеТоваров КАК ДвижениеТоваров
		|		
		|ЛЕВОЕ СОЕДИНЕНИЕ КешСБ КАК СБ
		|ПО	СБ.Регистратор 			   	  = ВЫРАЗИТЬ(ДвижениеТоваров.Регистратор КАК Документ.СборкаТоваров)
		|И	СБ.АналитикаУчетаНоменклатуры = ДвижениеТоваров.АналитикаУчетаНоменклатуры
		|
		|ГДЕ
		|	ДвижениеТоваров.Регистратор			Ссылка	Документ.СборкаТоваров
		|И (	IsNull(СБ.Поставщик, 0) 			<> 	IsNull(ДвижениеТоваров.Поставщик, 0) 
		|ИЛИ 	IsNull(СБ.ДокументПоступления, 0) 	<> 	IsNull(ДвижениеТоваров.ДокументПоступления, 0) 
		|ИЛИ 	IsNull(СБ.Количество, 0) 			<> 	IsNull(ДвижениеТоваров.Количество, 0) 
		|ИЛИ 	IsNull(СБ.ЦенаПрихода, 0) 			<> 	IsNull(ДвижениеТоваров.ЦенаПрихода, 0)
		|ИЛИ 	IsNull(СБ.ДатаПрихода, 0) 			<> 	IsNull(ДвижениеТоваров.ДатаПрихода, 0)
		|  )
		|
		|ИНДЕКСИРОВАТЬ ПО
		|	СБ.Регистратор	
		|;
		//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		//23. 
		|ВЫБРАТЬ
		|	СБ.Период,
		|	СБ.Регистратор,
		|	СБ.АналитикаУчетаНоменклатуры,
		|	СБ.Поставщик,
		|	СБ.ДокументПоступления,
		|	СБ.Количество,
		|	СБ.ЦенаПрихода,
		|	СБ.ДатаПрихода
		|ИЗ
		|	КешСБ КАК СБ
		|	
		|ВНУТРЕННЕЕ СОЕДИНЕНИЕ ДокументыДляЗаписиСБ КАК ДокументыДляЗаписи
		|ПО	ДокументыДляЗаписи.Регистратор = СБ.Регистратор
		|
		|ИТОГИ ПО
		|	ДокументПоступления
		|;
		//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ КешСБ;
		|УНИЧТОЖИТЬ ДокументыДляЗаписиСБ;
		|";
	Возврат ТекстЗапроса;

КонецФункции // ПолучитьТекстЗапросаДвиженияПьриход()

Функция ПолучитьТекстЗапросаНачальныеДвижения()
	
	ТекстЗапроса = "
		//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		//0.
		|ВЫБРАТЬ 
		|	&НачалоПериода					КАК Период,
		|	АналитикаУчетаНоменклатуры		КАК АналитикаУчетаНоменклатуры,
		|	Поставщик						КАК Поставщик,
		|	ДокументПоступления				КАК ДокументПоступления,
		|	КоличествоОстаток				КАК Количество	
		|ПОМЕСТИТЬ ОстаткиТоваровПоставщиков
		|ИЗ
		|	РегистрНакопления.КТС_ДвижениеТоваровПоставщиков.Остатки(&НачалоПериода) КАК ДвижениеТоваров
		|
		|ОБЪЕДИНИТЬ
		|
		|ВЫБРАТЬ
		|	Период,
		|	АналитикаУчетаНоменклатуры,
		|	Поставщик,
		|	ДокументПоступления,
		|	Количество	
		|ИЗ
		|	РегистрНакопления.КТС_ДвижениеТоваровПоставщиков КАК ДвижениеТоваров	
		|ГДЕ
		|	ДвижениеТоваров.Период 		>= &НачалоПериода
		|И	ДвижениеТоваров.Период 		<= &КонецПериода
		|И	ДвижениеТоваров.ВидДвижения  = Значение(ВидДвиженияНакопления.Приход)
		|И (	
		|	ДвижениеТоваров.Регистратор Ссылка Документ.ВводОстатков
		|ИЛИ	ДвижениеТоваров.Регистратор Ссылка Документ.СборкаТоваров
		|ИЛИ	ДвижениеТоваров.Регистратор Ссылка Документ.ВозвратТоваровОтКлиента
		|ИЛИ	ДвижениеТоваров.Регистратор Ссылка Документ.ПоступлениеТоваровУслуг
		|ИЛИ	ДвижениеТоваров.Регистратор Ссылка Документ.ОприходованиеИзлишковТоваров
		|  )
		|
		|ОБЪЕДИНИТЬ
		|
		|ВЫБРАТЬ
		|	Период,
		|	АналитикаУчетаНоменклатуры,
		|	Неопределено,
		|	Регистратор,
		|	КоличествоОборот		
		|ИЗ
		|	РегистрНакопления.СебестоимостьТоваров.Обороты(&НачалоПериода, &КонецПериода, Регистратор) 
		|ГДЕ
		|	Регистратор Ссылка Документ.ПеремещениеТоваров
		|И	КоличествоОборот > 0
		|;
		//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		//1.
		|ВЫБРАТЬ
		|	ОстаткиТоваровПоставщиков.Период 						КАК Период,
		|	ОстаткиТоваровПоставщиков.АналитикаУчетаНоменклатуры	КАК АналитикаУчетаНоменклатуры,
		|	ОстаткиТоваровПоставщиков.Поставщик						КАК Поставщик,
		|	ОстаткиТоваровПоставщиков.ДокументПоступления   		КАК ДокументПоступления,
		|	СУММА(ОстаткиТоваровПоставщиковКопия.Количество)    									КАК КоличествоПосле,
		|	СУММА(ОстаткиТоваровПоставщиковКопия.Количество) - ОстаткиТоваровПоставщиков.Количество КАК КоличествоДо
		|ПОМЕСТИТЬ ОстаткиТоваровПоставщиковНаростающие
		|ИЗ
		|	ОстаткиТоваровПоставщиков КАК ОстаткиТоваровПоставщиков
		|		
		|ВНУТРЕННЕЕ СОЕДИНЕНИЕ ОстаткиТоваровПоставщиков КАК ОстаткиТоваровПоставщиковКопия
		|ПО 	ОстаткиТоваровПоставщиковКопия.АналитикаУчетаНоменклатуры = ОстаткиТоваровПоставщиков.АналитикаУчетаНоменклатуры
		|И	ВЫБОР
		|		КОГДА ОстаткиТоваровПоставщиковКопия.Период 			 = 	ОстаткиТоваровПоставщиков.Период
		|		ТОГДА ОстаткиТоваровПоставщиковКопия.ДокументПоступления <= ОстаткиТоваровПоставщиков.ДокументПоступления
		|		ИНАЧЕ ОстаткиТоваровПоставщиковКопия.Период 			 <=	ОстаткиТоваровПоставщиков.Период
		|	КОНЕЦ
		|				
		|СГРУППИРОВАТЬ ПО
		|	ОстаткиТоваровПоставщиков.Период,
		|	ОстаткиТоваровПоставщиков.АналитикаУчетаНоменклатуры,
		|	ОстаткиТоваровПоставщиков.Поставщик,
		|	ОстаткиТоваровПоставщиков.ДокументПоступления,
		|	ОстаткиТоваровПоставщиков.Количество	
		|;
		//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		//2.
		|ВЫБРАТЬ
		|	РТиУ.Период						КАК Период,
		|	РТиУ.Регистратор				КАК Регистратор,
		|	РТиУ.АналитикаУчетаНоменклатуры	КАК АналитикаУчетаНоменклатуры,
		|	РТиУ.КоличествоОборот			КАК Количество
		|ПОМЕСТИТЬ ДвиженияТоваров	
		|ИЗ
		|	РегистрНакопления.ВыручкаИСебестоимостьПродаж.Обороты(&НачалоПериода, &КонецПериода, Регистратор) КАК РТиУ
		|ГДЕ
		|	РТиУ.Регистратор Ссылка Документ.РеализацияТоваровУслуг
		|
		|ОБЪЕДИНИТЬ
		|
		|ВЫБРАТЬ
		|	Период,
		|	Регистратор,
		|	АналитикаУчетаНоменклатуры,
		|	-КоличествоОборот		
		|ИЗ
		|	РегистрНакопления.СебестоимостьТоваров.Обороты(&НачалоПериода, &КонецПериода, Регистратор) 
		|ГДЕ
		|	 Регистратор Ссылка Документ.ВозвратТоваровПоставщику
		|ИЛИ Регистратор Ссылка Документ.СписаниеНедостачТоваров
		|ИЛИ Регистратор Ссылка Документ.ВнутреннееПотреблениеТоваров
		|
		|ОБЪЕДИНИТЬ
		|
		|ВЫБРАТЬ
		|	Период,
		|	Регистратор,
		|	АналитикаУчетаНоменклатуры,
		|	-КоличествоОборот		
		|ИЗ
		|	РегистрНакопления.СебестоимостьТоваров.Обороты(&НачалоПериода, &КонецПериода, Регистратор) 
		|ГДЕ
		|	Регистратор Ссылка Документ.СборкаТоваров
		|И	КоличествоОборот < 0
		|
		|ОБЪЕДИНИТЬ
		|
		|ВЫБРАТЬ
		|	Период,
		|	Регистратор,
		|	АналитикаУчетаНоменклатуры,
		|	-КоличествоОборот		
		|ИЗ
		|	РегистрНакопления.СебестоимостьТоваров.Обороты(&НачалоПериода, &КонецПериода, Регистратор) 
		|ГДЕ
		|	Регистратор Ссылка Документ.ПеремещениеТоваров
		|И	КоличествоОборот < 0
		|;	
		//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		//3.
		|ВЫБРАТЬ
		|	ДвиженияТоваров.Период 												КАК Период,
		|	ДвиженияТоваров.Регистратор											КАК Регистратор,
		|	ДвиженияТоваров.АналитикаУчетаНоменклатуры							КАК АналитикаУчетаНоменклатуры,
		|	СУММА(ДвиженияТоваровКопия.Количество)    							КАК КоличествоПосле,
		|	СУММА(ДвиженияТоваровКопия.Количество) - ДвиженияТоваров.Количество КАК КоличествоДо
		|ПОМЕСТИТЬ ДвиженияТоваровНаростающие
		|ИЗ
		|	ДвиженияТоваров КАК ДвиженияТоваров
		|		
		|ВНУТРЕННЕЕ СОЕДИНЕНИЕ ДвиженияТоваров КАК ДвиженияТоваровКопия
		|ПО 	ДвиженияТоваровКопия.АналитикаУчетаНоменклатуры = ДвиженияТоваров.АналитикаУчетаНоменклатуры
		|И	ВЫБОР
		|		КОГДА ДвиженияТоваровКопия.Период 		 = ДвиженияТоваров.Период
		|		ТОГДА ДвиженияТоваровКопия.Регистратор 	<= ДвиженияТоваров.Регистратор
		|		ИНАЧЕ ДвиженияТоваровКопия.Период 		<= ДвиженияТоваров.Период
		|	КОНЕЦ
		|				
		|СГРУППИРОВАТЬ ПО
		|	ДвиженияТоваров.Период,
		|	ДвиженияТоваров.Регистратор,
		|	ДвиженияТоваров.АналитикаУчетаНоменклатуры,
		|	ДвиженияТоваров.Количество	
		|;
		//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		//4. Точки по аналитике
		|ВЫБРАТЬ
		|	АналитикаУчетаНоменклатуры	КАК АналитикаУчетаНоменклатуры,
		|	КоличествоПосле 			КАК Точка
		|ПОМЕСТИТЬ ТочкиАналитики		
		|ИЗ
		|	ОстаткиТоваровПоставщиковНаростающие
		|	
		|ОБЪЕДИНИТЬ
		|
		|ВЫБРАТЬ
		|	АналитикаУчетаНоменклатуры,
		|	КоличествоПосле		
		|ИЗ
		|	ДвиженияТоваровНаростающие		
		|;
		//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		//5.	
		|ВЫБРАТЬ
		|	ДвиженияТоваровНаростающие.Период,	
		|   ДвиженияТоваровНаростающие.Регистратор,
		|	ТочкиАналитики.АналитикаУчетаНоменклатуры,
		|	ОстаткиТоваровПоставщиковНаростающие.Поставщик,
		|	ОстаткиТоваровПоставщиковНаростающие.ДокументПоступления,
		|	ТочкиАналитики.Точка - ВЫБОР
		|								КОГДА ДвиженияТоваровНаростающие.КоличествоДо < ОстаткиТоваровПоставщиковНаростающие.КоличествоДо
		|								ТОГДА ОстаткиТоваровПоставщиковНаростающие.КоличествоДо
		|								ИНАЧЕ ДвиженияТоваровНаростающие.КоличествоДо
		|							КОНЕЦ КАК Количество
		|ПОМЕСТИТЬ КешПервогоУровня				
		|ИЗ
		|	ТочкиАналитики КАК ТочкиАналитики
		|
		|ВНУТРЕННЕЕ СОЕДИНЕНИЕ ОстаткиТоваровПоставщиковНаростающие КАК ОстаткиТоваровПоставщиковНаростающие
		|ПО	ОстаткиТоваровПоставщиковНаростающие.АналитикаУчетаНоменклатуры = 	ТочкиАналитики.АналитикаУчетаНоменклатуры
		|И  ОстаткиТоваровПоставщиковНаростающие.КоличествоПосле 			>= 	ТочкиАналитики.Точка
		|И  ОстаткиТоваровПоставщиковНаростающие.КоличествоДо 				< 	ТочкиАналитики.Точка
		|
		|ВНУТРЕННЕЕ СОЕДИНЕНИЕ ДвиженияТоваровНаростающие КАК ДвиженияТоваровНаростающие
		|ПО	ДвиженияТоваровНаростающие.АналитикаУчетаНоменклатуры 	= 	ТочкиАналитики.АналитикаУчетаНоменклатуры
		|И  ДвиженияТоваровНаростающие.КоличествоПосле 				>= 	ТочкиАналитики.Точка
		|И  ДвиженияТоваровНаростающие.КоличествоДо 				< 	ТочкиАналитики.Точка
		|
		|;
		//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		//|УНИЧТОЖИТЬ ОстаткиТоваровПоставщиков;
		|УНИЧТОЖИТЬ ОстаткиТоваровПоставщиковНаростающие;
		|УНИЧТОЖИТЬ ДвиженияТоваров;
		//|УНИЧТОЖИТЬ ДвиженияТоваровНаростающие;
		|УНИЧТОЖИТЬ ТочкиАналитики;
		//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		//11.
		|ВЫБРАТЬ
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)									КАК ВидДвижения, 
		|	КешПервогоУровня.Период													КАК Период,
		|	ВЫРАЗИТЬ(КешПервогоУровня.Регистратор КАК Документ.ПеремещениеТоваров) 	КАК Регистратор,
		|	КешПервогоУровня.АналитикаУчетаНоменклатуры								КАК АналитикаУчетаНоменклатуры,
		|	КешПервогоУровня.Поставщик												КАК Поставщик,
		|	КешПервогоУровня.ДокументПоступления									КАК ДокументПоступления,
		|	КешПервогоУровня.Количество												КАК Количество	
		|ПОМЕСТИТЬ КешВторогоУровня
		|ИЗ
		|	КешПервогоУровня КАК КешПервогоУровня	
		|ГДЕ
		|	КешПервогоУровня.Регистратор Ссылка Документ.ПеремещениеТоваров
		|И (	
		| 	КешПервогоУровня.ДокументПоступления Ссылка Документ.ВводОстатков
		|ИЛИ	КешПервогоУровня.ДокументПоступления Ссылка Документ.СборкаТоваров
		|ИЛИ	КешПервогоУровня.ДокументПоступления Ссылка Документ.ВозвратТоваровОтКлиента
		|ИЛИ	КешПервогоУровня.ДокументПоступления Ссылка Документ.ПоступлениеТоваровУслуг
		|ИЛИ	КешПервогоУровня.ДокументПоступления Ссылка Документ.ОприходованиеИзлишковТоваров
		| )
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход),
		|	КешПервогоУровня.Период,
		|	ВЫРАЗИТЬ(КешПервогоУровня.Регистратор КАК Документ.ПеремещениеТоваров),
		|	СБ.АналитикаУчетаНоменклатуры,
		|	КешПервогоУровня.Поставщик,
		|	КешПервогоУровня.ДокументПоступления,
		|	КешПервогоУровня.Количество		
		|ИЗ
		|	РегистрНакопления.СебестоимостьТоваров.Обороты(&НачалоПериода, &КонецПериода, Регистратор) КАК СБ
		|
		|ВНУТРЕННЕЕ СОЕДИНЕНИЕ КешПервогоУровня КАК КешПервогоУровня
		|ПО	ВЫРАЗИТЬ(КешПервогоУровня.Регистратор КАК Документ.ПеремещениеТоваров) = ВЫРАЗИТЬ(СБ.Регистратор КАК Документ.ПеремещениеТоваров)
		|И	КешПервогоУровня.АналитикаУчетаНоменклатуры.Номенклатура = СБ.АналитикаУчетаНоменклатуры.Номенклатура
		|И (
		|		КешПервогоУровня.ДокументПоступления Ссылка Документ.ВводОстатков
		|ИЛИ	КешПервогоУровня.ДокументПоступления Ссылка Документ.СборкаТоваров
		|ИЛИ	КешПервогоУровня.ДокументПоступления Ссылка Документ.ВозвратТоваровОтКлиента
		|ИЛИ	КешПервогоУровня.ДокументПоступления Ссылка Документ.ПоступлениеТоваровУслуг
		|ИЛИ	КешПервогоУровня.ДокументПоступления Ссылка Документ.ОприходованиеИзлишковТоваров 
		|  )
		|
		|ГДЕ
		|	СБ.Регистратор Ссылка Документ.ПеремещениеТоваров
		|И	СБ.КоличествоОборот > 0
		|;";
	Возврат ТекстЗапроса;
	
КонецФункции // ПолучитьТекстЗапросаНачальныеДвиженияПеремещений()

Функция ПолучитьТекстЗапросаРекурсивныеДвижения()
	
	ТекстЗапроса = "
		//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		//
		|ВЫБРАТЬ
		|	ОТП.Период,
		|	ОТП.АналитикаУчетаНоменклатуры,
		|	IsNull(КешВторогоУровня.Поставщик, ОТП.Поставщик)						КАК Поставщик,
		|	IsNull(КешВторогоУровня.ДокументПоступления, ОТП.ДокументПоступления) 	КАК ДокументПоступления,
		|	IsNull(КешВторогоУровня.Количество, ОТП.Количество)						КАК Количество
		|ПОМЕСТИТЬ ДополненыеОТП
		|ИЗ
		|	ОстаткиТоваровПоставщиков КАК ОТП
		|
		|ЛЕВОЕ СОЕДИНЕНИЕ КешВторогоУровня КАК КешВторогоУровня
		|ПО	КешВторогоУровня.Регистратор = ВЫРАЗИТЬ(ОТП.ДокументПоступления КАК Документ.ПеремещениеТоваров)
		|И	КешВторогоУровня.АналитикаУчетаНоменклатуры.Номенклатура = ОТП.АналитикаУчетаНоменклатуры.Номенклатура
		|И	КешВторогоУровня.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
		|;
		//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ КешПервогоУровня;
		|УНИЧТОЖИТЬ КешВторогоУровня;
		|УНИЧТОЖИТЬ ОстаткиТоваровПоставщиков;
		//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	*
		|ПОМЕСТИТЬ ОстаткиТоваровПоставщиков	
		|ИЗ
		|	ДополненыеОТП
		|;
		//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ ДополненыеОТП;
		//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		//1.
		|ВЫБРАТЬ
		|	ОстаткиТоваровПоставщиков.Период 						КАК Период,
		|	ОстаткиТоваровПоставщиков.АналитикаУчетаНоменклатуры	КАК АналитикаУчетаНоменклатуры,
		|	ОстаткиТоваровПоставщиков.Поставщик						КАК Поставщик,
		|	ОстаткиТоваровПоставщиков.ДокументПоступления   		КАК ДокументПоступления,
		|	СУММА(ОстаткиТоваровПоставщиковКопия.Количество)    									КАК КоличествоПосле,
		|	СУММА(ОстаткиТоваровПоставщиковКопия.Количество) - ОстаткиТоваровПоставщиков.Количество КАК КоличествоДо
		|ПОМЕСТИТЬ ОстаткиТоваровПоставщиковНаростающие
		|ИЗ
		|	ОстаткиТоваровПоставщиков КАК ОстаткиТоваровПоставщиков
		|		
		|ВНУТРЕННЕЕ СОЕДИНЕНИЕ ОстаткиТоваровПоставщиков КАК ОстаткиТоваровПоставщиковКопия
		|ПО 	ОстаткиТоваровПоставщиковКопия.АналитикаУчетаНоменклатуры = ОстаткиТоваровПоставщиков.АналитикаУчетаНоменклатуры
		|И	ВЫБОР
		|		КОГДА ОстаткиТоваровПоставщиковКопия.Период 			 = 	ОстаткиТоваровПоставщиков.Период
		|		ТОГДА ОстаткиТоваровПоставщиковКопия.ДокументПоступления <= ОстаткиТоваровПоставщиков.ДокументПоступления
		|		ИНАЧЕ ОстаткиТоваровПоставщиковКопия.Период 			 <=	ОстаткиТоваровПоставщиков.Период
		|	КОНЕЦ
		|				
		|СГРУППИРОВАТЬ ПО
		|	ОстаткиТоваровПоставщиков.Период,
		|	ОстаткиТоваровПоставщиков.АналитикаУчетаНоменклатуры,
		|	ОстаткиТоваровПоставщиков.Поставщик,
		|	ОстаткиТоваровПоставщиков.ДокументПоступления,
		|	ОстаткиТоваровПоставщиков.Количество	
		|;		
		//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		//4. Точки по аналитике
		|ВЫБРАТЬ
		|	АналитикаУчетаНоменклатуры	КАК АналитикаУчетаНоменклатуры,
		|	КоличествоПосле 			КАК Точка
		|ПОМЕСТИТЬ ТочкиАналитики		
		|ИЗ
		|	ОстаткиТоваровПоставщиковНаростающие
		|	
		|ОБЪЕДИНИТЬ

		|ВЫБРАТЬ
		|	АналитикаУчетаНоменклатуры,
		|	КоличествоПосле		
		|ИЗ
		|	ДвиженияТоваровНаростающие		
		|;
		|ВЫБРАТЬ
		|	ДвиженияТоваровНаростающие.Период,	
		|	ДвиженияТоваровНаростающие.Регистратор,
		|	ТочкиАналитики.АналитикаУчетаНоменклатуры,
		|	ОстаткиТоваровПоставщиковНаростающие.Поставщик,
		|	ОстаткиТоваровПоставщиковНаростающие.ДокументПоступления,
		|	СУММА(ТочкиАналитики.Точка - ВЫБОР
		|								КОГДА ДвиженияТоваровНаростающие.КоличествоДо < ОстаткиТоваровПоставщиковНаростающие.КоличествоДо
		|								ТОГДА ОстаткиТоваровПоставщиковНаростающие.КоличествоДо
		|								ИНАЧЕ ДвиженияТоваровНаростающие.КоличествоДо
		|							КОНЕЦ) КАК Количество
		|ПОМЕСТИТЬ КешПервогоУровня				
		|ИЗ
		|	ТочкиАналитики КАК ТочкиАналитики

		|ВНУТРЕННЕЕ СОЕДИНЕНИЕ ОстаткиТоваровПоставщиковНаростающие КАК ОстаткиТоваровПоставщиковНаростающие
		|ПО	ОстаткиТоваровПоставщиковНаростающие.АналитикаУчетаНоменклатуры = 	ТочкиАналитики.АналитикаУчетаНоменклатуры
		|И   ОстаткиТоваровПоставщиковНаростающие.КоличествоПосле 			>= 	ТочкиАналитики.Точка
		|И   ОстаткиТоваровПоставщиковНаростающие.КоличествоДо 				< 	ТочкиАналитики.Точка

		|ВНУТРЕННЕЕ СОЕДИНЕНИЕ ДвиженияТоваровНаростающие КАК ДвиженияТоваровНаростающие
		|ПО	ДвиженияТоваровНаростающие.АналитикаУчетаНоменклатуры 	= 	ТочкиАналитики.АналитикаУчетаНоменклатуры
		|И   ДвиженияТоваровНаростающие.КоличествоПосле 				>= 	ТочкиАналитики.Точка
		|И   ДвиженияТоваровНаростающие.КоличествоДо 				< 	ТочкиАналитики.Точка
		|
		|СГРУППИРОВАТЬ ПО
		|	ДвиженияТоваровНаростающие.Период,	
		|	ДвиженияТоваровНаростающие.Регистратор,
		|	ТочкиАналитики.АналитикаУчетаНоменклатуры,
		|	ОстаткиТоваровПоставщиковНаростающие.Поставщик,
		|	ОстаткиТоваровПоставщиковНаростающие.ДокументПоступления
		|;
		//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ ОстаткиТоваровПоставщиковНаростающие;
		|УНИЧТОЖИТЬ ТочкиАналитики;
		//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		//11.
		|ВЫБРАТЬ
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)									КАК ВидДвижения, 
		|	КешПервогоУровня.Период													КАК Период,
		|	ВЫРАЗИТЬ(КешПервогоУровня.Регистратор КАК Документ.ПеремещениеТоваров) 	КАК Регистратор,
		|	КешПервогоУровня.АналитикаУчетаНоменклатуры								КАК АналитикаУчетаНоменклатуры,
		|	КешПервогоУровня.Поставщик												КАК Поставщик,
		|	КешПервогоУровня.ДокументПоступления									КАК ДокументПоступления,
		|	КешПервогоУровня.Количество												КАК Количество	
		|ПОМЕСТИТЬ КешВторогоУровня
		|ИЗ
		|	КешПервогоУровня КАК КешПервогоУровня	
		|ГДЕ
		|	КешПервогоУровня.Регистратор Ссылка Документ.ПеремещениеТоваров
		|И (	
		| 	КешПервогоУровня.ДокументПоступления Ссылка Документ.ВводОстатков
		|ИЛИ	КешПервогоУровня.ДокументПоступления Ссылка Документ.СборкаТоваров
		|ИЛИ	КешПервогоУровня.ДокументПоступления Ссылка Документ.ВозвратТоваровОтКлиента
		|ИЛИ	КешПервогоУровня.ДокументПоступления Ссылка Документ.ПоступлениеТоваровУслуг
		|ИЛИ	КешПервогоУровня.ДокументПоступления Ссылка Документ.ОприходованиеИзлишковТоваров
		| )

		|ОБЪЕДИНИТЬ ВСЕ

		|ВЫБРАТЬ
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход),
		|	КешПервогоУровня.Период,
		|	ВЫРАЗИТЬ(КешПервогоУровня.Регистратор КАК Документ.ПеремещениеТоваров),
		|	СБ.АналитикаУчетаНоменклатуры,
		|	КешПервогоУровня.Поставщик,
		|	КешПервогоУровня.ДокументПоступления,
		|	КешПервогоУровня.Количество		
		|ИЗ
		|	РегистрНакопления.СебестоимостьТоваров.Обороты(&НачалоПериода, &КонецПериода, Регистратор) КАК СБ

		|ВНУТРЕННЕЕ СОЕДИНЕНИЕ КешПервогоУровня КАК КешПервогоУровня
		|ПО	ВЫРАЗИТЬ(КешПервогоУровня.Регистратор КАК Документ.ПеремещениеТоваров) = ВЫРАЗИТЬ(СБ.Регистратор КАК Документ.ПеремещениеТоваров)
		|И	КешПервогоУровня.АналитикаУчетаНоменклатуры.Номенклатура = СБ.АналитикаУчетаНоменклатуры.Номенклатура
		|И (
		|	КешПервогоУровня.ДокументПоступления Ссылка Документ.ВводОстатков
		|ИЛИ	КешПервогоУровня.ДокументПоступления Ссылка Документ.СборкаТоваров
		|ИЛИ	КешПервогоУровня.ДокументПоступления Ссылка Документ.ВозвратТоваровОтКлиента
		|ИЛИ	КешПервогоУровня.ДокументПоступления Ссылка Документ.ПоступлениеТоваровУслуг
		|ИЛИ	КешПервогоУровня.ДокументПоступления Ссылка Документ.ОприходованиеИзлишковТоваров 
		|  )

		|ГДЕ
		|	СБ.Регистратор Ссылка Документ.ПеремещениеТоваров
		|И	СБ.КоличествоОборот > 0
		|;";
	Возврат ТекстЗапроса;
	
КонецФункции // ПолучитьТекстЗапросаРекурсивныеДвижения() 

Функция ПолучитьТекстЗапросаРекурсивныеДвижения_1()
	
	ТекстЗапроса = "
		//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		//X0.
		|ВЫБРАТЬ
		|	КешВторогоУровня.ВидДвижения,
		|	КешВторогоУровня.Период,
		|	КешВторогоУровня.Регистратор,
		|	КешВторогоУровня.АналитикаУчетаНоменклатуры,
		|	КешВторогоУровня.Поставщик,
		|	КешВторогоУровня.ДокументПоступления,
		|	КешВторогоУровня.Количество
		|ПОМЕСТИТЬ КешРекурсивногоУровня		
		|ИЗ
		|	КешВторогоУровня КАК КешВторогоУровня
		|ГДЕ
		|	КешВторогоУровня.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)	
		|;
		//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ КешВторогоУровня; 
		//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		//X2. 
		|ВЫБРАТЬ
		|	КешРекурсивногоУровня.Период,
		|	КешРекурсивногоУровня.Регистратор,
		|	КешРекурсивногоУровня.АналитикаУчетаНоменклатуры,
		|	КешРекурсивногоУровня.Поставщик,
		|	КешРекурсивногоУровня.ДокументПоступления,
		|	СУММА(КешРекурсивногоУровняКопия.Количество) - КешРекурсивногоУровня.Количество КАК СуммаДо,
		|	СУММА(КешРекурсивногоУровняКопия.Количество) КАК СуммаПосле
		|ПОМЕСТИТЬ КешРекурсивногоУровняНаростающие			
		|ИЗ
		|	КешРекурсивногоУровня КАК КешРекурсивногоУровня		
		|
		|ВНУТРЕННЕЕ СОЕДИНЕНИЕ КешРекурсивногоУровня КАК КешРекурсивногоУровняКопия
		|ПО	КешРекурсивногоУровняКопия.АналитикаУчетаНоменклатуры = КешРекурсивногоУровня.АналитикаУчетаНоменклатуры
		|И	ВЫБОР
		|		КОГДА КешРекурсивногоУровняКопия.Период 			  = КешРекурсивногоУровня.Период
		|		ТОГДА КешРекурсивногоУровняКопия.ДокументПоступления <= КешРекурсивногоУровня.ДокументПоступления
		|		ИНАЧЕ КешРекурсивногоУровняКопия.Период 			 <= КешРекурсивногоУровня.Период
		|	КОНЕЦ
		|	
		|СГРУППИРОВАТЬ ПО
		|	КешРекурсивногоУровня.Период,
		|	КешРекурсивногоУровня.Регистратор,
		|	КешРекурсивногоУровня.АналитикаУчетаНоменклатуры,
		|	КешРекурсивногоУровня.Поставщик,
		|	КешРекурсивногоУровня.ДокументПоступления,
		|	КешРекурсивногоУровня.Количество		
		|;
		//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		//X3.
		|ВЫБРАТЬ
		|	КешПервогоУровня.Период,
		|	КешПервогоУровня.Регистратор,
		|	КешПервогоУровня.АналитикаУчетаНоменклатуры,
		|	КешПервогоУровня.Поставщик,
		|	КешПервогоУровня.ДокументПоступления,
		|	СУММА(КешПервогоУровняКопия.Количество) - КешПервогоУровня.Количество КАК СуммаДо,
		|	СУММА(КешПервогоУровняКопия.Количество) КАК СуммаПосле
		|ПОМЕСТИТЬ КешПервогоУровняНаростающие		
		|ИЗ
		|	КешПервогоУровня КАК КешПервогоУровня	
		| 
		|ВНУТРЕННЕЕ СОЕДИНЕНИЕ КешПервогоУровня КАК КешПервогоУровняКопия
		|ПО	КешПервогоУровняКопия.ДокументПоступления Ссылка Документ.ПеремещениеТоваров
		|И	КешПервогоУровняКопия.АналитикаУчетаНоменклатуры = КешПервогоУровня.АналитикаУчетаНоменклатуры
		|И	ВЫБОР
		|		КОГДА КешПервогоУровняКопия.Период 			  	=  КешПервогоУровня.Период
		|		ТОГДА КешПервогоУровняКопия.ДокументПоступления <= КешПервогоУровня.ДокументПоступления
		|		ИНАЧЕ КешПервогоУровняКопия.Период 			 	<= КешПервогоУровня.Период
		|	КОНЕЦ
		|
		|СГРУППИРОВАТЬ ПО
		|	КешПервогоУровня.Период,
		|	КешПервогоУровня.Регистратор,
		|	КешПервогоУровня.АналитикаУчетаНоменклатуры,
		|	КешПервогоУровня.Поставщик,
		|	КешПервогоУровня.ДокументПоступления,
		|	КешПервогоУровня.Количество	
		|;
		//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		//X4. Точки объединения
		|ВЫБРАТЬ
		|	АналитикаУчетаНоменклатуры	КАК АналитикаУчетаНоменклатуры,
		|	СуммаПосле 					КАК Точка
		|ПОМЕСТИТЬ ТочкиОбъединение		
		|ИЗ
		|	КешРекурсивногоУровняНаростающие
		|	
		|ОБЪЕДИНИТЬ
		|
		|ВЫБРАТЬ
		|	АналитикаУчетаНоменклатуры,
		|	СуммаПосле		
		|ИЗ
		|	КешПервогоУровняНаростающие	
		|;
		//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		//X5.
		|ВЫБРАТЬ
		|	КешПервогоУровняНаростающие.Период,	
		|	КешПервогоУровняНаростающие.Регистратор,
		|	ТочкиОбъединение.АналитикаУчетаНоменклатуры,
		|	КешРекурсивногоУровняНаростающие.Поставщик,
		|	КешРекурсивногоУровняНаростающие.ДокументПоступления,
		|	ВЫРАЗИТЬ(КешПервогоУровняНаростающие.ДокументПоступления КАК Документ.ПеремещениеТоваров) КАК ДокументПеремещения,
		|	ТочкиОбъединение.Точка - ВЫБОР
		|								КОГДА КешПервогоУровняНаростающие.СуммаДо < КешРекурсивногоУровняНаростающие.СуммаДо
		|								ТОГДА КешРекурсивногоУровняНаростающие.СуммаДо
		|								ИНАЧЕ КешПервогоУровняНаростающие.СуммаДо
		|							КОНЕЦ КАК Количество
		|ПОМЕСТИТЬ ДополнениеКешПервогоУровня				
		|ИЗ
		|	ТочкиОбъединение КАК ТочкиОбъединение
		|
		|ВНУТРЕННЕЕ СОЕДИНЕНИЕ КешРекурсивногоУровняНаростающие КАК КешРекурсивногоУровняНаростающие
		|ПО	КешРекурсивногоУровняНаростающие.АналитикаУчетаНоменклатуры = 	ТочкиОбъединение.АналитикаУчетаНоменклатуры
		|И   КешРекурсивногоУровняНаростающие.СуммаПосле 				>= 	ТочкиОбъединение.Точка
		|И   КешРекурсивногоУровняНаростающие.СуммаДо 					< 	ТочкиОбъединение.Точка
		|
		|ВНУТРЕННЕЕ СОЕДИНЕНИЕ КешПервогоУровняНаростающие КАК КешПервогоУровняНаростающие
		|ПО	КешПервогоУровняНаростающие.АналитикаУчетаНоменклатуры 	= 	ТочкиОбъединение.АналитикаУчетаНоменклатуры
		|И   КешПервогоУровняНаростающие.СуммаПосле 					>= 	ТочкиОбъединение.Точка
		|И   КешПервогоУровняНаростающие.СуммаДо 					< 	ТочкиОбъединение.Точка
		|;
		//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ ТочкиОбъединение;
		|УНИЧТОЖИТЬ КешПервогоУровняНаростающие;
		|УНИЧТОЖИТЬ КешРекурсивногоУровня; 
		|УНИЧТОЖИТЬ КешРекурсивногоУровняНаростающие;
		//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		//X10.
		|ВЫБРАТЬ
		|	*
		|ПОМЕСТИТЬ ПредварительныйКешПервогоУровня
		|ИЗ
		|	КешПервогоУровня
		|;	
		//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ КешПервогоУровня;
		//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		//X12.
		|ВЫБРАТЬ
		|	КПУ.Период,	
		|	КПУ.Регистратор,
		|	КПУ.АналитикаУчетаНоменклатуры,
		|	ВЫБОР 
		|		КОГДА ДКПУ.ДокументПоступления ЕСТЬ NULL
		|		ТОГДА КПУ.Поставщик
		|		ИНАЧЕ ДКПУ.Поставщик
		|	КОНЕЦ КАК Поставщик,
		|	ВЫБОР 
		|		КОГДА ДКПУ.ДокументПоступления ЕСТЬ NULL
		|		ТОГДА КПУ.ДокументПоступления
		|		ИНАЧЕ ДКПУ.ДокументПоступления
		|	КОНЕЦ КАК ДокументПоступления,
		|	ВЫБОР 
		|		КОГДА ДКПУ.ДокументПоступления ЕСТЬ NULL
		|		ТОГДА КПУ.Количество
		|		ИНАЧЕ ДКПУ.Количество
		|	КОНЕЦ КАК Количество
		|ПОМЕСТИТЬ НеСумированныйКешПервогоУровня	
		|ИЗ
		|	ПредварительныйКешПервогоУровня КАК КПУ
		|	
		|ЛЕВОЕ СОЕДИНЕНИЕ ДополнениеКешПервогоУровня КАК ДКПУ
		|ПО	ДКПУ.АналитикаУчетаНоменклатуры = КПУ.АналитикаУчетаНоменклатуры
		|И	ДКПУ.ДокументПеремещения        = ВЫРАЗИТЬ(КПУ.ДокументПоступления КАК Документ.ПеремещениеТоваров)
		|И	ВЫБОР 
		|		КОГДА ДКПУ.Регистратор Ссылка Документ.РеализацияТоваровУслуг
		|		ТОГДА ВЫРАЗИТЬ(ДКПУ.Регистратор КАК Документ.РеализацияТоваровУслуг) 		= ВЫРАЗИТЬ(КПУ.Регистратор КАК Документ.РеализацияТоваровУслуг)
		|		КОГДА ДКПУ.Регистратор Ссылка Документ.ПеремещениеТоваров
		|		ТОГДА ВЫРАЗИТЬ(ДКПУ.Регистратор КАК Документ.ПеремещениеТоваров) 			= ВЫРАЗИТЬ(КПУ.Регистратор КАК Документ.ПеремещениеТоваров)
		|		КОГДА ДКПУ.Регистратор Ссылка Документ.СборкаТоваров
		|		ТОГДА ВЫРАЗИТЬ(ДКПУ.Регистратор КАК Документ.СборкаТоваров) 				= ВЫРАЗИТЬ(КПУ.Регистратор КАК Документ.СборкаТоваров)
		|		КОГДА ДКПУ.Регистратор Ссылка Документ.ВозвратТоваровПоставщику
		|		ТОГДА ВЫРАЗИТЬ(ДКПУ.Регистратор КАК Документ.ВозвратТоваровПоставщику) 		= ВЫРАЗИТЬ(КПУ.Регистратор КАК Документ.ВозвратТоваровПоставщику)
		|		КОГДА ДКПУ.Регистратор Ссылка Документ.СписаниеНедостачТоваров
		|		ТОГДА ВЫРАЗИТЬ(ДКПУ.Регистратор КАК Документ.СписаниеНедостачТоваров) 		= ВЫРАЗИТЬ(КПУ.Регистратор КАК Документ.СписаниеНедостачТоваров)
		|		КОГДА ДКПУ.Регистратор Ссылка Документ.ВнутреннееПотреблениеТоваров
		|		ТОГДА ВЫРАЗИТЬ(ДКПУ.Регистратор КАК Документ.ВнутреннееПотреблениеТоваров) 	= ВЫРАЗИТЬ(КПУ.Регистратор КАК Документ.ВнутреннееПотреблениеТоваров)
		|	КОНЕЦ	
		|;
		//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		//X13.
		|ВЫБРАТЬ
		|	Период,	
		|	Регистратор,
		|	АналитикаУчетаНоменклатуры,
		|	Поставщик,
		|	ДокументПоступления,
		|	СУММА(Количество) КАК Количество
		|ПОМЕСТИТЬ КешПервогоУровня	
		|ИЗ
		|	НеСумированныйКешПервогоУровня
		|
		|СГРУППИРОВАТЬ ПО
		|	Период,	
		|	Регистратор,
		|	АналитикаУчетаНоменклатуры,
		|	Поставщик,
		|	ДокументПоступления
		|;
		//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ ПредварительныйКешПервогоУровня;
		|УНИЧТОЖИТЬ НеСумированныйКешПервогоУровня;
		|УНИЧТОЖИТЬ ДополнениеКешПервогоУровня;
		//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		//Х17.
		|ВЫБРАТЬ
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)									КАК ВидДвижения, 
		|	КешПервогоУровня.Период													КАК Период,
		|	ВЫРАЗИТЬ(КешПервогоУровня.Регистратор КАК Документ.ПеремещениеТоваров) 	КАК Регистратор,
		|	КешПервогоУровня.АналитикаУчетаНоменклатуры								КАК АналитикаУчетаНоменклатуры,
		|	КешПервогоУровня.Поставщик												КАК Поставщик,
		|	КешПервогоУровня.ДокументПоступления									КАК ДокументПоступления,
		|	КешПервогоУровня.Количество												КАК Количество	
		|ПОМЕСТИТЬ КешВторогоУровня
		|ИЗ
		|	КешПервогоУровня КАК КешПервогоУровня	
		|ГДЕ
		|	КешПервогоУровня.Регистратор Ссылка Документ.ПеремещениеТоваров
		|И (	
		| 	КешПервогоУровня.ДокументПоступления Ссылка Документ.ВводОстатков
		|ИЛИ	КешПервогоУровня.ДокументПоступления Ссылка Документ.СборкаТоваров
		|ИЛИ	КешПервогоУровня.ДокументПоступления Ссылка Документ.ВозвратТоваровОтКлиента
		|ИЛИ	КешПервогоУровня.ДокументПоступления Ссылка Документ.ПоступлениеТоваровУслуг
		|ИЛИ	КешПервогоУровня.ДокументПоступления Ссылка Документ.ОприходованиеИзлишковТоваров
		| )
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход),
		|	КешПервогоУровня.Период,
		|	ВЫРАЗИТЬ(КешПервогоУровня.Регистратор КАК Документ.ПеремещениеТоваров),
		|	СБ.АналитикаУчетаНоменклатуры,
		|	КешПервогоУровня.Поставщик,
		|	КешПервогоУровня.ДокументПоступления,
		|	КешПервогоУровня.Количество		
		|ИЗ
		|	РегистрНакопления.СебестоимостьТоваров.Обороты(&НачалоПериода, &КонецПериода, Регистратор) КАК СБ
		|
		|ВНУТРЕННЕЕ СОЕДИНЕНИЕ КешПервогоУровня КАК КешПервогоУровня
		|ПО	ВЫРАЗИТЬ(КешПервогоУровня.Регистратор КАК Документ.ПеремещениеТоваров) = ВЫРАЗИТЬ(СБ.Регистратор КАК Документ.ПеремещениеТоваров)
		|И	КешПервогоУровня.АналитикаУчетаНоменклатуры.Номенклатура = СБ.АналитикаУчетаНоменклатуры.Номенклатура
		|И (
		|		КешПервогоУровня.ДокументПоступления Ссылка Документ.ВводОстатков
		|ИЛИ	КешПервогоУровня.ДокументПоступления Ссылка Документ.СборкаТоваров
		|ИЛИ	КешПервогоУровня.ДокументПоступления Ссылка Документ.ВозвратТоваровОтКлиента
		|ИЛИ	КешПервогоУровня.ДокументПоступления Ссылка Документ.ПоступлениеТоваровУслуг
		|ИЛИ	КешПервогоУровня.ДокументПоступления Ссылка Документ.ОприходованиеИзлишковТоваров 
		|  )
		|
		|ГДЕ
		|	СБ.Регистратор Ссылка Документ.ПеремещениеТоваров
		|И	СБ.КоличествоОборот > 0
		|;";
	Возврат ТекстЗапроса;
	
КонецФункции // ПолучитьТекстЗапросаРекурсивныеДвижения() 

Функция ПолучитьТекстЗапросаДвиженийРасход()
	
	ТекстЗапроса = "
		//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		//Z0.
		|ВЫБРАТЬ
		|	*
		|ИЗ
		|	КешВторогоУровня	
		|ИТОГИ ПО
		|	Регистратор
		|;
		//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ КешВторогоУровня;
		//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		//Z2.
		|ВЫБРАТЬ
		|	*
		|ПОМЕСТИТЬ ДвижениеТоваров
		|ИЗ
		|	РегистрНакопления.КТС_ДвижениеТоваровПоставщиков КАК ДвижениеТоваров	
		|ГДЕ
		|	ДвижениеТоваров.Период 		>= &НачалоПериода
		|И	ДвижениеТоваров.Период 		<= &КонецПериода
		|И	ДвижениеТоваров.ВидДвижения  = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
		|;	
		//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		//Z3.
		|ВЫБРАТЬ
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)							КАК ВидДвижения,
		|	РТиУ.Период														КАК Период,
		|	ВЫРАЗИТЬ(РТиУ.Регистратор КАК Документ.РеализацияТоваровУслуг)	КАК Регистратор,
		|	РТиУ.АналитикаУчетаНоменклатуры 								КАК АналитикаУчетаНоменклатуры,
		|	РТиУ.Поставщик						 							КАК Поставщик,
		|	РТиУ.ДокументПоступления										КАК ДокументПоступления,
		|	РТиУ.Количество													КАК Количество
		|ПОМЕСТИТЬ КешРТиУ							
		|ИЗ
		|	КешПервогоУровня КАК РТиУ						
		|
		|ГДЕ
		|	Регистратор Ссылка Документ.РеализацияТоваровУслуг
		|	
		|ИНДЕКСИРОВАТЬ ПО
		|	Регистратор,
		|	АналитикаУчетаНоменклатуры	
		|;
		//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		//Z4.
		|ВЫБРАТЬ
		|	РТиУ.Регистратор
		|ПОМЕСТИТЬ ДокументыДляЗаписиРТиУ		
		|ИЗ
		|	КешРТиУ КАК РТиУ
		|		
		|ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.КТС_ДвижениеТоваровПоставщиков КАК ДвижениеТоваров
		|ПО	ВЫРАЗИТЬ(ДвижениеТоваров.Регистратор КАК Документ.РеализацияТоваровУслуг) 	= РТиУ.Регистратор
		|И	ДвижениеТоваров.АналитикаУчетаНоменклатуры 						 			= РТиУ.АналитикаУчетаНоменклатуры
		|
		|ГДЕ
		|		IsNull(РТиУ.Поставщик, 0) 			<> IsNull(ДвижениеТоваров.Поставщик, 0)  
		|ИЛИ	IsNull(РТиУ.ДокументПоступления, 0) <> IsNull(ДвижениеТоваров.ДокументПоступления, 0) 
		|ИЛИ	IsNull(РТиУ.Количество, 0) 			<> IsNull(ДвижениеТоваров.Количество, 0) 
		|
		|ОБЪЕДИНИТЬ 
		|
		|ВЫБРАТЬ
		|	ВЫРАЗИТЬ(ДвижениеТоваров.Регистратор КАК Документ.РеализацияТоваровУслуг)		
		|ИЗ
		|	ДвижениеТоваров КАК ДвижениеТоваров
		|		
		|ЛЕВОЕ СОЕДИНЕНИЕ КешРТиУ КАК РТиУ
		|ПО	РТиУ.Регистратор 			   	= ВЫРАЗИТЬ(ДвижениеТоваров.Регистратор КАК Документ.РеализацияТоваровУслуг)
		|И	РТиУ.АналитикаУчетаНоменклатуры = ДвижениеТоваров.АналитикаУчетаНоменклатуры
		|
		|ГДЕ
		|	ДвижениеТоваров.Регистратор			Ссылка	Документ.РеализацияТоваровУслуг
		|И (	IsNull(РТиУ.Поставщик, 0) 			<> 	IsNull(ДвижениеТоваров.Поставщик, 0)
		|ИЛИ	IsNull(РТиУ.ДокументПоступления, 0) <> 	IsNull(ДвижениеТоваров.ДокументПоступления, 0) 
		|ИЛИ	IsNull(РТиУ.Количество, 0) 			<> 	IsNull(ДвижениеТоваров.Количество, 0)
		|  ) 
		|
		|ИНДЕКСИРОВАТЬ ПО
		|	РТиУ.Регистратор	
		|;
		////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		//Z5. 
		|ВЫБРАТЬ
		|	РТиУ.ВидДвижения,
		|	РТиУ.Период,
		|	РТиУ.Регистратор,
		|	РТиУ.АналитикаУчетаНоменклатуры,
		|	РТиУ.Поставщик,
		|	РТиУ.ДокументПоступления,
		|	РТиУ.Количество
		|ИЗ
		|	КешРТиУ КАК РТиУ
		|	
		|ВНУТРЕННЕЕ СОЕДИНЕНИЕ ДокументыДляЗаписиРТиУ КАК ДокументыДляЗаписи
		|ПО	ДокументыДляЗаписи.Регистратор = РТиУ.Регистратор
		|
		|ИТОГИ ПО
		|	РТиУ.Регистратор
		|;
		//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ КешРТиУ;
		|УНИЧТОЖИТЬ ДокументыДляЗаписиРТиУ;
		//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		//Z8.
		|ВЫБРАТЬ
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)				КАК ВидДвижения,
		|	СТ.Период											КАК Период,
		|	ВЫРАЗИТЬ(СТ.Регистратор КАК Документ.СборкаТоваров)	КАК Регистратор,
		|	СТ.АналитикаУчетаНоменклатуры 						КАК АналитикаУчетаНоменклатуры,
		|	СТ.Поставщик						 				КАК Поставщик,
		|	СТ.ДокументПоступления								КАК ДокументПоступления,
		|	СТ.Количество										КАК Количество
		|ПОМЕСТИТЬ КешСТ							
		|ИЗ
		|	КешПервогоУровня КАК СТ						
		|
		|ГДЕ
		|	Регистратор Ссылка Документ.СборкаТоваров
		|	
		|ИНДЕКСИРОВАТЬ ПО
		|	Регистратор,
		|	АналитикаУчетаНоменклатуры	
		|;
		//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		//Z9.
		|ВЫБРАТЬ
		|	СТ.Регистратор
		|ПОМЕСТИТЬ ДокументыДляЗаписиСТ		
		|ИЗ
		|	КешСТ КАК СТ
		|		
		|ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.КТС_ДвижениеТоваровПоставщиков КАК ДвижениеТоваров
		|ПО	ВЫРАЗИТЬ(ДвижениеТоваров.Регистратор КАК Документ.СборкаТоваров) = СТ.Регистратор
		|И	ДвижениеТоваров.АналитикаУчетаНоменклатуры 						 = СТ.АналитикаУчетаНоменклатуры
		|
		|ГДЕ
		|		IsNull(СТ.Поставщик, 0) 			<> IsNull(ДвижениеТоваров.Поставщик, 0)
		|ИЛИ	IsNull(СТ.ДокументПоступления, 0) 	<> IsNull(ДвижениеТоваров.ДокументПоступления, 0) 
		|ИЛИ	IsNull(СТ.Количество, 0) 			<> IsNull(ДвижениеТоваров.Количество, 0) 
		|
		|ОБЪЕДИНИТЬ 
		|
		|ВЫБРАТЬ
		|	ВЫРАЗИТЬ(ДвижениеТоваров.Регистратор КАК Документ.СборкаТоваров)		
		|ИЗ
		|	ДвижениеТоваров КАК ДвижениеТоваров
		|		
		|ЛЕВОЕ СОЕДИНЕНИЕ КешСТ КАК СТ
		|ПО	СТ.Регистратор 			   		= ВЫРАЗИТЬ(ДвижениеТоваров.Регистратор КАК Документ.СборкаТоваров)
		|И	СТ.АналитикаУчетаНоменклатуры 	= ДвижениеТоваров.АналитикаУчетаНоменклатуры
		|
		|ГДЕ
		|	ДвижениеТоваров.Регистратор			Ссылка	Документ.СборкаТоваров
		|И (	IsNull(СТ.Поставщик, 0) 			<> 	IsNull(ДвижениеТоваров.Поставщик, 0) 
		|ИЛИ	IsNull(СТ.ДокументПоступления, 0) 	<> 	IsNull(ДвижениеТоваров.ДокументПоступления, 0) 
		|ИЛИ	IsNull(СТ.Количество, 0) 			<> 	IsNull(ДвижениеТоваров.Количество, 0)
		|  ) 
		|
		|ИНДЕКСИРОВАТЬ ПО
		|	СТ.Регистратор	
		|;
		////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		//Z10. 
		|ВЫБРАТЬ
		|	СТ.ВидДвижения,
		|	СТ.Период,
		|	СТ.Регистратор,
		|	СТ.АналитикаУчетаНоменклатуры,
		|	СТ.Поставщик,
		|	СТ.ДокументПоступления,
		|	СТ.Количество,
		|	ДАТАВРЕМЯ(1, 1, 1) КАК ДатаПрихода
		|ИЗ
		|	КешСТ КАК СТ
		|	
		|ВНУТРЕННЕЕ СОЕДИНЕНИЕ ДокументыДляЗаписиСТ КАК ДокументыДляЗаписи
		|ПО	ДокументыДляЗаписи.Регистратор = СТ.Регистратор
		|
		|ОБЪЕДИНИТЬ 
		|
		|ВЫБРАТЬ
		|	ДвижениеТоваров.ВидДвижения,
		|	ДвижениеТоваров.Период,
		|	ВЫРАЗИТЬ(ДвижениеТоваров.Регистратор КАК Документ.СборкаТоваров),
		|	ДвижениеТоваров.АналитикаУчетаНоменклатуры,
		|	ДвижениеТоваров.Поставщик,
		|	ДвижениеТоваров.ДокументПоступления,
		|	ДвижениеТоваров.Количество,
		|	ДвижениеТоваров.ДатаПрихода
		|ИЗ
		|	РегистрНакопления.КТС_ДвижениеТоваровПоставщиков КАК ДвижениеТоваров
		|
		|ВНУТРЕННЕЕ СОЕДИНЕНИЕ ДокументыДляЗаписиСТ КАК ДокументыДляЗаписи
		|ПО	ДокументыДляЗаписи.Регистратор = ВЫРАЗИТЬ(ДвижениеТоваров.Регистратор КАК Документ.СборкаТоваров)
		|
		|ГДЕ
		|	ДвижениеТоваров.Регистратор	 Ссылка	Документ.СборкаТоваров
		|И	ДвижениеТоваров.ВидДвижения  = Значение(ВидДвиженияНакопления.Приход)		
		|
		|ИТОГИ ПО
		|	СТ.Регистратор
		|;
		//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ КешСТ;
		|УНИЧТОЖИТЬ ДокументыДляЗаписиСТ;
		//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		//Z13.
		|ВЫБРАТЬ
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)							КАК ВидДвижения,
		|	ВТП.Период														КАК Период,
		|	ВЫРАЗИТЬ(ВТП.Регистратор КАК Документ.ВозвратТоваровПоставщику)	КАК Регистратор,
		|	ВТП.АналитикаУчетаНоменклатуры 									КАК АналитикаУчетаНоменклатуры,
		|	ВТП.Поставщик						 							КАК Поставщик,
		|	ВТП.ДокументПоступления											КАК ДокументПоступления,
		|	ВТП.Количество													КАК Количество
		|ПОМЕСТИТЬ КешВТП							
		|ИЗ
		|	КешПервогоУровня КАК ВТП						
		|
		|ГДЕ
		|	Регистратор Ссылка Документ.ВозвратТоваровПоставщику
		|	
		|ИНДЕКСИРОВАТЬ ПО
		|	Регистратор,
		|	АналитикаУчетаНоменклатуры	
		|;
		//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		//Z14.
		|ВЫБРАТЬ
		|	ВТП.Регистратор
		|ПОМЕСТИТЬ ДокументыДляЗаписиВТП		
		|ИЗ
		|	КешВТП КАК ВТП
		|		
		|ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.КТС_ДвижениеТоваровПоставщиков КАК ДвижениеТоваров
		|ПО	ВЫРАЗИТЬ(ДвижениеТоваров.Регистратор КАК Документ.ВозвратТоваровПоставщику) = ВТП.Регистратор
		|И	ДвижениеТоваров.АналитикаУчетаНоменклатуры 						 			= ВТП.АналитикаУчетаНоменклатуры
		|
		|ГДЕ
		|		IsNull(ВТП.Поставщик, 0) 			<> IsNull(ДвижениеТоваров.Поставщик, 0)  
		|ИЛИ	IsNull(ВТП.ДокументПоступления, 0) 	<> IsNull(ДвижениеТоваров.ДокументПоступления, 0) 
		|ИЛИ	IsNull(ВТП.Количество, 0) 			<> IsNull(ДвижениеТоваров.Количество, 0) 
		|
		|ОБЪЕДИНИТЬ 
		|
		|ВЫБРАТЬ
		|	ВЫРАЗИТЬ(ДвижениеТоваров.Регистратор КАК Документ.ВозвратТоваровПоставщику)		
		|ИЗ
		|	ДвижениеТоваров КАК ДвижениеТоваров
		|		
		|ЛЕВОЕ СОЕДИНЕНИЕ КешВТП КАК ВТП
		|ПО	ВТП.Регистратор 			   	= ВЫРАЗИТЬ(ДвижениеТоваров.Регистратор КАК Документ.ВозвратТоваровПоставщику)
		|И	ВТП.АналитикаУчетаНоменклатуры 	= ДвижениеТоваров.АналитикаУчетаНоменклатуры
		|
		|ГДЕ
		|	ДвижениеТоваров.Регистратор			Ссылка	Документ.ВозвратТоваровПоставщику
		|И (	IsNull(ВТП.Поставщик, 0) 			<> 	IsNull(ДвижениеТоваров.Поставщик, 0) 
		|ИЛИ	IsNull(ВТП.ДокументПоступления, 0) 	<> 	IsNull(ДвижениеТоваров.ДокументПоступления, 0) 
		|ИЛИ	IsNull(ВТП.Количество, 0) 			<> 	IsNull(ДвижениеТоваров.Количество, 0)
		|  ) 
		|
		|ИНДЕКСИРОВАТЬ ПО
		|	ВТП.Регистратор	
		|;
		////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		//Z15. 
		|ВЫБРАТЬ
		|	ВТП.ВидДвижения,
		|	ВТП.Период,
		|	ВТП.Регистратор,
		|	ВТП.АналитикаУчетаНоменклатуры,
		|	ВТП.Поставщик,
		|	ВТП.ДокументПоступления,
		|	ВТП.Количество
		|ИЗ
		|	КешВТП КАК ВТП
		|	
		|ВНУТРЕННЕЕ СОЕДИНЕНИЕ ДокументыДляЗаписиВТП КАК ДокументыДляЗаписи
		|ПО	ДокументыДляЗаписи.Регистратор = ВТП.Регистратор
		|
		|ИТОГИ ПО
		|	ВТП.Регистратор
		|;
		//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ КешВТП;
		|УНИЧТОЖИТЬ ДокументыДляЗаписиВТП;
		//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		//Z18.
		|ВЫБРАТЬ
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)							КАК ВидДвижения,
		|	СНТ.Период														КАК Период,
		|	ВЫРАЗИТЬ(СНТ.Регистратор КАК Документ.СписаниеНедостачТоваров)	КАК Регистратор,
		|	СНТ.АналитикаУчетаНоменклатуры 									КАК АналитикаУчетаНоменклатуры,
		|	СНТ.Поставщик						 							КАК Поставщик,
		|	СНТ.ДокументПоступления											КАК ДокументПоступления,
		|	СНТ.Количество													КАК Количество
		|ПОМЕСТИТЬ КешСНТ							
		|ИЗ
		|	КешПервогоУровня КАК СНТ						
		|
		|ГДЕ
		|	Регистратор Ссылка Документ.СписаниеНедостачТоваров
		|	
		|ИНДЕКСИРОВАТЬ ПО
		|	Регистратор,
		|	АналитикаУчетаНоменклатуры	
		|;
		//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		//Z19.
		|ВЫБРАТЬ
		|	СНТ.Регистратор
		|ПОМЕСТИТЬ ДокументыДляЗаписиСНТ		
		|ИЗ
		|	КешСНТ КАК СНТ
		|		
		|ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.КТС_ДвижениеТоваровПоставщиков КАК ДвижениеТоваров
		|ПО	ВЫРАЗИТЬ(ДвижениеТоваров.Регистратор КАК Документ.СписаниеНедостачТоваров) 	= СНТ.Регистратор
		|И	ДвижениеТоваров.АналитикаУчетаНоменклатуры 						 			= СНТ.АналитикаУчетаНоменклатуры
		|
		|ГДЕ
		|		IsNull(СНТ.Поставщик, 0) 			<> IsNull(ДвижениеТоваров.Поставщик, 0) 
		|ИЛИ	IsNull(СНТ.ДокументПоступления, 0) 	<> IsNull(ДвижениеТоваров.ДокументПоступления, 0) 
		|ИЛИ	IsNull(СНТ.Количество, 0) 			<> IsNull(ДвижениеТоваров.Количество, 0) 
		|
		|ОБЪЕДИНИТЬ 
		|
		|ВЫБРАТЬ
		|	ВЫРАЗИТЬ(ДвижениеТоваров.Регистратор КАК Документ.СписаниеНедостачТоваров)		
		|ИЗ
		|	ДвижениеТоваров КАК ДвижениеТоваров
		|		
		|ЛЕВОЕ СОЕДИНЕНИЕ КешСНТ КАК СНТ
		|ПО	СНТ.Регистратор 			   	= ВЫРАЗИТЬ(ДвижениеТоваров.Регистратор КАК Документ.СписаниеНедостачТоваров)
		|И	СНТ.АналитикаУчетаНоменклатуры 	= ДвижениеТоваров.АналитикаУчетаНоменклатуры
		|
		|ГДЕ
		|	ДвижениеТоваров.Регистратор			Ссылка	Документ.СписаниеНедостачТоваров
		|И (	IsNull(СНТ.Поставщик, 0) 			<> 	IsNull(ДвижениеТоваров.Поставщик, 0) 
		|ИЛИ	IsNull(СНТ.ДокументПоступления, 0) 	<> 	IsNull(ДвижениеТоваров.ДокументПоступления, 0) 
		|ИЛИ	IsNull(СНТ.Количество, 0) 			<> 	IsNull(ДвижениеТоваров.Количество, 0)
		|  ) 
		|
		|ИНДЕКСИРОВАТЬ ПО
		|	СНТ.Регистратор	
		|;
		////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		//Z20. 
		|ВЫБРАТЬ
		|	СНТ.ВидДвижения,
		|	СНТ.Период,
		|	СНТ.Регистратор,
		|	СНТ.АналитикаУчетаНоменклатуры,
		|	СНТ.Поставщик,
		|	СНТ.ДокументПоступления,
		|	СНТ.Количество
		|ИЗ
		|	КешСНТ КАК СНТ
		|	
		|ВНУТРЕННЕЕ СОЕДИНЕНИЕ ДокументыДляЗаписиСНТ КАК ДокументыДляЗаписи
		|ПО	ДокументыДляЗаписи.Регистратор = СНТ.Регистратор
		|
		|ИТОГИ ПО
		|	СНТ.Регистратор
		|;
		//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ КешСНТ;
		|УНИЧТОЖИТЬ ДокументыДляЗаписиСНТ;
		//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		//Z23.
		|ВЫБРАТЬ
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)								КАК ВидДвижения,
		|	ВПТ.Период															КАК Период,
		|	ВЫРАЗИТЬ(ВПТ.Регистратор КАК Документ.ВнутреннееПотреблениеТоваров)	КАК Регистратор,
		|	ВПТ.АналитикаУчетаНоменклатуры 										КАК АналитикаУчетаНоменклатуры,
		|	ВПТ.Поставщик						 								КАК Поставщик,
		|	ВПТ.ДокументПоступления												КАК ДокументПоступления,
		|	ВПТ.Количество														КАК Количество
		|ПОМЕСТИТЬ КешВПТ							
		|ИЗ
		|	КешПервогоУровня КАК ВПТ						
		|
		|ГДЕ
		|	Регистратор Ссылка Документ.ВнутреннееПотреблениеТоваров
		|	
		|ИНДЕКСИРОВАТЬ ПО
		|	Регистратор,
		|	АналитикаУчетаНоменклатуры	
		|;
		//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		//Z24.
		|ВЫБРАТЬ
		|	ВПТ.Регистратор
		|ПОМЕСТИТЬ ДокументыДляЗаписиВПТ		
		|ИЗ
		|	КешВПТ КАК ВПТ
		|		
		|ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.КТС_ДвижениеТоваровПоставщиков КАК ДвижениеТоваров
		|ПО	ВЫРАЗИТЬ(ДвижениеТоваров.Регистратор КАК Документ.ВнутреннееПотреблениеТоваров) = ВПТ.Регистратор
		|И	ДвижениеТоваров.АналитикаУчетаНоменклатуры 						 				= ВПТ.АналитикаУчетаНоменклатуры
		|
		|ГДЕ
		|		IsNull(ВПТ.Поставщик, 0) 			<> IsNull(ДвижениеТоваров.Поставщик, 0) 
		|ИЛИ	IsNull(ВПТ.ДокументПоступления, 0) 	<> IsNull(ДвижениеТоваров.ДокументПоступления, 0) 
		|ИЛИ	IsNull(ВПТ.Количество, 0) 			<> IsNull(ДвижениеТоваров.Количество, 0) 
		|
		|ОБЪЕДИНИТЬ 
		|
		|ВЫБРАТЬ
		|	ВЫРАЗИТЬ(ДвижениеТоваров.Регистратор КАК Документ.ВнутреннееПотреблениеТоваров)		
		|ИЗ
		|	ДвижениеТоваров КАК ДвижениеТоваров
		|		
		|ЛЕВОЕ СОЕДИНЕНИЕ КешВПТ КАК ВПТ
		|ПО	ВПТ.Регистратор 			   	= ВЫРАЗИТЬ(ДвижениеТоваров.Регистратор КАК Документ.ВнутреннееПотреблениеТоваров)
		|И	ВПТ.АналитикаУчетаНоменклатуры 	= ДвижениеТоваров.АналитикаУчетаНоменклатуры
		|
		|ГДЕ
		|	ДвижениеТоваров.Регистратор			Ссылка	Документ.ВнутреннееПотреблениеТоваров
		|И (	IsNull(ВПТ.Поставщик, 0) 			<> 	IsNull(ДвижениеТоваров.Поставщик, 0) 
		|ИЛИ	IsNull(ВПТ.ДокументПоступления, 0) 	<> 	IsNull(ДвижениеТоваров.ДокументПоступления, 0) 
		|ИЛИ	IsNull(ВПТ.Количество, 0) 			<> 	IsNull(ДвижениеТоваров.Количество, 0)
		|  ) 
		|
		|ИНДЕКСИРОВАТЬ ПО
		|	ВПТ.Регистратор	
		|;
		////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		//Z25. 
		|ВЫБРАТЬ
		|	ВПТ.ВидДвижения,
		|	ВПТ.Период,
		|	ВПТ.Регистратор,
		|	ВПТ.АналитикаУчетаНоменклатуры,
		|	ВПТ.Поставщик,
		|	ВПТ.ДокументПоступления,
		|	ВПТ.Количество
		|ИЗ
		|	КешВПТ КАК ВПТ
		|	
		|ВНУТРЕННЕЕ СОЕДИНЕНИЕ ДокументыДляЗаписиВПТ КАК ДокументыДляЗаписи
		|ПО	ДокументыДляЗаписи.Регистратор = ВПТ.Регистратор
		|
		|ИТОГИ ПО
		|	ВПТ.Регистратор
		|;
		//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ КешВПТ;
		|УНИЧТОЖИТЬ ДокументыДляЗаписиВПТ;
		|УНИЧТОЖИТЬ КешПервогоУровня;
		|УНИЧТОЖИТЬ ДвижениеТоваров;
		|";
	Возврат ТекстЗапроса;
	
КонецФункции // ПолучитьТекстЗапросаДвиженийРасход() 

Функция ПроверитьКонечностьПартий(МенеджерВременныхТаблиц)
	
	Запрос = Новый Запрос;
	Запрос.МенеджерВременныхТаблиц = МенеджерВременныхТаблиц;
	Запрос.Текст = "
		|ВЫБРАТЬ ПЕРВЫЕ 1
		|	АналитикаУчетаНоменклатуры,
		|	ДокументПоступления
		|ИЗ
		|	КешПервогоУровня
		|ГДЕ
		|	ДокументПоступления Ссылка Документ.ПеремещениеТоваров
		|";
	Возврат НЕ Запрос.Выполнить().Пустой();
	
КонецФункции // ПроверитьКонечностьПартий()





// Сведения о внешней обработке

Функция СведенияОВнешнейОбработке() Экспорт
	
	//Версия
	Версия = "2.0.3";            
	
	// Объявим переменную, в которой мы сохраним и вернем "наружу" необходимые данные
    ПараметрыРегистрации = Новый Структура;

    // Объявим еще одну переменную, которая нам потребуется ниже
    МассивНазначений = Новый Массив;
    
    // Первый параметр, который мы должны указать - это какой вид обработки системе должна зарегистрировать. 
    // Допустимые типы: ДополнительнаяОбработка, ДополнительныйОтчет, ЗаполнениеОбъекта, Отчет, ПечатнаяФорма, СозданиеСвязанныхОбъектов
    ПараметрыРегистрации.Вставить("Вид", "ДополнительнаяОбработка");	
	ПараметрыРегистрации.Вставить("Назначение", Новый Массив);
    
    // Теперь зададим имя, под которым ВПФ будет зарегистрирована в справочнике внешних обработок
    ПараметрыРегистрации.Вставить("Наименование", "Движение товаров поставщиков");
    
    // Зададим право обработке на использование безопасного режима. Более подробно можно узнать в справке к платформе (метод УстановитьБезопасныйРежим)
    ПараметрыРегистрации.Вставить("БезопасныйРежим", Ложь);

    // Следующие два параметра играют больше информационную роль, т.е. это то, что будет видеть пользователь в информации к обработке
    ПараметрыРегистрации.Вставить("Версия", Версия);    
    ПараметрыРегистрации.Вставить("Информация", "Движение товаров поставщиков [" + Версия + "]");
    
    // Создадим таблицу команд (подробнее смотрим ниже)
    ТаблицаКоманд = ПолучитьТаблицуКоманд();
    
    // Добавим команду в таблицу
    ДобавитьКоманду(ТаблицаКоманд, "Движение товаров поставщиков [" + Версия + "]", "Движение товаров поставщиков", "ОткрытиеФормы", Ложь, "Движение товаров поставщиков");
	ДобавитьКоманду(ТаблицаКоманд, "Регл. обновление прайс-листов [" + Версия + "]", "ВыполнитьДвиженияПоПартиям();", "ВызовСерверногоМетода");
    
    // Сохраним таблицу команд в параметры регистрации обработки
    ПараметрыРегистрации.Вставить("Команды", ТаблицаКоманд);
    
    // Теперь вернем системе наши параметры
    Возврат ПараметрыРегистрации;
	
КонецФункции

Функция ПолучитьТаблицуКоманд()

   // Создадим пустую таблицу команд и колонки в ней
   Команды = Новый ТаблицаЗначений;

   // Как будет выглядеть описание печатной формы для пользователя
   Команды.Колонки.Добавить("Представление", Новый ОписаниеТипов("Строка")); 

   // Имя нашего макета, что бы могли отличить вызванную команду в обработке печати
   Команды.Колонки.Добавить("Идентификатор", Новый ОписаниеТипов("Строка"));

   // Тут задается, как должна вызваться команда обработки
   // Возможные варианты:
   // - ОткрытиеФормы - в этом случае в колонке идентификатор должно быть указано имя формы, которое должна будет открыть система
   // - ВызовКлиентскогоМетода - вызвать клиентскую экспортную процедуру из модуля формы обработки
   // - ВызовСерверногоМетода - вызвать серверную экспортную процедуру из модуля объекта обработки
   Команды.Колонки.Добавить("Использование", Новый ОписаниеТипов("Строка"));

   // Следующий параметр указывает, необходимо ли показывать оповещение при начале и завершению работы обработки. Не имеет смысла при открытии формы
   Команды.Колонки.Добавить("ПоказыватьОповещение", Новый ОписаниеТипов("Булево"));

   // Для печатной формы должен содержать строку ПечатьMXL 
   Команды.Колонки.Добавить("Модификатор", Новый ОписаниеТипов("Строка"));
   
   Возврат Команды;
   
КонецФункции

Процедура ДобавитьКоманду(ТаблицаКоманд, Представление, Идентификатор, Использование, ПоказыватьОповещение = Ложь, Модификатор = "")
	
  // Добавляем команду в таблицу команд по переданному описанию.
  // Параметры и их значения можно посмотреть в функции ПолучитьТаблицуКоманд
  НоваяКоманда = ТаблицаКоманд.Добавить();
  НоваяКоманда.Представление = Представление;
  НоваяКоманда.Идентификатор = Идентификатор;
  НоваяКоманда.Использование = Использование;
  НоваяКоманда.ПоказыватьОповещение = ПоказыватьОповещение;
  НоваяКоманда.Модификатор = Модификатор;

КонецПроцедуры

Процедура ВыполнитьКоманду(ИдентификаторКоманды) Экспорт
	Если ТипЗнч(ИдентификаторКоманды) = Тип("Строка") Тогда
		Выполнить(ИдентификаторКоманды);
	КонецЕсли;
КонецПроцедуры
