
#Область ОбработчикиСобытий

Процедура ПриКомпоновкеРезультата(ДокументРезультат, ДанныеРасшифровки, СтандартнаяОбработка)
	
	УстановитьПривилегированныйРежим(Истина);
	
	//Соглашения 		= ПолучитьЗначениеПараметра("Соглашения");
	ПериодОтчета 	= ПолучитьЗначениеПараметра("ПериодОтчета");
	
	Если Не ЗначениеЗаполнено(ПериодОтчета) Тогда
		СтандартнаяОбработка = Истина;
		Возврат;
	Иначе
		СтандартнаяОбработка = Ложь;
	КонецЕсли;
	
	ТекстЗапроса = ПолучитьТекстЗапросаКомпоновки();
	
	//Если Соглашения<>Неопределено Тогда
	//	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"%СоглашенияЗаДень%","  Соглашение В(&Соглашение) И  ");
	//	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"%СоглашенияЗаПериод%","  ЦеныНоменклатуры.Соглашение В(&Соглашение) И  ");
	//Иначе
	//	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"%СоглашенияЗаДень%"," ");
	//	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"%СоглашенияЗаПериод%"," ");
	//КонецЕсли;
	
	СформироватьОтчетПрограммно(ТекстЗапроса, ДанныеРасшифровки, ДокументРезультат, ПериодОтчета);
	
КонецПроцедуры

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

Функция ПолучитьТекстЗапросаКомпоновки()

	ТекстЗапроса = "
	
		// КУРСЫ ВАЛЮТ
		|ВЫБРАТЬ
		|	ВЫРАЗИТЬ(КурсыВалют.Курс / КурсыВалют.Кратность КАК ЧИСЛО(15, 4)) КАК Курс,
		|	КурсыВалют.Валюта КАК Валюта,
		|	КурсыВалют.Период КАК Период
		|ПОМЕСТИТЬ КурсыВалют
		|ИЗ
		|	РегистрСведений.КурсыВалют КАК КурсыВалют
		|;
		|
		|ВЫБРАТЬ
		|  	КурсыВалют.Курс,
		|  	КурсыВалют.Валюта,
		|  	КурсыВалют.Период КАК НачалоПериода,
		|  	МИНИМУМ(ЕСТЬNULL(КурсыВалютКопия.Период, ДАТАВРЕМЯ(3999, 1, 1))) КАК КонецПериода
		|ПОМЕСТИТЬ ТаблицаКурсов
		|ИЗ
		|  	КурсыВалют КАК КурсыВалют
		|		
		|ЛЕВОЕ СОЕДИНЕНИЕ КурсыВалют КАК КурсыВалютКопия
		|ПО 	КурсыВалютКопия.Период > КурсыВалют.Период
		|И 	КурсыВалютКопия.Валюта = КурсыВалют.Валюта
		|			
		|СГРУППИРОВАТЬ ПО
		|  	КурсыВалют.Период,
		|  	КурсыВалют.Курс,
		|  	КурсыВалют.Валюта
		|
		|ИНДЕКСИРОВАТЬ ПО 
		|	КурсыВалют.Валюта
		|;
		
		// КОНЕЦ КУРСЫ ВАЛЮТ

	
		// АНАЛИЗ ЗАКАЗОВ
		|ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	ОбработкаЗаказовКлиентов.Номенклатура 										КАК Номенклатура,
		|	ВЫРАЗИТЬ(ОбработкаЗаказовКлиентов.ЗаказКлиента КАК Документ.ЗаказКлиента) 	КАК ЗаказКлиента,
		|	ЗНАЧЕНИЕ(Справочник.ХарактеристикиНоменклатуры.ПустаяСсылка) 				КАК Характеристика,
		|	ОбработкаЗаказовКлиентов.КодСтроки											КАК КодСтроки,
		|	ОбработкаЗаказовКлиентов.КоличествоВЗаказе									КАК КоличествоВЗаказе,
		|	ОбработкаЗаказовКлиентов.ДатаАктуальности									КАК ДатаАктуальности,
		|	ВЫРАЗИТЬ(&ЛогистическийСклад КАК Справочник.Склады)							КАК ЛогистическийСклад
		|ПОМЕСТИТЬ ОбособленнаяНоменклатура
		|ИЗ
		|	РегистрСведений.ОбработкаЗаказовКлиентов КАК ОбработкаЗаказовКлиентов
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ЗаказКлиента.Товары КАК ЗаказКлиентаТовары
		|		ПО ОбработкаЗаказовКлиентов.ЗаказКлиента = ЗаказКлиентаТовары.Ссылка
		|			И ОбработкаЗаказовКлиентов.Номенклатура = ЗаказКлиентаТовары.Номенклатура
		|			И ОбработкаЗаказовКлиентов.КодСтроки = ЗаказКлиентаТовары.КодСтроки
		|		И (ЗаказКлиентаТовары.ОтменитьЗаказПодЗаказ = ЛОЖЬ)
		|			И (ЗаказКлиентаТовары.Отменено = ЛОЖЬ)
		|ГДЕ
		|	ОбработкаЗаказовКлиентов.ЗаказКлиента ССЫЛКА Документ.ЗаказКлиента
		|	И ВЫРАЗИТЬ(ОбработкаЗаказовКлиентов.ЗаказКлиента КАК Документ.ЗаказКлиента).Дата >= &ДатаНачала
		|	И ВЫРАЗИТЬ(ОбработкаЗаказовКлиентов.ЗаказКлиента КАК Документ.ЗаказКлиента).Дата <= &ДатаОкончания
		|	И НЕ ОбработкаЗаказовКлиентов.ДатаАктуальности = ДАТАВРЕМЯ(1, 1, 1, 0, 0, 0)

		|ИНДЕКСИРОВАТЬ ПО
		|	Номенклатура,
		|	ЗаказКлиента
		|;

		|               
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|   ТоварыКПоступлениюОбороты.Период КАК ДатаПоступления,
		|   ОбеспечениеЗаказовОбороты.Номенклатура,
		|   ВЫРАЗИТЬ(ОбеспечениеЗаказовОбороты.Назначение.Заказ КАК Документ.ЗаказКлиента) КАК Заказ,
		|   ОбеспечениеЗаказовОбороты.НаличиеПодЗаказПриход,
		|   ВЫРАЗИТЬ(ОбеспечениеЗаказовОбороты.Регистратор КАК Документ.ПеремещениеТоваров) КАК Регистратор,
		|   ТоварыКПоступлениюОбороты.КПоступлениюРасход КАК КПоступлению
		|ПОМЕСТИТЬ ПоступленияПоОбеспечению
		|ИЗ
		|   РегистрНакопления.ОбеспечениеЗаказов.Обороты(
		|   		&ДатаНачала,
		|   		&КонецСвета,
		|   		Регистратор,
		|   		(Номенклатура, Характеристика, Склад, ВЫРАЗИТЬ(Назначение.Заказ КАК Документ.ЗаказКлиента)) В
		|   			(
		|   				ВЫБРАТЬ
		|   					Номенклатура,
		|   					Характеристика,
		|						ЛогистическийСклад,
		|   					ЗаказКлиента
		|   				ИЗ
		|   					ОбособленнаяНоменклатура)) КАК ОбеспечениеЗаказовОбороты
		|   	ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.ТоварыКПоступлению.Обороты(
		|   			&ДатаНачала,
		|   			&КонецСвета,
		|   			Регистратор,
		|   			Номенклатура В
		|   					(ВЫБРАТЬ
		|   						Номенклатура
		|   					ИЗ
		|   						ОбособленнаяНоменклатура)
		|   				И Склад = &ЛогистическийСклад) КАК ТоварыКПоступлениюОбороты
		|   	ПО ОбеспечениеЗаказовОбороты.Номенклатура = ТоварыКПоступлениюОбороты.Номенклатура
		|   		И ((ВЫРАЗИТЬ(ОбеспечениеЗаказовОбороты.Регистратор КАК Документ.ПеремещениеТоваров)) = (ВЫРАЗИТЬ(ТоварыКПоступлениюОбороты.ДокументПоступления КАК Документ.ПеремещениеТоваров)))
		|ГДЕ
		|   ОбеспечениеЗаказовОбороты.Регистратор ССЫЛКА Документ.ПеремещениеТоваров

		|ОБЪЕДИНИТЬ

		|ВЫБРАТЬ
		|   ОбеспечениеЗаказовОбороты.Период,
		|   ОбеспечениеЗаказовОбороты.Номенклатура,
		|   ВЫРАЗИТЬ(ОбеспечениеЗаказовОбороты.Назначение.Заказ КАК Документ.ЗаказКлиента),
		|   ОбеспечениеЗаказовОбороты.НаличиеПодЗаказПриход,
		|   ВЫРАЗИТЬ(ОбеспечениеЗаказовОбороты.Регистратор КАК Документ.ПоступлениеТоваровУслуг),
		|   ОбеспечениеЗаказовОбороты.НаличиеПодЗаказПриход
		|ИЗ
		|   РегистрНакопления.ОбеспечениеЗаказов.Обороты(
		|   		&ДатаНачала,
		|   		&КонецСвета,
		|   		Регистратор,
		|   		(Номенклатура, Характеристика, Склад, ВЫРАЗИТЬ(Назначение.Заказ КАК Документ.ЗаказКлиента)) В
		|   			(
		|   				ВЫБРАТЬ
		|   					Номенклатура,
		|   					Характеристика,
		|						ЛогистическийСклад,
		|   					ЗаказКлиента
		|   				ИЗ
		|   					ОбособленнаяНоменклатура)) КАК ОбеспечениеЗаказовОбороты
		|ГДЕ
		|   ОбеспечениеЗаказовОбороты.Регистратор ССЫЛКА Документ.ПоступлениеТоваровУслуг

		|ОБЪЕДИНИТЬ

		|ВЫБРАТЬ
		|   ОбеспечениеЗаказовОбороты.Период,
		|   ОбеспечениеЗаказовОбороты.Номенклатура,
		|   ВЫРАЗИТЬ(ОбеспечениеЗаказовОбороты.Назначение.Заказ КАК Документ.ЗаказКлиента),
		|   ОбеспечениеЗаказовОбороты.НаличиеСоСкладаРасход,
		|   ВЫРАЗИТЬ(ОбеспечениеЗаказовОбороты.Регистратор КАК Документ.ПеремещениеТоваров),
		|   ОбеспечениеЗаказовОбороты.НаличиеСоСкладаРасход
		|ИЗ
		|   РегистрНакопления.ОбеспечениеЗаказов.Обороты(
		|   		&ДатаНачала,
		|   		&КонецСвета,
		|   		Регистратор,
		|   		(Номенклатура, Характеристика, Склад, ВЫРАЗИТЬ(Назначение.Заказ КАК Документ.ЗаказКлиента)) В
		|   			(
		|   				ВЫБРАТЬ
		|   					Номенклатура,
		|   					Характеристика,
		|						ЛогистическийСклад,
		|   					ЗаказКлиента
		|   				ИЗ
		|   					ОбособленнаяНоменклатура)) КАК ОбеспечениеЗаказовОбороты
		|ГДЕ
		|   ОбеспечениеЗаказовОбороты.Регистратор ССЫЛКА Документ.ПеремещениеТоваров
		|;

		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|   ОбособленнаяНоменклатура.ЗаказКлиента,
		|   ОбособленнаяНоменклатура.КодСтроки,
		|   ОбособленнаяНоменклатура.Номенклатура,
		|   ОбособленнаяНоменклатура.КоличествоВЗаказе,
		|   ОбособленнаяНоменклатура.ДатаАктуальности,
		|   СУММА(ОбособленнаяНоменклатураКопия.КоличествоВЗаказе) - ОбособленнаяНоменклатура.КоличествоВЗаказе КАК КоличествоВЗаказеДо,
		|   СУММА(ОбособленнаяНоменклатураКопия.КоличествоВЗаказе) КАК КоличествоВЗаказеПосле
		|ПОМЕСТИТЬ ОбособленаяНоменклатураПоНаростающим
		|ИЗ
		|   ОбособленнаяНоменклатура КАК ОбособленнаяНоменклатура
		|   	ЛЕВОЕ СОЕДИНЕНИЕ ОбособленнаяНоменклатура КАК ОбособленнаяНоменклатураКопия
		|   	ПО ОбособленнаяНоменклатура.ЗаказКлиента = ОбособленнаяНоменклатураКопия.ЗаказКлиента
		|   		И ОбособленнаяНоменклатура.Номенклатура = ОбособленнаяНоменклатураКопия.Номенклатура
		|   		И ОбособленнаяНоменклатура.ДатаАктуальности >= ОбособленнаяНоменклатураКопия.ДатаАктуальности
		|   		И (ВЫБОР
		|   			КОГДА ОбособленнаяНоменклатура.ДатаАктуальности = ОбособленнаяНоменклатураКопия.ДатаАктуальности
		|   				ТОГДА ОбособленнаяНоменклатура.КодСтроки >= ОбособленнаяНоменклатураКопия.КодСтроки
		|   			ИНАЧЕ ИСТИНА
		|   		КОНЕЦ)

		|СГРУППИРОВАТЬ ПО
		|   ОбособленнаяНоменклатура.ЗаказКлиента,
		|   ОбособленнаяНоменклатура.КодСтроки,
		|   ОбособленнаяНоменклатура.Номенклатура,
		|   ОбособленнаяНоменклатура.КоличествоВЗаказе,
		|   ОбособленнаяНоменклатура.ДатаАктуальности

		|ИНДЕКСИРОВАТЬ ПО
		|   ОбособленнаяНоменклатура.ЗаказКлиента,
		|   ОбособленнаяНоменклатура.Номенклатура,
		|   ОбособленнаяНоменклатура.КоличествоВЗаказе
		|;

		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|   ПоступленияПоОбеспечению.Заказ,
		|   ПоступленияПоОбеспечению.Регистратор,
		|   ПоступленияПоОбеспечению.Номенклатура,
		|   ПоступленияПоОбеспечению.ДатаПоступления КАК ДатаПоступления,
		|   ПоступленияПоОбеспечению.КПоступлению,
		|   СУММА(ПоступленияПоОбеспечениюКопия.КПоступлению) - ПоступленияПоОбеспечению.КПоступлению КАК КПоступлениюДо,
		|   СУММА(ПоступленияПоОбеспечениюКопия.КПоступлению) КАК КПоступлениюПосле
		|ПОМЕСТИТЬ ПоступленияПоОбеспечениюНаростающие
		|ИЗ
		|   ПоступленияПоОбеспечению КАК ПоступленияПоОбеспечению
		|   	ЛЕВОЕ СОЕДИНЕНИЕ ПоступленияПоОбеспечению КАК ПоступленияПоОбеспечениюКопия
		|   	ПО ПоступленияПоОбеспечению.Заказ = ПоступленияПоОбеспечениюКопия.Заказ
		|   		И ПоступленияПоОбеспечению.Номенклатура = ПоступленияПоОбеспечениюКопия.Номенклатура
		|   		И ПоступленияПоОбеспечению.ДатаПоступления >= ПоступленияПоОбеспечениюКопия.ДатаПоступления
		|   		И (ВЫБОР
		|   			КОГДА ПоступленияПоОбеспечению.ДатаПоступления = ПоступленияПоОбеспечениюКопия.ДатаПоступления
		|   				ТОГДА ПоступленияПоОбеспечению.Регистратор >= ПоступленияПоОбеспечениюКопия.Регистратор
		|   			ИНАЧЕ ИСТИНА
		|   		КОНЕЦ)

		|СГРУППИРОВАТЬ ПО
		|   ПоступленияПоОбеспечению.Заказ,
		|   ПоступленияПоОбеспечению.Регистратор,
		|   ПоступленияПоОбеспечению.Номенклатура,
		|   ПоступленияПоОбеспечению.КПоступлению,
		|   ПоступленияПоОбеспечению.ДатаПоступления
		|ИНДЕКСИРОВАТЬ ПО
		|   ПоступленияПоОбеспечению.Заказ,
		|   ПоступленияПоОбеспечению.Номенклатура
		|;

		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|   ЗаказКлиента 			КАК ЗаказКлиента,
		|   Номенклатура 			КАК Номенклатура,
		|   КоличествоВЗаказеПосле 	КАК Точка
		|ПОМЕСТИТЬ КешТочки
		|ИЗ
		|   ОбособленаяНоменклатураПоНаростающим

		|ОБЪЕДИНИТЬ

		|ВЫБРАТЬ
		|   Заказ,
		|   Номенклатура,
		|   КПоступлениюПосле
		|ИЗ
		|   ПоступленияПоОбеспечениюНаростающие

		|ИНДЕКСИРОВАТЬ ПО
		|   ЗаказКлиента,
		|   Номенклатура
		|;

		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|   КешТочки.ЗаказКлиента 																					КАК ЗаказКлиента,
		|   КешТочки.Номенклатура																					КАК Номенклатура,
		|   ЕСТЬNULL(ОбособленаяНоменклатураПоНаростающим.КодСтроки, 0) 											КАК КодСтроки,
		|   ЕСТЬNULL(ОбособленаяНоменклатураПоНаростающим.КоличествоВЗаказе, 0) 									КАК КоличествоВЗаказе,
		|   ЕСТЬNULL(ОбособленаяНоменклатураПоНаростающим.КоличествоВЗаказеПосле, 0) 								КАК КоличествоВЗаказеПосле,
		|   ЕСТЬNULL(ОбособленаяНоменклатураПоНаростающим.ДатаАктуальности, ДАТАВРЕМЯ(1, 1, 1, 0, 0, 0)) 			КАК ДатаАктуальности,
		|   МАКСИМУМ(ЕСТЬNULL(ПоступленияПоОбеспечениюНаростающие.ДатаПоступления, ДАТАВРЕМЯ(1, 1, 1, 0, 0, 0))) 	КАК ДатаПоступления,
		|   МАКСИМУМ(ЕСТЬNULL(ПоступленияПоОбеспечениюНаростающие.КПоступлениюПосле, 0)) 							КАК КПоступлениюПосле
		|ПОМЕСТИТЬ ОбъединенияПоНаростающим
		|ИЗ
		|   КешТочки КАК КешТочки
		|   	ЛЕВОЕ СОЕДИНЕНИЕ ОбособленаяНоменклатураПоНаростающим КАК ОбособленаяНоменклатураПоНаростающим
		|   	ПО КешТочки.ЗаказКлиента = ОбособленаяНоменклатураПоНаростающим.ЗаказКлиента
		|   		И КешТочки.Номенклатура = ОбособленаяНоменклатураПоНаростающим.Номенклатура
		|   		И КешТочки.Точка <= ОбособленаяНоменклатураПоНаростающим.КоличествоВЗаказеПосле
		|   		И КешТочки.Точка > ОбособленаяНоменклатураПоНаростающим.КоличествоВЗаказеДо
		|   	ЛЕВОЕ СОЕДИНЕНИЕ ПоступленияПоОбеспечениюНаростающие КАК ПоступленияПоОбеспечениюНаростающие
		|   	ПО КешТочки.ЗаказКлиента = ПоступленияПоОбеспечениюНаростающие.Заказ
		|   		И КешТочки.Номенклатура = ПоступленияПоОбеспечениюНаростающие.Номенклатура
		|   		И КешТочки.Точка <= ПоступленияПоОбеспечениюНаростающие.КПоступлениюПосле
		|   		И КешТочки.Точка > ПоступленияПоОбеспечениюНаростающие.КПоступлениюДо

		|СГРУППИРОВАТЬ ПО
		|   КешТочки.ЗаказКлиента,
		|   КешТочки.Номенклатура,
		|   ЕСТЬNULL(ОбособленаяНоменклатураПоНаростающим.ДатаАктуальности, ДАТАВРЕМЯ(1, 1, 1, 0, 0, 0)),
		|   ЕСТЬNULL(ОбособленаяНоменклатураПоНаростающим.КодСтроки, 0),
		|   ЕСТЬNULL(ОбособленаяНоменклатураПоНаростающим.КоличествоВЗаказеПосле, 0),
		|   ЕСТЬNULL(ОбособленаяНоменклатураПоНаростающим.КоличествоВЗаказе, 0)
		|;

		// КОНЕЦ АНАЛИЗА ЗАКАЗОВ
		
		
		
		// ОБЩИЕ ОСТАТКИ ТОВАРОВ НА СКЛАДАХ
			
		|ВЫБРАТЬ
		|	Номенклатура						КАК Номенклатура,
		|	ВНаличииОстаток - ВРезервеОстаток 	КАК ОбщийОстатокНаСкладе
		|ПОМЕСТИТЬ ОстаткиТоваровОбщие	
		|ИЗ
		|	 РегистрНакопления.СвободныеОстатки.Остатки(&ДатаОкончания, Номенклатура В (ВЫБРАТЬ Номенклатура ИЗ ОбособленнаяНоменклатура))
		|;

		
		// КОНЕЦ ОБЩИЕ ОСТАТКИ ТОВАРОВ НА СКЛАДАХ
		
		
		
		
		// Результирующий запрос
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|   ОбъединенияПоНаростающим.ЗаказКлиента 		КАК ЗаказКлиента,
		|	ОбъединенияПоНаростающим.ЗаказКлиента.Склад	КАК Склад,
		|   ОбъединенияПоНаростающим.Номенклатура 		КАК Номенклатура,
		|   ОбъединенияПоНаростающим.ДатаАктуальности 	КАК ДатаАктуальности,
		|   ОбъединенияПоНаростающим.ДатаПоступления 	КАК ДатаПоступления,
		|   1 КАК КоличествоЗаказов,
		|   ВЫБОР
		|   	КОГДА НАЧАЛОПЕРИОДА(ОбъединенияПоНаростающим.ДатаПоступления, ДЕНЬ) = ДАТАВРЕМЯ(1, 1, 1, 0, 0, 0)
		|   			И ОбъединенияПоНаростающим.ДатаАктуальности < &ТекущаяДата
		|   		ТОГДА 1
		|   	КОГДА ОбъединенияПоНаростающим.КПоступлениюПосле < ОбъединенияПоНаростающим.КоличествоВЗаказеПосле
		|   			И ОбъединенияПоНаростающим.ДатаАктуальности < &ТекущаяДата
		|   		ТОГДА 1
		|   	КОГДА ОбъединенияПоНаростающим.ДатаАктуальности < НАЧАЛОПЕРИОДА(ОбъединенияПоНаростающим.ДатаПоступления, ДЕНЬ)
		|   			И ОбъединенияПоНаростающим.ДатаАктуальности < &ТекущаяДата
		|   		ТОГДА 1
		|   КОНЕЦ КАК Залет,
		|   ОбъединенияПоНаростающим.Номенклатура.ВидНоменклатуры КАК ВидыНоменклатуры,
		|   ОбъединенияПоНаростающим.КоличествоВЗаказе КАК КоличествоВЗаказе,
		|	ЕСТЬNULL(ОстаткиТоваровОбщие.ОбщийОстатокНаСкладе, 0) КАК ОбщийОстатокНаСкладе
		|ИЗ
		|   ОбособленнаяНоменклатура КАК ОбособленнаяНоменклатура
		|
		|   	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ОбъединенияПоНаростающим КАК ОбъединенияПоНаростающим
		|   	ПО ОбособленнаяНоменклатура.Номенклатура = ОбъединенияПоНаростающим.Номенклатура
		|   		И ОбособленнаяНоменклатура.ЗаказКлиента = ОбъединенияПоНаростающим.ЗаказКлиента
		|   		И ОбособленнаяНоменклатура.КодСтроки = ОбъединенияПоНаростающим.КодСтроки
		|
		|		ЛЕВОЕ СОЕДИНЕНИЕ ОстаткиТоваровОбщие КАК ОстаткиТоваровОбщие
		|		ПО ОбособленнаяНоменклатура.Номенклатура = ОстаткиТоваровОбщие.Номенклатура
		|ГДЕ
		|   ОбъединенияПоНаростающим.ДатаАктуальности <> ДАТАВРЕМЯ(1, 1, 1, 0, 0, 0)
		|";
	
	Возврат ТекстЗапроса;

КонецФункции // ПолучитьТекстЗапросаКомпоновки()

Процедура СформироватьОтчетПрограммно(ТекстЗапроса, ДанныеРасшифровки, ДокументРезультат, ПериодОтчета)
		
	НаборыДанных 	= СхемаКомпоновкиДанных.НаборыДанных;
	ОсновнойНабор   = НаборыДанных.Найти("НаборДанных1");
	
	Если ОсновнойНабор = Неопределено Тогда
		ВызватьИсключение НСтр("ru='Отчет сломался. Сообщите в службу поддержки.'", ОбщегоНазначенияКлиентСервер.КодОсновногоЯзыка());
	КонецЕсли;
	
	ОсновнойНабор.Запрос = ТекстЗапроса;
	
	УстановитьПараметрыКомпоновкиДанных(КомпоновщикНастроек, ПериодОтчета);
	
	НастройкиОтчета = КомпоновщикНастроек.ПолучитьНастройки();
	
	КомпоновщикМакета = Новый КомпоновщикМакетаКомпоновкиДанных;
	МакетКомпоновки = КомпоновщикМакета.Выполнить(СхемаКомпоновкиДанных, НастройкиОтчета, ДанныеРасшифровки, , , Ложь);
	
	ПроцессорКомпоновки = Новый ПроцессорКомпоновкиДанных;
	ПроцессорКомпоновки.Инициализировать(МакетКомпоновки, , ДанныеРасшифровки);
	
	ПроцессорВывода = Новый ПроцессорВыводаРезультатаКомпоновкиДанныхВТабличныйДокумент;
	ПроцессорВывода.УстановитьДокумент(ДокументРезультат);
	ПроцессорВывода.Вывести(ПроцессорКомпоновки);

КонецПроцедуры

Процедура УстановитьПараметрыКомпоновкиДанных(КомпоновщикНастроек, ПериодОтчета)

	ПараметрыДанных 	= КомпоновщикНастроек.Настройки.ПараметрыДанных;
	
	ЛогистическийСклад	= Справочники.Склады.ПолучитьСсылку(Новый УникальныйИдентификатор("d10d3409-40c2-11e0-9f98-001517115d85")); // Склад Соборна
	УстановитьЗначениеПараметраКомпоновкиДанных("ЛогистическийСклад", ЛогистическийСклад, ПараметрыДанных);
	
	УстановитьЗначениеПараметраКомпоновкиДанных("ТекущаяДата", ТекущаяДата(), ПараметрыДанных);
	
	ВалютаУпрУчета = Константы.ВалютаУправленческогоУчета.Получить();
	УстановитьЗначениеПараметраКомпоновкиДанных("ВалютаУпрУчета", ВалютаУпрУчета, ПараметрыДанных);
	
	УстановитьЗначениеПараметраКомпоновкиДанных("КонецСвета", Дата("39990101000000"), ПараметрыДанных);
	
	Если ПериодОтчета <> Неопределено Тогда
		УстановитьЗначениеПараметраКомпоновкиДанных("ДатаНачала", ПериодОтчета.ДатаНачала, ПараметрыДанных);
		УстановитьЗначениеПараметраКомпоновкиДанных("ДатаОкончания", ПериодОтчета.ДатаОкончания, ПараметрыДанных);
	КонецЕсли;

КонецПроцедуры

Процедура УстановитьЗначениеПараметраКомпоновкиДанных(ИмяПараметра, ЗначениеПараметра, ПараметрыДанных)

	Параметр = ПараметрыДанных.НайтиЗначениеПараметра(Новый ПараметрКомпоновкиДанных(ИмяПараметра));
	
	Если Параметр = Неопределено Тогда
		ТекстСообщения = НСтр("ru='Не удалось получить параметр «%1». Обратитесь в службу технической поддержки.'", ОбщегоНазначенияКлиентСервер.КодОсновногоЯзыка());
		ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(ТекстСообщения, ИмяПараметра);
		ВызватьИсключение ТекстСообщения;
	КонецЕсли;
	
	Параметр.Значение 		= ЗначениеПараметра;
	Параметр.Использование  = Истина;

КонецПроцедуры

Функция ПолучитьЗначениеПараметра(ИмяПараметра)
	
	ПараметрДанных = КомпоновщикНастроек.Настройки.ПараметрыДанных.Элементы.Найти(ИмяПараметра);
	Если ПараметрДанных <> Неопределено Тогда
		ПараметрПользовательскойНастройки = КомпоновщикНастроек.ПользовательскиеНастройки.Элементы.Найти(ПараметрДанных.ИдентификаторПользовательскойНастройки);
		Если ПараметрПользовательскойНастройки <> Неопределено Тогда
			Возврат ПараметрПользовательскойНастройки.Значение;
		Иначе
			Возврат ПараметрДанных.Значение;
		КонецЕсли;
	КонецЕсли;
	
	Возврат Неопределено;
	
КонецФункции

#КонецОбласти