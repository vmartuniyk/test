

#Область ОбработчикиСобытийФормы

&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	
	ОбновитьУправлениеНаСервере();
	
КонецПроцедуры

&НаСервере
Процедура ПриЗагрузкеДанныхИзНастроекНаСервере(Настройки)
	
	//ОбновитьУправлениеНаСервере();
	
КонецПроцедуры
	
#КонецОбласти

#Область ОбработчикиСобытийЭлементовФормы

#Область ОбработчикСобытийСтраницыУправление

&НаКлиенте
Процедура ГруппаВидаНоменклатурыПриИзменении(Элемент)
	ОбновитьУправлениеНаСервере();
КонецПроцедуры

&НаКлиенте
Процедура УправлениеАссортиментнойМатрицейПриИзменении(Элемент)
	
	Отказ = Ложь;
	Если ТекущиеДанныеОпределены(Элемент) Тогда
		
		ТекущиеДанные = Элемент.ТекущиеДанные;
		РодительДанных = ТекущиеДанные.ПолучитьРодителя();
		
		Если РодительДанных.ВидНоменклатуры = ПредопределенноеЗначение("Справочник.ВидыНоменклатуры.ПустаяСсылка") Тогда
			
			ЭлементыПоРодителю = ТекущиеДанные.ПолучитьЭлементы();
			СуммаПосадочныхМест = ВыполнитьПодсчетПосадочныхМест(ЭлементыПоРодителю);
			
			Если Элемент.ТекущийЭлемент = Элементы.УправлениеАссортиментнойМатрицейПосадочныеМеста Тогда
				
				ТекущиеДанные.ДанныеДереваЗаполненость = ПолучитьДанныеДереваЗаполненность(ТекущиеДанные, СуммаПосадочныхМест);
		
				Для Каждого Строка Из ЭлементыПоРодителю Цикл
					Строка.ПосадочныеМестаПроцент = ПолучитьПосадочныеМестаПроцент(Строка, ТекущиеДанные);
				КонецЦикла;
				
			КонецЕсли;	
			
		Иначе
			
			ЭлементыПоРодителю = РодительДанных.ПолучитьЭлементы(); 
			СуммаПосадочныхМест = ВыполнитьПодсчетПосадочныхМест(ЭлементыПоРодителю);
			
			Если Элемент.ТекущийЭлемент = Элементы.УправлениеАссортиментнойМатрицейПосадочныеМеста Тогда	
				ТекущиеДанные.ПосадочныеМестаПроцент 	= ПолучитьПосадочныеМестаПроцент(ТекущиеДанные, РодительДанных);
				РодительДанных.ДанныеДереваЗаполненость = ПолучитьДанныеДереваЗаполненность(РодительДанных, СуммаПосадочныхМест);
			КонецЕсли;
			
			Если Элемент.ТекущийЭлемент = Элементы.УправлениеАссортиментнойМатрицейПосадочныеМестаПроцент Тогда
			    СуммаПосадочныхМест = СуммаПосадочныхМест - ТекущиеДанные.ПосадочныеМеста;
			  	ТекущиеДанные.ПосадочныеМеста = Окр(РодительДанных.ПосадочныеМеста * ТекущиеДанные.ПосадочныеМестаПроцент / 100, 0, РежимОкругления.Окр15как20);
				СуммаПосадочныхМест = СуммаПосадочныхМест + ТекущиеДанные.ПосадочныеМеста;
				РодительДанных.ДанныеДереваЗаполненость = "(" + Строка(Окр(СуммаПосадочныхМест / РодительДанных.ПосадочныеМеста * 100)) + "%)";
			КонецЕсли;
			
		КонецЕсли;

		ВыполнитьЗаписьИзмененийВРегистр_АМ_УправлениеАссортиментнойМатрицей("УправлениеАссортиментнойМатрицей", Элемент.ТекущиеДанные.ПолучитьИдентификатор(), Отказ);	
			
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура УправлениеАссортиментнойМатрицейПередРазворачиванием(Элемент, Строка, Отказ)
	ОбновитьДеревоУправленияНаСервере(Строка);
КонецПроцедуры

#КонецОбласти 

#Область ОбработчикиСобытийСтраницыНастройки
	
&НаКлиенте
Процедура ГруппаСтраницыПриСменеСтраницы(Элемент, ТекущаяСтраница)
	
	//Если ТекущаяСтраница = Элементы.СтраницаНастройки Тогда
	//	ОбновитьМагазиныПодУправлениемНаСервере();
	//ИначеЕсли ТекущаяСтраница = Элементы.СтраницаУправление Тогда
	//	ОбновитьУправлениеНаСервере();
	//КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура МагазиныПодУправлениемПриИзменении(Элемент)
	
	Отказ = Ложь;
	Если ТекущиеДанныеОпределены(Элемент) Тогда
		ВыполнитьЗаписьИзмененийВРегистр_АМ_МагазиныПодУправлением("МагазиныПодУправлением", Элемент.ТекущиеДанные.ПолучитьИдентификатор(), Отказ);	
		Если Отказ = Ложь Тогда
			Состояние(НСтр("ru = 'Данные удачно записаны'"), 100, , БиблиотекаКартинок.УстановитьСтатусЗаявкиВыполнена);
		КонецЕсли;
	КонецЕсли;
	
КонецПроцедуры

#КонецОбласти 

#КонецОбласти

#Область ОбработчикиКомандФормы

&НаКлиенте
Процедура ПоказатьСкрытьДеревоФорматовМагазинов(Команда)
	Элементы.ГруппаФорматыМагазинов.Видимость = НЕ Элементы.ГруппаФорматыМагазинов.Видимость;
КонецПроцедуры




&НаКлиенте
Процедура ПереместитьТовар(Команда)
	
	// Костыль
	МассивВыделенныхСтрок = Элементы.УправлениеАссортиментнойМатрицей.ВыделенныеСтроки;
	ФормаДокумента = ПолучитьФорму("Документ.ПеремещениеТоваров.Форма.ФормаДокумента");
	
	Товары = ФормаДокумента.Объект.Товары;
	Для каждого ЭлементМассива Из МассивВыделенныхСтрок Цикл
		РезультатПоиска = УправлениеАссортиментнойМатрицей.НайтиПоИдентификатору(ЭлементМассива);
		ФормаДокумента.Объект.СкладОтправитель = РезультатПоиска.Склад; 
		НоваяСтрока = Товары.Добавить();		
		НоваяСтрока.Номенклатура = РезультатПоиска.Номенклатура;
		НоваяСтрока.Количество = РезультатПоиска.ГлубинаОстаткаФактМаксимальное - РезультатПоиска.ГлубинаОстатка;
	    НоваяСтрока.КоличествоУпаковок = РезультатПоиска.ГлубинаОстаткаФактМаксимальное - РезультатПоиска.ГлубинаОстатка;
	КонецЦикла;
	
	ОткрытьФорму(ФормаДокумента);
	
КонецПроцедуры // ПереместитьТовар()

&НаКлиенте
Процедура ПерестроитьДеревоУправления(Команда)
	
	Идентификатор = Неопределено;
	
	Элемент = Элементы.УправлениеАссортиментнойМатрицей;
	Если ТекущиеДанныеОпределены(Элемент) Тогда
		Идентификатор = Элемент.ТекущиеДанные.ПолучитьИдентификатор();
	КонецЕсли;
	
	ПерестроитьДеревоУправленияНаСервере(Идентификатор);
	
КонецПроцедуры // ПерестроитьДеревоУправления()

#КонецОбласти


#Область СлужебныеПроцедурыИФункции

&НаКлиенте
Функция ТекущиеДанныеОпределены(Элемент)
	
	ТекущиеДанные = Элемент.ТекущиеДанные;
	Если ТекущиеДанные <> Неопределено Тогда
		Возврат Истина;
	КонецЕсли;
	
	Возврат Ложь;
	
КонецФункции // ТекущиеДанныеОпределены() 

&НаКлиенте
Функция ВыполнитьПодсчетПосадочныхМест(ЭлементыПоРодителю) 
	
	СуммаПосадочныхМест = 0;
	Для каждого Строка Из ЭлементыПоРодителю Цикл
		СуммаПосадочныхМест = СуммаПосадочныхМест + Строка.ПосадочныеМеста;	
	КонецЦикла;
	
	Возврат СуммаПосадочныхМест;
	
КонецФункции // ВыполнитьПодсчетПосадочныхМест()

&НаКлиенте
Функция ПолучитьПосадочныеМестаПроцент(Данные, РодительДанных) 
	
	Процент = 0;
	Если РодительДанных.ПосадочныеМеста <> 0 Тогда
		Процент = Данные.ПосадочныеМеста / РодительДанных.ПосадочныеМеста * 100;
	КонецЕсли;	
	
	Возврат Процент;
	
КонецФункции // ПолучитьПосадочныеМестаПроцент()
 
&НаКлиентеНаСервереБезКонтекста
Функция ПолучитьДанныеДереваЗаполненность(Данные, СуммаПосадочныхМест)

	ДанныеДереваЗаполненость = "(???%)";
	Если Данные.ПосадочныеМеста = 0 И СуммаПосадочныхМест = 0 Тогда
		ДанныеДереваЗаполненость = "(???%)";
	ИначеЕсли Данные.ПосадочныеМеста = 0 Тогда
		ДанныеДереваЗаполненость = "(999%)";	
	Иначе
		ДанныеДереваЗаполненость = "(" + Строка(Окр(СуммаПосадочныхМест / Данные.ПосадочныеМеста * 100)) + "%)";
	КонецЕсли;
	
	Возврат ДанныеДереваЗаполненость;

КонецФункции // ПолучитьДанныеДереваЗаполненность()
 


&НаСервере
Процедура ОбновитьУправлениеНаСервере()

	УстановитьПривилегированныйРежим(Истина);
	
	Запрос = Новый Запрос;
	Запрос.Текст = ПолучитьТекстЗапросаДеревоФорматовМагазина();
	Запрос.УстановитьПараметр("ГруппаВидаНоменклатуры", ГруппаВидаНоменклатуры);
	ВыгрузкаДерево = Запрос.Выполнить().Выгрузить(ОбходРезультатаЗапроса.ПоГруппировкам);
	
	Для каждого СтрокаВерхнегоУровня Из ВыгрузкаДерево.Строки Цикл
		СтрокаВерхнегоУровня.ДанныеДерева = Строка(СтрокаВерхнегоУровня.ФорматМагазина);
		Если СтрокаВерхнегоУровня.ПосадочныеМеста = 0 И СтрокаВерхнегоУровня.КоличествоАртикулов = 0 Тогда 
			СтрокаВерхнегоУровня.Состояние = 0;
		ИначеЕсли СтрокаВерхнегоУровня.ПосадочныеМеста = 0 И СтрокаВерхнегоУровня.КоличествоАртикулов > 0 Тогда
			СтрокаВерхнегоУровня.Состояние = 3;
		ИначеЕсли СтрокаВерхнегоУровня.ПосадочныеМеста < СтрокаВерхнегоУровня.КоличествоАртикулов Тогда
			СтрокаВерхнегоУровня.Состояние = 1;
		Иначе
			СтрокаВерхнегоУровня.Состояние = 2;	
		КонецЕсли;
	КонецЦикла; 
	
	ЗначениеВРеквизитФормы(ВыгрузкаДерево, "ДеревоФорматыМагазинов");
	
	//ДеревоЗначений = РеквизитФормыВЗначение("УправлениеАссортиментнойМатрицей", Тип("ДеревоЗначений"));
	//СтрокиДерева = ДеревоЗначений.Строки;
	//СтрокиДерева.Очистить();
	//
	//Запрос = Новый Запрос;
	//Запрос.Текст = ПолучитьТекстЗапросаОбновитьУправлениеАссортиментнойМатрицей();	
	//Запрос.УстановитьПараметр("КонецПериода", ТекущаяДатаСеанса());
	//Запрос.УстановитьПараметр("НачалоПериодаНеделя", НачалоДня(ТекущаяДатаСеанса()) - 7 * 86400);
	//Запрос.УстановитьПараметр("НачалоПериода2Недели", НачалоДня(ТекущаяДатаСеанса()) - 14 * 86400);
	//Запрос.УстановитьПараметр("НачалоПериодаМесяц", НачалоДня(ТекущаяДатаСеанса()) - 31 * 86400);
	//Выборка = Запрос.Выполнить().Выбрать();
	//Пока Выборка.Следующий() Цикл
	//	
	//	НоваяСтрока = СтрокиДерева.Добавить();
	//	ЗаполнитьЗначенияСвойств(НоваяСтрока, Выборка);
	//	
	//	ВыполнитьДополнительнуюОбработкуСтрокиДерева(НоваяСтрока);
	//	
	//	НоваяСтрока.Строки.Добавить();
	//	
	//КонецЦикла;
	//
	//ЗначениеВРеквизитФормы(ДеревоЗначений, "УправлениеАссортиментнойМатрицей");
	
КонецПроцедуры // ОбновитьУправлениеНаСервере()

&НаСервере
Процедура ОбновитьДеревоУправленияНаСервере(Идентификатор)
	
	УстановитьПривилегированныйРежим(Истина);
	
	СтрокаДерева = УправлениеАссортиментнойМатрицей.НайтиПоИдентификатору(Идентификатор);
	ПараметрСклад 			  = СтрокаДерева.Склад;
	ПараметрПроизводитель	  = СтрокаДерева.Производитель;
	ПараметрВидНоменклатуры   = СтрокаДерева.ВидНоменклатуры;	
	ПараметрТоварнаяКатегория = СтрокаДерева.ТоварнаяКатегория;
	
	СтрокаЭлементы = СтрокаДерева.ПолучитьЭлементы();
	СтрокаЭлементы.Очистить();
	
	
	УровеньВложенности = 0;
	Пока СтрокаДерева.ПолучитьРодителя() <> Неопределено Цикл
		СтрокаДерева = СтрокаДерева.ПолучитьРодителя();
		УровеньВложенности = УровеньВложенности + 1;			
	КонецЦикла;
	
	// Получаем уровень вложености "Склад"
	Если УровеньВложенности = 0 Тогда 
		ТекстЗапроса = ПолучитьТекстЗапросаОбновитьДеревоУправленияПоСкладу();
	// Получаем уровень вложености "ВидНоменклатуры"
	ИначеЕсли УровеньВложенности = 1 Тогда
		ТекстЗапроса = ПолучитьТекстЗапросаОбновитьДеревоУправленияПоВидуНоменклатуры();
	// Получаем уровень вложености "ТоварнаяКатегория"
	ИначеЕсли УровеньВложенности = 2 Тогда
		ТекстЗапроса = ПолучитьТекстЗапросаОбновитьДеревоПоТоварнойКатегории();		
	// Получаем уровень вложености "Производители"
	ИначеЕсли УровеньВложенности = 3 Тогда
		ТекстЗапроса = ПолучитьТекстЗапросаОбновитьДеревоДетальныеЗаписи();	
	Иначе
		Возврат;	
	КонецЕсли;
	
	
	Запрос = Новый Запрос;
	Запрос.Текст = ТекстЗапроса;
	Запрос.УстановитьПараметр("КонецПериода", ТекущаяДатаСеанса());
	Запрос.УстановитьПараметр("НачалоПериодаНеделя", НачалоДня(ТекущаяДатаСеанса()) - 7 * 86400);
	Запрос.УстановитьПараметр("НачалоПериода2Недели", НачалоДня(ТекущаяДатаСеанса()) - 14 * 86400);
	Запрос.УстановитьПараметр("НачалоПериодаМесяц", НачалоДня(ТекущаяДатаСеанса()) - 31 * 86400);
	Запрос.УстановитьПараметр("Склад", ПараметрСклад);
	Запрос.УстановитьПараметр("Производитель", ПараметрПроизводитель);
	Запрос.УстановитьПараметр("ВидНоменклатуры", ПараметрВидНоменклатуры);
	Запрос.УстановитьПараметр("ТоварнаяКатегория", ПараметрТоварнаяКатегория);
	Запрос.УстановитьПараметр("ГруппаВидаНоменклатуры", ГруппаВидаНоменклатуры);
	Выборка = Запрос.Выполнить().Выбрать();
	Пока Выборка.Следующий() Цикл
		
		Если Выборка.ДанныеДерева = "<Производитель не задан>" И Выборка.ТКА = 0 Тогда
			Продолжить;
		КонецЕсли;
		
		Если Выборка.ДанныеДерева = "<Товарная категория не задана>" И Выборка.ТКА = 0 Тогда
			Продолжить;
		КонецЕсли;
		
		НоваяСтрока = СтрокаЭлементы.Добавить();
		ЗаполнитьЗначенияСвойств(НоваяСтрока, Выборка);
		
		ВыполнитьДополнительнуюОбработкуСтрокиДерева(НоваяСтрока, УровеньВложенности);
		
		Если ПустаяСтрока(Выборка.ДанныеРодителя) Тогда
			НоваяСтрока.ДанныеДерева = Выборка.ДанныеДерева;	
		Иначе
			НоваяСтрока.ДанныеДерева = Выборка.ДанныеРодителя + " / " + Выборка.ДанныеДерева;
		КонецЕсли;
		
		// Для подсчета процентов правильности заполнености Виды <-> ТК 
		Если ПараметрВидНоменклатуры.Пустая() Тогда
			НоваяСтрока.ДанныеДереваЗаполненость = ПолучитьДанныеДереваЗаполненность(НоваяСтрока, Выборка.ДанныеДереваЗаполненость);
		КонецЕсли;
		
		Если УровеньВложенности <> 3 Тогда
			НоваяСтрока.ПолучитьЭлементы().Добавить();
		КонецЕсли;
		
	КонецЦикла;
	
КонецПроцедуры // ОбновитьДеревоУправленияНаСервере()

&НаСервере
Процедура ОбновитьМагазиныПодУправлениемНаСервере()
	
	УстановитьПривилегированныйРежим(Истина);
	
	Запрос = Новый Запрос;
	Запрос.Текст = ПолучитьТекстЗапросаМагазиныПодУправлением();
	РезультатЗапроса = Запрос.Выполнить();
	Если РезультатЗапроса.Пустой() = Ложь Тогда
		//МагазиныПодУправлением.Загрузить(РезультатЗапроса.Выгрузить());	
	КонецЕсли;
	
КонецПроцедуры // ОбновитьМагазиныПодУправлениемНаСервере()

&НаСервере
Процедура ПерестроитьДеревоУправленияНаСервере(Идентификатор)
	
	//Перем Склад, ВидНоменклатуры, ТоварнаяКатегория, Номенклатура;
	//
	//Если Идентификатор <> Неопределено Тогда
	//	РезультатПоиска = УправлениеАссортиментнойМатрицей.НайтиПоИдентификатору(Идентификатор);
	//	Если РезультатПоиска <> Неопределено Тогда
	//		Склад = РезультатПоиска.Склад;
	//		ВидНоменклатуры = РезультатПоиска.ВидНоменклатуры;
	//		ТоварнаяКатегория = РезультатПоиска.ТоварнаяКатегория;
	//		Номенклатура = РезультатПоиска.Номенклатура;
	//	КонецЕсли;
	//КонецЕсли;
	
	ОбновитьУправлениеНаСервере();
	
	//РезультатПоиска = УправлениеАссортиментнойМатрицей;
	//ВыполнитьВостановлениеКурсораПриПерестройкиДерева(РезультатПоиска, "Склад", Склад);
	//ВыполнитьВостановлениеКурсораПриПерестройкиДерева(РезультатПоиска, "ВидНоменклатуры", ВидНоменклатуры);
	//ВыполнитьВостановлениеКурсораПриПерестройкиДерева(РезультатПоиска, "ТоварнаяКатегория", ТоварнаяКатегория);
	//ВыполнитьВостановлениеКурсораПриПерестройкиДерева(РезультатПоиска, "Номенклатура", Номенклатура);
	//Если РезультатПоиска <> УправлениеАссортиментнойМатрицей Тогда
	//	Элементы.УправлениеАссортиментнойМатрицей.ТекущаяСтрока = РезультатПоиска.ПолучитьИдентификатор();		
	//КонецЕсли;
		
КонецПроцедуры // ПерестроитьДеревоУправленияНаСервере()

&НаСервере
Процедура ВыполнитьДополнительнуюОбработкуСтрокиДерева(СтрокаДерева, УровеньВложенности = 0)
	
	Если УровеньВложенности <> 3 Тогда  
		СтрокаДерева.ОТКА = СтрокаДерева.ОТКА + "%";
	Иначе
		СтрокаДерева.ОТКА = "—";
	КонецЕсли;
	
КонецПроцедуры // ВыполнитьДополнительнуюОбработкуСтрокиДерева()

&НаСервере
Процедура ВыполнитьВостановлениеКурсораПриПерестройкиДерева(РезультатПоиска, Знач Свойство, Знач Значение)
	
	Если ЗначениеЗаполнено(Значение) Тогда
		ЭлементыДерева = РезультатПоиска.ПолучитьЭлементы();
		Для каждого ЭлементДерева Из ЭлементыДерева Цикл
			Если ЭлементДерева[Свойство] = Значение Тогда
				РезультатПоиска = ЭлементДерева;
				ОбновитьДеревоУправленияНаСервере(РезультатПоиска.ПолучитьИдентификатор());
				Прервать;
			КонецЕсли;
		КонецЦикла; 
	КонецЕсли;
	
КонецПроцедуры // ВыполнитьВостановлениеКурсораПриПерестройкиДерева()

&НаСервере
Процедура ВыполнитьЗаписьИзмененийВРегистр_АМ_МагазиныПодУправлением(ИмяТаблицы, Идентификатор, Отказ)
	
	УстановитьПривилегированныйРежим(Истина);
	
	РезультатПоиска = ЭтаФорма[ИмяТаблицы].НайтиПоИдентификатору(Идентификатор);
	Если РезультатПоиска <> Неопределено Тогда
		ПериодЗаписи = ТекущаяДатаСеанса();
		НаборЗаписей = РегистрыСведений.АМ_МагазиныПодУправлением.СоздатьНаборЗаписей();
		НаборЗаписей.Отбор.Период.Установить(ПериодЗаписи);
		НаборЗаписей.Отбор.Склад.Установить(РезультатПоиска.Склад);
			НоваяЗапись = НаборЗаписей.Добавить();
			ЗаполнитьЗначенияСвойств(НоваяЗапись, РезультатПоиска);
			НоваяЗапись.Период = ПериодЗаписи;
		Попытка
			НаборЗаписей.Записать();
			РегистрыСведений.АМ_МагазиныПодУправлением.ПересчитатьИтоги();
		Исключение
			ОбщегоНазначенияКлиентСервер.СообщитьПользователю(НСтр("ru = 'Неудача при попытке записи значения'"), , , , Отказ);	
		КонецПопытки;
	КонецЕсли;
	
КонецПроцедуры // ВыполнитьЗаписьИзмененийВРегистр_АМ_МагазиныПодУправлением()

&НаСервере
Процедура ВыполнитьЗаписьИзмененийВРегистр_АМ_УправлениеАссортиментнойМатрицей(ИмяТаблицы, Идентификатор, Отказ)	
	
	УстановитьПривилегированныйРежим(Истина);
	
	РезультатПоиска = ЭтаФорма[ИмяТаблицы].НайтиПоИдентификатору(Идентификатор);
	Если РезультатПоиска <> Неопределено Тогда
		ПериодЗаписи = ТекущаяДатаСеанса();
		НаборЗаписей = РегистрыСведений.АМ_УправлениеАссортиментнойМатрицей.СоздатьНаборЗаписей();
		НаборЗаписей.Отбор.Период.Установить(ПериодЗаписи);
		НаборЗаписей.Отбор.Склад.Установить(РезультатПоиска.Склад);
		НаборЗаписей.Отбор.Производитель.Установить(РезультатПоиска.Производитель);
		НаборЗаписей.Отбор.ВидНоменклатуры.Установить(РезультатПоиска.ВидНоменклатуры);
		НаборЗаписей.Отбор.ТоварнаяКатегория.Установить(РезультатПоиска.ТоварнаяКатегория);
			НоваяЗапись = НаборЗаписей.Добавить();
			ЗаполнитьЗначенияСвойств(НоваяЗапись, РезультатПоиска);
			НоваяЗапись.Период = ПериодЗаписи;
		Попытка
			НаборЗаписей.Записать();
			РегистрыСведений.АМ_УправлениеАссортиментнойМатрицей.ПересчитатьИтоги();
		Исключение
			ОбщегоНазначенияКлиентСервер.СообщитьПользователю(НСтр("ru = 'Неудача при попытке записи значения'"), , , , Отказ);	
		КонецПопытки;
	КонецЕсли;

КонецПроцедуры



&НаСервереБезКонтекста
Функция ПолучитьТекстЗапросаДеревоФорматовМагазина()
	
	ТекстЗапроса = "
		////////////////////////////////////////////////////////////////////////////////////////////
		//
		|ВЫБРАТЬ
		|	Ссылка	
		|ПОМЕСТИТЬ КешВидовНоменклатуры
		|ИЗ
		|	Справочник.ВидыНоменклатуры КАК ВидыНоменклатуры
		|ГДЕ
		|	ЭтоГруппа = Ложь
		|И	ВидыНоменклатуры.Ссылка В ИЕРАРХИИ(&ГруппаВидаНоменклатуры)
		|
		|ИНДЕКСИРОВАТЬ ПО
		|	Ссылка
		|;
		////////////////////////////////////////////////////////////////////////////////////////////
		//
		|ВЫБРАТЬ
		|	Склад					КАК Склад,
		|	СУММА(ПосадочныеМеста)	КАК ПосадочныеМеста 
		|ПОМЕСТИТЬ КешПоСкладамПоПосадочнымМестам
		|ИЗ
		|	РегистрСведений.АМ_УправлениеАссортиментнойМатрицей.СрезПоследних(, 
		|																	ВидНоменклатуры  	В (ВЫБРАТЬ Ссылка ИЗ КешВидовНоменклатуры)
		|																И 	ТоварнаяКатегория 	= ЗНАЧЕНИЕ(Справочник.ТоварныеКатегории.ПустаяСсылка)
		|																И	Производитель  		= ЗНАЧЕНИЕ(Справочник.Производители.ПустаяСсылка)
		|																И	Номенклатура  		= ЗНАЧЕНИЕ(Справочник.Номенклатура.ПустаяСсылка)
		|																							) КАК АМ_УправлениеАссортиментнойМатрицей
		|СГРУППИРОВАТЬ ПО
		|	Склад
		|
		|ИНДЕКСИРОВАТЬ ПО
		|	Склад
		|;	
		////////////////////////////////////////////////////////////////////////////////////////////
		//
		|ВЫБРАТЬ
		|	Склад 					КАК Склад,
		|	КОЛИЧЕСТВО(Номенклатура)КАК КоличествоАртикулов
		|ПОМЕСТИТЬ КешПоСкладамПоКоличествуАртикулов
		|ИЗ
		|	РегистрНакопления.ТоварыОрганизаций.Остатки(, Номенклатура.ВидНоменклатуры В (ВЫБРАТЬ Ссылка ИЗ КешВидовНоменклатуры)) КАК ТоварыОрганизацийОстатки
		|
		|СГРУППИРОВАТЬ ПО
		|	Склад
		|	
		|ИНДЕКСИРОВАТЬ ПО
		|	Склад
		|;
		////////////////////////////////////////////////////////////////////////////////////////////
		//
		|ВЫБРАТЬ
		|	ВЫБОР
		|		КОГДА IsNull(КешПоСкладамПоПосадочнымМестам.ПосадочныеМеста, 0) = 0 
		|			И IsNull(КешПоСкладамПоКоличествуАртикулов.КоличествоАртикулов, 0) = 0
		|			ТОГДА 0
		|		КОГДА IsNull(КешПоСкладамПоПосадочнымМестам.ПосадочныеМеста, 0) = 0 
		|			И IsNull(КешПоСкладамПоКоличествуАртикулов.КоличествоАртикулов, 0) > 0
		|			ТОГДА 3
		|		КОГДА КешПоСкладамПоПосадочнымМестам.ПосадочныеМеста < КешПоСкладамПоКоличествуАртикулов.КоличествоАртикулов
		|			ТОГДА 1
		|		ИНАЧЕ 2
		|	КОНЕЦ															КАК Состояние,
		|	ПРЕДСТАВЛЕНИЕ(АМ_ФорматыМагазиновСклады.Склад)					КАК ДанныеДерева,
		|	АМ_ФорматыМагазинов.Ссылка										КАК ФорматМагазина,
		|	АМ_ФорматыМагазиновСклады.Склад									КАК Склад,
		|	АМ_ФорматыМагазиновСклады.ИспользуетсяУправление				КАК ПодУправлением,
		|	IsNull(КешПоСкладамПоПосадочнымМестам.ПосадочныеМеста, 0)	 	КАК ПосадочныеМеста,
		|	IsNull(КешПоСкладамПоКоличествуАртикулов.КоличествоАртикулов, 0)КАК КоличествоАртикулов,
		|	""""															КАК Пустышка
		|ИЗ
		|	Справочник.АМ_ФорматыМагазинов КАК АМ_ФорматыМагазинов
		|		
		|ЛЕВОЕ СОЕДИНЕНИЕ Справочник.АМ_ФорматыМагазинов.Склады КАК АМ_ФорматыМагазиновСклады
		|ПО 	АМ_ФорматыМагазиновСклады.Ссылка = АМ_ФорматыМагазинов.Ссылка
		|
		|ЛЕВОЕ СОЕДИНЕНИЕ КешПоСкладамПоКоличествуАртикулов КАК КешПоСкладамПоКоличествуАртикулов
		|ПО	КешПоСкладамПоКоличествуАртикулов.Склад = АМ_ФорматыМагазиновСклады.Склад
		|
		|ЛЕВОЕ СОЕДИНЕНИЕ КешПоСкладамПоПосадочнымМестам КАК КешПоСкладамПоПосадочнымМестам
		|ПО	КешПоСкладамПоПосадочнымМестам.Склад = АМ_ФорматыМагазиновСклады.Склад
		|
		|ГДЕ
		|	АМ_ФорматыМагазинов.Активен = Истина
		|	
		|СГРУППИРОВАТЬ ПО
		|	АМ_ФорматыМагазинов.Ссылка,
		|	АМ_ФорматыМагазиновСклады.Склад,
		|	АМ_ФорматыМагазиновСклады.ИспользуетсяУправление,
		|	КешПоСкладамПоПосадочнымМестам.ПосадочныеМеста,
		|	КешПоСкладамПоКоличествуАртикулов.КоличествоАртикулов
		|	
		|ИТОГИ 
		|	СУММА(ПосадочныеМеста),
		|	СУММА(КоличествоАртикулов) 
		|ПО
		|	ФорматМагазина 	
		|;
		////////////////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ КешПоСкладамПоПосадочнымМестам;
		////////////////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ КешПоСкладамПоКоличествуАртикулов;	
		|";
	Возврат ТекстЗапроса;		
		
КонецФункции // ПолучитьТекстЗапросаДеревоФорматовМагазина()


&НаСервереБезКонтекста
Функция ПолучитьТекстЗапросаОбновитьУправлениеАссортиментнойМатрицей()

	ТекстЗапроса = "
		////////////////////////////////////////////////////////////////////////////////////////////
		// 0.
		|ВЫБРАТЬ РАЗРЕШЕННЫЕ РАЗЛИЧНЫЕ
		|	ПРЕДСТАВЛЕНИЕ(МагазиныПодУправлением.Склад) КАК ДанныеДерева,
		|	МагазиныПодУправлением.Склад 				КАК Склад
		|ПОМЕСТИТЬ КешДанныхДляВывода 
		|ИЗ
		|	РегистрСведений.АМ_МагазиныПодУправлением.СрезПоследних КАК МагазиныПодУправлением
		|
		|ГДЕ
		|	МагазиныПодУправлением.ИспользуетсяУправление = Истина
		|;
		////////////////////////////////////////////////////////////////////////////////////////////
		// 1. Продажи по неделям
		|ВЫБРАТЬ РАЗРЕШЕННЫЕ
		|	АналитикаУчетаНоменклатуры.Склад КАК Склад,
		|	СУММА(КоличествоОборот) КАК ПродажиНеделя,
		|	КОЛИЧЕСТВО(АналитикаУчетаНоменклатуры.Номенклатура) КАК ПродажиНеделяПоАртикулам
		|ПОМЕСТИТЬ ПродажиПоНеделям
		|ИЗ
		|	РегистрНакопления.ВыручкаИСебестоимостьПродаж.Обороты(&НачалоПериодаНеделя, &КонецПериода, , АналитикаУчетаНоменклатуры.Склад В (ВЫБРАТЬ Склад ИЗ КешДанныхДляВывода)
		|														И  АналитикаУчетаПоПартнерам.Партнер <> ЗНАЧЕНИЕ(Справочник.Партнеры.НашеПредприятие))
		|
		|СГРУППИРОВАТЬ ПО
		|	АналитикаУчетаНоменклатуры.Склад		
		|
		|ИНДЕКСИРОВАТЬ ПО
		|	Склад
		|;
		////////////////////////////////////////////////////////////////////////////////////////////
		// 2. Продажи по неделям "Под заказ"
		|ВЫБРАТЬ РАЗРЕШЕННЫЕ
		|	Склад							КАК Склад,
		|	Сумма(НаличиеПодЗаказРасход)   	КАК ПродажиНеделяПодЗаказ
		|ПОМЕСТИТЬ ПродажиПоНеделямПодЗаказ
		|ИЗ
		|	РегистрНакопления.ОбеспечениеЗаказов.Обороты(&НачалоПериодаНеделя, &КонецПериода, Регистратор, Склад В (ВЫБРАТЬ Склад ИЗ КешДанныхДляВывода))
		|ГДЕ
		|	Регистратор Ссылка Документ.РеализацияТоваровУслуг
		|
		|СГРУППИРОВАТЬ ПО
		| 	Склад
		|
		|ИНДЕКСИРОВАТЬ ПО
		| 	Склад
		|;
		////////////////////////////////////////////////////////////////////////////////////////////
		// 3. Продажи по 2-х неделям
		|ВЫБРАТЬ РАЗРЕШЕННЫЕ
		|	АналитикаУчетаНоменклатуры.Склад 					КАК Склад,
		|	СУММА(КоличествоОборот) 							КАК Продажи2Недели,
		|	КОЛИЧЕСТВО(АналитикаУчетаНоменклатуры.Номенклатура) КАК Продажи2НеделиПоАртикулам
		|ПОМЕСТИТЬ Продажи2ПоНеделям
		|ИЗ
		|	РегистрНакопления.ВыручкаИСебестоимостьПродаж.Обороты(&НачалоПериода2Недели, &КонецПериода, , АналитикаУчетаНоменклатуры.Склад В (ВЫБРАТЬ Склад ИЗ КешДанныхДляВывода)
		|														И  АналитикаУчетаПоПартнерам.Партнер <> ЗНАЧЕНИЕ(Справочник.Партнеры.НашеПредприятие))
		|
		|СГРУППИРОВАТЬ ПО
		|	АналитикаУчетаНоменклатуры.Склад		
		|
		|ИНДЕКСИРОВАТЬ ПО
		|	Склад
		|;
		////////////////////////////////////////////////////////////////////////////////////////////
		// 4. Продажи по 2-х неделям "Под заказ"
		|ВЫБРАТЬ РАЗРЕШЕННЫЕ
		|	Склад							КАК Склад,
		|	Сумма(НаличиеПодЗаказРасход)   	КАК Продажи2НеделиПодЗаказ
		|ПОМЕСТИТЬ ПродажиПо2НеделямПодЗаказ
		|ИЗ
		|	РегистрНакопления.ОбеспечениеЗаказов.Обороты(&НачалоПериода2Недели, &КонецПериода, Регистратор, Склад В (ВЫБРАТЬ Склад ИЗ КешДанныхДляВывода))
		|ГДЕ
		|	Регистратор Ссылка Документ.РеализацияТоваровУслуг
		|
		|СГРУППИРОВАТЬ ПО
		| 	Склад
		|
		|ИНДЕКСИРОВАТЬ ПО
		| 	Склад
		|;
		////////////////////////////////////////////////////////////////////////////////////////////
		// 5. Продажи за месяц
		|ВЫБРАТЬ РАЗРЕШЕННЫЕ
		|	АналитикаУчетаНоменклатуры.Склад 					КАК Склад,
		|	СУММА(КоличествоОборот) 							КАК ПродажиМесяц,
		|	КОЛИЧЕСТВО(АналитикаУчетаНоменклатуры.Номенклатура) КАК ПродажиМесяцПоАртикулам
		|ПОМЕСТИТЬ ПродажиЗаМесяц
		|ИЗ
		|	РегистрНакопления.ВыручкаИСебестоимостьПродаж.Обороты(&НачалоПериодаМесяц, &КонецПериода, , АналитикаУчетаНоменклатуры.Склад В (ВЫБРАТЬ Склад ИЗ КешДанныхДляВывода)
		|														И  АналитикаУчетаПоПартнерам.Партнер <> ЗНАЧЕНИЕ(Справочник.Партнеры.НашеПредприятие))
		|
		|СГРУППИРОВАТЬ ПО
		|	АналитикаУчетаНоменклатуры.Склад		
		|
		|ИНДЕКСИРОВАТЬ ПО
		|	Склад
		|;
		////////////////////////////////////////////////////////////////////////////////////////////
		// 6. Продажи за месяц "Под заказ"
		|ВЫБРАТЬ РАЗРЕШЕННЫЕ
		|	Склад							КАК Склад,
		|	Сумма(НаличиеПодЗаказРасход)   	КАК ПродажиМесяцПодЗаказ
		|ПОМЕСТИТЬ ПродажиЗаМесяцПодЗаказ
		|ИЗ
		|	РегистрНакопления.ОбеспечениеЗаказов.Обороты(&НачалоПериодаМесяц, &КонецПериода, Регистратор, Склад В (ВЫБРАТЬ Склад ИЗ КешДанныхДляВывода))
		|ГДЕ
		|	Регистратор Ссылка Документ.РеализацияТоваровУслуг
		|
		|СГРУППИРОВАТЬ ПО
		| 	Склад
		|
		|ИНДЕКСИРОВАТЬ ПО
		| 	Склад
		|;
		////////////////////////////////////////////////////////////////////////////////////////////
		//
		|ВЫБРАТЬ РАЗРЕШЕННЫЕ
		|	КешДанныхДляВывода.Склад	КАК Склад,
		|
		|	0							КАК ГлубинаОстаткаФактСреднее,
		|   0							КАК ГлубинаОстаткаФактМаксимальное,
		|  	КОЛИЧЕСТВО(ТоварыОрганизацийОстатки.Номенклатура) 	КАК ТКА
		|ПОМЕСТИТЬ РасчетТКА
		|ИЗ
		|	КешДанныхДляВывода КАК КешДанныхДляВывода
		|
		|ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.ТоварыОрганизаций.Остатки(, Склад В (ВЫБРАТЬ Склад ИЗ КешДанныхДляВывода)) КАК ТоварыОрганизацийОстатки
		|ПО	ТоварыОрганизацийОстатки.Склад = КешДанныхДляВывода.Склад
		|
		|СГРУППИРОВАТЬ ПО
		|	КешДанныхДляВывода.Склад		
		|
		|ИНДЕКСИРОВАТЬ ПО
		|	Склад
		|;
		////////////////////////////////////////////////////////////////////////////////////////////
		//
		|ВЫБРАТЬ РАЗРЕШЕННЫЕ
		|	АМ_УправлениеАссортиментнойМатрицей.Склад 																					КАК Склад,	
		|
		|	СУММА(АМ_УправлениеАссортиментнойМатрицей.ПосадочныеМеста) 																	КАК ПосадочныеМеста,
		|	СУММА(АМ_УправлениеАссортиментнойМатрицей.ОтклонениеКоличествоПМ) 															КАК ОтклонениеКоличествоПМ,
		|	СУММА(IsNull(АМ_УправлениеАссортиментнойМатрицей.ПосадочныеМеста * АМ_УправлениеАссортиментнойМатрицей.ГлубинаОстатка, 0))	КАК ГлубинаОстатка
		|ПОМЕСТИТЬ АМ_УправлениеАссортиментнойМатрицей
		|ИЗ
		|	РегистрСведений.АМ_УправлениеАссортиментнойМатрицей.СрезПоследних(, 
		|															Склад В (	ВЫБРАТЬ 
		|																			Склад
		|																		ИЗ 
		|																			КешДанныхДляВывода)
		|															И ВидНоменклатуры  <> ЗНАЧЕНИЕ(Справочник.ВидыНоменклатуры.ПустаяСсылка)
		|															И ТоварнаяКатегория = ЗНАЧЕНИЕ(Справочник.ТоварныеКатегории.ПустаяСсылка)
		|																					) КАК АМ_УправлениеАссортиментнойМатрицей
		|СГРУППИРОВАТЬ ПО
		|	Склад	
		|
		|ИНДЕКСИРОВАТЬ ПО
		|	Склад 
		|;
		////////////////////////////////////////////////////////////////////////////////////////////
		//
		|ВЫБРАТЬ РАЗРЕШЕННЫЕ
		|	КешДанныхДляВывода.ДанныеДерева	КАК ДанныеДерева,
		|   КешДанныхДляВывода.Склад		КАК Склад,
		|
		|	УправлениеАссортиментнойМатрицей.ПосадочныеМеста КАК ПосадочныеМеста,
		|	УправлениеАссортиментнойМатрицей.ОтклонениеКоличествоПМ КАК ОтклонениеКоличествоПМ,
		|
		|	ВЫБОР
		|		КОГДА IsNull(УправлениеАссортиментнойМатрицей.ПосадочныеМеста, 0) = 0
		|		ТОГДА 0
		|		ИНАЧЕ УправлениеАссортиментнойМатрицей.ГлубинаОстатка / УправлениеАссортиментнойМатрицей.ПосадочныеМеста
		|	КОНЕЦ КАК ГлубинаОстатка,
		|	РасчетТКА.ГлубинаОстаткаФактСреднее КАК ГлубинаОстаткаФактСреднее,
		|   РасчетТКА.ГлубинаОстаткаФактМаксимальное КАК ГлубинаОстаткаФактМаксимальное,
		|  	РасчетТКА.ТКА КАК ТКА,
		|	ВЫБОР
		|		КОГДА IsNull(УправлениеАссортиментнойМатрицей.ПосадочныеМеста, 0) = 0 
		|		ТОГДА	ВЫБОР
		|					КОГДА РасчетТКА.ТКА = 0
		|					ТОГДА 0
		|					ИНАЧЕ ""?!""
		|				КОНЕЦ
		|		ИНАЧЕ ВЫРАЗИТЬ( (РасчетТКА.ТКА / УправлениеАссортиментнойМатрицей.ПосадочныеМеста - 1) * 100 КАК Число(4,0)) 
		|	КОНЕЦ КАК ОТКА,
		|	ВЫБОР
		|		КОГДА IsNull(УправлениеАссортиментнойМатрицей.ПосадочныеМеста, 0) <= РасчетТКА.ТКА
		|       ТОГДА	ВЫБОР
		|					КОГДА IsNull(УправлениеАссортиментнойМатрицей.ПосадочныеМеста, 0) + IsNull(УправлениеАссортиментнойМатрицей.ОтклонениеКоличествоПМ, 0) >= РасчетТКА.ТКА
		|					ТОГДА ИСТИНА
		|					ИНАЧЕ ЛОЖЬ
		|				КОНЕЦ
		|		ИНАЧЕ ЛОЖЬ
		|	КОНЕЦ КАК ЕстьОтклоненияПоКоличеству,
		|
		|	ПродажиПоНеделям.ПродажиНеделя 					КАК ПродажиНеделя,
		|	ПродажиПоНеделям.ПродажиНеделяПоАртикулам 		КАК ПродажиНеделяПоАртикулам,
		|	ПродажиПоНеделямПодЗаказ.ПродажиНеделяПодЗаказ 	КАК ПродажиНеделяПодЗаказ,
		|
		|	Продажи2ПоНеделям.Продажи2Недели 				КАК Продажи2Недели,
		|	Продажи2ПоНеделям.Продажи2НеделиПоАртикулам 	КАК Продажи2НеделиПоАртикулам,
		|	ПродажиПо2НеделямПодЗаказ.Продажи2НеделиПодЗаказ КАК Продажи2НеделиПодЗаказ,
		|
		|	ПродажиЗаМесяц.ПродажиМесяц 					КАК ПродажиМесяц,
		|	ПродажиЗаМесяц.ПродажиМесяцПоАртикулам 			КАК ПродажиМесяцПоАртикулам,
		|	ПродажиЗаМесяцПодЗаказ.ПродажиМесяцПодЗаказ 	КАК ПродажиМесяцПодЗаказ
		|
		|ИЗ
		|	КешДанныхДляВывода КАК КешДанныхДляВывода
		|
		|ЛЕВОЕ СОЕДИНЕНИЕ РасчетТКА КАК РасчетТКА
		|ПО	РасчетТКА.Склад = КешДанныхДляВывода.Склад
		|
		|ЛЕВОЕ СОЕДИНЕНИЕ АМ_УправлениеАссортиментнойМатрицей КАК УправлениеАссортиментнойМатрицей
		|ПО	УправлениеАссортиментнойМатрицей.Склад = КешДанныхДляВывода.Склад
		|
		|ЛЕВОЕ СОЕДИНЕНИЕ ПродажиПоНеделям КАК ПродажиПоНеделям
		|ПО ПродажиПоНеделям.Склад = КешДанныхДляВывода.Склад
		|
		|ЛЕВОЕ СОЕДИНЕНИЕ ПродажиПоНеделямПодЗаказ КАК ПродажиПоНеделямПодЗаказ
		|ПО ПродажиПоНеделямПодЗаказ.Склад = КешДанныхДляВывода.Склад
		|
		|ЛЕВОЕ СОЕДИНЕНИЕ Продажи2ПоНеделям КАК Продажи2ПоНеделям
		|ПО Продажи2ПоНеделям.Склад = КешДанныхДляВывода.Склад
		|
		|ЛЕВОЕ СОЕДИНЕНИЕ ПродажиПо2НеделямПодЗаказ КАК ПродажиПо2НеделямПодЗаказ
		|ПО ПродажиПо2НеделямПодЗаказ.Склад = КешДанныхДляВывода.Склад
		|
		|ЛЕВОЕ СОЕДИНЕНИЕ ПродажиЗаМесяц КАК ПродажиЗаМесяц
		|ПО ПродажиЗаМесяц.Склад = КешДанныхДляВывода.Склад
		|
		|ЛЕВОЕ СОЕДИНЕНИЕ ПродажиЗаМесяцПодЗаказ КАК ПродажиЗаМесяцПодЗаказ
		|ПО ПродажиЗаМесяцПодЗаказ.Склад = КешДанныхДляВывода.Склад
		|
		|УПОРЯДОЧИТЬ ПО
		|	КешДанныхДляВывода.ДанныеДерева Убыв
		|;
		////////////////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ РасчетТКА;
		////////////////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ ПродажиПоНеделям;
		////////////////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ ПродажиПоНеделямПодЗаказ;
		////////////////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ Продажи2ПоНеделям;
		////////////////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ ПродажиПо2НеделямПодЗаказ;
		////////////////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ ПродажиЗаМесяц;
		////////////////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ ПродажиЗаМесяцПодЗаказ;
		////////////////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ КешДанныхДляВывода;
		////////////////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ АМ_УправлениеАссортиментнойМатрицей;
		////////////////////////////////////////////////////////////////////////////////////////////
		|";
	Возврат ТекстЗапроса;

КонецФункции // ПолучитьТекстЗапросаОбновитьУправлениеАссортиментнойМатрицей()

&НаСервере
Функция ПолучитьТекстЗапросаОбновитьДеревоУправленияПоСкладу()

	ТекстЗапроса = "
		////////////////////////////////////////////////////////////////////////////////////////////
		//
		|ВЫБРАТЬ РАЗРЕШЕННЫЕ
		|	ПРЕДСТАВЛЕНИЕ(ВидыНоменклатуры.Ссылка)	КАК ДанныеДерева,
		|	ПРЕДСТАВЛЕНИЕ(ВидыНоменклатуры.Родитель)КАК ДанныеРодителя, 	
		|	&Склад								   	КАК Склад,
		|	ВидыНоменклатуры.Ссылка				   	КАК ВидНоменклатуры,
		|	&ТоварнаяКатегория						КАК ТоварнаяКатегория
		|ПОМЕСТИТЬ КешДанныхДляВывода
		|ИЗ
		|	Справочник.ВидыНоменклатуры КАК ВидыНоменклатуры
		|
		|ГДЕ
		| 	ВидыНоменклатуры.ЭтоГруппа = Ложь	
		|И	ВидыНоменклатуры.ПометкаУдаления = Ложь
		| %1
		|
		|ИНДЕКСИРОВАТЬ ПО
		|	Склад, ВидНоменклатуры, ТоварнаяКатегория	
		|;
		////////////////////////////////////////////////////////////////////////////////////////////
		// Продажи по неделям
		|ВЫБРАТЬ РАЗРЕШЕННЫЕ
		|	АналитикаУчетаНоменклатуры.Склад 						КАК Склад,
		|	АналитикаУчетаНоменклатуры.Номенклатура.ВидНоменклатуры КАК ВидНоменклатуры,
		|	СУММА(КоличествоОборот) 								КАК ПродажиНеделя,
		|	КОЛИЧЕСТВО(АналитикаУчетаНоменклатуры.Номенклатура) 	КАК ПродажиНеделяПоАртикулам
		|ПОМЕСТИТЬ ПродажиПоНеделям
		|ИЗ
		|	РегистрНакопления.ВыручкаИСебестоимостьПродаж.Обороты(&НачалоПериодаНеделя, &КонецПериода, , (АналитикаУчетаНоменклатуры.Номенклатура.ВидНоменклатуры, АналитикаУчетаНоменклатуры.Склад) В (ВЫБРАТЬ ВидНоменклатуры, Склад ИЗ КешДанныхДляВывода)
		|														И  АналитикаУчетаПоПартнерам.Партнер <> ЗНАЧЕНИЕ(Справочник.Партнеры.НашеПредприятие))
		|
		|СГРУППИРОВАТЬ ПО
		|	АналитикаУчетаНоменклатуры.Склад,
		|	АналитикаУчетаНоменклатуры.Номенклатура.ВидНоменклатуры
		|
		|ИНДЕКСИРОВАТЬ ПО
		|	Склад,
		|	ВидНоменклатуры
		|;
		////////////////////////////////////////////////////////////////////////////////////////////
		// Продажи по неделям "Под заказ"
		|ВЫБРАТЬ РАЗРЕШЕННЫЕ
		|	Склад							КАК Склад,
		|	Номенклатура.ВидНоменклатуры	КАК ВидНоменклатуры,
		|	Сумма(НаличиеПодЗаказРасход)   	КАК ПродажиНеделяПодЗаказ
		|ПОМЕСТИТЬ ПродажиПоНеделямПодЗаказ
		|ИЗ
		|	РегистрНакопления.ОбеспечениеЗаказов.Обороты(&НачалоПериодаНеделя, &КонецПериода, Регистратор, (Номенклатура.ВидНоменклатуры, Склад) В (ВЫБРАТЬ ВидНоменклатуры, Склад ИЗ КешДанныхДляВывода))
		|ГДЕ
		|	Регистратор Ссылка Документ.РеализацияТоваровУслуг
		|
		|СГРУППИРОВАТЬ ПО
		| 	Склад,
		|	Номенклатура.ВидНоменклатуры
		|
		|ИНДЕКСИРОВАТЬ ПО
		| 	Склад,
		|	ВидНоменклатуры
		|;
		////////////////////////////////////////////////////////////////////////////////////////////
		// 3. Продажи по 2-х неделям
		|ВЫБРАТЬ РАЗРЕШЕННЫЕ
		|	АналитикаУчетаНоменклатуры.Склад 						КАК Склад,
		|	АналитикаУчетаНоменклатуры.Номенклатура.ВидНоменклатуры КАК ВидНоменклатуры,
		|	СУММА(КоличествоОборот) 								КАК Продажи2Недели,
		|	КОЛИЧЕСТВО(АналитикаУчетаНоменклатуры.Номенклатура) 	КАК Продажи2НеделиПоАртикулам
		|ПОМЕСТИТЬ Продажи2ПоНеделям
		|ИЗ
		|	РегистрНакопления.ВыручкаИСебестоимостьПродаж.Обороты(&НачалоПериода2Недели, &КонецПериода, , (АналитикаУчетаНоменклатуры.Номенклатура.ВидНоменклатуры, АналитикаУчетаНоменклатуры.Склад) В (ВЫБРАТЬ ВидНоменклатуры, Склад ИЗ КешДанныхДляВывода)
		|														И  АналитикаУчетаПоПартнерам.Партнер <> ЗНАЧЕНИЕ(Справочник.Партнеры.НашеПредприятие))
		|
		|СГРУППИРОВАТЬ ПО
		|	АналитикаУчетаНоменклатуры.Склад,
		|	АналитикаУчетаНоменклатуры.Номенклатура.ВидНоменклатуры
		|
		|ИНДЕКСИРОВАТЬ ПО
		|	Склад,
		|	ВидНоменклатуры
		|;
		////////////////////////////////////////////////////////////////////////////////////////////
		// 4. Продажи по 2-х неделям "Под заказ"
		|ВЫБРАТЬ РАЗРЕШЕННЫЕ
		|	Склад							КАК Склад,
		|	Номенклатура.ВидНоменклатуры	КАК ВидНоменклатуры,
		|	Сумма(НаличиеПодЗаказРасход)   	КАК Продажи2НеделиПодЗаказ
		|ПОМЕСТИТЬ ПродажиПо2НеделямПодЗаказ
		|ИЗ
		|	РегистрНакопления.ОбеспечениеЗаказов.Обороты(&НачалоПериода2Недели, &КонецПериода, Регистратор, (Номенклатура.ВидНоменклатуры, Склад) В (ВЫБРАТЬ ВидНоменклатуры, Склад ИЗ КешДанныхДляВывода))
		|ГДЕ
		|	Регистратор Ссылка Документ.РеализацияТоваровУслуг
		|
		|СГРУППИРОВАТЬ ПО
		| 	Склад,
		|	Номенклатура.ВидНоменклатуры
		|
		|ИНДЕКСИРОВАТЬ ПО
		| 	Склад,
		|	ВидНоменклатуры
		|;
		////////////////////////////////////////////////////////////////////////////////////////////
		// 5. Продажи за месяц
		|ВЫБРАТЬ РАЗРЕШЕННЫЕ
		|	АналитикаУчетаНоменклатуры.Склад 						КАК Склад,
		|	АналитикаУчетаНоменклатуры.Номенклатура.ВидНоменклатуры КАК ВидНоменклатуры,
		|	СУММА(КоличествоОборот) 							КАК ПродажиМесяц,
		|	КОЛИЧЕСТВО(АналитикаУчетаНоменклатуры.Номенклатура) КАК ПродажиМесяцПоАртикулам
		|ПОМЕСТИТЬ ПродажиЗаМесяц
		|ИЗ
		|	РегистрНакопления.ВыручкаИСебестоимостьПродаж.Обороты(&НачалоПериодаМесяц, &КонецПериода, ,  (АналитикаУчетаНоменклатуры.Номенклатура.ВидНоменклатуры, АналитикаУчетаНоменклатуры.Склад) В (ВЫБРАТЬ ВидНоменклатуры, Склад ИЗ КешДанныхДляВывода)
		|														И  АналитикаУчетаПоПартнерам.Партнер <> ЗНАЧЕНИЕ(Справочник.Партнеры.НашеПредприятие))
		|
		|СГРУППИРОВАТЬ ПО
		|	АналитикаУчетаНоменклатуры.Склад,
		|	АналитикаУчетаНоменклатуры.Номенклатура.ВидНоменклатуры		
		|
		|ИНДЕКСИРОВАТЬ ПО
		|	Склад,
		|	ВидНоменклатуры
		|;
		////////////////////////////////////////////////////////////////////////////////////////////
		// 6. Продажи за месяц "Под заказ"
		|ВЫБРАТЬ РАЗРЕШЕННЫЕ
		|	Склад							КАК Склад,
		|	Номенклатура.ВидНоменклатуры	КАК ВидНоменклатуры,
		|	Сумма(НаличиеПодЗаказРасход)   	КАК ПродажиМесяцПодЗаказ
		|ПОМЕСТИТЬ ПродажиЗаМесяцПодЗаказ
		|ИЗ
		|	РегистрНакопления.ОбеспечениеЗаказов.Обороты(&НачалоПериодаМесяц, &КонецПериода, Регистратор, (Номенклатура.ВидНоменклатуры, Склад) В (ВЫБРАТЬ ВидНоменклатуры, Склад ИЗ КешДанныхДляВывода))
		|ГДЕ
		|	Регистратор Ссылка Документ.РеализацияТоваровУслуг
		|
		|СГРУППИРОВАТЬ ПО
		| 	Склад,
		|	Номенклатура.ВидНоменклатуры
		|
		|ИНДЕКСИРОВАТЬ ПО
		| 	Склад,
		|	ВидНоменклатуры
		|;
		////////////////////////////////////////////////////////////////////////////////////////////
		//
		|ВЫБРАТЬ РАЗРЕШЕННЫЕ
		|	КешДанныхДляВывода.Склад			КАК Склад,
		|   КешДанныхДляВывода.ВидНоменклатуры	КАК ВидНоменклатуры,
		|
		|	СРЕДНЕЕ(ТоварыОрганизацийОстатки.КоличествоОстаток) КАК ГлубинаОстаткаФактСреднее,
		|   МАКСИМУМ(ТоварыОрганизацийОстатки.КоличествоОстаток)КАК ГлубинаОстаткаФактМаксимальное,
		|  	КОЛИЧЕСТВО(ТоварыОрганизацийОстатки.Номенклатура) 	КАК ТКА
		|ПОМЕСТИТЬ РасчетТКА
		|ИЗ
		|	КешДанныхДляВывода КАК КешДанныхДляВывода
		|
		|ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.ТоварыОрганизаций.Остатки(, Склад = &Склад) КАК ТоварыОрганизацийОстатки
		|ПО	ТоварыОрганизацийОстатки.Номенклатура.ВидНоменклатуры = КешДанныхДляВывода.ВидНоменклатуры
		|И	ТоварыОрганизацийОстатки.Склад 						  = КешДанныхДляВывода.Склад
		|
		|СГРУППИРОВАТЬ ПО
		|	КешДанныхДляВывода.Склад,
		|	КешДанныхДляВывода.ВидНоменклатуры
		|
		|ИНДЕКСИРОВАТЬ ПО
		|	Склад, ВидНоменклатуры
		|;
		////////////////////////////////////////////////////////////////////////////////////////////
		//
		|ВЫБРАТЬ РАЗРЕШЕННЫЕ
		|	АМ_УправлениеАссортиментнойМатрицей.Склад 				КАК Склад,	
		|	АМ_УправлениеАссортиментнойМатрицей.ВидНоменклатуры 	КАК ВидНоменклатуры,
		|	АМ_УправлениеАссортиментнойМатрицей.ТоварнаяКатегория 	КАК ТоварнаяКатегория,
		|
		|	IsNull(АМ_УправлениеАссортиментнойМатрицей.ПосадочныеМеста, 0) 			КАК ПосадочныеМеста,
		|	IsNull(АМ_УправлениеАссортиментнойМатрицей.ОтклонениеКоличествоПМ, 0) 	КАК ОтклонениеКоличествоПМ,
		|	IsNull(АМ_УправлениеАссортиментнойМатрицей.ГлубинаОстатка, 0)			КАК ГлубинаОстатка
		|ПОМЕСТИТЬ АМ_УправлениеАссортиментнойМатрицей
		|ИЗ
		|	РегистрСведений.АМ_УправлениеАссортиментнойМатрицей.СрезПоследних(, 
		|						(Склад, ВидНоменклатуры, ТоварнаяКатегория) В (	ВЫБРАТЬ 
		|																			Склад, 
		|																			ВидНоменклатуры, 
		|																			ТоварнаяКатегория 
		|																		ИЗ 
		|																			КешДанныхДляВывода)
		|																					) КАК АМ_УправлениеАссортиментнойМатрицей	
		|ИНДЕКСИРОВАТЬ ПО
		|	Склад, ВидНоменклатуры, ТоварнаяКатегория 
		|;
		////////////////////////////////////////////////////////////////////////////////////////////
		//
		|ВЫБРАТЬ РАЗРЕШЕННЫЕ
		|	АМ_УАМ.Склад 								КАК Склад,	
		|	АМ_УАМ.ВидНоменклатуры 						КАК ВидНоменклатуры,
		|	СУММА(IsNull(АМ_УАМ.ПосадочныеМеста, 0)) 	КАК ДанныеДереваЗаполненость,
		|	СУММА(IsNull(АМ_УАМ.ПосадочныеМеста * АМ_УАМ.ГлубинаОстатка, 0)) КАК ГлубинаОстатка
		|ПОМЕСТИТЬ АМ_УАМ_ДанныеДереваЗаполненость
		|ИЗ
		|	РегистрСведений.АМ_УправлениеАссортиментнойМатрицей.СрезПоследних(, 
		|						(Склад, ВидНоменклатуры) В (	ВЫБРАТЬ 
		|															Склад, 
		|															ВидНоменклатуры
		|														ИЗ 
		|															КешДанныхДляВывода)
		|						И ТоварнаяКатегория <> ЗНАЧЕНИЕ(Справочник.ТоварныеКатегории.ПустаяСсылка)
		|													) КАК АМ_УАМ
		|СГРУППИРОВАТЬ ПО
		|	АМ_УАМ.Склад,	
		|   АМ_УАМ.ВидНоменклатуры
		|
		|ИНДЕКСИРОВАТЬ ПО
		|	Склад, ВидНоменклатуры 
		|;
		////////////////////////////////////////////////////////////////////////////////////////////
		//
		|ВЫБРАТЬ РАЗРЕШЕННЫЕ
		|	КешДанныхДляВывода.ДанныеДерева							 			КАК ДанныеДерева,
		|	IsNull(АМ_УАМ_ДанныеДереваЗаполненость.ДанныеДереваЗаполненость, 0) КАК ДанныеДереваЗаполненость,
		|
		|	КешДанныхДляВывода.ДанныеРодителя		КАК ДанныеРодителя,
		|   КешДанныхДляВывода.Склад				КАК Склад,
		|	КешДанныхДляВывода.ВидНоменклатуры		КАК ВидНоменклатуры,
		|	КешДанныхДляВывода.ТоварнаяКатегория	КАК ТоварнаяКатегория,
		|
		|	IsNull(УправлениеАссортиментнойМатрицей.ПосадочныеМеста, 0) КАК ПосадочныеМеста,
		|	УправлениеАссортиментнойМатрицей.ОтклонениеКоличествоПМ 	КАК ОтклонениеКоличествоПМ,
		|
		|	ВЫБОР
		|		КОГДА IsNull(АМ_УАМ_ДанныеДереваЗаполненость.ДанныеДереваЗаполненость, 0) = 0
		|		ТОГДА 0
		|		ИНАЧЕ АМ_УАМ_ДанныеДереваЗаполненость.ГлубинаОстатка / АМ_УАМ_ДанныеДереваЗаполненость.ДанныеДереваЗаполненость
		|	КОНЕЦ КАК ГлубинаОстатка,
		|   РасчетТКА.ГлубинаОстаткаФактСреднее  				КАК ГлубинаОстаткаФактСреднее,
		|   РасчетТКА.ГлубинаОстаткаФактМаксимальное  			КАК ГлубинаОстаткаФактМаксимальное,
		|
		|	РасчетТКА.ТКА КАК ТКА,
		|	ВЫБОР
		|		КОГДА IsNull(УправлениеАссортиментнойМатрицей.ПосадочныеМеста, 0) = 0 
		|		ТОГДА	ВЫБОР
		|					КОГДА РасчетТКА.ТКА = 0
		|					ТОГДА 0
		|					ИНАЧЕ ""?!""
		|				КОНЕЦ
		|		ИНАЧЕ ВЫРАЗИТЬ( (РасчетТКА.ТКА / УправлениеАссортиментнойМатрицей.ПосадочныеМеста - 1) * 100 КАК Число(4,0))
		|	КОНЕЦ КАК ОТКА,
		|	ВЫБОР
		|		КОГДА IsNull(УправлениеАссортиментнойМатрицей.ПосадочныеМеста, 0) <= РасчетТКА.ТКА
		|       ТОГДА	ВЫБОР
		|					КОГДА IsNull(УправлениеАссортиментнойМатрицей.ПосадочныеМеста, 0) + IsNull(УправлениеАссортиментнойМатрицей.ОтклонениеКоличествоПМ, 0) >= РасчетТКА.ТКА
		|					ТОГДА ИСТИНА
		|					ИНАЧЕ ЛОЖЬ
		|				КОНЕЦ
		|		ИНАЧЕ ЛОЖЬ
		|	КОНЕЦ КАК ЕстьОтклоненияПоКоличеству,
		|
		|	ПродажиПоНеделям.ПродажиНеделя 					КАК ПродажиНеделя,
		|	ПродажиПоНеделям.ПродажиНеделяПоАртикулам 		КАК ПродажиНеделяПоАртикулам,
		|	ПродажиПоНеделямПодЗаказ.ПродажиНеделяПодЗаказ 	КАК ПродажиНеделяПодЗаказ,
		|
		|	Продажи2ПоНеделям.Продажи2Недели 				КАК Продажи2Недели,
		|	Продажи2ПоНеделям.Продажи2НеделиПоАртикулам 	КАК Продажи2НеделиПоАртикулам,
		|	ПродажиПо2НеделямПодЗаказ.Продажи2НеделиПодЗаказ КАК Продажи2НеделиПодЗаказ,
		|
		|	ПродажиЗаМесяц.ПродажиМесяц 					КАК ПродажиМесяц,
		|	ПродажиЗаМесяц.ПродажиМесяцПоАртикулам 			КАК ПродажиМесяцПоАртикулам,
		|	ПродажиЗаМесяцПодЗаказ.ПродажиМесяцПодЗаказ 	КАК ПродажиМесяцПодЗаказ
		|
		|ИЗ
		|	КешДанныхДляВывода КАК КешДанныхДляВывода
		|
		|ЛЕВОЕ СОЕДИНЕНИЕ АМ_УправлениеАссортиментнойМатрицей КАК УправлениеАссортиментнойМатрицей
		|ПО	КешДанныхДляВывода.Склад 			 = УправлениеАссортиментнойМатрицей.Склад
		|И 	КешДанныхДляВывода.ВидНоменклатуры 	 = УправлениеАссортиментнойМатрицей.ВидНоменклатуры
		|И  КешДанныхДляВывода.ТоварнаяКатегория = УправлениеАссортиментнойМатрицей.ТоварнаяКатегория
		|
		|ЛЕВОЕ СОЕДИНЕНИЕ АМ_УАМ_ДанныеДереваЗаполненость КАК АМ_УАМ_ДанныеДереваЗаполненость
		|ПО	КешДанныхДляВывода.Склад 			 = АМ_УАМ_ДанныеДереваЗаполненость.Склад
		|И 	КешДанныхДляВывода.ВидНоменклатуры 	 = АМ_УАМ_ДанныеДереваЗаполненость.ВидНоменклатуры
		|
		|ЛЕВОЕ СОЕДИНЕНИЕ РасчетТКА КАК РасчетТКА
		|ПО	РасчетТКА.Склад 		  = КешДанныхДляВывода.Склад
		|И	РасчетТКА.ВидНоменклатуры = КешДанныхДляВывода.ВидНоменклатуры
		|
		|ЛЕВОЕ СОЕДИНЕНИЕ ПродажиПоНеделям КАК ПродажиПоНеделям
		|ПО ПродажиПоНеделям.Склад 			 = КешДанныхДляВывода.Склад
		|И	ПродажиПоНеделям.ВидНоменклатуры = КешДанныхДляВывода.ВидНоменклатуры
		|
		|ЛЕВОЕ СОЕДИНЕНИЕ ПродажиПоНеделямПодЗаказ КАК ПродажиПоНеделямПодЗаказ
		|ПО ПродажиПоНеделямПодЗаказ.Склад 			 = КешДанныхДляВывода.Склад
		|И	ПродажиПоНеделямПодЗаказ.ВидНоменклатуры = КешДанныхДляВывода.ВидНоменклатуры
		|
		|ЛЕВОЕ СОЕДИНЕНИЕ Продажи2ПоНеделям КАК Продажи2ПоНеделям
		|ПО Продажи2ПоНеделям.Склад 			= КешДанныхДляВывода.Склад
		|И	Продажи2ПоНеделям.ВидНоменклатуры 	= КешДанныхДляВывода.ВидНоменклатуры
		|
		|ЛЕВОЕ СОЕДИНЕНИЕ ПродажиПо2НеделямПодЗаказ КАК ПродажиПо2НеделямПодЗаказ
		|ПО ПродажиПо2НеделямПодЗаказ.Склад 			= КешДанныхДляВывода.Склад
		|И	ПродажиПо2НеделямПодЗаказ.ВидНоменклатуры 	= КешДанныхДляВывода.ВидНоменклатуры
		|
		|ЛЕВОЕ СОЕДИНЕНИЕ ПродажиЗаМесяц КАК ПродажиЗаМесяц
		|ПО ПродажиЗаМесяц.Склад 			= КешДанныхДляВывода.Склад
		|И	ПродажиЗаМесяц.ВидНоменклатуры 	= КешДанныхДляВывода.ВидНоменклатуры
		|
		|ЛЕВОЕ СОЕДИНЕНИЕ ПродажиЗаМесяцПодЗаказ КАК ПродажиЗаМесяцПодЗаказ
		|ПО ПродажиЗаМесяцПодЗаказ.Склад 			= КешДанныхДляВывода.Склад
		|И	ПродажиЗаМесяцПодЗаказ.ВидНоменклатуры 	= КешДанныхДляВывода.ВидНоменклатуры
		|
		|УПОРЯДОЧИТЬ ПО
		|	КешДанныхДляВывода.ДанныеРодителя Убыв
		|;
		////////////////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ РасчетТКА;
		////////////////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ ПродажиПоНеделям;
		////////////////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ ПродажиПоНеделямПодЗаказ;
		////////////////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ Продажи2ПоНеделям;
		////////////////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ ПродажиПо2НеделямПодЗаказ;
		////////////////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ ПродажиЗаМесяц;
		////////////////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ ПродажиЗаМесяцПодЗаказ;
		////////////////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ КешДанныхДляВывода;
		////////////////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ АМ_УАМ_ДанныеДереваЗаполненость;
		////////////////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ АМ_УправлениеАссортиментнойМатрицей;
		////////////////////////////////////////////////////////////////////////////////////////////
		|";
		
	Если ГруппаВидаНоменклатуры.Пустая() Тогда
		ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "%1", "");		
	Иначе
		ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "%1", "И ВидыНоменклатуры.Ссылка В ИЕРАРХИИ(&ГруппаВидаНоменклатуры)");		
	КонецЕсли;
	
	Возврат ТекстЗапроса;
	
КонецФункции // ПолучитьТекстЗапросаОбновитьДеревоУправленияПоСкладу()
 
&НаСервереБезКонтекста
Функция ПолучитьТекстЗапросаОбновитьДеревоУправленияПоВидуНоменклатуры()

	ТекстЗапроса = "
		////////////////////////////////////////////////////////////////////////////////////////////
		//
		|ВЫБРАТЬ РАЗРЕШЕННЫЕ
		|	ПРЕДСТАВЛЕНИЕ(ТоварныеКатегории.Ссылка)		КАК ДанныеДерева,
		|	ПРЕДСТАВЛЕНИЕ(ТоварныеКатегории.Родитель)	КАК ДанныеРодителя,
		|	&Склад								   		КАК Склад,
		|	&ВидНоменклатуры				   			КАК ВидНоменклатуры,
		|	ТоварныеКатегории.Ссылка					КАК ТоварнаяКатегория
		|ПОМЕСТИТЬ КешДанныхДляВывода
		|ИЗ
		|	Справочник.ТоварныеКатегории КАК ТоварныеКатегории
		|
		|ГДЕ
		|	ТоварныеКатегории.Владелец = &ВидНоменклатуры
		|И 	ТоварныеКатегории.ЭтоГруппа = Ложь	
		|И	ТоварныеКатегории.ПометкаУдаления = Ложь
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ
		|	""<Товарная категория не задана>"",
		|	"""",
		|	&Склад,
		|	&ВидНоменклатуры,
		|	ЗНАЧЕНИЕ(Справочник.ТоварныеКатегории.ПустаяСсылка)
		|
		|ИНДЕКСИРОВАТЬ ПО
		|	Склад, ВидНоменклатуры, ТоварнаяКатегория	
		|;
		////////////////////////////////////////////////////////////////////////////////////////////
		// Продажи по неделям
		|ВЫБРАТЬ РАЗРЕШЕННЫЕ
		|	АналитикаУчетаНоменклатуры.Склад 							КАК Склад,
		|	АналитикаУчетаНоменклатуры.Номенклатура.ВидНоменклатуры 	КАК ВидНоменклатуры,
		|	АналитикаУчетаНоменклатуры.Номенклатура.ТоварнаяКатегория 	КАК ТоварнаяКатегория,
		|	СУММА(КоличествоОборот) 									КАК ПродажиНеделя,
		|	КОЛИЧЕСТВО(АналитикаУчетаНоменклатуры.Номенклатура) 		КАК ПродажиНеделяПоАртикулам
		|ПОМЕСТИТЬ ПродажиПоНеделям
		|ИЗ
		|	РегистрНакопления.ВыручкаИСебестоимостьПродаж.Обороты(&НачалоПериодаНеделя, &КонецПериода, , (АналитикаУчетаНоменклатуры.Номенклатура.ВидНоменклатуры, АналитикаУчетаНоменклатуры.Склад) В (ВЫБРАТЬ ВидНоменклатуры, Склад ИЗ КешДанныхДляВывода)
		|														И  АналитикаУчетаПоПартнерам.Партнер <> ЗНАЧЕНИЕ(Справочник.Партнеры.НашеПредприятие))
		|
		|СГРУППИРОВАТЬ ПО
		|	АналитикаУчетаНоменклатуры.Склад,
		|	АналитикаУчетаНоменклатуры.Номенклатура.ВидНоменклатуры,
		|	АналитикаУчетаНоменклатуры.Номенклатура.ТоварнаяКатегория	
		|
		|ИНДЕКСИРОВАТЬ ПО
		|	Склад, ВидНоменклатуры, ТоварнаяКатегория
		|;
		////////////////////////////////////////////////////////////////////////////////////////////
		// Продажи по неделям "Под заказ"
		|ВЫБРАТЬ РАЗРЕШЕННЫЕ
		|	Склад							КАК Склад,
		|	Номенклатура.ВидНоменклатуры	КАК ВидНоменклатуры,
		|	Номенклатура.ТоварнаяКатегория 	КАК ТоварнаяКатегория,
		|	Сумма(НаличиеПодЗаказРасход)   	КАК ПродажиНеделяПодЗаказ
		|ПОМЕСТИТЬ ПродажиПоНеделямПодЗаказ
		|ИЗ
		|	РегистрНакопления.ОбеспечениеЗаказов.Обороты(&НачалоПериодаНеделя, &КонецПериода, Регистратор, (Номенклатура.ВидНоменклатуры, Склад) В (ВЫБРАТЬ ВидНоменклатуры, Склад ИЗ КешДанныхДляВывода))
		|ГДЕ
		|	Регистратор Ссылка Документ.РеализацияТоваровУслуг
		|
		|СГРУППИРОВАТЬ ПО
		| 	Склад,
		|	Номенклатура.ВидНоменклатуры,
		|	Номенклатура.ТоварнаяКатегория
		|
		|ИНДЕКСИРОВАТЬ ПО
		| 	Склад, ВидНоменклатуры, ТоварнаяКатегория
		|;
		////////////////////////////////////////////////////////////////////////////////////////////
		// 3. Продажи по 2-х неделям
		|ВЫБРАТЬ РАЗРЕШЕННЫЕ
		|	АналитикаУчетаНоменклатуры.Склад 							КАК Склад,
		|	АналитикаУчетаНоменклатуры.Номенклатура.ВидНоменклатуры 	КАК ВидНоменклатуры,
		|	АналитикаУчетаНоменклатуры.Номенклатура.ТоварнаяКатегория 	КАК ТоварнаяКатегория,
		|	СУММА(КоличествоОборот) 									КАК Продажи2Недели,
		|	КОЛИЧЕСТВО(АналитикаУчетаНоменклатуры.Номенклатура) 		КАК Продажи2НеделиПоАртикулам
		|ПОМЕСТИТЬ Продажи2ПоНеделям
		|ИЗ
		|	РегистрНакопления.ВыручкаИСебестоимостьПродаж.Обороты(&НачалоПериода2Недели, &КонецПериода, , (АналитикаУчетаНоменклатуры.Номенклатура.ВидНоменклатуры, АналитикаУчетаНоменклатуры.Склад) В (ВЫБРАТЬ ВидНоменклатуры, Склад ИЗ КешДанныхДляВывода)
		|														И  АналитикаУчетаПоПартнерам.Партнер <> ЗНАЧЕНИЕ(Справочник.Партнеры.НашеПредприятие))
		|
		|СГРУППИРОВАТЬ ПО
		|	АналитикаУчетаНоменклатуры.Склад,
		|	АналитикаУчетаНоменклатуры.Номенклатура.ВидНоменклатуры,
		|	АналитикаУчетаНоменклатуры.Номенклатура.ТоварнаяКатегория	
		|
		|ИНДЕКСИРОВАТЬ ПО
		|	Склад, ВидНоменклатуры, ТоварнаяКатегория
		|;
		////////////////////////////////////////////////////////////////////////////////////////////
		// 4. Продажи по 2-х неделям "Под заказ"
		|ВЫБРАТЬ РАЗРЕШЕННЫЕ
		|	Склад							КАК Склад,
		|	Номенклатура.ВидНоменклатуры	КАК ВидНоменклатуры,
		|	Номенклатура.ТоварнаяКатегория 	КАК ТоварнаяКатегория,
		|	Сумма(НаличиеПодЗаказРасход)   	КАК Продажи2НеделиПодЗаказ
		|ПОМЕСТИТЬ ПродажиПо2НеделямПодЗаказ
		|ИЗ
		|	РегистрНакопления.ОбеспечениеЗаказов.Обороты(&НачалоПериода2Недели, &КонецПериода, Регистратор, (Номенклатура.ВидНоменклатуры, Склад) В (ВЫБРАТЬ ВидНоменклатуры, Склад ИЗ КешДанныхДляВывода))
		|ГДЕ
		|	Регистратор Ссылка Документ.РеализацияТоваровУслуг
		|
		|СГРУППИРОВАТЬ ПО
		| 	Склад,
		|	Номенклатура.ВидНоменклатуры,
		|	Номенклатура.ТоварнаяКатегория
		|
		|ИНДЕКСИРОВАТЬ ПО
		| 	Склад, ВидНоменклатуры, ТоварнаяКатегория
		|;
		////////////////////////////////////////////////////////////////////////////////////////////
		// 5. Продажи за месяц
		|ВЫБРАТЬ РАЗРЕШЕННЫЕ
		|	АналитикаУчетаНоменклатуры.Склад 							КАК Склад,
		|	АналитикаУчетаНоменклатуры.Номенклатура.ВидНоменклатуры 	КАК ВидНоменклатуры,
		|	АналитикаУчетаНоменклатуры.Номенклатура.ТоварнаяКатегория 	КАК ТоварнаяКатегория,
		|	СУММА(КоличествоОборот) 									КАК ПродажиМесяц,
		|	КОЛИЧЕСТВО(АналитикаУчетаНоменклатуры.Номенклатура) 		КАК ПродажиМесяцПоАртикулам
		|ПОМЕСТИТЬ ПродажиЗаМесяц
		|ИЗ
		|	РегистрНакопления.ВыручкаИСебестоимостьПродаж.Обороты(&НачалоПериодаМесяц, &КонецПериода, ,  (АналитикаУчетаНоменклатуры.Номенклатура.ВидНоменклатуры, АналитикаУчетаНоменклатуры.Склад) В (ВЫБРАТЬ ВидНоменклатуры, Склад ИЗ КешДанныхДляВывода)
		|														И  АналитикаУчетаПоПартнерам.Партнер <> ЗНАЧЕНИЕ(Справочник.Партнеры.НашеПредприятие))
		|
		|СГРУППИРОВАТЬ ПО
		|	АналитикаУчетаНоменклатуры.Склад,
		|	АналитикаУчетаНоменклатуры.Номенклатура.ВидНоменклатуры,
		|	АналитикаУчетаНоменклатуры.Номенклатура.ТоварнаяКатегория	
		|
		|ИНДЕКСИРОВАТЬ ПО
		|	Склад, ВидНоменклатуры, ТоварнаяКатегория
		|;
		////////////////////////////////////////////////////////////////////////////////////////////
		// 6. Продажи за месяц "Под заказ"
		|ВЫБРАТЬ РАЗРЕШЕННЫЕ
		|	Склад							КАК Склад,
		|	Номенклатура.ВидНоменклатуры	КАК ВидНоменклатуры,
		|	Номенклатура.ТоварнаяКатегория 	КАК ТоварнаяКатегория,
		|	Сумма(НаличиеПодЗаказРасход)   	КАК ПродажиМесяцПодЗаказ
		|ПОМЕСТИТЬ ПродажиЗаМесяцПодЗаказ
		|ИЗ
		|	РегистрНакопления.ОбеспечениеЗаказов.Обороты(&НачалоПериодаМесяц, &КонецПериода, Регистратор, (Номенклатура.ВидНоменклатуры, Склад) В (ВЫБРАТЬ ВидНоменклатуры, Склад ИЗ КешДанныхДляВывода))
		|ГДЕ
		|	Регистратор Ссылка Документ.РеализацияТоваровУслуг
		|
		|СГРУППИРОВАТЬ ПО
		| 	Склад,
		|	Номенклатура.ВидНоменклатуры,
		|	Номенклатура.ТоварнаяКатегория
		|
		|ИНДЕКСИРОВАТЬ ПО
		| 	Склад, ВидНоменклатуры, ТоварнаяКатегория
		|;
		////////////////////////////////////////////////////////////////////////////////////////////
		//
		|ВЫБРАТЬ РАЗРЕШЕННЫЕ
		|	КешДанныхДляВывода.Склад				КАК Склад,
		|   КешДанныхДляВывода.ВидНоменклатуры		КАК ВидНоменклатуры,
		|	КешДанныхДляВывода.ТоварнаяКатегория 	КАК ТоварнаяКатегория,
		|
		|	СРЕДНЕЕ(ТоварыОрганизацийОстатки.КоличествоОстаток) КАК ГлубинаОстаткаФактСреднее,
		|   МАКСИМУМ(ТоварыОрганизацийОстатки.КоличествоОстаток)КАК ГлубинаОстаткаФактМаксимальное,
		|  	КОЛИЧЕСТВО(ТоварыОрганизацийОстатки.Номенклатура) 	КАК ТКА
		|ПОМЕСТИТЬ РасчетТКА
		|ИЗ
		|	КешДанныхДляВывода КАК КешДанныхДляВывода
		|
		|ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.ТоварыОрганизаций.Остатки(, Номенклатура.ВидНоменклатуры = &ВидНоменклатуры И Склад = &Склад) КАК ТоварыОрганизацийОстатки
		|ПО	ТоварыОрганизацийОстатки.Номенклатура.ВидНоменклатуры 	= КешДанныхДляВывода.ВидНоменклатуры
		|И	ТоварыОрганизацийОстатки.Номенклатура.ТоварнаяКатегория = КешДанныхДляВывода.ТоварнаяКатегория
		|И	ТоварыОрганизацийОстатки.Склад 						  	= КешДанныхДляВывода.Склад
		|
		|СГРУППИРОВАТЬ ПО
		|	КешДанныхДляВывода.Склад,
		|	КешДанныхДляВывода.ВидНоменклатуры,
		|	КешДанныхДляВывода.ТоварнаяКатегория
		|
		|ИНДЕКСИРОВАТЬ ПО
		|	Склад, ВидНоменклатуры, ТоварнаяКатегория
		|;
		////////////////////////////////////////////////////////////////////////////////////////////
		//
		|ВЫБРАТЬ РАЗРЕШЕННЫЕ
		|	АМ_УправлениеАссортиментнойМатрицей.Склад 				КАК Склад,	
		|	АМ_УправлениеАссортиментнойМатрицей.ВидНоменклатуры 	КАК ВидНоменклатуры,
		|	АМ_УправлениеАссортиментнойМатрицей.ТоварнаяКатегория 	КАК ТоварнаяКатегория,
		|
		|	IsNull(АМ_УправлениеАссортиментнойМатрицей.ПосадочныеМеста, 0) 			КАК ПосадочныеМеста,
		|	IsNull(АМ_УправлениеАссортиментнойМатрицей.ОтклонениеКоличествоПМ, 0) 	КАК ОтклонениеКоличествоПМ,
		|	IsNull(АМ_УправлениеАссортиментнойМатрицей.ГлубинаОстатка, 0)			КАК ГлубинаОстатка
		|ПОМЕСТИТЬ АМ_УправлениеАссортиментнойМатрицей
		|ИЗ
		|	РегистрСведений.АМ_УправлениеАссортиментнойМатрицей.СрезПоследних(, 
		|						(Склад, ВидНоменклатуры, ТоварнаяКатегория) В (	ВЫБРАТЬ 
		|																			Склад, 
		|																			ВидНоменклатуры, 
		|																			ТоварнаяКатегория 
		|																		ИЗ 
		|																			КешДанныхДляВывода)
		|																					) КАК АМ_УправлениеАссортиментнойМатрицей	
		|ИНДЕКСИРОВАТЬ ПО
		|	Склад, ВидНоменклатуры, ТоварнаяКатегория 
		|;
		////////////////////////////////////////////////////////////////////////////////////////////
		//
		|ВЫБРАТЬ РАЗРЕШЕННЫЕ
		|	КешДанныхДляВывода.ДанныеДерева			КАК ДанныеДерева,
		|	КешДанныхДляВывода.ДанныеРодителя		КАК ДанныеРодителя,	
		|   КешДанныхДляВывода.Склад				КАК Склад,
		|	КешДанныхДляВывода.ВидНоменклатуры		КАК ВидНоменклатуры,
		|	КешДанныхДляВывода.ТоварнаяКатегория	КАК ТоварнаяКатегория,
		|
		|	УправлениеАссортиментнойМатрицей.ПосадочныеМеста 			КАК ПосадочныеМеста,
		|	ВЫБОР
		|		КОГДА IsNull(УправлениеАссортиментнойМатрицей_Родитель.ПосадочныеМеста, 0) = 0
		|		ТОГДА 0
		|		ИНАЧЕ ВЫРАЗИТЬ(УправлениеАссортиментнойМатрицей.ПосадочныеМеста / УправлениеАссортиментнойМатрицей_Родитель.ПосадочныеМеста * 100 КАК Число(3, 0))
		|	КОНЕЦ КАК ПосадочныеМестаПроцент,
		|	УправлениеАссортиментнойМатрицей.ОтклонениеКоличествоПМ 		КАК ОтклонениеКоличествоПМ,
		|	УправлениеАссортиментнойМатрицей.ГлубинаОстатка  КАК ГлубинаОстатка,
		|
		|   РасчетТКА.ГлубинаОстаткаФактСреднее  				КАК ГлубинаОстаткаФактСреднее,
		|   РасчетТКА.ГлубинаОстаткаФактМаксимальное  			КАК ГлубинаОстаткаФактМаксимальное,
		|
		|	РасчетТКА.ТКА КАК ТКА,
		|	ВЫБОР
		|		КОГДА IsNull(УправлениеАссортиментнойМатрицей.ПосадочныеМеста, 0) = 0 
		|		ТОГДА	ВЫБОР
		|					КОГДА РасчетТКА.ТКА = 0
		|					ТОГДА 0
		|					ИНАЧЕ ""?!""
		|				КОНЕЦ
		|		ИНАЧЕ ВЫРАЗИТЬ((РасчетТКА.ТКА / УправлениеАссортиментнойМатрицей.ПосадочныеМеста - 1) * 100 КАК Число(4,0)) 
		|	КОНЕЦ КАК ОТКА,
		|	ВЫБОР
		|		КОГДА IsNull(УправлениеАссортиментнойМатрицей.ПосадочныеМеста, 0) <= РасчетТКА.ТКА
		|       ТОГДА	ВЫБОР
		|					КОГДА IsNull(УправлениеАссортиментнойМатрицей.ПосадочныеМеста, 0) + IsNull(УправлениеАссортиментнойМатрицей.ОтклонениеКоличествоПМ, 0) >= РасчетТКА.ТКА
		|					ТОГДА ИСТИНА
		|					ИНАЧЕ ЛОЖЬ
		|				КОНЕЦ
		|		ИНАЧЕ ЛОЖЬ
		|	КОНЕЦ КАК ЕстьОтклоненияПоКоличеству,
		|
		|	ПродажиПоНеделям.ПродажиНеделя 					КАК ПродажиНеделя,
		|	ПродажиПоНеделям.ПродажиНеделяПоАртикулам 		КАК ПродажиНеделяПоАртикулам,
		|	ПродажиПоНеделямПодЗаказ.ПродажиНеделяПодЗаказ 	КАК ПродажиНеделяПодЗаказ,
		|
		|	Продажи2ПоНеделям.Продажи2Недели 				КАК Продажи2Недели,
		|	Продажи2ПоНеделям.Продажи2НеделиПоАртикулам 	КАК Продажи2НеделиПоАртикулам,
		|	ПродажиПо2НеделямПодЗаказ.Продажи2НеделиПодЗаказ КАК Продажи2НеделиПодЗаказ,
		|
		|	ПродажиЗаМесяц.ПродажиМесяц 					КАК ПродажиМесяц,
		|	ПродажиЗаМесяц.ПродажиМесяцПоАртикулам 			КАК ПродажиМесяцПоАртикулам,
		|	ПродажиЗаМесяцПодЗаказ.ПродажиМесяцПодЗаказ 	КАК ПродажиМесяцПодЗаказ
		|
		|ИЗ
		|	КешДанныхДляВывода КАК КешДанныхДляВывода
		|
		|ЛЕВОЕ СОЕДИНЕНИЕ АМ_УправлениеАссортиментнойМатрицей КАК УправлениеАссортиментнойМатрицей
		|ПО	КешДанныхДляВывода.Склад 			 = УправлениеАссортиментнойМатрицей.Склад
		|И 	КешДанныхДляВывода.ВидНоменклатуры 	 = УправлениеАссортиментнойМатрицей.ВидНоменклатуры
		|И  КешДанныхДляВывода.ТоварнаяКатегория = УправлениеАссортиментнойМатрицей.ТоварнаяКатегория
		|И	КешДанныхДляВывода.ТоварнаяКатегория <> ЗНАЧЕНИЕ(Справочник.ТоварныеКатегории.ПустаяСсылка)
		|
		|ЛЕВОЕ СОЕДИНЕНИЕ АМ_УправлениеАссортиментнойМатрицей КАК УправлениеАссортиментнойМатрицей_Родитель
		|ПО	УправлениеАссортиментнойМатрицей.Склад 			 = УправлениеАссортиментнойМатрицей_Родитель.Склад
		|И 	УправлениеАссортиментнойМатрицей.ВидНоменклатуры = УправлениеАссортиментнойМатрицей_Родитель.ВидНоменклатуры
		|И	УправлениеАссортиментнойМатрицей_Родитель.ТоварнаяКатегория = ЗНАЧЕНИЕ(Справочник.ТоварныеКатегории.ПустаяСсылка)
		|
		|ЛЕВОЕ СОЕДИНЕНИЕ РасчетТКА КАК РасчетТКА
		|ПО	РасчетТКА.Склад 		  	= КешДанныхДляВывода.Склад
		|И	РасчетТКА.ВидНоменклатуры 	= КешДанныхДляВывода.ВидНоменклатуры
		|И	РасчетТКА.ТоварнаяКатегория = КешДанныхДляВывода.ТоварнаяКатегория
		|
		|ЛЕВОЕ СОЕДИНЕНИЕ ПродажиПоНеделям КАК ПродажиПоНеделям
		|ПО ПродажиПоНеделям.Склад 			 	= КешДанныхДляВывода.Склад
		|И	ПродажиПоНеделям.ВидНоменклатуры 	= КешДанныхДляВывода.ВидНоменклатуры
		|И	ПродажиПоНеделям.ТоварнаяКатегория 	= КешДанныхДляВывода.ТоварнаяКатегория
		|
		|ЛЕВОЕ СОЕДИНЕНИЕ ПродажиПоНеделямПодЗаказ КАК ПродажиПоНеделямПодЗаказ
		|ПО ПродажиПоНеделямПодЗаказ.Склад 				= КешДанныхДляВывода.Склад
		|И	ПродажиПоНеделямПодЗаказ.ВидНоменклатуры 	= КешДанныхДляВывода.ВидНоменклатуры
		|И	ПродажиПоНеделямПодЗаказ.ТоварнаяКатегория 	= КешДанныхДляВывода.ТоварнаяКатегория
		|
		|ЛЕВОЕ СОЕДИНЕНИЕ Продажи2ПоНеделям КАК Продажи2ПоНеделям
		|ПО Продажи2ПоНеделям.Склад 			= КешДанныхДляВывода.Склад
		|И	Продажи2ПоНеделям.ВидНоменклатуры 	= КешДанныхДляВывода.ВидНоменклатуры
		|И	Продажи2ПоНеделям.ТоварнаяКатегория = КешДанныхДляВывода.ТоварнаяКатегория
		|
		|ЛЕВОЕ СОЕДИНЕНИЕ ПродажиПо2НеделямПодЗаказ КАК ПродажиПо2НеделямПодЗаказ
		|ПО ПродажиПо2НеделямПодЗаказ.Склад 			= КешДанныхДляВывода.Склад
		|И	ПродажиПо2НеделямПодЗаказ.ВидНоменклатуры 	= КешДанныхДляВывода.ВидНоменклатуры
		|И	ПродажиПо2НеделямПодЗаказ.ТоварнаяКатегория = КешДанныхДляВывода.ТоварнаяКатегория
		|
		|ЛЕВОЕ СОЕДИНЕНИЕ ПродажиЗаМесяц КАК ПродажиЗаМесяц
		|ПО ПродажиЗаМесяц.Склад 			= КешДанныхДляВывода.Склад
		|И	ПродажиЗаМесяц.ВидНоменклатуры 	= КешДанныхДляВывода.ВидНоменклатуры
		|И	ПродажиЗаМесяц.ТоварнаяКатегория= КешДанныхДляВывода.ТоварнаяКатегория
		|
		|ЛЕВОЕ СОЕДИНЕНИЕ ПродажиЗаМесяцПодЗаказ КАК ПродажиЗаМесяцПодЗаказ
		|ПО ПродажиЗаМесяцПодЗаказ.Склад 			= КешДанныхДляВывода.Склад
		|И	ПродажиЗаМесяцПодЗаказ.ВидНоменклатуры 	= КешДанныхДляВывода.ВидНоменклатуры
		|И	ПродажиЗаМесяцПодЗаказ.ТоварнаяКатегория= КешДанныхДляВывода.ТоварнаяКатегория
		|
		//|УПОРЯДОЧИТЬ ПО
		//|	КешДанныхДляВывода.ДанныеДерева Убыв
		|;
		////////////////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ РасчетТКА;
		////////////////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ ПродажиПоНеделям;
		////////////////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ ПродажиПоНеделямПодЗаказ;
		////////////////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ Продажи2ПоНеделям;
		////////////////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ ПродажиПо2НеделямПодЗаказ;
		////////////////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ ПродажиЗаМесяц;
		////////////////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ ПродажиЗаМесяцПодЗаказ;
		////////////////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ АМ_УправлениеАссортиментнойМатрицей;
		////////////////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ КешДанныхДляВывода;
		////////////////////////////////////////////////////////////////////////////////////////////
		|";
	Возврат ТекстЗапроса;
	
КонецФункции // ПолучитьТекстЗапросаОбновитьДеревоУправленияПоВидуНоменклатуры()

&НаСервереБезКонтекста
Функция ПолучитьТекстЗапросаОбновитьДеревоПоТоварнойКатегории()

	ТекстЗапроса = "
		////////////////////////////////////////////////////////////////////////////////////////////
		// Кеш номенклатуры
		|ВЫБРАТЬ
		|	СпрНоменклатура.Ссылка 			КАК Номенклатура,
		|	СпрНоменклатура.Производитель 	КАК Производитель
		|ПОМЕСТИТЬ СпрНоменклатура
		|ИЗ
		|	Справочник.Номенклатура КАК СпрНоменклатура
		|ГДЕ
		|	СпрНоменклатура.ВидНоменклатуры = &ВидНоменклатуры
		|И	СпрНоменклатура.ТоварнаяКатегория = &ТоварнаяКатегория
		|
		|ИНДЕКСИРОВАТЬ ПО
		|	Номенклатура
		|;
		////////////////////////////////////////////////////////////////////////////////////////////
		//
		|ВЫБРАТЬ РАЗРЕШЕННЫЕ РАЗЛИЧНЫЕ
		|	ПРЕДСТАВЛЕНИЕ(Производитель.Ссылка)		КАК ДанныеДерева,
		|	""""									КАК ДанныеРодителя,
		|	&Склад								   	КАК Склад,
		|	&ВидНоменклатуры				   		КАК ВидНоменклатуры,
		|	&ТоварнаяКатегория						КАК ТоварнаяКатегория,
		|	Производители.Ссылка                    КАК Производитель
		|ПОМЕСТИТЬ КешДанныхДляВывода
		|ИЗ
		|	Справочник.Производители КАК Производители
		|
		|ВНУТРЕННЕЕ СОЕДИНЕНИЕ СпрНоменклатура КАК СпрНоменклатура
		|ПО	СпрНоменклатура.Производитель = Производители.Ссылка
		|
		|ГДЕ
		|	Производители.ПометкаУдаления = Ложь
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ
		|	""<Производитель не задан>"",
		|	"""",
		|	&Склад,
		|	&ВидНоменклатуры,
		|	&ТоварнаяКатегория,
		|	ЗНАЧЕНИЕ(Справочник.Производители.ПустаяСсылка)
		|
		|ИНДЕКСИРОВАТЬ ПО
		|	Склад, ВидНоменклатуры, ТоварнаяКатегория, Производитель	
		|;
		////////////////////////////////////////////////////////////////////////////////////////////
		// Продажи по неделям
		|ВЫБРАТЬ РАЗРЕШЕННЫЕ
		|	АналитикаУчетаНоменклатуры.Склад 							КАК Склад,
		|	АналитикаУчетаНоменклатуры.Номенклатура.ВидНоменклатуры 	КАК ВидНоменклатуры,
		|	АналитикаУчетаНоменклатуры.Номенклатура.ТоварнаяКатегория 	КАК ТоварнаяКатегория,
		|	АналитикаУчетаНоменклатуры.Номенклатура.Производитель	 	КАК Производитель,
		|	СУММА(КоличествоОборот) 									КАК ПродажиНеделя,
		|	КОЛИЧЕСТВО(АналитикаУчетаНоменклатуры.Номенклатура) 		КАК ПродажиНеделяПоАртикулам
		|ПОМЕСТИТЬ ПродажиПоНеделям
		|ИЗ
		|	РегистрНакопления.ВыручкаИСебестоимостьПродаж.Обороты(&НачалоПериодаНеделя, &КонецПериода, , АналитикаУчетаНоменклатуры.Номенклатура В (ВЫБРАТЬ Номенклатура ИЗ СпрНоменклатура) И АналитикаУчетаНоменклатуры.Склад = &Склад
		|														И  АналитикаУчетаПоПартнерам.Партнер <> ЗНАЧЕНИЕ(Справочник.Партнеры.НашеПредприятие))
		|
		|СГРУППИРОВАТЬ ПО
		|	АналитикаУчетаНоменклатуры.Склад,
		|	АналитикаУчетаНоменклатуры.Номенклатура.ВидНоменклатуры,
		|	АналитикаУчетаНоменклатуры.Номенклатура.ТоварнаяКатегория,
		|	АналитикаУчетаНоменклатуры.Номенклатура.Производитель	
		|
		|ИНДЕКСИРОВАТЬ ПО
		|	Склад, ВидНоменклатуры, ТоварнаяКатегория, Производитель
		|;
		////////////////////////////////////////////////////////////////////////////////////////////
		// Продажи по неделям "Под заказ"
		|ВЫБРАТЬ РАЗРЕШЕННЫЕ
		|	Склад							КАК Склад,
		|	Номенклатура.ВидНоменклатуры	КАК ВидНоменклатуры,
		|	Номенклатура.ТоварнаяКатегория 	КАК ТоварнаяКатегория,
		|	Номенклатура.Производитель 		КАК Производитель,
		|	Сумма(НаличиеПодЗаказРасход)   	КАК ПродажиНеделяПодЗаказ
		|ПОМЕСТИТЬ ПродажиПоНеделямПодЗаказ
		|ИЗ
		|	РегистрНакопления.ОбеспечениеЗаказов.Обороты(&НачалоПериодаНеделя, &КонецПериода, Регистратор, Номенклатура В (ВЫБРАТЬ Номенклатура ИЗ СпрНоменклатура) И Склад = &Склад)
		|ГДЕ
		|	Регистратор Ссылка Документ.РеализацияТоваровУслуг
		|
		|СГРУППИРОВАТЬ ПО
		| 	Склад,
		|	Номенклатура
		|
		|ИНДЕКСИРОВАТЬ ПО
		| 	Склад, ВидНоменклатуры, ТоварнаяКатегория, Производитель
		|;
		////////////////////////////////////////////////////////////////////////////////////////////
		// 3. Продажи по 2-х неделям
		|ВЫБРАТЬ РАЗРЕШЕННЫЕ
		|	АналитикаУчетаНоменклатуры.Склад 							КАК Склад,
		|	АналитикаУчетаНоменклатуры.Номенклатура.ВидНоменклатуры 	КАК ВидНоменклатуры,
		|	АналитикаУчетаНоменклатуры.Номенклатура.ТоварнаяКатегория 	КАК ТоварнаяКатегория,
		|	АналитикаУчетаНоменклатуры.Номенклатура.Производитель	 	КАК Производитель,
		|	СУММА(КоличествоОборот) 									КАК Продажи2Недели,
		|	КОЛИЧЕСТВО(АналитикаУчетаНоменклатуры.Номенклатура) 		КАК Продажи2НеделиПоАртикулам
		|ПОМЕСТИТЬ Продажи2ПоНеделям
		|ИЗ
		|	РегистрНакопления.ВыручкаИСебестоимостьПродаж.Обороты(&НачалоПериода2Недели, &КонецПериода, , АналитикаУчетаНоменклатуры.Номенклатура В (ВЫБРАТЬ Номенклатура ИЗ СпрНоменклатура) И АналитикаУчетаНоменклатуры.Склад = &Склад
		|														И  АналитикаУчетаПоПартнерам.Партнер <> ЗНАЧЕНИЕ(Справочник.Партнеры.НашеПредприятие))
		|
		|СГРУППИРОВАТЬ ПО
		|	АналитикаУчетаНоменклатуры.Склад,
		|	АналитикаУчетаНоменклатуры.Номенклатура.ВидНоменклатуры,
		|	АналитикаУчетаНоменклатуры.Номенклатура.ТоварнаяКатегория,
		|	АналитикаУчетаНоменклатуры.Номенклатура.Производитель	
		|
		|ИНДЕКСИРОВАТЬ ПО
		|	Склад, ВидНоменклатуры, ТоварнаяКатегория, Производитель
		|;
		////////////////////////////////////////////////////////////////////////////////////////////
		// 4. Продажи по 2-х неделям "Под заказ"
		|ВЫБРАТЬ РАЗРЕШЕННЫЕ
		|	Склад							КАК Склад,
		|	Номенклатура.ВидНоменклатуры	КАК ВидНоменклатуры,
		|	Номенклатура.ТоварнаяКатегория 	КАК ТоварнаяКатегория,
		|	Номенклатура.Производитель 		КАК Производитель,
		|	Сумма(НаличиеПодЗаказРасход)   	КАК Продажи2НеделиПодЗаказ
		|ПОМЕСТИТЬ ПродажиПо2НеделямПодЗаказ
		|ИЗ
		|	РегистрНакопления.ОбеспечениеЗаказов.Обороты(&НачалоПериода2Недели, &КонецПериода, Регистратор, Номенклатура В (ВЫБРАТЬ Номенклатура ИЗ СпрНоменклатура) И Склад = &Склад)
		|ГДЕ
		|	Регистратор Ссылка Документ.РеализацияТоваровУслуг
		|
		|СГРУППИРОВАТЬ ПО
		| 	Склад,
		|	Номенклатура
		|
		|ИНДЕКСИРОВАТЬ ПО
		| 	Склад, ВидНоменклатуры, ТоварнаяКатегория, Производитель
		|;
		////////////////////////////////////////////////////////////////////////////////////////////
		// 5. Продажи за месяц
		|ВЫБРАТЬ РАЗРЕШЕННЫЕ
		|	АналитикаУчетаНоменклатуры.Склад 							КАК Склад,
		|	АналитикаУчетаНоменклатуры.Номенклатура.ВидНоменклатуры 	КАК ВидНоменклатуры,
		|	АналитикаУчетаНоменклатуры.Номенклатура.ТоварнаяКатегория 	КАК ТоварнаяКатегория,
		|	АналитикаУчетаНоменклатуры.Номенклатура.Производитель	 	КАК Производитель,
		|	СУММА(КоличествоОборот) 									КАК ПродажиМесяц,
		|	КОЛИЧЕСТВО(АналитикаУчетаНоменклатуры.Номенклатура) 		КАК ПродажиМесяцПоАртикулам
		|ПОМЕСТИТЬ ПродажиЗаМесяц
		|ИЗ
		|	РегистрНакопления.ВыручкаИСебестоимостьПродаж.Обороты(&НачалоПериодаМесяц, &КонецПериода, ,  АналитикаУчетаНоменклатуры.Номенклатура В (ВЫБРАТЬ Номенклатура ИЗ СпрНоменклатура) И АналитикаУчетаНоменклатуры.Склад = &Склад
		|														И  АналитикаУчетаПоПартнерам.Партнер <> ЗНАЧЕНИЕ(Справочник.Партнеры.НашеПредприятие))
		|
		|СГРУППИРОВАТЬ ПО
		|	АналитикаУчетаНоменклатуры.Склад,
		|	АналитикаУчетаНоменклатуры.Номенклатура.ВидНоменклатуры,
		|	АналитикаУчетаНоменклатуры.Номенклатура.ТоварнаяКатегория,
		|	АналитикаУчетаНоменклатуры.Номенклатура.Производитель	
		|
		|ИНДЕКСИРОВАТЬ ПО
		|	Склад, ВидНоменклатуры, ТоварнаяКатегория, Производитель
		|;
		////////////////////////////////////////////////////////////////////////////////////////////
		// 6. Продажи за месяц "Под заказ"
		|ВЫБРАТЬ РАЗРЕШЕННЫЕ
		|	Склад							КАК Склад,
		|	Номенклатура.ВидНоменклатуры	КАК ВидНоменклатуры,
		|	Номенклатура.ТоварнаяКатегория 	КАК ТоварнаяКатегория,
		|	Номенклатура.Производитель 		КАК Производитель,
		|	Сумма(НаличиеПодЗаказРасход)   	КАК ПродажиМесяцПодЗаказ
		|ПОМЕСТИТЬ ПродажиЗаМесяцПодЗаказ
		|ИЗ
		|	РегистрНакопления.ОбеспечениеЗаказов.Обороты(&НачалоПериодаМесяц, &КонецПериода, Регистратор, Номенклатура В (ВЫБРАТЬ Номенклатура ИЗ СпрНоменклатура) И Склад = &Склад)
		|ГДЕ
		|	Регистратор Ссылка Документ.РеализацияТоваровУслуг
		|
		|СГРУППИРОВАТЬ ПО
		| 	Склад,
		|	Номенклатура
		|
		|ИНДЕКСИРОВАТЬ ПО
		| 	Склад, ВидНоменклатуры, ТоварнаяКатегория, Производитель 
		|;
		////////////////////////////////////////////////////////////////////////////////////////////
		//
		|ВЫБРАТЬ РАЗРЕШЕННЫЕ
		|	КешДанныхДляВывода.Склад				КАК Склад,
		|   КешДанныхДляВывода.ВидНоменклатуры		КАК ВидНоменклатуры,
		|	КешДанныхДляВывода.ТоварнаяКатегория 	КАК ТоварнаяКатегория,
		|	КешДанныхДляВывода.Производитель	 	КАК Производитель,
		|
		|	СРЕДНЕЕ(ТоварыОрганизацийОстатки.КоличествоОстаток) КАК ГлубинаОстаткаФактСреднее,
		|   МАКСИМУМ(ТоварыОрганизацийОстатки.КоличествоОстаток)КАК ГлубинаОстаткаФактМаксимальное,
		|  	КОЛИЧЕСТВО(ТоварыОрганизацийОстатки.Номенклатура) 	КАК ТКА
		|ПОМЕСТИТЬ РасчетТКА
		|ИЗ
		|	КешДанныхДляВывода КАК КешДанныхДляВывода
		|
		|ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.ТоварыОрганизаций.Остатки(, Номенклатура В (ВЫБРАТЬ Номенклатура ИЗ СпрНоменклатура) И Склад = &Склад) КАК ТоварыОрганизацийОстатки
		|ПО	ТоварыОрганизацийОстатки.Номенклатура.ВидНоменклатуры 	= КешДанныхДляВывода.ВидНоменклатуры
		|И	ТоварыОрганизацийОстатки.Номенклатура.ТоварнаяКатегория = КешДанныхДляВывода.ТоварнаяКатегория
		|И	ТоварыОрганизацийОстатки.Номенклатура.Производитель	    = КешДанныхДляВывода.Производитель
		|И	ТоварыОрганизацийОстатки.Склад 						  	= КешДанныхДляВывода.Склад
		|
		|СГРУППИРОВАТЬ ПО
		|	КешДанныхДляВывода.Склад,
		|	КешДанныхДляВывода.ВидНоменклатуры,
		|	КешДанныхДляВывода.ТоварнаяКатегория,
		|	КешДанныхДляВывода.Производитель
		|
		|ИНДЕКСИРОВАТЬ ПО
		|	Склад, ВидНоменклатуры, ТоварнаяКатегория, Производитель
		|;
		////////////////////////////////////////////////////////////////////////////////////////////
		//
		|ВЫБРАТЬ РАЗРЕШЕННЫЕ
		|	АМ_УправлениеАссортиментнойМатрицей.Склад 				КАК Склад,	
		|	АМ_УправлениеАссортиментнойМатрицей.ВидНоменклатуры 	КАК ВидНоменклатуры,
		|	АМ_УправлениеАссортиментнойМатрицей.ТоварнаяКатегория 	КАК ТоварнаяКатегория,
		|	АМ_УправлениеАссортиментнойМатрицей.Производитель		КАК Производитель,
		|
		|	IsNull(АМ_УправлениеАссортиментнойМатрицей.ПосадочныеМеста, 0) 			КАК ПосадочныеМеста,
		|	IsNull(АМ_УправлениеАссортиментнойМатрицей.ОтклонениеКоличествоПМ, 0) 	КАК ОтклонениеКоличествоПМ,
		|	IsNull(АМ_УправлениеАссортиментнойМатрицей.ГлубинаОстатка, 0)			КАК ГлубинаОстатка
		|ПОМЕСТИТЬ АМ_УправлениеАссортиментнойМатрицей
		|ИЗ
		|	РегистрСведений.АМ_УправлениеАссортиментнойМатрицей.СрезПоследних(, 
		|						(Склад, 
		|						ВидНоменклатуры, 
		|						ТоварнаяКатегория, 
		|						Производитель) В (	ВЫБРАТЬ 
		|												Склад, 
		|												ВидНоменклатуры, 
		|												ТоварнаяКатегория,
		|												Производитель
		|											ИЗ 
		|												КешДанныхДляВывода)
		|										  ) КАК АМ_УправлениеАссортиментнойМатрицей	
		|ИНДЕКСИРОВАТЬ ПО
		|	Склад, ВидНоменклатуры, ТоварнаяКатегория, Производитель 
		|;
		////////////////////////////////////////////////////////////////////////////////////////////
		//
		|ВЫБРАТЬ РАЗРЕШЕННЫЕ
		|	КешДанныхДляВывода.ДанныеДерева			КАК ДанныеДерева,
		|	КешДанныхДляВывода.ДанныеРодителя		КАК ДанныеРодителя,	
		|   КешДанныхДляВывода.Склад				КАК Склад,
		|	КешДанныхДляВывода.ВидНоменклатуры		КАК ВидНоменклатуры,
		|	КешДанныхДляВывода.ТоварнаяКатегория	КАК ТоварнаяКатегория,
		|	КешДанныхДляВывода.Производитель		КАК Производитель,
		|
		|	УправлениеАссортиментнойМатрицей.ПосадочныеМеста 			КАК ПосадочныеМеста,
		|	ВЫБОР
		|		КОГДА IsNull(УправлениеАссортиментнойМатрицей_Родитель.ПосадочныеМеста, 0) = 0
		|		ТОГДА 0
		|		ИНАЧЕ ВЫРАЗИТЬ(УправлениеАссортиментнойМатрицей.ПосадочныеМеста / УправлениеАссортиментнойМатрицей_Родитель.ПосадочныеМеста * 100 КАК Число(3, 0))
		|	КОНЕЦ КАК ПосадочныеМестаПроцент,
		|	УправлениеАссортиментнойМатрицей.ОтклонениеКоличествоПМ 		КАК ОтклонениеКоличествоПМ,
		|	УправлениеАссортиментнойМатрицей.ГлубинаОстатка  КАК ГлубинаОстатка,
		|
		|   РасчетТКА.ГлубинаОстаткаФактСреднее  				КАК ГлубинаОстаткаФактСреднее,
		|   РасчетТКА.ГлубинаОстаткаФактМаксимальное  			КАК ГлубинаОстаткаФактМаксимальное,
		|
		|	РасчетТКА.ТКА КАК ТКА,
		|	ВЫБОР
		|		КОГДА IsNull(УправлениеАссортиментнойМатрицей.ПосадочныеМеста, 0) = 0 
		|		ТОГДА	ВЫБОР
		|					КОГДА РасчетТКА.ТКА = 0
		|					ТОГДА 0
		|					ИНАЧЕ ""?!""
		|				КОНЕЦ
		|		ИНАЧЕ ВЫРАЗИТЬ((РасчетТКА.ТКА / УправлениеАссортиментнойМатрицей.ПосадочныеМеста - 1) * 100 КАК Число(4,0)) 
		|	КОНЕЦ КАК ОТКА,
		|	ВЫБОР
		|		КОГДА IsNull(УправлениеАссортиментнойМатрицей.ПосадочныеМеста, 0) <= РасчетТКА.ТКА
		|       ТОГДА	ВЫБОР
		|					КОГДА IsNull(УправлениеАссортиментнойМатрицей.ПосадочныеМеста, 0) + IsNull(УправлениеАссортиментнойМатрицей.ОтклонениеКоличествоПМ, 0) >= РасчетТКА.ТКА
		|					ТОГДА ИСТИНА
		|					ИНАЧЕ ЛОЖЬ
		|				КОНЕЦ
		|		ИНАЧЕ ЛОЖЬ
		|	КОНЕЦ КАК ЕстьОтклоненияПоКоличеству,
		|
		|	ПродажиПоНеделям.ПродажиНеделя 					КАК ПродажиНеделя,
		|	ПродажиПоНеделям.ПродажиНеделяПоАртикулам 		КАК ПродажиНеделяПоАртикулам,
		|	ПродажиПоНеделямПодЗаказ.ПродажиНеделяПодЗаказ 	КАК ПродажиНеделяПодЗаказ,
		|
		|	Продажи2ПоНеделям.Продажи2Недели 				КАК Продажи2Недели,
		|	Продажи2ПоНеделям.Продажи2НеделиПоАртикулам 	КАК Продажи2НеделиПоАртикулам,
		|	ПродажиПо2НеделямПодЗаказ.Продажи2НеделиПодЗаказ КАК Продажи2НеделиПодЗаказ,
		|
		|	ПродажиЗаМесяц.ПродажиМесяц 					КАК ПродажиМесяц,
		|	ПродажиЗаМесяц.ПродажиМесяцПоАртикулам 			КАК ПродажиМесяцПоАртикулам,
		|	ПродажиЗаМесяцПодЗаказ.ПродажиМесяцПодЗаказ 	КАК ПродажиМесяцПодЗаказ
		|
		|ИЗ
		|	КешДанныхДляВывода КАК КешДанныхДляВывода
		|
		|ЛЕВОЕ СОЕДИНЕНИЕ АМ_УправлениеАссортиментнойМатрицей КАК УправлениеАссортиментнойМатрицей
		|ПО	КешДанныхДляВывода.Склад 			 = УправлениеАссортиментнойМатрицей.Склад
		|И 	КешДанныхДляВывода.ВидНоменклатуры 	 = УправлениеАссортиментнойМатрицей.ВидНоменклатуры
		|И  КешДанныхДляВывода.ТоварнаяКатегория = УправлениеАссортиментнойМатрицей.ТоварнаяКатегория
		|И  КешДанныхДляВывода.Производитель	 = УправлениеАссортиментнойМатрицей.Производитель
		|И	КешДанныхДляВывода.Производитель 	<> ЗНАЧЕНИЕ(Справочник.Производители.ПустаяСсылка)
		|
		|ЛЕВОЕ СОЕДИНЕНИЕ АМ_УправлениеАссортиментнойМатрицей КАК УправлениеАссортиментнойМатрицей_Родитель
		|ПО	УправлениеАссортиментнойМатрицей.Склад 			 	= УправлениеАссортиментнойМатрицей_Родитель.Склад
		|И 	УправлениеАссортиментнойМатрицей.ВидНоменклатуры 	= УправлениеАссортиментнойМатрицей_Родитель.ВидНоменклатуры
		|И 	УправлениеАссортиментнойМатрицей.ТоварнаяКатегория 	= УправлениеАссортиментнойМатрицей_Родитель.ТоварнаяКатегория
		|И	УправлениеАссортиментнойМатрицей_Родитель.Производитель = ЗНАЧЕНИЕ(Справочник.Производители.ПустаяСсылка)
		|
		|ЛЕВОЕ СОЕДИНЕНИЕ РасчетТКА КАК РасчетТКА
		|ПО	РасчетТКА.Склад 		  	= КешДанныхДляВывода.Склад
		|И	РасчетТКА.ВидНоменклатуры 	= КешДанныхДляВывода.ВидНоменклатуры
		|И	РасчетТКА.ТоварнаяКатегория = КешДанныхДляВывода.ТоварнаяКатегория
		|И	РасчетТКА.Производитель 	= КешДанныхДляВывода.Производитель
		|
		|ЛЕВОЕ СОЕДИНЕНИЕ ПродажиПоНеделям КАК ПродажиПоНеделям
		|ПО ПродажиПоНеделям.Склад 			 	= КешДанныхДляВывода.Склад
		|И	ПродажиПоНеделям.ВидНоменклатуры 	= КешДанныхДляВывода.ВидНоменклатуры
		|И	ПродажиПоНеделям.ТоварнаяКатегория 	= КешДанныхДляВывода.ТоварнаяКатегория
		|И	ПродажиПоНеделям.Производитель 		= КешДанныхДляВывода.Производитель
		|
		|ЛЕВОЕ СОЕДИНЕНИЕ ПродажиПоНеделямПодЗаказ КАК ПродажиПоНеделямПодЗаказ
		|ПО ПродажиПоНеделямПодЗаказ.Склад 				= КешДанныхДляВывода.Склад
		|И	ПродажиПоНеделямПодЗаказ.ВидНоменклатуры 	= КешДанныхДляВывода.ВидНоменклатуры
		|И	ПродажиПоНеделямПодЗаказ.ТоварнаяКатегория 	= КешДанныхДляВывода.ТоварнаяКатегория
		|И	ПродажиПоНеделямПодЗаказ.Производитель 		= КешДанныхДляВывода.Производитель
		|
		|ЛЕВОЕ СОЕДИНЕНИЕ Продажи2ПоНеделям КАК Продажи2ПоНеделям
		|ПО Продажи2ПоНеделям.Склад 			= КешДанныхДляВывода.Склад
		|И	Продажи2ПоНеделям.ВидНоменклатуры 	= КешДанныхДляВывода.ВидНоменклатуры
		|И	Продажи2ПоНеделям.ТоварнаяКатегория = КешДанныхДляВывода.ТоварнаяКатегория
		|И	Продажи2ПоНеделям.Производитель 	= КешДанныхДляВывода.Производитель
		|
		|ЛЕВОЕ СОЕДИНЕНИЕ ПродажиПо2НеделямПодЗаказ КАК ПродажиПо2НеделямПодЗаказ
		|ПО ПродажиПо2НеделямПодЗаказ.Склад 			= КешДанныхДляВывода.Склад
		|И	ПродажиПо2НеделямПодЗаказ.ВидНоменклатуры 	= КешДанныхДляВывода.ВидНоменклатуры
		|И	ПродажиПо2НеделямПодЗаказ.ТоварнаяКатегория = КешДанныхДляВывода.ТоварнаяКатегория
		|И	ПродажиПо2НеделямПодЗаказ.Производитель 	= КешДанныхДляВывода.Производитель
		|
		|ЛЕВОЕ СОЕДИНЕНИЕ ПродажиЗаМесяц КАК ПродажиЗаМесяц
		|ПО ПродажиЗаМесяц.Склад 			= КешДанныхДляВывода.Склад
		|И	ПродажиЗаМесяц.ВидНоменклатуры 	= КешДанныхДляВывода.ВидНоменклатуры
		|И	ПродажиЗаМесяц.ТоварнаяКатегория= КешДанныхДляВывода.ТоварнаяКатегория
		|И	ПродажиЗаМесяц.Производитель	= КешДанныхДляВывода.Производитель
		|
		|ЛЕВОЕ СОЕДИНЕНИЕ ПродажиЗаМесяцПодЗаказ КАК ПродажиЗаМесяцПодЗаказ
		|ПО ПродажиЗаМесяцПодЗаказ.Склад 			= КешДанныхДляВывода.Склад
		|И	ПродажиЗаМесяцПодЗаказ.ВидНоменклатуры 	= КешДанныхДляВывода.ВидНоменклатуры
		|И	ПродажиЗаМесяцПодЗаказ.ТоварнаяКатегория= КешДанныхДляВывода.ТоварнаяКатегория
		|И	ПродажиЗаМесяцПодЗаказ.Производитель	= КешДанныхДляВывода.Производитель
		|
		//|УПОРЯДОЧИТЬ ПО
		//|	КешДанныхДляВывода.ДанныеДерева Убыв
		|;
		////////////////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ РасчетТКА;
		////////////////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ ПродажиПоНеделям;
		////////////////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ ПродажиПоНеделямПодЗаказ;
		////////////////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ Продажи2ПоНеделям;
		////////////////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ ПродажиПо2НеделямПодЗаказ;
		////////////////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ ПродажиЗаМесяц;
		////////////////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ ПродажиЗаМесяцПодЗаказ;
		////////////////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ АМ_УправлениеАссортиментнойМатрицей;
		////////////////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ КешДанныхДляВывода;
		////////////////////////////////////////////////////////////////////////////////////////////
		|";
	Возврат ТекстЗапроса;
	
КонецФункции // ПолучитьТекстЗапросаОбновитьДеревоУправленияПоВидуНоменклатуры()

&НаСервереБезКонтекста
Функция ПолучитьТекстЗапросаОбновитьДеревоДетальныеЗаписи()

	ТекстЗапроса = "
		////////////////////////////////////////////////////////////////////////////////////////////
		// 0.
		|ВЫБРАТЬ РАЗРЕШЕННЫЕ
		|	ПРЕДСТАВЛЕНИЕ(СпрНоменклатура.Ссылка)		КАК ДанныеДерева,
		|	""""										КАК ДанныеРодителя,
		|	СпрНоменклатура.Ссылка				   		КАК Номенклатура,
		|	&Склад								   		КАК Склад,
		|	СпрНоменклатура.ВидНоменклатуры				КАК ВидНоменклатуры,
		|	СпрНоменклатура.ТоварнаяКатегория			КАК ТоварнаяКатегория
		|ПОМЕСТИТЬ КешДанныхДляВывода
		|ИЗ
		|	Справочник.Номенклатура КАК СпрНоменклатура
		|
		|ГДЕ
		|	СпрНоменклатура.ВидНоменклатуры = &ВидНоменклатуры
		|И	СпрНоменклатура.ТоварнаяКатегория = &ТоварнаяКатегория
		|И	СпрНоменклатура.Производитель = &Производитель
		|И 	СпрНоменклатура.ЭтоГруппа = Ложь	
		|И	СпрНоменклатура.ПометкаУдаления = Ложь
		|
		|ИНДЕКСИРОВАТЬ ПО
		|	Номенклатура, Склад	
		|;
		////////////////////////////////////////////////////////////////////////////////////////////
		// 1. Продажи по неделям
		|ВЫБРАТЬ РАЗРЕШЕННЫЕ
		|	АналитикаУчетаНоменклатуры.Склад 					КАК Склад,
		|	АналитикаУчетаНоменклатуры.Номенклатура 			КАК Номенклатура,
		|	СУММА(КоличествоОборот) 							КАК ПродажиНеделя,
		|	КОЛИЧЕСТВО(АналитикаУчетаНоменклатуры.Номенклатура) КАК ПродажиНеделяПоАртикулам
		|ПОМЕСТИТЬ ПродажиПоНеделям
		|ИЗ
		|	РегистрНакопления.ВыручкаИСебестоимостьПродаж.Обороты(&НачалоПериодаНеделя, &КонецПериода, , (АналитикаУчетаНоменклатуры.Номенклатура, АналитикаУчетаНоменклатуры.Склад) В (ВЫБРАТЬ Номенклатура, Склад ИЗ КешДанныхДляВывода)
		|														И  АналитикаУчетаПоПартнерам.Партнер <> ЗНАЧЕНИЕ(Справочник.Партнеры.НашеПредприятие))
		|
		|СГРУППИРОВАТЬ ПО
		|	АналитикаУчетаНоменклатуры.Склад,
		|	АналитикаУчетаНоменклатуры.Номенклатура
		|
		|ИНДЕКСИРОВАТЬ ПО
		|	Номенклатура, Склад
		|;
		////////////////////////////////////////////////////////////////////////////////////////////
		// 2. Продажи по неделям "Под заказ"
		|ВЫБРАТЬ РАЗРЕШЕННЫЕ
		|	Склад						КАК Склад,
		|	Номенклатура				КАК Номенклатура,
		|	Сумма(НаличиеПодЗаказРасход)КАК ПродажиНеделяПодЗаказ
		|ПОМЕСТИТЬ ПродажиПоНеделямПодЗаказ
		|ИЗ
		|	РегистрНакопления.ОбеспечениеЗаказов.Обороты(&НачалоПериодаНеделя, &КонецПериода, Регистратор, (Номенклатура, Склад) В (ВЫБРАТЬ Номенклатура, Склад ИЗ КешДанныхДляВывода))
		|ГДЕ
		|	Регистратор Ссылка Документ.РеализацияТоваровУслуг
		|
		|СГРУППИРОВАТЬ ПО
		| 	Склад,
		|	Номенклатура
		|
		|ИНДЕКСИРОВАТЬ ПО
		| 	Номенклатура, Склад
		|;
		////////////////////////////////////////////////////////////////////////////////////////////
		// 3. Продажи по 2-х неделям
		|ВЫБРАТЬ РАЗРЕШЕННЫЕ
		|	АналитикаУчетаНоменклатуры.Склад 					КАК Склад,
		|	АналитикаУчетаНоменклатуры.Номенклатура 			КАК Номенклатура,
		|	СУММА(КоличествоОборот) 							КАК Продажи2Недели,
		|	КОЛИЧЕСТВО(АналитикаУчетаНоменклатуры.Номенклатура) КАК Продажи2НеделиПоАртикулам
		|ПОМЕСТИТЬ Продажи2ПоНеделям
		|ИЗ
		|	РегистрНакопления.ВыручкаИСебестоимостьПродаж.Обороты(&НачалоПериода2Недели, &КонецПериода, , (АналитикаУчетаНоменклатуры.Номенклатура, АналитикаУчетаНоменклатуры.Склад) В (ВЫБРАТЬ Номенклатура, Склад ИЗ КешДанныхДляВывода)
		|														И  АналитикаУчетаПоПартнерам.Партнер <> ЗНАЧЕНИЕ(Справочник.Партнеры.НашеПредприятие))
		|
		|СГРУППИРОВАТЬ ПО
		|	АналитикаУчетаНоменклатуры.Склад,
		|	АналитикаУчетаНоменклатуры.Номенклатура
		|
		|ИНДЕКСИРОВАТЬ ПО
		|	Номенклатура, Склад
		|;
		////////////////////////////////////////////////////////////////////////////////////////////
		// 4. Продажи по 2-х неделям "Под заказ"
		|ВЫБРАТЬ РАЗРЕШЕННЫЕ
		|	Склад							КАК Склад,
		|	Номенклатура					КАК Номенклатура,
		|	Сумма(НаличиеПодЗаказРасход)   	КАК Продажи2НеделиПодЗаказ
		|ПОМЕСТИТЬ ПродажиПо2НеделямПодЗаказ
		|ИЗ
		|	РегистрНакопления.ОбеспечениеЗаказов.Обороты(&НачалоПериода2Недели, &КонецПериода, Регистратор, (Номенклатура, Склад) В (ВЫБРАТЬ Номенклатура, Склад ИЗ КешДанныхДляВывода))
		|ГДЕ
		|	Регистратор Ссылка Документ.РеализацияТоваровУслуг
		|
		|СГРУППИРОВАТЬ ПО
		| 	Склад,
		|	Номенклатура
		|
		|ИНДЕКСИРОВАТЬ ПО
		| 	Номенклатура, Склад
		|;
		////////////////////////////////////////////////////////////////////////////////////////////
		// 5. Продажи за месяц
		|ВЫБРАТЬ РАЗРЕШЕННЫЕ
		|	АналитикаУчетаНоменклатуры.Склад 					КАК Склад,
		|	АналитикаУчетаНоменклатуры.Номенклатура 			КАК Номенклатура,
		|	СУММА(КоличествоОборот) 							КАК ПродажиМесяц,
		|	КОЛИЧЕСТВО(АналитикаУчетаНоменклатуры.Номенклатура) КАК ПродажиМесяцПоАртикулам
		|ПОМЕСТИТЬ ПродажиЗаМесяц
		|ИЗ
		|	РегистрНакопления.ВыручкаИСебестоимостьПродаж.Обороты(&НачалоПериодаМесяц, &КонецПериода, ,  (АналитикаУчетаНоменклатуры.Номенклатура, АналитикаУчетаНоменклатуры.Склад) В (ВЫБРАТЬ Номенклатура, Склад ИЗ КешДанныхДляВывода)
		|														И  АналитикаУчетаПоПартнерам.Партнер <> ЗНАЧЕНИЕ(Справочник.Партнеры.НашеПредприятие))
		|
		|СГРУППИРОВАТЬ ПО
		|	АналитикаУчетаНоменклатуры.Склад,
		|	АналитикаУчетаНоменклатуры.Номенклатура
		|
		|ИНДЕКСИРОВАТЬ ПО
		|	Номенклатура, Склад
		|;
		////////////////////////////////////////////////////////////////////////////////////////////
		// 6. Продажи за месяц "Под заказ"
		|ВЫБРАТЬ РАЗРЕШЕННЫЕ
		|	Склад							КАК Склад,
		|	Номенклатура					КАК Номенклатура,
		|	Сумма(НаличиеПодЗаказРасход)   	КАК ПродажиМесяцПодЗаказ
		|ПОМЕСТИТЬ ПродажиЗаМесяцПодЗаказ
		|ИЗ
		|	РегистрНакопления.ОбеспечениеЗаказов.Обороты(&НачалоПериодаМесяц, &КонецПериода, Регистратор, (Номенклатура, Склад) В (ВЫБРАТЬ Номенклатура, Склад ИЗ КешДанныхДляВывода))
		|ГДЕ
		|	Регистратор Ссылка Документ.РеализацияТоваровУслуг
		|
		|СГРУППИРОВАТЬ ПО
		| 	Склад,
		|	Номенклатура
		|
		|ИНДЕКСИРОВАТЬ ПО
		| 	Номенклатура, Склад
		|;
		////////////////////////////////////////////////////////////////////////////////////////////
		//
		|ВЫБРАТЬ РАЗРЕШЕННЫЕ
		|	АМ_УправлениеАссортиментнойМатрицей.Склад 				КАК Склад,	
		|	АМ_УправлениеАссортиментнойМатрицей.ВидНоменклатуры 	КАК ВидНоменклатуры,
		|	АМ_УправлениеАссортиментнойМатрицей.ТоварнаяКатегория 	КАК ТоварнаяКатегория,
		|
		//|	IsNull(АМ_УправлениеАссортиментнойМатрицей.ОтклонениеКоличествоПМ, 0) 	КАК ОтклонениеКоличествоПМ,
		|	IsNull(АМ_УправлениеАссортиментнойМатрицей.ГлубинаОстатка, 0)			КАК ГлубинаОстатка
		|ПОМЕСТИТЬ АМ_УправлениеАссортиментнойМатрицей
		|ИЗ
		|	РегистрСведений.АМ_УправлениеАссортиментнойМатрицей.СрезПоследних(, 
		|						(Склад, ВидНоменклатуры, ТоварнаяКатегория) В (	ВЫБРАТЬ 
		|																			Склад, 
		|																			ВидНоменклатуры, 
		|																			ТоварнаяКатегория 
		|																		ИЗ 
		|																			КешДанныхДляВывода)
		|																					) КАК АМ_УправлениеАссортиментнойМатрицей	
		|ИНДЕКСИРОВАТЬ ПО
		|	Склад, ВидНоменклатуры, ТоварнаяКатегория 
		|;
		////////////////////////////////////////////////////////////////////////////////////////////
		//
		|ВЫБРАТЬ РАЗРЕШЕННЫЕ
		|	КешДанныхДляВывода.ДанныеДерева			КАК ДанныеДерева,
		|	КешДанныхДляВывода.ДанныеРодителя		КАК ДанныеРодителя,
		|	КешДанныхДляВывода.Номенклатура			КАК Номенклатура,
		|   КешДанныхДляВывода.Склад				КАК Склад,
		|	КешДанныхДляВывода.ВидНоменклатуры		КАК ВидНоменклатуры,
		|	КешДанныхДляВывода.ТоварнаяКатегория	КАК ТоварнаяКатегория,
		|
		|	УправлениеАссортиментнойМатрицей.ГлубинаОстатка		КАК ГлубинаОстатка,
		|	ТоварыОрганизацийОбороты.КоличествоКонечныйОстаток 	КАК ГлубинаОстаткаФактСреднее,
		|	ТоварыОрганизацийОбороты.КоличествоКонечныйОстаток 	КАК ГлубинаОстаткаФактМаксимальное,
		|   ВЫБОР
		|		КОГДА ТоварыОрганизацийОбороты.КоличествоКонечныйОстаток <> 0
		|			ТОГДА 1
		|		КОГДА ТоварыОрганизацийОбороты.КоличествоПриход <> 0 ИЛИ ТоварыОрганизацийОбороты.КоличествоРасход <> 0
		|			ТОГДА 0
		|		ИНАЧЕ 0
		|	КОНЕЦ КАК ТКА,
		|   Истина КАК ЕстьОтклоненияПоКоличеству,
		|
		|	ПродажиПоНеделям.ПродажиНеделя 					КАК ПродажиНеделя,
		|	ПродажиПоНеделям.ПродажиНеделяПоАртикулам 		КАК ПродажиНеделяПоАртикулам,
		|	ПродажиПоНеделямПодЗаказ.ПродажиНеделяПодЗаказ 	КАК ПродажиНеделяПодЗаказ,
		|
		|	Продажи2ПоНеделям.Продажи2Недели 				КАК Продажи2Недели,
		|	Продажи2ПоНеделям.Продажи2НеделиПоАртикулам 	КАК Продажи2НеделиПоАртикулам,
		|	ПродажиПо2НеделямПодЗаказ.Продажи2НеделиПодЗаказ КАК Продажи2НеделиПодЗаказ,
		|
		|	ПродажиЗаМесяц.ПродажиМесяц 					КАК ПродажиМесяц,
		|	ПродажиЗаМесяц.ПродажиМесяцПоАртикулам 			КАК ПродажиМесяцПоАртикулам,
		|	ПродажиЗаМесяцПодЗаказ.ПродажиМесяцПодЗаказ 	КАК ПродажиМесяцПодЗаказ
		|
		|ИЗ
		|	КешДанныхДляВывода КАК КешДанныхДляВывода
		|  
		|ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрНакопления.ТоварыОрганизаций.ОстаткиИОбороты(&НачалоПериодаМесяц, &КонецПериода, , ,  
		|											(Номенклатура, Склад) В (	ВЫБРАТЬ 
		|																			Номенклатура, 
		|																			Склад 
		|																		ИЗ 
		|																			КешДанныхДляВывода)
		|																					) КАК ТоварыОрганизацийОбороты
		|ПО	КешДанныхДляВывода.Номенклатура	= ТоварыОрганизацийОбороты.Номенклатура
		|И 	КешДанныхДляВывода.Склад	 	= ТоварыОрганизацийОбороты.Склад
		|
		|ЛЕВОЕ СОЕДИНЕНИЕ АМ_УправлениеАссортиментнойМатрицей КАК УправлениеАссортиментнойМатрицей
		|ПО	УправлениеАссортиментнойМатрицей.Склад 			 = КешДанныхДляВывода.Склад
		|И 	УправлениеАссортиментнойМатрицей.ВидНоменклатуры = КешДанныхДляВывода.ВидНоменклатуры
		|И	УправлениеАссортиментнойМатрицей.ТоварнаяКатегория = КешДанныхДляВывода.ТоварнаяКатегория
		|
		|ЛЕВОЕ СОЕДИНЕНИЕ ПродажиПоНеделям КАК ПродажиПоНеделям
		|ПО ПродажиПоНеделям.Номенклатура 	= КешДанныхДляВывода.Номенклатура
		|И	ПродажиПоНеделям.Склад 			= КешДанныхДляВывода.Склад
		|
		|ЛЕВОЕ СОЕДИНЕНИЕ ПродажиПоНеделямПодЗаказ КАК ПродажиПоНеделямПодЗаказ
		|ПО ПродажиПоНеделямПодЗаказ.Номенклатура 	= КешДанныхДляВывода.Номенклатура
		|И	ПродажиПоНеделямПодЗаказ.Склад 			= КешДанныхДляВывода.Склад
		|
		|ЛЕВОЕ СОЕДИНЕНИЕ Продажи2ПоНеделям КАК Продажи2ПоНеделям
		|ПО Продажи2ПоНеделям.Номенклатура 	= КешДанныхДляВывода.Номенклатура
		|И	Продажи2ПоНеделям.Склад 		= КешДанныхДляВывода.Склад
		|
		|ЛЕВОЕ СОЕДИНЕНИЕ ПродажиПо2НеделямПодЗаказ КАК ПродажиПо2НеделямПодЗаказ
		|ПО ПродажиПо2НеделямПодЗаказ.Номенклатура 	= КешДанныхДляВывода.Номенклатура
		|И	ПродажиПо2НеделямПодЗаказ.Склад 		= КешДанныхДляВывода.Склад
		|
		|ЛЕВОЕ СОЕДИНЕНИЕ ПродажиЗаМесяц КАК ПродажиЗаМесяц
		|ПО ПродажиЗаМесяц.Номенклатура = КешДанныхДляВывода.Номенклатура
		|И	ПродажиЗаМесяц.Склад 		= КешДанныхДляВывода.Склад
		|
		|ЛЕВОЕ СОЕДИНЕНИЕ ПродажиЗаМесяцПодЗаказ КАК ПродажиЗаМесяцПодЗаказ
		|ПО ПродажиЗаМесяцПодЗаказ.Номенклатура = КешДанныхДляВывода.Номенклатура
		|И	ПродажиЗаМесяцПодЗаказ.Склад 		= КешДанныхДляВывода.Склад
		|
		|УПОРЯДОЧИТЬ ПО
		|	КешДанныхДляВывода.Номенклатура.Наименование Возр
		|;
		////////////////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ АМ_УправлениеАссортиментнойМатрицей;
		////////////////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ КешДанныхДляВывода;
		////////////////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ ПродажиПоНеделям;
		////////////////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ ПродажиПоНеделямПодЗаказ;
		////////////////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ Продажи2ПоНеделям;
		////////////////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ ПродажиПо2НеделямПодЗаказ;
		////////////////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ ПродажиЗаМесяц;
		////////////////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ ПродажиЗаМесяцПодЗаказ;
		////////////////////////////////////////////////////////////////////////////////////////////
		|";
	Возврат ТекстЗапроса;
	
КонецФункции // ПолучитьТекстЗапросаОбновитьДеревоДетальныеЗаписи()


&НаСервереБезКонтекста
Функция ПолучитьТекстЗапросаМагазиныПодУправлением()

	ТекстЗапроса = "
		|ВЫБРАТЬ РАЗРЕШЕННЫЕ
		|	Склады.Склад КАК Склад,
		|	МагазиныПодУправлением.ИспользуетсяУправление КАК ИспользуетсяУправление
		|ИЗ
		|	РегистрСведений.Модуль_ДоступныеСклады КАК Склады
		|
		|ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.АМ_МагазиныПодУправлением.СрезПоследних КАК МагазиныПодУправлением
		|ПО	МагазиныПодУправлением.Склад = Склады.Склад
		|
		|ГДЕ
		|	Основной = Истина
		|УПОРЯДОЧИТЬ ПО
		|	Склады.Склад.Наименование Возр	
		|";
	Возврат ТекстЗапроса;

КонецФункции // ПолучитьТекстЗапросаМагазиныПодУправлением()


#КонецОбласти



