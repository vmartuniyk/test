
#Область ПрограммныйИнтерфейс

Процедура ВыполнитьКоманду(ИдентификаторКоманды, ПараметрыКоманды) Экспорт
	
	Перем РезультатВыполнения, ОповещениеФорм, МассивДанных;
	
	ДатаСеанса = ТекущаяДатаСеанса();
	НачалоДня = НачалоДня(ДатаСеанса);
	
	УстановитьПривилегированныйРежим(Истина);
	
	Если ИдентификаторКоманды = "ПереместитьТоварыВМатрицу();" 
	 ИЛИ ИдентификаторКоманды = "ПереместитьТоварыИзМатрицы();" Тогда
		Выполнить(ИдентификаторКоманды);
		Возврат;
	КонецЕсли;
	
	Запрос = Новый Запрос;
	Запрос.МенеджерВременныхТаблиц = Новый МенеджерВременныхТаблиц;
	
	// Выполняем кеширование доступных складов матрице
	Запрос.Текст = ПолучитьТекстЗапросаДоступныхСкладов();
	Запрос.Выполнить();
		
	Запрос.УстановитьПараметр("Склад", 				ПараметрыКоманды.Склад);
	Запрос.УстановитьПараметр("ВидНоменклатуры", 	ПараметрыКоманды.ВидНоменклатуры);
	Запрос.УстановитьПараметр("ТоварнаяКатегория", 	ПараметрыКоманды.ТоварнаяКатегория);
	Запрос.УстановитьПараметр("Производитель", 		ПараметрыКоманды.Производитель);
	Запрос.УстановитьПараметр("Номенклатура", 		ПараметрыКоманды.Номенклатура);
	Запрос.УстановитьПараметр("КонецПериода", ДатаСеанса);
	Запрос.УстановитьПараметр("НачалоПериодаНеделя", 	ДатаСеанса -  7 * 86400);
	Запрос.УстановитьПараметр("НачалоПериода2Недели", 	ДатаСеанса - 14 * 86400);
	Запрос.УстановитьПараметр("НачалоПериодаМесяц",  	ДатаСеанса - 31 * 86400);
	Запрос.УстановитьПараметр("НачалоПериодаКвартал", 	ДатаСеанса - 91 * 86400);
	
	
	Если ИдентификаторКоманды = "ОбновитьПродажиПоФорматамВФоне" Тогда
		
		ТекстЗапроса = ПолучитьТекстЗапросаАналитическихДанных();
		ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "%1", "Склады.Ссылка КАК ФорматМагазина, 
													  | Склады.Ссылка КАК ДанныеДерева, ");
		Запрос.Текст = СтрЗаменить(ТекстЗапроса, "%2", "Склады.Ссылка");
		
	ИначеЕсли ИдентификаторКоманды = "ОбновитьПродажиПоМагазинамВФоне" Тогда
		
		ТекстЗапроса = ПолучитьТекстЗапросаАналитическихДанных();
		ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "%1", "Склады.Склад КАК Склад, 
													  | Склады.Склад КАК ДанныеДерева, ");
		Запрос.Текст = СтрЗаменить(ТекстЗапроса, "%2", "Склады.Склад");
				
	ИначеЕсли  ИдентификаторКоманды = "ОбновитьТоварыКПриездуВФоне" Тогда
		
		ТекстЗапроса = ПолучитьТекстЗапросаОбщегоЗаказа();
		ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "%1", "И ВидНоменклатуры = &ВидНоменклатуры");
		ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "%2", "И ВидыНоменклатуры.Ссылка = &ВидНоменклатуры");
		ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "%3", "Номенклатура.ВидНоменклатуры = &ВидНоменклатуры И");
		Запрос.Текст = ТекстЗапроса;
		
	ИначеЕсли ИдентификаторКоманды = "ОбновитьТоварыВРезервахВФоне" Тогда

		Запрос.Текст = ПолучитьТекстЗапросаАналитикаТоварыВРезервах();

	КонецЕсли;
	
	
	
	Если ПараметрыКоманды.Свойство("РезультатВыполнения", РезультатВыполнения) Тогда
		
		Если РезультатВыполнения.Свойство("ОповещениеФорм", ОповещениеФорм) Тогда

			ОповещениеФорм.ИмяСобытия = ИдентификаторКоманды;
			ОповещениеФорм.Использование = Истина;
			Если ПараметрыКоманды.Свойство("ДополнительнаяОбработкаСсылка") Тогда
				ОповещениеФорм.Свойство("Источник", ПараметрыКоманды.ДополнительнаяОбработкаСсылка);
			КонецЕсли;
			
			Если ИдентификаторКоманды = "ОбновитьТоварыКПриездуВФоне" Тогда
				Выгрузка = ПолучитьТаблицуЗначенийТоваровКПриезду(Запрос.ВыполнитьПакет(), ПараметрыКоманды.Склад);
			ИначеЕсли ИдентификаторКоманды = "ОбновитьТоварыКОтъездуВФоне" Тогда
				Выгрузка = ПолучитьТаблицуЗначенийТоваровКОтъезду(Запрос, ПараметрыКоманды.Склад, ПараметрыКоманды.ВидНоменклатуры);	
			Иначе
				Выгрузка = Запрос.Выполнить().Выгрузить();
			КонецЕсли;
					
			КлючиСтруктуры = "";
			Для Каждого Колонка Из Выгрузка.Колонки Цикл
				КлючиСтруктуры = КлючиСтруктуры + Колонка.Имя + ",";
			КонецЦикла;
			КлючиСтруктуры = Лев(КлючиСтруктуры, СтрДлина(КлючиСтруктуры) - 1);
			
			МассивДанных = Новый Массив;
			Для каждого СтрокаВыгрузки Из Выгрузка Цикл
				СтруктураЗаписи = Новый Структура(КлючиСтруктуры);
				ЗаполнитьЗначенияСвойств(СтруктураЗаписи, СтрокаВыгрузки);
				МассивДанных.Добавить(СтруктураЗаписи);
			КонецЦикла;
							
			ОповещениеФорм.Параметр = МассивДанных;
			
		КонецЕсли;
		
	КонецЕсли;
	
	Запрос.МенеджерВременныхТаблиц.Закрыть();
	
КонецПроцедуры // ВыполнитьКоманду()

Процедура ПереместитьТоварыВМатрицу()
	
	АвторизированныйПользователь = ПараметрыСеанса.ТекущийПользователь;
	
	Запрос = Новый Запрос;
	Запрос.МенеджерВременныхТаблиц = Новый МенеджерВременныхТаблиц;
	Запрос.Текст = ПолучитьТекстЗапросаДоступныхСкладовПоПоездкам();
	Запрос.УстановитьПараметр("ТекущееВремя", Дата(1, 1, 1) + (ТекущаяДатаСеанса() - НачалоДня(ТекущаяДатаСеанса())));
	Запрос.Выполнить();
	
	ТекстЗапроса = ПолучитьТекстЗапросаОбщегоЗаказа();
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "%1", "");
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "%2", "");
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "%3", "");
	Запрос.Текст = ТекстЗапроса;
	ТаблицаТоваров = ПолучитьТаблицуЗначенийТоваровКПриезду(Запрос.ВыполнитьПакет());
	ТаблицаТоваров.Индексы.Добавить("Склад");
	Запрос.МенеджерВременныхТаблиц.Закрыть();
	
	
	ТаблицаСкладов = ТаблицаТоваров.Скопировать(, "Склад");
	ТаблицаСкладов.Свернуть("Склад");
	Запрос = Новый Запрос;
	Запрос.Текст = ПолучитьТекстЗапросаШапкиДокументаПеремещения();
	Запрос.УстановитьПараметр("ТаблицаСкладов", ТаблицаСкладов);
	Запрос.УстановитьПараметр("Ответственный", АвторизированныйПользователь);
	РезультатЗапроса = Запрос.Выполнить();
	Если НЕ РезультатЗапроса.Пустой() Тогда
		
		ДатаСеанса = ТекущаяДатаСеанса();
		
		ДанныеШапки = РезультатЗапроса.Выбрать();
		Пока ДанныеШапки.Следующий() Цикл
			
			ПараметрыОбъекта = git_Templates.ПолучитьШаблонЗаказНаПеремещение();
			ЗаполнитьЗначенияСвойств(ПараметрыОбъекта, ДанныеШапки);
			ПараметрыОбъекта.Вставить("Комментарий", "Автоматическое перемещение под матрицу"); 
			
			РезультатыПоиска = ТаблицаТоваров.НайтиСтроки(Новый Структура("Склад", ДанныеШапки.СкладПолучатель));
			Если РезультатыПоиска.Количество() = 0 Тогда
				Продолжить;
			КонецЕсли;
			
			КодСтроки = 0;
			Для каждого РезультатПоиска Из РезультатыПоиска Цикл
				
				КодСтроки = КодСтроки + 1;
				НоваяСтрока = ПараметрыОбъекта.Товары.Добавить();
				НоваяСтрока.Номенклатура 		= РезультатПоиска.Номенклатура;
				НоваяСтрока.Количество 			= Мин(РезультатПоиска.КоличествоКПоставке, РезультатПоиска.ЕстьНаРаспределительныхСкладах);
				НоваяСтрока.КоличествоУпаковок 	= Мин(РезультатПоиска.КоличествоКПоставке, РезультатПоиска.ЕстьНаРаспределительныхСкладах);
				НоваяСтрока.ВариантОбеспечения 	= Перечисления.ВариантыОбеспечения.СоСклада;
				НоваяСтрока.НачалоОтгрузки 		= ДатаСеанса;
				НоваяСтрока.ОкончаниеПоступления = ДатаСеанса;
			
			КонецЦикла; 
			
			
			ПараметрыОбъекта.МаксимальныйКодСтроки = КодСтроки;
			Если КодСтроки = 0 Тогда
				Продолжить;	
			КонецЕсли;
			
			СтруктураОшибок = Новый Структура; 
			ЗаказНаПеремещение = git_Objcon.СоздатьДокумент("ЗаказНаПеремещение", ПараметрыОбъекта, СтруктураОшибок);
			Для каждого СтрокаТовара Из ЗаказНаПеремещение.Товары Цикл
				Если СтрокаТовара.ВариантОбеспечения = Перечисления.ВариантыОбеспечения.ПодЗаказ Тогда
					ЗаказНаПеремещение.Товары.Удалить(СтрокаТовара);		
				КонецЕсли;
			КонецЦикла;
			
			ИмяСобытияЖурналаРегистрации = НСтр("ru = 'Автоматический контроль товаров матрицей'");
			Если СтруктураОшибок.Количество() = 0 Тогда
				
				Если ЗаказНаПеремещение.Товары.Количество() = 0 Тогда
					Продолжить;	
				КонецЕсли;
				
				НачатьТранзакцию();
				
				Попытка
					
					ЗаказНаПеремещение.Записать(РежимЗаписиДокумента.Проведение);
					ПеремещениеТоваров = Документы.ПеремещениеТоваров.СоздатьДокумент();
					ПеремещениеТоваров.Заполнить(ЗаказНаПеремещение.Ссылка);
					ПеремещениеТоваров.Ответственный = АвторизированныйПользователь;
					ПеремещениеТоваров.Подразделение = Справочники.СтруктураПредприятия.ПолучитьСсылку(Новый УникальныйИдентификатор("2ae9d40c-85c1-11e3-a390-001e673c80fc"));;
					ПеремещениеТоваров.Комментарий = "Автоматическое перемещение под матрицу";
					ПеремещениеТоваров.Записать(РежимЗаписиДокумента.Проведение);
					
				Исключение
					
					ОтменитьТранзакцию();
					
					СтруктураОшибок.Вставить("ОшибкаДвиженийМатрицы", НСтр("ru = 'Не удалось доставить товар в матрицу!'") + ОписаниеОшибки());
					ВыполнитьОповещениеОбОшибках(ЗаказНаПеремещение, ИмяСобытияЖурналаРегистрации, СтруктураОшибок, Истина);	
					Продолжить;
					
				КонецПопытки;
				
				ЗафиксироватьТранзакцию();
				
			Иначе
				ВыполнитьОповещениеОбОшибках(ЗаказНаПеремещение, ИмяСобытияЖурналаРегистрации, СтруктураОшибок, Истина);
			КонецЕсли;
	
		КонецЦикла;
		
	КонецЕсли;
	
	// АвтоПеремещениеЗаказПодЗаказ
	// Пока не реализовано!
		
КонецПроцедуры // ПереместитьТоварыВМатрицу()

Процедура ПереместитьТоварыИзМатрицы()
		
	АвторизированныйПользователь = ПараметрыСеанса.ТекущийПользователь;
	
	Запрос = Новый Запрос;
	Запрос.МенеджерВременныхТаблиц = Новый МенеджерВременныхТаблиц;
	Запрос.Текст = ПолучитьТекстЗапросаДоступныхСкладов();
	Запрос.Выполнить();	
	
	ТаблицаТоваров = ПолучитьТаблицуЗначенийТоваровКОтъезду(Запрос);	
	ТаблицаТоваров.Индексы.Добавить("Склад");
	Запрос.МенеджерВременныхТаблиц.Закрыть();
	
	ТаблицаСкладов = ТаблицаТоваров.Скопировать(, "Склад");
	ТаблицаСкладов.Свернуть("Склад");
	Запрос = Новый Запрос;
	Запрос.Текст = ПолучитьТекстЗапросаШапкиДокументаПеремещения();
	Запрос.УстановитьПараметр("ТаблицаСкладов", ТаблицаСкладов);
	Запрос.УстановитьПараметр("Ответственный", АвторизированныйПользователь);
	РезультатЗапроса = Запрос.Выполнить();
	Если НЕ РезультатЗапроса.Пустой() Тогда
		
		ДатаСеанса = ТекущаяДатаСеанса();
		
		ДанныеШапки = РезультатЗапроса.Выбрать();
		Пока ДанныеШапки.Следующий() Цикл
			
			Если ДанныеШапки.АвтоПеремещениеСоСклада = Ложь Тогда
				Продолжить;
			КонецЕсли;
			
			ПараметрыОбъекта = git_Templates.ПолучитьШаблонЗаказНаПеремещение();
			ЗаполнитьЗначенияСвойств(ПараметрыОбъекта, ДанныеШапки);
			ПараметрыОбъекта.СкладОтправитель = ДанныеШапки.СкладПолучатель;
			ПараметрыОбъекта.СкладПолучатель = ДанныеШапки.СкладОтправитель;
			ПараметрыОбъекта.Вставить("Комментарий", "Автоматическое перемещение из матрицы"); 
			
			РезультатыПоиска = ТаблицаТоваров.НайтиСтроки(Новый Структура("Склад", ДанныеШапки.СкладПолучатель));
			Если РезультатыПоиска.Количество() = 0 Тогда
				Продолжить;
			КонецЕсли;
			
			КодСтроки = 0;
			Для каждого РезультатПоиска Из РезультатыПоиска Цикл
				// Затычка
				Если РезультатПоиска.Количество <= 0 Тогда
					Продолжить;
				КонецЕсли;
				
				КодСтроки = КодСтроки + 1;
				НоваяСтрока = ПараметрыОбъекта.Товары.Добавить();
				НоваяСтрока.Номенклатура 		= РезультатПоиска.Номенклатура;
				НоваяСтрока.Количество 			= РезультатПоиска.Количество;
				НоваяСтрока.КоличествоУпаковок 	= РезультатПоиска.Количество;
				НоваяСтрока.ВариантОбеспечения 	= Перечисления.ВариантыОбеспечения.СоСклада;
				НоваяСтрока.НачалоОтгрузки 		= ДатаСеанса;
				НоваяСтрока.ОкончаниеПоступления = ДатаСеанса;
			
			КонецЦикла; 
			
			ПараметрыОбъекта.МаксимальныйКодСтроки = КодСтроки;
			Если КодСтроки = 0 Тогда
				Продолжить;	
			КонецЕсли;
			
			СтруктураОшибок = Новый Структура;
			ЗаказНаПеремещение = git_Objcon.СоздатьДокумент("ЗаказНаПеремещение", ПараметрыОбъекта, СтруктураОшибок);
						
			ИмяСобытияЖурналаРегистрации = НСтр("ru = 'Автоматический перемещение товаров из матрицы'");
			Если СтруктураОшибок.Количество() = 0 Тогда
				
				Для каждого СтрокаТовара Из ЗаказНаПеремещение.Товары Цикл
					Если СтрокаТовара.ВариантОбеспечения = Перечисления.ВариантыОбеспечения.ПодЗаказ Тогда
						ЗаказНаПеремещение.Товары.Удалить(СтрокаТовара);		
					КонецЕсли;
				КонецЦикла;

				Если ЗаказНаПеремещение.Товары.Количество() = 0 Тогда
					Продолжить;	
				КонецЕсли;
				
				НачатьТранзакцию();
				
				Попытка
					
					ЗаказНаПеремещение.Записать(РежимЗаписиДокумента.Проведение);
					НавигационнаяСсылка = "e1c://server/gamlet/yt11#" + ПолучитьНавигационнуюСсылку(ЗаказНаПеремещение.Ссылка);
					ТекстПисьма = НСтр("ru = 'Товар из документа ""Заказ на перемещение"" должен быть собран и отправлен на склад в течении 24 часов.
									|Контроль за отправкой товара должен выполнять руководитель магазина.
									|Ссылка: %НавигационнаяСсылка%
									|
									|При возникновении спорных вопросов их нужно задавать продакт-менеджеру по товарной группе.'");
					ТекстПисьма = СтрЗаменить(ТекстПисьма, "%НавигационнаяСсылка%", НавигационнаяСсылка);
					
					ЭПИсходящее = Документы.ЭлектронноеПисьмоИсходящее.СоздатьДокумент();
					ЭПИсходящее.Дата 			= ТекущаяДатаСеанса();	
					ЭПИсходящее.Автор 			= АвторизированныйПользователь;
					ЭПИсходящее.Важность 		= Перечисления.ВариантыВажностиВзаимодействия.Высокая;
					ЭПИсходящее.СтатусПисьма	= Перечисления.СтатусыИсходящегоЭлектронногоПисьма.Исходящее;
					ЭПИсходящее.Ответственный 	= АвторизированныйПользователь;
					ЭПИсходящее.Тема 		= НСтр("ru = 'Автоматическое управление ассортиментом'");
					ЭПИсходящее.Комментарий = НСтр("ru = 'Автоматическое управление ассортиментом, автоматическое перемещение товаров из матрицы'"); 
					ЭПИсходящее.Текст 		= ТекстПисьма;
					ЭПИсходящее.ОтправительПредставление= НСтр("ru = 'Mr. Smith'"); 
					ЭПИсходящее.СписокПолучателейПисьма	= ДанныеШапки.АдресЭП;
					ЭПИсходящее.УчетнаяЗапись			= РаботаСПочтовымиСообщениями.ПолучитьСистемнуюУчетнуюЗапись();
					ЭПИсходящее.ТипТекста				= Перечисления.ТипыТекстовЭлектронныхПисем.ПростойТекст;
					ЭПИсходящее.УдалятьПослеОтправки	= Истина;
					
					НовыйПолучатель = ЭПИсходящее.ПолучателиПисьма.Добавить();
					НовыйПолучатель.Адрес = ДанныеШапки.АдресЭП;
					НовыйПолучатель.Представление = ДанныеШапки.АдресЭП;
					НовыйПолучатель.Контакт = АвторизированныйПользователь;
					
					ЭПИсходящее.Записать(РежимЗаписиДокумента.Запись);
					
				Исключение
					
					ОтменитьТранзакцию();
					
					СтруктураОшибок.Вставить("ОшибкаДвиженийМатрицы", НСтр("ru = 'Не удалось забрать товар из матрицы!'") + ОписаниеОшибки());
					ВыполнитьОповещениеОбОшибках(ЗаказНаПеремещение, ИмяСобытияЖурналаРегистрации, СтруктураОшибок, Истина);	
					Продолжить;
					
				КонецПопытки;
				
				ЗафиксироватьТранзакцию();
				
			Иначе
				ВыполнитьОповещениеОбОшибках(ЗаказНаПеремещение, ИмяСобытияЖурналаРегистрации, СтруктураОшибок, Истина);
			КонецЕсли;
	
		КонецЦикла;
		
	КонецЕсли; 
	
КонецПроцедуры // ПереместитьТоварыИзМатрицы()

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

Функция ПолучитьТаблицуЗначенийТоваровКПриезду(РезультатПакета, Selection = Неопределено)
	
	DataSource = ПолучитьОписаниеТаблицыЗначенийТоваровКПриезду();		
	
	ТаблицаМатрицы = РезультатПакета[55].Выгрузить();
	
	ТаблицаОстатков = РезультатПакета[56].Выгрузить();
	ТаблицаОстатков.Индексы.Добавить("СкладПополнения, Номенклатура");
	
	ТаблицаАктуальности = РезультатПакета[57].Выгрузить();
	ТаблицаАктуальности.Индексы.Добавить("Номенклатура");

	
	// Распределение по виду номенклатуры
	ТаблицаМатрицы.Индексы.Очистить();
	ТаблицаМатрицы.Индексы.Добавить("Склад, ВидНоменклатуры, ТоварнаяКатегория, ТКА_НМ");
	РаспределитьТоварыПоИерархииМатрицы(РезультатПакета[31].Выбрать(),
									РезультатПакета[32].Выгрузить(),
									ТаблицаМатрицы,
									ТаблицаОстатков,
									ТаблицаАктуальности,
									Новый Структура("Склад, ВидНоменклатуры"),
									Новый Структура("Склад, ВидНоменклатуры, ТоварнаяКатегория, ТКА_НМ", , , , 1),
									Новый Структура("СкладПополнения, Номенклатура"),
									DataSource,
									Selection);
									
									
	// Распеределение по товарным категориям
	ТаблицаМатрицы.Индексы.Очистить();
	ТаблицаМатрицы.Индексы.Добавить("Склад, ВидНоменклатуры, ТоварнаяКатегория, Производитель, ТКА_НМ");
	РаспределитьТоварыПоИерархииМатрицы(РезультатПакета[40].Выбрать(),
									РезультатПакета[41].Выгрузить(),
									ТаблицаМатрицы,
									ТаблицаОстатков,
									ТаблицаАктуальности,
									Новый Структура("Склад, ВидНоменклатуры, ТоварнаяКатегория"),
									Новый Структура("Склад, ВидНоменклатуры, ТоварнаяКатегория, Производитель, ТКА_НМ", , , , , 1),
									Новый Структура("СкладПополнения, Номенклатура"),
									DataSource,
									Selection);
									
									
	// Распеределение по товарным категориям
	ТаблицаМатрицы.Индексы.Очистить();
	ТаблицаМатрицы.Индексы.Добавить("Склад, ВидНоменклатуры, ТоварнаяКатегория, Производитель, Номенклатура, ТКА_НМ");
	РаспределитьТоварыПоИерархииМатрицы(РезультатПакета[49].Выбрать(),
									РезультатПакета[50].Выгрузить(),
									ТаблицаМатрицы,
									ТаблицаОстатков,
									ТаблицаАктуальности,
									Новый Структура("Склад, ВидНоменклатуры, ТоварнаяКатегория, Производитель"),
									Новый Структура("Склад, ВидНоменклатуры, ТоварнаяКатегория, Производитель, Номенклатура, ТКА_НМ", , , , , , 1),
									Новый Структура("СкладПополнения, Номенклатура"),
									DataSource,
									Selection);
									
									
	// Распеределение по номенклатуре
	РаспределитьТоварыПоИерархииМатрицы(РезультатПакета[54].Выбрать(),
									РезультатПакета[54].Выгрузить(),
									ТаблицаМатрицы,
									ТаблицаОстатков,
									ТаблицаАктуальности,
									Новый Структура("Склад, ВидНоменклатуры, ТоварнаяКатегория, Производитель, Номенклатура"),
									Новый Структура("Склад, ВидНоменклатуры, ТоварнаяКатегория, Производитель, Номенклатура, ТКА_НМ", , , , , , 1),
									Новый Структура("СкладПополнения, Номенклатура"),
									DataSource,
									Selection);

	Возврат DataSource;	
	
КонецФункции // ПолучитьТаблицуЗначенийТоваровКПриезду()

Функция ПолучитьОписаниеТаблицыЗначенийТоваровКПриезду()
	
	КвалификаторЧисла = Новый КвалификаторыЧисла(15, 3, ДопустимыйЗнак.Неотрицательный);
	
	ТаблицаЗначений = Новый ТаблицаЗначений;
	ТаблицаЗначений.Колонки.Добавить("Склад", 			Новый ОписаниеТипов("СправочникСсылка.Склады"));
	ТаблицаЗначений.Колонки.Добавить("ВидНоменклатуры", Новый ОписаниеТипов("СправочникСсылка.ВидыНоменклатуры"));
	ТаблицаЗначений.Колонки.Добавить("ТоварнаяКатегория", 	Новый ОписаниеТипов("СправочникСсылка.ТоварныеКатегории"));
	ТаблицаЗначений.Колонки.Добавить("Производитель", 	Новый ОписаниеТипов("СправочникСсылка.Производители"));
	ТаблицаЗначений.Колонки.Добавить("Номенклатура", 	Новый ОписаниеТипов("СправочникСсылка.Номенклатура"));
	ТаблицаЗначений.Колонки.Добавить("МинимальныйЗапас",	Новый ОписаниеТипов("Число", КвалификаторЧисла));
	ТаблицаЗначений.Колонки.Добавить("МаксимальныйЗапас",	Новый ОписаниеТипов("Число", КвалификаторЧисла));
	ТаблицаЗначений.Колонки.Добавить("ТекущийЗапас", 		Новый ОписаниеТипов("Число", КвалификаторЧисла));
	ТаблицаЗначений.Колонки.Добавить("КоличествоКПоставке", Новый ОписаниеТипов("Число", КвалификаторЧисла));
	ТаблицаЗначений.Колонки.Добавить("ЕстьНаРаспределительныхСкладах", 	Новый ОписаниеТипов("Число", КвалификаторЧисла));
	ТаблицаЗначений.Колонки.Добавить("ЕстьВозможностьЗаказа", Новый ОписаниеТипов("Дата"));
	ТаблицаЗначений.Колонки.Добавить("ДанныеДерева", Новый ОписаниеТипов("Строка"));
	ТаблицаЗначений.Колонки.Добавить("СкладПополнения", Новый ОписаниеТипов("СправочникСсылка.Склады"));
	
	Возврат ТаблицаЗначений;
	
КонецФункции // ПолучитьОписаниеТаблицыЗначенийТоваровКПриезду()

Процедура РаспределитьТоварыПоИерархииМатрицы(ВыборкаИерархия, ТаблицаПоиска, ТаблицаМатрицы, ТаблицаОстатков, ТаблицаАктуальности, ОтборПоИерархии, ОтборПоМатрице, ОтборПоОстаткам, DataSource, Selection)
	
	Пока ВыборкаИерархия.Следующий() Цикл
		
		НеРаспределено = ВыборкаИерархия.НеРаспределено;
		КоличествоМест = ВыборкаИерархия.КоличествоМест;
		
		ЗаполнитьЗначенияСвойств(ОтборПоИерархии, ВыборкаИерархия);		
		РезультатыПоиска = ТаблицаПоиска.НайтиСтроки(ОтборПоИерархии);
		
		РаспределитьОстаткиПоМатрице(РезультатыПоиска,
								ТаблицаМатрицы,
								ТаблицаОстатков,
								ОтборПоМатрице,
								ОтборПоОстаткам,
								DataSource,
								Selection,
								НеРаспределено,
								КоличествоМест);
								
		Если Selection <> Неопределено Тогда
									
			РаспределитьАктуальностьПоМатрице(РезультатыПоиска,
									ТаблицаМатрицы,
									ТаблицаАктуальности,
									ОтборПоМатрице,
									DataSource,
									Selection,
									НеРаспределено);
									
			Если НеРаспределено > 0 И ОтборПоИерархии.Свойство("Склад") И ВыборкаИерархия.Склад = Selection Тогда
				
				ТекстСообщения = НСтр("ru = '%1% позиций не распределено. Нет возможности заказа по параметрам : %2% %3% %4% %5% %6%'");
				ТекстСообщения = СтрЗаменить(ТекстСообщения, "%1%", Строка(НеРаспределено));
				
				Если ОтборПоИерархии.Свойство("Склад") Тогда
					ТекстСообщения = СтрЗаменить(ТекстСообщения, "%2%", "[" + Строка(ВыборкаИерархия.Склад) + "]");
				Иначе
					ТекстСообщения = СтрЗаменить(ТекстСообщения, "%2%", "");	
				КонецЕсли;
				
				Если ОтборПоИерархии.Свойство("ВидНоменклатуры") Тогда
					ТекстСообщения = СтрЗаменить(ТекстСообщения, "%3%", "[" + Строка(ВыборкаИерархия.ВидНоменклатуры) + "]");
				Иначе
					ТекстСообщения = СтрЗаменить(ТекстСообщения, "%3%", "");
				КонецЕсли;
				
				Если ОтборПоИерархии.Свойство("ТоварнаяКатегория") Тогда
					ТекстСообщения = СтрЗаменить(ТекстСообщения, "%4%", "[" + Строка(ВыборкаИерархия.ТоварнаяКатегория) + "]");
				Иначе
					ТекстСообщения = СтрЗаменить(ТекстСообщения, "%4%", "");
				КонецЕсли;
				
				Если ОтборПоИерархии.Свойство("Производитель") Тогда
					ТекстСообщения = СтрЗаменить(ТекстСообщения, "%5%", "[" + Строка(ВыборкаИерархия.Производитель) + "]");
				Иначе
					ТекстСообщения = СтрЗаменить(ТекстСообщения, "%5%", "");
				КонецЕсли;
				
				Если ОтборПоИерархии.Свойство("Номенклатура") Тогда
					ТекстСообщения = СтрЗаменить(ТекстСообщения, "%6%", "[" + Строка(ВыборкаИерархия.Номенклатура) + "]");
				Иначе
					ТекстСообщения = СтрЗаменить(ТекстСообщения, "%6%", "");
				КонецЕсли;
				
				НоваяСтрока = DataSource.Добавить();
				ЗаполнитьЗначенияСвойств(НоваяСтрока, ВыборкаИерархия);
				НоваяСтрока.ДанныеДерева = ТекстСообщения
				
			КонецЕсли;
			
		КонецЕсли;
									
	КонецЦикла;
	
КонецПроцедуры // РаспределитьТоварыПоИерархииМатрицы()

Процедура РаспределитьОстаткиПоМатрице(МассивЭлементов, МатрицаНоменклатуры, ОстаткиТоваров, ПараметрыОтбораПоМатрице, ПараметрыОтбораОстатков, DataSource, Selection, НеРаспределено, КоличествоМест)

	// Обработка элементов в наличии
	ПараметрыОтбораПоМатрице.ТКА_НМ = 1;
	Для каждого Элемент Из МассивЭлементов Цикл
		
		ЗаполнитьЗначенияСвойств(ПараметрыОтбораПоМатрице, Элемент);
		РезультатыОтбораПоМатрице = МатрицаНоменклатуры.НайтиСтроки(ПараметрыОтбораПоМатрице);
		Для каждого ЭлементМатрицы Из РезультатыОтбораПоМатрице Цикл
			
			Если КоличествоМест = 0 Тогда
				Прервать;	
			КонецЕсли;
			
			Если ЭлементМатрицы.МаксимальныйЗапас = 0 Тогда
				Продолжить;
			КонецЕсли;
			
			ЗаполнитьЗначенияСвойств(ПараметрыОтбораОстатков, ЭлементМатрицы, "СкладПополнения, Номенклатура");
			ДоступныеОстатки = ОстаткиТоваров.НайтиСтроки(ПараметрыОтбораОстатков);	
			Если ДоступныеОстатки.Количество() Тогда
				УменьшитьКоличествоДоступногоТовара(ОстаткиТоваров, ДоступныеОстатки[0], DataSource, Selection, ЭлементМатрицы, КоличествоМест);
			Иначе
				Если ЭлементМатрицы.МинимальныйЗапас >= ЭлементМатрицы.КоличествоОстаток
				 И	 ЭлементМатрицы.МаксимальныйЗапас > ЭлементМатрицы.КоличествоОстаток Тогда
					Если Selection = ЭлементМатрицы.Склад Тогда
						ДобавитьНоменклатуруВDataSource(DataSource, ЭлементМатрицы, 0, НСтр("ru = 'Недостаток по min\max'"));
					КонецЕсли;
				КонецЕсли;
				УменьшитьКоличествоНеРаспределенногоТовара(КоличествоМест);	
			КонецЕсли;
			
		КонецЦикла;
		
	КонецЦикла;
	
	Если НеРаспределено <= 0 Тогда
		Возврат;		
	КонецЕсли;
	
	// Обработка элементов не достающих
	ПараметрыОтбораПоМатрице.ТКА_НМ = 0;
	Для каждого Элемент Из МассивЭлементов Цикл
			
		ЗаполнитьЗначенияСвойств(ПараметрыОтбораПоМатрице, Элемент);
		РезультатыОтбораПоМатрице = МатрицаНоменклатуры.НайтиСтроки(ПараметрыОтбораПоМатрице);
		Для каждого ЭлементМатрицы Из РезультатыОтбораПоМатрице Цикл
			
			Если НеРаспределено = 0 Тогда
				Прервать;	
			КонецЕсли;
			
			Если ЭлементМатрицы.МаксимальныйЗапас = 0 Тогда
				Продолжить;
			КонецЕсли;
			
			ЗаполнитьЗначенияСвойств(ПараметрыОтбораОстатков, ЭлементМатрицы, "СкладПополнения, Номенклатура");
			ДоступныеОстатки = ОстаткиТоваров.НайтиСтроки(ПараметрыОтбораОстатков);
			Если ДоступныеОстатки.Количество() Тогда
				УменьшитьКоличествоДоступногоТовара(ОстаткиТоваров, ДоступныеОстатки[0], DataSource, Selection, ЭлементМатрицы, НеРаспределено);
			КонецЕсли;
			
		КонецЦикла; 
			
	КонецЦикла;
		
КонецПроцедуры // РаспределитьОстаткиПоМатрице()

Процедура РаспределитьАктуальностьПоМатрице(МассивЭлементов, МатрицаНоменклатуры, АктуальныеТовары, ПараметрыОтбораПоМатрице, DataSource, Selection, НеРаспределено)

	Если НеРаспределено <= 0 Тогда
		Возврат;		
	КонецЕсли;

	ПараметрыПоискаПоДереву = Новый Структура("Склад, Номенклатура");	
	ПараметрыОтбораПоМатрице.ТКА_НМ = 0;
	Для каждого Элемент Из МассивЭлементов Цикл
			
		ЗаполнитьЗначенияСвойств(ПараметрыОтбораПоМатрице, Элемент);
		РезультатыОтбораПоМатрице = МатрицаНоменклатуры.НайтиСтроки(ПараметрыОтбораПоМатрице);
		Для каждого ЭлементМатрицы Из РезультатыОтбораПоМатрице Цикл
			
			Если НеРаспределено = 0 Тогда
				Прервать;	
			КонецЕсли;
			
			Если ЭлементМатрицы.МаксимальныйЗапас = 0 Тогда
				Продолжить;
			КонецЕсли;
			
			РезультатПоискаАТ = АктуальныеТовары.НайтиСтроки(Новый Структура("Номенклатура", ЭлементМатрицы.Номенклатура));
			Если РезультатПоискаАТ.Количество() Тогда
				
				ЗаполнитьЗначенияСвойств(ПараметрыПоискаПоДереву, ЭлементМатрицы);
				РезультатПоиска = DataSource.НайтиСтроки(ПараметрыПоискаПоДереву);	
				Если РезультатПоиска.Количество() Тогда
					Продолжить;
				КонецЕсли;
				
				Если Selection = ЭлементМатрицы.Склад Тогда
					ДобавитьНоменклатуруВDataSource(DataSource, ЭлементМатрицы, 0, НСтр("ru = 'Недостаток артикулов'"));
				КонецЕсли;
				УменьшитьКоличествоНеРаспределенногоТовара(НеРаспределено);
					
			КонецЕсли;
		
		КонецЦикла; 
			
	КонецЦикла;
	
КонецПроцедуры // РаспределитьАктуальностьПоМатрице()
 
Процедура УменьшитьКоличествоДоступногоТовара(ОстаткиТоваров, СтрокаОстаток, DataSource, Selection, ЭлементМатрицы, НеОбработано)
	
	КоличествоОстаток = СтрокаОстаток.КоличествоОстаток;
	КоличествоКПриезду = Макс(ЭлементМатрицы.МаксимальныйЗапас - ЭлементМатрицы.КоличествоОстаток, 0);
	Если КоличествоКПриезду = 0 Тогда
		Возврат;
	КонецЕсли;
	
	ДополнительноеСообщение = НСтр("ru = 'Готово для перемещения'");
	Если СтрокаОстаток.КоличествоОстаток > КоличествоКПриезду Тогда
		// Уменьшаем остаток товаров, так как эти остатки уедут на потребность матрицы
		СтрокаОстаток.КоличествоОстаток = СтрокаОстаток.КоличествоОстаток - КоличествоКПриезду;
		УменьшитьКоличествоНеРаспределенногоТовара(НеОбработано);		
	ИначеЕсли СтрокаОстаток.КоличествоОстаток = КоличествоКПриезду Тогда
		// Удаляем остаток товаров, так как эти остатки уедут на потребность матрицы
		ОстаткиТоваров.Удалить(СтрокаОстаток);
		УменьшитьКоличествоНеРаспределенногоТовара(НеОбработано);	
	Иначе
		// Удаляем остаток товаров, так как эти остатки уедут на потребность матрицы
		ОстаткиТоваров.Удалить(СтрокаОстаток);
		УменьшитьКоличествоНеРаспределенногоТовара(НеОбработано);
		ДополнительноеСообщение = НСтр("ru = 'Недостаток по min\max'");	
	КонецЕсли;
	
	Если Selection = ЭлементМатрицы.Склад ИЛИ Selection = Неопределено Тогда
		ДобавитьНоменклатуруВDataSource(DataSource, ЭлементМатрицы, КоличествоОстаток, ДополнительноеСообщение);
	КонецЕсли;
	
КонецПроцедуры // УменьшитьКоличествоДоступногоТовара() 

Процедура УменьшитьКоличествоНеРаспределенногоТовара(НеРаспределено)
	НеРаспределено = НеРаспределено - 1;	
КонецПроцедуры // УменьшитьКоличествоНеРаспределенногоТовара()

Процедура ДобавитьНоменклатуруВDataSource(DataSource, ЭлементМатрицы, Знач ДоступныйОстаток, ДополнительноеСообщение)
	
	СтрокаDataSource = DataSource.Добавить();
	СтрокаDataSource.ДанныеДерева = ДополнительноеСообщение;
	ЗаполнитьЗначенияСвойств(СтрокаDataSource, ЭлементМатрицы);
	СтрокаDataSource.ТекущийЗапас 					= ЭлементМатрицы.КоличествоОстаток;
	СтрокаDataSource.КоличествоКПоставке 			= Окр(Макс(ЭлементМатрицы.МаксимальныйЗапас - ЭлементМатрицы.КоличествоОстаток, 0) + 0.499, 0, РежимОкругления.Окр15как20);
	СтрокаDataSource.ЕстьНаРаспределительныхСкладах = ДоступныйОстаток;		
		
КонецПроцедуры // ДобавитьНоменклатуруВDataSource()



Функция ПолучитьТаблицуЗначенийТоваровКОтъезду(Запрос, Склад = Неопределено, ВидНоменклатуры = Неопределено)
	
	ТекстЗапроса = ПолучитьТекстЗапросаАналитикаТоварыКОтъезду();
	Если Склад <> Неопределено И ВидНоменклатуры <> Неопределено Тогда
		ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "%1", "Номенклатура.ВидНоменклатуры = &ВидНоменклатуры И Склад = &Склад");
		ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "%2", "Склад = &Склад И ВидНоменклатуры = &ВидНоменклатуры");
	Иначе
		ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "%1", "");
		ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "%2", "");	
	КонецЕсли;
	Запрос.Текст = ТекстЗапроса;
	ТаблицаТоваровКОтъезду = Запрос.Выполнить().Выгрузить();
	
	DataSource = ПолучитьОписаниеТаблицыЗначенийТоваровКПриезду();		
	
	
	ТекстЗапроса = ПолучитьТекстЗапросаОбщегоЗаказа();
	Если Склад <> Неопределено И ВидНоменклатуры <> Неопределено Тогда
		ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "%1", "И ВидНоменклатуры = &ВидНоменклатуры");
		ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "%2", "И ВидыНоменклатуры.Ссылка = &ВидНоменклатуры");
		ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "%3", "Номенклатура.ВидНоменклатуры = &ВидНоменклатуры И");
	Иначе
		ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "%1", "");
		ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "%2", "");
		ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "%3", "");	
	КонецЕсли;
	Запрос.Текст = ТекстЗапроса;
 	РезультатПакета = Запрос.ВыполнитьПакет();

	ТаблицаМатрицы = РезультатПакета[55].Выгрузить();
		
	// Распределение по виду номенклатуры
	ТаблицаМатрицы.Индексы.Очистить();
	ТаблицаМатрицы.Индексы.Добавить("Склад, ВидНоменклатуры, ТоварнаяКатегория, ТКА_НМ");
	ТоварыКОтъездуПоИерархииМатрицы(РезультатПакета[31].Выбрать(),
									РезультатПакета[32].Выгрузить(),
									ТаблицаМатрицы,
									Новый Структура("Склад, ВидНоменклатуры"),
									Новый Структура("Склад, ВидНоменклатуры, ТоварнаяКатегория, ТКА_НМ", , , , 1),
									DataSource,
									Склад);
									
									
	// Распеределение по товарным категориям
	ТаблицаМатрицы.Индексы.Очистить();
	ТаблицаМатрицы.Индексы.Добавить("Склад, ВидНоменклатуры, ТоварнаяКатегория, Производитель, ТКА_НМ");
	ТоварыКОтъездуПоИерархииМатрицы(РезультатПакета[40].Выбрать(),
									РезультатПакета[41].Выгрузить(),
									ТаблицаМатрицы,
									Новый Структура("Склад, ВидНоменклатуры, ТоварнаяКатегория"),
									Новый Структура("Склад, ВидНоменклатуры, ТоварнаяКатегория, Производитель, ТКА_НМ", , , , , 1),
									DataSource,
									Склад);
																	
	// Распеределение по товарным категориям
	ТаблицаМатрицы.Индексы.Очистить();
	ТаблицаМатрицы.Индексы.Добавить("Склад, ВидНоменклатуры, ТоварнаяКатегория, Производитель, Номенклатура, ТКА_НМ");
	ТоварыКОтъездуПоИерархииМатрицы(РезультатПакета[49].Выбрать(),
									РезультатПакета[50].Выгрузить(),
									ТаблицаМатрицы,
									Новый Структура("Склад, ВидНоменклатуры, ТоварнаяКатегория, Производитель"),
									Новый Структура("Склад, ВидНоменклатуры, ТоварнаяКатегория, Производитель, Номенклатура, ТКА_НМ", , , , , , 1),
									DataSource,
									Склад);
																	
	// Распеределение по номенклатуре
	ТоварыКОтъездуПоИерархииМатрицы(РезультатПакета[54].Выбрать(),
									РезультатПакета[54].Выгрузить(),
									ТаблицаМатрицы,
									Новый Структура("Склад, ВидНоменклатуры, ТоварнаяКатегория, Производитель, Номенклатура"),
									Новый Структура("Склад, ВидНоменклатуры, ТоварнаяКатегория, Производитель, Номенклатура, ТКА_НМ", , , , , , 1),
									DataSource,
									Склад);
									
	Для Каждого СтрокаДанных Из DataSource Цикл
		НоваяСтрока = ТаблицаТоваровКОтъезду.Добавить();
		ЗаполнитьЗначенияСвойств(НоваяСтрока, СтрокаДанных);
		НоваяСтрока.Количество 		= СтрокаДанных.ТекущийЗапас;
		НоваяСтрока.ПричинаОтъезда 	= СтрокаДанных.ДанныеДерева;
	КонецЦикла;
																		
	Возврат ТаблицаТоваровКОтъезду;
	
КонецФункции // ПолучитьТаблицуЗначенийТоваровКОтъезду()

Процедура ТоварыКОтъездуПоИерархииМатрицы(ВыборкаИерархия, ТаблицаПоиска, ТаблицаМатрицы, ОтборПоИерархии, ОтборПоМатрице, DataSource, Selection)
	
	Пока ВыборкаИерархия.Следующий() Цикл
		
		КоличествоМест = ВыборкаИерархия.КоличествоМест;
		
		ЗаполнитьЗначенияСвойств(ОтборПоИерархии, ВыборкаИерархия);		
		РезультатыПоиска = ТаблицаПоиска.НайтиСтроки(ОтборПоИерархии);
		
		СобратьОстаткиПоМатрице(РезультатыПоиска,
								ТаблицаМатрицы,
								ОтборПоМатрице,
								DataSource,
								Selection,
								КоличествоМест);
								
	КонецЦикла;
	
КонецПроцедуры // ТоварыКОтъездуПоИерархииМатрицы()

Процедура СобратьОстаткиПоМатрице(МассивЭлементов, ТаблицаМатрицы, ОтборПоМатрице, DataSource, Selection, КоличествоМест)
	
	// Обработка элементов в наличии
	Для каждого Элемент Из МассивЭлементов Цикл
		
		ЗаполнитьЗначенияСвойств(ОтборПоМатрице, Элемент);
		РезультатыОтбораПоМатрице = ТаблицаМатрицы.НайтиСтроки(ОтборПоМатрице);
		Для каждого ЭлементМатрицы Из РезультатыОтбораПоМатрице Цикл
			
			УменьшитьКоличествоНеРаспределенногоТовара(КоличествоМест);
			
			Если КоличествоМест < 0 Тогда
				Если Selection = ЭлементМатрицы.Склад ИЛИ Selection = Неопределено Тогда
					ДобавитьНоменклатуруВDataSource(DataSource, ЭлементМатрицы, 0, НСтр("ru = 'Артикулов больше чем задано в матрице'"));
				КонецЕсли;
			КонецЕсли;
			
		КонецЦикла;
		
	КонецЦикла;	
	
КонецПроцедуры // СобратьОстаткиПоМатрице()







Процедура ВыполнитьОповещениеОбОшибках(Объект, ИмяСобытия, СтруктураОшибок, Оповестить)
	
	Попытка
		Если Объект.Проведен = Истина Тогда
			Объект.Записать(РежимЗаписиДокумента.ОтменаПроведения);
		Иначе
			Объект.Записать(РежимЗаписиДокумента.Запись);	
		КонецЕсли;
		СтруктураОшибок.Вставить("Не нужно выписывать товар, ссылка только для отладки", " : e1c://server/gamlet/yt11#" + ПолучитьНавигационнуюСсылку(Объект.Ссылка));
	Исключение
	КонецПопытки;
	git_Objcon.ЗафиксироватьОшибкиВЖР(ИмяСобытия, СтруктураОшибок, Оповестить);
	
КонецПроцедуры // ВыполнитьОповещениеОбОшибках()



Функция ПолучитьТекстЗапросаАналитическихДанных()

	ТекстЗапроса = "
		////////////////////////////////////////////////////////////////////////////////////////////
		// 0.
		|ВЫБРАТЬ
		|	АналитикаУчетаНоменклатуры.Ссылка КАК АналитикаУчетаНоменклатуры,
		|	АналитикаУчетаНоменклатуры.Номенклатура КАК Номенклатура,
		|	АналитикаУчетаНоменклатуры.Характеристика КАК Характеристика,
		|	АналитикаУчетаНоменклатуры.Склад КАК Склад
		|ПОМЕСТИТЬ КешАналитикаУчетаНоменклатуры
		|ИЗ
		|	Справочник.КлючиАналитикиУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры
		|ГДЕ
		|	АналитикаУчетаНоменклатуры.Номенклатура.ВидНоменклатуры = &ВидНоменклатуры
		|И	ВЫБОР
		|		КОГДА &ТоварнаяКатегория = ЗНАЧЕНИЕ(Справочник.ТоварныеКатегории.ПустаяСсылка)
		|			ТОГДА Истина
		|		ИНАЧЕ АналитикаУчетаНоменклатуры.Номенклатура.ТоварнаяКатегория = &ТоварнаяКатегория
		|	КОНЕЦ
		|И	ВЫБОР
		|		КОГДА &Производитель = ЗНАЧЕНИЕ(Справочник.Производители.ПустаяСсылка)
		|			ТОГДА Истина
		|		ИНАЧЕ АналитикаУчетаНоменклатуры.Номенклатура.Производитель = &Производитель
		|	КОНЕЦ
		|И	ВЫБОР
		|		КОГДА &Номенклатура = ЗНАЧЕНИЕ(Справочник.Номенклатура.ПустаяСсылка)
		|			ТОГДА Истина
		|		ИНАЧЕ АналитикаУчетаНоменклатуры.Номенклатура = &Номенклатура
		|	КОНЕЦ			
		|
		|ИНДЕКСИРОВАТЬ ПО
		|	АналитикаУчетаНоменклатуры	
		|;
		////////////////////////////////////////////////////////////////////////////////////////////
		// 1. Продажи по неделям
		|ВЫБРАТЬ РАЗРЕШЕННЫЕ
		|	АналитикаУчетаНоменклатуры.Склад 						КАК Склад,
		|	СУММА(КоличествоОборот) 								КАК ПродажиНеделя,
		|	КОЛИЧЕСТВО(АналитикаУчетаНоменклатуры.Номенклатура) 	КАК ПродажиНеделяПоАртикулам
		|ПОМЕСТИТЬ ПродажиПоНеделям
		|ИЗ
		|	РегистрНакопления.ВыручкаИСебестоимостьПродаж.Обороты(&НачалоПериодаНеделя, &КонецПериода, , АналитикаУчетаНоменклатуры В (ВЫБРАТЬ АналитикаУчетаНоменклатуры ИЗ КешАналитикаУчетаНоменклатуры)
		|														И  АналитикаУчетаПоПартнерам.Партнер <> ЗНАЧЕНИЕ(Справочник.Партнеры.НашеПредприятие))
		|
		|СГРУППИРОВАТЬ ПО
		|	АналитикаУчетаНоменклатуры.Склад
		|
		|ИНДЕКСИРОВАТЬ ПО
		|	Склад
		|;
		////////////////////////////////////////////////////////////////////////////////////////////
		// 2. Продажи по неделям "Под заказ"
		|ВЫБРАТЬ РАЗРЕШЕННЫЕ
		|	Склад							КАК Склад,
		|	Сумма(НаличиеПодЗаказРасход)   	КАК ПродажиНеделяПодЗаказ
		|ПОМЕСТИТЬ ПродажиПоНеделямПодЗаказ
		|ИЗ
		|	РегистрНакопления.ОбеспечениеЗаказов.Обороты(&НачалоПериодаНеделя, 
		|												&КонецПериода, 
		|												Регистратор, 
		|												(Номенклатура, Характеристика, Склад) В (ВЫБРАТЬ 
		|																							Номенклатура, 
		|																							Характеристика, 
		|																							Склад 
		|																						ИЗ 
		|																							КешАналитикаУчетаНоменклатуры))
		|ГДЕ
		|	Регистратор Ссылка Документ.РеализацияТоваровУслуг
		|
		|СГРУППИРОВАТЬ ПО
		| 	Склад
		|
		|ИНДЕКСИРОВАТЬ ПО
		| 	Склад
		|;
		////////////////////////////////////////////////////////////////////////////////////////////
		// 3. Продажи по 2-х неделям
		|ВЫБРАТЬ РАЗРЕШЕННЫЕ
		|	АналитикаУчетаНоменклатуры.Склад 						КАК Склад,
		|	СУММА(КоличествоОборот) 								КАК Продажи2Недели,
		|	КОЛИЧЕСТВО(АналитикаУчетаНоменклатуры.Номенклатура) 	КАК Продажи2НеделиПоАртикулам
		|ПОМЕСТИТЬ Продажи2ПоНеделям
		|ИЗ
		|	РегистрНакопления.ВыручкаИСебестоимостьПродаж.Обороты(&НачалоПериода2Недели, &КонецПериода, , АналитикаУчетаНоменклатуры В (ВЫБРАТЬ АналитикаУчетаНоменклатуры ИЗ КешАналитикаУчетаНоменклатуры)
		|														И  АналитикаУчетаПоПартнерам.Партнер <> ЗНАЧЕНИЕ(Справочник.Партнеры.НашеПредприятие))
		|
		|СГРУППИРОВАТЬ ПО
		|	АналитикаУчетаНоменклатуры.Склад
		|
		|ИНДЕКСИРОВАТЬ ПО
		|	Склад
		|;
		////////////////////////////////////////////////////////////////////////////////////////////
		// 4. Продажи по 2-х неделям "Под заказ"
		|ВЫБРАТЬ РАЗРЕШЕННЫЕ
		|	Склад							КАК Склад,
		|	Сумма(НаличиеПодЗаказРасход)   	КАК Продажи2НеделиПодЗаказ
		|ПОМЕСТИТЬ ПродажиПо2НеделямПодЗаказ
		|ИЗ
		|	РегистрНакопления.ОбеспечениеЗаказов.Обороты(&НачалоПериода2Недели, 
		|												&КонецПериода, 
		|												Регистратор, 
		|												(Номенклатура, Характеристика, Склад) В (ВЫБРАТЬ 
		|																							Номенклатура, 
		|																							Характеристика, 
		|																							Склад 
		|																						ИЗ 
		|																							КешАналитикаУчетаНоменклатуры))
		|ГДЕ
		|	Регистратор Ссылка Документ.РеализацияТоваровУслуг
		|
		|СГРУППИРОВАТЬ ПО
		| 	Склад
		|
		|ИНДЕКСИРОВАТЬ ПО
		| 	Склад
		|;
		////////////////////////////////////////////////////////////////////////////////////////////
		// 5. Продажи за месяц
		|ВЫБРАТЬ РАЗРЕШЕННЫЕ
		|	АналитикаУчетаНоменклатуры.Склад 						КАК Склад,
		|	СУММА(КоличествоОборот) 							КАК ПродажиМесяц,
		|	КОЛИЧЕСТВО(АналитикаУчетаНоменклатуры.Номенклатура) КАК ПродажиМесяцПоАртикулам
		|ПОМЕСТИТЬ ПродажиЗаМесяц
		|ИЗ
		|	РегистрНакопления.ВыручкаИСебестоимостьПродаж.Обороты(&НачалоПериодаМесяц, &КонецПериода, ,  АналитикаУчетаНоменклатуры В (ВЫБРАТЬ АналитикаУчетаНоменклатуры ИЗ КешАналитикаУчетаНоменклатуры)
		|														И  АналитикаУчетаПоПартнерам.Партнер <> ЗНАЧЕНИЕ(Справочник.Партнеры.НашеПредприятие))
		|
		|СГРУППИРОВАТЬ ПО
		|	АналитикаУчетаНоменклатуры.Склад	
		|
		|ИНДЕКСИРОВАТЬ ПО
		|	Склад
		|;
		////////////////////////////////////////////////////////////////////////////////////////////
		// 6. Продажи за месяц "Под заказ"
		|ВЫБРАТЬ РАЗРЕШЕННЫЕ
		|	Склад							КАК Склад,
		|	Сумма(НаличиеПодЗаказРасход)   	КАК ПродажиМесяцПодЗаказ
		|ПОМЕСТИТЬ ПродажиЗаМесяцПодЗаказ
		|ИЗ
		|	РегистрНакопления.ОбеспечениеЗаказов.Обороты(&НачалоПериодаМесяц, 
		|												&КонецПериода, 
		|												Регистратор, 
		|												(Номенклатура, Характеристика, Склад) В (ВЫБРАТЬ 
		|																							Номенклатура, 
		|																							Характеристика, 
		|																							Склад 
		|																						ИЗ 
		|																							КешАналитикаУчетаНоменклатуры))
		|ГДЕ
		|	Регистратор Ссылка Документ.РеализацияТоваровУслуг
		|
		|СГРУППИРОВАТЬ ПО
		| 	Склад
		|
		|ИНДЕКСИРОВАТЬ ПО
		| 	Склад
		|;
		////////////////////////////////////////////////////////////////////////////////////////////
		// 7. Продажи за квартал
		|ВЫБРАТЬ РАЗРЕШЕННЫЕ
		|	АналитикаУчетаНоменклатуры.Склад 					КАК Склад,
		|	СУММА(КоличествоОборот) 							КАК ПродажиКвартал,
		|	КОЛИЧЕСТВО(АналитикаУчетаНоменклатуры.Номенклатура) КАК ПродажиКварталПоАртикулам
		|ПОМЕСТИТЬ ПродажиЗаКвартал
		|ИЗ
		|	РегистрНакопления.ВыручкаИСебестоимостьПродаж.Обороты(&НачалоПериодаКвартал, &КонецПериода, ,  АналитикаУчетаНоменклатуры В (ВЫБРАТЬ АналитикаУчетаНоменклатуры ИЗ КешАналитикаУчетаНоменклатуры)
		|														И  АналитикаУчетаПоПартнерам.Партнер <> ЗНАЧЕНИЕ(Справочник.Партнеры.НашеПредприятие))
		|
		|СГРУППИРОВАТЬ ПО
		|	АналитикаУчетаНоменклатуры.Склад	
		|
		|ИНДЕКСИРОВАТЬ ПО
		|	Склад
		|;
		////////////////////////////////////////////////////////////////////////////////////////////
		// 8. Продажи за квартал "Под заказ"
		|ВЫБРАТЬ РАЗРЕШЕННЫЕ
		|	Склад							КАК Склад,
		|	Сумма(НаличиеПодЗаказРасход)   	КАК ПродажиКварталПодЗаказ
		|ПОМЕСТИТЬ ПродажиЗаКварталПодЗаказ
		|ИЗ
		|	РегистрНакопления.ОбеспечениеЗаказов.Обороты(&НачалоПериодаКвартал, 
		|												&КонецПериода, 
		|												Регистратор, 
		|												(Номенклатура, Характеристика, Склад) В (ВЫБРАТЬ 
		|																							Номенклатура, 
		|																							Характеристика, 
		|																							Склад 
		|																						ИЗ 
		|																							КешАналитикаУчетаНоменклатуры))
		|ГДЕ
		|	Регистратор Ссылка Документ.РеализацияТоваровУслуг
		|
		|СГРУППИРОВАТЬ ПО
		| 	Склад
		|
		|ИНДЕКСИРОВАТЬ ПО
		| 	Склад
		|;
		////////////////////////////////////////////////////////////////////////////////////////////
		// 9.
		|ВЫБРАТЬ РАЗРЕШЕННЫЕ
		|	%1
		|	СУММА(ОстаткиНаСкладе.ВНаличииОстаток) КАК НаСкладе,
		|
		|	СУММА(ПродажиПоНеделям.ПродажиНеделя) КАК ПродажиНеделя,
		|	СУММА(ПродажиПоНеделям.ПродажиНеделяПоАртикулам) КАК ПродажиНеделяПоАртикулам,
		|	СУММА(ПродажиПоНеделямПодЗаказ.ПродажиНеделяПодЗаказ) КАК ПродажиНеделяПодЗаказ,
		|	ВЫБОР
		|		КОГДА СУММА(ОстаткиНаСкладе.ВНаличииОстаток) > 0
		|		ТОГДА СУММА(ПродажиПоНеделям.ПродажиНеделя) * 4 / СУММА(ОстаткиНаСкладе.ВНаличииОстаток)
		|		ИНАЧЕ ""—""
		|	КОНЕЦ КАК ПродажиНеделяОборачиваемость,
		|	ВЫБОР
		|		КОГДА СУММА(Продажи2ПоНеделям.Продажи2Недели) > 0
		|		ТОГДА (СУММА(ПродажиПоНеделям.ПродажиНеделя) * 2 / СУММА(Продажи2ПоНеделям.Продажи2Недели) - 1) * 100
		|		ИНАЧЕ 0
		|	КОНЕЦ КАК ПродажиНеделяРост,
		|
		|
		|	СУММА(Продажи2ПоНеделям.Продажи2Недели) КАК Продажи2Недели,
		|	СУММА(Продажи2ПоНеделям.Продажи2НеделиПоАртикулам) КАК Продажи2НеделиПоАртикулам,
		|	СУММА(ПродажиПо2НеделямПодЗаказ.Продажи2НеделиПодЗаказ) КАК Продажи2НеделиПодЗаказ,
		|	ВЫБОР
		|		КОГДА СУММА(ОстаткиНаСкладе.ВНаличииОстаток) > 0
		|		ТОГДА СУММА(Продажи2ПоНеделям.Продажи2Недели) * 2 / СУММА(ОстаткиНаСкладе.ВНаличииОстаток)
		|		ИНАЧЕ ""—""
		|	КОНЕЦ КАК Продажи2НеделиОборачиваемость,
		|	ВЫБОР
		|		КОГДА СУММА(ПродажиЗаМесяц.ПродажиМесяц) > 0
		|		ТОГДА (СУММА(Продажи2ПоНеделям.Продажи2Недели) * 2 / СУММА(ПродажиЗаМесяц.ПродажиМесяц) - 1) * 100
		|		ИНАЧЕ 0
		|	КОНЕЦ КАК Продажи2НеделиРост,
		|
		|
		|	СУММА(ПродажиЗаМесяц.ПродажиМесяц) КАК ПродажиМесяц,
		|	СУММА(ПродажиЗаМесяц.ПродажиМесяцПоАртикулам) КАК ПродажиМесяцПоАртикулам,
		|	СУММА(ПродажиЗаМесяцПодЗаказ.ПродажиМесяцПодЗаказ) КАК ПродажиМесяцПодЗаказ,
		|	ВЫБОР
		|		КОГДА СУММА(ОстаткиНаСкладе.ВНаличииОстаток) > 0
		|		ТОГДА СУММА(ПродажиЗаМесяц.ПродажиМесяц) / СУММА(ОстаткиНаСкладе.ВНаличииОстаток)
		|		ИНАЧЕ ""—""
		|	КОНЕЦ КАК ПродажиМесяцОборачиваемость,
		|	ВЫБОР
		|		КОГДА СУММА(ПродажиЗаКвартал.ПродажиКвартал) > 0
		|		ТОГДА (СУММА(ПродажиЗаМесяц.ПродажиМесяц) * 3 / СУММА(ПродажиЗаКвартал.ПродажиКвартал) - 1) * 100
		|		ИНАЧЕ 0
		|	КОНЕЦ КАК ПродажиМесяцРост,
		|
		|
		|	СУММА(ПродажиЗаКвартал.ПродажиКвартал) КАК ПродажиКвартал,
		|	СУММА(ПродажиЗаКвартал.ПродажиКварталПоАртикулам) КАК ПродажиКварталПоАртикулам,
		|	СУММА(ПродажиЗаКварталПодЗаказ.ПродажиКварталПодЗаказ) КАК ПродажиКварталПодЗаказ,
		|	ВЫБОР
		|		КОГДА СУММА(ОстаткиНаСкладе.ВНаличииОстаток) > 0
		|		ТОГДА СУММА(ПродажиЗаКвартал.ПродажиКвартал) / 3 / СУММА(ОстаткиНаСкладе.ВНаличииОстаток)
		|		ИНАЧЕ ""—""
		|	КОНЕЦ КАК ПродажиКварталОборачиваемость
		|
		|ИЗ
		|	Справочник.АМ_ФорматыМагазинов.Склады КАК Склады
		|
		|ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.СвободныеОстатки.Остатки(, (Номенклатура, Характеристика, Склад) В (ВЫБРАТЬ 
		|																							Номенклатура, 
		|																							Характеристика, 
		|																							Склад 
		|																						ИЗ 
		|																							КешАналитикаУчетаНоменклатуры)) КАК ОстаткиНаСкладе
		|ПО ОстаткиНаСкладе.Склад = Склады.Склад
		|
		|ЛЕВОЕ СОЕДИНЕНИЕ ПродажиПоНеделям КАК ПродажиПоНеделям
		|ПО ПродажиПоНеделям.Склад = Склады.Склад
		|
		|ЛЕВОЕ СОЕДИНЕНИЕ ПродажиПоНеделямПодЗаказ КАК ПродажиПоНеделямПодЗаказ
		|ПО ПродажиПоНеделямПодЗаказ.Склад = Склады.Склад
		|
		|
		|ЛЕВОЕ СОЕДИНЕНИЕ Продажи2ПоНеделям КАК Продажи2ПоНеделям
		|ПО Продажи2ПоНеделям.Склад = Склады.Склад
		|
		|ЛЕВОЕ СОЕДИНЕНИЕ ПродажиПо2НеделямПодЗаказ КАК ПродажиПо2НеделямПодЗаказ
		|ПО ПродажиПо2НеделямПодЗаказ.Склад = Склады.Склад
		|
		|
		|ЛЕВОЕ СОЕДИНЕНИЕ ПродажиЗаМесяц КАК ПродажиЗаМесяц
		|ПО ПродажиЗаМесяц.Склад = Склады.Склад
		|
		|ЛЕВОЕ СОЕДИНЕНИЕ ПродажиЗаМесяцПодЗаказ КАК ПродажиЗаМесяцПодЗаказ
		|ПО ПродажиЗаМесяцПодЗаказ.Склад = Склады.Склад
		|
		|
		|ЛЕВОЕ СОЕДИНЕНИЕ ПродажиЗаКвартал КАК ПродажиЗаКвартал
		|ПО ПродажиЗаКвартал.Склад = Склады.Склад
		|
		|ЛЕВОЕ СОЕДИНЕНИЕ ПродажиЗаКварталПодЗаказ КАК ПродажиЗаКварталПодЗаказ
		|ПО ПродажиЗаКварталПодЗаказ.Склад = Склады.Склад
		|
		|СГРУППИРОВАТЬ ПО
		|	%2	
		|
		|УПОРЯДОЧИТЬ ПО
		|	ПродажиКвартал Убыв
		|;
		////////////////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ КешАналитикаУчетаНоменклатуры;
		////////////////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ ПродажиПоНеделям;
		////////////////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ ПродажиПоНеделямПодЗаказ;
		////////////////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ Продажи2ПоНеделям;
		////////////////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ ПродажиПо2НеделямПодЗаказ;
		////////////////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ ПродажиЗаМесяц;
		////////////////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ ПродажиЗаМесяцПодЗаказ;
		////////////////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ ПродажиЗаКвартал;
		////////////////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ ПродажиЗаКварталПодЗаказ;
		|";
	Возврат ТекстЗапроса;
	
КонецФункции // ПолучитьТекстЗапросаАналитическихДанных()

Функция ПолучитьТекстЗапросаАналитикаТоварыВРезервах()
	
	ТекстЗапроса = "
		|ВЫБРАТЬ
		|	ЗаказКлиента КАК Заказ,
		|	ЗаказКлиента.Дата КАК Дата,
		|	Номенклатура КАК Номенклатура,
		|	Номенклатура.ВидНоменклатуры КАК ВидНоменклатуры,
		|	Номенклатура.ТоварнаяКатегория КАК ТоварнаяКатегория,	
		|	Номенклатура.Производитель КАК Производитель,
		|	СуммаОстаток КАК Сумма,
		|	ЗаказаноОстаток КАК Заказано,
		|	КОформлениюОстаток КАК ВРезерве
		|ИЗ                                             
		|	РегистрНакопления.ЗаказыКлиентов.Остатки(, Склад = &Склад)
		|
		|ОБЪЕДИНИТЬ
		|
		|ВЫБРАТЬ
		|	ЗаказНаВнутреннееПотребление,
		|	ЗаказНаВнутреннееПотребление.Дата,
		|	Номенклатура,
		|	Номенклатура.ВидНоменклатуры,
		|	Номенклатура.ТоварнаяКатегория,	
		|	Номенклатура.Производитель,
		|	0,
		|	ЗаказаноОстаток,
		|	КОформлениюОстаток
		|ИЗ                                             
		|	РегистрНакопления.ЗаказыНаВнутреннееПотребление.Остатки(, Склад = &Склад)
		|
		|ОБЪЕДИНИТЬ
		|
		|ВЫБРАТЬ
		|	ЗаказНаПеремещение,
		|	ЗаказНаПеремещение.Дата,
		|	Номенклатура,
		|	Номенклатура.ВидНоменклатуры,
		|	Номенклатура.ТоварнаяКатегория,	
		|	Номенклатура.Производитель,
		|	0,
		|	ЗаказаноОстаток,
		|	КОформлениюОстаток
		|ИЗ                                             
		|	РегистрНакопления.ЗаказыНаПеремещение.Остатки(, ЗаказНаПеремещение.СкладОтправитель = &Склад)
		|
		|ОБЪЕДИНИТЬ
		|
		|ВЫБРАТЬ
		|	ЗаказНаСборку,
		|	ЗаказНаСборку.Дата,
		|	Номенклатура,
		|	Номенклатура.ВидНоменклатуры,
		|	Номенклатура.ТоварнаяКатегория,	
		|	Номенклатура.Производитель,
		|	0,
		|	ЗаказаноОстаток,
		|	КОформлениюОстаток
		|ИЗ                                             
		|	РегистрНакопления.ЗаказыНаСборку.Остатки(, ЗаказНаСборку.Склад = &Склад)
		|
		|УПОРЯДОЧИТЬ ПО 
		|	Дата Возр	
		|";
	Возврат ТекстЗапроса;
	
КонецФункции // ПолучитьТекстЗапросаАналитикаТоварыВРезервах()

Функция ПолучитьТекстЗапросаОбщегоЗаказа() Экспорт

	ТекстЗапроса = "
		////////////////////////////////////////////////////////////////////////////////
		// 0. Склады которыми управляет матрица
		|ВЫБРАТЬ
		|	Склад, 	
		|   СкладПополнения
		|ПОМЕСТИТЬ СкладыВМатрице
		|ИЗ
		|	ПредСкладыВМатрице
		|
		|ИНДЕКСИРОВАТЬ ПО
		|	Склад,
		|	СкладПополнения
		|;
		////////////////////////////////////////////////////////////////////////////////
		// 1. Настройки полок матрицы без данных
		|ВЫБРАТЬ
		|	Склад 				КАК Склад,
		|	ВидНоменклатуры 	КАК ВидНоменклатуры,
		|	ТоварнаяКатегория 	КАК ТоварнаяКатегория,
		|	Производитель 		КАК Производитель,
		|	Номенклатура 		КАК Номенклатура,
		|	
		|	НомерПоПорядку 			КАК НомерПоПорядку,
		|	ПосадочныеМеста 		КАК ПосадочныеМеста,
		|	ОтклонениеКоличествоПМ 	КАК ОтклонениеКоличествоПМ,
		|	
		|	МинимальныйЗапас 		КАК МинимальныйЗапас,
		|	СтраховойЗапас 			КАК СтраховойЗапас,
		|	МаксимальныйЗапас 		КАК МаксимальныйЗапас,
		|	
		|	Исключено 				 КАК Исключено,
		|	КонтрольМатрицейОтключен КАК КонтрольМатрицейОтключен
		|ПОМЕСТИТЬ КешМатрицы
		|ИЗ
		|	РегистрСведений.АМ_УправлениеАссортиментнойМатрицей.СрезПоследних(, Склад В (ВЫБРАТЬ Склад ИЗ СкладыВМатрице) %1)
		|
		|ИНДЕКСИРОВАТЬ ПО
		|	Склад,
		|	ВидНоменклатуры,
		|	ТоварнаяКатегория,
		|	Производитель,
		|	Номенклатура
		|;
		////////////////////////////////////////////////////////////////////////////////
		// 2. Справочный кеш данных по виду номенклатуры
		|ВЫБРАТЬ
		|	СкладыВМатрице.Склад 								КАК Склад,
		|	ВидыНоменклатуры.Ссылка 							КАК ВидНоменклатуры,
		|	ЗНАЧЕНИЕ(Справочник.ТоварныеКатегории.ПустаяСсылка) КАК ТоварнаяКатегория,
		|	ЗНАЧЕНИЕ(Справочник.Производители.ПустаяСсылка) 	КАК Производитель,
		|	ЗНАЧЕНИЕ(Справочник.Номенклатура.ПустаяСсылка) 		КАК Номенклатура,	
		|	СкладыВМатрице.СкладПополнения 						КАК СкладПополнения
		|	
		|ПОМЕСТИТЬ КешДанныхПоВидуНоменклатуры
		|ИЗ
		|	СкладыВМатрице КАК СкладыВМатрице
		|	
		|ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ВидыНоменклатуры КАК ВидыНоменклатуры
		|ПО ИСТИНА
		|
		|ГДЕ
		|	ВидыНоменклатуры.ЭтоГруппа = ЛОЖЬ
		|И 	ВидыНоменклатуры.ПометкаУдаления = ЛОЖЬ
		|%2
		|
		|ИНДЕКСИРОВАТЬ ПО
		|	Склад,
		|	ВидНоменклатуры,
		|	ТоварнаяКатегория,
		|	Производитель,
		|	Номенклатура	
		|;
		////////////////////////////////////////////////////////////////////////////////
		// 3. Настойка полок матрицы по виду номенклатуры без данных
		|ВЫБРАТЬ
		|	КешДанных.Склад 						КАК Склад,
		|	КешДанных.ВидНоменклатуры 				КАК ВидНоменклатуры,
		|	КешДанных.ТоварнаяКатегория 			КАК ТоварнаяКатегория,
		|	КешДанных.Производитель					КАК Производитель,
		|	КешДанных.Номенклатура 					КАК Номенклатура,
		|	IsNull(КешМатрицы.ПосадочныеМеста, 0) 	КАК ПосадочныеМеста,
		|	0										КАК ОтклонениеКоличествоПМ,
		|	0										КАК НомерПоПорядку,
		|	IsNull(КешМатрицы.МинимальныйЗапас, 0)  КАК МинимальныйЗапас,
		|	IsNull(КешМатрицы.СтраховойЗапас, 0)  	КАК СтраховойЗапас,
		|	IsNull(КешМатрицы.МаксимальныйЗапас, 0) КАК МаксимальныйЗапас,	
		|	КешДанных.СкладПополнения 				КАК СкладПополнения
		|	
		|ПОМЕСТИТЬ ПосадочныхМестПоВидуНоменклатуры
		|ИЗ
		|	КешДанныхПоВидуНоменклатуры КАК КешДанных
		|		
		|ЛЕВОЕ СОЕДИНЕНИЕ КешМатрицы КАК КешМатрицы
		|ПО	КешМатрицы.Склад 			 = КешДанных.Склад
		|И 	КешМатрицы.ВидНоменклатуры 	 = КешДанных.ВидНоменклатуры
		|И 	КешМатрицы.ТоварнаяКатегория = КешДанных.ТоварнаяКатегория
		|И	КешМатрицы.Производитель 	 = КешДанных.Производитель
		|И	КешМатрицы.Номенклатура 	 = КешДанных.Номенклатура
		|
		|ГДЕ
		|	IsNull(КешМатрицы.Исключено, Ложь) 				 = Ложь
		|И 	IsNull(КешМатрицы.КонтрольМатрицейОтключен, Ложь)= Ложь
		|
		|ИНДЕКСИРОВАТЬ ПО
		|	Склад,
		|	ВидНоменклатуры,
		|	ТоварнаяКатегория,
		|	Производитель,
		|	Номенклатура
		|;
		////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ КешДанныхПоВидуНоменклатуры;
		////////////////////////////////////////////////////////////////////////////////
		// 5. Справочный кеш данных по товарным категориям
		|ВЫБРАТЬ
		|	КешДанныхПоВидуНоменклатуры.Склад 				КАК Склад,
		|	КешДанныхПоВидуНоменклатуры.ВидНоменклатуры 	КАК ВидНоменклатуры,
		|	ТоварныеКатегории.Ссылка 						КАК ТоварнаяКатегория,
		|	ЗНАЧЕНИЕ(Справочник.Производители.ПустаяСсылка) КАК Производитель,
		|	ЗНАЧЕНИЕ(Справочник.Номенклатура.ПустаяСсылка) 	КАК Номенклатура,
		|	КешДанныхПоВидуНоменклатуры.СкладПополнения 	КАК СкладПополнения
		|ПОМЕСТИТЬ КешДанныхПоТоварнымКатегориям
		|ИЗ
		|	ПосадочныхМестПоВидуНоменклатуры КАК КешДанныхПоВидуНоменклатуры
		|		
		|ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.ТоварныеКатегории КАК ТоварныеКатегории
		|ПО ТоварныеКатегории.Владелец 		  = КешДанныхПоВидуНоменклатуры.ВидНоменклатуры
		|И 	ТоварныеКатегории.ЭтоГруппа 	  = Ложь
		|И 	ТоварныеКатегории.ПометкаУдаления = Ложь
		|
		|ИНДЕКСИРОВАТЬ ПО
		|	Склад,
		|	ВидНоменклатуры,
		|	ТоварнаяКатегория,
		|	Производитель,
		|	Номенклатура
		|;
		////////////////////////////////////////////////////////////////////////////////
		// 6. Настойка полок матрицы по товарным категориям без данных
		|ВЫБРАТЬ
		|	КешДанных.Склад 			КАК Склад,
		|	КешДанных.ВидНоменклатуры 	КАК ВидНоменклатуры,
		|	КешДанных.ТоварнаяКатегория КАК ТоварнаяКатегория,
		|	КешДанных.Производитель 	КАК Производитель,
		|	КешДанных.Номенклатура		КАК Номенклатура,
		|	IsNull(КешМатрицы.ПосадочныеМеста, 0) 		КАК ПосадочныеМеста,
		|	IsNull(КешМатрицы.ОтклонениеКоличествоПМ, 0)КАК ОтклонениеКоличествоПМ,
		|	IsNull(КешМатрицы.НомерПоПорядку, 0) 		КАК НомерПоПорядку,
		|	ВЫБОР
		|		КОГДА IsNull(КешМатрицы.МинимальныйЗапас, 0) 	<> 0
		|		  ИЛИ IsNull(КешМатрицы.СтраховойЗапас, 0) 		<> 0
		|		  ИЛИ IsNull(КешМатрицы.МаксимальныйЗапас, 0) 	<> 0
		|		ТОГДА IsNull(КешМатрицы.МинимальныйЗапас, 0) 
		|		ИНАЧЕ IsNull(ПосадочныхМестПоВидуНоменклатуры.МинимальныйЗапас, 0) 
		|	КОНЕЦ КАК МинимальныйЗапас,
		|	ВЫБОР
		|		КОГДА IsNull(КешМатрицы.МинимальныйЗапас, 0) 	<> 0
		|		  ИЛИ IsNull(КешМатрицы.СтраховойЗапас, 0) 		<> 0
		|		  ИЛИ IsNull(КешМатрицы.МаксимальныйЗапас, 0) 	<> 0
		|		ТОГДА IsNull(КешМатрицы.СтраховойЗапас, 0) 
		|		ИНАЧЕ IsNull(ПосадочныхМестПоВидуНоменклатуры.СтраховойЗапас, 0) 
		|	КОНЕЦ КАК СтраховойЗапас,
		|	ВЫБОР
		|		КОГДА IsNull(КешМатрицы.МинимальныйЗапас, 0) 	<> 0
		|		  ИЛИ IsNull(КешМатрицы.СтраховойЗапас, 0) 		<> 0
		|		  ИЛИ IsNull(КешМатрицы.МаксимальныйЗапас, 0) 	<> 0
		|		ТОГДА IsNull(КешМатрицы.МаксимальныйЗапас, 0) 
		|		ИНАЧЕ IsNull(ПосадочныхМестПоВидуНоменклатуры.МаксимальныйЗапас, 0) 
		|	КОНЕЦ КАК МаксимальныйЗапас,
		|	КешДанных.СкладПополнения КАК СкладПополнения
		|ПОМЕСТИТЬ ПосадочныхМестПоТоварнойКатегории
		|ИЗ
		|	КешДанныхПоТоварнымКатегориям КАК КешДанных
		|		
		|ЛЕВОЕ СОЕДИНЕНИЕ КешМатрицы КАК КешМатрицы
		|ПО КешМатрицы.Склад 			= КешДанных.Склад
		|И  КешМатрицы.ВидНоменклатуры 	= КешДанных.ВидНоменклатуры
		|И  КешМатрицы.ТоварнаяКатегория= КешДанных.ТоварнаяКатегория
		|И  КешМатрицы.Производитель 	= КешДанных.Производитель
		|И	КешМатрицы.Номенклатура 	= КешДанных.Номенклатура
		|
		|ЛЕВОЕ СОЕДИНЕНИЕ ПосадочныхМестПоВидуНоменклатуры КАК ПосадочныхМестПоВидуНоменклатуры
		|ПО ПосадочныхМестПоВидуНоменклатуры.Склад 			 = КешДанных.Склад
		|И 	ПосадочныхМестПоВидуНоменклатуры.ВидНоменклатуры = КешДанных.ВидНоменклатуры
		|
		|ГДЕ
		|	IsNull(КешМатрицы.Исключено, Ложь) = Ложь
		|И 	IsNull(КешМатрицы.КонтрольМатрицейОтключен, Ложь) = Ложь
		|
		|ИНДЕКСИРОВАТЬ ПО
		|	Склад,
		|	ВидНоменклатуры,
		|	ТоварнаяКатегория,
		|	Производитель,
		|	Номенклатура
		|;
		////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ КешДанныхПоТоварнымКатегориям;
		////////////////////////////////////////////////////////////////////////////////
		// 8. Справочный кеш данных по производителям
		|ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	КешДанныхПоТоварнымКатегориям.Склад 			КАК Склад,
		|	КешДанныхПоТоварнымКатегориям.ВидНоменклатуры 	КАК ВидНоменклатуры,
		|	КешДанныхПоТоварнымКатегориям.ТоварнаяКатегория КАК ТоварнаяКатегория,
		|	СпрНоменклатура.Производитель 					КАК Производитель,
		|	ЗНАЧЕНИЕ(Справочник.Номенклатура.ПустаяСсылка) 	КАК Номенклатура,
		|	КешДанныхПоТоварнымКатегориям.СкладПополнения 	КАК СкладПополнения
		|ПОМЕСТИТЬ КешДанныхПоПроизводителям
		|ИЗ
		|	ПосадочныхМестПоТоварнойКатегории КАК КешДанныхПоТоварнымКатегориям
		|	
		|ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.Номенклатура КАК СпрНоменклатура
		|ПО СпрНоменклатура.ВидНоменклатуры   = КешДанныхПоТоварнымКатегориям.ВидНоменклатуры
		|И 	СпрНоменклатура.ТоварнаяКатегория = КешДанныхПоТоварнымКатегориям.ТоварнаяКатегория
		|И 	СпрНоменклатура.Производитель <> ЗНАЧЕНИЕ(Справочник.Производители.ПустаяСсылка)
		|
		|ИНДЕКСИРОВАТЬ ПО
		|	Склад,
		|	ВидНоменклатуры,
		|	ТоварнаяКатегория,
		|	Производитель,
		|	Номенклатура
		|;
		////////////////////////////////////////////////////////////////////////////////
		// 9. Настойка полок матрицы по производителям без данных
		|ВЫБРАТЬ
		|	КешДанных.Склад 			КАК Склад,
		|	КешДанных.ВидНоменклатуры 	КАК ВидНоменклатуры,
		|	КешДанных.ТоварнаяКатегория КАК ТоварнаяКатегория,
		|	КешДанных.Производитель 	КАК Производитель,
		|	КешДанных.Номенклатура 		КАК Номенклатура,
		|	ЕСТЬNULL(КешМатрицы.ПосадочныеМеста, 0) 		КАК ПосадочныеМеста,
		|	ЕСТЬNULL(КешМатрицы.ОтклонениеКоличествоПМ, 0) 	КАК ОтклонениеКоличествоПМ,
		|	ЕСТЬNULL(КешМатрицы.НомерПоПорядку, 0) 			КАК НомерПоПорядку,
		|	ВЫБОР
		|		КОГДА IsNull(КешМатрицы.МинимальныйЗапас, 0) 	<> 0
		|		  ИЛИ IsNull(КешМатрицы.СтраховойЗапас, 0) 		<> 0
		|		  ИЛИ IsNull(КешМатрицы.МаксимальныйЗапас, 0) 	<> 0
		|		ТОГДА IsNull(КешМатрицы.МинимальныйЗапас, 0)
		|		ИНАЧЕ IsNull(ПосадочныхМестПоТоварнойКатегории.МинимальныйЗапас, 0) 
		|	КОНЕЦ КАК МинимальныйЗапас,
		|	ВЫБОР
		|		КОГДА IsNull(КешМатрицы.МинимальныйЗапас, 0) 	<> 0
		|		  ИЛИ IsNull(КешМатрицы.СтраховойЗапас, 0) 		<> 0
		|		  ИЛИ IsNull(КешМатрицы.МаксимальныйЗапас, 0) 	<> 0
		|		ТОГДА IsNull(КешМатрицы.СтраховойЗапас, 0) 
		|		ИНАЧЕ IsNull(ПосадочныхМестПоТоварнойКатегории.СтраховойЗапас, 0) 
		|	КОНЕЦ КАК СтраховойЗапас,
		|	ВЫБОР
		|		КОГДА IsNull(КешМатрицы.МинимальныйЗапас, 0) 	<> 0
		|		  ИЛИ IsNull(КешМатрицы.СтраховойЗапас, 0) 		<> 0
		|		  ИЛИ IsNull(КешМатрицы.МаксимальныйЗапас, 0) 	<> 0
		|		ТОГДА IsNull(КешМатрицы.МаксимальныйЗапас, 0) 
		|		ИНАЧЕ IsNull(ПосадочныхМестПоТоварнойКатегории.МаксимальныйЗапас, 0) 
		|	КОНЕЦ КАК МаксимальныйЗапас,
		|	КешДанных.СкладПополнения КАК СкладПополнения
		|ПОМЕСТИТЬ ПосадочныхМестПоПроизводителю
		|ИЗ
		|	КешДанныхПоПроизводителям КАК КешДанных
		|		
		|ЛЕВОЕ СОЕДИНЕНИЕ КешМатрицы КАК КешМатрицы
		|ПО 	КешМатрицы.Склад 			= КешДанных.Склад
		|И 	КешМатрицы.ВидНоменклатуры 	= КешДанных.ВидНоменклатуры
		|И 	КешМатрицы.ТоварнаяКатегория= КешДанных.ТоварнаяКатегория
		|И 	КешМатрицы.Производитель 	= КешДанных.Производитель
		|И 	КешМатрицы.Номенклатура 	= КешДанных.Номенклатура
		|
		|ЛЕВОЕ СОЕДИНЕНИЕ ПосадочныхМестПоТоварнойКатегории КАК ПосадочныхМестПоТоварнойКатегории
		|ПО 	ПосадочныхМестПоТоварнойКатегории.Склад 			= КешДанных.Склад
		|И 	ПосадочныхМестПоТоварнойКатегории.ВидНоменклатуры 	= КешДанных.ВидНоменклатуры
		|И 	ПосадочныхМестПоТоварнойКатегории.ТоварнаяКатегория = КешДанных.ТоварнаяКатегория
		|
		|ГДЕ
		|	IsNull(КешМатрицы.Исключено, Ложь) = Ложь
		|И 	IsNull(КешМатрицы.КонтрольМатрицейОтключен, Ложь) = Ложь
		|
		|ИНДЕКСИРОВАТЬ ПО
		|	Склад,
		|	ВидНоменклатуры,
		|	ТоварнаяКатегория,
		|	Производитель,
		|	Номенклатура
		|;
		////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ КешДанныхПоПроизводителям;
		////////////////////////////////////////////////////////////////////////////////
		// 11. Справочный кеш данных по номенклатуре
		|ВЫБРАТЬ
		|	КешДанныхПоПроизводителям.Склад 			КАК Склад,
		|	КешДанныхПоПроизводителям.ВидНоменклатуры 	КАК ВидНоменклатуры,
		|	КешДанныхПоПроизводителям.ТоварнаяКатегория КАК ТоварнаяКатегория,
		|	КешДанныхПоПроизводителям.Производитель 	КАК Производитель,
		|	СпрНоменклатура.Ссылка 						КАК Номенклатура,
		|	КешДанныхПоПроизводителям.СкладПополнения 	КАК СкладПополнения
		|ПОМЕСТИТЬ КешДанныхПоНоменклатуре
		|ИЗ
		|	ПосадочныхМестПоПроизводителю КАК КешДанныхПоПроизводителям
		|	
		|ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.Номенклатура КАК СпрНоменклатура
		|ПО СпрНоменклатура.ВидНоменклатуры 	= КешДанныхПоПроизводителям.ВидНоменклатуры
		|И 	СпрНоменклатура.ТоварнаяКатегория 	= КешДанныхПоПроизводителям.ТоварнаяКатегория
		|И 	СпрНоменклатура.Производитель 		= КешДанныхПоПроизводителям.Производитель
		|
		|ИНДЕКСИРОВАТЬ ПО
		|	Склад,
		|	ВидНоменклатуры,
		|	ТоварнаяКатегория,
		|	Производитель,
		|	Номенклатура
		|;
		////////////////////////////////////////////////////////////////////////////////
		// 12. Настойка полок матрицы по номенклатуре без данных
		|ВЫБРАТЬ
		|	КешДанных.Склад 			КАК Склад,
		|	КешДанных.ВидНоменклатуры 	КАК ВидНоменклатуры,
		|	КешДанных.ТоварнаяКатегория КАК ТоварнаяКатегория,
		|	КешДанных.Производитель 	КАК Производитель,
		|	КешДанных.Номенклатура 		КАК Номенклатура,
		|	IsNull(КешМатрицы.ПосадочныеМеста, 0) 	КАК ПосадочныеМеста,
		|	0 										КАК ОтклонениеКоличествоПМ,
		|	IsNull(КешМатрицы.НомерПоПорядку, 0) 	КАК НомерПоПорядку,
		|	ВЫБОР
		|		КОГДА IsNull(КешМатрицы.МинимальныйЗапас, 0) 	<> 0
		|		  ИЛИ IsNull(КешМатрицы.СтраховойЗапас, 0) 		<> 0
		|		  ИЛИ IsNull(КешМатрицы.МаксимальныйЗапас, 0) 	<> 0
		|		ТОГДА IsNull(КешМатрицы.МинимальныйЗапас, 0) 
		|		ИНАЧЕ IsNull(ПосадочныхМестПоПроизводителю.МинимальныйЗапас, 0) 
		|	КОНЕЦ КАК МинимальныйЗапас,
		|	ВЫБОР
		|		КОГДА IsNull(КешМатрицы.МинимальныйЗапас, 0) 	<> 0
		|		  ИЛИ IsNull(КешМатрицы.СтраховойЗапас, 0) 		<> 0
		|		  ИЛИ IsNull(КешМатрицы.МаксимальныйЗапас, 0) 	<> 0
		|		ТОГДА IsNull(КешМатрицы.СтраховойЗапас, 0) 
		|		ИНАЧЕ IsNull(ПосадочныхМестПоПроизводителю.СтраховойЗапас, 0) 
		|	КОНЕЦ КАК СтраховойЗапас,
		|	ВЫБОР
		|		КОГДА IsNull(КешМатрицы.МинимальныйЗапас, 0) 	<> 0
		|		  ИЛИ IsNull(КешМатрицы.СтраховойЗапас, 0) 		<> 0
		|		  ИЛИ IsNull(КешМатрицы.МаксимальныйЗапас, 0) 	<> 0
		|		ТОГДА IsNull(КешМатрицы.МаксимальныйЗапас, 0) 
		|		ИНАЧЕ IsNull(ПосадочныхМестПоПроизводителю.МаксимальныйЗапас, 0) 
		|	КОНЕЦ КАК МаксимальныйЗапас,
		|	КешДанных.СкладПополнения КАК СкладПополнения
		|ПОМЕСТИТЬ ПосадочныхМестПоНоменклатуре
		|ИЗ
		|	КешДанныхПоНоменклатуре КАК КешДанных
		|		
		|ЛЕВОЕ СОЕДИНЕНИЕ КешМатрицы КАК КешМатрицы
		|ПО 	КешМатрицы.Склад 			= КешДанных.Склад
		|И 	КешМатрицы.ВидНоменклатуры 	= КешДанных.ВидНоменклатуры
		|И 	КешМатрицы.ТоварнаяКатегория= КешДанных.ТоварнаяКатегория
		|И 	КешМатрицы.Производитель 	= КешДанных.Производитель
		|И 	КешМатрицы.Номенклатура 	= КешДанных.Номенклатура
		|
		|ЛЕВОЕ СОЕДИНЕНИЕ ПосадочныхМестПоПроизводителю КАК ПосадочныхМестПоПроизводителю
		|ПО ПосадочныхМестПоПроизводителю.Склад 			= КешДанных.Склад
		|И 	ПосадочныхМестПоПроизводителю.ВидНоменклатуры 	= КешДанных.ВидНоменклатуры
		|И 	ПосадочныхМестПоПроизводителю.ТоварнаяКатегория = КешДанных.ТоварнаяКатегория
		|И 	ПосадочныхМестПоПроизводителю.Производитель 	= КешДанных.Производитель
		|			
		|ГДЕ
		|	IsNull(КешМатрицы.Исключено, Ложь) = Ложь
		|И 	IsNull(КешМатрицы.КонтрольМатрицейОтключен, Ложь) = Ложь
		|
		|ИНДЕКСИРОВАТЬ ПО
		|	Склад,
		|	ВидНоменклатуры,
		|	ТоварнаяКатегория,
		|	Производитель,
		|	Номенклатура
		|;
		////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ КешДанныхПоНоменклатуре;
		////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ КешМатрицы;
		////////////////////////////////////////////////////////////////////////////////
		// 15. Таблица для расчета текущего количества артикулов на складе
		|ВЫБРАТЬ
		|	СвободныеОстатки.Склад		  КАК Склад,
		| 	СвободныеОстатки.Номенклатура КАК Номенклатура
		|ПОМЕСТИТЬ ТаблицаДляРасчетаТКА
		|ИЗ                                                                                                                       
		|  	РегистрНакопления.СвободныеОстатки.Остатки(, %3 (Номенклатура, Склад) В (ВЫБРАТЬ
		|  											  								Номенклатура,
		|  											  								Склад
		|  											  							 ИЗ
		|  											  							 	ПосадочныхМестПоНоменклатуре)
		|  											  ) КАК СвободныеОстатки
		|ГДЕ
		|	СвободныеОстатки.ВНаличииОстаток - СвободныеОстатки.ВРезервеОстаток > 0
		|
		|ОБЪЕДИНИТЬ
		|
		|ВЫБРАТЬ
		|  	ТоварыКПоступлению.Склад		КАК Склад,	
		|	ТоварыКПоступлению.Номенклатура КАК Номенклатура
		|ИЗ                                                                                                  
		|	РегистрНакопления.ТоварыКПоступлению.Остатки(, %3 (Номенклатура, Склад) В (ВЫБРАТЬ
		|  											  								Номенклатура,
		|  											  								Склад
		|  											  							 ИЗ
		|  											  							 	ПосадочныхМестПоНоменклатуре)
		|  											  	) КАК ТоварыКПоступлению
		|																				 
		|ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.КТС_ТоварыКПоступлениюПодОбеспечение.Остатки(, %3 (Номенклатура, Склад) В (	ВЫБРАТЬ
		|									  											  								Номенклатура,
		|									  											  								Склад
		|									  											  							 ИЗ
		|									  											  							 	ПосадочныхМестПоНоменклатуре)
		|									  										   ) КАК ТоварыПодОбеспечение
		|ПО	ТоварыПодОбеспечение.Номенклатура = ТоварыКПоступлению.Номенклатура
		|И	ТоварыПодОбеспечение.Склад 		  = ТоварыКПоступлению.Склад
		|
		|ГДЕ
		|	IsNull(ТоварыКПоступлению.КПоступлениюОстаток, 0) - IsNull(ТоварыПодОбеспечение.КПоступлениюОстаток, 0) > 0 	
		|;
		////////////////////////////////////////////////////////////////////////////////
		// 16. Текущее количество артикулов по виду номенклатуры
		|ВЫБРАТЬ
		|	СвободныеОстатки.Склад 							КАК Склад,
		|	СвободныеОстатки.Номенклатура.ВидНоменклатуры 	КАК ВидНоменклатуры,
		|	КОЛИЧЕСТВО(СвободныеОстатки.Номенклатура) 		КАК КоличествоАртикулов
		|ПОМЕСТИТЬ КоличествоАртикуловПоВидуНоменклатуры
		|ИЗ
		|	ТаблицаДляРасчетаТКА КАК СвободныеОстатки
		|
		|СГРУППИРОВАТЬ ПО
		|	СвободныеОстатки.Склад,
		|	СвободныеОстатки.Номенклатура.ВидНоменклатуры
		|
		|ИНДЕКСИРОВАТЬ ПО
		|	Склад,
		|	ВидНоменклатуры
		|;
		////////////////////////////////////////////////////////////////////////////////
		// 17. Текущее количество артикулов по товарным категориям
		|ВЫБРАТЬ
		|	СвободныеОстатки.Склад 							КАК Склад,
		|	СвободныеОстатки.Номенклатура.ВидНоменклатуры 	КАК ВидНоменклатуры,
		|	СвободныеОстатки.Номенклатура.ТоварнаяКатегория	КАК ТоварнаяКатегория,
		|	КОЛИЧЕСТВО(СвободныеОстатки.Номенклатура) 		КАК КоличествоАртикулов
		|ПОМЕСТИТЬ КоличествоАртикуловПоТоварнымКатегориям
		|ИЗ
		|	ТаблицаДляРасчетаТКА КАК СвободныеОстатки
		|
		|СГРУППИРОВАТЬ ПО
		|	СвободныеОстатки.Склад,
		|	СвободныеОстатки.Номенклатура.ВидНоменклатуры,
		|	СвободныеОстатки.Номенклатура.ТоварнаяКатегория
		|
		|ИНДЕКСИРОВАТЬ ПО
		|	Склад,
		|	ВидНоменклатуры,
		|	ТоварнаяКатегория
		|;
		////////////////////////////////////////////////////////////////////////////////
		// 18. Текущее количество артикулов по производителям
		|ВЫБРАТЬ
		|	СвободныеОстатки.Склад 							КАК Склад,
		|	СвободныеОстатки.Номенклатура.ВидНоменклатуры 	КАК ВидНоменклатуры,
		|	СвободныеОстатки.Номенклатура.ТоварнаяКатегория	КАК ТоварнаяКатегория,
		|	СвободныеОстатки.Номенклатура.Производитель		КАК Производитель,
		|	КОЛИЧЕСТВО(СвободныеОстатки.Номенклатура) 		КАК КоличествоАртикулов
		|ПОМЕСТИТЬ КоличествоАртикуловПоПроизводителям
		|ИЗ
		|	ТаблицаДляРасчетаТКА КАК СвободныеОстатки
		|
		|СГРУППИРОВАТЬ ПО
		|	СвободныеОстатки.Склад,
		|	СвободныеОстатки.Номенклатура.ВидНоменклатуры,
		|	СвободныеОстатки.Номенклатура.ТоварнаяКатегория,
		|	СвободныеОстатки.Номенклатура.Производитель
		|
		|ИНДЕКСИРОВАТЬ ПО
		|	Склад,
		|	ВидНоменклатуры,
		|	ТоварнаяКатегория,
		|	Производитель
		|;
		////////////////////////////////////////////////////////////////////////////////
		// 19. Текущее количество артикулов по номенклатуре
		|ВЫБРАТЬ
		|	РасчетаТКА.Склад 							КАК Склад,
		|	РасчетаТКА.Номенклатура.ВидНоменклатуры 	КАК ВидНоменклатуры,
		|	РасчетаТКА.Номенклатура.ТоварнаяКатегория	КАК ТоварнаяКатегория,
		|	РасчетаТКА.Номенклатура.Производитель		КАК Производитель,
		|	РасчетаТКА.Номенклатура						КАК Номенклатура,
		|	1 											КАК КоличествоАртикулов,
		|	IsNull(СвободныеОстатки.ВНаличииОстаток, 0) 
	 	| - IsNull(СвободныеОстатки.ВРезервеОстаток, 0)
	  	| + IsNull(ТоварыКПоступлению.КПоступлениюОстаток, 0) 
	  	| - IsNull(ТоварыПодОбеспечение.КПоступлениюОстаток, 0) КАК КоличествоОстаток
		|ПОМЕСТИТЬ КоличествоАртикуловПоНоменклатуре
		|ИЗ
		|	ТаблицаДляРасчетаТКА КАК РасчетаТКА
		|
		|ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.СвободныеОстатки.Остатки(, %3 Склад В (ВЫБРАТЬ Склад ИЗ СкладыВМатрице)) КАК СвободныеОстатки
		|ПО	СвободныеОстатки.Номенклатура = РасчетаТКА.Номенклатура
		|И	СвободныеОстатки.Склад 		  = РасчетаТКА.Склад
		|
		|ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.ТоварыКПоступлению.Остатки(, %3 Склад В (ВЫБРАТЬ Склад ИЗ СкладыВМатрице)) КАК ТоварыКПоступлению
		|ПО	ТоварыКПоступлению.Номенклатура = РасчетаТКА.Номенклатура
		|И	ТоварыКПоступлению.Склад 		= РасчетаТКА.Склад	
		|
		|ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.КТС_ТоварыКПоступлениюПодОбеспечение.Остатки(, %3 Склад В (ВЫБРАТЬ Склад ИЗ СкладыВМатрице)) КАК ТоварыПодОбеспечение
		|ПО	ТоварыПодОбеспечение.Номенклатура = РасчетаТКА.Номенклатура
		|И	ТоварыПодОбеспечение.Склад 		  = РасчетаТКА.Склад
		|
		|ГДЕ
		|	IsNull(СвободныеОстатки.ВНаличииОстаток, 0) 
		|  - IsNull(СвободныеОстатки.ВРезервеОстаток, 0)
		|  + IsNull(ТоварыКПоступлению.КПоступлениюОстаток, 0) 
		|  - IsNull(ТоварыПодОбеспечение.КПоступлениюОстаток, 0) > 0
		|
		|ИНДЕКСИРОВАТЬ ПО
		|	РасчетаТКА.Склад,
		|	РасчетаТКА.Номенклатура.ВидНоменклатуры,
		|	РасчетаТКА.Номенклатура.ТоварнаяКатегория,
		|	РасчетаТКА.Номенклатура.Производитель,
		|	РасчетаТКА.Номенклатура
		|;
		////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ ТаблицаДляРасчетаТКА; 
		////////////////////////////////////////////////////////////////////////////////
		// 21. Дней на складе по виду номенклатуры, для построения приоритетности перемещения
		|ВЫБРАТЬ
		|	АУН.Склад 							КАК Склад,
		|	АУН.Номенклатура.ВидНоменклатуры 	КАК ВидНоменклатуры,
		|	СРЕДНЕЕ(ДнейНаСкладе.КоличествоДней)КАК ДНС
		|ПОМЕСТИТЬ ДнейНаСкладеПоВидуНоменклатуры
		|ИЗ
		|	РегистрСведений.АМ_ДнейНаСкладе КАК ДнейНаСкладе
		|		
		|ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.АналитикаУчетаНоменклатуры КАК АУН
		|ПО АУН.КлючАналитики = ДнейНаСкладе.АналитикаУчетаНоменклатуры
		|		
		|ВНУТРЕННЕЕ СОЕДИНЕНИЕ ПосадочныхМестПоВидуНоменклатуры КАК КешДанныхДляВывода
		|ПО КешДанныхДляВывода.Склад 			= АУН.Склад
		|И 	КешДанныхДляВывода.ВидНоменклатуры 	= АУН.Номенклатура.ВидНоменклатуры
		|
		|СГРУППИРОВАТЬ ПО
		|	АУН.Склад,
		|	АУН.Номенклатура.ВидНоменклатуры
		|
		|ИНДЕКСИРОВАТЬ ПО
		|	Склад,
		|	ВидНоменклатуры
		|;
		////////////////////////////////////////////////////////////////////////////////
		// 22. Дней на складе по товарным категориям
		|ВЫБРАТЬ
		|	АУН.Склад 							КАК Склад,
		|	АУН.Номенклатура.ВидНоменклатуры 	КАК ВидНоменклатуры,
		|	АУН.Номенклатура.ТоварнаяКатегория 	КАК ТоварнаяКатегория,
		|	СРЕДНЕЕ(ДнейНаСкладе.КоличествоДней) КАК ДНС
		|ПОМЕСТИТЬ ДнейНаСкладеПоТоварнымКатегориям
		|ИЗ
		|	РегистрСведений.АМ_ДнейНаСкладе КАК ДнейНаСкладе
		|		
		|ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.АналитикаУчетаНоменклатуры КАК АУН
		|ПО АУН.КлючАналитики = ДнейНаСкладе.АналитикаУчетаНоменклатуры
		|		
		|ВНУТРЕННЕЕ СОЕДИНЕНИЕ ПосадочныхМестПоТоварнойКатегории КАК КешДанныхДляВывода
		|ПО КешДанныхДляВывода.Склад 			= АУН.Склад
		|И 	КешДанныхДляВывода.ВидНоменклатуры 	= АУН.Номенклатура.ВидНоменклатуры
		|И 	КешДанныхДляВывода.ТоварнаяКатегория = АУН.Номенклатура.ТоварнаяКатегория
		|
		|СГРУППИРОВАТЬ ПО
		|	АУН.Склад,
		|	АУН.Номенклатура.ВидНоменклатуры,
		|	АУН.Номенклатура.ТоварнаяКатегория
		|
		|ИНДЕКСИРОВАТЬ ПО
		|	Склад,
		|	ВидНоменклатуры,
		|	ТоварнаяКатегория
		|;
		////////////////////////////////////////////////////////////////////////////////
		// 23. Дней на складе по производителям
		|ВЫБРАТЬ
		|	АУН.Склад 							КАК Склад,
		|	АУН.Номенклатура.ВидНоменклатуры 	КАК ВидНоменклатуры,
		|	АУН.Номенклатура.ТоварнаяКатегория 	КАК ТоварнаяКатегория,
		|	АУН.Номенклатура.Производитель	 	КАК Производитель,
		|	СРЕДНЕЕ(ДнейНаСкладе.КоличествоДней) КАК ДНС
		|ПОМЕСТИТЬ ДнейНаСкладеПоПроизводителям
		|ИЗ
		|	РегистрСведений.АМ_ДнейНаСкладе КАК ДнейНаСкладе
		|		
		|ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.АналитикаУчетаНоменклатуры КАК АУН
		|ПО АУН.КлючАналитики = ДнейНаСкладе.АналитикаУчетаНоменклатуры
		|		
		|ВНУТРЕННЕЕ СОЕДИНЕНИЕ ПосадочныхМестПоПроизводителю КАК КешДанныхДляВывода
		|ПО КешДанныхДляВывода.Склад 			 = АУН.Склад
		|И 	КешДанныхДляВывода.ВидНоменклатуры 	 = АУН.Номенклатура.ВидНоменклатуры
		|И 	КешДанныхДляВывода.ТоварнаяКатегория = АУН.Номенклатура.ТоварнаяКатегория
		|И 	КешДанныхДляВывода.Производитель 	 = АУН.Номенклатура.Производитель
		|
		|СГРУППИРОВАТЬ ПО
		|	АУН.Склад,
		|	АУН.Номенклатура.ВидНоменклатуры,
		|	АУН.Номенклатура.ТоварнаяКатегория,
		|	АУН.Номенклатура.Производитель	
		|
		|ИНДЕКСИРОВАТЬ ПО
		|	Склад,
		|	ВидНоменклатуры,
		|	ТоварнаяКатегория,
		|	Производитель
		|;
		////////////////////////////////////////////////////////////////////////////////
		// 24. Дней на складе по номенклатуре
		|ВЫБРАТЬ
		|	АУН.Склад 							КАК Склад,
		|	АУН.Номенклатура.ВидНоменклатуры 	КАК ВидНоменклатуры,
		|	АУН.Номенклатура.ТоварнаяКатегория 	КАК ТоварнаяКатегория,
		|	АУН.Номенклатура.Производитель	 	КАК Производитель,
		|	АУН.Номенклатура					КАК Номенклатура,
		|	ДнейНаСкладе.КоличествоДней 		КАК ДНС
		|ПОМЕСТИТЬ ДнейНаСкладеПоНоменклатуре
		|ИЗ
		|	РегистрСведений.АМ_ДнейНаСкладе КАК ДнейНаСкладе
		|		
		|ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.АналитикаУчетаНоменклатуры КАК АУН
		|ПО АУН.КлючАналитики = ДнейНаСкладе.АналитикаУчетаНоменклатуры
		|		
		|ВНУТРЕННЕЕ СОЕДИНЕНИЕ ПосадочныхМестПоНоменклатуре КАК КешДанныхДляВывода
		|ПО КешДанныхДляВывода.Склад 			 = АУН.Склад
		|И 	КешДанныхДляВывода.ВидНоменклатуры 	 = АУН.Номенклатура.ВидНоменклатуры
		|И 	КешДанныхДляВывода.ТоварнаяКатегория = АУН.Номенклатура.ТоварнаяКатегория
		|И 	КешДанныхДляВывода.Производитель 	 = АУН.Номенклатура.Производитель
		|И 	КешДанныхДляВывода.Номенклатура 	 = АУН.Номенклатура
		|
		|ИНДЕКСИРОВАТЬ ПО
		|	Склад,
		|	ВидНоменклатуры,
		|	ТоварнаяКатегория,
		|	Производитель,
		|	Номенклатура
		|;
		////////////////////////////////////////////////////////////////////////////////
		// 25. Посадочных мест по номенклатуре с данными по дереву
		|ВЫБРАТЬ
		|	ПосадочныхМестПоНоменклатуре.Склад 				КАК Склад,
		|	ПосадочныхМестПоНоменклатуре.ВидНоменклатуры 	КАК ВидНоменклатуры,
		|	ПосадочныхМестПоНоменклатуре.ТоварнаяКатегория 	КАК ТоварнаяКатегория,
		|	ПосадочныхМестПоНоменклатуре.Производитель 		КАК Производитель,
		|	ПосадочныхМестПоНоменклатуре.Номенклатура 		КАК Номенклатура,
		|	ПосадочныхМестПоНоменклатуре.ПосадочныеМеста 		КАК ПосадочныеМеста,
		|	ПосадочныхМестПоНоменклатуре.ОтклонениеКоличествоПМ КАК ОтклонениеКоличествоПМ,
		|	ПосадочныхМестПоНоменклатуре.НомерПоПорядку 		КАК НомерПоПорядку,
		|	ПосадочныхМестПоНоменклатуре.МинимальныйЗапас 	КАК МинимальныйЗапас,
		|	ПосадочныхМестПоНоменклатуре.СтраховойЗапас 	КАК СтраховойЗапас,
		|	ПосадочныхМестПоНоменклатуре.МаксимальныйЗапас 	КАК МаксимальныйЗапас,
		|	ПосадочныхМестПоНоменклатуре.СкладПополнения 	КАК СкладПополнения,
		|	
		|	IsNull(ПосадочныхМестПоТоварнойКатегории.НомерПоПорядку, 0) КАК НПП_ТК,
		|	IsNull(ДнейНаСкладеПоТоварнымКатегориям.ДНС, 0) 			КАК ДНС_ТК,
		|	
		|	IsNull(ПосадочныхМестПоПроизводителю.НомерПоПорядку, 0) КАК НПП_ПР,
		|	IsNull(ДнейНаСкладеПоПроизводителям.ДНС, 0) 			КАК ДНС_ПР,
		|	
		|	IsNull(ДнейНаСкладеПоНоменклатуре.ДНС, 0) 						КАК ДНС_НМ,
		|	IsNull(КоличествоАртикуловПоНоменклатуре.КоличествоАртикулов, 0)КАК ТКА_НМ,
		|	IsNull(КоличествоАртикуловПоНоменклатуре.КоличествоОстаток, 0) 	КАК КоличествоОстаток
		|	
		|ПОМЕСТИТЬ ПосадочныхМестПоНоменклатуреСДанными
		|ИЗ
		|	ПосадочныхМестПоНоменклатуре КАК ПосадочныхМестПоНоменклатуре
		|
		|ЛЕВОЕ СОЕДИНЕНИЕ ПосадочныхМестПоТоварнойКатегории КАК ПосадочныхМестПоТоварнойКатегории
		|ПО	ПосадочныхМестПоТоварнойКатегории.Склад				= ПосадочныхМестПоНоменклатуре.Склад
		|И 	ПосадочныхМестПоТоварнойКатегории.ВидНоменклатуры 	= ПосадочныхМестПоНоменклатуре.ВидНоменклатуры
		|И 	ПосадочныхМестПоТоварнойКатегории.ТоварнаяКатегория	= ПосадочныхМестПоНоменклатуре.ТоварнаяКатегория
		|	
		|ЛЕВОЕ СОЕДИНЕНИЕ ДнейНаСкладеПоТоварнымКатегориям КАК ДнейНаСкладеПоТоварнымКатегориям
		|ПО	ДнейНаСкладеПоТоварнымКатегориям.Склад				= ПосадочныхМестПоНоменклатуре.Склад
		|И 	ДнейНаСкладеПоТоварнымКатегориям.ВидНоменклатуры 	= ПосадочныхМестПоНоменклатуре.ВидНоменклатуры
		|И 	ДнейНаСкладеПоТоварнымКатегориям.ТоварнаяКатегория	= ПосадочныхМестПоНоменклатуре.ТоварнаяКатегория
		|
		|
		|ЛЕВОЕ СОЕДИНЕНИЕ ПосадочныхМестПоПроизводителю КАК ПосадочныхМестПоПроизводителю
		|ПО	ПосадочныхМестПоПроизводителю.Склад				= ПосадочныхМестПоНоменклатуре.Склад
		|И 	ПосадочныхМестПоПроизводителю.ВидНоменклатуры 	= ПосадочныхМестПоНоменклатуре.ВидНоменклатуры
		|И 	ПосадочныхМестПоПроизводителю.ТоварнаяКатегория	= ПосадочныхМестПоНоменклатуре.ТоварнаяКатегория
		|И 	ПосадочныхМестПоПроизводителю.Производитель		= ПосадочныхМестПоНоменклатуре.Производитель
		|
		|ЛЕВОЕ СОЕДИНЕНИЕ ДнейНаСкладеПоПроизводителям КАК ДнейНаСкладеПоПроизводителям
		|ПО	ДнейНаСкладеПоПроизводителям.Склад				= ПосадочныхМестПоНоменклатуре.Склад
		|И 	ДнейНаСкладеПоПроизводителям.ВидНоменклатуры 	= ПосадочныхМестПоНоменклатуре.ВидНоменклатуры
		|И 	ДнейНаСкладеПоПроизводителям.ТоварнаяКатегория	= ПосадочныхМестПоНоменклатуре.ТоварнаяКатегория
		|И 	ДнейНаСкладеПоПроизводителям.Производитель		= ПосадочныхМестПоНоменклатуре.Производитель
		|
		|
		|ЛЕВОЕ СОЕДИНЕНИЕ ДнейНаСкладеПоНоменклатуре КАК ДнейНаСкладеПоНоменклатуре
		|ПО	ДнейНаСкладеПоНоменклатуре.Склад			= ПосадочныхМестПоНоменклатуре.Склад
		|И 	ДнейНаСкладеПоНоменклатуре.ВидНоменклатуры 	= ПосадочныхМестПоНоменклатуре.ВидНоменклатуры
		|И 	ДнейНаСкладеПоНоменклатуре.ТоварнаяКатегория= ПосадочныхМестПоНоменклатуре.ТоварнаяКатегория
		|И 	ДнейНаСкладеПоНоменклатуре.Производитель	= ПосадочныхМестПоНоменклатуре.Производитель
		|И 	ДнейНаСкладеПоНоменклатуре.Номенклатура		= ПосадочныхМестПоНоменклатуре.Номенклатура
		|
		|ЛЕВОЕ СОЕДИНЕНИЕ КоличествоАртикуловПоНоменклатуре КАК КоличествоАртикуловПоНоменклатуре
		|ПО	КоличествоАртикуловПоНоменклатуре.Склад				= ПосадочныхМестПоНоменклатуре.Склад
		|И 	КоличествоАртикуловПоНоменклатуре.ВидНоменклатуры 	= ПосадочныхМестПоНоменклатуре.ВидНоменклатуры
		|И 	КоличествоАртикуловПоНоменклатуре.ТоварнаяКатегория	= ПосадочныхМестПоНоменклатуре.ТоварнаяКатегория
		|И 	КоличествоАртикуловПоНоменклатуре.Производитель		= ПосадочныхМестПоНоменклатуре.Производитель
		|И 	КоличествоАртикуловПоНоменклатуре.Номенклатура		= ПосадочныхМестПоНоменклатуре.Номенклатура
		|
		|ИНДЕКСИРОВАТЬ ПО
		|	ПосадочныхМестПоНоменклатуре.Склад,
		|	ПосадочныхМестПоНоменклатуре.ВидНоменклатуры,
		|	ПосадочныхМестПоНоменклатуре.ТоварнаяКатегория,
		|	ПосадочныхМестПоНоменклатуре.Производитель,
		|	ПосадочныхМестПоНоменклатуре.Номенклатура	
		|;
		////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ ПосадочныхМестПоНоменклатуре; 
		////////////////////////////////////////////////////////////////////////////////
		// 27. Начало расчета не достающих посадочных мест по виду номенклатуры 
		|ВЫБРАТЬ
		|	ПосадочныхМестПоВидуНоменклатуры.Склад 			 	КАК Склад,
		|	ПосадочныхМестПоВидуНоменклатуры.ВидНоменклатуры 	КАК ВидНоменклатуры,
		|	СУММА(ПосадочныхМестПоТоварнойКатегории.ПосадочныеМеста) КАК ПодчиненныеПосадочныеМеста
		|ПОМЕСТИТЬ ПосадочныеИПодчиненныеМестаПоВидуНоменклатуры
		|ИЗ
		|	ПосадочныхМестПоВидуНоменклатуры КАК ПосадочныхМестПоВидуНоменклатуры
		|	
		|ЛЕВОЕ СОЕДИНЕНИЕ ПосадочныхМестПоТоварнойКатегории КАК ПосадочныхМестПоТоварнойКатегории
		|ПО	ПосадочныхМестПоТоварнойКатегории.Склад 		  = ПосадочныхМестПоВидуНоменклатуры.Склад
		|И	ПосадочныхМестПоТоварнойКатегории.ВидНоменклатуры = ПосадочныхМестПоВидуНоменклатуры.ВидНоменклатуры
		|
		|СГРУППИРОВАТЬ ПО
		|	ПосадочныхМестПоВидуНоменклатуры.Склад,
		|	ПосадочныхМестПоВидуНоменклатуры.ВидНоменклатуры
		|;
		////////////////////////////////////////////////////////////////////////////////
		// 28. Проверка на ошибки распределения посадочных мест
		|ВЫБРАТЬ
		|	ПосадочныхМестПоВидуНоменклатуры.Склад 			 	КАК Склад,
		|	ПосадочныхМестПоВидуНоменклатуры.ВидНоменклатуры 	КАК ВидНоменклатуры,
		|	ПосадочныхМестПоВидуНоменклатуры.ПосадочныеМеста 
		|  - IsNull(ПосадочныеИПодчиненныеМестаПоВидуНоменклатуры.ПодчиненныеПосадочныеМеста, 0) КАК НеРаспределено,
		|  	""Нет доступных товарных категорий для произвольного заполнениям товарной матрицы, количество мест: %ОшибкаПоВидуНоменклатуры%"" КАК СообщениеОбОшибке	
		|ПОМЕСТИТЬ ОшибкиПоВидуНоменклатуры
		|ИЗ
		|	ПосадочныхМестПоВидуНоменклатуры КАК ПосадочныхМестПоВидуНоменклатуры
		|	
		|ЛЕВОЕ СОЕДИНЕНИЕ ПосадочныеИПодчиненныеМестаПоВидуНоменклатуры КАК ПосадочныеИПодчиненныеМестаПоВидуНоменклатуры
		|ПО	ПосадочныеИПодчиненныеМестаПоВидуНоменклатуры.Склад 		  = ПосадочныхМестПоВидуНоменклатуры.Склад
		|И	ПосадочныеИПодчиненныеМестаПоВидуНоменклатуры.ВидНоменклатуры = ПосадочныхМестПоВидуНоменклатуры.ВидНоменклатуры
		|		
		|ЛЕВОЕ СОЕДИНЕНИЕ ПосадочныхМестПоТоварнойКатегории КАК ПосадочныхМестПоТоварнойКатегории
		|ПО	ПосадочныхМестПоТоварнойКатегории.Склад 		  = ПосадочныхМестПоВидуНоменклатуры.Склад
		|И	ПосадочныхМестПоТоварнойКатегории.ВидНоменклатуры = ПосадочныхМестПоВидуНоменклатуры.ВидНоменклатуры
		|И	ПосадочныхМестПоТоварнойКатегории.ПосадочныеМеста = 0
		|
		|ГДЕ
		|	ПосадочныхМестПоВидуНоменклатуры.ПосадочныеМеста > IsNull(ПосадочныеИПодчиненныеМестаПоВидуНоменклатуры.ПодчиненныеПосадочныеМеста, 0)
		|И	ПосадочныхМестПоТоварнойКатегории.ПосадочныеМеста ЕСТЬ NULL	
		|;
		////////////////////////////////////////////////////////////////////////////////
		// 29. Не распределенные посадочные места по виду номенклатуры без данных
		|ВЫБРАТЬ
		|	ПосадочныхМестПоВидуНоменклатуры.Склад 			 КАК Склад,
		|	ПосадочныхМестПоВидуНоменклатуры.ВидНоменклатуры КАК ВидНоменклатуры,
		|	ПосадочныхМестПоВидуНоменклатуры.ПосадочныеМеста 
		|  - IsNull(ПосадочныеИПодчиненныеМестаПоВидуНоменклатуры.ПодчиненныеПосадочныеМеста, 0) КАК НеРаспределено,
		|  	ПосадочныхМестПоВидуНоменклатуры.СкладПополнения КАК СкладПополнения	
		|ПОМЕСТИТЬ НеРаспределенныеПосадочныеМестаПоВидуНоменклатурыБаза
		|ИЗ
		|	ПосадочныхМестПоВидуНоменклатуры КАК ПосадочныхМестПоВидуНоменклатуры
		|	
		|ЛЕВОЕ СОЕДИНЕНИЕ ПосадочныеИПодчиненныеМестаПоВидуНоменклатуры КАК ПосадочныеИПодчиненныеМестаПоВидуНоменклатуры
		|ПО	ПосадочныеИПодчиненныеМестаПоВидуНоменклатуры.Склад 		  = ПосадочныхМестПоВидуНоменклатуры.Склад
		|И	ПосадочныеИПодчиненныеМестаПоВидуНоменклатуры.ВидНоменклатуры = ПосадочныхМестПоВидуНоменклатуры.ВидНоменклатуры

		|ГДЕ
		|	ПосадочныхМестПоВидуНоменклатуры.ПосадочныеМеста > IsNull(ПосадочныеИПодчиненныеМестаПоВидуНоменклатуры.ПодчиненныеПосадочныеМеста, 0)
		|И  (ПосадочныхМестПоВидуНоменклатуры.Склад,
		|	ПосадочныхМестПоВидуНоменклатуры.ВидНоменклатуры) НЕ В (ВЫБРАТЬ 
		|															Склад 				КАК Склад,
		|															ВидНоменклатуры 	КАК ВидНоменклатуры
		|														ИЗ
		|															ОшибкиПоВидуНоменклатуры)
		|
		|ИНДЕКСИРОВАТЬ ПО
		|	Склад,
		|	ВидНоменклатуры	
		|;
		////////////////////////////////////////////////////////////////////////////////
		// 30. Заполнение товарных категорий, где посадочные места = 0
		|ВЫБРАТЬ
		|	ПосадочныхМестПоТоварнойКатегории.Склад 			КАК Склад,
		|	ПосадочныхМестПоТоварнойКатегории.ВидНоменклатуры 	КАК ВидНоменклатуры,
		|	ПосадочныхМестПоТоварнойКатегории.ТоварнаяКатегория КАК ТоварнаяКатегория,	
		|  	0 													КАК ПосадочныеМеста,
		|	0 													КАК ОтклонениеКоличествоПМ,
		|	ПосадочныхМестПоТоварнойКатегории.НомерПоПорядку 	КАК НомерПоПорядку,
		|	IsNull(ДнейНаСкладеПоТоварнымКатегориям.ДНС, 0)     КАК ДНС,  	
		|
		|  	ПосадочныхМестПоТоварнойКатегории.МинимальныйЗапас 	КАК МинимальныйЗапас,
		|  	ПосадочныхМестПоТоварнойКатегории.СтраховойЗапас 	КАК СтраховойЗапас,
		|  	ПосадочныхМестПоТоварнойКатегории.МаксимальныйЗапас	КАК МаксимальныйЗапас,
		|  	ПосадочныхМестПоТоварнойКатегории.СкладПополнения	КАК СкладПополнения	
		|ПОМЕСТИТЬ ТоварныеКатегорииДляРаспределенияПоВидуНоменклатуры
		|ИЗ
		|	НеРаспределенныеПосадочныеМестаПоВидуНоменклатурыБаза КАК ПосадочныхМестПоВидуНоменклатуры
		|			
		|ЛЕВОЕ СОЕДИНЕНИЕ ПосадочныхМестПоТоварнойКатегории КАК ПосадочныхМестПоТоварнойКатегории
		|ПО	ПосадочныхМестПоТоварнойКатегории.Склад 		  = ПосадочныхМестПоВидуНоменклатуры.Склад
		|И	ПосадочныхМестПоТоварнойКатегории.ВидНоменклатуры = ПосадочныхМестПоВидуНоменклатуры.ВидНоменклатуры
		|И	ПосадочныхМестПоТоварнойКатегории.ПосадочныеМеста = 0
		|
		|ЛЕВОЕ СОЕДИНЕНИЕ ДнейНаСкладеПоТоварнымКатегориям КАК ДнейНаСкладеПоТоварнымКатегориям
		|ПО	ДнейНаСкладеПоТоварнымКатегориям.Склад 		  		= ПосадочныхМестПоТоварнойКатегории.Склад
		|И	ДнейНаСкладеПоТоварнымКатегориям.ВидНоменклатуры 	= ПосадочныхМестПоТоварнойКатегории.ВидНоменклатуры
		|И	ДнейНаСкладеПоТоварнымКатегориям.ТоварнаяКатегория	= ПосадочныхМестПоТоварнойКатегории.ТоварнаяКатегория
		|
		|ГДЕ
		|	IsNull(ПосадочныхМестПоТоварнойКатегории.ПосадочныеМеста, Неопределено) <> Неопределено
		|
		|ИНДЕКСИРОВАТЬ ПО
		|	Склад,
		|	ВидНоменклатуры,
		|	ТоварнаяКатегория	
		|;
		////////////////////////////////////////////////////////////////////////////////
		// 31. Не распределенные посадочные места по виду номенклатуры с данными
		|ВЫБРАТЬ
		|	ПосадочныхМестПоВидуНоменклатуры.Склад 			 КАК Склад,
		|	ПосадочныхМестПоВидуНоменклатуры.ВидНоменклатуры КАК ВидНоменклатуры,
		|	ДнейНаСкладеПоВидуНоменклатуры.ДНС				 КАК ДНС,
		|	ПосадочныхМестПоВидуНоменклатуры.НеРаспределено  КАК КоличествоМест,
		|	ПосадочныхМестПоВидуНоменклатуры.НеРаспределено 
		|  - IsNull(СУММА(КоличествоАртикуловПоТоварнымКатегориям.КоличествоАртикулов), 0) КАК НеРаспределено,
		|  	ПосадочныхМестПоВидуНоменклатуры.СкладПополнения КАК СкладПополнения	
		|ИЗ
		|	НеРаспределенныеПосадочныеМестаПоВидуНоменклатурыБаза КАК ПосадочныхМестПоВидуНоменклатуры
		|	
		|ЛЕВОЕ СОЕДИНЕНИЕ ТоварныеКатегорииДляРаспределенияПоВидуНоменклатуры КАК ТоварныеКатегорииДляРаспределенияПоВидуНоменклатуры
		|ПО	ТоварныеКатегорииДляРаспределенияПоВидуНоменклатуры.Склад 		  	= ПосадочныхМестПоВидуНоменклатуры.Склад
		|И	ТоварныеКатегорииДляРаспределенияПоВидуНоменклатуры.ВидНоменклатуры = ПосадочныхМестПоВидуНоменклатуры.ВидНоменклатуры
		|
		|ЛЕВОЕ СОЕДИНЕНИЕ КоличествоАртикуловПоТоварнымКатегориям КАК КоличествоАртикуловПоТоварнымКатегориям
		|ПО	КоличествоАртикуловПоТоварнымКатегориям.Склад 			  = ТоварныеКатегорииДляРаспределенияПоВидуНоменклатуры.Склад
		|И	КоличествоАртикуловПоТоварнымКатегориям.ВидНоменклатуры   = ТоварныеКатегорииДляРаспределенияПоВидуНоменклатуры.ВидНоменклатуры
		|И	КоличествоАртикуловПоТоварнымКатегориям.ТоварнаяКатегория = ТоварныеКатегорииДляРаспределенияПоВидуНоменклатуры.ТоварнаяКатегория
		|
		|ЛЕВОЕ СОЕДИНЕНИЕ ДнейНаСкладеПоВидуНоменклатуры КАК ДнейНаСкладеПоВидуНоменклатуры
		|ПО	ДнейНаСкладеПоВидуНоменклатуры.Склад 		   = ПосадочныхМестПоВидуНоменклатуры.Склад
		|И	ДнейНаСкладеПоВидуНоменклатуры.ВидНоменклатуры = ПосадочныхМестПоВидуНоменклатуры.ВидНоменклатуры
		|
		|СГРУППИРОВАТЬ ПО
		|	ПосадочныхМестПоВидуНоменклатуры.Склад,
		|	ПосадочныхМестПоВидуНоменклатуры.ВидНоменклатуры,
		|	ДнейНаСкладеПоВидуНоменклатуры.ДНС,
		|	ПосадочныхМестПоВидуНоменклатуры.НеРаспределено,
		|	ПосадочныхМестПоВидуНоменклатуры.СкладПополнения
		|	
		|УПОРЯДОЧИТЬ ПО
		|	ДнейНаСкладеПоВидуНоменклатуры.ДНС Возр 			
		|;
		////////////////////////////////////////////////////////////////////////////////
		// 32. Товарные категории для распределения по виду номенклатуры
		|ВЫБРАТЬ
		|	ТКДРПВН.Склад 					КАК Склад,
		|	ТКДРПВН.ВидНоменклатуры 		КАК ВидНоменклатуры,
		|	ТКДРПВН.ТоварнаяКатегория 		КАК ТоварнаяКатегория,	
		|  	ТКДРПВН.ПосадочныеМеста 		КАК ПосадочныеМеста,
		|	ТКДРПВН.ОтклонениеКоличествоПМ 	КАК ОтклонениеКоличествоПМ,
		|	ТКДРПВН.НомерПоПорядку 			КАК НомерПоПорядку,
		|  	
		|  	ТКДРПВН.МинимальныйЗапас 		КАК МинимальныйЗапас,
		|  	ТКДРПВН.СтраховойЗапас 			КАК СтраховойЗапас,
		|  	ТКДРПВН.МаксимальныйЗапас		КАК МаксимальныйЗапас,
		|  	ТКДРПВН.СкладПополнения			КАК СкладПополнения	
		|ИЗ
		|	ТоварныеКатегорииДляРаспределенияПоВидуНоменклатуры КАК ТКДРПВН
		|УПОРЯДОЧИТЬ ПО
		|	ВЫБОР
		|		КОГДА ТКДРПВН.НомерПоПорядку = 0
		|		ТОГДА 99999
		|		ИНАЧЕ ТКДРПВН.НомерПоПорядку
		|	КОНЕЦ Возр,
		|	ТКДРПВН.ДНС Возр
		|;
		////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ ТоварныеКатегорииДляРаспределенияПоВидуНоменклатуры;
		////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ НеРаспределенныеПосадочныеМестаПоВидуНоменклатурыБаза;
		////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ ПосадочныеИПодчиненныеМестаПоВидуНоменклатуры;
		////////////////////////////////////////////////////////////////////////////////
		// 36. Начало расчета не достающих посадочных мест по товарной категории 
		|ВЫБРАТЬ
		|	ПосадочныхМестПоТоварнойКатегории.Склад 			КАК Склад,
		|	ПосадочныхМестПоТоварнойКатегории.ВидНоменклатуры 	КАК ВидНоменклатуры,
		|	ПосадочныхМестПоТоварнойКатегории.ТоварнаяКатегория КАК ТоварнаяКатегория,
		|	СУММА(ПосадочныхМестПоПроизводителю.ПосадочныеМеста) КАК ПодчиненныеПосадочныеМеста
		|ПОМЕСТИТЬ ПосадочныеИПодчиненныеМестаПоТоварнымКатегориям
		|ИЗ
		|	ПосадочныхМестПоТоварнойКатегории КАК ПосадочныхМестПоТоварнойКатегории
		|	
		|ЛЕВОЕ СОЕДИНЕНИЕ ПосадочныхМестПоПроизводителю КАК ПосадочныхМестПоПроизводителю
		|ПО	ПосадочныхМестПоПроизводителю.Склад 		  	= ПосадочныхМестПоТоварнойКатегории.Склад
		|И	ПосадочныхМестПоПроизводителю.ВидНоменклатуры 	= ПосадочныхМестПоТоварнойКатегории.ВидНоменклатуры
		|И	ПосадочныхМестПоПроизводителю.ТоварнаяКатегория = ПосадочныхМестПоТоварнойКатегории.ТоварнаяКатегория
		|
		|СГРУППИРОВАТЬ ПО
		|	ПосадочныхМестПоТоварнойКатегории.Склад,
		|	ПосадочныхМестПоТоварнойКатегории.ВидНоменклатуры,
		|	ПосадочныхМестПоТоварнойКатегории.ТоварнаяКатегория
		|;
		////////////////////////////////////////////////////////////////////////////////
		// 37. Проверка на ошибки распределения посадочных мест
		|ВЫБРАТЬ
		|	ПосадочныхМестПоТоварнойКатегории.Склад 			КАК Склад,
		|	ПосадочныхМестПоТоварнойКатегории.ВидНоменклатуры 	КАК ВидНоменклатуры,
		|	ПосадочныхМестПоТоварнойКатегории.ТоварнаяКатегория КАК ТоварнаяКатегория,
		|	ПосадочныхМестПоТоварнойКатегории.ПосадочныеМеста 
		|  - IsNull(ПосадочныеИПодчиненныеМестаПоТоварнымКатегориям.ПодчиненныеПосадочныеМеста, 0) КАК НеРаспределено,
		|  	""Нет доступных производителей для произвольного заполнениям товарной матрицы, количество мест: %ОшибкаПоТоварнойКатегории%"" КАК СообщениеОбОшибке	
		|ПОМЕСТИТЬ ОшибкиПоТоварнымКатегориям
		|ИЗ
		|	ПосадочныхМестПоТоварнойКатегории КАК ПосадочныхМестПоТоварнойКатегории
		|	
		|ЛЕВОЕ СОЕДИНЕНИЕ ПосадочныеИПодчиненныеМестаПоТоварнымКатегориям КАК ПосадочныеИПодчиненныеМестаПоТоварнымКатегориям
		|ПО	ПосадочныеИПодчиненныеМестаПоТоварнымКатегориям.Склад 		  	  = ПосадочныхМестПоТоварнойКатегории.Склад
		|И	ПосадочныеИПодчиненныеМестаПоТоварнымКатегориям.ВидНоменклатуры   = ПосадочныхМестПоТоварнойКатегории.ВидНоменклатуры
		|И	ПосадочныеИПодчиненныеМестаПоТоварнымКатегориям.ТоварнаяКатегория = ПосадочныхМестПоТоварнойКатегории.ТоварнаяКатегория
		|		
		|ЛЕВОЕ СОЕДИНЕНИЕ ПосадочныхМестПоПроизводителю КАК ПосадочныхМестПоПроизводителю
		|ПО	ПосадочныхМестПоПроизводителю.Склад 		  	= ПосадочныхМестПоТоварнойКатегории.Склад
		|И	ПосадочныхМестПоПроизводителю.ВидНоменклатуры 	= ПосадочныхМестПоТоварнойКатегории.ВидНоменклатуры
		|И	ПосадочныхМестПоПроизводителю.ТоварнаяКатегория = ПосадочныхМестПоТоварнойКатегории.ТоварнаяКатегория 
		|И	ПосадочныхМестПоПроизводителю.ПосадочныеМеста 	= 0
		|
		|ГДЕ
		|	ПосадочныхМестПоТоварнойКатегории.ПосадочныеМеста > IsNull(ПосадочныеИПодчиненныеМестаПоТоварнымКатегориям.ПодчиненныеПосадочныеМеста, 0)
		|И	ПосадочныхМестПоПроизводителю.ПосадочныеМеста ЕСТЬ NULL	
		|;
		////////////////////////////////////////////////////////////////////////////////
		// 38. Не распределенные посадочные места по товарным категориям без данных
		|ВЫБРАТЬ
		|	ПосадочныхМестПоТоварнойКатегории.Склад 			КАК Склад,
		|	ПосадочныхМестПоТоварнойКатегории.ВидНоменклатуры 	КАК ВидНоменклатуры,
		|	ПосадочныхМестПоТоварнойКатегории.ТоварнаяКатегория КАК ТоварнаяКатегория,
		|	ПосадочныхМестПоТоварнойКатегории.НомерПоПорядку    КАК НомерПоПорядку,
		|	ПосадочныхМестПоТоварнойКатегории.ПосадочныеМеста 
		|  - IsNull(ПосадочныеИПодчиненныеМестаПоТоварнымКатегориям.ПодчиненныеПосадочныеМеста, 0) КАК НеРаспределено,
		|  	ПосадочныхМестПоТоварнойКатегории.СкладПополнения КАК СкладПополнения	
		|ПОМЕСТИТЬ НеРаспределенныеПосадочныеМестаПоТоварнымКатегориямБаза
		|ИЗ
		|	ПосадочныхМестПоТоварнойКатегории КАК ПосадочныхМестПоТоварнойКатегории
		|	
		|ЛЕВОЕ СОЕДИНЕНИЕ ПосадочныеИПодчиненныеМестаПоТоварнымКатегориям КАК ПосадочныеИПодчиненныеМестаПоТоварнымКатегориям
		|ПО	ПосадочныеИПодчиненныеМестаПоТоварнымКатегориям.Склад 		  	  = ПосадочныхМестПоТоварнойКатегории.Склад
		|И	ПосадочныеИПодчиненныеМестаПоТоварнымКатегориям.ВидНоменклатуры   = ПосадочныхМестПоТоварнойКатегории.ВидНоменклатуры
		|И	ПосадочныеИПодчиненныеМестаПоТоварнымКатегориям.ТоварнаяКатегория = ПосадочныхМестПоТоварнойКатегории.ТоварнаяКатегория
		|
		|ГДЕ
		|	ПосадочныхМестПоТоварнойКатегории.ПосадочныеМеста > IsNull(ПосадочныеИПодчиненныеМестаПоТоварнымКатегориям.ПодчиненныеПосадочныеМеста, 0)
		|И  (ПосадочныхМестПоТоварнойКатегории.Склад,
		|	ПосадочныхМестПоТоварнойКатегории.ВидНоменклатуры,
		|	ПосадочныхМестПоТоварнойКатегории.ТоварнаяКатегория) НЕ В (ВЫБРАТЬ 
		|															Склад 				КАК Склад,
		|															ВидНоменклатуры 	КАК ВидНоменклатуры,
		|															ТоварнаяКатегория	КАК ТоварнаяКатегория
		|														ИЗ
		|															ОшибкиПоТоварнымКатегориям)
		|
		|ИНДЕКСИРОВАТЬ ПО
		|	Склад,
		|	ВидНоменклатуры,
		|	ТоварнаяКатегория	
		|;
		////////////////////////////////////////////////////////////////////////////////
		// 39. Заполнение производителей, где посадочные места = 0
		|ВЫБРАТЬ
		|	ПосадочныхМестПоПроизводителю.Склад 			КАК Склад,
		|	ПосадочныхМестПоПроизводителю.ВидНоменклатуры 	КАК ВидНоменклатуры,
		|	ПосадочныхМестПоПроизводителю.ТоварнаяКатегория КАК ТоварнаяКатегория,
		|	ПосадочныхМестПоПроизводителю.Производитель		КАК Производитель,	
		|  	0 												КАК ПосадочныеМеста,
		|	0 												КАК ОтклонениеКоличествоПМ,
		|	ПосадочныхМестПоПроизводителю.НомерПоПорядку 	КАК НомерПоПорядку,
		|	IsNull(ДнейНаСкладеПоПроизводителям.ДНС, 0)		КАК ДНС,
		|  	
		|  	ПосадочныхМестПоПроизводителю.МинимальныйЗапас 	КАК МинимальныйЗапас,
		|  	ПосадочныхМестПоПроизводителю.СтраховойЗапас 	КАК СтраховойЗапас,
		|  	ПосадочныхМестПоПроизводителю.МаксимальныйЗапас	КАК МаксимальныйЗапас,
		|  	ПосадочныхМестПоПроизводителю.СкладПополнения	КАК СкладПополнения	
		|ПОМЕСТИТЬ ПроизводителиДляРаспределенияПоТоварнымКатегориям
		|ИЗ
		|	НеРаспределенныеПосадочныеМестаПоТоварнымКатегориямБаза КАК ПосадочныхМестПоТоварнойКатегории
		|			
		|ЛЕВОЕ СОЕДИНЕНИЕ ПосадочныхМестПоПроизводителю КАК ПосадочныхМестПоПроизводителю
		|ПО	ПосадочныхМестПоПроизводителю.Склад 		  	= ПосадочныхМестПоТоварнойКатегории.Склад
		|И	ПосадочныхМестПоПроизводителю.ВидНоменклатуры 	= ПосадочныхМестПоТоварнойКатегории.ВидНоменклатуры
		|И	ПосадочныхМестПоПроизводителю.ТоварнаяКатегория	= ПосадочныхМестПоТоварнойКатегории.ТоварнаяКатегория
		|И	ПосадочныхМестПоПроизводителю.ПосадочныеМеста 	= 0
		|
		|ЛЕВОЕ СОЕДИНЕНИЕ ДнейНаСкладеПоПроизводителям КАК ДнейНаСкладеПоПроизводителям
		|ПО	ДнейНаСкладеПоПроизводителям.Склад 		  		= ПосадочныхМестПоПроизводителю.Склад
		|И	ДнейНаСкладеПоПроизводителям.ВидНоменклатуры 	= ПосадочныхМестПоПроизводителю.ВидНоменклатуры
		|И	ДнейНаСкладеПоПроизводителям.ТоварнаяКатегория	= ПосадочныхМестПоПроизводителю.ТоварнаяКатегория
		|И  ДнейНаСкладеПоПроизводителям.Производитель		= ПосадочныхМестПоПроизводителю.Производитель
		|
		|ГДЕ
		|	IsNull(ПосадочныхМестПоПроизводителю.ПосадочныеМеста, Неопределено) <> Неопределено
		|
		|ИНДЕКСИРОВАТЬ ПО
		|	Склад,
		|	ВидНоменклатуры,
		|	ТоварнаяКатегория,
		|	Производитель	
		|;
		////////////////////////////////////////////////////////////////////////////////
		// 40. Не распределенные посадочные места по виду номенклатуры с данными
		|ВЫБРАТЬ
		|	ПосадочныхМестПоТоварнойКатегории.Склад 			КАК Склад,
		|	ПосадочныхМестПоТоварнойКатегории.ВидНоменклатуры 	КАК ВидНоменклатуры,
		|	ПосадочныхМестПоТоварнойКатегории.ТоварнаяКатегория КАК ТоварнаяКатегория,
		|	IsNull(ДнейНаСкладеПоТоварнымКатегориям.ДНС, 0)		КАК ДНС,
		|	ПосадочныхМестПоТоварнойКатегории.НеРаспределено	КАК КоличествоМест,
		|	ПосадочныхМестПоТоварнойКатегории.НеРаспределено 
		|  - IsNull(СУММА(КоличествоАртикуловПоПроизводителям.КоличествоАртикулов), 0) КАК НеРаспределено,
		|  	ПосадочныхМестПоТоварнойКатегории.СкладПополнения КАК СкладПополнения	
		|ИЗ
		|	НеРаспределенныеПосадочныеМестаПоТоварнымКатегориямБаза КАК ПосадочныхМестПоТоварнойКатегории
		|	
		|ЛЕВОЕ СОЕДИНЕНИЕ ПроизводителиДляРаспределенияПоТоварнымКатегориям КАК ПроизводителиДляРаспределенияПоТоварнымКатегориям
		|ПО	ПроизводителиДляРаспределенияПоТоварнымКатегориям.Склад 		  	= ПосадочныхМестПоТоварнойКатегории.Склад
		|И	ПроизводителиДляРаспределенияПоТоварнымКатегориям.ВидНоменклатуры 	= ПосадочныхМестПоТоварнойКатегории.ВидНоменклатуры
		|И	ПроизводителиДляРаспределенияПоТоварнымКатегориям.ТоварнаяКатегория = ПосадочныхМестПоТоварнойКатегории.ТоварнаяКатегория
		|
		|ЛЕВОЕ СОЕДИНЕНИЕ КоличествоАртикуловПоПроизводителям КАК КоличествоАртикуловПоПроизводителям
		|ПО	КоличествоАртикуловПоПроизводителям.Склад 			  = ПроизводителиДляРаспределенияПоТоварнымКатегориям.Склад
		|И	КоличествоАртикуловПоПроизводителям.ВидНоменклатуры   = ПроизводителиДляРаспределенияПоТоварнымКатегориям.ВидНоменклатуры
		|И	КоличествоАртикуловПоПроизводителям.ТоварнаяКатегория = ПроизводителиДляРаспределенияПоТоварнымКатегориям.ТоварнаяКатегория
		|И	КоличествоАртикуловПоПроизводителям.Производитель	  = ПроизводителиДляРаспределенияПоТоварнымКатегориям.Производитель
		|
		|ЛЕВОЕ СОЕДИНЕНИЕ ДнейНаСкладеПоТоварнымКатегориям КАК ДнейНаСкладеПоТоварнымКатегориям
		|ПО	ДнейНаСкладеПоТоварнымКатегориям.Склад 		   	 	= ПосадочныхМестПоТоварнойКатегории.Склад
		|И	ДнейНаСкладеПоТоварнымКатегориям.ВидНоменклатуры 	= ПосадочныхМестПоТоварнойКатегории.ВидНоменклатуры
		|И	ДнейНаСкладеПоТоварнымКатегориям.ТоварнаяКатегория 	= ПосадочныхМестПоТоварнойКатегории.ТоварнаяКатегория
		|
		|СГРУППИРОВАТЬ ПО
		|	ПосадочныхМестПоТоварнойКатегории.Склад,
		|	ПосадочныхМестПоТоварнойКатегории.ВидНоменклатуры,
		|	ПосадочныхМестПоТоварнойКатегории.ТоварнаяКатегория,
		|	ДнейНаСкладеПоТоварнымКатегориям.ДНС,
		|	ПосадочныхМестПоТоварнойКатегории.НеРаспределено,
		|	ПосадочныхМестПоТоварнойКатегории.НомерПоПорядку,
		|	ПосадочныхМестПоТоварнойКатегории.СкладПополнения
		|	
		|УПОРЯДОЧИТЬ ПО
		|	ВЫБОР
		|		КОГДА ПосадочныхМестПоТоварнойКатегории.НомерПоПорядку = 0
		|		ТОГДА 99999
		|		ИНАЧЕ ПосадочныхМестПоТоварнойКатегории.НомерПоПорядку
		|	КОНЕЦ Возр,
		|	ДнейНаСкладеПоТоварнымКатегориям.ДНС Возр 			
		|;
		////////////////////////////////////////////////////////////////////////////////
		// 41. Производители для распределения по товарным категориям
		|ВЫБРАТЬ
		|	ПДРПТК.Склад 					КАК Склад,
		|	ПДРПТК.ВидНоменклатуры 			КАК ВидНоменклатуры,
		|	ПДРПТК.ТоварнаяКатегория 		КАК ТоварнаяКатегория,
		|	ПДРПТК.Производитель	 		КАК Производитель,		
		|  	ПДРПТК.ПосадочныеМеста 			КАК ПосадочныеМеста,
		|	ПДРПТК.ОтклонениеКоличествоПМ 	КАК ОтклонениеКоличествоПМ,
		|	ПДРПТК.НомерПоПорядку 			КАК НомерПоПорядку,
		|  	
		|  	ПДРПТК.МинимальныйЗапас 		КАК МинимальныйЗапас,
		|  	ПДРПТК.СтраховойЗапас 			КАК СтраховойЗапас,
		|  	ПДРПТК.МаксимальныйЗапас		КАК МаксимальныйЗапас,
		|  	ПДРПТК.СкладПополнения			КАК СкладПополнения	
		|ИЗ
		|	ПроизводителиДляРаспределенияПоТоварнымКатегориям КАК ПДРПТК
		|
		|УПОРЯДОЧИТЬ ПО
		|	ВЫБОР
		|		КОГДА ПДРПТК.НомерПоПорядку = 0
		|		ТОГДА 99999
		|		ИНАЧЕ ПДРПТК.НомерПоПорядку
		|	КОНЕЦ Возр,
		|	ВЫБОР
		|		КОГДА ПДРПТК.ДНС = 0
		|		ТОГДА 14
		|		ИНАЧЕ ПДРПТК.ДНС
		|	КОНЕЦ Возр
		|;
		////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ ПроизводителиДляРаспределенияПоТоварнымКатегориям;
		////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ НеРаспределенныеПосадочныеМестаПоТоварнымКатегориямБаза;
		////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ ПосадочныеИПодчиненныеМестаПоТоварнымКатегориям;
		////////////////////////////////////////////////////////////////////////////////
		// 45. Начало расчета не достающих посадочных мест по производителям 
		|ВЫБРАТЬ
		|	ПосадочныхМестПоПроизводителю.Склад 			КАК Склад,
		|	ПосадочныхМестПоПроизводителю.ВидНоменклатуры 	КАК ВидНоменклатуры,
		|	ПосадочныхМестПоПроизводителю.ТоварнаяКатегория КАК ТоварнаяКатегория,
		|	ПосадочныхМестПоПроизводителю.Производитель		КАК Производитель,
		|	СУММА(ПосадочныхМестПоНоменклатуре.ПосадочныеМеста) КАК ПодчиненныеПосадочныеМеста
		|ПОМЕСТИТЬ ПосадочныеИПодчиненныеМестаПоПроизводителям
		|ИЗ
		|	ПосадочныхМестПоПроизводителю КАК ПосадочныхМестПоПроизводителю
		|	
		|ЛЕВОЕ СОЕДИНЕНИЕ ПосадочныхМестПоНоменклатуреСДанными КАК ПосадочныхМестПоНоменклатуре
		|ПО	ПосадочныхМестПоНоменклатуре.Склад 		  		= ПосадочныхМестПоПроизводителю.Склад
		|И	ПосадочныхМестПоНоменклатуре.ВидНоменклатуры 	= ПосадочныхМестПоПроизводителю.ВидНоменклатуры
		|И	ПосадочныхМестПоНоменклатуре.ТоварнаяКатегория 	= ПосадочныхМестПоПроизводителю.ТоварнаяКатегория
		|И	ПосадочныхМестПоНоменклатуре.Производитель     	= ПосадочныхМестПоПроизводителю.Производитель
		|
		|СГРУППИРОВАТЬ ПО
		|	ПосадочныхМестПоПроизводителю.Склад,
		|	ПосадочныхМестПоПроизводителю.ВидНоменклатуры,
		|	ПосадочныхМестПоПроизводителю.ТоварнаяКатегория,
		|	ПосадочныхМестПоПроизводителю.Производитель
		|;
		////////////////////////////////////////////////////////////////////////////////
		// 46. Проверка на ошибки распределения посадочных мест
		|ВЫБРАТЬ
		|	ПосадочныхМестПоПроизводителю.Склад 			КАК Склад,
		|	ПосадочныхМестПоПроизводителю.ВидНоменклатуры 	КАК ВидНоменклатуры,
		|	ПосадочныхМестПоПроизводителю.ТоварнаяКатегория КАК ТоварнаяКатегория,
		|	ПосадочныхМестПоПроизводителю.Производитель		КАК Производитель,
		|	ПосадочныхМестПоПроизводителю.ПосадочныеМеста 
		|  - IsNull(ПосадочныеИПодчиненныеМестаПоПроизводителям.ПодчиненныеПосадочныеМеста, 0) КАК НеРаспределено,
		|  	""Нет доступных товарных категорий для произвольного заполнениям товарной матрицы, количество мест: %ОшибкаПоПроизводителю%"" КАК СообщениеОбОшибке	
		|ПОМЕСТИТЬ ОшибкиПоПроизводителям
		|ИЗ
		|	ПосадочныхМестПоПроизводителю КАК ПосадочныхМестПоПроизводителю
		|	
		|ЛЕВОЕ СОЕДИНЕНИЕ ПосадочныеИПодчиненныеМестаПоПроизводителям КАК ПосадочныеИПодчиненныеМестаПоПроизводителям
		|ПО	ПосадочныеИПодчиненныеМестаПоПроизводителям.Склад 		  	  = ПосадочныхМестПоПроизводителю.Склад
		|И	ПосадочныеИПодчиненныеМестаПоПроизводителям.ВидНоменклатуры   = ПосадочныхМестПоПроизводителю.ВидНоменклатуры
		|И	ПосадочныеИПодчиненныеМестаПоПроизводителям.ТоварнаяКатегория = ПосадочныхМестПоПроизводителю.ТоварнаяКатегория
		|И   ПосадочныеИПодчиненныеМестаПоПроизводителям.Производитель 	  = ПосадочныхМестПоПроизводителю.Производитель
		|		
		|ЛЕВОЕ СОЕДИНЕНИЕ ПосадочныхМестПоНоменклатуреСДанными КАК ПосадочныхМестПоНоменклатуре
		|ПО	ПосадочныхМестПоНоменклатуре.Склад 		  		= ПосадочныхМестПоПроизводителю.Склад
		|И	ПосадочныхМестПоНоменклатуре.ВидНоменклатуры 	= ПосадочныхМестПоПроизводителю.ВидНоменклатуры
		|И	ПосадочныхМестПоНоменклатуре.ТоварнаяКатегория 	= ПосадочныхМестПоПроизводителю.ТоварнаяКатегория
		|И	ПосадочныхМестПоНоменклатуре.Производитель		= ПосадочныхМестПоПроизводителю.Производитель		 
		|И	ПосадочныхМестПоНоменклатуре.ПосадочныеМеста 	= 0
		|
		|ГДЕ
		|	ПосадочныхМестПоПроизводителю.ПосадочныеМеста > IsNull(ПосадочныеИПодчиненныеМестаПоПроизводителям.ПодчиненныеПосадочныеМеста, 0)
		|И	ПосадочныхМестПоНоменклатуре.ПосадочныеМеста ЕСТЬ NULL	
		|;
		////////////////////////////////////////////////////////////////////////////////
		// 47. Не распределенные посадочные места по производителям без данных
		|ВЫБРАТЬ
		|	ПосадочныхМестПоПроизводителю.Склад 			КАК Склад,
		|	ПосадочныхМестПоПроизводителю.ВидНоменклатуры 	КАК ВидНоменклатуры,
		|	ПосадочныхМестПоПроизводителю.ТоварнаяКатегория КАК ТоварнаяКатегория,
		|	ПосадочныхМестПоПроизводителю.Производитель		КАК Производитель,
		|	ПосадочныхМестПоПроизводителю.НомерПоПорядку	КАК НомерПоПорядку,
		|	ПосадочныхМестПоПроизводителю.ПосадочныеМеста 
		|  - IsNull(ПосадочныеИПодчиненныеМестаПоПроизводителям.ПодчиненныеПосадочныеМеста, 0) КАК НеРаспределено,
		|  	ПосадочныхМестПоПроизводителю.СкладПополнения КАК СкладПополнения	
		|ПОМЕСТИТЬ НеРаспределенныеПосадочныеМестаПоПроизводителямБаза
		|ИЗ
		|	ПосадочныхМестПоПроизводителю КАК ПосадочныхМестПоПроизводителю
		|	
		|ЛЕВОЕ СОЕДИНЕНИЕ ПосадочныеИПодчиненныеМестаПоПроизводителям КАК ПосадочныеИПодчиненныеМестаПоПроизводителям
		|ПО	ПосадочныеИПодчиненныеМестаПоПроизводителям.Склад 		  	  = ПосадочныхМестПоПроизводителю.Склад
		|И	ПосадочныеИПодчиненныеМестаПоПроизводителям.ВидНоменклатуры   = ПосадочныхМестПоПроизводителю.ВидНоменклатуры
		|И	ПосадочныеИПодчиненныеМестаПоПроизводителям.ТоварнаяКатегория = ПосадочныхМестПоПроизводителю.ТоварнаяКатегория
		|И	ПосадочныеИПодчиненныеМестаПоПроизводителям.Производитель	  = ПосадочныхМестПоПроизводителю.Производитель
		|
		|ГДЕ
		|	ПосадочныхМестПоПроизводителю.ПосадочныеМеста > IsNull(ПосадочныеИПодчиненныеМестаПоПроизводителям.ПодчиненныеПосадочныеМеста, 0)
		|И  (ПосадочныхМестПоПроизводителю.Склад,
		|	ПосадочныхМестПоПроизводителю.ВидНоменклатуры,
		|	ПосадочныхМестПоПроизводителю.ТоварнаяКатегория,
		|	ПосадочныхМестПоПроизводителю.Производитель) НЕ В (ВЫБРАТЬ 
		|															Склад 				КАК Склад,
		|															ВидНоменклатуры 	КАК ВидНоменклатуры,
		|															ТоварнаяКатегория	КАК ТоварнаяКатегория,
		|															Производитель		КАК Производитель
		|														ИЗ
		|															ОшибкиПоПроизводителям)
		|
		|ИНДЕКСИРОВАТЬ ПО
		|	Склад,
		|	ВидНоменклатуры,
		|	ТоварнаяКатегория,
		|	Производитель	
		|;
		////////////////////////////////////////////////////////////////////////////////
		// 48. Заполнение номенклатуры, где посадочные места = 0
		|ВЫБРАТЬ
		|	ПосадочныхМестПоНоменклатуре.Склад 				КАК Склад,
		|	ПосадочныхМестПоНоменклатуре.ВидНоменклатуры 	КАК ВидНоменклатуры,
		|	ПосадочныхМестПоНоменклатуре.ТоварнаяКатегория 	КАК ТоварнаяКатегория,
		|	ПосадочныхМестПоНоменклатуре.Производитель		КАК Производитель,
		|	ПосадочныхМестПоНоменклатуре.Номенклатура		КАК Номенклатура,	
		|  	0 												КАК ПосадочныеМеста,
		|	0 												КАК ОтклонениеКоличествоПМ,
		|	ПосадочныхМестПоНоменклатуре.НомерПоПорядку 	КАК НомерПоПорядку,
		|  	IsNull(ДнейНаСкладеПоНоменклатуре.ДНС, 0)		КАК ДНС,
		|  	
		|  	ПосадочныхМестПоНоменклатуре.МинимальныйЗапас 	КАК МинимальныйЗапас,
		|  	ПосадочныхМестПоНоменклатуре.СтраховойЗапас 	КАК СтраховойЗапас,
		|  	ПосадочныхМестПоНоменклатуре.МаксимальныйЗапас	КАК МаксимальныйЗапас,
		|  	ПосадочныхМестПоНоменклатуре.СкладПополнения	КАК СкладПополнения	
		|ПОМЕСТИТЬ НоменклатураДляРаспределенияПоПроизводителям
		|ИЗ
		|	НеРаспределенныеПосадочныеМестаПоПроизводителямБаза КАК ПосадочныхМестПоПроизводителю
		|			
		|ЛЕВОЕ СОЕДИНЕНИЕ ПосадочныхМестПоНоменклатуреСДанными КАК ПосадочныхМестПоНоменклатуре
		|ПО	ПосадочныхМестПоНоменклатуре.Склад 		  		= ПосадочныхМестПоПроизводителю.Склад
		|И	ПосадочныхМестПоНоменклатуре.ВидНоменклатуры 	= ПосадочныхМестПоПроизводителю.ВидНоменклатуры
		|И	ПосадочныхМестПоНоменклатуре.ТоварнаяКатегория	= ПосадочныхМестПоПроизводителю.ТоварнаяКатегория
		|И	ПосадочныхМестПоНоменклатуре.Производитель		= ПосадочныхМестПоПроизводителю.Производитель
		|И	ПосадочныхМестПоНоменклатуре.ПосадочныеМеста 	= 0
		|
		|ЛЕВОЕ СОЕДИНЕНИЕ ДнейНаСкладеПоНоменклатуре КАК ДнейНаСкладеПоНоменклатуре
		|ПО	ДнейНаСкладеПоНоменклатуре.Склад 		  	= ПосадочныхМестПоНоменклатуре.Склад
		|И	ДнейНаСкладеПоНоменклатуре.ВидНоменклатуры 	= ПосадочныхМестПоНоменклатуре.ВидНоменклатуры
		|И	ДнейНаСкладеПоНоменклатуре.ТоварнаяКатегория= ПосадочныхМестПоНоменклатуре.ТоварнаяКатегория
		|И  ДнейНаСкладеПоНоменклатуре.Производитель	= ПосадочныхМестПоНоменклатуре.Производитель
		|И	ДнейНаСкладеПоНоменклатуре.Номенклатура		= ПосадочныхМестПоНоменклатуре.Номенклатура
		|
		|ГДЕ
		|	IsNull(ПосадочныхМестПоНоменклатуре.ПосадочныеМеста, Неопределено) <> Неопределено
		|
		|ИНДЕКСИРОВАТЬ ПО
		|	Склад,
		|	ВидНоменклатуры,
		|	ТоварнаяКатегория,
		|	Производитель,
		|	Номенклатура	
		|;
		////////////////////////////////////////////////////////////////////////////////
		// 49. Не распределенные посадочные места по производителям с данными
		|ВЫБРАТЬ
		|	ПосадочныхМестПоПроизводителю.Склад 			КАК Склад,
		|	ПосадочныхМестПоПроизводителю.ВидНоменклатуры 	КАК ВидНоменклатуры,
		|	ПосадочныхМестПоПроизводителю.ТоварнаяКатегория КАК ТоварнаяКатегория,
		|	ПосадочныхМестПоПроизводителю.Производитель		КАК Производитель,
		|	ДнейНаСкладеПоПроизводителям.ДНС				КАК ДНС,
		|	ПосадочныхМестПоПроизводителю.НеРаспределено	КАК КоличествоМест,
		|	ПосадочныхМестПоПроизводителю.НеРаспределено 
		|  - IsNull(СУММА(КоличествоАртикуловПоНоменклатуре.КоличествоАртикулов), 0) КАК НеРаспределено,
		|  	ПосадочныхМестПоПроизводителю.СкладПополнения КАК СкладПополнения	
		|ИЗ
		|	НеРаспределенныеПосадочныеМестаПоПроизводителямБаза КАК ПосадочныхМестПоПроизводителю
		|	
		|ЛЕВОЕ СОЕДИНЕНИЕ НоменклатураДляРаспределенияПоПроизводителям КАК НоменклатураДляРаспределенияПоПроизводителям
		|ПО	НоменклатураДляРаспределенияПоПроизводителям.Склад 		  	   = ПосадочныхМестПоПроизводителю.Склад
		|И	НоменклатураДляРаспределенияПоПроизводителям.ВидНоменклатуры   = ПосадочныхМестПоПроизводителю.ВидНоменклатуры
		|И	НоменклатураДляРаспределенияПоПроизводителям.ТоварнаяКатегория = ПосадочныхМестПоПроизводителю.ТоварнаяКатегория
		|И	НоменклатураДляРаспределенияПоПроизводителям.Производитель	   = ПосадочныхМестПоПроизводителю.Производитель
		|
		|ЛЕВОЕ СОЕДИНЕНИЕ КоличествоАртикуловПоНоменклатуре КАК КоличествоАртикуловПоНоменклатуре
		|ПО	КоличествоАртикуловПоНоменклатуре.Склад 			= НоменклатураДляРаспределенияПоПроизводителям.Склад
		|И	КоличествоАртикуловПоНоменклатуре.ВидНоменклатуры   = НоменклатураДляРаспределенияПоПроизводителям.ВидНоменклатуры
		|И	КоличествоАртикуловПоНоменклатуре.ТоварнаяКатегория = НоменклатураДляРаспределенияПоПроизводителям.ТоварнаяКатегория
		|И	КоличествоАртикуловПоНоменклатуре.Производитель	  	= НоменклатураДляРаспределенияПоПроизводителям.Производитель
		|И	КоличествоАртикуловПоНоменклатуре.Номенклатура	  	= НоменклатураДляРаспределенияПоПроизводителям.Номенклатура	
		|
		|ЛЕВОЕ СОЕДИНЕНИЕ ДнейНаСкладеПоПроизводителям КАК ДнейНаСкладеПоПроизводителям
		|ПО	ДнейНаСкладеПоПроизводителям.Склад 		   	 	= ПосадочныхМестПоПроизводителю.Склад
		|И	ДнейНаСкладеПоПроизводителям.ВидНоменклатуры 	= ПосадочныхМестПоПроизводителю.ВидНоменклатуры
		|И	ДнейНаСкладеПоПроизводителям.ТоварнаяКатегория 	= ПосадочныхМестПоПроизводителю.ТоварнаяКатегория
		|И	ДнейНаСкладеПоПроизводителям.Производитель 		= ПосадочныхМестПоПроизводителю.Производитель
		|
		|СГРУППИРОВАТЬ ПО
		|	ПосадочныхМестПоПроизводителю.Склад,
		|	ПосадочныхМестПоПроизводителю.ВидНоменклатуры,
		|	ПосадочныхМестПоПроизводителю.ТоварнаяКатегория,
		|	ПосадочныхМестПоПроизводителю.Производитель,
		|	ДнейНаСкладеПоПроизводителям.ДНС,
		|	ПосадочныхМестПоПроизводителю.НеРаспределено,
		|	ПосадочныхМестПоПроизводителю.НомерПоПорядку,
		|	ПосадочныхМестПоПроизводителю.СкладПополнения
		|	
		|УПОРЯДОЧИТЬ ПО
		|	ВЫБОР
		|		КОГДА ПосадочныхМестПоПроизводителю.НомерПоПорядку = 0
		|		ТОГДА 99999
		|		ИНАЧЕ ПосадочныхМестПоПроизводителю.НомерПоПорядку
		|	КОНЕЦ Возр,
		|	ДнейНаСкладеПоПроизводителям.ДНС Возр 			
		|;
		////////////////////////////////////////////////////////////////////////////////
		// 50. Номенклатура для распределения по производителям
		|ВЫБРАТЬ
		|	НДРПП.Склад 					КАК Склад,
		|	НДРПП.ВидНоменклатуры 			КАК ВидНоменклатуры,
		|	НДРПП.ТоварнаяКатегория 		КАК ТоварнаяКатегория,
		|	НДРПП.Производитель	 			КАК Производитель,
		|	НДРПП.Номенклатура				КАК Номенклатура,		
		|  	НДРПП.ПосадочныеМеста 			КАК ПосадочныеМеста,
		|	НДРПП.ОтклонениеКоличествоПМ 	КАК ОтклонениеКоличествоПМ,
		|	НДРПП.НомерПоПорядку 			КАК НомерПоПорядку,
		|  	
		|  	НДРПП.МинимальныйЗапас 			КАК МинимальныйЗапас,
		|  	НДРПП.СтраховойЗапас 			КАК СтраховойЗапас,
		|  	НДРПП.МаксимальныйЗапас			КАК МаксимальныйЗапас,
		|  	НДРПП.СкладПополнения			КАК СкладПополнения	
		|ИЗ
		|	НоменклатураДляРаспределенияПоПроизводителям КАК НДРПП
		|	
		|УПОРЯДОЧИТЬ ПО
		|	ВЫБОР
		|		КОГДА НДРПП.НомерПоПорядку = 0
		|		ТОГДА 99999
		|		ИНАЧЕ НДРПП.НомерПоПорядку
		|	КОНЕЦ Возр,
		|	ВЫБОР
		|		КОГДА НДРПП.ДНС = 0
		|		ТОГДА 14
		|		ИНАЧЕ НДРПП.ДНС
		|	КОНЕЦ Возр	
		|;
		////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ НоменклатураДляРаспределенияПоПроизводителям;
		////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ НеРаспределенныеПосадочныеМестаПоПроизводителямБаза;
		////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ ПосадочныеИПодчиненныеМестаПоПроизводителям;
		////////////////////////////////////////////////////////////////////////////////
		// 54.
		|ВЫБРАТЬ
		|	ПосадочныхМестПоНоменклатуре.Склад 				КАК Склад,
		|	ПосадочныхМестПоНоменклатуре.ВидНоменклатуры 	КАК ВидНоменклатуры,
		|	ПосадочныхМестПоНоменклатуре.ТоварнаяКатегория 	КАК ТоварнаяКатегория,
		|	ПосадочныхМестПоНоменклатуре.Производитель 		КАК Производитель,
		|	ПосадочныхМестПоНоменклатуре.Номенклатура 		КАК Номенклатура,
		|	ПосадочныхМестПоНоменклатуре.ПосадочныеМеста 		КАК ПосадочныеМеста,
		|	ПосадочныхМестПоНоменклатуре.ОтклонениеКоличествоПМ КАК ОтклонениеКоличествоПМ,
		|	ПосадочныхМестПоНоменклатуре.НомерПоПорядку 		КАК НомерПоПорядку,
		|	ПосадочныхМестПоНоменклатуре.МинимальныйЗапас 	КАК МинимальныйЗапас,
		|	ПосадочныхМестПоНоменклатуре.СтраховойЗапас 	КАК СтраховойЗапас,
		|	ПосадочныхМестПоНоменклатуре.МаксимальныйЗапас 	КАК МаксимальныйЗапас,
		|	ПосадочныхМестПоНоменклатуре.СкладПополнения 	КАК СкладПополнения,
		|	1												КАК НеРаспределено,
		|	1												КАК КоличествоМест
		|ИЗ
		|	ПосадочныхМестПоНоменклатуреСДанными КАК ПосадочныхМестПоНоменклатуре
		|ГДЕ
		|	ПосадочныхМестПоНоменклатуре.ПосадочныеМеста > 0
		|И	ПосадочныхМестПоНоменклатуре.ТКА_НМ = 0	
		|
		|УПОРЯДОЧИТЬ ПО
		|	ВЫБОР
		|		КОГДА НПП_ТК = 0
		|		ТОГДА 99999
		|		ИНАЧЕ НПП_ТК
		|	КОНЕЦ Возр,
		|	ВЫБОР
		|		КОГДА ДНС_ТК = 0
		|		ТОГДА 14
		|		ИНАЧЕ ДНС_ТК
		|	КОНЕЦ Возр,
		|	ВЫБОР
		|		КОГДА НПП_ПР = 0
		|		ТОГДА 99999
		|		ИНАЧЕ НПП_ПР
		|	КОНЕЦ Возр,
		|	ВЫБОР
		|		КОГДА ДНС_ПР = 0
		|		ТОГДА 14
		|		ИНАЧЕ ДНС_ПР
		|	КОНЕЦ Возр,
		|	ВЫБОР
		|		КОГДА НомерПоПорядку = 0
		|		ТОГДА 99999
		|		ИНАЧЕ НомерПоПорядку
		|	КОНЕЦ Возр,
		|	ВЫБОР
		|		КОГДА ДНС_НМ = 0
		|		ТОГДА 14
		|		ИНАЧЕ ДНС_НМ
		|	КОНЕЦ Возр	
		|;
		////////////////////////////////////////////////////////////////////////////////
		// 55.
		|ВЫБРАТЬ
		|	Склад 				КАК Склад,
		|	ВидНоменклатуры 	КАК ВидНоменклатуры,
		|	ТоварнаяКатегория 	КАК ТоварнаяКатегория,
		|	Производитель 		КАК Производитель,
		|	ПМПНСД.Номенклатура КАК Номенклатура,
		|	ПосадочныеМеста 		КАК ПосадочныеМеста,
		|	ОтклонениеКоличествоПМ 	КАК ОтклонениеКоличествоПМ,
		|	НомерПоПорядку 		КАК НомерПоПорядку,
		|	МинимальныйЗапас 	КАК МинимальныйЗапас,
		|	СтраховойЗапас 		КАК СтраховойЗапас,
		|	МаксимальныйЗапас 	КАК МаксимальныйЗапас,
		|	СкладПополнения 	КАК СкладПополнения,
		|	
		|	НПП_ТК КАК НПП_ТК,
		|	ДНС_ТК КАК ДНС_ТК,
		|	НПП_ПР КАК НПП_ПР,
		|	ДНС_ПР КАК ДНС_ПР,
		|	ДНС_НМ КАК ДНС_НМ,
		|	ТКА_НМ КАК ТКА_НМ,
		|	КоличествоОстаток 						КАК КоличествоОстаток,
		|	АктуальностьНоменклатуры.ДатаПоставки 	КАК ЕстьВозможностьЗаказа
		|ИЗ
		|	ПосадочныхМестПоНоменклатуреСДанными КАК ПМПНСД
		|
		|ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ALPS_АктуальностьНоменклатуры.СрезПоследних(, Номенклатура В (	ВЫБРАТЬ 
		|																						Номенклатура 
		|																					ИЗ 
		|																						ПосадочныхМестПоНоменклатуреСДанными)
		|											  ) КАК АктуальностьНоменклатуры	
		|ПО	АктуальностьНоменклатуры.Номенклатура 	  = ПМПНСД.Номенклатура
		|И	АктуальностьНоменклатуры.Актуально 		  = Истина
		|И	АктуальностьНоменклатуры.ГарантияДоставки = Истина
		|
		|	
		|УПОРЯДОЧИТЬ ПО
		|	Склад Возр,
		|	ВЫБОР
		|		КОГДА НПП_ТК = 0
		|		ТОГДА 99999
		|		ИНАЧЕ НПП_ТК
		|	КОНЕЦ Возр,
		|	ВЫБОР
		|		КОГДА ДНС_ТК = 0
		|		ТОГДА 14
		|		ИНАЧЕ ДНС_ТК
		|	КОНЕЦ Возр,
		|	ВЫБОР
		|		КОГДА НПП_ПР = 0
		|		ТОГДА 99999
		|		ИНАЧЕ НПП_ПР
		|	КОНЕЦ Возр,
		|	ВЫБОР
		|		КОГДА ДНС_ПР = 0
		|		ТОГДА 14
		|		ИНАЧЕ ДНС_ПР
		|	КОНЕЦ Возр,
		|	ВЫБОР
		|		КОГДА НомерПоПорядку = 0
		|		ТОГДА 99999
		|		ИНАЧЕ НомерПоПорядку
		|	КОНЕЦ Возр,
		|	ВЫБОР
		|		КОГДА ДНС_НМ = 0
		|		ТОГДА 14
		|		ИНАЧЕ ДНС_НМ
		|	КОНЕЦ Возр
		|	
		|;
		////////////////////////////////////////////////////////////////////////////////
		// 56. Получим остатки на распределительных складах
		|ВЫБРАТЬ
		|	СвободныеОстатки.Склад							КАК СкладПополнения,
		|	СвободныеОстатки.Номенклатура.ВидНоменклатуры 	КАК ВидНоменклатуры,
		|	СвободныеОстатки.Номенклатура.ТоварнаяКатегория КАК ТоварнаяКатегория,
		|	СвободныеОстатки.Номенклатура.Производитель 	КАК Производитель,	
		|	СвободныеОстатки.Номенклатура					КАК Номенклатура,
		|	СвободныеОстатки.ВНаличииОстаток - СвободныеОстатки.ВРезервеОстаток КАК КоличествоОстаток
		|ИЗ
		|	РегистрНакопления.СвободныеОстатки.Остатки(, (Номенклатура, Склад) В (	ВЫБРАТЬ 
		|																				Номенклатура, 
		|																				СкладПополнения 
		|																			ИЗ 
		|																				ПосадочныхМестПоНоменклатуреСДанными)
		|											  ) КАК СвободныеОстатки	
		|ГДЕ
		|	IsNull(СвободныеОстатки.ВНаличииОстаток, 0) - IsNull(СвободныеОстатки.ВРезервеОстаток, 0) > 0	
		|;
		////////////////////////////////////////////////////////////////////////////////
		// 57. Получим актуальность на распределительных складах
		|ВЫБРАТЬ
		|	АктуальностьНоменклатуры.Номенклатура.ВидНоменклатуры 	КАК ВидНоменклатуры,
		|	АктуальностьНоменклатуры.Номенклатура.ТоварнаяКатегория КАК ТоварнаяКатегория,
		|	АктуальностьНоменклатуры.Номенклатура.Производитель 	КАК Производитель,	
		|	АктуальностьНоменклатуры.Номенклатура					КАК Номенклатура,
		|	АктуальностьНоменклатуры.ДатаПоставки					КАК ДатаПоставки
		|ИЗ
		|	РегистрСведений.ALPS_АктуальностьНоменклатуры.СрезПоследних(, Номенклатура В (	ВЫБРАТЬ 
		|																						Номенклатура 
		|																					ИЗ 
		|																						ПосадочныхМестПоНоменклатуреСДанными)
		|											  ) КАК АктуальностьНоменклатуры	
		|ГДЕ
		|	Актуально = Истина
		|И	ГарантияДоставки = Истина	
		|;
		////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ ПосадочныхМестПоВидуНоменклатуры;
		////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ ПосадочныхМестПоТоварнойКатегории;
		////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ ПосадочныхМестПоПроизводителю;
		////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ ПосадочныхМестПоНоменклатуреСДанными;
		////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ КоличествоАртикуловПоВидуНоменклатуры;
		////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ КоличествоАртикуловПоТоварнымКатегориям;
		////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ КоличествоАртикуловПоПроизводителям;
		////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ КоличествоАртикуловПоНоменклатуре;
		////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ ДнейНаСкладеПоВидуНоменклатуры;
		////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ ДнейНаСкладеПоТоварнымКатегориям;
		////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ ДнейНаСкладеПоПроизводителям;
		////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ ДнейНаСкладеПоНоменклатуре;
		////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ ОшибкиПоВидуНоменклатуры;
		////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ ОшибкиПоТоварнымКатегориям;
		////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ ОшибкиПоПроизводителям;
		////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ СкладыВМатрице;
		////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ ПредСкладыВМатрице;
		////////////////////////////////////////////////////////////////////////////////
		|";
	Возврат ТекстЗапроса;

КонецФункции // ПолучитьТекстЗапросаОбщегоЗаказа()

Функция ПолучитьТекстЗапросаАналитикаТоварыКОтъезду()

	ТекстЗапроса = "
		////////////////////////////////////////////////////////////////////////////////////////////
		// 0. Получаем свободные остатки по магазину
		|ВЫБРАТЬ
		|	СвободныеОстатки.Номенклатура КАК Номенклатура,
		|	СвободныеОстатки.Номенклатура.ВидНоменклатуры КАК ВидНоменклатуры,
		|	СвободныеОстатки.Номенклатура.ТоварнаяКатегория КАК ТоварнаяКатегория,
		|	СвободныеОстатки.Номенклатура.Производитель КАК Производитель,
		|	СвободныеОстатки.Характеристика КАК Характеристика,
		|	СвободныеОстатки.Склад			КАК Склад,
		|	СвободныеОстатки.ВНаличииОстаток 
		|  - СвободныеОстатки.ВРезервеОстаток КАК СвободныйОстаток
		|ПОМЕСТИТЬ КешСвободныхОстатков
		|ИЗ
		|	РегистрНакопления.СвободныеОстатки.Остатки(, %1 ) КАК СвободныеОстатки
		|;
		////////////////////////////////////////////////////////////////////////////////////////////
		// 1. Товары без заполненной товарной категории
		|ВЫБРАТЬ
		|	КешСвободныхОстатков.Склад				КАК Склад,
		|	КешСвободныхОстатков.ВидНоменклатуры	КАК ВидНоменклатуры,
		|	КешСвободныхОстатков.ТоварнаяКатегория 	КАК ТоварнаяКатегория,
		|	КешСвободныхОстатков.Производитель		КАК Производитель,
		|	КешСвободныхОстатков.Номенклатура		КАК Номенклатура,
		|	КешСвободныхОстатков.Характеристика		КАК Характеристика,
		|	КешСвободныхОстатков.СвободныйОстаток	КАК СвободныйОстаток,
		|	""Товарная категория не заполнена!""	КАК	ПричинаОтъезда
		|ПОМЕСТИТЬ КешТкПустая
		|ИЗ
		|	КешСвободныхОстатков КАК КешСвободныхОстатков
		|ГДЕ
		|	КешСвободныхОстатков.ТоварнаяКатегория = ЗНАЧЕНИЕ(Справочник.ТоварныеКатегории.ПустаяСсылка)
		|И	КешСвободныхОстатков.Производитель	  <> ЗНАЧЕНИЕ(Справочник.Производители.ПустаяСсылка)
		|;
		////////////////////////////////////////////////////////////////////////////////////////////
		// 2. Товары без заполненного производителя
		|ВЫБРАТЬ
		|	КешСвободныхОстатков.Склад				КАК Склад,
		|	КешСвободныхОстатков.ВидНоменклатуры	КАК ВидНоменклатуры,
		|	КешСвободныхОстатков.ТоварнаяКатегория 	КАК ТоварнаяКатегория,
		|	КешСвободныхОстатков.Производитель		КАК Производитель,
		|	КешСвободныхОстатков.Номенклатура		КАК Номенклатура,
		|	КешСвободныхОстатков.Характеристика		КАК Характеристика,
		|	КешСвободныхОстатков.СвободныйОстаток	КАК СвободныйОстаток,
		|	""Производитель не заполнен!""			КАК	ПричинаОтъезда
		|ПОМЕСТИТЬ КешПрПустая
		|ИЗ
		|	КешСвободныхОстатков КАК КешСвободныхОстатков
		|ГДЕ
		|	КешСвободныхОстатков.ТоварнаяКатегория <> ЗНАЧЕНИЕ(Справочник.ТоварныеКатегории.ПустаяСсылка)
		|И	КешСвободныхОстатков.Производитель	    = ЗНАЧЕНИЕ(Справочник.Производители.ПустаяСсылка)
		|
		|;
		////////////////////////////////////////////////////////////////////////////////////////////
		// 3. Товары без заполненного производителя и товарной категории
		|ВЫБРАТЬ
		|	КешСвободныхОстатков.Склад				КАК Склад,
		|	КешСвободныхОстатков.ВидНоменклатуры	КАК ВидНоменклатуры,
		|	КешСвободныхОстатков.ТоварнаяКатегория 	КАК ТоварнаяКатегория,
		|	КешСвободныхОстатков.Производитель		КАК Производитель,
		|	КешСвободныхОстатков.Номенклатура		КАК Номенклатура,
		|	КешСвободныхОстатков.Характеристика		КАК Характеристика,
		|	КешСвободныхОстатков.СвободныйОстаток	КАК СвободныйОстаток,
		|	""Производитель и товарная категория не заполнены!"" КАК ПричинаОтъезда
		|ПОМЕСТИТЬ КешТкПрПустая
		|ИЗ
		|	КешСвободныхОстатков КАК КешСвободныхОстатков
		|ГДЕ
		|	КешСвободныхОстатков.ТоварнаяКатегория  = ЗНАЧЕНИЕ(Справочник.ТоварныеКатегории.ПустаяСсылка)
		|И	КешСвободныхОстатков.Производитель	    = ЗНАЧЕНИЕ(Справочник.Производители.ПустаяСсылка)
		|
		|;
		////////////////////////////////////////////////////////////////////////////////////////////
		// 4. Исключенный ассортимент магазина
		|ВЫБРАТЬ
		|	УАМ.Склад,
		|	УАМ.ВидНоменклатуры,
		|	УАМ.ТоварнаяКатегория,
		|	УАМ.Производитель,
		|	УАМ.Номенклатура,
		|	УАМ.Исключено
		|ПОМЕСТИТЬ НастройкиИсключеноИзАссортимента
		|ИЗ
		|	РегистрСведений.АМ_УправлениеАссортиментнойМатрицей.СрезПоследних(, %2 ) КАК УАМ
		|ГДЕ
		|	УАМ.Исключено = Истина
		|И	УАМ.КонтрольМатрицейОтключен = Ложь
		|;
		////////////////////////////////////////////////////////////////////////////////////////////
		// 5. Контроль отключен по управлению ассортиментом
		|ВЫБРАТЬ
		|	УАМ.Склад,
		|	УАМ.ВидНоменклатуры,
		|	УАМ.ТоварнаяКатегория,
		|	УАМ.Производитель,
		|	УАМ.Номенклатура,
		|	УАМ.КонтрольМатрицейОтключен
		|ПОМЕСТИТЬ НастройкиОтключенКонтроль
		|ИЗ                                                                            
		|	РегистрСведений.АМ_УправлениеАссортиментнойМатрицей.СрезПоследних(, %2 ) КАК УАМ
		|ГДЕ
		|	УАМ.КонтрольМатрицейОтключен = Истина	
		|;
		////////////////////////////////////////////////////////////////////////////////////////////
		// 6.
		|ВЫБРАТЬ
		|	КешСвободныхОстатков.Склад				КАК Склад,
		|	КешСвободныхОстатков.ВидНоменклатуры	КАК ВидНоменклатуры,
		|	КешСвободныхОстатков.ТоварнаяКатегория 	КАК ТоварнаяКатегория,
		|	КешСвободныхОстатков.Производитель		КАК Производитель,
		|	КешСвободныхОстатков.Номенклатура		КАК Номенклатура,
		|	КешСвободныхОстатков.Характеристика		КАК Характеристика,
		|	КешСвободныхОстатков.СвободныйОстаток	КАК СвободныйОстаток,
		|	""Товар исключен из матрицы магазина!"" КАК ПричинаОтъезда		
		|ПОМЕСТИТЬ КешИсключеноИзАссортимента	
		|ИЗ
		|	КешСвободныхОстатков КАК КешСвободныхОстатков
		|	
		|ЛЕВОЕ СОЕДИНЕНИЕ НастройкиИсключеноИзАссортимента КАК ИсключеноПоВидуНоменклатуры
		|ПО	ИсключеноПоВидуНоменклатуры.Склад 				= КешСвободныхОстатков.Склад 
		|И	ИсключеноПоВидуНоменклатуры.ВидНоменклатуры 	= КешСвободныхОстатков.ВидНоменклатуры
		|И	ИсключеноПоВидуНоменклатуры.ТоварнаяКатегория 	= ЗНАЧЕНИЕ(Справочник.ТоварныеКатегории.ПустаяСсылка)
		|И	ИсключеноПоВидуНоменклатуры.Производитель 		= ЗНАЧЕНИЕ(Справочник.Производители.ПустаяСсылка)
		|И	ИсключеноПоВидуНоменклатуры.Номенклатура 		= ЗНАЧЕНИЕ(Справочник.Номенклатура.ПустаяСсылка)
		|
		|ЛЕВОЕ СОЕДИНЕНИЕ НастройкиИсключеноИзАссортимента КАК ИсключеноПоТоварнойКатегории
		|ПО	ИсключеноПоТоварнойКатегории.Склад 				= КешСвободныхОстатков.Склад 
		|И	ИсключеноПоТоварнойКатегории.ВидНоменклатуры 	= КешСвободныхОстатков.ВидНоменклатуры
		|И	ИсключеноПоТоварнойКатегории.ТоварнаяКатегория 	= КешСвободныхОстатков.ТоварнаяКатегория
		|И	ИсключеноПоТоварнойКатегории.Производитель 		= ЗНАЧЕНИЕ(Справочник.Производители.ПустаяСсылка)
		|И	ИсключеноПоТоварнойКатегории.Номенклатура 		= ЗНАЧЕНИЕ(Справочник.Номенклатура.ПустаяСсылка)
		|
		|ЛЕВОЕ СОЕДИНЕНИЕ НастройкиИсключеноИзАссортимента КАК ИсключеноПоПроизводителю
		|ПО	ИсключеноПоПроизводителю.Склад 				= КешСвободныхОстатков.Склад 
		|И	ИсключеноПоПроизводителю.ВидНоменклатуры 	= КешСвободныхОстатков.ВидНоменклатуры
		|И	ИсключеноПоПроизводителю.ТоварнаяКатегория 	= КешСвободныхОстатков.ТоварнаяКатегория
		|И	ИсключеноПоПроизводителю.Производитель 		= КешСвободныхОстатков.Производитель
		|И	ИсключеноПоПроизводителю.Номенклатура 		= ЗНАЧЕНИЕ(Справочник.Номенклатура.ПустаяСсылка)
		|
		|ЛЕВОЕ СОЕДИНЕНИЕ НастройкиИсключеноИзАссортимента КАК ИсключеноПоНоменклатуре
		|ПО	ИсключеноПоНоменклатуре.Склад 				= КешСвободныхОстатков.Склад 
		|И	ИсключеноПоНоменклатуре.ВидНоменклатуры 	= КешСвободныхОстатков.ВидНоменклатуры
		|И	ИсключеноПоНоменклатуре.ТоварнаяКатегория 	= КешСвободныхОстатков.ТоварнаяКатегория
		|И	ИсключеноПоНоменклатуре.Производитель 		= КешСвободныхОстатков.Производитель
		|И	ИсключеноПоНоменклатуре.Номенклатура 		= КешСвободныхОстатков.Номенклатура
		|
		|
		|ЛЕВОЕ СОЕДИНЕНИЕ НастройкиОтключенКонтроль КАК ОтключеноПоВидуНоменклатуры
		|ПО	ОтключеноПоВидуНоменклатуры.Склад 				= КешСвободныхОстатков.Склад 
		|И	ОтключеноПоВидуНоменклатуры.ВидНоменклатуры 	= КешСвободныхОстатков.ВидНоменклатуры
		|И	ОтключеноПоВидуНоменклатуры.ТоварнаяКатегория 	= ЗНАЧЕНИЕ(Справочник.ТоварныеКатегории.ПустаяСсылка)
		|И	ОтключеноПоВидуНоменклатуры.Производитель 		= ЗНАЧЕНИЕ(Справочник.Производители.ПустаяСсылка)
		|И	ОтключеноПоВидуНоменклатуры.Номенклатура 		= ЗНАЧЕНИЕ(Справочник.Номенклатура.ПустаяСсылка)
		|
		|ЛЕВОЕ СОЕДИНЕНИЕ НастройкиОтключенКонтроль КАК ОтключеноПоТоварнойКатегории
		|ПО	ОтключеноПоТоварнойКатегории.Склад 				= КешСвободныхОстатков.Склад 
		|И	ОтключеноПоТоварнойКатегории.ВидНоменклатуры 	= КешСвободныхОстатков.ВидНоменклатуры
		|И	ОтключеноПоТоварнойКатегории.ТоварнаяКатегория 	= КешСвободныхОстатков.ТоварнаяКатегория
		|И	ОтключеноПоТоварнойКатегории.Производитель 		= ЗНАЧЕНИЕ(Справочник.Производители.ПустаяСсылка)
		|И	ОтключеноПоТоварнойКатегории.Номенклатура 		= ЗНАЧЕНИЕ(Справочник.Номенклатура.ПустаяСсылка)
		|
		|ЛЕВОЕ СОЕДИНЕНИЕ НастройкиОтключенКонтроль КАК ОтключеноПоПроизводителю
		|ПО	ОтключеноПоПроизводителю.Склад 				= КешСвободныхОстатков.Склад 
		|И	ОтключеноПоПроизводителю.ВидНоменклатуры 	= КешСвободныхОстатков.ВидНоменклатуры
		|И	ОтключеноПоПроизводителю.ТоварнаяКатегория 	= КешСвободныхОстатков.ТоварнаяКатегория
		|И	ОтключеноПоПроизводителю.Производитель 		= КешСвободныхОстатков.Производитель
		|И	ОтключеноПоПроизводителю.Номенклатура 		= ЗНАЧЕНИЕ(Справочник.Номенклатура.ПустаяСсылка)
		|
		|ЛЕВОЕ СОЕДИНЕНИЕ НастройкиОтключенКонтроль КАК ОтключеноПоНоменклатуре
		|ПО	ОтключеноПоНоменклатуре.Склад 				= КешСвободныхОстатков.Склад 
		|И	ОтключеноПоНоменклатуре.ВидНоменклатуры 	= КешСвободныхОстатков.ВидНоменклатуры
		|И	ОтключеноПоНоменклатуре.ТоварнаяКатегория 	= КешСвободныхОстатков.ТоварнаяКатегория
		|И	ОтключеноПоНоменклатуре.Производитель 		= КешСвободныхОстатков.Производитель
		|И	ОтключеноПоНоменклатуре.Номенклатура 		= КешСвободныхОстатков.Номенклатура
		|   
		|ГДЕ
		|	КешСвободныхОстатков.ТоварнаяКатегория  <> ЗНАЧЕНИЕ(Справочник.ТоварныеКатегории.ПустаяСсылка)
		|И	КешСвободныхОстатков.Производитель	    <> ЗНАЧЕНИЕ(Справочник.Производители.ПустаяСсылка)
		|И 	ВЫБОР
		|		КОГДА IsNull(ОтключеноПоВидуНоменклатуры.КонтрольМатрицейОтключен, ЛОЖЬ) = ИСТИНА
		|			ТОГДА ЛОЖЬ
		|		КОГДА IsNull(ОтключеноПоТоварнойКатегории.КонтрольМатрицейОтключен, ЛОЖЬ) = ИСТИНА
		|			ТОГДА ЛОЖЬ
		|		КОГДА IsNull(ОтключеноПоПроизводителю.КонтрольМатрицейОтключен, ЛОЖЬ) = ИСТИНА
		|			ТОГДА ЛОЖЬ
		|		КОГДА IsNull(ОтключеноПоНоменклатуре.КонтрольМатрицейОтключен, ЛОЖЬ) = ИСТИНА
		|			ТОГДА ЛОЖЬ
		|		ИНАЧЕ ИСТИНА
		|	КОНЕЦ
		|И	ВЫБОР
		|		КОГДА IsNull(ИсключеноПоВидуНоменклатуры.Исключено, ЛОЖЬ) = ИСТИНА
		|			ТОГДА ИСТИНА
		|		КОГДА IsNull(ИсключеноПоТоварнойКатегории.Исключено, ЛОЖЬ) = ИСТИНА
		|			ТОГДА ИСТИНА
		|		КОГДА IsNull(ИсключеноПоПроизводителю.Исключено, ЛОЖЬ) = ИСТИНА
		|			ТОГДА ИСТИНА
		|		КОГДА IsNull(ИсключеноПоНоменклатуре.Исключено, ЛОЖЬ) = ИСТИНА
		|			ТОГДА ИСТИНА		
		|		ИНАЧЕ ЛОЖЬ
		|	КОНЕЦ
		|;
		////////////////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ НастройкиОтключенКонтроль;
		////////////////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ НастройкиИсключеноИзАссортимента;
		////////////////////////////////////////////////////////////////////////////////////////////
		// 7.
		|ВЫБРАТЬ
		|	Склад,
		|	ВидНоменклатуры,
		|	ТоварнаяКатегория,
		|	Производитель,
		|	Номенклатура,
		|	МинимальныйЗапас,
		|	МаксимальныйЗапас,	
		|	Исключено,
		|	КонтрольМатрицейОтключен
		|ПОМЕСТИТЬ НастройкиПерегрузАссортимента
		|ИЗ                                                                           
		|	РегистрСведений.АМ_УправлениеАссортиментнойМатрицей.СрезПоследних(, %2 )	
		|;
		////////////////////////////////////////////////////////////////////////////////////////////
		// 8.
		|ВЫБРАТЬ
		|	КешСвободныхОстатков.Склад				КАК Склад,
		|	КешСвободныхОстатков.ВидНоменклатуры	КАК ВидНоменклатуры,
		|	КешСвободныхОстатков.ТоварнаяКатегория 	КАК ТоварнаяКатегория,
		|	КешСвободныхОстатков.Производитель		КАК Производитель,
		|	КешСвободныхОстатков.Номенклатура		КАК Номенклатура,
		|	КешСвободныхОстатков.Характеристика		КАК Характеристика,
		|	КешСвободныхОстатков.СвободныйОстаток	КАК СвободныйОстаток,
		|	ВЫБОР
		|		КОГДА IsNull(НеВАссортиментеПоНоменклатуре.МинимальныйЗапас, 0) <> 0
		|		  ИЛИ IsNull(НеВАссортиментеПоНоменклатуре.МаксимальныйЗапас, 0)<> 0		
		|			ТОГДА НеВАссортиментеПоНоменклатуре.МинимальныйЗапас
		|		КОГДА IsNull(НеВАссортиментеПоПроизводителю.МинимальныйЗапас, 0) <> 0
		|		  ИЛИ IsNull(НеВАссортиментеПоПроизводителю.МаксимальныйЗапас, 0)<> 0
		|			ТОГДА НеВАссортиментеПоПроизводителю.МинимальныйЗапас
		|		КОГДА IsNull(НеВАссортиментеПоТоварнойКатегории.МинимальныйЗапас, 0) <> 0
		|		  ИЛИ IsNull(НеВАссортиментеПоТоварнойКатегории.МаксимальныйЗапас, 0)<> 0
		|			ТОГДА НеВАссортиментеПоТоварнойКатегории.МинимальныйЗапас
		|		КОГДА IsNull(НеВАссортиментеПоВидуНоменклатуры.МинимальныйЗапас, 0) <> 0
		|		  ИЛИ IsNull(НеВАссортиментеПоВидуНоменклатуры.МаксимальныйЗапас, 0)<> 0
		|			ТОГДА НеВАссортиментеПоВидуНоменклатуры.МинимальныйЗапас
		|		ИНАЧЕ
		|			0
		|	КОНЕЦ КАК МинимальныйЗапас,
		|	ВЫБОР
		|		КОГДА IsNull(НеВАссортиментеПоНоменклатуре.МинимальныйЗапас, 0) <> 0
		|		  ИЛИ IsNull(НеВАссортиментеПоНоменклатуре.МаксимальныйЗапас, 0)<> 0
		|			ТОГДА НеВАссортиментеПоНоменклатуре.МаксимальныйЗапас
		|		КОГДА IsNull(НеВАссортиментеПоПроизводителю.МинимальныйЗапас, 0) <> 0
		|		  ИЛИ IsNull(НеВАссортиментеПоПроизводителю.МаксимальныйЗапас, 0)<> 0
		|			ТОГДА НеВАссортиментеПоПроизводителю.МаксимальныйЗапас
		|		КОГДА IsNull(НеВАссортиментеПоТоварнойКатегории.МинимальныйЗапас, 0) <> 0
		|		  ИЛИ IsNull(НеВАссортиментеПоТоварнойКатегории.МаксимальныйЗапас, 0)<> 0
		|			ТОГДА НеВАссортиментеПоТоварнойКатегории.МаксимальныйЗапас
		|		КОГДА IsNull(НеВАссортиментеПоВидуНоменклатуры.МинимальныйЗапас, 0) <> 0
		|		  ИЛИ IsNull(НеВАссортиментеПоВидуНоменклатуры.МаксимальныйЗапас, 0)<> 0
		|			ТОГДА НеВАссортиментеПоВидуНоменклатуры.МаксимальныйЗапас
		|		ИНАЧЕ
		|			0
		|	КОНЕЦ КАК МаксимальныйЗапас,
		|	""Товара больше чем мин.\макс. запас в матрице магазина!"" КАК ПричинаОтъезда	
		| 		 
		|ПОМЕСТИТЬ КешПерегрузАссортимента	
		|ИЗ
		|	КешСвободныхОстатков КАК КешСвободныхОстатков
		|	
		|ЛЕВОЕ СОЕДИНЕНИЕ НастройкиПерегрузАссортимента КАК НеВАссортиментеПоВидуНоменклатуры
		|ПО	НеВАссортиментеПоВидуНоменклатуры.Склад = КешСвободныхОстатков.Склад 
		|И	НеВАссортиментеПоВидуНоменклатуры.ВидНоменклатуры = КешСвободныхОстатков.ВидНоменклатуры
		|И	НеВАссортиментеПоВидуНоменклатуры.ТоварнаяКатегория = ЗНАЧЕНИЕ(Справочник.ТоварныеКатегории.ПустаяСсылка)
		|И	НеВАссортиментеПоВидуНоменклатуры.Производитель = ЗНАЧЕНИЕ(Справочник.Производители.ПустаяСсылка)
		|И	НеВАссортиментеПоВидуНоменклатуры.Номенклатура = ЗНАЧЕНИЕ(Справочник.Номенклатура.ПустаяСсылка) 
		|
		|ЛЕВОЕ СОЕДИНЕНИЕ НастройкиПерегрузАссортимента КАК НеВАссортиментеПоТоварнойКатегории
		|ПО	НеВАссортиментеПоТоварнойКатегории.Склад = КешСвободныхОстатков.Склад 
		|И	НеВАссортиментеПоТоварнойКатегории.ВидНоменклатуры = КешСвободныхОстатков.ВидНоменклатуры 
		|И	НеВАссортиментеПоТоварнойКатегории.ТоварнаяКатегория = КешСвободныхОстатков.ТоварнаяКатегория
		|И	НеВАссортиментеПоТоварнойКатегории.Производитель = ЗНАЧЕНИЕ(Справочник.Производители.ПустаяСсылка)
		|И	НеВАссортиментеПоТоварнойКатегории.Номенклатура = ЗНАЧЕНИЕ(Справочник.Номенклатура.ПустаяСсылка) 
		|
		|ЛЕВОЕ СОЕДИНЕНИЕ НастройкиПерегрузАссортимента КАК НеВАссортиментеПоПроизводителю
		|ПО	НеВАссортиментеПоПроизводителю.Склад = КешСвободныхОстатков.Склад 
		|И	НеВАссортиментеПоПроизводителю.ВидНоменклатуры = КешСвободныхОстатков.ВидНоменклатуры 
		|И	НеВАссортиментеПоПроизводителю.ТоварнаяКатегория = КешСвободныхОстатков.ТоварнаяКатегория
		|И	НеВАссортиментеПоПроизводителю.Производитель = КешСвободныхОстатков.Производитель
		|И	НеВАссортиментеПоПроизводителю.Номенклатура = ЗНАЧЕНИЕ(Справочник.Номенклатура.ПустаяСсылка)
		|
		|ЛЕВОЕ СОЕДИНЕНИЕ НастройкиПерегрузАссортимента КАК НеВАссортиментеПоНоменклатуре
		|ПО	НеВАссортиментеПоНоменклатуре.Склад = КешСвободныхОстатков.Склад 
		|И	НеВАссортиментеПоНоменклатуре.ВидНоменклатуры = КешСвободныхОстатков.ВидНоменклатуры 
		|И	НеВАссортиментеПоНоменклатуре.ТоварнаяКатегория = КешСвободныхОстатков.ТоварнаяКатегория
		|И	НеВАссортиментеПоНоменклатуре.Производитель = КешСвободныхОстатков.Производитель
		|И	НеВАссортиментеПоНоменклатуре.Номенклатура = КешСвободныхОстатков.Номенклатура
		|    
		|ГДЕ
		|	КешСвободныхОстатков.ТоварнаяКатегория  <> ЗНАЧЕНИЕ(Справочник.ТоварныеКатегории.ПустаяСсылка)
		|И	КешСвободныхОстатков.Производитель	    <> ЗНАЧЕНИЕ(Справочник.Производители.ПустаяСсылка)
		|И	ВЫБОР
		|		КОГДА IsNull(НеВАссортиментеПоНоменклатуре.Исключено, ЛОЖЬ) <> ЛОЖЬ
		|			ТОГДА НеВАссортиментеПоНоменклатуре.Исключено
		|		КОГДА IsNull(НеВАссортиментеПоПроизводителю.Исключено, ЛОЖЬ) <> ЛОЖЬ
		|			ТОГДА НеВАссортиментеПоПроизводителю.Исключено
		|		КОГДА IsNull(НеВАссортиментеПоТоварнойКатегории.Исключено, ЛОЖЬ) <> ЛОЖЬ
		|			ТОГДА НеВАссортиментеПоТоварнойКатегории.Исключено
		|		КОГДА IsNull(НеВАссортиментеПоВидуНоменклатуры.Исключено, ЛОЖЬ) <> ЛОЖЬ
		|			ТОГДА НеВАссортиментеПоВидуНоменклатуры.Исключено
		|		ИНАЧЕ ЛОЖЬ
		|	КОНЕЦ = ЛОЖЬ
		|И	ВЫБОР
		|		КОГДА IsNull(НеВАссортиментеПоНоменклатуре.КонтрольМатрицейОтключен, ЛОЖЬ) <> ЛОЖЬ
		|			ТОГДА НеВАссортиментеПоНоменклатуре.КонтрольМатрицейОтключен
		|		КОГДА IsNull(НеВАссортиментеПоПроизводителю.КонтрольМатрицейОтключен, ЛОЖЬ) <> ЛОЖЬ
		|			ТОГДА НеВАссортиментеПоПроизводителю.КонтрольМатрицейОтключен
		|		КОГДА IsNull(НеВАссортиментеПоТоварнойКатегории.КонтрольМатрицейОтключен, ЛОЖЬ) <> ЛОЖЬ
		|			ТОГДА НеВАссортиментеПоТоварнойКатегории.КонтрольМатрицейОтключен
		|		КОГДА IsNull(НеВАссортиментеПоВидуНоменклатуры.КонтрольМатрицейОтключен, ЛОЖЬ) <> ЛОЖЬ
		|			ТОГДА НеВАссортиментеПоВидуНоменклатуры.КонтрольМатрицейОтключен
		|		ИНАЧЕ ЛОЖЬ
		|	КОНЕЦ = ЛОЖЬ
		|	
		|;
		////////////////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ НастройкиПерегрузАссортимента; 
		////////////////////////////////////////////////////////////////////////////////////////////
		// 10.
		|ВЫБРАТЬ
		|	КешПерегрузАссортимента.Склад				КАК Склад,
		|	КешПерегрузАссортимента.ВидНоменклатуры		КАК ВидНоменклатуры,
		|	КешПерегрузАссортимента.ТоварнаяКатегория 	КАК ТоварнаяКатегория,
		|	КешПерегрузАссортимента.Производитель		КАК Производитель,
		|	КешПерегрузАссортимента.Номенклатура		КАК Номенклатура,
		|	КешПерегрузАссортимента.Характеристика		КАК Характеристика,
		|	ВЫБОР
		|		КОГДА КешПерегрузАссортимента.МаксимальныйЗапас = 0
		|			ТОГДА КешПерегрузАссортимента.СвободныйОстаток - КешПерегрузАссортимента.МинимальныйЗапас
		|		ИНАЧЕ КешПерегрузАссортимента.СвободныйОстаток - КешПерегрузАссортимента.МаксимальныйЗапас
		|	КОНЕЦ КАК Количество,
		|	КешПерегрузАссортимента.ПричинаОтъезда		КАК ПричинаОтъезда
		|ИЗ
		|	КешПерегрузАссортимента КАК КешПерегрузАссортимента
		|ГДЕ
		|	(КешПерегрузАссортимента.МаксимальныйЗапас <> 0
		|  И КешПерегрузАссортимента.СвободныйОстаток > КешПерегрузАссортимента.МаксимальныйЗапас)
		|ИЛИ		
		|  	(КешПерегрузАссортимента.МаксимальныйЗапас = 0
		|  И КешПерегрузАссортимента.СвободныйОстаток > КешПерегрузАссортимента.МинимальныйЗапас)
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ
		|	ИсключеноИзАссортимента.Склад,
		|	ИсключеноИзАссортимента.ВидНоменклатуры,
		|	ИсключеноИзАссортимента.ТоварнаяКатегория,
		|	ИсключеноИзАссортимента.Производитель,
		|	ИсключеноИзАссортимента.Номенклатура,
		|	ИсключеноИзАссортимента.Характеристика,
		|	ИсключеноИзАссортимента.СвободныйОстаток,
		|	ИсключеноИзАссортимента.ПричинаОтъезда
		|ИЗ
		|	КешИсключеноИзАссортимента КАК ИсключеноИзАссортимента	
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ
		|	КешТкПустая.Склад,
		|	КешТкПустая.ВидНоменклатуры,
		|	КешТкПустая.ТоварнаяКатегория,
		|	КешТкПустая.Производитель,
		|	КешТкПустая.Номенклатура,
		|	КешТкПустая.Характеристика,
		|	КешТкПустая.СвободныйОстаток,
		|	КешТкПустая.ПричинаОтъезда
		|ИЗ
		|	КешТкПустая КАК КешТкПустая	
		|
		|ОБЪЕДИНИТЬ ВСЕ 
		|
		|ВЫБРАТЬ
		|	КешПрПустая.Склад,
		|	КешПрПустая.ВидНоменклатуры,
		|	КешПрПустая.ТоварнаяКатегория,
		|	КешПрПустая.Производитель,
		|	КешПрПустая.Номенклатура,
		|	КешПрПустая.Характеристика,
		|	КешПрПустая.СвободныйОстаток,
		|	КешПрПустая.ПричинаОтъезда
		|ИЗ
		|	КешПрПустая КАК КешПрПустая	
		|	
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ
		|	КешТкПрПустая.Склад,
		|	КешТкПрПустая.ВидНоменклатуры,
		|	КешТкПрПустая.ТоварнаяКатегория,
		|	КешТкПрПустая.Производитель,
		|	КешТкПрПустая.Номенклатура,
		|	КешТкПрПустая.Характеристика,
		|	КешТкПрПустая.СвободныйОстаток,
		|	КешТкПрПустая.ПричинаОтъезда
		|ИЗ
		|	КешТкПрПустая КАК КешТкПрПустая
		|	
		|УПОРЯДОЧИТЬ ПО
		|	ВидНоменклатуры Возр		
		|;
		////////////////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ КешТкПустая; 
		////////////////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ КешПрПустая;
		////////////////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ КешТкПрПустая;
		////////////////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ КешСвободныхОстатков;
		////////////////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ КешПерегрузАссортимента;
		////////////////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ КешИсключеноИзАссортимента;
		|";
	Возврат ТекстЗапроса

КонецФункции // ПолучитьТекстЗапросаАналитикаТоварыКОтъезду()

Функция ПолучитьТекстЗапросаДоступныхСкладов() Экспорт
	
	ТекстЗапроса = "
		|ВЫБРАТЬ
		|	ФорматыМагазинов.Склад КАК Склад,
		|	ФорматыМагазинов.СкладПополнения КАК СкладПополнения
		|ПОМЕСТИТЬ ПредСкладыВМатрице
		|ИЗ
		|	Справочник.АМ_ФорматыМагазинов.Склады КАК ФорматыМагазинов		
		|ГДЕ
		|	ФорматыМагазинов.Ссылка.Активен 		  = Истина
		|И 	ФорматыМагазинов.Ссылка.ПометкаУдаления   = Ложь
		|И 	ФорматыМагазинов.ИспользуетсяУправление   = Истина
		|И 	ФорматыМагазинов.АвтоПеремещениеПоГлубине = Истина
		|
		|ИНДЕКСИРОВАТЬ ПО
		|	Склад,
		|	СкладПополнения
		|;";
	Возврат ТекстЗапроса;
	
КонецФункции // ПолучитьТекстЗапросаДоступныхСкладов()

Функция ПолучитьТекстЗапросаДоступныхСкладовПоПоездкам() 
	
	ТекстЗапроса = "
		|ВЫБРАТЬ
		|	ФорматыМагазинов.Склад КАК Склад,
		|	ФорматыМагазинов.СкладПополнения КАК СкладПополнения
		|ПОМЕСТИТЬ СкладыВМатрице
		|ИЗ
		|	Справочник.АМ_ФорматыМагазинов.Склады КАК ФорматыМагазинов		
		|ГДЕ
		|	ФорматыМагазинов.Ссылка.Активен 		  = Истина
		|И 	ФорматыМагазинов.Ссылка.ПометкаУдаления   = Ложь
		|И 	ФорматыМагазинов.ИспользуетсяУправление   = Истина
		|И 	ФорматыМагазинов.АвтоПеремещениеПоГлубине = Истина
		|
		|ИНДЕКСИРОВАТЬ ПО
		|	Склад,
		|	СкладПополнения
		|;
		////////////////////////////////////////////////////////////////////////////////
		//
		|ВЫБРАТЬ 
		|	Ссылка 			КАК ДокументПоездки,
		|	ВариантМаршрута КАК ВариантМаршрута
		|ПОМЕСТИТЬ ПоездкиВПроцессе
		|ИЗ
		|	Документ.ПоездкаЗаМаршрутом
		|ГДЕ
		|	Проведен   	  = Истина
		|И	СтатусПоездки = ЗНАЧЕНИЕ(Перечисление.КТС_СтатусыПоездки.ВПроцессе)
		|
		|ИНДЕКСИРОВАТЬ ПО
		|	ВариантМаршрута	
		|;
		////////////////////////////////////////////////////////////////////////////////
		//
		|ВЫБРАТЬ 
		|	ВЫРАЗИТЬ(ГородСклад КАК Справочник.Склады) КАК Склад,
		|	Ссылка КАК ВариантМаршрута
		|ПОМЕСТИТЬ СписокСкладов
		|ИЗ
		|	Справочник.ВариантыМаршрутов.СписокАдресов
		|ГДЕ
		|	ТИПЗНАЧЕНИЯ(ГородСклад) = ТИП(Справочник.Склады)	
		|
		|ИНДЕКСИРОВАТЬ ПО
		|	ВариантМаршрута	
		|;
		////////////////////////////////////////////////////////////////////////////////
		//
		|ВЫБРАТЬ
		|	СписокСкладов.Склад КАК Склад,
		|	Склады.Склад 		КАК СкладПополнения
		|ПОМЕСТИТЬ ПредСкладыВМатрице		
		|ИЗ
		|	Документ.ПоездкаЗаМаршрутом.Склады КАК Склады
		|
		|ВНУТРЕННЕЕ СОЕДИНЕНИЕ ПоездкиВПроцессе КАК ПоездкиВПроцессе
		|ПО	ПоездкиВПроцессе.ДокументПоездки = Склады.Ссылка
		|
		|ВНУТРЕННЕЕ СОЕДИНЕНИЕ СписокСкладов КАК СписокСкладов
		|ПО	СписокСкладов.ВариантМаршрута = ПоездкиВПроцессе.ВариантМаршрута
		|
		|ВНУТРЕННЕЕ СОЕДИНЕНИЕ СкладыВМатрице КАК ПредСкладыВМатрице
		|ПО	ПредСкладыВМатрице.Склад = СписокСкладов.Склад
		|И	ПредСкладыВМатрице.СкладПополнения = Склады.Склад		
		|
		|СГРУППИРОВАТЬ ПО
		|	СписокСкладов.Склад,
		|	Склады.Склад	
		|	
		|ИМЕЮЩИЕ МАКСИМУМ(Склады.ВремяКОтгрузке) > &ТекущееВремя
		|;
		////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ СкладыВМатрице;
		////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ ПоездкиВПроцессе;
		////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ СписокСкладов;
		////////////////////////////////////////////////////////////////////////////////
		|";
	Возврат ТекстЗапроса;
	
КонецФункции // ПолучитьТекстЗапросаДоступныхСкладовПоПоездкам()

Функция ПолучитьТекстЗапросаШапкиДокументаПеремещения()
	
	ТекстЗапроса = "
		////////////////////////////////////////////////////////////////////////////////
		// 
		|ВЫБРАТЬ
		|	ТаблицаСкладов.Склад
		|ПОМЕСТИТЬ ТаблицаСкладов
		|ИЗ
		|	&ТаблицаСкладов КАК ТаблицаСкладов
		|ИНДЕКСИРОВАТЬ ПО
		|	ТаблицаСкладов.Склад
		|;
		////////////////////////////////////////////////////////////////////////////////
		//
		|ВЫБРАТЬ
		|	ТаблицаСкладов.Склад 				КАК СкладПолучатель,
		|	ФорматыМагазинов.СкладПополнения 	КАК СкладОтправитель,
		|	Модуль_ДоступныеСклады.Организация 	КАК Организация,
		|	ТаблицаСкладов.Склад.Подразделение 	КАК Подразделение,
		|	&Ответственный 						КАК Ответственный,
		|
		|	ФорматыМагазинов.АвтоПеремещениеПоГлубине 	  КАК АвтоПеремещениеПоГлубине,
		|	ФорматыМагазинов.АвтоПеремещениеСоСклада 	  КАК АвтоПеремещениеСоСклада,
		|	ФорматыМагазинов.АвтоПеремещениеЗаказПодЗаказ КАК АвтоПеремещениеЗаказПодЗаказ,
		|
		|   КИ.АдресЭП 									КАК АдресЭП
		|ИЗ
		|	ТаблицаСкладов КАК ТаблицаСкладов
		|
		|ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.АМ_ФорматыМагазинов.Склады КАК ФорматыМагазинов
		|ПО	ФорматыМагазинов.Склад = ТаблицаСкладов.Склад	
		|
		|ЛЕВОЕ СОЕДИНЕНИЕ Справочник.Склады.КонтактнаяИнформация КАК КИ
		|ПО	КИ.Ссылка 	= ТаблицаСкладов.Склад
		|И	КИ.Тип 		= ЗНАЧЕНИЕ(Перечисление.ТипыКонтактнойИнформации.АдресЭлектроннойПочты)
		|
		|ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.Модуль_ДоступныеСклады КАК Модуль_ДоступныеСклады
		|ПО	Модуль_ДоступныеСклады.Склад = ТаблицаСкладов.Склад
		|;
		////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ ТаблицаСкладов;
		////////////////////////////////////////////////////////////////////////////////
		|";
	Возврат ТекстЗапроса;
	
КонецФункции // ПолучитьТекстЗапросаШапкиДокументаПеремещения()

#КонецОбласти

#Область  СведенияОВнешнейОбработке

Функция СведенияОВнешнейОбработке() Экспорт
	
	Версия = "1.0.51";
	
	// Объявим переменную, в которой мы сохраним и вернем "наружу" необходимые данные
    ПараметрыРегистрации = Новый Структура;

    // Объявим еще одну переменную, которая нам потребуется ниже
    МассивНазначений = Новый Массив;
    
    // Первый параметр, который мы должны указать - это какой вид обработки системе должна зарегистрировать. 
    // Допустимые типы: ДополнительнаяОбработка, ДополнительныйОтчет, ЗаполнениеОбъекта, Отчет, ПечатнаяФорма, СозданиеСвязанныхОбъектов
    ПараметрыРегистрации.Вставить("Вид", "ДополнительнаяОбработка");

    // Теперь нам необходимо передать в виде массива имен, к чему будет подключена наша ВПФ
    // Имейте ввиду, что можно задать имя в таком виде: Документ.* - в этом случае обработка будет подключена ко всем документам в системе, 
    // которые поддерживают механизм ВПФ
	//СчитатьДокументыНазначений(МассивНазначений);
	
	ПараметрыРегистрации.Вставить("Назначение", Новый Массив);
    
    // Теперь зададим имя, под которым ВПФ будет зарегистрирована в справочнике внешних обработок
    ПараметрыРегистрации.Вставить("Наименование", "УправлениеАссортиментнымиМатрицами");
    
    // Зададим право обработке на использование безопасного режима. Более подробно можно узнать в справке к платформе (метод УстановитьБезопасныйРежим)
    ПараметрыРегистрации.Вставить("БезопасныйРежим", Ложь);

    // Следующие два параметра играют больше информационную роль, т.е. это то, что будет видеть пользователь в информации к обработке
    ПараметрыРегистрации.Вставить("Версия", Версия);
	ПараметрыРегистрации.Вставить("ВерсияБСП", "2.1.3.50");
    ПараметрыРегистрации.Вставить("Информация", "Управление ассортиментными матрицами [" + Версия + "]");
    
    // Создадим таблицу команд (подробнее смотрим ниже)
    ТаблицаКоманд = ПолучитьТаблицуКоманд();
    
    // Добавим команду в таблицу
    ДобавитьКоманду(ТаблицаКоманд, "УправлениеАссортиментнымиМатрицами [" + Версия + "]", "УАМ", "ОткрытиеФормы", Ложь, "УАМ");
	ДобавитьКоманду(ТаблицаКоманд, "ОбновитьПродажиПоФорматамВФоне", 	"ОбновитьПродажиПоФорматамВФоне", 	"ВызовСерверногоМетода");
	ДобавитьКоманду(ТаблицаКоманд, "ОбновитьПродажиПоМагазинамВФоне", 	"ОбновитьПродажиПоМагазинамВФоне", 	"ВызовСерверногоМетода");
	ДобавитьКоманду(ТаблицаКоманд, "ОбновитьТоварыКОтъездуВФоне", 		"ОбновитьТоварыКОтъездуВФоне", 		"ВызовСерверногоМетода");
	ДобавитьКоманду(ТаблицаКоманд, "ОбновитьТоварыКПриездуВФоне", 		"ОбновитьТоварыКПриездуВФоне", 		"ВызовСерверногоМетода");
	ДобавитьКоманду(ТаблицаКоманд, "ОбновитьТоварыВРезервахВФоне", 		"ОбновитьТоварыВРезервахВФоне", 	"ВызовСерверногоМетода");
	ДобавитьКоманду(ТаблицаКоманд, "Регл. перемещение товаров в матрицу [" + Версия + "]", "ПереместитьТоварыВМатрицу();", "ВызовСерверногоМетода");
	ДобавитьКоманду(ТаблицаКоманд, "Регл. перемещение товаров из матрицы [" + Версия + "]", "ПереместитьТоварыИзМатрицы();", "ВызовСерверногоМетода");
	
    // Сохраним таблицу команд в параметры регистрации обработки
    ПараметрыРегистрации.Вставить("Команды", ТаблицаКоманд);
    
    // Теперь вернем системе наши параметры
    Возврат ПараметрыРегистрации;
КонецФункции

Функция ПолучитьТаблицуКоманд()

   // Создадим пустую таблицу команд и колонки в ней
   Команды = Новый ТаблицаЗначений;

   // Как будет выглядеть описание печатной формы для пользователя
   Команды.Колонки.Добавить("Представление", Новый ОписаниеТипов("Строка")); 

   // Имя нашего макета, что бы могли отличить вызванную команду в обработке печати
   Команды.Колонки.Добавить("Идентификатор", Новый ОписаниеТипов("Строка"));

   // Тут задается, как должна вызваться команда обработки
   // Возможные варианты:
   // - ОткрытиеФормы - в этом случае в колонке идентификатор должно быть указано имя формы, которое должна будет открыть система
   // - ВызовКлиентскогоМетода - вызвать клиентскую экспортную процедуру из модуля формы обработки
   // - ВызовСерверногоМетода - вызвать серверную экспортную процедуру из модуля объекта обработки
   Команды.Колонки.Добавить("Использование", Новый ОписаниеТипов("Строка"));

   // Следующий параметр указывает, необходимо ли показывать оповещение при начале и завершению работы обработки. Не имеет смысла при открытии формы
   Команды.Колонки.Добавить("ПоказыватьОповещение", Новый ОписаниеТипов("Булево"));

   // Для печатной формы должен содержать строку ПечатьMXL 
   Команды.Колонки.Добавить("Модификатор", Новый ОписаниеТипов("Строка"));
   
   Возврат Команды;
   
КонецФункции

Процедура ДобавитьКоманду(ТаблицаКоманд, Представление, Идентификатор, Использование, ПоказыватьОповещение = Ложь, Модификатор = "")
  // Добавляем команду в таблицу команд по переданному описанию.
  // Параметры и их значения можно посмотреть в функции ПолучитьТаблицуКоманд
  НоваяКоманда = ТаблицаКоманд.Добавить();
  НоваяКоманда.Представление = Представление;
  НоваяКоманда.Идентификатор = Идентификатор;
  НоваяКоманда.Использование = Использование;
  НоваяКоманда.ПоказыватьОповещение = ПоказыватьОповещение;
  НоваяКоманда.Модификатор = Модификатор;

КонецПроцедуры

#КонецОбласти
