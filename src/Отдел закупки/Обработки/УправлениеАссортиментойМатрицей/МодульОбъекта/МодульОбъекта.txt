

#Область ОбработчикиСобытийФормы

	
#КонецОбласти

#Область ОбработчикиСобытийЭлементовФормы





#Область ОбработчикиСобытийСтраницыНастройки
	
&НаКлиенте
Процедура ГруппаСтраницыПриСменеСтраницы(Элемент, ТекущаяСтраница)
	
	Если ТекущаяСтраница = Элементы.СтраницаНастройки Тогда
		ОбновитьМагазиныПодУправлениемНаСервере();
	ИначеЕсли ТекущаяСтраница = Элементы.СтраницаУправление Тогда
		ОбновитьУправлениеНаСервере();
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура МагазиныПодУправлениемПриИзменении(Элемент)
	
	Отказ = Ложь;
	Если ТекущиеДанныеОпределены(Элемент) Тогда
		ВыполнитьЗаписьИзмененийВРегистр_АМ_МагазиныПодУправлением("МагазиныПодУправлением", Элемент.ТекущиеДанные.ПолучитьИдентификатор(), Отказ);	
		Если Отказ = Ложь Тогда
			Состояние(НСтр("ru = 'Данные удачно записаны'"), 100, , БиблиотекаКартинок.УстановитьСтатусЗаявкиВыполнена);	
		КонецЕсли;
	КонецЕсли;
	
КонецПроцедуры


#КонецОбласти 

#КонецОбласти

#Область ОбработчикиКомандФормы



#КонецОбласти


#Область СлужебныеПроцедурыИФункции

&НаКлиенте
Функция ТекущиеДанныеОпределены(Элемент)
	
	ТекущиеДанные = Элемент.ТекущиеДанные;
	Если ТекущиеДанные <> Неопределено Тогда
		Возврат Истина;
	КонецЕсли;
	
	Возврат Ложь;
	
КонецФункции // ТекущиеДанныеОпределены() 


&НаСервере
Процедура ОбновитьМагазиныПодУправлениемНаСервере()
	
	Запрос = Новый Запрос;
	Запрос.Текст = ПолучитьТекстЗапросаМагазиныПодУправлением();
	РезультатЗапроса = Запрос.Выполнить();
	Если РезультатЗапроса.Пустой() = Ложь Тогда
		МагазиныПодУправлением.Загрузить(РезультатЗапроса.Выгрузить());	
	КонецЕсли;
	
КонецПроцедуры // ОбновитьМагазиныПодУправлениемНаСервере()

&НаСервере
Процедура ВыполнитьЗаписьИзмененийВРегистр_АМ_МагазиныПодУправлением(ИмяТаблицы, Идентификатор, Отказ)
	
	РезультатПоиска = ЭтаФорма[ИмяТаблицы].НайтиПоИдентификатору(Идентификатор);
	Если РезультатПоиска <> Неопределено Тогда
		ПериодЗаписи = ТекущаяДатаСеанса();
		НаборЗаписей = РегистрыСведений.АМ_МагазиныПодУправлением.СоздатьНаборЗаписей();
		НаборЗаписей.Отбор.Период.Установить(ПериодЗаписи);
		НаборЗаписей.Отбор.Склад.Установить(РезультатПоиска.Склад);
			НоваяЗапись = НаборЗаписей.Добавить();
			ЗаполнитьЗначенияСвойств(НоваяЗапись, РезультатПоиска);
			НоваяЗапись.Период = ПериодЗаписи;
		Попытка
			НаборЗаписей.Записать();
			РегистрыСведений.АМ_МагазиныПодУправлением.ПересчитатьИтоги();
		Исключение
			ОбщегоНазначенияКлиентСервер.СообщитьПользователю(НСтр("ru = 'Неудача при попытке записи значения'"), , , , Отказ);	
		КонецПопытки;
	КонецЕсли;
	
КонецПроцедуры // ВыполнитьЗаписьИзмененийВРегистр_АМ_МагазиныПодУправлением()

	
	
	
&НаСервереБезКонтекста
Функция ПолучитьТекстЗапросаМагазиныПодУправлением()

	ТекстЗапроса = "
		|ВЫБРАТЬ РАЗРЕШЕННЫЕ
		|	Склады.Склад КАК Склад,
		|	МагазиныПодУправлением.ИспользуетсяУправление КАК ИспользуетсяУправление
		|ИЗ
		|	РегистрСведений.Модуль_ДоступныеСклады КАК Склады
		|
		|ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.АМ_МагазиныПодУправлением.СрезПоследних КАК МагазиныПодУправлением
		|ПО	МагазиныПодУправлением.Склад = Склады.Склад
		|
		|ГДЕ
		|	Основной = Истина
		|УПОРЯДОЧИТЬ ПО
		|	Склады.Склад.Наименование Возр	
		|";
	Возврат ТекстЗапроса;

КонецФункции // ПолучитьТекстЗапросаМагазиныПодУправлением()



 

#КонецОбласти



