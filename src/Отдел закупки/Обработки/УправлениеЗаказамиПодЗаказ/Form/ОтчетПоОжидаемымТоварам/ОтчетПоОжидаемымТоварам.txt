
#Область ИнтерфейсАвтоматическихТестов

&НаКлиенте
Перем ЮнитТест;

&НаКлиенте
Функция ПолучитьСписокТестов(ЮнитТестирование) Экспорт
	
	ЮнитТест = ЮнитТестирование;
	
	СписокТестов = Новый Массив;	
	Возврат СписокТестов;
	
КонецФункции

#КонецОбласти

&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	
	Если Параметры.Свойство("АвтоТест") Тогда
		Возврат;	
	КонецЕсли;

	Номенклатура = Параметры.Номенклатура;
	
	СформироватьОтчетНаСервере();
	
КонецПроцедуры

&НаКлиенте
Процедура СформироватьОтчет(Команда)
	
	СформироватьОтчетНаСервере();
	
КонецПроцедуры

&НаСервере
Процедура СформироватьОтчетНаСервере()
	
	УстановитьПривилегированныйРежим(Истина);
	
	Результат.Очистить();
	
	Запрос 			= Новый Запрос;
	Запрос.Текст 	= СформироватьТексЗапроса();
	
	Если НЕ Номенклатура.Пустая() Тогда
		Запрос.УстановитьПараметр("Номенклатура", Номенклатура);
	КонецЕсли;
	
	СписокНоменклатуры = Запрос.Выполнить().Выгрузить();
	
	ВывестиРезультатыЗапроса(СписокНоменклатуры);
	
КонецПроцедуры

&НаСервере
Функция СформироватьТексЗапроса()
	ТекстЗапроса =  "ВЫБРАТЬ
	                |	ТоварыКПоступлениюОстатки.ДокументПоступления КАК ДокументПоступления,
	                |	ТоварыКПоступлениюОстатки.Номенклатура КАК Номенклатура,
	                |	ТоварыКПоступлениюОстатки.Номенклатура.Код КАК Код,
	                |	ТоварыКПоступлениюОстатки.Склад КАК Склад,
	                |	ТоварыКПоступлениюОстатки.КПоступлениюОстаток КАК КПоступлению,
	                |	ВЫБОР
	                |		КОГДА ТоварыКПоступлениюОстатки.ДокументПоступления ССЫЛКА Документ.ВозвратТоваровОтКлиента
	                |			ТОГДА ТоварыКПоступлениюОстатки.ДокументПоступления.Менеджер
	                |		ИНАЧЕ ТоварыКПоступлениюОстатки.ДокументПоступления.Ответственный
	                |	КОНЕЦ КАК Менеджер,
	                |	ВЫБОР
	                |		КОГДА ТоварыКПоступлениюОстатки.ДокументПоступления ССЫЛКА Документ.ВозвратТоваровОтКлиента
	                |				ИЛИ ТоварыКПоступлениюОстатки.ДокументПоступления ССЫЛКА Документ.ЗаявкаНаВозвратТоваровОтКлиента
	                |				ИЛИ ТоварыКПоступлениюОстатки.ДокументПоступления ССЫЛКА Справочник.СоглашенияСПоставщиками
	                |			ТОГДА """"
	                |	КОНЕЦ КАК Назначение
	                |ИЗ
	                |	РегистрНакопления.ТоварыКПоступлению.Остатки(
	                |			,
	                |			(ДокументПоступления ССЫЛКА Документ.ВозвратТоваровОтКлиента
	                |				ИЛИ ДокументПоступления ССЫЛКА Документ.ЗаявкаНаВозвратТоваровОтКлиента
	                |				ИЛИ ДокументПоступления ССЫЛКА Справочник.СоглашенияСПоставщиками)
	                |				" + ?(Номенклатура.Пустая(), "", "И Номенклатура = &Номенклатура") + ") КАК ТоварыКПоступлениюОстатки
	                |
	                |ОБЪЕДИНИТЬ ВСЕ
	                |
	                |ВЫБРАТЬ
	                |	ТоварыКПоступлениюОстатки.ДокументПоступления,
	                |	ТоварыКПоступлениюОстатки.Номенклатура,
	                |	ТоварыКПоступлениюОстатки.Номенклатура.Код,
	                |	ТоварыКПоступлениюОстатки.Склад,
	                |	ТоварыКПоступлениюОстатки.КПоступлениюОстаток,
	                |	ТоварыКПоступлениюОстатки.ДокументПоступления.Ответственный,
	                |	ВЫБОР
	                |		КОГДА ТоварыКПоступлениюОстатки.ДокументПоступления ССЫЛКА Документ.ЗаказНаПеремещение
	                |			ТОГДА ЕСТЬNULL(ЗаказНаПеремещениеТовары.Назначение, """")
	                |	КОНЕЦ
	                |ИЗ
	                |	РегистрНакопления.ТоварыКПоступлению.Остатки(
	                |			,
	                |			ДокументПоступления ССЫЛКА Документ.ЗаказНаПеремещение
	                |				" + ?(Номенклатура.Пустая(), "", "И Номенклатура = &Номенклатура") + ") КАК ТоварыКПоступлениюОстатки
	                |		ЛЕВОЕ СОЕДИНЕНИЕ Документ.ЗаказНаПеремещение.Товары КАК ЗаказНаПеремещениеТовары
	                |		ПО ТоварыКПоступлениюОстатки.ДокументПоступления = ЗаказНаПеремещениеТовары.Ссылка
	                |			И ТоварыКПоступлениюОстатки.Номенклатура = ЗаказНаПеремещениеТовары.Номенклатура
	                |
	                |ОБЪЕДИНИТЬ ВСЕ
	                |
	                |ВЫБРАТЬ
	                |	ТоварыКПоступлениюОстатки.ДокументПоступления,
	                |	ТоварыКПоступлениюОстатки.Номенклатура,
	                |	ТоварыКПоступлениюОстатки.Номенклатура.Код,
	                |	ТоварыКПоступлениюОстатки.Склад,
	                |	ТоварыКПоступлениюОстатки.КПоступлениюОстаток,
	                |	ТоварыКПоступлениюОстатки.ДокументПоступления.Ответственный,
	                |	ВЫБОР
	                |		КОГДА ТоварыКПоступлениюОстатки.ДокументПоступления ССЫЛКА Документ.ЗаказНаСборку
	                |				ИЛИ ТоварыКПоступлениюОстатки.ДокументПоступления ССЫЛКА Документ.СборкаТоваров
	                |			ТОГДА ЕСТЬNULL(ТоварыКПоступлениюОстатки.ДокументПоступления.Назначение, """")
	                |	КОНЕЦ
	                |ИЗ
	                |	РегистрНакопления.ТоварыКПоступлению.Остатки(
	                |			,
	                |			(ДокументПоступления ССЫЛКА Документ.ЗаказНаСборку
	                |				ИЛИ ДокументПоступления ССЫЛКА Документ.СборкаТоваров)
	                |				" + ?(Номенклатура.Пустая(), "", "И Номенклатура = &Номенклатура") + ") КАК ТоварыКПоступлениюОстатки
	                |
	                |ОБЪЕДИНИТЬ ВСЕ
	                |
	                |ВЫБРАТЬ
	                |	ТоварыКПоступлениюОстатки.ДокументПоступления,
	                |	ТоварыКПоступлениюОстатки.Номенклатура,
	                |	ТоварыКПоступлениюОстатки.Номенклатура.Код,
	                |	ТоварыКПоступлениюОстатки.Склад,
	                |	ТоварыКПоступлениюОстатки.КПоступлениюОстаток,
	                |	ТоварыКПоступлениюОстатки.ДокументПоступления.Ответственный,
	                |	ВЫБОР
	                |		КОГДА ТоварыКПоступлениюОстатки.ДокументПоступления ССЫЛКА Документ.ПеремещениеТоваров
	                |			ТОГДА ЕСТЬNULL(ПеремещениеТоваровТовары.Назначение, """")
	                |	КОНЕЦ
	                |ИЗ
	                |	РегистрНакопления.ТоварыКПоступлению.Остатки(
	                |			,
	                |			ДокументПоступления ССЫЛКА Документ.ПеремещениеТоваров
	                |				" + ?(Номенклатура.Пустая(), "", "И Номенклатура = &Номенклатура") + ") КАК ТоварыКПоступлениюОстатки
	                |		ЛЕВОЕ СОЕДИНЕНИЕ Документ.ПеремещениеТоваров.Товары КАК ПеремещениеТоваровТовары
	                |		ПО ТоварыКПоступлениюОстатки.ДокументПоступления = ПеремещениеТоваровТовары.Ссылка
	                |			И ТоварыКПоступлениюОстатки.Номенклатура = ПеремещениеТоваровТовары.Номенклатура
	                |
	                |ОБЪЕДИНИТЬ ВСЕ
	                |
	                |ВЫБРАТЬ
	                |	ТоварыКПоступлениюОстатки.ДокументПоступления,
	                |	ТоварыКПоступлениюОстатки.Номенклатура,
	                |	ТоварыКПоступлениюОстатки.Номенклатура.Код,
	                |	ТоварыКПоступлениюОстатки.Склад,
	                |	ТоварыКПоступлениюОстатки.КПоступлениюОстаток,
	                |	ТоварыКПоступлениюОстатки.ДокументПоступления.Менеджер,
	                |	ВЫБОР
	                |		КОГДА ТоварыКПоступлениюОстатки.ДокументПоступления ССЫЛКА Документ.ПоступлениеТоваровУслуг
	                |			ТОГДА ЕСТЬNULL(ПоступлениеТоваровУслугТовары.Назначение, """")
	                |	КОНЕЦ
	                |ИЗ
	                |	РегистрНакопления.ТоварыКПоступлению.Остатки(
	                |			,
	                |			ДокументПоступления ССЫЛКА Документ.ПоступлениеТоваровУслуг
	                |				" + ?(Номенклатура.Пустая(), "", "И Номенклатура = &Номенклатура") + ") КАК ТоварыКПоступлениюОстатки
	                |		ЛЕВОЕ СОЕДИНЕНИЕ Документ.ПоступлениеТоваровУслуг.Товары КАК ПоступлениеТоваровУслугТовары
	                |		ПО ТоварыКПоступлениюОстатки.ДокументПоступления = ПоступлениеТоваровУслугТовары.Ссылка
	                |			И ТоварыКПоступлениюОстатки.Номенклатура = ПоступлениеТоваровУслугТовары.Номенклатура
	                |
	                |ОБЪЕДИНИТЬ ВСЕ
	                |
	                |ВЫБРАТЬ
	                |	ТоварыКПоступлениюОстатки.ДокументПоступления,
	                |	ТоварыКПоступлениюОстатки.Номенклатура,
	                |	ТоварыКПоступлениюОстатки.Номенклатура.Код,
	                |	ТоварыКПоступлениюОстатки.Склад,
	                |	ТоварыКПоступлениюОстатки.КПоступлениюОстаток,
	                |	ТоварыКПоступлениюОстатки.ДокументПоступления.Ответственный,
	                |	ВЫБОР
	                |		КОГДА ТоварыКПоступлениюОстатки.ДокументПоступления ССЫЛКА Документ.ПрочееОприходованиеТоваров
	                |			ТОГДА ЕСТЬNULL(ПрочееОприходованиеТоваровТовары.ПередачаВЭксплуатацию, """")
	                |	КОНЕЦ
	                |ИЗ
	                |	РегистрНакопления.ТоварыКПоступлению.Остатки(
	                |			,
	                |			ДокументПоступления ССЫЛКА Документ.ПрочееОприходованиеТоваров
	                |				" + ?(Номенклатура.Пустая(), "", "И Номенклатура = &Номенклатура") + ") КАК ТоварыКПоступлениюОстатки,
	                |	Документ.ПрочееОприходованиеТоваров.Товары КАК ПрочееОприходованиеТоваровТовары
	                |
	                |ОБЪЕДИНИТЬ ВСЕ
	                |
	                |ВЫБРАТЬ
	                |	ТоварыКПоступлениюОстатки.ДокументПоступления,
	                |	ТоварыКПоступлениюОстатки.Номенклатура,
	                |	ТоварыКПоступлениюОстатки.Номенклатура.Код,
	                |	ТоварыКПоступлениюОстатки.Склад,
	                |	ТоварыКПоступлениюОстатки.КПоступлениюОстаток,
	                |	ТоварыКПоступлениюОстатки.ДокументПоступления.Менеджер,
	                |	ВЫБОР
	                |		КОГДА ТоварыКПоступлениюОстатки.ДокументПоступления ССЫЛКА Документ.ЗаказПоставщику
	                |			ТОГДА ЕСТЬNULL(ЗаказПоставщикуТовары.Назначение, """")
	                |	КОНЕЦ
	                |ИЗ
	                |	РегистрНакопления.ТоварыКПоступлению.Остатки(
	                |			,
	                |			ДокументПоступления ССЫЛКА Документ.ЗаказПоставщику
	                |				" + ?(Номенклатура.Пустая(), "", "И Номенклатура = &Номенклатура") + ") КАК ТоварыКПоступлениюОстатки
	                |		ЛЕВОЕ СОЕДИНЕНИЕ Документ.ЗаказПоставщику.Товары КАК ЗаказПоставщикуТовары
	                |		ПО ТоварыКПоступлениюОстатки.ДокументПоступления = ЗаказПоставщикуТовары.Ссылка
	                |			И ТоварыКПоступлениюОстатки.Номенклатура = ЗаказПоставщикуТовары.Номенклатура
	                |
	                |УПОРЯДОЧИТЬ ПО
	                |	Менеджер,
	                |	КПоступлению УБЫВ" ;
		
   Возврат ТекстЗапроса;
	
КонецФункции

&НаСервере
Процедура ВывестиРезультатыЗапроса(СписокНоменклатуры)
	
	ВнешниеНаборыДанных = Новый Структура;
	ВнешниеНаборыДанных.Вставить("СписокНоменклатуры", СписокНоменклатуры);
	
	ОбъектОбработки 		= РеквизитФормыВЗначение("Объект");
	СхемаКомпоновкиДанных   = ОбъектОбработки.ПолучитьМакет("СКД_ОжидаемыеТовары");
	ЗначениеВРеквизитФормы(ОбъектОбработки, "Объект");
	
	Настройки 					= СхемаКомпоновкиДанных.НастройкиПоУмолчанию;
	
	КомпоновщикМакета 			= Новый КомпоновщикМакетаКомпоновкиДанных;
	ДанныеРасшифровки			= Новый ДанныеРасшифровкиКомпоновкиДанных;
	МакетКомпоновки				= КомпоновщикМакета.Выполнить(СхемаКомпоновкиДанных, Настройки, ДанныеРасшифровки);
	
	ПроцессорКомпоновкиДанны    = Новый ПроцессорКомпоновкиДанных;
	ПроцессорКомпоновкиДанны.Инициализировать(МакетКомпоновки, ВнешниеНаборыДанных, ДанныеРасшифровки);
	
	ПроцессорВывода				= Новый ПроцессорВыводаРезультатаКомпоновкиДанныхВТабличныйДокумент;
	ПроцессорВывода.УстановитьДокумент(Результат);
	ПроцессорВывода.Вывести(ПроцессорКомпоновкиДанны);
	
КонецПроцедуры