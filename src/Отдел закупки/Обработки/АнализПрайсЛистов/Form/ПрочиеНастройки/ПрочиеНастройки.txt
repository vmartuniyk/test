
&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	
	Перем ДеревоПрайсов;
	
	Если Параметры.Свойство("АвтоТест") Тогда
		Возврат;
	КонецЕсли;

	УстановитьПривилегированныйРежим(Истина);
	
	Соглашение = Параметры.Соглашение;		
	НастройкаГлобальная = ХранилищеНастроекДанныхФорм.Загрузить("ДополнительныеНастройкиОбработокМодификацииКонфигурации", , , "ДополнительныеНастройкиОбработокМодификацииКонфигурации");
	Если ТипЗнч(НастройкаГлобальная) = Тип("Структура") Тогда
		Если НастройкаГлобальная.Свойство("ДеревоПрайсов", ДеревоПрайсов) Тогда
			РезультатПоиска = ДеревоПрайсов.Строки.Найти(Соглашение.Партнер, "Партнер");
			Если НЕ РезультатПоиска = Неопределено Тогда
				ПоискСоглашения = РезультатПоиска.Строки.Найти(Соглашение, "Соглашение");	
				Если НЕ ПоискСоглашения = Неопределено Тогда
					ЗаполнитьЗначенияСвойств(ЭтаФорма, ПоискСоглашения);
				Иначе
					ВызватьИсключение НСтр("ru='Сохраните для начала настройки прайс-листа в основном окне'");	
				КонецЕсли;
			Иначе
				ВызватьИсключение НСтр("ru='Сохраните для начала настройки прайс-листа в основном окне'");
			КонецЕсли; 
		КонецЕсли; 
	КонецЕсли;
	
		
КонецПроцедуры

&НаКлиенте
Процедура ПередЗакрытием(Отказ, СтандартнаяОбработка)
	Если Модифицированность Тогда
		РезультатОтвета = Вопрос("Данные были изменены. Сохранить изменения?", РежимДиалогаВопрос.ДаНетОтмена);
		Если РезультатОтвета = КодВозвратаДиалога.Да Тогда
			ЗаписатьНастройкиНаСервере();
		ИначеЕсли РезультатОтвета = КодВозвратаДиалога.Отмена Тогда
			Отказ = Истина;	
		КонецЕсли;
	КонецЕсли;
КонецПроцедуры





&НаКлиенте
Процедура Записать(Команда)
	ЗаписатьНастройкиНаСервере();
	Модифицированность = Ложь;
КонецПроцедуры

&НаКлиенте
Процедура ЗаписатьИЗакрыть(Команда)
	ЗаписатьНастройкиНаСервере();
	Модифицированность = Ложь; 
	Закрыть();
КонецПроцедуры

&НаСервере
Процедура ЗаписатьНастройкиНаСервере()
	
	Перем ДеревоПрайсов;
	УстановитьПривилегированныйРежим(Истина);
	
	Настройки = ХранилищеНастроекДанныхФорм.Загрузить("ДополнительныеНастройкиОбработокМодификацииКонфигурации", , , "ДополнительныеНастройкиОбработокМодификацииКонфигурации");
	Если ТипЗнч(Настройки) = Тип("Структура") Тогда
		Если Настройки.Свойство("ДеревоПрайсов", ДеревоПрайсов) Тогда
			
			РезультатПоиска = ДеревоПрайсов.Строки.Найти(Соглашение.Партнер, "Партнер");
			Если РезультатПоиска = Неопределено Тогда
				ВызватьИсключение НСтр("ru='Сохраните для начала настройки прайс-листа в основном окне'");
			КонецЕсли;
			
			ПоискСоглашения = РезультатПоиска.Строки.Найти(Соглашение, "Соглашение");	
			Если ПоискСоглашения = Неопределено Тогда
				ВызватьИсключение НСтр("ru='Сохраните для начала настройки прайс-листа в основном окне'");
			КонецЕсли; 
			
			ЗаполнитьЗначенияСвойств(ПоискСоглашения, ЭтаФорма);
			
		Иначе
			ВызватьИсключение "Для начала роботы с ALPS, задайте базовые настройки (Нормативно справочная информация->Дополнительные обработки->Настройки внешних обработок:Вкладка ""Настройки ALPS"")";
		КонецЕсли;
		
	Иначе
		ВызватьИсключение "Для начала роботы с ALPS, задайте базовые настройки (Нормативно справочная информация->Дополнительные обработки->Настройки внешних обработок:Вкладка ""Настройки ALPS"")";
	КонецЕсли;
		
	ХранилищеНастроекДанныхФорм.Сохранить("ДополнительныеНастройкиОбработокМодификацииКонфигурации", , Настройки, "Настройки актуальности прайс-листов", "ДополнительныеНастройкиОбработокМодификацииКонфигурации");
		
КонецПроцедуры





&НаКлиенте
Процедура ОтключитьИспользованиеПрайсЛистаПриИзменении(Элемент)
	Модифицированность = Истина;
КонецПроцедуры

&НаКлиенте
Процедура ДнейАктуальностиПриИзменении(Элемент)
	Модифицированность = Истина;
КонецПроцедуры

&НаКлиенте
Процедура deadlineПриИзменении(Элемент)
	Модифицированность = Истина;
КонецПроцедуры

&НаКлиенте
Процедура РасписаниеПриИзменении(Элемент)
	Модифицированность = Истина;
КонецПроцедуры

&НаКлиенте
Процедура РасписаниеНачалоВыбора(Элемент, ДанныеВыбора, СтандартнаяОбработка)
	
	СтандартнаяОбработка = Ложь;	
	
	перемРасписание = ?(Расписание.Количество() = 0, Неопределено,  Расписание.Получить(0).Значение);
	Если перемРасписание = Неопределено Тогда
		перемРасписание = Новый РасписаниеРегламентногоЗадания;
	КонецЕсли;
	
	Диалог = Новый ДиалогРасписанияРегламентногоЗадания(перемРасписание);
	Если Диалог.ОткрытьМодально() Тогда
		перемРасписание = Диалог.Расписание;
		Модифицированность = Истина;
	КонецЕсли;
	
	Расписание.Очистить();
	Расписание.Добавить(перемРасписание);
	
КонецПроцедуры

&НаКлиенте
Процедура ПутьКФайлуПриИзменении(Элемент)
	Модифицированность = Истина;
КонецПроцедуры

&НаКлиенте
Процедура ИмяФайлаПриИзменении(Элемент)
	Модифицированность = Истина;
КонецПроцедуры

&НаКлиенте
Процедура cmdПриИзменении(Элемент)
	Модифицированность = Истина;
КонецПроцедуры	