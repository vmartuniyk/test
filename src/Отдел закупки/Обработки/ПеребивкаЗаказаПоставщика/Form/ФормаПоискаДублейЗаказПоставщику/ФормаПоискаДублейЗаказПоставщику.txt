#Область АвтоТест
	
Перем ЮнитТест;

Функция ПолучитьСписокТестов(ЮнитТестирование) Экспорт
	
	ЮнитТест = ЮнитТестирование;
	
	СпиокТестов = Новый Массив;	
	Возврат СпиокТестов;
	
КонецФункции

#КонецОбласти 

#Область  ОбработчикиСобытийФормы
&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	Если Параметры.СсылкаНаДокумент<>Неопределено И  Параметры.АдресДерева<>Неопределено Тогда
		СслыкаНаДокумент 			= Параметры.СсылкаНаДокумент;
		ДеревоСписокНоменклатуры 	= РеквизитФормыВЗначение("СписокНоменклатуры", Тип("ДеревоЗначений"));
		Дерево						= ПолучитьИзВременногоХранилища(Параметры.АдресДерева);
		Для каждого ПерваяИерархия Из Дерево.Строки Цикл      
			Для каждого СтрокаДерева Из ПерваяИерархия.Строки Цикл
				Строка 				= ДеревоСписокНоменклатуры.Строки.Добавить();
				ЗаполнитьЗначенияСвойств(Строка, СтрокаДерева);
				Для каждого СтрокаПодстроки Из СтрокаДерева.Строки Цикл
					Подстрока 						= Строка.Строки.Добавить();
					Подстрока.ЗаказПоставщикуДоп				= СтрокаПодстроки.ЗаказПоставщикуДоп;
					Подстрока.Поставщик 						= СтрокаПодстроки.Поставщик;
					Подстрока.НомерТТН 							= СтрокаПодстроки.НомерТТН;
					Подстрока.НазначениеДоп						= СтрокаПодстроки.НазначениеДоп;
					Подстрока.КоличествоДоп 					= СтрокаПодстроки.КоличествоДоп;
					Подстрока.КоличествоОстатокДоп				= СтрокаПодстроки.КоличествоОстатокДоп;
					Подстрока.ЕдиницаИзмеренияДоп 				= СтрокаПодстроки.ЕдиницаИзмеренияДоп;
					Подстрока.ЦенаДоп 							= СтрокаПодстроки.ЦенаДоп;
					Подстрока.УпаковкаДоп 						= СтрокаПодстроки.УпаковкаДоп;
					Подстрока.КодСтрокиДоп	 					= СтрокаПодстроки.КодСтрокиДоп;
					Подстрока.ММ_ВыписатьБонусНаПоставщикаДоп 	= СтрокаПодстроки.ММ_ВыписатьБонусНаПоставщикаДоп;
					Подстрока.ММ_БонусДоп 						= СтрокаПодстроки.ММ_БонусДоп;
					Подстрока.ММ	 							= СтрокаПодстроки.ММ;   
					Подстрока.НеПеребивать						= СтрокаПодстроки.НеПеребивать; 
				КонецЦикла; 
			КонецЦикла; 	
		КонецЦикла; 
		ЗначениеВРеквизитФормы(ДеревоСписокНоменклатуры, "СписокНоменклатуры"); 
	КонецЕсли; 
КонецПроцедуры
#КонецОбласти

#Область  ОбработчикиКомандФормы
&НаКлиенте
Процедура ПровестиДокумент(Команда)
	ПровестиДокументНаКлиенте();
КонецПроцедуры
&НаКлиенте
Процедура ПровестиИЗакрытьДокумент(Команда)
	ПровестиДокументНаКлиенте();
КонецПроцедуры

&НаКлиенте
Процедура Отмена(Команда)
	Закрыть(Неопределено);
КонецПроцедуры
#КонецОбласти

#Область СлужебныеПроцедурыИФункции

#Область ПроцедурыРаботыНаКлиенте
// Обробляет таблицу владельца формы и проводит документ
//
// Параметры:
//  НЕТ
//
&НаКлиенте
Процедура ПровестиДокументНаКлиенте()

	ТоварыЗаказа 	=	ВладелецФормы.Объект.Товары;
	                                                   	
	УникальныйИндентификаторСтроки = 1;	
	Для каждого Строка  Из ТоварыЗаказа Цикл
		НоваяСтрока = 	Объект.ТоварыИзЗаказа.Добавить();
		НоваяСтрока.УникальныйИндентификаторСтроки =УникальныйИндентификаторСтроки;
		УникальныйИндентификаторСтроки = УникальныйИндентификаторСтроки+1;
		ЗаполнитьЗначенияСвойств(НоваяСтрока,Строка) 
	КонецЦикла;

	Результат 		= ПровестиДокументНаСервере(); 	
	
	Если Результат Тогда
		ФормаДокумента	= ВладелецФормы;
		ОбъектФормы		= ФормаДокумента.Объект;
		ДокументТовары	= ОбъектФормы.Товары;
		ДокументТовары.Очистить();	
		СтруктураДействий = Новый Структура;
		ЗаполнитьСтруктуруДействия(СтруктураДействий, ОбъектФормы);
		Для Каждого ТекущаяСтрока Из Объект.Товары Цикл
			НоваяСтрока = ДокументТовары.Добавить();
			Если ТекущаяСтрока.КодСтроки =	0 Тогда 
				ТекущаяСтрока.КодСтроки	 = Новый УникальныйИдентификатор();
			КонецЕсли;
			СтруктураДействий.Вставить("ПроверитьЗаполнитьУпаковкуПоВладельцу", НоваяСтрока.Упаковка);
			ЗаполнитьЗначенияСвойств(НоваяСтрока, ТекущаяСтрока);
			ОбработкаТабличнойЧастиКлиент.ОбработатьСтрокуТЧ(НоваяСтрока, СтруктураДействий, );
		КонецЦикла;
	Иначе
		ПоказатьОповещениеПользователя("Документ проведен без изменений:", ПолучитьНавигационнуюСсылку(СслыкаНаДокумент), Строка(СслыкаНаДокумент), БиблиотекаКартинок.Информация32);
	КонецЕсли;
	Закрыть(Ложь);
КонецПроцедуры // ПровестиДокументНаКлиенте()
#КонецОбласти 
 
#Область ПроцедурыИФункцииДляОбработкиТаблицы
&НаКлиентеНаСервереБезКонтекста
Процедура РассчитатьИтоговыеПоказателиЗаказа(Форма)
	
	// Заполнение итогов по таблице "Товары"
	
	КоллекцияТовары = Форма.Объект.Товары;
	
	Форма.СуммаЗаказано     = КоллекцияТовары.Итог("СуммаСНДСБезВозвратнойТары") - КоллекцияТовары.Итог("СуммаСНДСОтмененоБезВозвратнойТары");
	Форма.СуммаНДСЗаказано  = КоллекцияТовары.Итог("СуммаНДСБезВозвратнойТары") - КоллекцияТовары.Итог("СуммаНДСОтмененоБезВозвратнойТары");
	Форма.СуммаАвтоСкидки   = КоллекцияТовары.Итог("СуммаАвтоматическойСкидкиБезВозвратнойТары") - КоллекцияТовары.Итог("СуммаАвтоматическойСкидкиОтмененоБезВозвратнойТары");
	Форма.СуммаРучнойСкидки = КоллекцияТовары.Итог("СуммаРучнойСкидкиБезВозвратнойТары") - КоллекцияТовары.Итог("СуммаРучнойСкидкиОтмененоБезВозвратнойТары");
	Форма.СуммаСкидки       = Форма.СуммаАвтоСкидки + Форма.СуммаРучнойСкидки;
	Форма.СуммаОтменено     = КоллекцияТовары.Итог("СуммаСНДСОтмененоБезВозвратнойТары");
	
	Если КоллекцияТовары.Итог("СуммаСНДСОтмененоБезВозвратнойТары") = КоллекцияТовары.Итог("СуммаСНДСБезВозвратнойТары") Тогда
		Форма.ВсеСтрокиОтменены = Истина;
	Иначе
		Форма.ВсеСтрокиОтменены = Ложь;
	КонецЕсли;
	
	СуммаЗаказано = КоллекцияТовары.Итог("СуммаБезВозвратнойТары") - КоллекцияТовары.Итог("СуммаОтмененоБезВозвратнойТары");
	
	Если СуммаЗаказано > 0 Тогда
		Форма.ПроцентАвтоСкидки   = Форма.СуммаАвтоСкидки * 100 / (СуммаЗаказано + Форма.СуммаСкидки);
		Форма.ПроцентРучнойСкидки = Форма.СуммаРучнойСкидки * 100 / (СуммаЗаказано + Форма.СуммаСкидки);
		Форма.ПроцентСкидки       = Форма.ПроцентАвтоСкидки + Форма.ПроцентРучнойСкидки;
	ИначеЕсли Форма.СуммаСкидки > 0 Тогда
		Форма.ПроцентАвтоСкидки   = Форма.СуммаАвтоСкидки * 100 / Форма.СуммаСкидки;
		Форма.ПроцентРучнойСкидки = Форма.СуммаРучнойСкидки * 100 / Форма.СуммаСкидки;
		Форма.ПроцентСкидки       = 100;
	Иначе
		Форма.ПроцентАвтоСкидки   = 0;
		Форма.ПроцентРучнойСкидки = 0;
		Форма.ПроцентСкидки       = 0;
	КонецЕсли;
	
	// Заполнение итогов по этапам оплаты
	
	ПредыдущееЗначениеДаты = Дата(1,1,1);
	Форма.НомерСтрокиПолнойОплаты = 0;
	ПроцентПлатежейОбщий = 0;
	
	Форма.СуммаАвансаДоОбеспечения = 0;
	Форма.СуммаПредоплатыДоОтгрузки = 0;
	Форма.СуммаКредитаПослеОтгрузки = 0;
	Форма.ПроцентАвансаДоОбеспечения = 0;
	Форма.ПроцентПредоплатыДоОтгрузки = 0;
	Форма.ПроцентКредитаПослеОтгрузки = 0;
	
	СоответствиеВариантовОплаты = Новый Соответствие;
	СоответствиеВариантовОплаты.Вставить(ПредопределенноеЗначение("Перечисление.ВариантыОплатыКлиентом.АвансДоОбеспечения"),
	Новый Структура("Сумма, Проценты", "СуммаАвансаДоОбеспечения", "ПроцентАвансаДоОбеспечения"));
	СоответствиеВариантовОплаты.Вставить(ПредопределенноеЗначение("Перечисление.ВариантыОплатыКлиентом.ПредоплатаДоОтгрузки"),
	Новый Структура("Сумма, Проценты", "СуммаПредоплатыДоОтгрузки", "ПроцентПредоплатыДоОтгрузки"));
	СоответствиеВариантовОплаты.Вставить(ПредопределенноеЗначение("Перечисление.ВариантыОплатыКлиентом.КредитПослеОтгрузки"),
	Новый Структура("Сумма, Проценты", "СуммаКредитаПослеОтгрузки", "ПроцентКредитаПослеОтгрузки"));
	
	Для Каждого ТекСтрока Из Форма.Объект.ЭтапыГрафикаОплаты Цикл
		ПроцентПлатежейОбщий = ПроцентПлатежейОбщий + ТекСтрока.ПроцентПлатежа;
		ТекСтрока.ПроцентЗаполненНеВерно = (ПроцентПлатежейОбщий > 100);
		ТекСтрока.ДатаЗаполненаНеВерно = (ПредыдущееЗначениеДаты > ТекСтрока.ДатаПлатежа);
		ПредыдущееЗначениеДаты = ТекСтрока.ДатаПлатежа;
		Если ПроцентПлатежейОбщий = 100 Тогда
			Форма.НомерСтрокиПолнойОплаты = ТекСтрока.НомерСтроки;
		КонецЕсли;
		ИменаЭлементов = СоответствиеВариантовОплаты[ТекСтрока.ВариантОплаты];
		Если ИменаЭлементов <> Неопределено Тогда
			Форма[ИменаЭлементов.Сумма] = Форма[ИменаЭлементов.Сумма] + ТекСтрока.СуммаПлатежа;
			Форма[ИменаЭлементов.Проценты] = Форма[ИменаЭлементов.Проценты] + ТекСтрока.ПроцентПлатежа;
		КонецЕсли;
	КонецЦикла;
	
	// Выбор странцицы отображения НДС
	
	Если Форма.Объект.НалогообложениеНДС = ПредопределенноеЗначение("Перечисление.ТипыНалогообложенияНДС.ПродажаНеОблагаетсяНДС")
		ИЛИ Форма.Объект.НалогообложениеНДС = ПредопределенноеЗначение("Перечисление.ТипыНалогообложенияНДС.ПродажаОблагаетсяЕНВД") Тогда
		
		Форма.Элементы.ГруппаСтраницыНДС.ТекущаяСтраница   = Форма.Элементы.СтраницаБезНДС;
		Форма.Элементы.ГруппаСтраницыВсего.ТекущаяСтраница = Форма.Элементы.СтраницаВсегоБезНДС;
		
	Иначе
		
		Форма.Элементы.ГруппаСтраницыНДС.ТекущаяСтраница   = Форма.Элементы.СтраницаСНДС;
		Форма.Элементы.ГруппаСтраницыВсего.ТекущаяСтраница = Форма.Элементы.СтраницаВсегоСНДС;
		
	КонецЕсли;
	
КонецПроцедуры
&НаКлиентеНаСервереБезКонтекста
Процедура ЗаполнитьСтруктуруДействия(СтруктураДействий, ОбъектФормы)
	
	СтруктураПересчетаСуммы = ОбработкаТабличнойЧастиКлиентСервер.ПолучитьСтруктуруПересчетаСуммыНДСВСтрокеТЧ(ОбъектФормы);
	
	СтруктураДействий = Новый Структура;
	СтруктураДействий.Вставить("ПересчитатьКоличествоЕдиниц");
	
	СтруктураДействий.Вставить("ПересчитатьСуммуРучнойСкидки");
	СтруктураДействий.Вставить("ПересчитатьСумму");
	СтруктураДействий.Вставить("ПересчитатьСуммуСУчетомРучнойСкидки", Новый Структура("Очищать", Ложь));
	СтруктураДействий.Вставить("ПересчитатьСуммуСУчетомАвтоматическойСкидки", Новый Структура("Очищать", Ложь));
	СтруктураДействий.Вставить("ПересчитатьСуммуНДС", СтруктураПересчетаСуммы);
	СтруктураДействий.Вставить("ПересчитатьСуммуСНДС", СтруктураПересчетаСуммы);
	
	СтруктураДействий.Вставить("ЗаполнитьСодержание", 
	ОбработкаТабличнойЧастиКлиентСервер.ПолучитьСтруктуруЗаполненияСодержанияУслугиВСтрокеТЧ(ОбъектФормы, Ложь));
	//СтруктураДействий.Вставить("ЗаполнитьДубликатыЗависимыхРеквизитов"		, ПолучитьСтруктуруЗависимыхРеквизитов());
	//СтруктураДействий.Вставить("ЗаполнитьПризнакБезВозвратнойТары"			, ОбъектФормы.ВернутьМногооборотнуюТару);
	//СтруктураДействий.Вставить("ЗаполнитьПризнакОтмененоБезВозвратнойТары"	, ОбъектФормы.ВернутьМногооборотнуюТару);
	
КонецПроцедуры
&НаКлиентеНаСервереБезКонтекста
Функция ПолучитьСтруктуруЗависимыхРеквизитов()
	
	Возврат Новый Структура(
	"БезВозвратнойТары,ОтмененоБезВозвратнойТары",
	"Сумма,СуммаНДС,СуммаСНДС,СуммаАвтоматическойСкидки,СуммаРучнойСкидки",
	"Сумма,СуммаНДС,СуммаСНДС,СуммаАвтоматическойСкидки,СуммаРучнойСкидки");
	
КонецФункции
#КонецОбласти 

#Область ПроцедурыИФункцииОбработкиСобитийПриКомандеПровести
// Отменняет строки в отмеченных пользователем заказов
//
// Параметры:
//  НЕТ
//
&НаСервере
Процедура ОтменитьСтрокуВЗаказе()
	УстановитьПривилегированныйРежим(Истина);
	
	Запрос					= Новый Запрос;
	Запрос.Текст			= ПолучитьТекстЗапросаСпискаНоменклатурыДляОтмени();		
	Запрос.УстановитьПараметр("СписокНоменклатурыДляОтменения",СписокОтменныхЗаказов.Выгрузить());
	
	РезультатЗапроса		= Запрос.Выполнить();
	ПричиныОтмены			= Справочники.ПричиныОтменыЗаказовПоставщикам.ПолучитьСсылку(Новый УникальныйИдентификатор("3b8e4dd8-221d-11e2-b1c4-14dae9dfbe72"));
	ВыборкаЗаказПоставщика	= РезультатЗапроса.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
	
	Пока ВыборкаЗаказПоставщика.Следующий() Цикл
		
		ЗаказСсылка			= ВыборкаЗаказПоставщика.ЗаказПоставщика;
		ЗаказОбъект			= ЗаказСсылка.ПолучитьОбъект();
		Товары 				= ЗаказОбъект.Товары;

		
		ВыборкаДетальныеЗаписи 	= ВыборкаЗаказПоставщика.Выбрать();
		Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
			
			Номенклатура 	= ВыборкаДетальныеЗаписи.Номенклатура;
			КодСтрокиДоп	= ВыборкаДетальныеЗаписи.КодСтрокиДоп;
			СтруктураПоиска = Новый Структура("Номенклатура, КодСтроки", Номенклатура,КодСтрокиДоп);
			
			МассивСтрок 	= Товары.НайтиСтроки(СтруктураПоиска);
			Для каждого СтрокаТЧ Из МассивСтрок Цикл
				СтрокаТЧ.Отменено 			= Истина;    			
				СтрокаТЧ.ПричинаОтмены  	= ПричиныОтмены;
			КонецЦикла;
		КонецЦикла;
	
		Если МассивСтрок.Количество() > 0 Тогда
			ЗаказОбъект.ЗаполнитьЭтапыГрафикаОплаты();
			ЗаказОбъект.Записать(РежимЗаписиДокумента.Проведение);
		КонецЕсли;
	КонецЦикла;
	
КонецПроцедуры // ОтменитьСтрокуВЗаказе()

// Функция перебырает дерево значений и переносит значения с отмеченныех строк 
//
// Параметры:
//  НЕТ
//
// Возвращаемое значение:
//   Булево  - Истина - если нужно изменять Таблицу "Товары" Владельца
//             ЛОЖЬ	  - если изменений не было	
&НаСервере
Функция ПровестиДокументНаСервере()
	
	ОтменитьСтроки 	= Ложь;
	ПараметрыОтбора = Новый Структура;
	ПараметрыОтбора.Вставить("Флаг", Истина);
		
	ДеревоСписокНоменклатуры 	= РеквизитФормыВЗначение("СписокНоменклатуры", Тип("ДеревоЗначений")); 
	Для каждого СтрокаДерева Из ДеревоСписокНоменклатуры.Строки Цикл
		Номенклатура 	= СтрокаДерева.Номенклатура;
		НайденныеСтроки = СтрокаДерева.Строки.НайтиСтроки(ПараметрыОтбора);
		Если НайденныеСтроки.Количество()>0 Тогда
			ПеренестиЗначенияНоменклатурыСОтменогоЗаказа(НайденныеСтроки,Номенклатура);
			ОтменитьСтроки = Истина;
		КонецЕсли;
	КонецЦикла;	
		
	Если ОтменитьСтроки Тогда
		Изменения 	= 	ПеребратьНоменклатураДокументаВладельца();
		ИтогДо		= 	Объект.ТоварыИзЗаказа.Итог("Количество");
		ИтогПосле	=	Объект.Товары.Итог("Количество");
		Если  ИтогДо=ИтогПосле И Изменения Тогда
			ОтменитьСтрокуВЗаказе();
			Возврат Изменения;
		КонецЕсли;	
	КонецЕсли;
	Возврат Ложь;	
КонецФункции // ПровестиДокументНаСервере()

// Процедура  записивает в таблицу СписокОтменныхЗаказов все отменнеые закази
//
// Параметры:
//   Массив        - Массив						   - Строки из таблицы СписокНоменклатуры, которые отменил пользователь
//   Номенклатура  - СправочникСсылка.Номенклатура - Номенклатуру,которую отменил пользователь	
&НаСервере
Процедура ПеренестиЗначенияНоменклатурыСОтменогоЗаказа(Массив,Номенклатура)
	УникальныйИндентификаторСтроки = СписокОтменныхЗаказов.Количество() + 1;
	Для Каждого Строка Из Массив Цикл
		НоваяСтрока = СписокОтменныхЗаказов.Добавить();
		ЗаполнитьЗначенияСвойств(НоваяСтрока,Строка);
		НоваяСтрока.НомерСтроки 		= УникальныйИндентификаторСтроки;
		УникальныйИндентификаторСтроки 	= УникальныйИндентификаторСтроки+1;
		НоваяСтрока.Номенклатура = Номенклатура;
	КонецЦикла;
КонецПроцедуры // ПеренестиЗначенияНоменклатурыСОтменогоЗаказа()

// Функция переносит назначения  из отмененных заказов у таблицу Товары 
//
// Параметры:
//  НЕТ
//
// Возвращаемое значение:
//   Булево  - Истина - если нужно изменять Таблицу "Товары" Владельца
//             ЛОЖЬ	  - если изменений не было	
&НаСервере
Функция ПеребратьНоменклатураДокументаВладельца()
	УстановитьПривилегированныйРежим(Истина);
	
	Проведен		= СслыкаНаДокумент.Проведен;
	ВалютаУпрУч		= Константы.ВалютаУправленческогоУчета.Получить();

	Запрос 			= Новый Запрос;
	Запрос.Текст 	= ПолучитьТекстЗапросаНоменклатурыПослеОтмены();
	Запрос.УстановитьПараметр("СписокЗаказовПоставщиков",	СписокОтменныхЗаказов.Выгрузить());
	Запрос.УстановитьПараметр("Товары",						Объект.ТоварыИзЗаказа.Выгрузить());
	Запрос.УстановитьПараметр("ЗаказПоставщику",			СслыкаНаДокумент);
	Запрос.УстановитьПараметр("Проведен",					Проведен);

	РезультатЗапроса = Запрос.Выполнить();
	
	Если РезультатЗапроса.Пустой() Тогда
		Возврат Ложь;
	КонецЕсли; 
	
	РезультатПакета				= Запрос.ВыполнитьПакет();
	ПроверкаНаИзмененияЗапроса 	= РезультатПакета[2].Пустой();
	
	Если НЕ ПроверкаНаИзмененияЗапроса Тогда
		Объект.Товары.Очистить();
		Объект.Товары.Загрузить(РезультатЗапроса.Выгрузить());	
	Иначе Возврат Ложь;
	КонецЕсли;
	
	Если ПривилегированныйРежим()  Тогда
	     УстановитьПривилегированныйРежим(Ложь);
	КонецЕсли; 
	Возврат Истина;
КонецФункции // ПеребратьНоменклатураДокументаВладельца(Номенклатура)
#КонецОбласти

&НаСервере
Процедура ПриИзменениеЦеныОбработатьСтрокуТЧ(ТекущаяСтрока)
	СтруктураДействий	= Новый Структура;	
	ЗаполнитьСтруктуруДействий(СтруктураДействий);
	ОбработкаТабличнойЧастиСервер.ОбработатьСтрокуТЧ(ТекущаяСтрока, СтруктураДействий, Неопределено);
КонецПроцедуры	
&НаСервере	
Процедура ЗаполнитьСтруктуруДействий(СтруктураДействий)
	СтруктураПересчетаСуммы = ОбработкаТабличнойЧастиКлиентСервер.ПолучитьСтруктуруПересчетаСуммыНДСВСтрокеТЧ(СслыкаНаДокумент);
	СтруктураДействий.Вставить("ПересчитатьСуммуНДС", СтруктураПересчетаСуммы);
	СтруктураДействий.Вставить("ПересчитатьСуммуСНДС", СтруктураПересчетаСуммы);
	СтруктураДействий.Вставить("ПересчитатьСумму");
	СтруктураДействий.Вставить("ПересчитатьСуммуСУчетомРучнойСкидки", Новый Структура("Очищать", Ложь));
	//СтруктураДействий.Вставить("ЗаполнитьДубликатыЗависимыхРеквизитов", ПолучитьСтруктуруЗависимыхРеквизитов());
КонецПроцедуры


#Область ТекстиЗапросов
// Функция текста запроса, получаем текст зароса номенклатуру которою отменяют 
//
// Параметры:
//  НЕТ
//
// Возвращаемое значение:
//   Строка  - текст запроса
//
&НаСервере
Функция ПолучитьТекстЗапросаНоменклатурыПослеОтмены()
	ТекстЗапроса ="ВЫБРАТЬ
	              |	СписокНазначения.НомерСтроки КАК НомерСтроки,
	              |	СписокНазначения.Номенклатура КАК Номенклатура,
	              |	СписокНазначения.НазначениеДоп КАК Назначение,
	              |	СписокНазначения.КоличествоДоп КАК КоличествоОстаток,
	              |	СписокНазначения.УпаковкаДоп КАК Упаковка,
	              |	СписокНазначения.ММ_Бонус КАК ММ_Бонус,
	              |	СписокНазначения.ММ_ВыписатьБонусНаПоставщика КАК ММ_ВыписатьБонусНаПоставщика
	              |ПОМЕСТИТЬ ТаблицаОтменныхЗаказов
	              |ИЗ
	              |	&СписокЗаказовПоставщиков КАК СписокНазначения
	              |
	              |ИНДЕКСИРОВАТЬ ПО
	              |	Номенклатура,
	              |	Упаковка
	              |;
	              |
	              |////////////////////////////////////////////////////////////////////////////////
	              |ВЫБРАТЬ
	              |	ТаблицаОтменныхЗаказов.Номенклатура КАК Номенклатура,
	              |	ТаблицаОтменныхЗаказов.Назначение КАК Назначение,
	              |	СУММА(ТаблицаОтменныхЗаказов.КоличествоОстаток) КАК КоличествоОстаток,
	              |	ТаблицаОтменныхЗаказов.Упаковка КАК Упаковка,
	              |	ТаблицаОтменныхЗаказов.ММ_Бонус,
	              |	МАКСИМУМ(ТаблицаОтменныхЗаказов.НомерСтроки) КАК НомерСтроки
	              |ПОМЕСТИТЬ ПроверкаНаРазнесенияНазначенияССпискаОтменныхЗаказов
	              |ИЗ
	              |	ТаблицаОтменныхЗаказов КАК ТаблицаОтменныхЗаказов
	              |ГДЕ
	              |	(ТаблицаОтменныхЗаказов.Назначение <> ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка)
	              |			ИЛИ ТаблицаОтменныхЗаказов.ММ_Бонус <> ЗНАЧЕНИЕ(Справочник.Номенклатура.ПустаяСсылка))
	              |
	              |СГРУППИРОВАТЬ ПО
	              |	ТаблицаОтменныхЗаказов.Номенклатура,
	              |	ТаблицаОтменныхЗаказов.Назначение,
	              |	ТаблицаОтменныхЗаказов.Упаковка,
	              |	ТаблицаОтменныхЗаказов.ММ_Бонус
	              |
				  |ИНДЕКСИРОВАТЬ ПО
	              |	Номенклатура,
	              |	Упаковка,
	              |	Назначение
	              |;
	              |
				  |////////////////////////////////////////////////////////////////////////////////
				  |ВЫБРАТЬ
				  |	ЗаказПоставщикуТовары.НомерСтроки КАК НомерСтроки,
				  |	ЗаказПоставщикуТовары.НоменклатураПоставщика,
				  |	ЗаказПоставщикуТовары.УникальныйИндентификаторСтроки КАК УникальныйИндентификаторСтроки,
				  |	ЗаказПоставщикуТовары.Номенклатура КАК Номенклатура,
				  |	ЗаказПоставщикуТовары.Характеристика,
				  |	ЗаказПоставщикуТовары.Упаковка КАК Упаковка,
				  |	ЗаказПоставщикуТовары.КоличествоУпаковок,
				  |	ЗаказПоставщикуТовары.Количество,
				  |	ЗаказПоставщикуТовары.ДатаПоступления,
				  |	ЗаказПоставщикуТовары.УсловиеЦеныПоставщика,
				  |	ЗаказПоставщикуТовары.Цена,
				  |	ЗаказПоставщикуТовары.Сумма,
				  |	ЗаказПоставщикуТовары.ПроцентРучнойСкидки,
				  |	ЗаказПоставщикуТовары.СуммаРучнойСкидки,
				  |	ЗаказПоставщикуТовары.СтавкаНДС,
				  |	ЗаказПоставщикуТовары.СуммаНДС,
				  |	ЗаказПоставщикуТовары.СуммаСНДС,
				  |	ЗаказПоставщикуТовары.КодСтроки,
				  |	ЗаказПоставщикуТовары.Отменено,
				  |	ЗаказПоставщикуТовары.СтатьяРасходов,
				  |	ЗаказПоставщикуТовары.АналитикаРасходов,
				  |	ЗаказПоставщикуТовары.ПричинаОтмены,
				  |	ЗаказПоставщикуТовары.Склад,
				  |	ЗаказПоставщикуТовары.Назначение,
				  |	ЗаказПоставщикуТовары.ММ_Бонус КАК ММ_Бонус,
				  |	ЗаказПоставщикуТовары.ММ_ВыписатьБонусНаПоставщика КАК ММ_ВыписатьБонусНаПоставщика
				  |ПОМЕСТИТЬ ТаблицаТоваров
				  |ИЗ
				  |	&Товары КАК ЗаказПоставщикуТовары  
				  |
				  |ИНДЕКСИРОВАТЬ ПО
				  |	НомерСтроки,
				  |	Номенклатура,
				  |	Упаковка
				  |;
				  |
				  |////////////////////////////////////////////////////////////////////////////////
				  |ВЫБРАТЬ
				  |	&ЗаказПоставщику КАК ЗаказПоставщику,
				  |	КешТоварБезБонусов.НомерСтроки,
				  |	КешТоварБезБонусов.НоменклатураПоставщика,
				  |	КешТоварБезБонусов.УникальныйИндентификаторСтроки,
				  |	КешТоварБезБонусов.Номенклатура,
				  |	КешТоварБезБонусов.Характеристика,
				  |	КешТоварБезБонусов.Упаковка,
				  |	КешТоварБезБонусов.КоличествоУпаковок,
				  |	КешТоварБезБонусов.Количество,
				  |	КешТоварБезБонусов.ДатаПоступления,
				  |	КешТоварБезБонусов.УсловиеЦеныПоставщика,
				  |	КешТоварБезБонусов.Цена,
				  |	КешТоварБезБонусов.Сумма,
				  |	КешТоварБезБонусов.ПроцентРучнойСкидки,
				  |	КешТоварБезБонусов.СуммаРучнойСкидки,
				  |	КешТоварБезБонусов.СтавкаНДС,
				  |	КешТоварБезБонусов.СуммаНДС,
				  |	КешТоварБезБонусов.СуммаСНДС,
				  |	КешТоварБезБонусов.КодСтроки,
				  |	КешТоварБезБонусов.Отменено,
				  |	КешТоварБезБонусов.СтатьяРасходов,
				  |	КешТоварБезБонусов.АналитикаРасходов,
				  |	КешТоварБезБонусов.ПричинаОтмены,
				  |	КешТоварБезБонусов.Склад,
				  |	КешТоварБезБонусов.Назначение,
				  |	КешТоварБезБонусов.ММ_Бонус,
				  |	КешТоварБезБонусов.ММ_ВыписатьБонусНаПоставщика
				  |ПОМЕСТИТЬ ТоварПоДокументу
				  |ИЗ
				  |	ТаблицаТоваров КАК КешТоварБезБонусов 
				  |;
				  |
				  |////////////////////////////////////////////////////////////////////////////////
				  |ВЫБРАТЬ
				  |	&ЗаказПоставщику КАК ЗаказПоставщику,
				  |	ТоварПоДокументу.КодСтроки,
				  |	ТоварПоДокументу.УникальныйИндентификаторСтроки,
				  |	ТоварПоДокументу.Номенклатура КАК Номенклатура,
				  |	ТоварПоДокументу.Склад КАК Склад,
				  |	ТоварПоДокументу.Упаковка КАК Упаковка,
				  |	ТоварПоДокументу.КоличествоУпаковок КАК Количество,
				  |	ТоварПоДокументу.Цена КАК Цена,
				  |	ТоварПоДокументу.ММ_Бонус,
				  |	ТоварПоДокументу.Назначение
				  |ПОМЕСТИТЬ КешНоменклатураДляРазбивки
				  |ИЗ
				  |	ТоварПоДокументу КАК ТоварПоДокументу
				  |ГДЕ
				  |	НЕ ТоварПоДокументу.Отменено
				  |	И (ТоварПоДокументу.Назначение = ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка)
				  |			ИЛИ ТоварПоДокументу.ММ_ВыписатьБонусНаПоставщика = ЛОЖЬ)
				  |
				  |ИНДЕКСИРОВАТЬ ПО
				  |	Номенклатура,
				  |	Упаковка
				  |;
				  |
				  |////////////////////////////////////////////////////////////////////////////////
				  |ВЫБРАТЬ
				  |	КешНоменклатура.ЗаказПоставщику КАК ЗаказПоставщику,
				  |	КешНоменклатура.УникальныйИндентификаторСтроки,
				  |	КешНоменклатура.КодСтроки КАК КодСтроки,
				  |	КешНоменклатура.Номенклатура КАК Номенклатура,
				  |	КешНоменклатура.Склад КАК Склад,
				  |	КешНоменклатура.Упаковка КАК Упаковка,
				  |	КешНоменклатура.Количество,
				  |	КешНоменклатура.Цена,
				  |	ВЫБОР
				  |		КОГДА &Проведен
				  |			ТОГДА ЕСТЬNULL(ЗаказыПоставщикамОстатки.ЗаказаноОстаток, 0)
				  |		ИНАЧЕ КешНоменклатура.Количество
				  |	КОНЕЦ КАК КоличествоОстаток,
				  |	КешНоменклатура.ММ_Бонус,
				  |	КешНоменклатура.Назначение
				  |ПОМЕСТИТЬ ОприходованоПоЗаказу
				  |ИЗ
				  |	КешНоменклатураДляРазбивки КАК КешНоменклатура
				  |		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.ЗаказыПоставщикам.Остатки(, ) КАК ЗаказыПоставщикамОстатки
				  |		ПО КешНоменклатура.ЗаказПоставщику = ЗаказыПоставщикамОстатки.ЗаказПоставщику
				  |			И КешНоменклатура.Номенклатура = ЗаказыПоставщикамОстатки.Номенклатура
				  |			И КешНоменклатура.КодСтроки = ЗаказыПоставщикамОстатки.КодСтроки
				  |
				  |ИНДЕКСИРОВАТЬ ПО
				  |	Номенклатура,
				  |	Упаковка
				  |;
				  |
				  |////////////////////////////////////////////////////////////////////////////////
				  |ВЫБРАТЬ
				  |	ОприходованоПоЗаказу.ЗаказПоставщику,
				  |	ОприходованоПоЗаказу.УникальныйИндентификаторСтроки,
				  |	ОприходованоПоЗаказу.КодСтроки,
				  |	ОприходованоПоЗаказу.Номенклатура КАК Номенклатура,
				  |	ОприходованоПоЗаказу.Склад,
				  |	ОприходованоПоЗаказу.Упаковка КАК Упаковка,
				  |	ОприходованоПоЗаказу.Цена,
				  |	ОприходованоПоЗаказу.КоличествоОстаток КАК Количество,
				  |	ОприходованоПоЗаказу.ММ_Бонус,
				  |	ОприходованоПоЗаказу.Назначение,
				  |	ВЫБОР
				  |		КОГДА ОприходованоПоЗаказу.КоличествоОстаток = ОприходованоПоЗаказу.Количество
				  |			ТОГДА ЛОЖЬ
				  |		ИНАЧЕ ИСТИНА
				  |	КОНЕЦ КАК НовыйКодСтроки
				  |ПОМЕСТИТЬ НеОприходованныйТовар
				  |ИЗ
				  |	ОприходованоПоЗаказу КАК ОприходованоПоЗаказу
				  |ГДЕ
				  |	ОприходованоПоЗаказу.КоличествоОстаток <> 0
				  |
				  |ИНДЕКСИРОВАТЬ ПО
				  |	Номенклатура,
				  |	Упаковка
				  |;
				  |
				  |////////////////////////////////////////////////////////////////////////////////
				  |ВЫБРАТЬ
				  |	РазнесенияНазначения.Номенклатура КАК Номенклатура,
				  |	РазнесенияНазначения.Назначение,
				  |	СУММА(РазнесенияНазначения.КоличествоОстаток) КАК КоличествоОстаток,
				  |	РазнесенияНазначения.Упаковка КАК Упаковка,
				  |	РазнесенияНазначения.ММ_Бонус,
				  |	МИНИМУМ(РазнесенияНазначения.НомерСтроки) КАК НомерСтроки,
				  |	ВЫРАЗИТЬ(РазнесенияНазначения.Назначение КАК Справочник.Назначения).Заказ КАК Заказ
				  |ПОМЕСТИТЬ ОС_СБонусами
				  |ИЗ
				  |	ПроверкаНаРазнесенияНазначенияССпискаОтменныхЗаказов КАК РазнесенияНазначения
				  |ГДЕ
				  |	РазнесенияНазначения.Назначение <> ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка)
				  |	И РазнесенияНазначения.ММ_Бонус <> ЗНАЧЕНИЕ(Справочник.Номенклатура.ПустаяСсылка)
				  |
				  |СГРУППИРОВАТЬ ПО
				  |	РазнесенияНазначения.Номенклатура,
				  |	РазнесенияНазначения.Назначение,
				  |	РазнесенияНазначения.Упаковка,
				  |	РазнесенияНазначения.ММ_Бонус
				  |
				  |ИНДЕКСИРОВАТЬ ПО
				  |	Номенклатура,
				  |	Упаковка
				  |;
				  |
				  |////////////////////////////////////////////////////////////////////////////////
				  |ВЫБРАТЬ
				  |	ТоварСНазначениям.НомерСтроки,
				  |	ТоварСНазначениям.Номенклатура КАК Номенклатура,
				  |	ТоварСНазначениям.Упаковка КАК Упаковка,
				  |	ТоварСНазначениям.Назначение,
				  |	ТоварСНазначениям.ММ_Бонус,
				  |	ТоварСНазначениям.КоличествоОстаток,
				  |	СУММА(ТоварСНазначенияКопия.КоличествоОстаток) - ТоварСНазначениям.КоличествоОстаток КАК СуммаДо,
				  |	СУММА(ТоварСНазначенияКопия.КоличествоОстаток) КАК СуммаПосле
				  |ПОМЕСТИТЬ ОС_СБонусамиНаростающие
				  |ИЗ
				  |	ОС_СБонусами КАК ТоварСНазначениям
				  |		ЛЕВОЕ СОЕДИНЕНИЕ ОС_СБонусами КАК ТоварСНазначенияКопия
				  |		ПО ТоварСНазначениям.Номенклатура = ТоварСНазначенияКопия.Номенклатура
				  |			И ТоварСНазначениям.Упаковка = ТоварСНазначенияКопия.Упаковка
				  |			И ТоварСНазначениям.НомерСтроки >= ТоварСНазначенияКопия.НомерСтроки
				  |
				  |СГРУППИРОВАТЬ ПО
				  |	ТоварСНазначениям.НомерСтроки,
				  |	ТоварСНазначениям.Номенклатура,
				  |	ТоварСНазначениям.Упаковка,
				  |	ТоварСНазначениям.Назначение,
				  |	ТоварСНазначениям.ММ_Бонус,
				  |	ТоварСНазначениям.КоличествоОстаток
				  |
				  |ИНДЕКСИРОВАТЬ ПО
				  |	Номенклатура,
				  |	Упаковка,
				  |	СуммаПосле
				  |;
				  |
				  |////////////////////////////////////////////////////////////////////////////////
				  |ВЫБРАТЬ
				  |	НеОприходованныйТовар.УникальныйИндентификаторСтроки,
				  |	НеОприходованныйТовар.КодСтроки,
				  |	НеОприходованныйТовар.Номенклатура,
				  |	НеОприходованныйТовар.Упаковка,
				  |	НеОприходованныйТовар.Количество,
				  |	НеОприходованныйТовар.ММ_Бонус,
				  |	НеОприходованныйТовар.Назначение,
				  |	НеОприходованныйТовар.НовыйКодСтроки
				  |ПОМЕСТИТЬ ТабПеребивкаНазначенияСБонусами
				  |ИЗ
				  |	НеОприходованныйТовар КАК НеОприходованныйТовар
				  |ГДЕ
				  |	НеОприходованныйТовар.Номенклатура В
				  |			(ВЫБРАТЬ РАЗЛИЧНЫЕ
				  |				ОС_СБонусами.Номенклатура
				  |			ИЗ
				  |				ОС_СБонусами КАК ОС_СБонусами)
				  |	И НеОприходованныйТовар.Назначение = ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка)
				  |;
				  |
				  |////////////////////////////////////////////////////////////////////////////////
				  |ВЫБРАТЬ
				  |	ТоварСНазначениям.КодСтроки,
				  |	ТоварСНазначениям.Номенклатура КАК Номенклатура,
				  |	ТоварСНазначениям.Упаковка КАК Упаковка,
				  |	ТоварСНазначениям.Назначение,
				  |	ТоварСНазначениям.ММ_Бонус,
				  |	ТоварСНазначениям.Количество,
				  |	СУММА(ТоварСНазначенияКопия.Количество) - ТоварСНазначениям.Количество КАК СуммаДо,
				  |	СУММА(ТоварСНазначенияКопия.Количество) КАК СуммаПосле,
				  |	ТоварСНазначениям.НовыйКодСтроки,
				  |	ТоварСНазначениям.УникальныйИндентификаторСтроки
				  |ПОМЕСТИТЬ ТабПеребивкаНазначенияСБонусамиНаростающие
				  |ИЗ
				  |	ТабПеребивкаНазначенияСБонусами КАК ТоварСНазначениям
				  |		ЛЕВОЕ СОЕДИНЕНИЕ ТабПеребивкаНазначенияСБонусами КАК ТоварСНазначенияКопия
				  |		ПО ТоварСНазначениям.Номенклатура = ТоварСНазначенияКопия.Номенклатура
				  |			И ТоварСНазначениям.Упаковка = ТоварСНазначенияКопия.Упаковка
				  |			И ТоварСНазначениям.УникальныйИндентификаторСтроки >= ТоварСНазначенияКопия.УникальныйИндентификаторСтроки
				  |
				  |СГРУППИРОВАТЬ ПО
				  |	ТоварСНазначениям.КодСтроки,
				  |	ТоварСНазначениям.Номенклатура,
				  |	ТоварСНазначениям.Упаковка,
				  |	ТоварСНазначениям.Назначение,
				  |	ТоварСНазначениям.ММ_Бонус,
				  |	ТоварСНазначениям.Количество,
				  |	ТоварСНазначениям.НовыйКодСтроки,
				  |	ТоварСНазначениям.УникальныйИндентификаторСтроки
				  |
				  |ИНДЕКСИРОВАТЬ ПО
				  |	Номенклатура,
				  |	Упаковка,
				  |	СуммаПосле
				  |;
				  |
				  |////////////////////////////////////////////////////////////////////////////////
				  |ВЫБРАТЬ
				  |	Наростающие.Номенклатура,
				  |	Наростающие.Упаковка,
				  |	Наростающие.СуммаПосле КАК Точка
				  |ПОМЕСТИТЬ ОС_СБонусамиТочкаПересечения
				  |ИЗ
				  |	ОС_СБонусамиНаростающие КАК Наростающие
				  |
				  |ОБЪЕДИНИТЬ
				  |
				  |ВЫБРАТЬ
				  |	Наростающие.Номенклатура,
				  |	Наростающие.Упаковка,
				  |	Наростающие.СуммаПосле
				  |ИЗ
				  |	ТабПеребивкаНазначенияСБонусамиНаростающие КАК Наростающие
				  |;
				  |
				  |////////////////////////////////////////////////////////////////////////////////
				  |ВЫБРАТЬ
				  |	ОС_СБонусамиТочкаПересечения.Номенклатура,
				  |	ОС_СБонусамиТочкаПересечения.Упаковка,
				  |	ОС_СБонусамиТочкаПересечения.Точка,
				  |	ВЫБОР
				  |		КОГДА ЕСТЬNULL(ОС_СБонусамиНаростающие.СуммаПосле, 0) >= ЕСТЬNULL(ТабПеребивкаНазначенияСБонусамиНаростающие.СуммаПосле, 0)
				  |				И ЕСТЬNULL(ТабПеребивкаНазначенияСБонусамиНаростающие.СуммаПосле, 0) <> 0
				  |				И ЕСТЬNULL(ОС_СБонусамиНаростающие.СуммаДо, 0) <= ЕСТЬNULL(ТабПеребивкаНазначенияСБонусамиНаростающие.СуммаДо, 0)
				  |			ТОГДА ЕСТЬNULL(ТабПеребивкаНазначенияСБонусамиНаростающие.СуммаПосле, 0) - ЕСТЬNULL(ТабПеребивкаНазначенияСБонусамиНаростающие.СуммаДо, 0)
				  |		КОГДА ЕСТЬNULL(ОС_СБонусамиНаростающие.СуммаПосле, 0) > ЕСТЬNULL(ТабПеребивкаНазначенияСБонусамиНаростающие.СуммаДо, 0)
				  |				И ЕСТЬNULL(ОС_СБонусамиНаростающие.СуммаПосле, 0) < ЕСТЬNULL(ТабПеребивкаНазначенияСБонусамиНаростающие.СуммаПосле, 0)
				  |			ТОГДА ЕСТЬNULL(ОС_СБонусамиНаростающие.СуммаПосле, 0) - ЕСТЬNULL(ТабПеребивкаНазначенияСБонусамиНаростающие.СуммаДо, 0)
				  |		КОГДА ЕСТЬNULL(ОС_СБонусамиНаростающие.СуммаПосле, 0) >= ЕСТЬNULL(ТабПеребивкаНазначенияСБонусамиНаростающие.СуммаПосле, 0)
				  |				И ЕСТЬNULL(ОС_СБонусамиНаростающие.СуммаДо, 0) > ЕСТЬNULL(ТабПеребивкаНазначенияСБонусамиНаростающие.СуммаДо, 0)
				  |				И ЕСТЬNULL(ТабПеребивкаНазначенияСБонусамиНаростающие.СуммаПосле, 0) <> 0
				  |			ТОГДА ЕСТЬNULL(ТабПеребивкаНазначенияСБонусамиНаростающие.СуммаПосле, 0) - ЕСТЬNULL(ОС_СБонусамиНаростающие.СуммаДо, 0)
				  |		ИНАЧЕ ЕСТЬNULL(ОС_СБонусамиНаростающие.СуммаПосле, 0) - ЕСТЬNULL(ОС_СБонусамиНаростающие.СуммаДо, 0)
				  |	КОНЕЦ КАК КоличествоОстаток,
				  |	ВЫБОР
				  |		КОГДА ЕСТЬNULL(ТабПеребивкаНазначенияСБонусамиНаростающие.ММ_Бонус, ЗНАЧЕНИЕ(Справочник.Номенклатура.ПустаяСсылка)) = ЗНАЧЕНИЕ(Справочник.Номенклатура.ПустаяСсылка)
				  |			ТОГДА ЕСТЬNULL(ОС_СБонусамиНаростающие.ММ_Бонус, ЗНАЧЕНИЕ(Справочник.Номенклатура.ПустаяСсылка))
				  |		ИНАЧЕ ЕСТЬNULL(ТабПеребивкаНазначенияСБонусамиНаростающие.ММ_Бонус, ЗНАЧЕНИЕ(Справочник.Номенклатура.ПустаяСсылка))
				  |	КОНЕЦ КАК ММ_Бонус,
				  |	ВЫБОР
				  |		КОГДА ЕСТЬNULL(ТабПеребивкаНазначенияСБонусамиНаростающие.Назначение, ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка)) = ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка)
				  |			ТОГДА ЕСТЬNULL(ОС_СБонусамиНаростающие.Назначение, ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка))
				  |		ИНАЧЕ ЕСТЬNULL(ТабПеребивкаНазначенияСБонусамиНаростающие.Назначение, ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка))
				  |	КОНЕЦ КАК Назначение,
				  |	ВЫБОР
				  |		КОГДА ТабПеребивкаНазначенияСБонусамиНаростающие.СуммаДо >= ОС_СБонусамиНаростающие.СуммаДо
				  |				И ЕСТЬNULL(ТабПеребивкаНазначенияСБонусамиНаростающие.НовыйКодСтроки, ЛОЖЬ) = ЛОЖЬ
				  |			ТОГДА ТабПеребивкаНазначенияСБонусамиНаростающие.КодСтроки
				  |		ИНАЧЕ 0
				  |	КОНЕЦ КАК КодСтроки,
				  |	ЕСТЬNULL(ТабПеребивкаНазначенияСБонусамиНаростающие.КодСтроки, 0) КАК СтарыйКодСтроки,
				  |	ЕСТЬNULL(ТабПеребивкаНазначенияСБонусамиНаростающие.УникальныйИндентификаторСтроки, 0) КАК УникальныйИндентификаторСтроки
				  |ПОМЕСТИТЬ ОбъединенияЗПСНазначениямСБонусами
				  |ИЗ
				  |	ОС_СБонусамиТочкаПересечения КАК ОС_СБонусамиТочкаПересечения
				  |		ЛЕВОЕ СОЕДИНЕНИЕ ОС_СБонусамиНаростающие КАК ОС_СБонусамиНаростающие
				  |		ПО ОС_СБонусамиТочкаПересечения.Номенклатура = ОС_СБонусамиНаростающие.Номенклатура
				  |			И ОС_СБонусамиТочкаПересечения.Упаковка = ОС_СБонусамиНаростающие.Упаковка
				  |			И ОС_СБонусамиТочкаПересечения.Точка > ОС_СБонусамиНаростающие.СуммаДо
				  |			И ОС_СБонусамиТочкаПересечения.Точка <= ОС_СБонусамиНаростающие.СуммаПосле
				  |		ЛЕВОЕ СОЕДИНЕНИЕ ТабПеребивкаНазначенияСБонусамиНаростающие КАК ТабПеребивкаНазначенияСБонусамиНаростающие
				  |		ПО ОС_СБонусамиТочкаПересечения.Номенклатура = ТабПеребивкаНазначенияСБонусамиНаростающие.Номенклатура
				  |			И ОС_СБонусамиТочкаПересечения.Упаковка = ТабПеребивкаНазначенияСБонусамиНаростающие.Упаковка
				  |			И ОС_СБонусамиТочкаПересечения.Точка > ТабПеребивкаНазначенияСБонусамиНаростающие.СуммаДо
				  |			И ОС_СБонусамиТочкаПересечения.Точка <= ТабПеребивкаНазначенияСБонусамиНаростающие.СуммаПосле
				  |;
				  |
				  |////////////////////////////////////////////////////////////////////////////////
				  |ВЫБРАТЬ
				  |	ОбъединенияЗПСНазначениямСБонусами.Номенклатура,
				  |	ОбъединенияЗПСНазначениямСБонусами.Упаковка,
				  |	ОбъединенияЗПСНазначениямСБонусами.КоличествоОстаток,
				  |	ОбъединенияЗПСНазначениямСБонусами.ММ_Бонус,
				  |	ОбъединенияЗПСНазначениямСБонусами.Назначение,
				  |	ОбъединенияЗПСНазначениямСБонусами.КодСтроки,
				  |	ОбъединенияЗПСНазначениямСБонусами.СтарыйКодСтроки,
				  |	ОбъединенияЗПСНазначениямСБонусами.УникальныйИндентификаторСтроки
				  |ПОМЕСТИТЬ РазбивкаТовараСНазначениямИБонусами
				  |ИЗ
				  |	ОбъединенияЗПСНазначениямСБонусами КАК ОбъединенияЗПСНазначениямСБонусами
				  |ГДЕ
				  |	ОбъединенияЗПСНазначениямСБонусами.КоличествоОстаток <> 0
				  |	И ОбъединенияЗПСНазначениямСБонусами.УникальныйИндентификаторСтроки <> 0
				  |;
				  |
				  |////////////////////////////////////////////////////////////////////////////////
				  |ВЫБРАТЬ
				  |	РазбивкаТовараСНазначениямИБонусами.СтарыйКодСтроки,
				  |	РазбивкаТовараСНазначениямИБонусами.Номенклатура,
				  |	СУММА(РазбивкаТовараСНазначениямИБонусами.КоличествоОстаток) КАК КоличествоОстаток,
				  |	РазбивкаТовараСНазначениямИБонусами.Упаковка
				  |ПОМЕСТИТЬ СуммаРазбивкаТовараСНазначениямИБонусами
				  |ИЗ
				  |	РазбивкаТовараСНазначениямИБонусами КАК РазбивкаТовараСНазначениямИБонусами
				  |
				  |СГРУППИРОВАТЬ ПО
				  |	РазбивкаТовараСНазначениямИБонусами.СтарыйКодСтроки,
				  |	РазбивкаТовараСНазначениямИБонусами.Номенклатура,
				  |	РазбивкаТовараСНазначениямИБонусами.Упаковка
				  |;
				  |
				  |////////////////////////////////////////////////////////////////////////////////
				  |ВЫБРАТЬ
				  |	РазнесенияНазначения.Номенклатура КАК Номенклатура,
				  |	РазнесенияНазначения.Назначение,
				  |	СУММА(РазнесенияНазначения.КоличествоОстаток) КАК КоличествоОстаток,
				  |	РазнесенияНазначения.Упаковка КАК Упаковка,
				  |	РазнесенияНазначения.ММ_Бонус,
				  |	МИНИМУМ(РазнесенияНазначения.НомерСтроки) КАК НомерСтроки,
				  |	ВЫРАЗИТЬ(РазнесенияНазначения.Назначение КАК Справочник.Назначения).Заказ КАК Заказ
				  |ПОМЕСТИТЬ ОС_СНазначения
				  |ИЗ
				  |	ПроверкаНаРазнесенияНазначенияССпискаОтменныхЗаказов КАК РазнесенияНазначения
				  |ГДЕ
				  |	РазнесенияНазначения.Назначение <> ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка)
				  |	И РазнесенияНазначения.ММ_Бонус = ЗНАЧЕНИЕ(Справочник.Номенклатура.ПустаяСсылка)
				  |
				  |СГРУППИРОВАТЬ ПО
				  |	РазнесенияНазначения.Номенклатура,
				  |	РазнесенияНазначения.Назначение,
				  |	РазнесенияНазначения.Упаковка,
				  |	РазнесенияНазначения.ММ_Бонус
				  |
				  |ИНДЕКСИРОВАТЬ ПО
				  |	Номенклатура,
				  |	Упаковка
				  |;
				  |
				  |////////////////////////////////////////////////////////////////////////////////
				  |ВЫБРАТЬ
				  |	ТоварСНазначениям.НомерСтроки,
				  |	ТоварСНазначениям.Номенклатура КАК Номенклатура,
				  |	ТоварСНазначениям.Упаковка КАК Упаковка,
				  |	ТоварСНазначениям.Назначение,
				  |	ТоварСНазначениям.ММ_Бонус,
				  |	ТоварСНазначениям.КоличествоОстаток,
				  |	СУММА(ТоварСНазначенияКопия.КоличествоОстаток) - ТоварСНазначениям.КоличествоОстаток КАК СуммаДо,
				  |	СУММА(ТоварСНазначенияКопия.КоличествоОстаток) КАК СуммаПосле
				  |ПОМЕСТИТЬ ОС_СНазначенияНаростающие
				  |ИЗ
				  |	ОС_СНазначения КАК ТоварСНазначениям
				  |		ЛЕВОЕ СОЕДИНЕНИЕ ОС_СНазначения КАК ТоварСНазначенияКопия
				  |		ПО ТоварСНазначениям.Номенклатура = ТоварСНазначенияКопия.Номенклатура
				  |			И ТоварСНазначениям.Упаковка = ТоварСНазначенияКопия.Упаковка
				  |			И ТоварСНазначениям.НомерСтроки >= ТоварСНазначенияКопия.НомерСтроки
				  |
				  |СГРУППИРОВАТЬ ПО
				  |	ТоварСНазначениям.НомерСтроки,
				  |	ТоварСНазначениям.Номенклатура,
				  |	ТоварСНазначениям.Упаковка,
				  |	ТоварСНазначениям.Назначение,
				  |	ТоварСНазначениям.ММ_Бонус,
				  |	ТоварСНазначениям.КоличествоОстаток
				  |
				  |ИНДЕКСИРОВАТЬ ПО
				  |	Номенклатура,
				  |	Упаковка,
				  |	СуммаПосле
				  |;
				  |
				  |////////////////////////////////////////////////////////////////////////////////
				  |ВЫБРАТЬ
				  |	НеОприходованныйТовар.ЗаказПоставщику,
				  |	НеОприходованныйТовар.УникальныйИндентификаторСтроки,
				  |	НеОприходованныйТовар.КодСтроки,
				  |	НеОприходованныйТовар.Номенклатура,
				  |	НеОприходованныйТовар.Склад,
				  |	НеОприходованныйТовар.Упаковка,
				  |	НеОприходованныйТовар.Цена,
				  |	НеОприходованныйТовар.Количество - ЕСТЬNULL(СуммаРазбивкаТовараСНазначениямИБонусами.КоличествоОстаток, 0) КАК Количество,
				  |	НеОприходованныйТовар.ММ_Бонус,
				  |	НеОприходованныйТовар.Назначение,
				  |	ВЫБОР
				  |		КОГДА ЕСТЬNULL(СуммаРазбивкаТовараСНазначениямИБонусами.КоличествоОстаток, 0) <> 0
				  |			ТОГДА ИСТИНА
				  |		ИНАЧЕ НеОприходованныйТовар.НовыйКодСтроки
				  |	КОНЕЦ КАК НовыйКодСтроки
				  |ПОМЕСТИТЬ НеРазнесенныйТоварПослеБонусов
				  |ИЗ
				  |	НеОприходованныйТовар КАК НеОприходованныйТовар
				  |		ЛЕВОЕ СОЕДИНЕНИЕ СуммаРазбивкаТовараСНазначениямИБонусами КАК СуммаРазбивкаТовараСНазначениямИБонусами
				  |		ПО НеОприходованныйТовар.Номенклатура = СуммаРазбивкаТовараСНазначениямИБонусами.Номенклатура
				  |			И НеОприходованныйТовар.КодСтроки = СуммаРазбивкаТовараСНазначениямИБонусами.СтарыйКодСтроки
				  |			И НеОприходованныйТовар.Упаковка = СуммаРазбивкаТовараСНазначениямИБонусами.Упаковка
				  |ГДЕ
				  |	НеОприходованныйТовар.Номенклатура В
				  |			(ВЫБРАТЬ РАЗЛИЧНЫЕ
				  |				ОС_СНазначения.Номенклатура
				  |			ИЗ
				  |				ОС_СНазначения КАК ОС_СНазначения)
				  |	И НеОприходованныйТовар.Назначение = ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка)
				  |	И НеОприходованныйТовар.Количество - ЕСТЬNULL(СуммаРазбивкаТовараСНазначениямИБонусами.КоличествоОстаток, 0) > 0
				  |;
				  |
				  |////////////////////////////////////////////////////////////////////////////////
				  |ВЫБРАТЬ
				  |	ТоварСНазначениям.КодСтроки,
				  |	ТоварСНазначениям.Номенклатура КАК Номенклатура,
				  |	ТоварСНазначениям.Упаковка КАК Упаковка,
				  |	ТоварСНазначениям.Назначение,
				  |	ТоварСНазначениям.ММ_Бонус,
				  |	ТоварСНазначениям.Количество,
				  |	СУММА(ТоварСНазначенияКопия.Количество) - ТоварСНазначениям.Количество КАК СуммаДо,
				  |	СУММА(ТоварСНазначенияКопия.Количество) КАК СуммаПосле,
				  |	ТоварСНазначениям.НовыйКодСтроки,
				  |	ТоварСНазначениям.УникальныйИндентификаторСтроки
				  |ПОМЕСТИТЬ ТабПеребивкаНазначенияНаростающие
				  |ИЗ
				  |	НеРазнесенныйТоварПослеБонусов КАК ТоварСНазначениям
				  |		ЛЕВОЕ СОЕДИНЕНИЕ НеРазнесенныйТоварПослеБонусов КАК ТоварСНазначенияКопия
				  |		ПО ТоварСНазначениям.Номенклатура = ТоварСНазначенияКопия.Номенклатура
				  |			И ТоварСНазначениям.Упаковка = ТоварСНазначенияКопия.Упаковка
				  |			И ТоварСНазначениям.КодСтроки >= ТоварСНазначенияКопия.КодСтроки
				  |
				  |СГРУППИРОВАТЬ ПО
				  |	ТоварСНазначениям.КодСтроки,
				  |	ТоварСНазначениям.Номенклатура,
				  |	ТоварСНазначениям.Упаковка,
				  |	ТоварСНазначениям.Назначение,
				  |	ТоварСНазначениям.ММ_Бонус,
				  |	ТоварСНазначениям.Количество,
				  |	ТоварСНазначениям.НовыйКодСтроки,
				  |	ТоварСНазначениям.УникальныйИндентификаторСтроки
				  |
				  |ИНДЕКСИРОВАТЬ ПО
				  |	Номенклатура,
				  |	Упаковка,
				  |	СуммаПосле
				  |;
				  |
				  |////////////////////////////////////////////////////////////////////////////////
				  |ВЫБРАТЬ
				  |	Наростающие.Номенклатура,
				  |	Наростающие.Упаковка,
				  |	Наростающие.СуммаПосле КАК Точка
				  |ПОМЕСТИТЬ ОС_НазначенияТочкаПересечения
				  |ИЗ
				  |	ОС_СНазначенияНаростающие КАК Наростающие
				  |
				  |ОБЪЕДИНИТЬ
				  |
				  |ВЫБРАТЬ
				  |	Наростающие.Номенклатура,
				  |	Наростающие.Упаковка,
				  |	Наростающие.СуммаПосле
				  |ИЗ
				  |	ТабПеребивкаНазначенияНаростающие КАК Наростающие
				  |;
				  |
				  |////////////////////////////////////////////////////////////////////////////////
				  |ВЫБРАТЬ
				  |	ОС_НазначенияТочкаПересечения.Номенклатура,
				  |	ОС_НазначенияТочкаПересечения.Упаковка,
				  |	ОС_НазначенияТочкаПересечения.Точка,
				  |	ВЫБОР
				  |		КОГДА ЕСТЬNULL(ОС_Наростающие.СуммаПосле, 0) >= ЕСТЬNULL(ТабПеребивкаНазначенияНаростающие.СуммаПосле, 0)
				  |				И ЕСТЬNULL(ТабПеребивкаНазначенияНаростающие.СуммаПосле, 0) <> 0
				  |				И ЕСТЬNULL(ОС_Наростающие.СуммаДо, 0) <= ЕСТЬNULL(ТабПеребивкаНазначенияНаростающие.СуммаДо, 0)
				  |			ТОГДА ЕСТЬNULL(ТабПеребивкаНазначенияНаростающие.СуммаПосле, 0) - ЕСТЬNULL(ТабПеребивкаНазначенияНаростающие.СуммаДо, 0)
				  |		КОГДА ЕСТЬNULL(ОС_Наростающие.СуммаПосле, 0) > ЕСТЬNULL(ТабПеребивкаНазначенияНаростающие.СуммаДо, 0)
				  |				И ЕСТЬNULL(ОС_Наростающие.СуммаПосле, 0) < ЕСТЬNULL(ТабПеребивкаНазначенияНаростающие.СуммаПосле, 0)
				  |			ТОГДА ЕСТЬNULL(ОС_Наростающие.СуммаПосле, 0) - ЕСТЬNULL(ТабПеребивкаНазначенияНаростающие.СуммаДо, 0)
				  |		КОГДА ЕСТЬNULL(ОС_Наростающие.СуммаПосле, 0) >= ЕСТЬNULL(ТабПеребивкаНазначенияНаростающие.СуммаПосле, 0)
				  |				И ЕСТЬNULL(ОС_Наростающие.СуммаДо, 0) > ЕСТЬNULL(ТабПеребивкаНазначенияНаростающие.СуммаДо, 0)
				  |				И ЕСТЬNULL(ТабПеребивкаНазначенияНаростающие.СуммаПосле, 0) <> 0
				  |			ТОГДА ЕСТЬNULL(ТабПеребивкаНазначенияНаростающие.СуммаПосле, 0) - ЕСТЬNULL(ОС_Наростающие.СуммаДо, 0)
				  |		ИНАЧЕ ЕСТЬNULL(ОС_Наростающие.СуммаПосле, 0) - ЕСТЬNULL(ОС_Наростающие.СуммаДо, 0)
				  |	КОНЕЦ КАК КоличествоОстаток,
				  |	ВЫБОР
				  |		КОГДА ЕСТЬNULL(ТабПеребивкаНазначенияНаростающие.ММ_Бонус, ЗНАЧЕНИЕ(Справочник.Номенклатура.ПустаяСсылка)) = ЗНАЧЕНИЕ(Справочник.Номенклатура.ПустаяСсылка)
				  |			ТОГДА ЕСТЬNULL(ОС_Наростающие.ММ_Бонус, ЗНАЧЕНИЕ(Справочник.Номенклатура.ПустаяСсылка))
				  |		ИНАЧЕ ЕСТЬNULL(ТабПеребивкаНазначенияНаростающие.ММ_Бонус, ЗНАЧЕНИЕ(Справочник.Номенклатура.ПустаяСсылка))
				  |	КОНЕЦ КАК ММ_Бонус,
				  |	ВЫБОР
				  |		КОГДА ЕСТЬNULL(ТабПеребивкаНазначенияНаростающие.Назначение, ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка)) = ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка)
				  |			ТОГДА ЕСТЬNULL(ОС_Наростающие.Назначение, ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка))
				  |		ИНАЧЕ ЕСТЬNULL(ТабПеребивкаНазначенияНаростающие.Назначение, ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка))
				  |	КОНЕЦ КАК Назначение,
				  |	ВЫБОР
				  |		КОГДА ТабПеребивкаНазначенияНаростающие.СуммаДо >= ОС_Наростающие.СуммаДо
				  |				И ЕСТЬNULL(ТабПеребивкаНазначенияНаростающие.НовыйКодСтроки, ЛОЖЬ) = ЛОЖЬ
				  |			ТОГДА ТабПеребивкаНазначенияНаростающие.КодСтроки
				  |		ИНАЧЕ 0
				  |	КОНЕЦ КАК КодСтроки,
				  |	ЕСТЬNULL(ТабПеребивкаНазначенияНаростающие.КодСтроки, 0) КАК СтарыйКодСтроки,
				  |	ТабПеребивкаНазначенияНаростающие.УникальныйИндентификаторСтроки
				  |ПОМЕСТИТЬ ОбъединенияЗППоНазначениям
				  |ИЗ
				  |	ОС_НазначенияТочкаПересечения КАК ОС_НазначенияТочкаПересечения
				  |		ЛЕВОЕ СОЕДИНЕНИЕ ОС_СНазначенияНаростающие КАК ОС_Наростающие
				  |		ПО ОС_НазначенияТочкаПересечения.Номенклатура = ОС_Наростающие.Номенклатура
				  |			И ОС_НазначенияТочкаПересечения.Упаковка = ОС_Наростающие.Упаковка
				  |			И ОС_НазначенияТочкаПересечения.Точка > ОС_Наростающие.СуммаДо
				  |			И ОС_НазначенияТочкаПересечения.Точка <= ОС_Наростающие.СуммаПосле
				  |		ЛЕВОЕ СОЕДИНЕНИЕ ТабПеребивкаНазначенияНаростающие КАК ТабПеребивкаНазначенияНаростающие
				  |		ПО ОС_НазначенияТочкаПересечения.Номенклатура = ТабПеребивкаНазначенияНаростающие.Номенклатура
				  |			И ОС_НазначенияТочкаПересечения.Упаковка = ТабПеребивкаНазначенияНаростающие.Упаковка
				  |			И ОС_НазначенияТочкаПересечения.Точка > ТабПеребивкаНазначенияНаростающие.СуммаДо
				  |			И ОС_НазначенияТочкаПересечения.Точка <= ТабПеребивкаНазначенияНаростающие.СуммаПосле
				  |;
				  |
				  |////////////////////////////////////////////////////////////////////////////////
				  |ВЫБРАТЬ
				  |	ОбъединенияЗППоНазначениям.Номенклатура,
				  |	ОбъединенияЗППоНазначениям.Упаковка,
				  |	ОбъединенияЗППоНазначениям.КоличествоОстаток,
				  |	ОбъединенияЗППоНазначениям.ММ_Бонус,
				  |	ОбъединенияЗППоНазначениям.Назначение,
				  |	ОбъединенияЗППоНазначениям.КодСтроки,
				  |	ОбъединенияЗППоНазначениям.СтарыйКодСтроки,
				  |	ОбъединенияЗППоНазначениям.УникальныйИндентификаторСтроки
				  |ПОМЕСТИТЬ РазбивкаТовараСНазначениям
				  |ИЗ
				  |	ОбъединенияЗППоНазначениям КАК ОбъединенияЗППоНазначениям
				  |ГДЕ
				  |	ОбъединенияЗППоНазначениям.КоличествоОстаток <> 0
				  |	И ОбъединенияЗППоНазначениям.УникальныйИндентификаторСтроки <> 0
				  |;
				  |
				  |////////////////////////////////////////////////////////////////////////////////
				  |ВЫБРАТЬ
				  |	ПроверкаНаРазнесенияНазначенияССпискаОтменныхЗаказов.Номенклатура,
				  |	ПроверкаНаРазнесенияНазначенияССпискаОтменныхЗаказов.Упаковка,
				  |	ПроверкаНаРазнесенияНазначенияССпискаОтменныхЗаказов.ММ_Бонус,
				  |	ПроверкаНаРазнесенияНазначенияССпискаОтменныхЗаказов.Назначение,
				  |	ПроверкаНаРазнесенияНазначенияССпискаОтменныхЗаказов.КоличествоОстаток - ЕСТЬNULL(ПеребитыйТовар.КоличествоОстаток, 0) КАК КоличествоОстаток,
				  |	ПроверкаНаРазнесенияНазначенияССпискаОтменныхЗаказов.НомерСтроки
				  |ПОМЕСТИТЬ ТоварСНазначениямССпискаОтменныхЗаказов
				  |ИЗ
				  |	ПроверкаНаРазнесенияНазначенияССпискаОтменныхЗаказов КАК ПроверкаНаРазнесенияНазначенияССпискаОтменныхЗаказов
				  |		ЛЕВОЕ СОЕДИНЕНИЕ (ВЫБРАТЬ
				  |			РазбивкаТовараСНазначениямИБонусами.Назначение КАК Назначение,
				  |			СУММА(РазбивкаТовараСНазначениямИБонусами.КоличествоОстаток) КАК КоличествоОстаток,
				  |			РазбивкаТовараСНазначениямИБонусами.Номенклатура КАК Номенклатура,
				  |			РазбивкаТовараСНазначениямИБонусами.Упаковка КАК Упаковка
				  |		ИЗ
				  |			РазбивкаТовараСНазначениямИБонусами КАК РазбивкаТовараСНазначениямИБонусами
				  |		ГДЕ
				  |			РазбивкаТовараСНазначениямИБонусами.ММ_Бонус = ЗНАЧЕНИЕ(Справочник.Номенклатура.ПустаяСсылка)
				  |		
				  |		СГРУППИРОВАТЬ ПО
				  |			РазбивкаТовараСНазначениямИБонусами.Назначение,
				  |			РазбивкаТовараСНазначениямИБонусами.Номенклатура,
				  |			РазбивкаТовараСНазначениямИБонусами.Упаковка) КАК ПеребитыйТовар
				  |		ПО ПроверкаНаРазнесенияНазначенияССпискаОтменныхЗаказов.Номенклатура = ПеребитыйТовар.Номенклатура
				  |			И ПроверкаНаРазнесенияНазначенияССпискаОтменныхЗаказов.Упаковка = ПеребитыйТовар.Упаковка
				  |			И ПроверкаНаРазнесенияНазначенияССпискаОтменныхЗаказов.Назначение = ПеребитыйТовар.Назначение
				  |ГДЕ
				  |	ПроверкаНаРазнесенияНазначенияССпискаОтменныхЗаказов.КоличествоОстаток - ЕСТЬNULL(ПеребитыйТовар.КоличествоОстаток, 0) > 0
				  |;
				  |
				  |////////////////////////////////////////////////////////////////////////////////
				  |ВЫБРАТЬ
				  |	НеОприходованныйТовар.ЗаказПоставщику,
				  |	НеОприходованныйТовар.КодСтроки,
				  |	НеОприходованныйТовар.УникальныйИндентификаторСтроки,
				  |	НеОприходованныйТовар.Номенклатура,
				  |	НеОприходованныйТовар.Склад,
				  |	НеОприходованныйТовар.Упаковка,
				  |	НеОприходованныйТовар.Количество - ЕСТЬNULL(СуммаРазбивкаТовараСНазначениямИБонусами.КоличествоОстаток, 0) КАК КоличествоУпаковок,
				  |	НеОприходованныйТовар.Цена,
				  |	НеОприходованныйТовар.ММ_Бонус,
				  |	НеОприходованныйТовар.Назначение,
				  |	ВЫБОР
				  |		КОГДА ЕСТЬNULL(СуммаРазбивкаТовараСНазначениямИБонусами.КоличествоОстаток, 0) <> 0
				  |			ТОГДА ИСТИНА
				  |		ИНАЧЕ НеОприходованныйТовар.НовыйКодСтроки
				  |	КОНЕЦ КАК НовыйКодСтроки
				  |ПОМЕСТИТЬ КешТоварБезБонусов
				  |ИЗ
				  |	НеОприходованныйТовар КАК НеОприходованныйТовар
				  |		ЛЕВОЕ СОЕДИНЕНИЕ СуммаРазбивкаТовараСНазначениямИБонусами КАК СуммаРазбивкаТовараСНазначениямИБонусами
				  |		ПО НеОприходованныйТовар.Номенклатура = СуммаРазбивкаТовараСНазначениямИБонусами.Номенклатура
				  |			И НеОприходованныйТовар.Упаковка = СуммаРазбивкаТовараСНазначениямИБонусами.Упаковка
				  |			И НеОприходованныйТовар.КодСтроки = СуммаРазбивкаТовараСНазначениямИБонусами.СтарыйКодСтроки
				  |ГДЕ
				  |	НеОприходованныйТовар.Количество - ЕСТЬNULL(СуммаРазбивкаТовараСНазначениямИБонусами.КоличествоОстаток, 0) > 0
				  |	И НеОприходованныйТовар.ММ_Бонус = ЗНАЧЕНИЕ(Справочник.Номенклатура.ПустаяСсылка)
				  |	И (НеОприходованныйТовар.Номенклатура, НеОприходованныйТовар.Упаковка, НеОприходованныйТовар.Назначение) В
				  |			(ВЫБРАТЬ РАЗЛИЧНЫЕ
				  |				ТоварСНазначениямССпискаОтменныхЗаказов.Номенклатура,
				  |				ТоварСНазначениямССпискаОтменныхЗаказов.Упаковка,
				  |				ТоварСНазначениямССпискаОтменныхЗаказов.Назначение
				  |			ИЗ
				  |				ТоварСНазначениямССпискаОтменныхЗаказов КАК ТоварСНазначениямССпискаОтменныхЗаказов)
				  |;
				  |
				  |////////////////////////////////////////////////////////////////////////////////
				  |ВЫБРАТЬ
				  |	Товар.УникальныйИндентификаторСтроки,
				  |	Товар.Номенклатура,
				  |	Товар.Упаковка,
				  |	Товар.Назначение,
				  |	Товар.ММ_Бонус,
				  |	Товар.КоличествоУпаковок,
				  |	СУММА(ТоварКопия.КоличествоУпаковок) - Товар.КоличествоУпаковок КАК СуммаДо,
				  |	СУММА(ТоварКопия.КоличествоУпаковок) КАК СуммаПосле
				  |ПОМЕСТИТЬ ТоварСНазначенияНаростающие
				  |ИЗ
				  |	КешТоварБезБонусов КАК Товар
				  |		ЛЕВОЕ СОЕДИНЕНИЕ КешТоварБезБонусов КАК ТоварКопия
				  |		ПО Товар.Номенклатура = ТоварКопия.Номенклатура
				  |			И Товар.Упаковка = ТоварКопия.Упаковка
				  |			И Товар.Назначение = ТоварКопия.Назначение
				  |			И Товар.ММ_Бонус = ТоварКопия.ММ_Бонус
				  |			И Товар.УникальныйИндентификаторСтроки >= ТоварКопия.УникальныйИндентификаторСтроки
				  |
				  |СГРУППИРОВАТЬ ПО
				  |	Товар.УникальныйИндентификаторСтроки,
				  |	Товар.Номенклатура,
				  |	Товар.Упаковка,
				  |	Товар.Назначение,
				  |	Товар.ММ_Бонус,
				  |	Товар.КоличествоУпаковок
				  |;
				  |
				  |////////////////////////////////////////////////////////////////////////////////
				  |ВЫБРАТЬ
				  |	ТоварСНазначениямССпискаОтменныхЗаказов.Номенклатура,
				  |	ТоварСНазначениямССпискаОтменныхЗаказов.Назначение,
				  |	ТоварСНазначениямССпискаОтменныхЗаказов.КоличествоОстаток,
				  |	ТоварСНазначениямССпискаОтменныхЗаказов.Упаковка,
				  |	ТоварСНазначениямССпискаОтменныхЗаказов.ММ_Бонус,
				  |	ТоварСНазначениямССпискаОтменныхЗаказов.НомерСтроки,
				  |	СУММА(ТоварСНазначениямССпискаОтменныхЗаказовКопия.КоличествоОстаток) - ТоварСНазначениямССпискаОтменныхЗаказов.КоличествоОстаток КАК СуммаДо,
				  |	СУММА(ТоварСНазначениямССпискаОтменныхЗаказовКопия.КоличествоОстаток) КАК СуммаПосле
				  |ПОМЕСТИТЬ ТоварСНазначениямССпискаОтменныхЗаказовНаростающие
				  |ИЗ
				  |	ТоварСНазначениямССпискаОтменныхЗаказов КАК ТоварСНазначениямССпискаОтменныхЗаказов
				  |		ЛЕВОЕ СОЕДИНЕНИЕ ТоварСНазначениямССпискаОтменныхЗаказов КАК ТоварСНазначениямССпискаОтменныхЗаказовКопия
				  |		ПО ТоварСНазначениямССпискаОтменныхЗаказов.Номенклатура = ТоварСНазначениямССпискаОтменныхЗаказовКопия.Номенклатура
				  |			И ТоварСНазначениямССпискаОтменныхЗаказов.Назначение = ТоварСНазначениямССпискаОтменныхЗаказовКопия.Назначение
				  |			И ТоварСНазначениямССпискаОтменныхЗаказов.Упаковка = ТоварСНазначениямССпискаОтменныхЗаказовКопия.Упаковка
				  |			И ТоварСНазначениямССпискаОтменныхЗаказов.НомерСтроки <= ТоварСНазначениямССпискаОтменныхЗаказовКопия.НомерСтроки
				  |
				  |СГРУППИРОВАТЬ ПО
				  |	ТоварСНазначениямССпискаОтменныхЗаказов.Номенклатура,
				  |	ТоварСНазначениямССпискаОтменныхЗаказов.Назначение,
				  |	ТоварСНазначениямССпискаОтменныхЗаказов.КоличествоОстаток,
				  |	ТоварСНазначениямССпискаОтменныхЗаказов.Упаковка,
				  |	ТоварСНазначениямССпискаОтменныхЗаказов.ММ_Бонус,
				  |	ТоварСНазначениямССпискаОтменныхЗаказов.НомерСтроки
				  |;
				  |
				  |////////////////////////////////////////////////////////////////////////////////
				  |ВЫБРАТЬ
				  |	ТоварСНазначениямССпискаОтменныхЗаказовНаростающие.Номенклатура,
				  |	ТоварСНазначениямССпискаОтменныхЗаказовНаростающие.Назначение,
				  |	ТоварСНазначениямССпискаОтменныхЗаказовНаростающие.Упаковка,
				  |	ТоварСНазначениямССпискаОтменныхЗаказовНаростающие.СуммаПосле КАК Точка
				  |ПОМЕСТИТЬ ТоварСНазначениямТочкаПересечения
				  |ИЗ
				  |	ТоварСНазначениямССпискаОтменныхЗаказовНаростающие КАК ТоварСНазначениямССпискаОтменныхЗаказовНаростающие
				  |
				  |ОБЪЕДИНИТЬ
				  |
				  |ВЫБРАТЬ
				  |	ТоварСНазначенияНаростающие.Номенклатура,
				  |	ТоварСНазначенияНаростающие.Назначение,
				  |	ТоварСНазначенияНаростающие.Упаковка,
				  |	ТоварСНазначенияНаростающие.СуммаПосле
				  |ИЗ
				  |	ТоварСНазначенияНаростающие КАК ТоварСНазначенияНаростающие
				  |;
				  |
				  |////////////////////////////////////////////////////////////////////////////////
				  |ВЫБРАТЬ
				  |	ТоварСНазначениямТочкаПересечения.Номенклатура,
				  |	ТоварСНазначениямТочкаПересечения.Назначение,
				  |	ТоварСНазначениямТочкаПересечения.Упаковка,
				  |	ТоварСНазначениямТочкаПересечения.Точка,
				  |	ВЫБОР
				  |		КОГДА ЕСТЬNULL(ТоварСНазначениямССпискаОтменныхЗаказовНаростающие.СуммаПосле, 0) >= ЕСТЬNULL(ТоварСНазначенияНаростающие.СуммаПосле, 0)
				  |				И ЕСТЬNULL(ТоварСНазначенияНаростающие.СуммаПосле, 0) <> 0
				  |				И ЕСТЬNULL(ТоварСНазначениямССпискаОтменныхЗаказовНаростающие.СуммаДо, 0) <= ЕСТЬNULL(ТоварСНазначенияНаростающие.СуммаДо, 0)
				  |			ТОГДА ЕСТЬNULL(ТоварСНазначенияНаростающие.СуммаПосле, 0) - ЕСТЬNULL(ТоварСНазначенияНаростающие.СуммаДо, 0)
				  |		КОГДА ЕСТЬNULL(ТоварСНазначениямССпискаОтменныхЗаказовНаростающие.СуммаПосле, 0) > ЕСТЬNULL(ТоварСНазначенияНаростающие.СуммаДо, 0)
				  |				И ЕСТЬNULL(ТоварСНазначениямССпискаОтменныхЗаказовНаростающие.СуммаПосле, 0) < ЕСТЬNULL(ТоварСНазначенияНаростающие.СуммаПосле, 0)
				  |			ТОГДА ЕСТЬNULL(ТоварСНазначениямССпискаОтменныхЗаказовНаростающие.СуммаПосле, 0) - ЕСТЬNULL(ТоварСНазначенияНаростающие.СуммаДо, 0)
				  |		КОГДА ЕСТЬNULL(ТоварСНазначениямССпискаОтменныхЗаказовНаростающие.СуммаПосле, 0) >= ЕСТЬNULL(ТоварСНазначенияНаростающие.СуммаПосле, 0)
				  |				И ЕСТЬNULL(ТоварСНазначениямССпискаОтменныхЗаказовНаростающие.СуммаДо, 0) > ЕСТЬNULL(ТоварСНазначенияНаростающие.СуммаДо, 0)
				  |				И ЕСТЬNULL(ТоварСНазначенияНаростающие.СуммаПосле, 0) <> 0
				  |			ТОГДА ЕСТЬNULL(ТоварСНазначенияНаростающие.СуммаПосле, 0) - ЕСТЬNULL(ТоварСНазначениямССпискаОтменныхЗаказовНаростающие.СуммаДо, 0) - 1
				  |		ИНАЧЕ ЕСТЬNULL(ТоварСНазначениямССпискаОтменныхЗаказовНаростающие.СуммаПосле, 0) - ЕСТЬNULL(ТоварСНазначениямССпискаОтменныхЗаказовНаростающие.СуммаДо, 0)
				  |	КОНЕЦ КАК КоличествоОстаток,
				  |	ВЫБОР
				  |		КОГДА ЕСТЬNULL(ТоварСНазначенияНаростающие.ММ_Бонус, ЗНАЧЕНИЕ(Справочник.Номенклатура.ПустаяСсылка)) = ЗНАЧЕНИЕ(Справочник.Номенклатура.ПустаяСсылка)
				  |			ТОГДА ЕСТЬNULL(ТоварСНазначениямССпискаОтменныхЗаказовНаростающие.ММ_Бонус, ЗНАЧЕНИЕ(Справочник.Номенклатура.ПустаяСсылка))
				  |		ИНАЧЕ ЕСТЬNULL(ТоварСНазначенияНаростающие.ММ_Бонус, ЗНАЧЕНИЕ(Справочник.Номенклатура.ПустаяСсылка))
				  |	КОНЕЦ КАК ММ_Бонус,
				  |	ВЫБОР
				  |		КОГДА ТоварСНазначенияНаростающие.СуммаДо >= ТоварСНазначениямССпискаОтменныхЗаказовНаростающие.СуммаДо
				  |			ТОГДА ТоварСНазначенияНаростающие.УникальныйИндентификаторСтроки
				  |		ИНАЧЕ 0
				  |	КОНЕЦ КАК КодСтроки,
				  |	ЕСТЬNULL(ТоварСНазначенияНаростающие.УникальныйИндентификаторСтроки, 0) КАК СтарыйКодСтроки,
				  |	ТоварСНазначенияНаростающие.УникальныйИндентификаторСтроки
				  |ПОМЕСТИТЬ ОбъединенияПоНаростающихСНазначениям
				  |ИЗ
				  |	ТоварСНазначениямТочкаПересечения КАК ТоварСНазначениямТочкаПересечения
				  |		ЛЕВОЕ СОЕДИНЕНИЕ ТоварСНазначениямССпискаОтменныхЗаказовНаростающие КАК ТоварСНазначениямССпискаОтменныхЗаказовНаростающие
				  |		ПО ТоварСНазначениямТочкаПересечения.Номенклатура = ТоварСНазначениямССпискаОтменныхЗаказовНаростающие.Номенклатура
				  |			И ТоварСНазначениямТочкаПересечения.Назначение = ТоварСНазначениямССпискаОтменныхЗаказовНаростающие.Назначение
				  |			И ТоварСНазначениямТочкаПересечения.Упаковка = ТоварСНазначениямССпискаОтменныхЗаказовНаростающие.Упаковка
				  |			И ТоварСНазначениямТочкаПересечения.Точка > ТоварСНазначениямССпискаОтменныхЗаказовНаростающие.СуммаДо
				  |			И ТоварСНазначениямТочкаПересечения.Точка <= ТоварСНазначениямССпискаОтменныхЗаказовНаростающие.СуммаПосле
				  |		ЛЕВОЕ СОЕДИНЕНИЕ ТоварСНазначенияНаростающие КАК ТоварСНазначенияНаростающие
				  |		ПО ТоварСНазначениямТочкаПересечения.Номенклатура = ТоварСНазначенияНаростающие.Номенклатура
				  |			И ТоварСНазначениямТочкаПересечения.Назначение = ТоварСНазначенияНаростающие.Назначение
				  |			И ТоварСНазначениямТочкаПересечения.Упаковка = ТоварСНазначенияНаростающие.Упаковка
				  |			И ТоварСНазначениямТочкаПересечения.Точка <= ТоварСНазначенияНаростающие.СуммаПосле
				  |			И ТоварСНазначениямТочкаПересечения.Точка > ТоварСНазначенияНаростающие.СуммаДо
				  |ГДЕ
				  |	ЕСТЬNULL(ТоварСНазначенияНаростающие.УникальныйИндентификаторСтроки, 0) <> 0
				  |;
				  |
				  |////////////////////////////////////////////////////////////////////////////////
				  |ВЫБРАТЬ
				  |	ОбъединенияПоНаростающихСНазначениям.Номенклатура,
				  |	ОбъединенияПоНаростающихСНазначениям.Назначение,
				  |	ОбъединенияПоНаростающихСНазначениям.Упаковка,
				  |	ОбъединенияПоНаростающихСНазначениям.Точка,
				  |	ОбъединенияПоНаростающихСНазначениям.КоличествоОстаток,
				  |	ОбъединенияПоНаростающихСНазначениям.ММ_Бонус,
				  |	ОбъединенияПоНаростающихСНазначениям.КодСтроки,
				  |	ОбъединенияПоНаростающихСНазначениям.СтарыйКодСтроки,
				  |	ОбъединенияПоНаростающихСНазначениям.УникальныйИндентификаторСтроки
				  |ПОМЕСТИТЬ РазбивкаПоБонусамСНазначения
				  |ИЗ
				  |	ОбъединенияПоНаростающихСНазначениям КАК ОбъединенияПоНаростающихСНазначениям
				  |ГДЕ
				  |	ОбъединенияПоНаростающихСНазначениям.КоличествоОстаток <> 0
				  |;
				  |
				  |////////////////////////////////////////////////////////////////////////////////
				  |ВЫБРАТЬ
				  |	РазбивкаТовараСНазначениямИБонусами.Номенклатура,
				  |	РазбивкаТовараСНазначениямИБонусами.Упаковка,
				  |	РазбивкаТовараСНазначениямИБонусами.КоличествоОстаток,
				  |	РазбивкаТовараСНазначениямИБонусами.ММ_Бонус,
				  |	РазбивкаТовараСНазначениямИБонусами.Назначение,
				  |	РазбивкаТовараСНазначениямИБонусами.КодСтроки,
				  |	РазбивкаТовараСНазначениямИБонусами.СтарыйКодСтроки,
				  |	РазбивкаТовараСНазначениямИБонусами.УникальныйИндентификаторСтроки
				  |ПОМЕСТИТЬ ПеребивкаТовара
				  |ИЗ
				  |	РазбивкаТовараСНазначениямИБонусами КАК РазбивкаТовараСНазначениямИБонусами
				  |
				  |ОБЪЕДИНИТЬ ВСЕ
				  |
				  |ВЫБРАТЬ
				  |	РазбивкаТовараСНазначениям.Номенклатура,
				  |	РазбивкаТовараСНазначениям.Упаковка,
				  |	РазбивкаТовараСНазначениям.КоличествоОстаток,
				  |	РазбивкаТовараСНазначениям.ММ_Бонус,
				  |	РазбивкаТовараСНазначениям.Назначение,
				  |	РазбивкаТовараСНазначениям.КодСтроки,
				  |	РазбивкаТовараСНазначениям.СтарыйКодСтроки,
				  |	РазбивкаТовараСНазначениям.УникальныйИндентификаторСтроки
				  |ИЗ
				  |	РазбивкаТовараСНазначениям КАК РазбивкаТовараСНазначениям
				  |
				  |ОБЪЕДИНИТЬ ВСЕ
				  |
				  |ВЫБРАТЬ
				  |	РазбивкаПоБонусамСНазначения.Номенклатура,
				  |	РазбивкаПоБонусамСНазначения.Упаковка,
				  |	РазбивкаПоБонусамСНазначения.КоличествоОстаток,
				  |	РазбивкаПоБонусамСНазначения.ММ_Бонус,
				  |	РазбивкаПоБонусамСНазначения.Назначение,
				  |	РазбивкаПоБонусамСНазначения.КодСтроки,
				  |	РазбивкаПоБонусамСНазначения.СтарыйКодСтроки,
				  |	РазбивкаПоБонусамСНазначения.УникальныйИндентификаторСтроки
				  |ИЗ
				  |	РазбивкаПоБонусамСНазначения КАК РазбивкаПоБонусамСНазначения
				  |
				  |ОБЪЕДИНИТЬ ВСЕ
				  |
				  |ВЫБРАТЬ
				  |	КешНоменклатура.Номенклатура,
				  |	КешНоменклатура.Упаковка,
				  |	ВЫБОР
				  |		КОГДА &Проведен
				  |			ТОГДА КешНоменклатура.Количество - ЕСТЬNULL(ЗаказыПоставщикамОстатки.ЗаказаноОстаток, 0)
				  |		ИНАЧЕ 0
				  |	КОНЕЦ,
				  |	КешНоменклатура.ММ_Бонус,
				  |	КешНоменклатура.Назначение,
				  |	КешНоменклатура.КодСтроки,
				  |	КешНоменклатура.КодСтроки,
				  |	КешНоменклатура.УникальныйИндентификаторСтроки
				  |ИЗ
				  |	КешНоменклатураДляРазбивки КАК КешНоменклатура
				  |		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.ЗаказыПоставщикам.Остатки(, ) КАК ЗаказыПоставщикамОстатки
				  |		ПО КешНоменклатура.ЗаказПоставщику = ЗаказыПоставщикамОстатки.ЗаказПоставщику
				  |			И КешНоменклатура.Номенклатура = ЗаказыПоставщикамОстатки.Номенклатура
				  |			И КешНоменклатура.КодСтроки = ЗаказыПоставщикамОстатки.КодСтроки
				  |ГДЕ
				  |	КешНоменклатура.Количество - ЕСТЬNULL(ЗаказыПоставщикамОстатки.ЗаказаноОстаток, 0) <> 0
				  |;
				  |
				  |////////////////////////////////////////////////////////////////////////////////
				  |ВЫБРАТЬ
				  |	ВЫБОР
				  |		КОГДА ПеребивкаТовара.КодСтроки <> 0
				  |			ТОГДА ТаблицаТоваров.НомерСтроки
				  |		ИНАЧЕ ПеребивкаТовара.КодСтроки
				  |	КОНЕЦ КАК НомерСтроки,
				  |	ТаблицаТоваров.НоменклатураПоставщика,
				  |	ТаблицаТоваров.УникальныйИндентификаторСтроки,
				  |	ТаблицаТоваров.Номенклатура,
				  |	ТаблицаТоваров.Характеристика,
				  |	ТаблицаТоваров.Упаковка,
				  |	ПеребивкаТовара.КоличествоОстаток / ЕСТЬNULL(УпаковкиНоменклатуры.Коэффициент, 1) КАК КоличествоУпаковок,
				  |	ПеребивкаТовара.КоличествоОстаток КАК Количество,
				  |	ТаблицаТоваров.ДатаПоступления,
				  |	ТаблицаТоваров.УсловиеЦеныПоставщика,
				  |	ТаблицаТоваров.Цена,
				  |	ТаблицаТоваров.Сумма,
				  |	ТаблицаТоваров.ПроцентРучнойСкидки,
				  |	ТаблицаТоваров.СуммаРучнойСкидки,
				  |	ТаблицаТоваров.СтавкаНДС,
				  |	ТаблицаТоваров.СуммаНДС,
				  |	ТаблицаТоваров.СуммаСНДС,
				  |	ПеребивкаТовара.КодСтроки,
				  |	ТаблицаТоваров.Отменено,
				  |	ТаблицаТоваров.СтатьяРасходов,
				  |	ТаблицаТоваров.АналитикаРасходов,
				  |	ТаблицаТоваров.ПричинаОтмены,
				  |	ТаблицаТоваров.Склад,
				  |	ПеребивкаТовара.Назначение,
				  |	ПеребивкаТовара.ММ_Бонус,
				  |	ВЫБОР
				  |		КОГДА ПеребивкаТовара.ММ_Бонус = ЗНАЧЕНИЕ(Справочник.Номенклатура.ПустаяСсылка)
				  |			ТОГДА ЛОЖЬ
				  |		ИНАЧЕ ИСТИНА
				  |	КОНЕЦ КАК ММ_ВыписатьБонусНаПоставщика
				  |ПОМЕСТИТЬ ПеребивкаТовараТабДок
				  |ИЗ
				  |	ПеребивкаТовара КАК ПеребивкаТовара
				  |		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ТаблицаТоваров КАК ТаблицаТоваров
				  |		ПО ПеребивкаТовара.Номенклатура = ТаблицаТоваров.Номенклатура
				  |			И ПеребивкаТовара.УникальныйИндентификаторСтроки = ТаблицаТоваров.УникальныйИндентификаторСтроки
				  |		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.УпаковкиНоменклатуры КАК УпаковкиНоменклатуры
				  |		ПО ПеребивкаТовара.Упаковка = УпаковкиНоменклатуры.Ссылка
				  |;
				  |
				  |////////////////////////////////////////////////////////////////////////////////
				  |ВЫБРАТЬ
				  |	ПеребивкаТовараТабДок.Номенклатура,
				  |	ПеребивкаТовараТабДок.Упаковка,
				  |	СУММА(ПеребивкаТовараТабДок.КоличествоУпаковок) КАК КоличествоУпаковок,
				  |	СУММА(ПеребивкаТовараТабДок.Количество) КАК Количество,
				  |	ПеребивкаТовараТабДок.УникальныйИндентификаторСтроки
				  |ПОМЕСТИТЬ СуммаПеребивкаТовараТабДок
				  |ИЗ
				  |	ПеребивкаТовараТабДок КАК ПеребивкаТовараТабДок
				  |
				  |СГРУППИРОВАТЬ ПО
				  |	ПеребивкаТовараТабДок.Номенклатура,
				  |	ПеребивкаТовараТабДок.Упаковка,
				  |	ПеребивкаТовараТабДок.УникальныйИндентификаторСтроки
				  |;
				  |
				  |////////////////////////////////////////////////////////////////////////////////
				  |ВЫБРАТЬ
				  |	ТаблицаТоваров.НомерСтроки,
				  |	ТаблицаТоваров.НоменклатураПоставщика,
				  |	ТаблицаТоваров.УникальныйИндентификаторСтроки,
				  |	ТаблицаТоваров.Номенклатура,
				  |	ТаблицаТоваров.Характеристика,
				  |	ТаблицаТоваров.Упаковка,
				  |	ТаблицаТоваров.КоличествоУпаковок - ЕСТЬNULL(СуммаПеребивкаТовараТабДок.КоличествоУпаковок, 0) КАК КоличествоУпаковок,
				  |	ТаблицаТоваров.Количество - ЕСТЬNULL(СуммаПеребивкаТовараТабДок.Количество, 0) КАК Количество,
				  |	ТаблицаТоваров.ДатаПоступления,
				  |	ТаблицаТоваров.УсловиеЦеныПоставщика,
				  |	ТаблицаТоваров.Цена,
				  |	ТаблицаТоваров.Сумма,
				  |	ТаблицаТоваров.ПроцентРучнойСкидки,
				  |	ТаблицаТоваров.СуммаРучнойСкидки,
				  |	ТаблицаТоваров.СтавкаНДС,
				  |	ТаблицаТоваров.СуммаНДС,
				  |	ТаблицаТоваров.СуммаСНДС,
				  |	ВЫБОР
				  |		КОГДА ЕСТЬNULL(СуммаПеребивкаТовараТабДок.КоличествоУпаковок, 0) <> 0
				  |			ТОГДА 0
				  |		ИНАЧЕ ТаблицаТоваров.КодСтроки
				  |	КОНЕЦ КАК КодСтроки,
				  |	ТаблицаТоваров.Отменено,
				  |	ТаблицаТоваров.СтатьяРасходов,
				  |	ТаблицаТоваров.АналитикаРасходов,
				  |	ТаблицаТоваров.ПричинаОтмены,
				  |	ТаблицаТоваров.Склад,
				  |	ТаблицаТоваров.Назначение,
				  |	ТаблицаТоваров.ММ_Бонус,
				  |	ТаблицаТоваров.ММ_ВыписатьБонусНаПоставщика
				  |ПОМЕСТИТЬ ТабДокОтсеченияПеребивки
				  |ИЗ
				  |	ТаблицаТоваров КАК ТаблицаТоваров
				  |		ЛЕВОЕ СОЕДИНЕНИЕ СуммаПеребивкаТовараТабДок КАК СуммаПеребивкаТовараТабДок
				  |		ПО ТаблицаТоваров.Номенклатура = СуммаПеребивкаТовараТабДок.Номенклатура
				  |			И ТаблицаТоваров.УникальныйИндентификаторСтроки = СуммаПеребивкаТовараТабДок.УникальныйИндентификаторСтроки
				  |ГДЕ
				  |	ТаблицаТоваров.КоличествоУпаковок - ЕСТЬNULL(СуммаПеребивкаТовараТабДок.КоличествоУпаковок, 0) > 0
				  |;
				  |
				  |////////////////////////////////////////////////////////////////////////////////
				  |ВЫБРАТЬ
				  |	ТаблицаТоваров.НомерСтроки,
				  |	ТаблицаТоваров.КодСтроки,
				  |	ТаблицаТоваров.ММ_Бонус,
				  |	ТаблицаТоваров.ММ_ВыписатьБонусНаПоставщика,
				  |	ТаблицаТоваров.Назначение,
				  |	ТаблицаТоваров.НоменклатураПоставщика,
				  |	ТаблицаТоваров.УникальныйИндентификаторСтроки,
				  |	ТаблицаТоваров.Номенклатура,
				  |	ТаблицаТоваров.Характеристика,
				  |	ТаблицаТоваров.Упаковка,
				  |	ТаблицаТоваров.КоличествоУпаковок КАК КоличествоУпаковок,
				  |	ТаблицаТоваров.Количество КАК Количество,
				  |	ТаблицаТоваров.ДатаПоступления,
				  |	ТаблицаТоваров.УсловиеЦеныПоставщика,
				  |	ТаблицаТоваров.Цена,
				  |	ТаблицаТоваров.Сумма,
				  |	ТаблицаТоваров.ПроцентРучнойСкидки,
				  |	ТаблицаТоваров.СуммаРучнойСкидки,
				  |	ТаблицаТоваров.СтавкаНДС,
				  |	ТаблицаТоваров.СуммаНДС,
				  |	ТаблицаТоваров.СуммаСНДС,
				  |	ТаблицаТоваров.Отменено,
				  |	ТаблицаТоваров.СтатьяРасходов,
				  |	ТаблицаТоваров.АналитикаРасходов,
				  |	ТаблицаТоваров.ПричинаОтмены,
				  |	ТаблицаТоваров.Склад
				  |ИЗ
				  |	ТабДокОтсеченияПеребивки КАК ТаблицаТоваров
				  |
				  |ГДЕ
				  |	ТаблицаТоваров.КоличествоУпаковок <> 0
				  |
				  |ОБЪЕДИНИТЬ ВСЕ
				  |
				  |ВЫБРАТЬ
				  |	ПеребивкаТовараТабДок.НомерСтроки,
				  |	ПеребивкаТовараТабДок.КодСтроки,
				  |	ПеребивкаТовараТабДок.ММ_Бонус,
				  |	ПеребивкаТовараТабДок.ММ_ВыписатьБонусНаПоставщика,
				  |	ПеребивкаТовараТабДок.Назначение,
				  |	ПеребивкаТовараТабДок.НоменклатураПоставщика,
				  |	ПеребивкаТовараТабДок.УникальныйИндентификаторСтроки,
				  |	ПеребивкаТовараТабДок.Номенклатура,
				  |	ПеребивкаТовараТабДок.Характеристика,
				  |	ПеребивкаТовараТабДок.Упаковка,
				  |	ПеребивкаТовараТабДок.КоличествоУпаковок,
				  |	ПеребивкаТовараТабДок.Количество,
				  |	ПеребивкаТовараТабДок.ДатаПоступления,
				  |	ПеребивкаТовараТабДок.УсловиеЦеныПоставщика,
				  |	ПеребивкаТовараТабДок.Цена,
				  |	ПеребивкаТовараТабДок.Сумма,
				  |	ПеребивкаТовараТабДок.ПроцентРучнойСкидки,
				  |	ПеребивкаТовараТабДок.СуммаРучнойСкидки,
				  |	ПеребивкаТовараТабДок.СтавкаНДС,
				  |	ПеребивкаТовараТабДок.СуммаНДС,
				  |	ПеребивкаТовараТабДок.СуммаСНДС,
				  |	ПеребивкаТовараТабДок.Отменено,
				  |	ПеребивкаТовараТабДок.СтатьяРасходов,
				  |	ПеребивкаТовараТабДок.АналитикаРасходов,
				  |	ПеребивкаТовараТабДок.ПричинаОтмены,
				  |	ПеребивкаТовараТабДок.Склад
				  |ИЗ
				  |	ПеребивкаТовараТабДок КАК ПеребивкаТовараТабДок
				  |ГДЕ
				  |	ПеребивкаТовараТабДок.КоличествоУпаковок <> 0";
	Возврат ТекстЗапроса;
КонецФункции // ПолучитьТекстЗапросаНоменклатурыПослеОтмены()

// Функция текста запроса, получаем текст зароса список номенклатуры для отмены заказа 
//
// Параметры:
//  НЕТ
//
// Возвращаемое значение:
//   Строка  - текст запроса
//
&НаСервере
Функция ПолучитьТекстЗапросаСпискаНоменклатурыДляОтмени()
	
	ТекстЗапроса = 
	"ВЫБРАТЬ
	|	СписокНоменклатурыДляОтменения.ЗаказПоставщикуДоп,
	|	СписокНоменклатурыДляОтменения.Номенклатура,
	|	СписокНоменклатурыДляОтменения.КодСтрокиДоп
	|ПОМЕСТИТЬ КешСписокДокументов
	|ИЗ
	|	&СписокНоменклатурыДляОтменения КАК СписокНоменклатурыДляОтменения
	|;
	////////////////////////////////////////////////////////////////////////////////
	//1
	|ВЫБРАТЬ
	|	КешСписокДокументов.ЗаказПоставщикуДоп КАК ЗаказПоставщика,
	|	КешСписокДокументов.Номенклатура,
	|	КешСписокДокументов.КодСтрокиДоп
	|ИЗ
	|	КешСписокДокументов КАК КешСписокДокументов
	|ИТОГИ ПО
	|	ЗаказПоставщика";
	Возврат ТекстЗапроса;
КонецФункции // ПолучитьТекстЗапросаСпискаНоменклатурыДляОтмени()

#КонецОбласти

#КонецОбласти 



