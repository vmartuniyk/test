&НаКлиенте
Процедура ВыполнитьКоманду(ИдентификаторКоманды, ОбъектыНазначения) Экспорт
	
	ФормаДокумента = ЭтаФорма.ВладелецФормы;
	обДокумент = ФормаДокумента.Объект;
	
	Если НЕ ОбщегоНазначения.ПолучитьЗначениеРеквизита(обДокумент.Ссылка, "Проведен") Тогда
		
		ПоказатьПредупреждение(, "Для создания выписка банка необходимо провести документ!");
		Возврат;
		
	КонецЕсли;
	
	сОбъекты = СоздатьВыпискиНаСервере(обДокумент);
	
	Если НЕ ПустаяСтрока(сОбъекты.ОписаниеОшибки) Тогда
		
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю(сОбъекты.ОписаниеОшибки);
		
	Иначе
		
		ОткрытьФорму("Документ.ВыпискаПоРасчетномуСчету.ФормаОбъекта", Новый Структура("Ключ", сОбъекты.ИсходящийПлатеж), ФормаДокумента, ФормаДокумента);
		ОткрытьФорму("Документ.ВыпискаПоРасчетномуСчету.ФормаОбъекта", Новый Структура("Ключ", сОбъекты.ВходящийПлатеж), ФормаДокумента, ФормаДокумента);
		
	КонецЕсли; 
	
КонецПроцедуры	

&НаСервере
Функция СоздатьВыпискиНаСервере(ДокументОбъект)
	
	Результат = Новый Структура("ОписаниеОшибки, ИсходящийПлатеж, ВходящийПлатеж", "");
	
	СсылкаТекущаяПлатежка = ДокументОбъект.Ссылка;
	
	Если НЕ (СсылкаТекущаяПлатежка.ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.ПеречислениеДенежныхСредствНаДругойСчет
		ИЛИ СсылкаТекущаяПлатежка.ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.ВозвратДенежныхСредствВДругуюОрганизацию
		ИЛИ СсылкаТекущаяПлатежка.ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.ОплатаДенежныхСредствВДругуюОрганизацию) Тогда
		
		Результат.ОписаниеОшибки = "Для хозяйственной операции " + СсылкаТекущаяПлатежка.ХозяйственнаяОперация + " обработка не предусмотрена!";
		Возврат Результат;
		
	КонецЕсли; 
	// исходящий платеж
	ИсходящийПлатеж = Документы.ВыпискаПоРасчетномуСчету.СоздатьДокумент();
	ИсходящийПлатеж.Дата = ТекущаяДата();
	ИсходящийПлатеж.БанковскийСчет = СсылкаТекущаяПлатежка.БанковскийСчет;
	
	СтруктураРеквизитов = Справочники.БанковскиеСчетаОрганизаций.ПолучитьРеквизитыБанковскогоСчетаОрганизации(ИсходящийПлатеж.БанковскийСчет);
	ИсходящийПлатеж.Организация = СтруктураРеквизитов.Организация;
	
	ИсходящийПлатеж.ИсходящиеПлатежи.Очистить();
	
	СтрокаТаблицы = ИсходящийПлатеж.ИсходящиеПлатежи.Добавить();
	СтрокаТаблицы.ПлатежныйДокумент = СсылкаТекущаяПлатежка;
	СтрокаТаблицы.Сумма = СуммаИсходящегоДокумента(СтрокаТаблицы.ПлатежныйДокумент);
	
	// входящий платеж
	ВходящийПлатеж = Документы.ВыпискаПоРасчетномуСчету.СоздатьДокумент();
	ВходящийПлатеж.Дата = ТекущаяДата();
	ВходящийПлатеж.БанковскийСчет = СсылкаТекущаяПлатежка.БанковскийСчетПолучатель;
	
	СтруктураРеквизитов = Справочники.БанковскиеСчетаОрганизаций.ПолучитьРеквизитыБанковскогоСчетаОрганизации(ВходящийПлатеж.БанковскийСчет);
	ВходящийПлатеж.Организация = СтруктураРеквизитов.Организация;
	
	ВходящийПлатеж.ВходящиеПлатежи.Очистить();
	
	СтрокаТаблицы = ВходящийПлатеж.ВходящиеПлатежи.Добавить();
	СтрокаТаблицы.ПлатежныйДокумент = СсылкаТекущаяПлатежка;
	СтрокаТаблицы.Сумма = СуммаВходящегоДокумента(СтрокаТаблицы.ПлатежныйДокумент);
	
	Попытка
		
		ИсходящийПлатеж.Записать(РежимЗаписиДокумента.Проведение);
		ВходящийПлатеж.Записать(РежимЗаписиДокумента.Проведение);
		Результат.ИсходящийПлатеж = ИсходящийПлатеж.Ссылка;
		Результат.ВходящийПлатеж = ВходящийПлатеж.Ссылка;
		
	Исключение
		
		Результат.ОписаниеОшибки = ОписаниеОшибки();
		
	КонецПопытки;
	
	Возврат Результат;
	
КонецФункции

&НаСервереБезКонтекста
Функция СуммаВходящегоДокумента(Документ)
	
	Запрос = Новый Запрос("
	|ВЫБРАТЬ
	|	ДенежныеСредства.СуммаПриход КАК СуммаДокумента
	|ИЗ
	|	РегистрНакопления.ДенежныеСредстваКПоступлениюБезналичные.Обороты КАК ДенежныеСредства
	|ГДЕ
	|	ДенежныеСредства.Документ = &Документ
	|");
	Запрос.УстановитьПараметр("Документ", Документ);
	Выборка = Запрос.Выполнить().Выбрать();
	Если Выборка.Следующий() Тогда
		СуммаДокумента = Выборка.СуммаДокумента;
	Иначе
		СуммаДокумента = 0;
	КонецЕсли;
	
	Возврат СуммаДокумента;
	
КонецФункции

&НаСервереБезКонтекста
Функция СуммаИсходящегоДокумента(Документ)
	
	Запрос = Новый Запрос("
	|ВЫБРАТЬ
	|	ДенежныеСредства.СуммаРасход КАК СуммаДокумента
	|ИЗ
	|	РегистрНакопления.ДенежныеСредстваКСписаниюБезналичные.Обороты КАК ДенежныеСредства
	|ГДЕ
	|	ДенежныеСредства.Документ = &Документ
	|");
	Запрос.УстановитьПараметр("Документ", Документ);
	Выборка = Запрос.Выполнить().Выбрать();
	Если Выборка.Следующий() Тогда
		СуммаДокумента = Выборка.СуммаДокумента;
	Иначе
		СуммаДокумента = 0;
	КонецЕсли;
	
	Возврат СуммаДокумента;
	
КонецФункции

&НаКлиенте
Процедура Команда1(Команда)
	
	обДокумент = Реквизит1;
	
	Если НЕ ОбщегоНазначения.ПолучитьЗначениеРеквизита(обДокумент, "Проведен") Тогда
		
		ПоказатьПредупреждение(, "Для создания выписка банка необходимо провести документ!");
		Возврат;
		
	КонецЕсли; 
	
	сОбъекты = СоздатьВыпискиНаСервере(Реквизит1);
	
	Если НЕ ПустаяСтрока(сОбъекты.ОписаниеОшибки) Тогда
		
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю(сОбъекты.ОписаниеОшибки);
		
	Иначе
		
		ОткрытьФорму("Документ.ВыпискаПоРасчетномуСчету.ФормаОбъекта", Новый Структура("Ключ", сОбъекты.ИсходящийПлатеж), 
		ЭтаФорма, ЭтаФорма);
		ОткрытьФорму("Документ.ВыпискаПоРасчетномуСчету.ФормаОбъекта", Новый Структура("Ключ", сОбъекты.ВходящийПлатеж), 
		ЭтаФорма, ЭтаФорма);
		
	КонецЕсли; 
	
КонецПроцедуры
