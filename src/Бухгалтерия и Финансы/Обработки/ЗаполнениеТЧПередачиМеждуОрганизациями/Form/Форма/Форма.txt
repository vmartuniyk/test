// <Описание процедуры>
//
// Параметры
//  <Параметр1>  - <Тип.Вид> - <описание параметра>
//                 <продолжение описания параметра>
//  <Параметр2>  - <Тип.Вид> - <описание параметра>
//                 <продолжение описания параметра>
//
&НаКлиенте
Процедура ВыполнитьКоманду(ИдентификаторКоманды, ОбъектыНазначенияМассив) Экспорт
	ВыполнитьЗаполнениеВходныхЦен(ОбъектыНазначенияМассив);
КонецПроцедуры // ЗаполнитьТчДокумента()

// <Описание процедуры>
//
// Параметры
//  <Параметр1>  - <Тип.Вид> - <описание параметра>
//                 <продолжение описания параметра>
//  <Параметр2>  - <Тип.Вид> - <описание параметра>
//                 <продолжение описания параметра>
//
&НаСервере
Процедура ВыполнитьЗаполнениеВходныхЦен(ОбъектыНазначенияМассив)

	ВидВходнойЦены = ПолучитьВидВходнойЦены();
	Если ВидВходнойЦены = Неопределено Тогда
		
		Сообщение = Новый СообщениеПользователю;
		Сообщение.Текст = "Необходимо задать вид входной цены. Позвонить 777.";
		Сообщение.Сообщить(); 
		
		Возврат;
		
	КонецЕсли; 
	
	Для каждого Документ Из ОбъектыНазначенияМассив Цикл
	
		Запрос = Новый Запрос("ВЫБРАТЬ
		                      |	Товары.Номенклатура,
		                      |	Товары.Характеристика,
		                      |	Товары.Упаковка,
		                      |	Товары.КоличествоУпаковок,
		                      |	Товары.Количество,
		                      |	Товары.ВидЦены,
		                      |	Товары.Цена,
		                      |	Товары.СтавкаНДС,
		                      |	Товары.СуммаНДС,
		                      |	Товары.Сумма,
		                      |	Товары.СуммаСНДС,
		                      |	Товары.НомерГТД,
		                      |	Товары.ВидЗапасов,
		                      |	Товары.СтатьяРасходов,
		                      |	Товары.АналитикаРасходов
		                      |ПОМЕСТИТЬ ТабКешТовары
		                      |ИЗ
		                      |	&Товары КАК Товары
		                      |;
		                      |
		                      |////////////////////////////////////////////////////////////////////////////////
		                      |ВЫБРАТЬ
		                      |	ЦеныНоменклатурыСрезПоследних.ВидЦены,
		                      |	ЦеныНоменклатурыСрезПоследних.Номенклатура,
		                      |	ЦеныНоменклатурыСрезПоследних.Характеристика,
		                      |	ЦеныНоменклатурыСрезПоследних.Цена
		                      |ПОМЕСТИТЬ КешЦеныНоменклатуры
		                      |ИЗ
		                      |	РегистрСведений.ЦеныНоменклатуры.СрезПоследних(
		                      |			&ДатаСреза,
		                      |			ВидЦены В (&ВидЦены)
		                      |				И (Номенклатура, Характеристика) В
		                      |					(ВЫБРАТЬ
		                      |						ТабКешТовары.Номенклатура,
		                      |						ТабКешТовары.Характеристика
		                      |					ИЗ
		                      |						ТабКешТовары КАК ТабКешТовары)) КАК ЦеныНоменклатурыСрезПоследних
		                      |;
		                      |
		                      |////////////////////////////////////////////////////////////////////////////////
		                      |ВЫБРАТЬ
		                      |	ТабКешТовары.Номенклатура,
		                      |	ТабКешТовары.Характеристика,
		                      |	ТабКешТовары.Упаковка,
		                      |	ТабКешТовары.КоличествоУпаковок,
		                      |	ТабКешТовары.Количество,
		                      |	ТабКешТовары.ВидЦены,
		                      |	ТабКешТовары.СтавкаНДС,
		                      |	ТабКешТовары.СуммаНДС,
		                      |	ТабКешТовары.Сумма,
		                      |	ТабКешТовары.СуммаСНДС,
		                      |	ТабКешТовары.НомерГТД,
		                      |	ТабКешТовары.ВидЗапасов,
		                      |	ТабКешТовары.СтатьяРасходов,
		                      |	ТабКешТовары.АналитикаРасходов,
		                      |	ЕСТЬNULL(КешЦеныНоменклатуры.Цена, 0) КАК Цена
		                      |ПОМЕСТИТЬ КешВходныеЦеныСрезПоследних
		                      |ИЗ
		                      |	ТабКешТовары КАК ТабКешТовары
		                      |		ЛЕВОЕ СОЕДИНЕНИЕ КешЦеныНоменклатуры КАК КешЦеныНоменклатуры
		                      |		ПО ТабКешТовары.Номенклатура = КешЦеныНоменклатуры.Номенклатура
		                      |			И ТабКешТовары.Характеристика = КешЦеныНоменклатуры.Характеристика
		                      |;
		                      |
		                      |////////////////////////////////////////////////////////////////////////////////
		                      |УНИЧТОЖИТЬ ТабКешТовары
		                      |;
		                      |
		                      |////////////////////////////////////////////////////////////////////////////////
		                      |УНИЧТОЖИТЬ КешЦеныНоменклатуры
		                      |;
		                      |
		                      |////////////////////////////////////////////////////////////////////////////////
		                      |ВЫБРАТЬ
		                      |	ЦеныНоменклатурыСрезПервых.Номенклатура,
		                      |	ЦеныНоменклатурыСрезПервых.Характеристика,
		                      |	ЦеныНоменклатурыСрезПервых.Цена
		                      |ПОМЕСТИТЬ КешВходныеЦеныСрезПервых
		                      |ИЗ
		                      |	РегистрСведений.ЦеныНоменклатуры.СрезПервых(
		                      |			&ДатаСреза,
		                      |			ВидЦены В (&ВидЦены)
		                      |				И (Номенклатура, Характеристика) В
		                      |					(ВЫБРАТЬ
		                      |						КешВходныеЦеныСрезПоследних.Номенклатура,
		                      |						КешВходныеЦеныСрезПоследних.Характеристика
		                      |					ИЗ
		                      |						КешВходныеЦеныСрезПоследних КАК КешВходныеЦеныСрезПоследних
		                      |					ГДЕ
		                      |						КешВходныеЦеныСрезПоследних.Цена = 0)) КАК ЦеныНоменклатурыСрезПервых
		                      |;
		                      |
		                      |////////////////////////////////////////////////////////////////////////////////
		                      |ВЫБРАТЬ
		                      |	КешВходныеЦеныСрезПоследних.Номенклатура,
		                      |	КешВходныеЦеныСрезПоследних.Характеристика,
		                      |	КешВходныеЦеныСрезПоследних.Упаковка,
		                      |	КешВходныеЦеныСрезПоследних.КоличествоУпаковок,
		                      |	КешВходныеЦеныСрезПоследних.Количество,
		                      |	КешВходныеЦеныСрезПоследних.ВидЦены,
		                      |	КешВходныеЦеныСрезПоследних.СтавкаНДС,
		                      |	КешВходныеЦеныСрезПоследних.СуммаНДС,
		                      |	КешВходныеЦеныСрезПоследних.Сумма,
		                      |	КешВходныеЦеныСрезПоследних.СуммаСНДС,
		                      |	КешВходныеЦеныСрезПоследних.НомерГТД,
		                      |	КешВходныеЦеныСрезПоследних.ВидЗапасов,
		                      |	КешВходныеЦеныСрезПоследних.СтатьяРасходов,
		                      |	КешВходныеЦеныСрезПоследних.АналитикаРасходов,
		                      |	ВЫБОР
		                      |		КОГДА ЕСТЬNULL(КешВходныеЦеныСрезПервых.Цена, 0) <> 0
		                      |			ТОГДА КешВходныеЦеныСрезПервых.Цена
		                      |		ИНАЧЕ КешВходныеЦеныСрезПоследних.Цена
		                      |	КОНЕЦ КАК Цена
		                      |ПОМЕСТИТЬ КешРезультат
		                      |ИЗ
		                      |	КешВходныеЦеныСрезПоследних КАК КешВходныеЦеныСрезПоследних
		                      |		ЛЕВОЕ СОЕДИНЕНИЕ КешВходныеЦеныСрезПервых КАК КешВходныеЦеныСрезПервых
		                      |		ПО КешВходныеЦеныСрезПоследних.Номенклатура = КешВходныеЦеныСрезПервых.Номенклатура
		                      |			И КешВходныеЦеныСрезПоследних.Характеристика = КешВходныеЦеныСрезПервых.Характеристика
		                      |;
		                      |
		                      |////////////////////////////////////////////////////////////////////////////////
		                      |УНИЧТОЖИТЬ КешВходныеЦеныСрезПоследних
		                      |;
		                      |
		                      |////////////////////////////////////////////////////////////////////////////////
		                      |УНИЧТОЖИТЬ КешВходныеЦеныСрезПервых
		                      |;
		                      |
		                      |////////////////////////////////////////////////////////////////////////////////
		                      |ВЫБРАТЬ
		                      |	КешРезультат.Номенклатура,
		                      |	КешРезультат.Характеристика,
		                      |	КешРезультат.Упаковка,
		                      |	КешРезультат.КоличествоУпаковок,
		                      |	КешРезультат.Количество,
		                      |	КешРезультат.ВидЦены,
		                      |	КешРезультат.СтавкаНДС,
		                      |	КешРезультат.СуммаНДС,
		                      |	ВЫБОР
		                      |		КОГДА КешРезультат.Упаковка = ЗНАЧЕНИЕ(Справочник.УпаковкиНоменклатуры.ПустаяСсылка)
		                      |			ТОГДА КешРезультат.Цена * КешРезультат.Количество
		                      |		ИНАЧЕ КешРезультат.Цена * КешРезультат.Количество * КешРезультат.Упаковка.Коэффициент
		                      |	КОНЕЦ КАК Сумма,
		                      |	КешРезультат.СуммаСНДС,
		                      |	КешРезультат.НомерГТД,
		                      |	КешРезультат.ВидЗапасов,
		                      |	КешРезультат.СтатьяРасходов,
		                      |	КешРезультат.АналитикаРасходов,
		                      |	КешРезультат.Цена
		                      |ПОМЕСТИТЬ КешСумма
		                      |ИЗ
		                      |	КешРезультат КАК КешРезультат
		                      |;
		                      |
		                      |////////////////////////////////////////////////////////////////////////////////
		                      |УНИЧТОЖИТЬ КешРезультат
		                      |;
		                      |
		                      |////////////////////////////////////////////////////////////////////////////////
		                      |ВЫБРАТЬ
		                      |	КешСумма.Номенклатура,
		                      |	КешСумма.Характеристика,
		                      |	КешСумма.Упаковка,
		                      |	КешСумма.КоличествоУпаковок,
		                      |	КешСумма.Количество,
		                      |	КешСумма.ВидЦены,
		                      |	КешСумма.СтавкаНДС,
		                      |	ВЫБОР
		                      |		КОГДА КешСумма.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС10)
		                      |				ИЛИ КешСумма.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС10_110)
		                      |			ТОГДА КешСумма.Сумма * 0.1
		                      |		КОГДА КешСумма.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС18)
		                      |				ИЛИ КешСумма.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС18_118)
		                      |			ТОГДА КешСумма.Сумма * 0.18
		                      |		КОГДА КешСумма.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС20)
		                      |				ИЛИ КешСумма.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС20_120)
		                      |			ТОГДА КешСумма.Сумма * 0.2
		                      |		ИНАЧЕ 0
		                      |	КОНЕЦ КАК СуммаНДС,
		                      |	КешСумма.Сумма,
		                      |	ВЫБОР
		                      |		КОГДА &ЦенаВключаетНДС = ИСТИНА
		                      |			ТОГДА КешСумма.Сумма
		                      |		ИНАЧЕ КешСумма.Сумма + ВЫБОР
		                      |				КОГДА КешСумма.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС10)
		                      |						ИЛИ КешСумма.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС10_110)
		                      |					ТОГДА КешСумма.Сумма * 0.1
		                      |				КОГДА КешСумма.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС18)
		                      |						ИЛИ КешСумма.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС18_118)
		                      |					ТОГДА КешСумма.Сумма * 0.18
		                      |				КОГДА КешСумма.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС20)
		                      |						ИЛИ КешСумма.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС20_120)
		                      |					ТОГДА КешСумма.Сумма * 0.2
		                      |				ИНАЧЕ 0
		                      |			КОНЕЦ
		                      |	КОНЕЦ КАК СуммаСНДС,
		                      |	КешСумма.НомерГТД,
		                      |	КешСумма.ВидЗапасов,
		                      |	КешСумма.СтатьяРасходов,
		                      |	КешСумма.АналитикаРасходов,
		                      |	КешСумма.Цена
		                      |ИЗ
		                      |	КешСумма КАК КешСумма");
							  
		Запрос.УстановитьПараметр("Товары", Документ.Товары.Выгрузить());
		Запрос.УстановитьПараметр("ДатаСреза", Документ.МоментВремени());
		Запрос.УстановитьПараметр("ЦенаВключаетНДС", Документ.ЦенаВключаетНДС);
		Запрос.УстановитьПараметр("ВидЦены", ВидВходнойЦены);
		
		//Сообщить(ТипЗнч(Документ)=Тип("ДокументСсылка.ПередачаТоваровМеждуОрганизациями"));
		
		ДокументОбъект = Документ.ПолучитьОбъект();
		
		ДокументОбъект.Товары.Загрузить(Запрос.Выполнить().Выгрузить());
		ДокументОбъект.Записать();
	
	КонецЦикла; 

КонецПроцедуры // ВыполнитьЗаполнениеВходныхЦен()
 
// <Описание функции>
//
// Параметры
//  <Параметр1>  - <Тип.Вид> - <описание параметра>
//                 <продолжение описания параметра>
//  <Параметр2>  - <Тип.Вид> - <описание параметра>
//                 <продолжение описания параметра>
//
// Возвращаемое значение:
//   <Тип.Вид>   - <описание возвращаемого значения>
//
&НаСервере
Функция ПолучитьВидВходнойЦены()

	Запрос = Новый Запрос("ВЫБРАТЬ
	                      |	Регламент_ОбновитьЦены.ВидЦены КАК ВидЦены
	                      |ИЗ
	                      |	РегистрСведений.Регламент_ОбновитьЦены КАК Регламент_ОбновитьЦены
	                      |ГДЕ
	                      |	Регламент_ОбновитьЦены.Входная");
						  
	Выборка = Запрос.Выполнить().Выбрать();
	
	Возврат ?(Выборка.Следующий(), Выборка.ВидЦены, Неопределено);

КонецФункции // ПолучитьВидВходнойЦены()
  