#Область ПрограммныйИнтерфейс

Процедура ВыполнитьДвиженияДокументов(ПараметрыЗаписи)    Экспорт
    УстановитьПривилегированныйРежим(Истина);
    
    Если ТипЗнч(ПараметрыЗаписи) <> Тип("Структура") Тогда
        Возврат;    	
    КонецЕсли;
    
    НачалоПериода   = ПараметрыЗаписи.НачалоПериода;
    КонецПериода    = ПараметрыЗаписи.КонецПериода;
    ДокументДляЗаписи  = ПараметрыЗаписи.ДокументСсылка;
    
    Если ДокументДляЗаписи <> Неопределено Тогда
        Если ТипЗнч(ДокументДляЗаписи)=Тип("ДокументСсылка.РеализацияТоваровУслуг") 
            ИЛИ ТипЗнч(ДокументДляЗаписи)=Тип("ДокументСсылка.РеализацияТоваровУслуг") Тогда
        	ИсточникДокумента = ДокументДляЗаписи.ПолучитьОбъект();
            ЗаписатьДокумент(ИсточникДокумента);
            Возврат;
        КонецЕсли;
    КонецЕсли;
    
    Запрос = Новый Запрос;
    Запрос.Текст = ПолучитьТекстЗапросаСпискаДокументов();
    Запрос.УстановитьПараметр("НачалоПериода",НачалоПериода);
    Запрос.УстановитьПараметр("КонецПериода",КонецПериода);
    Выборка = Запрос.Выполнить().Выбрать();
    Пока Выборка.Следующий() Цикл
        ИсточникДокумента = Выборка.Ссылка.ПолучитьОбъект();
        ЗаписатьДокумент(ИсточникДокумента);
    КонецЦикла;
    
КонецПроцедуры //ВыполнитьДвиженияДокументов(ПараметрыЗаписи)


Процедура ЗаписатьДокумент(Объект)
    
    Отказ = Ложь;
	
	МетаданныеДокумента			= Объект.Метаданные();	
    ИмяДокумента  	   	        = МетаданныеДокумента.Имя;
	ДокументСсылка 				= Объект.Ссылка;
	Движения       				= Объект.Движения;
	ДополнительныеСвойства 		= Объект.ДополнительныеСвойства;
    
    ДополнительныеСвойстваВнешние = Новый Структура();
    ДополнительныеСвойстваВнешние.Вставить("ИмяДокумента", 	ИмяДокумента);
	ДополнительныеСвойстваВнешние.Вставить("Реквизиты", 	ПолучитьСтруктуруРеквизитовПоСсылке(ДокументСсылка));
	// "ТаблицыДляДвижений" - структура, которая будет содержать таблицы значений с данными для выполнения движений.
	ДополнительныеСвойстваВнешние.Вставить("ТаблицыДляДвижений", Новый Структура);
    
    
	ИнициализироватьДанныеДокумента(ДокументСсылка, ДополнительныеСвойстваВнешние, Отказ);

    Объект.Движения.КПП_БонусыМенеджерамНачисленые.Очистить();
	Объект.Движения.КПП_БонусыМенеджерамНачисленые.Записывать = Истина;

    ОтразитьДвиженияБонусыМенеджеров(ДополнительныеСвойстваВнешние, Движения, Отказ);
    ЗаписатьНаборыЗаписей(Объект, Движения, ДополнительныеСвойстваВнешние);	
	
КонецПроцедуры //ЗаписатьДокумент(Источник)

Функция ПолучитьТекстЗапросаСпискаДокументов()
    ТекстЗапроса = "ВЫБРАТЬ
                   |    РеализацияТоваровУслуг.Ссылка
                   |ИЗ
                   |    Документ.РеализацияТоваровУслуг КАК РеализацияТоваровУслуг
                   |ГДЕ
                   |    РеализацияТоваровУслуг.ПометкаУдаления = ЛОЖЬ
                   |    И РеализацияТоваровУслуг.Проведен = ИСТИНА
                   |    И РеализацияТоваровУслуг.Дата >= &НачалоПериода
                   |    И РеализацияТоваровУслуг.Дата <= &КонецПериода
                   |
                   |ОБЪЕДИНИТЬ
                   |
                   |ВЫБРАТЬ
                   |    ВозвратТоваровОтКлиента.Ссылка
                   |ИЗ
                   |    Документ.ВозвратТоваровОтКлиента КАК ВозвратТоваровОтКлиента
                   |ГДЕ
                   |    ВозвратТоваровОтКлиента.ПометкаУдаления = ЛОЖЬ
                   |    И ВозвратТоваровОтКлиента.Проведен = ИСТИНА
                   |    И ВозвратТоваровОтКлиента.Дата >= &НачалоПериода
                   |    И ВозвратТоваровОтКлиента.Дата <= &КонецПериода";
    Возврат ТекстЗапроса;
		
КонецФункции//ПолучитьТекстЗапросаСпискаДокументов



// Процедура выполняет формирование движений по регистру накопления КПП_БонусыМенеджерамНачисленые
// Вызывается из подписки на событие документов при проведении.
// 
// Параметры:
//  Источник 		- ДокументОбъект.РеализацияТоваровУслуг/ДокументОбъект.ВозвратТоваровОтКлиента 	- Документ объект для записи или удаления записи бонусов менеджера
//  Отказ			- Булево                               		- Выявлены ошибки при проведении документа
//  РежимПроведения - РежимПроведенияДокумента					- Режим проведения документа
//
Процедура ВыполнитьДвижения(Источник, Отказ=ЛОЖЬ, РежимПроведения) Экспорт
	                                               
	Если Отказ Тогда
		Возврат;
    КонецЕсли;
    
    МетаданныеДокумента			= Источник.Метаданные();		
	ДокументСсылка 				= Источник.Ссылка;
	Объект		   				= Источник;
	Движения       				= Источник.Движения;
	ДополнительныеСвойства 		= Источник.ДополнительныеСвойства;
	
	ВыполнитьПроведениеДокумента(ДокументСсылка, Объект, Движения, ДополнительныеСвойства, Отказ);		
			   
КонецПроцедуры

#КонецОбласти 

#Область СлужебныеПроцедурыИФункции


Процедура ВыполнитьПроведениеДокумента(ДокументСсылка, Объект, Движения, ДополнительныеСвойства, Отказ)
	
	ДополнительныеСвойстваВнешние = ИнициализироватьСвойстваДляПроведения(ДокументСсылка, ДополнительныеСвойства);			
	ИнициализироватьДанныеДокумента(ДокументСсылка, ДополнительныеСвойстваВнешние, Отказ);

    ПодготовитьНаборыЗаписейКРегистрацииДвижений(Объект); 
    ОтразитьДвиженияБонусыМенеджеров(ДополнительныеСвойстваВнешние, Движения, Отказ);
    ЗаписатьНаборыЗаписей(Объект, Движения, ДополнительныеСвойстваВнешние);	
	
КонецПроцедуры

// Процедура инициализирует общие структуры, используемые при проведении документов.
//
// Параметры:
//  ДокументСсылка 		- ДокументСсылка.РеализацияТоваровУслуг/ДокументОбъект.ВозвратТоваровОтКлиента 	- Документ ссылка для записи или удаления записи бонусов менеджера
//  РежимПроведения - РежимПроведенияДокумента					- Режим проведения документа
//  ДополнительныеСвойства - 
//
Функция ИнициализироватьСвойстваДляПроведения(ДокументСсылка, ДополнительныеСвойства)
    
	МетаданныеДокумента = ДокументСсылка.Метаданные();
	ИмяДокумента  	   	= МетаданныеДокумента.Имя;
	
	ДополнительныеСвойстваВнешние = Новый Структура;
	ДополнительныеСвойстваВнешние.Вставить("РежимЗаписи", 	ДополнительныеСвойства.РежимЗаписи);
	ДополнительныеСвойстваВнешние.Вставить("ЭтоНовый", 		ДополнительныеСвойства.ЭтоНовый);
	ДополнительныеСвойстваВнешние.Вставить("ИмяДокумента", 	ИмяДокумента);
	ДополнительныеСвойстваВнешние.Вставить("Реквизиты", 	ПолучитьСтруктуруРеквизитовПоСсылке(ДокументСсылка));
	
	// "ТаблицыДляДвижений" - структура, которая будет содержать таблицы значений с данными для выполнения движений.
	ДополнительныеСвойстваВнешние.Вставить("ТаблицыДляДвижений", Новый Структура);

	// "ДляПроведения" - структура, содержащая свойства и реквизиты документа, необходимые для проведения.
	ДополнительныеСвойстваВнешние.Вставить("ДляПроведения", Новый Структура);
	
	//ДополнительныеСвойстваВнешние.ДляПроведения.Вставить("РежимПроведения",           РежимПроведения);
	ДополнительныеСвойстваВнешние.ДляПроведения.Вставить("МетаданныеДокумента",       МетаданныеДокумента);
	ДополнительныеСвойстваВнешние.ДляПроведения.Вставить("Ссылка",                    ДокументСсылка);
	
	Возврат ДополнительныеСвойстваВнешние;
	
КонецФункции

Функция ПолучитьСтруктуруРеквизитовПоСсылке(ДокументСсылка)
	
	СтруктураРеквизитов = КонструкторСтруктуруРеквизитовПоСсылке();
	ЗаполнитьЗначенияСвойств(СтруктураРеквизитов, ДокументСсылка);
	Возврат СтруктураРеквизитов;
	
КонецФункции // ПолучитьСтруктуруРеквизитовПоСсылке

Функция КонструкторСтруктуруРеквизитовПоСсылке()

	СтруктураРеквизитов = Новый Структура;
	СтруктураРеквизитов.Вставить("Дата");
	СтруктураРеквизитов.Вставить("Ссылка");
	СтруктураРеквизитов.Вставить("Организация");
	СтруктураРеквизитов.Вставить("Менеджер");
	СтруктураРеквизитов.Вставить("Валюта");
	СтруктураРеквизитов.Вставить("Склад");
	СтруктураРеквизитов.Вставить("Подразделение");

	Возврат СтруктураРеквизитов;

КонецФункции // КонструкторСтруктуруРеквизитовПоСсылке()

Процедура ИнициализироватьДанныеДокумента(ДокументСсылка, ДополнительныеСвойства, Отказ)
		
    Перем СвойствоПомощьКТС;
	Перем ПроцентОтПродажыСертификата;
	Перем ВидНоменклатурыСертификаты;
    
    МетаданныеДокумента = ДокументСсылка.Метаданные();
	ИмяДокумента  	   	= МетаданныеДокумента.Имя;
    ТаблицыДляДвижений	= ДополнительныеСвойства.ТаблицыДляДвижений;
	Реквизиты			= ДополнительныеСвойства.Реквизиты;
	
	Запрос = Новый Запрос;
    
    Запрос.УстановитьПараметр("Ссылка", 	 	    			Реквизиты.Ссылка);
	Запрос.УстановитьПараметр("ДатаДокумента",      			Реквизиты.Дата);
	Запрос.УстановитьПараметр("Валюта",      					Реквизиты.Валюта);
	Запрос.УстановитьПараметр("Склад",      					Реквизиты.Склад);
	Запрос.УстановитьПараметр("ВалютаУпрУч",        			Константы.ВалютаУправленческогоУчета.Получить());
	Запрос.УстановитьПараметр("ВалютаРеглУч",        			Константы.ВалютаРегламентированногоУчета.Получить());    	
	Запрос.УстановитьПараметр("ПустаяУпаковка",     			Справочники.УпаковкиНоменклатуры.ПустаяСсылка());
	Запрос.УстановитьПараметр("ПустаяКПП",          			Справочники.КоефициентПриоритетностиНоменклатуры.ПустаяСсылка());
	Запрос.УстановитьПараметр("ПроцентОтПродажыСертификата", 	ктс_ПредопределенныеЗначенияПовтИсп.ПроцентОтПродажыСертификата());
	Запрос.УстановитьПараметр("ВидНоменклатурыСертификаты", 	ктс_ПредопределенныеЗначенияПовтИсп.ВидНоменклатурыСертификаты());
	Запрос.УстановитьПараметр("СвойствоПомощьКТС",  			ктс_ПредопределенныеЗначенияПовтИсп.СвойствоПомощьКТС());
	Запрос.УстановитьПараметр("ВидНоменклатурыКТСПомощь", 		ктс_ПредопределенныеЗначенияПовтИсп.ВидНоменклатурыКТСПомощь());
	Запрос.УстановитьПараметр("Подразделение",      			Реквизиты.Подразделение);
	Запрос.УстановитьПараметр("СписокБазовыхВидовЦен",			ПолучитьСписокБазовыхВидовЦен()); 	
	Запрос.УстановитьПараметр("Менеджер",           			Реквизиты.Менеджер);
	Запрос.УстановитьПараметр("Организация",        			Реквизиты.Организация);
	Запрос.УстановитьПараметр("ПодразделенияКЦ",        		ктс_ПредопределенныеЗначенияПовтИсп.ПодразделениеКонтактЦентр());

	Если ИмяДокумента = "РеализацияТоваровУслуг" Тогда
		
		ДатаВведенияЗПДляКЦ = ктс_ПредопределенныеЗначенияПовтИсп.ДатаВведенияЗПДляКЦ();
		
		Если ДатаВведенияЗПДляКЦ = '00010101' ИЛИ ДатаВведенияЗПДляКЦ > Реквизиты.Дата Тогда
			Запрос.Текст = ПолучитьТекстЗапросаДляРеализацияТоваровУслуг();				
		Иначе
			Запрос.Текст = ПолучитьТекстЗапросаДляРеализацияТоваровУслугСУчетемКЦ();			
		КонецЕсли;
		
	ИначеЕсли ИмяДокумента = "ВозвратТоваровОтКлиента" Тогда
		Запрос.Текст = ПолучитьТекстЗапросаДляВозвратТоваровОтКлиента();
    Иначе	
		ТаблицыДляДвижений.Вставить("ТаблицаКПП_БонусыМенеджерамНачисленые", Новый ТаблицаЗначений);
		Возврат;
	КонецЕсли;

	ТаблицыДляДвижений.Вставить("ТаблицаКПП_БонусыМенеджерамНачисленые", Запрос.Выполнить().Выгрузить());
	
КонецПроцедуры

// Процедура выполняет подготовку наборов записей документа к записи движений.
// 1. Очищает наборы записей от "старых записей" (ситуация возможна только в толстом клиенте)
// 2. Взводит флаг записи у наборов, по которым документ имеет движения
//
Процедура ПодготовитьНаборыЗаписейКРегистрацииДвижений(Объект)
	
	Если Объект.Движения.КПП_БонусыМенеджерамНачисленые.Количество() > 0 Тогда
		Объект.Движения.КПП_БонусыМенеджерамНачисленые.Очистить();
	КонецЕсли;
	
	Если Не Объект.ДополнительныеСвойства.ЭтоНовый Тогда
		Объект.Движения.КПП_БонусыМенеджерамНачисленые.Записывать = Истина;
	КонецЕсли;	
	
КонецПроцедуры // ПодготовитьНаборыЗаписейКРегистрацииДвижений 

// Процедура формирования движений по регистру "Бонусы менеджерам начисленые по КПП".
//
// Параметры:
//	ДокументОбъект - Текущий документ
//	Отказ - Булево - Признак отказа от проведения документа
//
Процедура ОтразитьДвиженияБонусыМенеджеров(ДополнительныеСвойства, Движения, Отказ) 
	
	Таблица = ДополнительныеСвойства.ТаблицыДляДвижений.ТаблицаКПП_БонусыМенеджерамНачисленые;
	
	Если Отказ ИЛИ Таблица.Количество() = 0 Тогда
		Возврат;
	КонецЕсли;

	Движения.КПП_БонусыМенеджерамНачисленые.Записывать = Истина;
	Движения.КПП_БонусыМенеджерамНачисленые.Загрузить(Таблица);
		
КонецПроцедуры

// Процедура записывает движения документа. Дополнительно происходит копирование параметров
// в модули наборов записей для выполнения регистрации изменений в движениях.
// в данном случаэ контроль не нужен.
//
Процедура ЗаписатьНаборыЗаписей(Объект, Движения, ДополнительныеСвойства) 
	Объект.Движения.Записать();
КонецПроцедуры

Функция ПолучитьСписокБазовыхВидовЦен()

	МассивВидовЦен = Новый Массив;
	
	УстановитьПривилегированныйРежим(Истина);
	Запрос  = Новый Запрос;
	Запрос.Текст = ПолучитьТекстЗапросаБазовыхВидовЦен();
	МассивВидовЦен = Запрос.Выполнить().Выгрузить().ВыгрузитьКолонку("БазовыйВидЦены");
	Возврат МассивВидовЦен;

КонецФункции // ПолучитьСписокБазовыхВидовЦен()

#Область ТЕКСТЗАПРОСА

Функция ПолучитьТекстЗапросаДляРеализацияТоваровУслуг()
	
	ТекстЗапроса = "ВЫБРАТЬ
	               |	КурсыВалют.Валюта КАК Валюта,
	               |	ВЫРАЗИТЬ(КурсыВалют.Курс / КурсыВалют.Кратность КАК ЧИСЛО(15, 4)) КАК Курс
	               |ПОМЕСТИТЬ ТаблицаКурсов
	               |ИЗ
	               |	РегистрСведений.КурсыВалют.СрезПоследних(&ДатаДокумента, ) КАК КурсыВалют
	               |
	               |ИНДЕКСИРОВАТЬ ПО
	               |	Валюта
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |ВЫБРАТЬ
	               |	РеализацияТоваровУслугТовары.Ссылка,
	               |	РеализацияТоваровУслугТовары.Номенклатура,
	               |	РеализацияТоваровУслугТовары.Номенклатура.ВидНоменклатуры КАК ВидНоменклатуры,
	               |	РеализацияТоваровУслугТовары.КоличествоУпаковок КАК Количество,
	               |	РеализацияТоваровУслугТовары.ВидЦены,
	               |	РеализацияТоваровУслугТовары.Склад,
	               |	РеализацияТоваровУслугТовары.СуммаСНДС КАК Сумма,
	               |	РеализацияТоваровУслугТовары.Цена,
	               |	РеализацияТоваровУслугТовары.СуммаРучнойСкидки,
	               |	РеализацияТоваровУслугТовары.СуммаАвтоматическойСкидки,
	               |	РеализацияТоваровУслугТовары.Упаковка
	               |ПОМЕСТИТЬ СписокТоваров
	               |ИЗ
	               |	Документ.РеализацияТоваровУслуг.Товары КАК РеализацияТоваровУслугТовары
	               |ГДЕ
	               |	РеализацияТоваровУслугТовары.Ссылка = &Ссылка
	               |
	               |ИНДЕКСИРОВАТЬ ПО
	               |	ВидНоменклатуры
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |ВЫБРАТЬ
	               |	СписокТоваров.Номенклатура,
	               |	СписокТоваров.Количество,
	               |	СписокТоваров.ВидЦены КАК ВидЦены,
	               |	СписокТоваров.Склад,
	               |	СписокТоваров.Сумма,
	               |	СписокТоваров.Цена,
	               |	СписокТоваров.СуммаРучнойСкидки,
	               |	СписокТоваров.СуммаАвтоматическойСкидки,
	               |	СписокТоваров.Упаковка
	               |ПОМЕСТИТЬ КешДопустимаяНоменклатура
	               |ИЗ
	               |	СписокТоваров КАК СписокТоваров
	               |ГДЕ
	               |	СписокТоваров.ВидНоменклатуры <> &ВидНоменклатурыСертификаты
	               |	И СписокТоваров.ВидНоменклатуры <> &ВидНоменклатурыКТСПомощь
	               |
	               |ИНДЕКСИРОВАТЬ ПО
	               |	СписокТоваров.Номенклатура,
	               |	ВидЦены
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |ВЫБРАТЬ
	               |	КешДопустимаяНоменклатура.Номенклатура КАК Номенклатура,
	               |	ЗП_ВидыЦен.БазовыйВидЦены,
	               |	КешДопустимаяНоменклатура.Количество,
	               |	КешДопустимаяНоменклатура.ВидЦены,
	               |	КешДопустимаяНоменклатура.Склад,
	               |	КешДопустимаяНоменклатура.Сумма,
	               |	КешДопустимаяНоменклатура.Цена,
	               |	КешДопустимаяНоменклатура.СуммаРучнойСкидки,
	               |	КешДопустимаяНоменклатура.СуммаАвтоматическойСкидки,
	               |	КешДопустимаяНоменклатура.Упаковка
	               |ПОМЕСТИТЬ ДопустимаяПоВидуЦен
	               |ИЗ
	               |	КешДопустимаяНоменклатура КАК КешДопустимаяНоменклатура
	               |		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.ЗП_ВидыЦен КАК ЗП_ВидыЦен
	               |		ПО КешДопустимаяНоменклатура.ВидЦены = ЗП_ВидыЦен.ВидЦены
	               |
	               |ИНДЕКСИРОВАТЬ ПО
	               |	Номенклатура
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |ВЫБРАТЬ
	               |	КешДопустимаяНоменклатура.Номенклатура КАК Номенклатура,
	               |	ЕСТЬNULL(ЗП_ВидыЦен.БазовыйВидЦены, ЗНАЧЕНИЕ(Справочник.ВидыЦен.ПустаяСсылка)) КАК БазовыйВидЦены,
	               |	КешДопустимаяНоменклатура.Количество,
	               |	КешДопустимаяНоменклатура.ВидЦены,
	               |	КешДопустимаяНоменклатура.Склад,
	               |	КешДопустимаяНоменклатура.Сумма,
	               |	КешДопустимаяНоменклатура.Цена,
	               |	КешДопустимаяНоменклатура.СуммаРучнойСкидки,
	               |	КешДопустимаяНоменклатура.СуммаАвтоматическойСкидки,
	               |	КешДопустимаяНоменклатура.Упаковка
	               |ПОМЕСТИТЬ ТаблицаНоменклатурыВидуЦен
	               |ИЗ
	               |	КешДопустимаяНоменклатура КАК КешДопустимаяНоменклатура
	               |		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ЗП_ВидыЦен КАК ЗП_ВидыЦен
	               |		ПО КешДопустимаяНоменклатура.ВидЦены = ЗП_ВидыЦен.ВидЦены
	               |
	               |ИНДЕКСИРОВАТЬ ПО
	               |	Номенклатура
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |ВЫБРАТЬ
	               |	ЦеныНоменклатурыСрезПоследних.Номенклатура КАК Номенклатура,
	               |	ВЫБОР
	               |		КОГДА ЦеныНоменклатурыСрезПоследних.Упаковка = &ПустаяУпаковка
	               |			ТОГДА ЦеныНоменклатурыСрезПоследних.Цена
	               |		ИНАЧЕ ЦеныНоменклатурыСрезПоследних.Цена * ЦеныНоменклатурыСрезПоследних.Упаковка.Коэффициент
	               |	КОНЕЦ КАК Цена,
	               |	ЦеныНоменклатурыСрезПоследних.ВидЦены КАК БазовыйВидЦены
	               |ПОМЕСТИТЬ ТаблицаБазовыхЦен
	               |ИЗ
	               |	РегистрСведений.ЦеныНоменклатуры.СрезПоследних(
	               |			&ДатаДокумента,
	               |			Номенклатура В
	               |					(ВЫБРАТЬ РАЗЛИЧНЫЕ
	               |						ДопустимаяПоВидуЦен.Номенклатура
	               |					ИЗ
	               |						ДопустимаяПоВидуЦен)
	               |				И ВидЦены В (&СписокБазовыхВидовЦен)) КАК ЦеныНоменклатурыСрезПоследних
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |ВЫБРАТЬ
	               |	ТаблицаНоменклатурыВидуЦен.Номенклатура,
	               |	ТаблицаНоменклатурыВидуЦен.Количество,
	               |	ТаблицаНоменклатурыВидуЦен.Склад,
	               |	ТаблицаНоменклатурыВидуЦен.Сумма КАК Сумма,
	               |	ВЫБОР
	               |		КОГДА ТаблицаНоменклатурыВидуЦен.ВидЦены = ТаблицаНоменклатурыВидуЦен.БазовыйВидЦены
	               |			ТОГДА ТаблицаНоменклатурыВидуЦен.Сумма
	               |		КОГДА ТаблицаНоменклатурыВидуЦен.БазовыйВидЦены = ЗНАЧЕНИЕ(Справочник.ВидыЦен.ПустаяСсылка)
	               |			ТОГДА 0
	               |		ИНАЧЕ ВЫБОР
	               |				КОГДА ТаблицаНоменклатурыВидуЦен.Сумма = 0
	               |					ТОГДА 0
	               |				ИНАЧЕ ЕСТЬNULL(ТаблицаНоменклатурыВидуЦен.Упаковка.Коэффициент, 1) * ТаблицаНоменклатурыВидуЦен.Количество * (ЕСТЬNULL(ТаблицаБазовыхЦен.Цена, 0) + ЕСТЬNULL(ТаблицаБазовыхЦен.Цена, 0) * ТаблицаНоменклатурыВидуЦен.СуммаАвтоматическойСкидки / ТаблицаНоменклатурыВидуЦен.Сумма + ЕСТЬNULL(ТаблицаБазовыхЦен.Цена, 0) * ТаблицаНоменклатурыВидуЦен.СуммаРучнойСкидки / ТаблицаНоменклатурыВидуЦен.Сумма)
	               |			КОНЕЦ
	               |	КОНЕЦ КАК СуммаДляРасчетаЗаработка
	               |ПОМЕСТИТЬ ТоварыРеализаций
	               |ИЗ
	               |	ТаблицаНоменклатурыВидуЦен КАК ТаблицаНоменклатурыВидуЦен
	               |		ЛЕВОЕ СОЕДИНЕНИЕ ТаблицаБазовыхЦен КАК ТаблицаБазовыхЦен
	               |		ПО ТаблицаНоменклатурыВидуЦен.Номенклатура = ТаблицаБазовыхЦен.Номенклатура
	               |			И ТаблицаНоменклатурыВидуЦен.БазовыйВидЦены = ТаблицаБазовыхЦен.БазовыйВидЦены
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |ВЫБРАТЬ
	               |	КПП_Розница.Номенклатура,
	               |	КПП_Розница.Значение КАК Значение,
	               |	КПП_Розница.Номенклатура.ВидНоменклатуры КАК ВидНоменклатуры
	               |ПОМЕСТИТЬ КПППоНоменклатуре
	               |ИЗ
	               |	РегистрСведений.КПП_Розница_ЗначениеКоефициентаПриоритетностиПродаж.СрезПоследних(
	               |			&ДатаДокумента,
	               |			Номенклатура В
	               |				(ВЫБРАТЬ РАЗЛИЧНЫЕ
	               |					ДопустимаяПоВидуЦен.Номенклатура
	               |				ИЗ
	               |					ДопустимаяПоВидуЦен)) КАК КПП_Розница
	               |ГДЕ
	               |	КПП_Розница.Значение <> ЗНАЧЕНИЕ(Справочник.КоефициентПриоритетностиНоменклатуры.ПустаяСсылка)
	               |
	               |ИНДЕКСИРОВАТЬ ПО
	               |	ВидНоменклатуры,
	               |	Значение
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |ВЫБРАТЬ
	               |	КПППоНоменклатуре.Номенклатура,
	               |	ЕСТЬNULL(КПП_ПоВидуНоменклатуры.Значение, 0) КАК КПП
	               |ПОМЕСТИТЬ ЗначениеКПППоНоменклатуре
	               |ИЗ
	               |	КПППоНоменклатуре КАК КПППоНоменклатуре
	               |		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.КПП_КоэффициентыПриоритетностиПоВидуНоменклатурыРозница.СрезПоследних(
	               |				&ДатаДокумента,
	               |				ВидНоменклатуры В
	               |					(ВЫБРАТЬ
	               |						КПППоНоменклатуре.ВидНоменклатуры
	               |					ИЗ
	               |						КПППоНоменклатуре)) КАК КПП_ПоВидуНоменклатуры
	               |		ПО КПППоНоменклатуре.Значение = КПП_ПоВидуНоменклатуры.КПП
	               |			И КПППоНоменклатуре.ВидНоменклатуры = КПП_ПоВидуНоменклатуры.ВидНоменклатуры
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |ВЫБРАТЬ
	               |	ТоварыРеализаций.Номенклатура,
	               |	ТоварыРеализаций.Склад,
	               |	ТоварыРеализаций.Количество КАК Количество,
	               |	ТоварыРеализаций.Сумма КАК Сумма,
	               |	ТоварыРеализаций.СуммаДляРасчетаЗаработка * ЕСТЬNULL(ЗначениеКПППоНоменклатуре.КПП * 0.01, 0) КАК ЗаработокМенеджера
	               |ПОМЕСТИТЬ НоменклатураСЗаработкомМенеджера
	               |ИЗ
	               |	ТоварыРеализаций КАК ТоварыРеализаций
	               |		ЛЕВОЕ СОЕДИНЕНИЕ ЗначениеКПППоНоменклатуре КАК ЗначениеКПППоНоменклатуре
	               |		ПО ТоварыРеализаций.Номенклатура = ЗначениеКПППоНоменклатуре.Номенклатура
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |ВЫБРАТЬ
	               |	СписокТоваров.Номенклатура,
	               |	СписокТоваров.Склад,
	               |	СписокТоваров.Количество,
	               |	СписокТоваров.Сумма,
	               |	0 КАК ЗаработокМенеджера
	               |ПОМЕСТИТЬ КешСертификаты
	               |ИЗ
	               |	СписокТоваров КАК СписокТоваров
	               |ГДЕ
	               |	СписокТоваров.ВидНоменклатуры = &ВидНоменклатурыСертификаты
	               |
	               |ИНДЕКСИРОВАТЬ ПО
	               |	СписокТоваров.Номенклатура
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |ВЫБРАТЬ
	               |	СписокТоваров.Номенклатура,
	               |	СписокТоваров.Склад,
	               |	СписокТоваров.Количество,
	               |	СписокТоваров.Сумма,
	               |	0 КАК ЗаработокМенеджера
	               |ПОМЕСТИТЬ КешНоменклатураКТСПомощь
	               |ИЗ
	               |	СписокТоваров КАК СписокТоваров
	               |ГДЕ
	               |	СписокТоваров.ВидНоменклатуры = &ВидНоменклатурыКТСПомощь
	               |
	               |ИНДЕКСИРОВАТЬ ПО
	               |	СписокТоваров.Номенклатура
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |ВЫБРАТЬ
	               |	НоменклатураСЗаработкомМенеджера.Номенклатура,
	               |	НоменклатураСЗаработкомМенеджера.Склад,
	               |	&Организация,
	               |	&Подразделение,
	               |	&Менеджер,
	               |	НоменклатураСЗаработкомМенеджера.Количество,
	               |	НоменклатураСЗаработкомМенеджера.Сумма,
	               |	НоменклатураСЗаработкомМенеджера.ЗаработокМенеджера
	               |ПОМЕСТИТЬ ТаблицаТоваров
	               |ИЗ
	               |	НоменклатураСЗаработкомМенеджера КАК НоменклатураСЗаработкомМенеджера
	               |
	               |ОБЪЕДИНИТЬ ВСЕ
	               |
	               |ВЫБРАТЬ
	               |	КешНоменклатураКТСПомощь.Номенклатура,
	               |	КешНоменклатураКТСПомощь.Склад,
	               |	&Организация,
	               |	&Подразделение,
	               |	&Менеджер,
	               |	КешНоменклатураКТСПомощь.Количество,
	               |	КешНоменклатураКТСПомощь.Сумма,
	               |	КешНоменклатураКТСПомощь.ЗаработокМенеджера
	               |ИЗ
	               |	КешНоменклатураКТСПомощь КАК КешНоменклатураКТСПомощь
	               |
	               |ОБЪЕДИНИТЬ ВСЕ
	               |
	               |ВЫБРАТЬ
	               |	КешСертификаты.Номенклатура,
	               |	КешСертификаты.Склад,
	               |	&Организация,
	               |	&Подразделение,
	               |	&Менеджер,
	               |	КешСертификаты.Количество,
	               |	КешСертификаты.Сумма,
	               |	КешСертификаты.ЗаработокМенеджера
	               |ИЗ
	               |	КешСертификаты КАК КешСертификаты
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |ВЫБРАТЬ
	               |	&ДатаДокумента КАК Период,
	               |	ТаблицаТоваров.Номенклатура,
	               |	ВЫБОР
	               |		КОГДА ТаблицаТоваров.Номенклатура.ТипНоменклатуры = ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.Услуга)
	               |			ТОГДА &Склад
	               |		ИНАЧЕ ТаблицаТоваров.Склад
	               |	КОНЕЦ КАК Склад,
	               |	ТаблицаТоваров.Организация,
	               |	ТаблицаТоваров.Подразделение,
	               |	ТаблицаТоваров.Менеджер,
	               |	ТаблицаТоваров.Количество,
	               |	ВЫРАЗИТЬ(ТаблицаТоваров.Сумма * ТаблицаКурсовДок.Курс / ТаблицаКурсовРеглУч.Курс КАК ЧИСЛО(15, 2)) КАК СуммаРегл,
	               |	ВЫРАЗИТЬ(ТаблицаТоваров.Сумма * ТаблицаКурсовДок.Курс / ТаблицаКурсовУпр.Курс КАК ЧИСЛО(15, 2)) КАК СуммаУпрУч,
	               |	ВЫРАЗИТЬ(ТаблицаТоваров.ЗаработокМенеджера * ТаблицаКурсовДок.Курс / ТаблицаКурсовРеглУч.Курс КАК ЧИСЛО(15, 2)) КАК ЗаработокМенеджераРегл,
	               |	ВЫРАЗИТЬ(ТаблицаТоваров.ЗаработокМенеджера * ТаблицаКурсовДок.Курс / ТаблицаКурсовУпр.Курс КАК ЧИСЛО(15, 2)) КАК ЗаработокМенеджераУпрУч
	               |ПОМЕСТИТЬ КешЗапись
	               |ИЗ
	               |	ТаблицаТоваров КАК ТаблицаТоваров
	               |		ЛЕВОЕ СОЕДИНЕНИЕ ТаблицаКурсов КАК ТаблицаКурсовУпр
	               |		ПО (ТаблицаКурсовУпр.Валюта = &ВалютаУпрУч)
	               |		ЛЕВОЕ СОЕДИНЕНИЕ ТаблицаКурсов КАК ТаблицаКурсовРеглУч
	               |		ПО (ТаблицаКурсовРеглУч.Валюта = &ВалютаРеглУч)
	               |		ЛЕВОЕ СОЕДИНЕНИЕ ТаблицаКурсов КАК ТаблицаКурсовДок
	               |		ПО (ТаблицаКурсовДок.Валюта = &Валюта)
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |ВЫБРАТЬ
	               |	КешЗапись.Период,
	               |	КешЗапись.Номенклатура,
	               |	КешЗапись.Склад,
	               |	КешЗапись.Организация,
	               |	КешЗапись.Подразделение,
	               |	КешЗапись.Менеджер,
	               |	СУММА(КешЗапись.Количество) КАК Количество,
	               |	СУММА(КешЗапись.СуммаРегл) КАК СуммаРегл,
	               |	СУММА(КешЗапись.СуммаУпрУч) КАК СуммаУпр,
	               |	СУММА(КешЗапись.ЗаработокМенеджераРегл) КАК ЗаработокМенеджераРегл,
	               |	СУММА(КешЗапись.ЗаработокМенеджераУпрУч) КАК ЗаработокМенеджераУпр
	               |ИЗ
	               |	КешЗапись КАК КешЗапись
	               |
	               |СГРУППИРОВАТЬ ПО
	               |	КешЗапись.Период,
	               |	КешЗапись.Номенклатура,
	               |	КешЗапись.Склад,
	               |	КешЗапись.Организация,
	               |	КешЗапись.Подразделение,
	               |	КешЗапись.Менеджер";

	Возврат ТекстЗапроса;
	
КонецФункции

Функция ПолучитьТекстЗапросаДляРеализацияТоваровУслугСУчетемКЦ()
	
	ТекстЗапроса = "ВЫБРАТЬ
	               |	КурсыВалют.Валюта КАК Валюта,
	               |	ВЫРАЗИТЬ(КурсыВалют.Курс / КурсыВалют.Кратность КАК ЧИСЛО(15, 4)) КАК Курс
	               |ПОМЕСТИТЬ ТаблицаКурсов
	               |ИЗ
	               |	РегистрСведений.КурсыВалют.СрезПоследних(&ДатаДокумента, ) КАК КурсыВалют
	               |
	               |ИНДЕКСИРОВАТЬ ПО
	               |	Валюта
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |ВЫБРАТЬ
	               |	РеализацияТоваровУслугТовары.Ссылка,
	               |	РеализацияТоваровУслугТовары.Номенклатура,
	               |	РеализацияТоваровУслугТовары.Номенклатура.ВидНоменклатуры КАК ВидНоменклатуры,
	               |	РеализацияТоваровУслугТовары.КоличествоУпаковок КАК Количество,
	               |	РеализацияТоваровУслугТовары.ВидЦены,
	               |	РеализацияТоваровУслугТовары.Склад,
	               |	РеализацияТоваровУслугТовары.СуммаСНДС КАК Сумма,
	               |	РеализацияТоваровУслугТовары.Цена,
	               |	РеализацияТоваровУслугТовары.СуммаРучнойСкидки,
	               |	РеализацияТоваровУслугТовары.СуммаАвтоматическойСкидки,
	               |	РеализацияТоваровУслугТовары.Упаковка,
	               |	ВЫРАЗИТЬ(РеализацияТоваровУслугТовары.ЗаказКлиента КАК Документ.ЗаказКлиента) КАК ЗаказКлиента
	               |ПОМЕСТИТЬ ТабТовары
	               |ИЗ
	               |	Документ.РеализацияТоваровУслуг.Товары КАК РеализацияТоваровУслугТовары
	               |ГДЕ
	               |	РеализацияТоваровУслугТовары.Ссылка = &Ссылка
	               |
	               |ИНДЕКСИРОВАТЬ ПО
	               |	ВидНоменклатуры,
	               |	ЗаказКлиента
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |ВЫБРАТЬ
	               |	ТабТовары.Ссылка,
	               |	ТабТовары.Номенклатура КАК Номенклатура,
	               |	ТабТовары.ВидНоменклатуры,
	               |	ТабТовары.Количество,
	               |	ТабТовары.ВидЦены,
	               |	ТабТовары.Склад,
	               |	ТабТовары.Сумма,
	               |	ТабТовары.Цена,
	               |	ТабТовары.СуммаРучнойСкидки,
	               |	ТабТовары.СуммаАвтоматическойСкидки,
	               |	ТабТовары.Упаковка,
	               |	ВЫБОР
	               |		КОГДА ЕСТЬNULL(ДокЗаказКлиента.Ссылка, ЗНАЧЕНИЕ(Документ.ЗаказКлиента.ПустаяСсылка)) <> ЗНАЧЕНИЕ(Документ.ЗаказКлиента.ПустаяСсылка)
	               |				И ЕСТЬNULL(ДокЗаказКлиента.Подразделение, ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка)) = &ПодразделениеКЦ
	               |				И ЕСТЬNULL(ДокЗаказКлиента.Менеджер, ЗНАЧЕНИЕ(Справочник.Пользователи.ПустаяСсылка)) <> &Менеджер
	               |			ТОГДА 0.5
	               |		ИНАЧЕ 1
	               |	КОНЕЦ КАК КоефициентПродаж,
	               |	ЕСТЬNULL(ДокЗаказКлиента.Организация, ЗНАЧЕНИЕ(Справочник.Организации.ПустаяСсылка)) КАК ОрганизацияКЦ,
	               |	ЕСТЬNULL(ДокЗаказКлиента.Менеджер, ЗНАЧЕНИЕ(Справочник.Пользователи.ПустаяСсылка)) КАК МенеджерКЦ,
	               |	ЕСТЬNULL(ДокЗаказКлиента.Подразделение, ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка)) КАК ПодразделениеКЦ
	               |ПОМЕСТИТЬ ТабДокСЗаказамиКЦ
	               |ИЗ
	               |	ТабТовары КАК ТабТовары
	               |		ЛЕВОЕ СОЕДИНЕНИЕ Документ.ЗаказКлиента КАК ДокЗаказКлиента
	               |		ПО ТабТовары.ЗаказКлиента = ДокЗаказКлиента.Ссылка
	               |			И (ДокЗаказКлиента.ПометкаУдаления = ЛОЖЬ)
	               |
	               |ИНДЕКСИРОВАТЬ ПО
	               |	Номенклатура
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |ВЫБРАТЬ
	               |	ТабДокСЗаказамиКЦ.Ссылка,
	               |	ТабДокСЗаказамиКЦ.Номенклатура,
	               |	ТабДокСЗаказамиКЦ.ВидНоменклатуры,
	               |	ТабДокСЗаказамиКЦ.Количество,
	               |	ТабДокСЗаказамиКЦ.ВидЦены,
	               |	ТабДокСЗаказамиКЦ.Склад,
	               |	ТабДокСЗаказамиКЦ.Сумма,
	               |	ТабДокСЗаказамиКЦ.Цена,
	               |	ТабДокСЗаказамиКЦ.СуммаРучнойСкидки,
	               |	ТабДокСЗаказамиКЦ.СуммаАвтоматическойСкидки,
	               |	ТабДокСЗаказамиКЦ.Упаковка,
	               |	ТабДокСЗаказамиКЦ.КоефициентПродаж,
	               |	&Организация КАК Организация,
	               |	&Менеджер КАК Менеджер,
	               |	&Подразделение КАК Подразделение
	               |ПОМЕСТИТЬ СписокТоваров
	               |ИЗ
	               |	ТабДокСЗаказамиКЦ КАК ТабДокСЗаказамиКЦ
	               |
	               |ОБЪЕДИНИТЬ
	               |
	               |ВЫБРАТЬ
	               |	ТабДокСЗаказамиКЦ.Ссылка,
	               |	ТабДокСЗаказамиКЦ.Номенклатура,
	               |	ТабДокСЗаказамиКЦ.ВидНоменклатуры,
	               |	ТабДокСЗаказамиКЦ.Количество,
	               |	ТабДокСЗаказамиКЦ.ВидЦены,
	               |	ТабДокСЗаказамиКЦ.Склад,
	               |	ТабДокСЗаказамиКЦ.Сумма,
	               |	ТабДокСЗаказамиКЦ.Цена,
	               |	ТабДокСЗаказамиКЦ.СуммаРучнойСкидки,
	               |	ТабДокСЗаказамиКЦ.СуммаАвтоматическойСкидки,
	               |	ТабДокСЗаказамиКЦ.Упаковка,
	               |	ТабДокСЗаказамиКЦ.КоефициентПродаж,
	               |	ТабДокСЗаказамиКЦ.ОрганизацияКЦ,
	               |	ТабДокСЗаказамиКЦ.МенеджерКЦ,
	               |	ТабДокСЗаказамиКЦ.ПодразделениеКЦ
	               |ИЗ
	               |	ТабДокСЗаказамиКЦ КАК ТабДокСЗаказамиКЦ
	               |ГДЕ
	               |	ТабДокСЗаказамиКЦ.КоефициентПродаж = 0.5
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |ВЫБРАТЬ
	               |	СписокТоваров.Номенклатура,
	               |	СписокТоваров.Количество,
	               |	СписокТоваров.ВидЦены КАК ВидЦены,
	               |	СписокТоваров.Склад,
	               |	СписокТоваров.Сумма,
	               |	СписокТоваров.Цена,
	               |	СписокТоваров.СуммаРучнойСкидки,
	               |	СписокТоваров.СуммаАвтоматическойСкидки,
	               |	СписокТоваров.Упаковка,
	               |	СписокТоваров.КоефициентПродаж,
	               |	СписокТоваров.Организация,
	               |	СписокТоваров.Менеджер,
	               |	СписокТоваров.Подразделение
	               |ПОМЕСТИТЬ КешДопустимаяНоменклатура
	               |ИЗ
	               |	СписокТоваров КАК СписокТоваров
	               |ГДЕ
	               |	СписокТоваров.ВидНоменклатуры <> &ВидНоменклатурыСертификаты
	               |	И СписокТоваров.ВидНоменклатуры <> &ВидНоменклатурыКТСПомощь
	               |
	               |ИНДЕКСИРОВАТЬ ПО
	               |	СписокТоваров.Номенклатура,
	               |	ВидЦены
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |ВЫБРАТЬ
	               |	КешДопустимаяНоменклатура.Номенклатура КАК Номенклатура,
	               |	ЗП_ВидыЦен.БазовыйВидЦены,
	               |	КешДопустимаяНоменклатура.Количество,
	               |	КешДопустимаяНоменклатура.ВидЦены,
	               |	КешДопустимаяНоменклатура.Склад,
	               |	КешДопустимаяНоменклатура.Сумма,
	               |	КешДопустимаяНоменклатура.Цена,
	               |	КешДопустимаяНоменклатура.СуммаРучнойСкидки,
	               |	КешДопустимаяНоменклатура.СуммаАвтоматическойСкидки,
	               |	КешДопустимаяНоменклатура.Упаковка
	               |ПОМЕСТИТЬ ДопустимаяПоВидуЦен
	               |ИЗ
	               |	КешДопустимаяНоменклатура КАК КешДопустимаяНоменклатура
	               |		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.ЗП_ВидыЦен КАК ЗП_ВидыЦен
	               |		ПО КешДопустимаяНоменклатура.ВидЦены = ЗП_ВидыЦен.ВидЦены
	               |
	               |ИНДЕКСИРОВАТЬ ПО
	               |	Номенклатура
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |ВЫБРАТЬ
	               |	КешДопустимаяНоменклатура.Номенклатура КАК Номенклатура,
	               |	ЕСТЬNULL(ЗП_ВидыЦен.БазовыйВидЦены, ЗНАЧЕНИЕ(Справочник.ВидыЦен.ПустаяСсылка)) КАК БазовыйВидЦены,
	               |	КешДопустимаяНоменклатура.Количество,
	               |	КешДопустимаяНоменклатура.ВидЦены,
	               |	КешДопустимаяНоменклатура.Склад,
	               |	КешДопустимаяНоменклатура.Сумма,
	               |	КешДопустимаяНоменклатура.Цена,
	               |	КешДопустимаяНоменклатура.СуммаРучнойСкидки,
	               |	КешДопустимаяНоменклатура.СуммаАвтоматическойСкидки,
	               |	КешДопустимаяНоменклатура.Упаковка,
	               |	КешДопустимаяНоменклатура.КоефициентПродаж,
	               |	КешДопустимаяНоменклатура.Организация,
	               |	КешДопустимаяНоменклатура.Менеджер,
	               |	КешДопустимаяНоменклатура.Подразделение
	               |ПОМЕСТИТЬ ТаблицаНоменклатурыВидуЦен
	               |ИЗ
	               |	КешДопустимаяНоменклатура КАК КешДопустимаяНоменклатура
	               |		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ЗП_ВидыЦен КАК ЗП_ВидыЦен
	               |		ПО КешДопустимаяНоменклатура.ВидЦены = ЗП_ВидыЦен.ВидЦены
	               |
	               |ИНДЕКСИРОВАТЬ ПО
	               |	Номенклатура
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |ВЫБРАТЬ
	               |	ЦеныНоменклатурыСрезПоследних.Номенклатура КАК Номенклатура,
	               |	ВЫБОР
	               |		КОГДА ЦеныНоменклатурыСрезПоследних.Упаковка = &ПустаяУпаковка
	               |			ТОГДА ЦеныНоменклатурыСрезПоследних.Цена
	               |		ИНАЧЕ ЦеныНоменклатурыСрезПоследних.Цена * ЦеныНоменклатурыСрезПоследних.Упаковка.Коэффициент
	               |	КОНЕЦ КАК Цена,
	               |	ЦеныНоменклатурыСрезПоследних.ВидЦены КАК БазовыйВидЦены
	               |ПОМЕСТИТЬ ТаблицаБазовыхЦен
	               |ИЗ
	               |	РегистрСведений.ЦеныНоменклатуры.СрезПоследних(
	               |			&ДатаДокумента,
	               |			Номенклатура В
	               |					(ВЫБРАТЬ РАЗЛИЧНЫЕ
	               |						ДопустимаяПоВидуЦен.Номенклатура
	               |					ИЗ
	               |						ДопустимаяПоВидуЦен)
	               |				И ВидЦены В (&СписокБазовыхВидовЦен)) КАК ЦеныНоменклатурыСрезПоследних
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |ВЫБРАТЬ
	               |	ТаблицаНоменклатурыВидуЦен.Номенклатура,
	               |	ТаблицаНоменклатурыВидуЦен.Количество,
	               |	ТаблицаНоменклатурыВидуЦен.Склад,
	               |	ТаблицаНоменклатурыВидуЦен.Сумма * ТаблицаНоменклатурыВидуЦен.КоефициентПродаж КАК Сумма,
	               |	ВЫБОР
	               |		КОГДА ТаблицаНоменклатурыВидуЦен.ВидЦены = ТаблицаНоменклатурыВидуЦен.БазовыйВидЦены
	               |			ТОГДА ТаблицаНоменклатурыВидуЦен.Сумма
	               |		КОГДА ТаблицаНоменклатурыВидуЦен.БазовыйВидЦены = ЗНАЧЕНИЕ(Справочник.ВидыЦен.ПустаяСсылка)
	               |			ТОГДА 0
	               |		ИНАЧЕ ВЫБОР
	               |				КОГДА ТаблицаНоменклатурыВидуЦен.Сумма = 0
	               |					ТОГДА 0
	               |				ИНАЧЕ ЕСТЬNULL(ТаблицаНоменклатурыВидуЦен.Упаковка.Коэффициент, 1) * ТаблицаНоменклатурыВидуЦен.Количество * (ЕСТЬNULL(ТаблицаБазовыхЦен.Цена, 0) + ЕСТЬNULL(ТаблицаБазовыхЦен.Цена, 0) * ТаблицаНоменклатурыВидуЦен.СуммаАвтоматическойСкидки / ТаблицаНоменклатурыВидуЦен.Сумма + ЕСТЬNULL(ТаблицаБазовыхЦен.Цена, 0) * ТаблицаНоменклатурыВидуЦен.СуммаРучнойСкидки / ТаблицаНоменклатурыВидуЦен.Сумма)
	               |			КОНЕЦ
	               |	КОНЕЦ * ТаблицаНоменклатурыВидуЦен.КоефициентПродаж КАК СуммаДляРасчетаЗаработка,
	               |	ТаблицаНоменклатурыВидуЦен.Организация,
	               |	ТаблицаНоменклатурыВидуЦен.Менеджер,
	               |	ТаблицаНоменклатурыВидуЦен.Подразделение
	               |ПОМЕСТИТЬ ТоварыРеализаций
	               |ИЗ
	               |	ТаблицаНоменклатурыВидуЦен КАК ТаблицаНоменклатурыВидуЦен
	               |		ЛЕВОЕ СОЕДИНЕНИЕ ТаблицаБазовыхЦен КАК ТаблицаБазовыхЦен
	               |		ПО ТаблицаНоменклатурыВидуЦен.Номенклатура = ТаблицаБазовыхЦен.Номенклатура
	               |			И ТаблицаНоменклатурыВидуЦен.БазовыйВидЦены = ТаблицаБазовыхЦен.БазовыйВидЦены
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |ВЫБРАТЬ
	               |	КПП_Розница.Номенклатура,
	               |	КПП_Розница.Значение КАК Значение,
	               |	КПП_Розница.Номенклатура.ВидНоменклатуры КАК ВидНоменклатуры
	               |ПОМЕСТИТЬ КПППоНоменклатуре
	               |ИЗ
	               |	РегистрСведений.КПП_Розница_ЗначениеКоефициентаПриоритетностиПродаж.СрезПоследних(
	               |			&ДатаДокумента,
	               |			Номенклатура В
	               |				(ВЫБРАТЬ РАЗЛИЧНЫЕ
	               |					ДопустимаяПоВидуЦен.Номенклатура
	               |				ИЗ
	               |					ДопустимаяПоВидуЦен)) КАК КПП_Розница
	               |ГДЕ
	               |	КПП_Розница.Значение <> ЗНАЧЕНИЕ(Справочник.КоефициентПриоритетностиНоменклатуры.ПустаяСсылка)
	               |
	               |ИНДЕКСИРОВАТЬ ПО
	               |	ВидНоменклатуры,
	               |	Значение
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |ВЫБРАТЬ
	               |	КПППоНоменклатуре.Номенклатура,
	               |	ЕСТЬNULL(КПП_ПоВидуНоменклатуры.Значение, 0) КАК КПП
	               |ПОМЕСТИТЬ ЗначениеКПППоНоменклатуре
	               |ИЗ
	               |	КПППоНоменклатуре КАК КПППоНоменклатуре
	               |		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.КПП_КоэффициентыПриоритетностиПоВидуНоменклатурыРозница.СрезПоследних(
	               |				&ДатаДокумента,
	               |				ВидНоменклатуры В
	               |					(ВЫБРАТЬ
	               |						КПППоНоменклатуре.ВидНоменклатуры
	               |					ИЗ
	               |						КПППоНоменклатуре)) КАК КПП_ПоВидуНоменклатуры
	               |		ПО КПППоНоменклатуре.Значение = КПП_ПоВидуНоменклатуры.КПП
	               |			И КПППоНоменклатуре.ВидНоменклатуры = КПП_ПоВидуНоменклатуры.ВидНоменклатуры
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |ВЫБРАТЬ
	               |	ТоварыРеализаций.Номенклатура,
	               |	ТоварыРеализаций.Склад,
	               |	ТоварыРеализаций.Количество КАК Количество,
	               |	ТоварыРеализаций.Сумма КАК Сумма,
	               |	ТоварыРеализаций.СуммаДляРасчетаЗаработка * ЕСТЬNULL(ЗначениеКПППоНоменклатуре.КПП * 0.01, 0) КАК ЗаработокМенеджера,
	               |	ТоварыРеализаций.Организация,
	               |	ТоварыРеализаций.Менеджер,
	               |	ТоварыРеализаций.Подразделение
	               |ПОМЕСТИТЬ НоменклатураСЗаработкомМенеджера
	               |ИЗ
	               |	ТоварыРеализаций КАК ТоварыРеализаций
	               |		ЛЕВОЕ СОЕДИНЕНИЕ ЗначениеКПППоНоменклатуре КАК ЗначениеКПППоНоменклатуре
	               |		ПО ТоварыРеализаций.Номенклатура = ЗначениеКПППоНоменклатуре.Номенклатура
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |ВЫБРАТЬ
	               |	СписокТоваров.Номенклатура,
	               |	СписокТоваров.Склад,
	               |	СписокТоваров.Количество,
	               |	СписокТоваров.КоефициентПродаж * СписокТоваров.Сумма КАК Сумма,
	               |	0 КАК ЗаработокМенеджера,
	               |	СписокТоваров.Организация,
	               |	СписокТоваров.Менеджер,
	               |	СписокТоваров.Подразделение
	               |ПОМЕСТИТЬ КешСертификаты
	               |ИЗ
	               |	СписокТоваров КАК СписокТоваров
	               |ГДЕ
	               |	СписокТоваров.ВидНоменклатуры = &ВидНоменклатурыСертификаты
	               |
	               |ИНДЕКСИРОВАТЬ ПО
	               |	СписокТоваров.Номенклатура
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |ВЫБРАТЬ
	               |	СписокТоваров.Номенклатура,
	               |	СписокТоваров.Склад,
	               |	СписокТоваров.Количество,
	               |	СписокТоваров.КоефициентПродаж * СписокТоваров.Сумма КАК Сумма,
	               |	0 КАК ЗаработокМенеджера,
	               |	СписокТоваров.Организация,
	               |	СписокТоваров.Менеджер,
	               |	СписокТоваров.Подразделение
	               |ПОМЕСТИТЬ КешНоменклатураКТСПомощь
	               |ИЗ
	               |	СписокТоваров КАК СписокТоваров
	               |ГДЕ
	               |	СписокТоваров.ВидНоменклатуры = &ВидНоменклатурыКТСПомощь
	               |
	               |ИНДЕКСИРОВАТЬ ПО
	               |	СписокТоваров.Номенклатура
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |ВЫБРАТЬ
	               |	НоменклатураСЗаработкомМенеджера.Номенклатура,
	               |	НоменклатураСЗаработкомМенеджера.Склад,
	               |	НоменклатураСЗаработкомМенеджера.Организация,
	               |	НоменклатураСЗаработкомМенеджера.Подразделение,
	               |	НоменклатураСЗаработкомМенеджера.Менеджер,
	               |	НоменклатураСЗаработкомМенеджера.Количество,
	               |	НоменклатураСЗаработкомМенеджера.Сумма,
	               |	НоменклатураСЗаработкомМенеджера.ЗаработокМенеджера
	               |ПОМЕСТИТЬ ТаблицаТоваров
	               |ИЗ
	               |	НоменклатураСЗаработкомМенеджера КАК НоменклатураСЗаработкомМенеджера
	               |
	               |ОБЪЕДИНИТЬ ВСЕ
	               |
	               |ВЫБРАТЬ
	               |	КешНоменклатураКТСПомощь.Номенклатура,
	               |	КешНоменклатураКТСПомощь.Склад,
	               |	КешНоменклатураКТСПомощь.Организация,
	               |	КешНоменклатураКТСПомощь.Подразделение,
	               |	КешНоменклатураКТСПомощь.Менеджер,
	               |	КешНоменклатураКТСПомощь.Количество,
	               |	КешНоменклатураКТСПомощь.Сумма,
	               |	КешНоменклатураКТСПомощь.ЗаработокМенеджера
	               |ИЗ
	               |	КешНоменклатураКТСПомощь КАК КешНоменклатураКТСПомощь
	               |
	               |ОБЪЕДИНИТЬ ВСЕ
	               |
	               |ВЫБРАТЬ
	               |	КешСертификаты.Номенклатура,
	               |	КешСертификаты.Склад,
	               |	КешСертификаты.Организация,
	               |	КешСертификаты.Подразделение,
	               |	КешСертификаты.Менеджер,
	               |	КешСертификаты.Количество,
	               |	КешСертификаты.Сумма,
	               |	КешСертификаты.ЗаработокМенеджера
	               |ИЗ
	               |	КешСертификаты КАК КешСертификаты
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |ВЫБРАТЬ
	               |	&ДатаДокумента КАК Период,
	               |	ТаблицаТоваров.Номенклатура,
	               |	ВЫБОР
	               |		КОГДА ТаблицаТоваров.Номенклатура.ТипНоменклатуры = ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.Услуга)
	               |			ТОГДА &Склад
	               |		ИНАЧЕ ТаблицаТоваров.Склад
	               |	КОНЕЦ КАК Склад,
	               |	ТаблицаТоваров.Организация,
	               |	ТаблицаТоваров.Подразделение,
	               |	ТаблицаТоваров.Менеджер,
	               |	ТаблицаТоваров.Количество,
	               |	ВЫРАЗИТЬ(ТаблицаТоваров.Сумма * ТаблицаКурсовДок.Курс / ТаблицаКурсовРеглУч.Курс КАК ЧИСЛО(15, 2)) КАК СуммаРегл,
	               |	ВЫРАЗИТЬ(ТаблицаТоваров.Сумма * ТаблицаКурсовДок.Курс / ТаблицаКурсовУпр.Курс КАК ЧИСЛО(15, 2)) КАК СуммаУпрУч,
	               |	ВЫРАЗИТЬ(ТаблицаТоваров.ЗаработокМенеджера * ТаблицаКурсовДок.Курс / ТаблицаКурсовРеглУч.Курс КАК ЧИСЛО(15, 2)) КАК ЗаработокМенеджераРегл,
	               |	ВЫРАЗИТЬ(ТаблицаТоваров.ЗаработокМенеджера * ТаблицаКурсовДок.Курс / ТаблицаКурсовУпр.Курс КАК ЧИСЛО(15, 2)) КАК ЗаработокМенеджераУпрУч
	               |ПОМЕСТИТЬ КешЗапись
	               |ИЗ
	               |	ТаблицаТоваров КАК ТаблицаТоваров
	               |		ЛЕВОЕ СОЕДИНЕНИЕ ТаблицаКурсов КАК ТаблицаКурсовУпр
	               |		ПО (ТаблицаКурсовУпр.Валюта = &ВалютаУпрУч)
	               |		ЛЕВОЕ СОЕДИНЕНИЕ ТаблицаКурсов КАК ТаблицаКурсовРеглУч
	               |		ПО (ТаблицаКурсовРеглУч.Валюта = &ВалютаРеглУч)
	               |		ЛЕВОЕ СОЕДИНЕНИЕ ТаблицаКурсов КАК ТаблицаКурсовДок
	               |		ПО (ТаблицаКурсовДок.Валюта = &Валюта)
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |ВЫБРАТЬ
	               |	КешЗапись.Период,
	               |	КешЗапись.Номенклатура,
	               |	КешЗапись.Склад,
	               |	КешЗапись.Организация,
	               |	КешЗапись.Подразделение,
	               |	КешЗапись.Менеджер,
	               |	СУММА(КешЗапись.Количество) КАК Количество,
	               |	СУММА(КешЗапись.СуммаРегл) КАК СуммаРегл,
	               |	СУММА(КешЗапись.СуммаУпрУч) КАК СуммаУпр,
	               |	СУММА(КешЗапись.ЗаработокМенеджераРегл) КАК ЗаработокМенеджераРегл,
	               |	СУММА(КешЗапись.ЗаработокМенеджераУпрУч) КАК ЗаработокМенеджераУпр
	               |ИЗ
	               |	КешЗапись КАК КешЗапись
	               |
	               |СГРУППИРОВАТЬ ПО
	               |	КешЗапись.Период,
	               |	КешЗапись.Номенклатура,
	               |	КешЗапись.Склад,
	               |	КешЗапись.Организация,
	               |	КешЗапись.Подразделение,
	               |	КешЗапись.Менеджер";

	Возврат ТекстЗапроса;
	
КонецФункции

Функция ПолучитьТекстЗапросаДляВозвратТоваровОтКлиента()
	
	ТекстЗапроса = "ВЫБРАТЬ
					|	КурсыВалют.Валюта КАК Валюта,
					|	ВЫРАЗИТЬ(КурсыВалют.Курс / КурсыВалют.Кратность КАК ЧИСЛО(15, 4)) КАК Курс
					|ПОМЕСТИТЬ ТаблицаКурсов
					|ИЗ
					|	РегистрСведений.КурсыВалют.СрезПоследних(&ДатаДокумента, ) КАК КурсыВалют
					|   
					|ИНДЕКСИРОВАТЬ ПО
					|	Валюта
					|;  
					////////////////////////////////////////////////////////////////////////////////
					//1
					|ВЫБРАТЬ
					|	ВозвратТоваровОтКлиентаТовары.Номенклатура КАК Номенклатура,
					|	ВозвратТоваровОтКлиентаТовары.КоличествоУпаковок КАК Количество,
					|	ВозвратТоваровОтКлиентаТовары.Цена,
					|	ВозвратТоваровОтКлиентаТовары.СуммаСНДС КАК Сумма,
					|	ВЫРАЗИТЬ(ВозвратТоваровОтКлиентаТовары.ДокументРеализации КАК Документ.РеализацияТоваровУслуг) КАК ДокументРеализации,
					|	ВозвратТоваровОтКлиентаТовары.Номенклатура.ВидНоменклатуры КАК ВидНоменклатуры
					|ПОМЕСТИТЬ ТаблицаТоваров
					|ИЗ
					|	Документ.ВозвратТоваровОтКлиента.Товары КАК ВозвратТоваровОтКлиентаТовары
					|ГДЕ
					|	ВозвратТоваровОтКлиентаТовары.Ссылка = &Ссылка

					|ИНДЕКСИРОВАТЬ ПО
					|	Номенклатура,
					|	ВидНоменклатуры,
					|	ДокументРеализации
					|;
					////////////////////////////////////////////////////////////////////////////////
					//2
					|ВЫБРАТЬ РАЗЛИЧНЫЕ
					|	ТаблицаТоваров.Номенклатура КАК Номенклатура
					|ПОМЕСТИТЬ НоменклатураБезРТУ
					|ИЗ
					|	ТаблицаТоваров КАК ТаблицаТоваров
					|ГДЕ
					|	ТаблицаТоваров.ВидНоменклатуры <> &ВидНоменклатурыСертификаты
					|	И ТаблицаТоваров.ВидНоменклатуры <> &ВидНоменклатурыКТСПомощь
					|	И ТаблицаТоваров.ДокументРеализации ЕСТЬ NULL 

					|ИНДЕКСИРОВАТЬ ПО
					|	Номенклатура
					|;
					////////////////////////////////////////////////////////////////////////////////
					//3
					|ВЫБРАТЬ
					|	КПП_Розница.Номенклатура,
					|	КПП_Розница.Значение КАК Значение,
					|	КПП_Розница.Номенклатура.ВидНоменклатуры КАК ВидНоменклатуры
					|ПОМЕСТИТЬ КПППоНоменклатуре
					|ИЗ
					|	РегистрСведений.КПП_Розница_ЗначениеКоефициентаПриоритетностиПродаж.СрезПоследних(
					|			&ДатаДокумента,
					|			Номенклатура В
					|				(ВЫБРАТЬ
					|					НоменклатураБезРТУ.Номенклатура
					|				ИЗ
					|					НоменклатураБезРТУ)) КАК КПП_Розница
					|ГДЕ
					|	КПП_Розница.Значение <> ЗНАЧЕНИЕ(Справочник.КоефициентПриоритетностиНоменклатуры.ПустаяСсылка)

					|ИНДЕКСИРОВАТЬ ПО
					|	ВидНоменклатуры,
					|	Значение
					|;
					////////////////////////////////////////////////////////////////////////////////
					//4
					|ВЫБРАТЬ
					|	КПППоНоменклатуре.Номенклатура,
					|	ЕСТЬNULL(КПП_ПоВидуНоменклатуры.Значение, 0) * 0.01 КАК ПроцентКПП
					|ПОМЕСТИТЬ ЗначениеКПППоНоменклатуре
					|ИЗ
					|	КПППоНоменклатуре КАК КПППоНоменклатуре

					|ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.КПП_КоэффициентыПриоритетностиПоВидуНоменклатурыРозница.СрезПоследних(
					|				&ДатаДокумента,
					|				ВидНоменклатуры В
					|					(ВЫБРАТЬ
					|						КПППоНоменклатуре.ВидНоменклатуры
					|					ИЗ
					|						КПППоНоменклатуре)) КАК КПП_ПоВидуНоменклатуры
					|ПО КПППоНоменклатуре.Значение = КПП_ПоВидуНоменклатуры.КПП
					|И КПППоНоменклатуре.ВидНоменклатуры = КПП_ПоВидуНоменклатуры.ВидНоменклатуры
					|   
					|ИНДЕКСИРОВАТЬ ПО
					|	Номенклатура
					|;
					////////////////////////////////////////////////////////////////////////////////
					//5
					|ВЫБРАТЬ
					|	ВЫРАЗИТЬ(БонусыМенеджерам.Регистратор КАК Документ.РеализацияТоваровУслуг) КАК Регистратор,
					|	БонусыМенеджерам.Номенклатура,
					|	БонусыМенеджерам.Склад,
					|	БонусыМенеджерам.Организация,
					|	БонусыМенеджерам.Подразделение,
					|	БонусыМенеджерам.Менеджер,
					|	БонусыМенеджерам.КоличествоОборот,
					|	БонусыМенеджерам.СуммаУпрОборот,
					|	БонусыМенеджерам.СуммаРеглОборот,
					|	БонусыМенеджерам.ЗаработокМенеджераРеглОборот,
					|	БонусыМенеджерам.ЗаработокМенеджераУпрОборот
					|ПОМЕСТИТЬ КПП_БонусыМенеджерамНачисленые
					|ИЗ
					|	РегистрНакопления.КПП_БонусыМенеджерамНачисленые.Обороты(
					|			,
					|			,
					|			Регистратор,
					|			Номенклатура В
					|				(ВЫБРАТЬ
					|					ТаблицаТоваров.Номенклатура
					|				ИЗ
					|					ТаблицаТоваров КАК ТаблицаТоваров)) КАК БонусыМенеджерам
					|ГДЕ
					|	БонусыМенеджерам.Регистратор ССЫЛКА Документ.РеализацияТоваровУслуг
					|	И ВЫРАЗИТЬ(БонусыМенеджерам.Регистратор КАК Документ.РеализацияТоваровУслуг) В (ВЫБРАТЬ РАЗЛИЧНЫЕ ДокументРеализации ИЗ ТаблицаТоваров)
					|;
					///////////////////////////////////////////////////////////////////////////////
					//6
					|ВЫБРАТЬ
					|	&ДатаДокумента КАК Период,
					|	ТаблицаТоваров.Номенклатура,
					|	ВЫБОР
					|		КОГДА ТаблицаТоваров.Номенклатура.ТипНоменклатуры = ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.Услуга)
					|			ТОГДА &Склад
					|		ИНАЧЕ ЕСТЬNULL(БонусыМенеджерам.Склад, &Склад)
					|	КОНЕЦ КАК Склад,
					|	ЕСТЬNULL(БонусыМенеджерам.Организация, &Организация) КАК Организация,
					|	ЕСТЬNULL(БонусыМенеджерам.Подразделение, &Подразделение) КАК Подразделение,
					|	ЕСТЬNULL(БонусыМенеджерам.Менеджер, &Менеджер) КАК Менеджер,
					|	-ТаблицаТоваров.Количество КАК Количество,
					|	ВЫБОР
					|		КОГДА ЕСТЬNULL(БонусыМенеджерам.КоличествоОборот, 0) = 0
					|			ТОГДА -(ВЫРАЗИТЬ(ТаблицаТоваров.Сумма * ТаблицаКурсовДок.Курс / ТаблицаКурсовРеглУч.Курс КАК ЧИСЛО(15, 2)))
					|		ИНАЧЕ -БонусыМенеджерам.СуммаУпрОборот * ТаблицаТоваров.Количество / БонусыМенеджерам.КоличествоОборот
					|	КОНЕЦ КАК СуммаУпр,
					|	ВЫБОР
					|		КОГДА ЕСТЬNULL(БонусыМенеджерам.КоличествоОборот, 0) = 0
					|			ТОГДА -(ВЫРАЗИТЬ(ТаблицаТоваров.Сумма * ТаблицаКурсовДок.Курс / ТаблицаКурсовУпр.Курс КАК ЧИСЛО(15, 2)))
					|		ИНАЧЕ -БонусыМенеджерам.СуммаРеглОборот * ТаблицаТоваров.Количество / БонусыМенеджерам.КоличествоОборот
					|	КОНЕЦ КАК СуммаРегл,
					|	ВЫБОР
					|		КОГДА ЕСТЬNULL(БонусыМенеджерам.КоличествоОборот, 0) = 0
					|			ТОГДА -(ВЫРАЗИТЬ(ТаблицаТоваров.Сумма * ЕСТЬNULL(КПП.ПроцентКПП, 0) * ТаблицаКурсовДок.Курс / ТаблицаКурсовРеглУч.Курс КАК ЧИСЛО(15, 2)))
					|		ИНАЧЕ -БонусыМенеджерам.ЗаработокМенеджераРеглОборот * ТаблицаТоваров.Количество / БонусыМенеджерам.КоличествоОборот
					|	КОНЕЦ КАК ЗаработокМенеджераРегл,
					|	ВЫБОР
					|		КОГДА ЕСТЬNULL(БонусыМенеджерам.КоличествоОборот, 0) = 0
					|			ТОГДА -(ВЫРАЗИТЬ(ТаблицаТоваров.Сумма * ЕСТЬNULL(КПП.ПроцентКПП, 0) * ТаблицаКурсовДок.Курс / ТаблицаКурсовУпр.Курс КАК ЧИСЛО(15, 2)))
					|		ИНАЧЕ -БонусыМенеджерам.ЗаработокМенеджераУпрОборот * ТаблицаТоваров.Количество / БонусыМенеджерам.КоличествоОборот
					|	КОНЕЦ КАК ЗаработокМенеджераУпр
					|ИЗ
					|	ТаблицаТоваров КАК ТаблицаТоваров
					|    
					|ЛЕВОЕ СОЕДИНЕНИЕ КПП_БонусыМенеджерамНачисленые  КАК БонусыМенеджерам
					|ПО ТаблицаТоваров.Номенклатура = БонусыМенеджерам.Номенклатура
					|И ТаблицаТоваров.ДокументРеализации = БонусыМенеджерам.Регистратор
					|   
					|ЛЕВОЕ СОЕДИНЕНИЕ ЗначениеКПППоНоменклатуре КАК КПП
					|ПО ТаблицаТоваров.Номенклатура = КПП.Номенклатура
					|		
					|ЛЕВОЕ СОЕДИНЕНИЕ ТаблицаКурсов КАК ТаблицаКурсовУпр
					|ПО (ТаблицаКурсовУпр.Валюта = &ВалютаУпрУч)
					|  
					|ЛЕВОЕ СОЕДИНЕНИЕ ТаблицаКурсов КАК ТаблицаКурсовРеглУч
					|ПО (ТаблицаКурсовРеглУч.Валюта = &ВалютаРеглУч)
					|		
					|ЛЕВОЕ СОЕДИНЕНИЕ ТаблицаКурсов КАК ТаблицаКурсовДок
					|ПО (ТаблицаКурсовДок.Валюта = &Валюта)";
	Возврат ТекстЗапроса;

КонецФункции

Функция ПолучитьТекстЗапросаБазовыхВидовЦен()

	ТекстЗапроса = "ВЫБРАТЬ РАЗЛИЧНЫЕ
	               |	ЗП_ВидыЦен.БазовыйВидЦены КАК БазовыйВидЦены
	               |ИЗ
	               |	РегистрСведений.ЗП_ВидыЦен КАК ЗП_ВидыЦен
	               |ГДЕ
	               |	ЗП_ВидыЦен.БазовыйВидЦены <> ЗНАЧЕНИЕ(Справочник.ВидыЦен.ПустаяСсылка)";
	
	Возврат ТекстЗапроса;

КонецФункции // ПолучитьТекстЗапросаБазовыхВидовЦен()

#КонецОбласти

#КонецОбласти

#Область СведенияОВнешнейОбработке

Функция СведенияОВнешнейОбработке() Экспорт
	
	Версия = "1.0.6";
	
	// Объявим переменную, в которой мы сохраним и вернем "наружу" необходимые данные
    ПараметрыРегистрации = Новый Структура;

    // Объявим еще одну переменную, которая нам потребуется ниже
    МассивНазначений = Новый Массив;
    
    // Первый параметр, который мы должны указать - это какой вид обработки системе должна зарегистрировать. 
    // Допустимые типы: ДополнительнаяОбработка, ДополнительныйОтчет, ЗаполнениеОбъекта, Отчет, ПечатнаяФорма, СозданиеСвязанныхОбъектов
    ПараметрыРегистрации.Вставить("Вид", "ДополнительнаяОбработка");	
	ПараметрыРегистрации.Вставить("Назначение", Новый Массив);
    
    // Теперь зададим имя, под которым ВПФ будет зарегистрирована в справочнике внешних обработок
    ПараметрыРегистрации.Вставить("Наименование", "ДвиженияКПП_БонусыМенеджерамНачисленые");
    
    // Зададим право обработке на использование безопасного режима. Более подробно можно узнать в справке к платформе (метод УстановитьБезопасныйРежим)
    ПараметрыРегистрации.Вставить("БезопасныйРежим", Ложь);

    // Следующие два параметра играют больше информационную роль, т.е. это то, что будет видеть пользователь в информации к обработке
    ПараметрыРегистрации.Вставить("Версия", Версия);    
    ПараметрыРегистрации.Вставить("Информация", "Движения КПП бонусы менеджерам начисленые [" + Версия + "]");
    
    // Создадим таблицу команд (подробнее смотрим ниже)
    ТаблицаКоманд = ПолучитьТаблицуКоманд();
    
    // Добавим команду в таблицу
    ДобавитьКоманду(ТаблицаКоманд, "Движения КПП бонусы менеджерам начисленые[" + Версия + "]", "МЛ", "ОткрытиеФормы", Ложь, "МЛ");
	
    // Сохраним таблицу команд в параметры регистрации обработки
    ПараметрыРегистрации.Вставить("Команды", ТаблицаКоманд);
    
    // Теперь вернем системе наши параметры
    Возврат ПараметрыРегистрации;
	
КонецФункции

Функция ПолучитьТаблицуКоманд()

   // Создадим пустую таблицу команд и колонки в ней
   Команды = Новый ТаблицаЗначений;

   // Как будет выглядеть описание печатной формы для пользователя
   Команды.Колонки.Добавить("Представление", Новый ОписаниеТипов("Строка")); 

   // Имя нашего макета, что бы могли отличить вызванную команду в обработке печати
   Команды.Колонки.Добавить("Идентификатор", Новый ОписаниеТипов("Строка"));

   // Тут задается, как должна вызваться команда обработки
   // Возможные варианты:
   // - ОткрытиеФормы - в этом случае в колонке идентификатор должно быть указано имя формы, которое должна будет открыть система
   // - ВызовКлиентскогоМетода - вызвать клиентскую экспортную процедуру из модуля формы обработки
   // - ВызовСерверногоМетода - вызвать серверную экспортную процедуру из модуля объекта обработки
   Команды.Колонки.Добавить("Использование", Новый ОписаниеТипов("Строка"));

   // Следующий параметр указывает, необходимо ли показывать оповещение при начале и завершению работы обработки. Не имеет смысла при открытии формы
   Команды.Колонки.Добавить("ПоказыватьОповещение", Новый ОписаниеТипов("Булево"));

   // Для печатной формы должен содержать строку ПечатьMXL 
   Команды.Колонки.Добавить("Модификатор", Новый ОписаниеТипов("Строка"));
   
   Возврат Команды;
   
КонецФункции

Процедура ДобавитьКоманду(ТаблицаКоманд, Представление, Идентификатор, Использование, ПоказыватьОповещение = Ложь, Модификатор = "")
  // Добавляем команду в таблицу команд по переданному описанию.
  // Параметры и их значения можно посмотреть в функции ПолучитьТаблицуКоманд
  НоваяКоманда = ТаблицаКоманд.Добавить();
  НоваяКоманда.Представление = Представление;
  НоваяКоманда.Идентификатор = Идентификатор;
  НоваяКоманда.Использование = Использование;
  НоваяКоманда.ПоказыватьОповещение = ПоказыватьОповещение;
  НоваяКоманда.Модификатор = Модификатор;

КонецПроцедуры

Процедура ВыполнитьКоманду(Индентификатор) Экспорт
	Выполнить(Индентификатор);	
КонецПроцедуры

#КонецОбласти
