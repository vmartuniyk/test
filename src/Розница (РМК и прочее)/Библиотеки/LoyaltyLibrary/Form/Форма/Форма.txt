





&НаКлиенте
Процедура ЛояльностьОтправка(Object, Организация) Экспорт
	Форма 	= ПолучитьФорму("ВнешняяОбработка." + git_ПолучитьИмяВнешнегоОбъекта("LoyaltyLibrary") + ".Форма.ЛояльностьОтправка", Новый Структура("Организация, Сумма", Организация, Object.Объект.Товары.Итог("Сумма")), Object, Новый УникальныйИдентификатор());
	Форма.ОткрытьМодально();	
КонецПроцедуры

&НаКлиенте
Функция ВвестиНомерМобильного(Организация, Знач ТипДокумента = Неопределено) Экспорт
	
	Перем МобНомер;
	КодыМобильныхОператоров = Новый Соответствие;
	КодыМобильныхОператоров.Вставить("039", "Golden Telecom");
	КодыМобильныхОператоров.Вставить("050", "МТС");
	КодыМобильныхОператоров.Вставить("063", "Life");
	КодыМобильныхОператоров.Вставить("066", "Jeans");
	КодыМобильныхОператоров.Вставить("067", "Kyivstar");
	КодыМобильныхОператоров.Вставить("068", "Beeline");
	КодыМобильныхОператоров.Вставить("073", "Beeline");
	КодыМобильныхОператоров.Вставить("090", "content provider");
	КодыМобильныхОператоров.Вставить("091", "Utel");
	КодыМобильныхОператоров.Вставить("092", "PEOPLEnet");
	КодыМобильныхОператоров.Вставить("093", "Life");
	КодыМобильныхОператоров.Вставить("094", "Intertelecom");
	КодыМобильныхОператоров.Вставить("095", "Jeans");
	КодыМобильныхОператоров.Вставить("096", "Kyivstar");
	КодыМобильныхОператоров.Вставить("097", "Djuice");
	КодыМобильныхОператоров.Вставить("098", "Djuice");
    КодыМобильныхОператоров.Вставить("099", "Ekotel");
	                                           
~enter:
	Если ВвестиСтроку(МобНомер, "Лояльность, введите номер", 10) Тогда
	
		Если ПустаяСтрока(МобНомер) Тогда
			Если ТипДокумента = Неопределено Тогда
				Возврат ПолучитьПартнераПоУмолчанию(Организация);
			ИначеЕсли ТипЗнч(ТипДокумента) = Тип("ДокументСсылка.ЗаказКлиента") Тогда
				Возврат ПредопределенноеЗначение("Справочник.Партнеры.ПустаяСсылка");
			КонецЕсли;
		КонецЕсли;
		
		Если СтрДлина(СтрЗаменить(МобНомер, " ", "")) < 10 Тогда
			Предупреждение("Номер мобильного телефона должен содержать 10 цифр! Повторите попытку...");
			Перейти ~enter;
		КонецЕсли;
		
		Если КодыМобильныхОператоров[Лев(МобНомер, 3)] = Неопределено Тогда
			Предупреждение("Код мобильного оператора не известен (" + Лев(МобНомер, 3) + ")! Повторите попытку...");
			Перейти ~enter;		
		КонецЕсли;
		
		Для инд = 1 По СтрДлина(МобНомер) Цикл
            ТекСимвол = Сред(МобНомер, инд, 1);
			Если НЕ ЭтоЦифра(ТекСимвол) Тогда
				Предупреждение("Номер мобильного телефона имеет запрещенные символы! Повторите попытку...");
				Перейти ~enter;
			КонецЕсли;
		КонецЦикла;
		
	Иначе
		Возврат Неопределено;	
	КонецЕсли;
	
	
	
	Партнер = ПолучитьПартнераПоНомеру(МобНомер);
	Если НЕ Партнер = Неопределено Тогда
		Возврат Партнер;		
	КонецЕсли;
	
	
	
	ФормаДействий = ПолучитьФорму("ВнешняяОбработка." + git_ПолучитьИмяВнешнегоОбъекта("LoyaltyLibrary") + ".Форма.ФормаДействий", , ЭтаФорма, Новый УникальныйИдентификатор());	
	ФормаДействий.МобНомер 	  = МобНомер;
	ФормаДействий.Организация = Организация;
	Партнер = ФормаДействий.ОткрытьМодально();
	Если НЕ Партнер = Неопределено Тогда
		Возврат Партнер;		
	КонецЕсли;
	
	Возврат Неопределено;
	
КонецФункции

&НаКлиенте
Функция ЭтоЦифра(Символ)
 	Код = КодСимвола(Символ); 
  	Если (Код<=47) ИЛИ (Код>=58) Тогда 
    	Возврат Ложь; 
  	Иначе 
    	Возврат Истина; 
 	КонецЕсли; 
КонецФункции

&НаСервере
Функция ПолучитьПартнераПоУмолчанию(Организация)
	Запрос = Новый Запрос;
	Запрос.Текст = "
		|ВЫБРАТЬ 
		|	* 
		|ИЗ 
		|	РегистрСведений.Лояльность_Настройки 
		|ГДЕ 
		|	Организация = &Организация";
	Запрос.УстановитьПараметр("Организация", Организация);
	Выборка = Запрос.Выполнить().Выбрать();
	Возврат ?(Выборка.Следующий(), Выборка.РозничныйКлиент, Неопределено);
КонецФункции

&НаСервере
Функция ПолучитьПартнераПоНомеру(Номер)
	Запрос = Новый Запрос;
	Запрос.Текст = "
		|ВЫБРАТЬ 
		|	* 
		|ИЗ 
		|	РегистрСведений.Лояльность_НомераТелефонов
		|ГДЕ
		|	НомерТелефона = &Номер";
	Запрос.УстановитьПараметр("Номер", Номер);
	Выборка = Запрос.Выполнить().Выбрать();
	Возврат ?(Выборка.Следующий(), Выборка.Партнер, Неопределено);
КонецФункции



////////////////////////////////////////////////////////////////////////////////
// СЛУЖЕБНЫЕ ПРОЦЕДУРЫ И ФУНКЦИИ ПЕРЕОПРЕДЕЛЕНИЯ ОБРАБОТЧИКОВ

// Только для внутреннего использования
&НаСервереБезКонтекста
Функция git_ПолучитьИмяВнешнегоОбъекта(ИмяОбработки)
	Возврат git_ПереопределениеОбработчиковСервер.ПолучитьИмяВнешнегоОбъекта(ИмяОбработки);
КонецФункции

