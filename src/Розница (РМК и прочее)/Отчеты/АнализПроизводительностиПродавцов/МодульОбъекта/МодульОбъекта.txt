#Область ОбработчикиСобытий

Процедура ПриКомпоновкеРезультата(ДокументРезультат, ДанныеРасшифровки, СтандартнаяОбработка)
	
	СтандартнаяОбработка = Ложь;
	УстановитьПривилегированныйРежим(Истина);
	
	Если Не ПроверитьПараметрыКомпоновщика() Тогда
		Возврат;
	КонецЕсли;
	
	НастройкиОтчета = КомпоновщикНастроек.ПолучитьНастройки();
	
	ВнешниеНаборыДанных = Новый Структура;
	ВнешниеНаборыДанных.Вставить("НаборДанных", ПолучитьНаборДанных());
	
	КомпоновщикМакета = Новый КомпоновщикМакетаКомпоновкиДанных;
	МакетКомпоновки = КомпоновщикМакета.Выполнить(СхемаКомпоновкиДанных, НастройкиОтчета, ДанныеРасшифровки,,,ЛОЖЬ);
	
	ПроцессорКомпоновки = Новый ПроцессорКомпоновкиДанных;
	ПроцессорКомпоновки.Инициализировать(МакетКомпоновки, ВнешниеНаборыДанных, ДанныеРасшифровки);

	ПроцессорВывода = Новый ПроцессорВыводаРезультатаКомпоновкиДанныхВТабличныйДокумент;
	ПроцессорВывода.УстановитьДокумент(ДокументРезультат);
	ПроцессорВывода.Вывести(ПроцессорКомпоновки);
	
КонецПроцедуры

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

Функция ПолучитьНаборДанных()
	Если ПроверитьВариантОтчетаНаОтборПоСкладам() = ИСТИНА Тогда
		Возврат ПолучитьНаборДанныхПоОтборуПоСкладом();
	Иначе
		Возврат ПолучитьНаборДанныхОсновнойВариант();
	КонецЕсли;  
КонецФункции // ПолучитьНаборДанных()

Функция ПолучитьНаборДанныхОсновнойВариант()
	Запрос 			= Новый Запрос;
	Запрос.Текст    = ТекстЗапросаНабораДанных();
	ПериодОтчета    = ПолучитьЗначениеПараметра("ПериодОтчета");
	
	Запрос.УстановитьПараметр("НачалоПериода", 						ПериодОтчета.ДатаНачала);
	Запрос.УстановитьПараметр("КонецПериода", 						КонецДня(ПериодОтчета.ДатаОкончания));
	Запрос.УстановитьПараметр("ВидНоменклатурыКТСПомощь", 			ктс_ПредопределенныеЗначенияПовтИсп.ВидНоменклатурыКТСПомощь());
	Запрос.УстановитьПараметр("ЗначениеАксесуары", 					ктс_ПредопределенныеЗначенияПовтИсп.ЗначенияСвойствОбъектовАксесуары());
	Запрос.УстановитьПараметр("СвойствоВидНоменклатурыАксесуары", 	ктс_ПредопределенныеЗначенияПовтИсп.СвойствоКлассификацияВидовНоменклатуры());
		
	Возврат Запрос.Выполнить().Выгрузить();  

КонецФункции // ПолучитьНаборДанныхОсновнойВариант()

Функция ПолучитьНаборДанныхПоОтборуПоСкладом()
	
	Запрос 			= Новый Запрос;
	
	ТекстЗапросаПоОтбору = ТекстЗапросаНабораДанныхПоОтбору();
	Отбор = ПолучитьОтборПоСкладу();
	Если Отбор = Неопределено Тогда
		Возврат Новый ТаблицаЗначений;   	
	КонецЕсли;
	
	Если Отбор.ВидСравнения = ВидСравненияКомпоновкиДанных.Равно Тогда 	
		СкладОтбор = " Аналитика.Склад = &Склад";
		Склад = Отбор.ПравоеЗначение;		
	ИначеЕсли Отбор.ВидСравнения = ВидСравненияКомпоновкиДанных.НеРавно Тогда 
		СкладОтбор = " Аналитика.Склад <> &Склад";
		Склад = Отбор.ПравоеЗначение; 
	ИначеЕсли Отбор.ВидСравнения = ВидСравненияКомпоновкиДанных.ВСписке Тогда  	
		СкладОтбор = " Аналитика.Склад В (&Склад)";
		Склад = Отбор.ПравоеЗначение;
	ИначеЕсли Отбор.ВидСравнения = ВидСравненияКомпоновкиДанных.ВСпискеПоИерархии Тогда
		СкладОтбор = " Аналитика.Склад В ИЕРАРХИИ (&Склад)";
		Склад = Отбор.ПравоеЗначение;   
	ИначеЕсли Отбор.ВидСравнения = ВидСравненияКомпоновкиДанных.ВИерархии Тогда 		
		СкладОтбор = " Аналитика.Склад В ИЕРАРХИИ (&Склад)";
		Склад = Отбор.ПравоеЗначение;   
	ИначеЕсли Отбор.ВидСравнения = ВидСравненияКомпоновкиДанных.НеВСписке Тогда 
		СкладОтбор = " Аналитика.Склад НЕ В (&Склад)";
		Склад = Отбор.ПравоеЗначение;    
	ИначеЕсли Отбор.ВидСравнения = ВидСравненияКомпоновкиДанных.НеВСпискеПоИерархии Тогда
		СкладОтбор = " Аналитика.Склад НЕ В ИЕРАРХИИ (&Склад)";
		Склад = Отбор.ПравоеЗначение;  
	ИначеЕсли Отбор.ВидСравнения = ВидСравненияКомпоновкиДанных.НеВИерархии Тогда
		СкладОтбор = " Аналитика.Склад НЕ В ИЕРАРХИИ (&Склад)";
		Склад = Отбор.ПравоеЗначение;   
	ИначеЕсли Отбор.ВидСравнения = ВидСравненияКомпоновкиДанных.Заполнено Тогда
		СкладОтбор = " Аналитика.Склад <> &Склад";
		Склад = Справочники.Склады.ПустаяСсылка();
	Иначе 
		СкладОтбор = " Аналитика.Склад = &Склад";
		Склад = Справочники.Склады.ПустаяСсылка();
	КонецЕсли;
	Запрос.УстановитьПараметр("Склад", 						Склад); 
	ТекстЗапросаПоОтбору = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(ТекстЗапросаПоОтбору,СкладОтбор);
	
	
	ТекстЗапроса    = ТекстЗапросаНабораДанныхПоСкладом();  	
	ПериодОтчета    = ПолучитьЗначениеПараметра("ПериодОтчета"); 	
	Запрос.УстановитьПараметр("НачалоПериода", 						ПериодОтчета.ДатаНачала);
	Запрос.УстановитьПараметр("КонецПериода", 						КонецДня(ПериодОтчета.ДатаОкончания));
	Запрос.УстановитьПараметр("ВидНоменклатурыКТСПомощь", 			ктс_ПредопределенныеЗначенияПовтИсп.ВидНоменклатурыКТСПомощь());
	Запрос.УстановитьПараметр("ЗначениеАксесуары", 					ктс_ПредопределенныеЗначенияПовтИсп.ЗначенияСвойствОбъектовАксесуары());
	Запрос.УстановитьПараметр("СвойствоВидНоменклатурыАксесуары", 	ктс_ПредопределенныеЗначенияПовтИсп.СвойствоКлассификацияВидовНоменклатуры());
	
	ТекстЗапроса = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(ТекстЗапроса,ТекстЗапросаПоОтбору);   
	Запрос.Текст = ТекстЗапроса;
	Отбор = ПолучитьОтборПоСкладу();                                                                             	
		
	Возврат Запрос.Выполнить().Выгрузить();  

КонецФункции // ПолучитьНаборДанныхОсновнойВариант()

Функция ТекстЗапросаНабораДанных()
	
	ТекстЗапроса = "ВЫБРАТЬ
	               |	Продажи.Регистратор,
	               |	Аналитика.Номенклатура,
	               |	ВЫБОР
	               |		КОГДА Аналитика.Склад = ЗНАЧЕНИЕ(Справочник.Склады.ПустаяСсылка)
	               |			ТОГДА ВЫБОР
	               |					КОГДА Продажи.Регистратор ССЫЛКА Документ.РеализацияТоваровУслуг
	               |						ТОГДА ВЫРАЗИТЬ(Продажи.Регистратор КАК Документ.РеализацияТоваровУслуг).Склад
	               |					КОГДА Продажи.Регистратор ССЫЛКА Документ.ВозвратТоваровОтКлиента
	               |						ТОГДА ВЫРАЗИТЬ(Продажи.Регистратор КАК Документ.ВозвратТоваровОтКлиента).Склад
	               |				КОНЕЦ
	               |		ИНАЧЕ Аналитика.Склад
	               |	КОНЕЦ КАК Склад,
	               |	ВЫБОР
	               |		КОГДА Продажи.Менеджер = ЗНАЧЕНИЕ(Справочник.Пользователи.ПустаяСсылка)
	               |			ТОГДА ВЫБОР
	               |					КОГДА Продажи.Регистратор ССЫЛКА Документ.РеализацияТоваровУслуг
	               |						ТОГДА ВЫРАЗИТЬ(Продажи.Регистратор КАК Документ.РеализацияТоваровУслуг).Менеджер
	               |					КОГДА Продажи.Регистратор ССЫЛКА Документ.ВозвратТоваровОтКлиента
	               |						ТОГДА ВЫРАЗИТЬ(Продажи.Регистратор КАК Документ.ВозвратТоваровОтКлиента).Менеджер
	               |				КОНЕЦ
	               |		ИНАЧЕ Продажи.Менеджер
	               |	КОНЕЦ КАК Менеджер,
	               |	Продажи.КоличествоОборот,
	               |	Продажи.СуммаВыручкиОборот,
	               |	Продажи.СуммаВыручкиРеглОборот,
	               |	Аналитика.Номенклатура.ВидНоменклатуры КАК ВидНоменклатуры
	               |ПОМЕСТИТЬ Выручка
	               |ИЗ
	               |	РегистрНакопления.ВыручкаИСебестоимостьПродаж.Обороты(&НачалоПериода, &КонецПериода, Авто, ) КАК Продажи
	               |		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.АналитикаУчетаНоменклатуры КАК Аналитика
	               |		ПО Продажи.АналитикаУчетаНоменклатуры = Аналитика.КлючАналитики
	               |ГДЕ
	               |	Продажи.Регистратор ССЫЛКА Документ.РеализацияТоваровУслуг
	               |
	               |ОБЪЕДИНИТЬ
	               |
	               |ВЫБРАТЬ
	               |	Продажи.Регистратор,
	               |	Аналитика.Номенклатура,
	               |	Аналитика.Склад,
	               |	ВЫБОР
	               |		КОГДА Продажи.Менеджер = ЗНАЧЕНИЕ(Справочник.Пользователи.ПустаяСсылка)
	               |			ТОГДА ВЫБОР
	               |					КОГДА Продажи.Регистратор ССЫЛКА Документ.РеализацияТоваровУслуг
	               |						ТОГДА ВЫРАЗИТЬ(Продажи.Регистратор КАК Документ.РеализацияТоваровУслуг).Менеджер
	               |					КОГДА Продажи.Регистратор ССЫЛКА Документ.ВозвратТоваровОтКлиента
	               |						ТОГДА ВЫРАЗИТЬ(Продажи.Регистратор КАК Документ.ВозвратТоваровОтКлиента).Менеджер
	               |				КОНЕЦ
	               |		ИНАЧЕ Продажи.Менеджер
	               |	КОНЕЦ,
	               |	Продажи.КоличествоОборот,
	               |	Продажи.СуммаВыручкиОборот,
	               |	Продажи.СуммаВыручкиРеглОборот,
	               |	Аналитика.Номенклатура.ВидНоменклатуры
	               |ИЗ
	               |	РегистрНакопления.ВыручкаИСебестоимостьПродаж.Обороты(&НачалоПериода, &КонецПериода, Авто, ) КАК Продажи
	               |		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.АналитикаУчетаНоменклатуры КАК Аналитика
	               |		ПО Продажи.АналитикаУчетаНоменклатуры = Аналитика.КлючАналитики
	               |ГДЕ
	               |	Продажи.Регистратор ССЫЛКА Документ.ВозвратТоваровОтКлиента
	               |
	               |ИНДЕКСИРОВАТЬ ПО
	               |	Склад,
	               |	Менеджер,
	               |	ВидНоменклатуры
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |ВЫБРАТЬ РАЗЛИЧНЫЕ
	               |	Выручка.Склад КАК Склад,
	               |	Выручка.Менеджер КАК Менеджер
	               |ПОМЕСТИТЬ АналитикаСкладМенеджер
	               |ИЗ
	               |	Выручка КАК Выручка
	               |
	               |ИНДЕКСИРОВАТЬ ПО
	               |	Склад,
	               |	Менеджер
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |ВЫБРАТЬ
	               |	Выручка.Склад КАК Склад,
	               |	Выручка.Менеджер КАК Менеджер,
	               |	СУММА(Выручка.СуммаВыручкиОборот) КАК СуммаВыручкиОборот,
	               |	1 КАК Позиция
	               |ПОМЕСТИТЬ ВыручкаТО
	               |ИЗ
	               |	Выручка КАК Выручка
	               |
	               |СГРУППИРОВАТЬ ПО
	               |	Выручка.Склад,
	               |	Выручка.Менеджер
	               |
	               |ИНДЕКСИРОВАТЬ ПО
	               |	Склад,
	               |	Менеджер
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |ВЫБРАТЬ
	               |	ВыручкаТО.Склад КАК Склад,
	               |	ВыручкаТО.Менеджер КАК Менеджер,
	               |	ВыручкаТО.СуммаВыручкиОборот КАК СуммаВыручкиОборот,
	               |	СУММА(ВыручкаТОКопия.Позиция) + 1 КАК Позиция
	               |ПОМЕСТИТЬ ВыручкаТОПоПозициям
	               |ИЗ
	               |	ВыручкаТО КАК ВыручкаТО
	               |		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВыручкаТО КАК ВыручкаТОКопия
	               |		ПО ВыручкаТО.СуммаВыручкиОборот > ВыручкаТОКопия.СуммаВыручкиОборот
	               |
	               |СГРУППИРОВАТЬ ПО
	               |	ВыручкаТО.Склад,
	               |	ВыручкаТО.Менеджер,
	               |	ВыручкаТО.СуммаВыручкиОборот
	               |
	               |ИНДЕКСИРОВАТЬ ПО
	               |	Склад,
	               |	Менеджер
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |ВЫБРАТЬ
	               |	ВыручкаТО.Позиция КАК Позиция,
	               |	ВыручкаТО.Склад КАК Склад,
	               |	ВыручкаТО.Менеджер КАК Менеджер,
	               |	ВыручкаТО.СуммаВыручкиОборот
	               |ПОМЕСТИТЬ РандПоВыручкаТО
	               |ИЗ
	               |	ВыручкаТО КАК ВыручкаТО
	               |ГДЕ
	               |	НЕ (ВыручкаТО.Склад, ВыручкаТО.Менеджер) В
	               |				(ВЫБРАТЬ
	               |					ВыручкаТОПоПозициям.Склад,
	               |					ВыручкаТОПоПозициям.Менеджер
	               |				ИЗ
	               |					ВыручкаТОПоПозициям КАК ВыручкаТОПоПозициям)
	               |
	               |ОБЪЕДИНИТЬ ВСЕ
	               |
	               |ВЫБРАТЬ
	               |	ВыручкаТОПоПозициям.Позиция,
	               |	ВыручкаТОПоПозициям.Склад,
	               |	ВыручкаТОПоПозициям.Менеджер,
	               |	ВыручкаТОПоПозициям.СуммаВыручкиОборот
	               |ИЗ
	               |	ВыручкаТОПоПозициям КАК ВыручкаТОПоПозициям
	               |
	               |ИНДЕКСИРОВАТЬ ПО
	               |	Склад,
	               |	Менеджер
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |УНИЧТОЖИТЬ ВыручкаТО
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |УНИЧТОЖИТЬ ВыручкаТОПоПозициям
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |ВЫБРАТЬ
	               |	Выручка.Склад КАК Склад,
	               |	Выручка.Менеджер КАК Менеджер,
	               |	СУММА(Выручка.СуммаВыручкиОборот) КАК СуммаВыручкиОборот,
	               |	1 КАК Позиция
	               |ПОМЕСТИТЬ ВыручкаПоКТСПомощь
	               |ИЗ
	               |	Выручка КАК Выручка
	               |ГДЕ
	               |	Выручка.ВидНоменклатуры = &ВидНоменклатурыКТСПомощь
	               |
	               |СГРУППИРОВАТЬ ПО
	               |	Выручка.Склад,
	               |	Выручка.Менеджер
	               |
	               |ИНДЕКСИРОВАТЬ ПО
	               |	Склад,
	               |	Менеджер
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |ВЫБРАТЬ
	               |	ВыручкаПоКТСПомощь.Склад,
	               |	ВыручкаПоКТСПомощь.Менеджер,
	               |	ВыручкаПоКТСПомощь.СуммаВыручкиОборот КАК СуммаВыручкиОборот,
	               |	СУММА(ВыручкаПоКТСПомощьКопия.Позиция) + 1 КАК Позиция
	               |ПОМЕСТИТЬ ВыручкаПоКТСПомощиПоПозициям
	               |ИЗ
	               |	ВыручкаПоКТСПомощь КАК ВыручкаПоКТСПомощь
	               |		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВыручкаПоКТСПомощь КАК ВыручкаПоКТСПомощьКопия
	               |		ПО ВыручкаПоКТСПомощь.СуммаВыручкиОборот > ВыручкаПоКТСПомощьКопия.СуммаВыручкиОборот
	               |
	               |СГРУППИРОВАТЬ ПО
	               |	ВыручкаПоКТСПомощь.Склад,
	               |	ВыручкаПоКТСПомощь.Менеджер,
	               |	ВыручкаПоКТСПомощь.СуммаВыручкиОборот
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |ВЫБРАТЬ
	               |	ВыручкаПоКТСПомощь.Позиция КАК Позиция,
	               |	ВыручкаПоКТСПомощь.Склад КАК Склад,
	               |	ВыручкаПоКТСПомощь.Менеджер КАК Менеджер,
	               |	ВыручкаПоКТСПомощь.СуммаВыручкиОборот
	               |ПОМЕСТИТЬ РандПоВыручкаКТСПомощь
	               |ИЗ
	               |	ВыручкаПоКТСПомощь КАК ВыручкаПоКТСПомощь
	               |ГДЕ
	               |	НЕ (ВыручкаПоКТСПомощь.Склад, ВыручкаПоКТСПомощь.Менеджер) В
	               |				(ВЫБРАТЬ
	               |					ВыручкаПоКТСПомощиПоПозициям.Склад,
	               |					ВыручкаПоКТСПомощиПоПозициям.Менеджер
	               |				ИЗ
	               |					ВыручкаПоКТСПомощиПоПозициям КАК ВыручкаПоКТСПомощиПоПозициям)
	               |
	               |ОБЪЕДИНИТЬ ВСЕ
	               |
	               |ВЫБРАТЬ
	               |	ВыручкаПоКТСПомощиПоПозициям.Позиция,
	               |	ВыручкаПоКТСПомощиПоПозициям.Склад,
	               |	ВыручкаПоКТСПомощиПоПозициям.Менеджер,
	               |	ВыручкаПоКТСПомощиПоПозициям.СуммаВыручкиОборот
	               |ИЗ
	               |	ВыручкаПоКТСПомощиПоПозициям КАК ВыручкаПоКТСПомощиПоПозициям
	               |
	               |ИНДЕКСИРОВАТЬ ПО
	               |	Склад,
	               |	Менеджер
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |УНИЧТОЖИТЬ ВыручкаПоКТСПомощь
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |УНИЧТОЖИТЬ ВыручкаПоКТСПомощиПоПозициям
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |ВЫБРАТЬ
	               |	ВЫРАЗИТЬ(ДополнительныеСведения.Объект КАК Справочник.ВидыНоменклатуры) КАК ВидыНоменклатуры
	               |ПОМЕСТИТЬ ВидыНоменклатурыАксесуары
	               |ИЗ
	               |	РегистрСведений.ДополнительныеСведения КАК ДополнительныеСведения
	               |ГДЕ
	               |	ДополнительныеСведения.Свойство = &СвойствоВидНоменклатурыАксесуары
	               |	И ДополнительныеСведения.Значение = &ЗначениеАксесуары
	               |
	               |ИНДЕКСИРОВАТЬ ПО
	               |	ВидыНоменклатуры
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |ВЫБРАТЬ
	               |	Выручка.Склад,
	               |	Выручка.Менеджер,
	               |	СУММА(Выручка.СуммаВыручкиОборот) КАК СуммаВыручкиОборот,
	               |	1 КАК Позиция
	               |ПОМЕСТИТЬ ВыручкаПоАКС
	               |ИЗ
	               |	Выручка КАК Выручка
	               |ГДЕ
	               |	Выручка.ВидНоменклатуры В
	               |			(ВЫБРАТЬ РАЗЛИЧНЫЕ
	               |				ВидыНоменклатурыАксесуары.ВидыНоменклатуры
	               |			ИЗ
	               |				ВидыНоменклатурыАксесуары КАК ВидыНоменклатурыАксесуары)
	               |
	               |СГРУППИРОВАТЬ ПО
	               |	Выручка.Склад,
	               |	Выручка.Менеджер
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |ВЫБРАТЬ
	               |	ВыручкаПоАКС.Склад,
	               |	ВыручкаПоАКС.Менеджер,
	               |	ВыручкаПоАКС.СуммаВыручкиОборот КАК СуммаВыручкиОборот,
	               |	СУММА(ВыручкаПоАКСКопия.Позиция) + 1 КАК Позиция
	               |ПОМЕСТИТЬ ВыручкаПоАКСПоПозициям
	               |ИЗ
	               |	ВыручкаПоАКС КАК ВыручкаПоАКС
	               |		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВыручкаПоАКС КАК ВыручкаПоАКСКопия
	               |		ПО ВыручкаПоАКС.СуммаВыручкиОборот > ВыручкаПоАКСКопия.СуммаВыручкиОборот
	               |
	               |СГРУППИРОВАТЬ ПО
	               |	ВыручкаПоАКС.Склад,
	               |	ВыручкаПоАКС.Менеджер,
	               |	ВыручкаПоАКС.СуммаВыручкиОборот
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |ВЫБРАТЬ
	               |	ВыручкаПоАКС.Позиция КАК Позиция,
	               |	ВыручкаПоАКС.Склад КАК Склад,
	               |	ВыручкаПоАКС.Менеджер КАК Менеджер,
	               |	ВыручкаПоАКС.СуммаВыручкиОборот
	               |ПОМЕСТИТЬ РандПоВыручкаАКС
	               |ИЗ
	               |	ВыручкаПоАКС КАК ВыручкаПоАКС
	               |ГДЕ
	               |	НЕ (ВыручкаПоАКС.Склад, ВыручкаПоАКС.Менеджер) В
	               |				(ВЫБРАТЬ
	               |					ВыручкаПоАКСПоПозициям.Склад,
	               |					ВыручкаПоАКСПоПозициям.Менеджер
	               |				ИЗ
	               |					ВыручкаПоАКСПоПозициям КАК ВыручкаПоАКСПоПозициям)
	               |
	               |ОБЪЕДИНИТЬ ВСЕ
	               |
	               |ВЫБРАТЬ
	               |	ВыручкаПоАКСПоПозициям.Позиция,
	               |	ВыручкаПоАКСПоПозициям.Склад,
	               |	ВыручкаПоАКСПоПозициям.Менеджер,
	               |	ВыручкаПоАКСПоПозициям.СуммаВыручкиОборот
	               |ИЗ
	               |	ВыручкаПоАКСПоПозициям КАК ВыручкаПоАКСПоПозициям
	               |
	               |ИНДЕКСИРОВАТЬ ПО
	               |	Склад,
	               |	Менеджер
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |УНИЧТОЖИТЬ ВидыНоменклатурыАксесуары
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |УНИЧТОЖИТЬ ВыручкаПоАКС
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |УНИЧТОЖИТЬ ВыручкаПоАКСПоПозициям
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |ВЫБРАТЬ
	               |	АналитикаСкладМенеджер.Склад КАК Склад,
	               |	АналитикаСкладМенеджер.Менеджер КАК Менеджер,
	               |	ЕСТЬNULL(РандПоВыручкаТО.Позиция, 0) * 0.3 КАК РандПоТО,
	               |	ЕСТЬNULL(РандПоВыручкаАКС.Позиция, 0) * 0.35 КАК РандПоАКС,
	               |	ЕСТЬNULL(РандПоВыручкаКТСПомощь.Позиция, 0) * 0.35 КАК РандПоКТСПомощь,
	               |	ЕСТЬNULL(РандПоВыручкаАКС.Позиция, 0) * 0.35 + ЕСТЬNULL(РандПоВыручкаКТСПомощь.Позиция, 0) * 0.35 + ЕСТЬNULL(РандПоВыручкаТО.Позиция, 0) * 0.3 КАК Сумма,
	               |	1 КАК Рейтинг,
	               |	РандПоВыручкаАКС.СуммаВыручкиОборот КАК ВыручкаАКС,
	               |	РандПоВыручкаКТСПомощь.СуммаВыручкиОборот КАК ВыручкаКТСПомощь,
	               |	РандПоВыручкаТО.СуммаВыручкиОборот КАК ВыручкаТО
	               |ПОМЕСТИТЬ СуммаРандов
	               |ИЗ
	               |	АналитикаСкладМенеджер КАК АналитикаСкладМенеджер
	               |		ЛЕВОЕ СОЕДИНЕНИЕ РандПоВыручкаТО КАК РандПоВыручкаТО
	               |		ПО АналитикаСкладМенеджер.Склад = РандПоВыручкаТО.Склад
	               |			И АналитикаСкладМенеджер.Менеджер = РандПоВыручкаТО.Менеджер
	               |		ЛЕВОЕ СОЕДИНЕНИЕ РандПоВыручкаКТСПомощь КАК РандПоВыручкаКТСПомощь
	               |		ПО АналитикаСкладМенеджер.Склад = РандПоВыручкаКТСПомощь.Склад
	               |			И АналитикаСкладМенеджер.Менеджер = РандПоВыручкаКТСПомощь.Менеджер
	               |		ЛЕВОЕ СОЕДИНЕНИЕ РандПоВыручкаАКС КАК РандПоВыручкаАКС
	               |		ПО АналитикаСкладМенеджер.Склад = РандПоВыручкаАКС.Склад
	               |			И АналитикаСкладМенеджер.Менеджер = РандПоВыручкаАКС.Менеджер
	               |
	               |ИНДЕКСИРОВАТЬ ПО
	               |	Склад,
	               |	Менеджер
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |УНИЧТОЖИТЬ Выручка
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |УНИЧТОЖИТЬ АналитикаСкладМенеджер
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |ВЫБРАТЬ
	               |	СуммаРандов.Склад,
	               |	СуммаРандов.Менеджер,
	               |	СуммаРандов.Сумма КАК Сумма,
	               |	СУММА(СуммаРандовКопия.Рейтинг) + 1 КАК Рейтинг
	               |ПОМЕСТИТЬ РейтингПоПозициям
	               |ИЗ
	               |	СуммаРандов КАК СуммаРандов
	               |		ВНУТРЕННЕЕ СОЕДИНЕНИЕ СуммаРандов КАК СуммаРандовКопия
	               |		ПО СуммаРандов.Сумма < СуммаРандовКопия.Сумма
	               |
	               |СГРУППИРОВАТЬ ПО
	               |	СуммаРандов.Склад,
	               |	СуммаРандов.Менеджер,
	               |	СуммаРандов.Сумма
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |ВЫБРАТЬ
	               |	СуммаРандов.Склад КАК Склад,
	               |	СуммаРандов.Менеджер КАК Менеджер,
	               |	СуммаРандов.Сумма КАК Сумма,
	               |	СуммаРандов.Рейтинг
	               |ПОМЕСТИТЬ РандРейтинг
	               |ИЗ
	               |	СуммаРандов КАК СуммаРандов
	               |ГДЕ
	               |	НЕ (СуммаРандов.Склад, СуммаРандов.Менеджер) В
	               |				(ВЫБРАТЬ
	               |					РейтингПоПозициям.Склад,
	               |					РейтингПоПозициям.Менеджер
	               |				ИЗ
	               |					РейтингПоПозициям КАК РейтингПоПозициям)
	               |
	               |ОБЪЕДИНИТЬ ВСЕ
	               |
	               |ВЫБРАТЬ
	               |	РейтингПоПозициям.Склад,
	               |	РейтингПоПозициям.Менеджер,
	               |	РейтингПоПозициям.Сумма,
	               |	РейтингПоПозициям.Рейтинг
	               |ИЗ
	               |	РейтингПоПозициям КАК РейтингПоПозициям
	               |
	               |ИНДЕКСИРОВАТЬ ПО
	               |	Склад,
	               |	Менеджер
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |УНИЧТОЖИТЬ РандПоВыручкаТО
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |УНИЧТОЖИТЬ РандПоВыручкаКТСПомощь
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |УНИЧТОЖИТЬ РандПоВыручкаАКС
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |УНИЧТОЖИТЬ РейтингПоПозициям
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |ВЫБРАТЬ
	               |	СуммаРандов.Склад,
	               |	СуммаРандов.Менеджер,
	               |	СуммаРандов.ВыручкаАКС,
	               |	СуммаРандов.ВыручкаКТСПомощь,
	               |	СуммаРандов.ВыручкаТО,
	               |	СуммаРандов.РандПоТО,
	               |	СуммаРандов.РандПоАКС,
	               |	СуммаРандов.РандПоКТСПомощь,
	               |	СуммаРандов.Сумма,
	               |	РандРейтинг.Рейтинг КАК Рейтинг,
	               |	ВЫБОР
	               |		КОГДА ЕСТЬNULL(СуммаРандов.ВыручкаТО, 0) = 0
	               |			ТОГДА 0
	               |		ИНАЧЕ 100 * СуммаРандов.ВыручкаАКС / СуммаРандов.ВыручкаТО
	               |	КОНЕЦ КАК ПроцентАКС,
	               |	ВЫБОР
	               |		КОГДА ЕСТЬNULL(СуммаРандов.ВыручкаТО, 0) = 0
	               |			ТОГДА 0
	               |		ИНАЧЕ 100 * СуммаРандов.ВыручкаКТСПомощь / СуммаРандов.ВыручкаТО
	               |	КОНЕЦ КАК ПроцентКТСПомощь
	               |ИЗ
	               |	СуммаРандов КАК СуммаРандов
	               |		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РандРейтинг КАК РандРейтинг
	               |		ПО СуммаРандов.Склад = РандРейтинг.Склад
	               |			И СуммаРандов.Менеджер = РандРейтинг.Менеджер
	               |
	               |УПОРЯДОЧИТЬ ПО
	               |	Рейтинг
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |УНИЧТОЖИТЬ СуммаРандов
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |УНИЧТОЖИТЬ РандРейтинг";
			
	Возврат ТекстЗапроса;
	
КонецФункции // ТекстЗапросаНабораДанных()

Функция ТекстЗапросаНабораДанныхПоОтбору()

	ТекстЗапроса ="ВЫБРАТЬ
	              |	Продажи.Регистратор,
	              |	Аналитика.Номенклатура,
	              |	ВЫБОР
	              |		КОГДА Аналитика.Склад = ЗНАЧЕНИЕ(Справочник.Склады.ПустаяСсылка)
	              |			ТОГДА ВЫБОР
	              |					КОГДА Продажи.Регистратор ССЫЛКА Документ.РеализацияТоваровУслуг
	              |						ТОГДА ВЫРАЗИТЬ(Продажи.Регистратор КАК Документ.РеализацияТоваровУслуг).Склад
	              |					КОГДА Продажи.Регистратор ССЫЛКА Документ.ВозвратТоваровОтКлиента
	              |						ТОГДА ВЫРАЗИТЬ(Продажи.Регистратор КАК Документ.ВозвратТоваровОтКлиента).Склад
	              |				КОНЕЦ
	              |		ИНАЧЕ Аналитика.Склад
	              |	КОНЕЦ КАК Склад,
	              |	ВЫБОР
	              |		КОГДА Продажи.Менеджер = ЗНАЧЕНИЕ(Справочник.Пользователи.ПустаяСсылка)
	              |			ТОГДА ВЫБОР
	              |					КОГДА Продажи.Регистратор ССЫЛКА Документ.РеализацияТоваровУслуг
	              |						ТОГДА ВЫРАЗИТЬ(Продажи.Регистратор КАК Документ.РеализацияТоваровУслуг).Менеджер
	              |					КОГДА Продажи.Регистратор ССЫЛКА Документ.ВозвратТоваровОтКлиента
	              |						ТОГДА ВЫРАЗИТЬ(Продажи.Регистратор КАК Документ.ВозвратТоваровОтКлиента).Менеджер
	              |				КОНЕЦ
	              |		ИНАЧЕ Продажи.Менеджер
	              |	КОНЕЦ КАК Менеджер,
	              |	Продажи.КоличествоОборот,
	              |	Продажи.СуммаВыручкиОборот,
	              |	Продажи.СуммаВыручкиРеглОборот,
	              |	Аналитика.Номенклатура.ВидНоменклатуры КАК ВидНоменклатуры
	              |ПОМЕСТИТЬ Выручка
	              |ИЗ
	              |	РегистрНакопления.ВыручкаИСебестоимостьПродаж.Обороты(&НачалоПериода, &КонецПериода, Авто, ) КАК Продажи
	              |		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.АналитикаУчетаНоменклатуры КАК Аналитика
	              |		ПО Продажи.АналитикаУчетаНоменклатуры = Аналитика.КлючАналитики
	              |ГДЕ
	              |	Продажи.Регистратор ССЫЛКА Документ.РеализацияТоваровУслуг
	              |	И %1
	              |
	              |ОБЪЕДИНИТЬ
	              |
	              |ВЫБРАТЬ
	              |	Продажи.Регистратор,
	              |	Аналитика.Номенклатура,
	              |	Аналитика.Склад,
	              |	ВЫБОР
	              |		КОГДА Продажи.Менеджер = ЗНАЧЕНИЕ(Справочник.Пользователи.ПустаяСсылка)
	              |			ТОГДА ВЫБОР
	              |					КОГДА Продажи.Регистратор ССЫЛКА Документ.РеализацияТоваровУслуг
	              |						ТОГДА ВЫРАЗИТЬ(Продажи.Регистратор КАК Документ.РеализацияТоваровУслуг).Менеджер
	              |					КОГДА Продажи.Регистратор ССЫЛКА Документ.ВозвратТоваровОтКлиента
	              |						ТОГДА ВЫРАЗИТЬ(Продажи.Регистратор КАК Документ.ВозвратТоваровОтКлиента).Менеджер
	              |				КОНЕЦ
	              |		ИНАЧЕ Продажи.Менеджер
	              |	КОНЕЦ,
	              |	Продажи.КоличествоОборот,
	              |	Продажи.СуммаВыручкиОборот,
	              |	Продажи.СуммаВыручкиРеглОборот,
	              |	Аналитика.Номенклатура.ВидНоменклатуры
	              |ИЗ
	              |	РегистрНакопления.ВыручкаИСебестоимостьПродаж.Обороты(&НачалоПериода, &КонецПериода, Авто, ) КАК Продажи
	              |		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.АналитикаУчетаНоменклатуры КАК Аналитика
	              |		ПО Продажи.АналитикаУчетаНоменклатуры = Аналитика.КлючАналитики
	              |ГДЕ
	              |	Продажи.Регистратор ССЫЛКА Документ.ВозвратТоваровОтКлиента
	              |	И %1
				  |
	              |ИНДЕКСИРОВАТЬ ПО
	              |	Склад,
	              |	Менеджер,
	              |	ВидНоменклатуры";
	Возврат ТекстЗапроса;

КонецФункции // ТекстЗапросаНабораДанныхПоОтбору()

Функция ТекстЗапросаНабораДанныхПоСкладом()
	
	ТекстЗапроса = "%1
				   |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |ВЫБРАТЬ РАЗЛИЧНЫЕ
	               |	Выручка.Склад КАК Склад,
	               |	Выручка.Менеджер КАК Менеджер
	               |ПОМЕСТИТЬ АналитикаСкладМенеджер
	               |ИЗ
	               |	Выручка КАК Выручка
	               |
	               |ИНДЕКСИРОВАТЬ ПО
	               |	Склад,
	               |	Менеджер
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |ВЫБРАТЬ
	               |	Выручка.Склад КАК Склад,
	               |	Выручка.Менеджер КАК Менеджер,
	               |	СУММА(Выручка.СуммаВыручкиОборот) КАК СуммаВыручкиОборот,
	               |	1 КАК Позиция
	               |ПОМЕСТИТЬ ВыручкаТО
	               |ИЗ
	               |	Выручка КАК Выручка
	               |
	               |СГРУППИРОВАТЬ ПО
	               |	Выручка.Склад,
	               |	Выручка.Менеджер
	               |
	               |ИНДЕКСИРОВАТЬ ПО
	               |	Склад,
	               |	Менеджер
	               |	
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |ВЫБРАТЬ
	               |	ВыручкаТО.Склад КАК Склад,
	               |	ВыручкаТО.Менеджер КАК Менеджер,
	               |	ВыручкаТО.СуммаВыручкиОборот КАК СуммаВыручкиОборот,
	               |	СУММА(ВыручкаТОКопия.Позиция) + 1 КАК Позиция
	               |ПОМЕСТИТЬ ВыручкаТОПоПозициям
	               |ИЗ
	               |	ВыручкаТО КАК ВыручкаТО
	               |
				   |ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВыручкаТО КАК ВыручкаТОКопия
	               |ПО ВыручкаТО.СуммаВыручкиОборот > ВыручкаТОКопия.СуммаВыручкиОборот
	               |
	               |СГРУППИРОВАТЬ ПО
	               |	ВыручкаТО.Склад,
	               |	ВыручкаТО.Менеджер,
	               |	ВыручкаТО.СуммаВыручкиОборот
	               |
	               |ИНДЕКСИРОВАТЬ ПО
	               |	Склад,
	               |	Менеджер
	               |	
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |ВЫБРАТЬ
	               |	ВыручкаТО.Позиция КАК Позиция,
	               |	ВыручкаТО.Склад КАК Склад,
	               |	ВыручкаТО.Менеджер КАК Менеджер,
	               |	ВыручкаТО.СуммаВыручкиОборот
	               |ПОМЕСТИТЬ РандПоВыручкаТО
	               |ИЗ
	               |	ВыручкаТО КАК ВыручкаТО
	               |ГДЕ
	               |	(ВыручкаТО.Склад, ВыручкаТО.Менеджер) НЕ В
	               |				(ВЫБРАТЬ
	               |					ВыручкаТОПоПозициям.Склад,
	               |					ВыручкаТОПоПозициям.Менеджер
	               |				ИЗ
	               |					ВыручкаТОПоПозициям КАК ВыручкаТОПоПозициям)
	               |
	               |ОБЪЕДИНИТЬ ВСЕ
	               |
	               |ВЫБРАТЬ
	               |	ВыручкаТОПоПозициям.Позиция,
	               |	ВыручкаТОПоПозициям.Склад,
	               |	ВыручкаТОПоПозициям.Менеджер,
	               |	ВыручкаТОПоПозициям.СуммаВыручкиОборот
	               |ИЗ
	               |	ВыручкаТОПоПозициям КАК ВыручкаТОПоПозициям
	               |
	               |ИНДЕКСИРОВАТЬ ПО
	               |	Склад,
	               |	Менеджер
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |УНИЧТОЖИТЬ ВыручкаТО
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |УНИЧТОЖИТЬ ВыручкаТОПоПозициям
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |ВЫБРАТЬ
	               |	Выручка.Склад КАК Склад,
	               |	Выручка.Менеджер КАК Менеджер,
	               |	СУММА(Выручка.СуммаВыручкиОборот) КАК СуммаВыручкиОборот,
	               |	1 КАК Позиция
	               |ПОМЕСТИТЬ ВыручкаПоКТСПомощь
	               |ИЗ
	               |	Выручка КАК Выручка
	               |ГДЕ
	               |	Выручка.ВидНоменклатуры = &ВидНоменклатурыКТСПомощь
	               |
	               |СГРУППИРОВАТЬ ПО
	               |	Выручка.Склад,
	               |	Выручка.Менеджер
	               |
	               |ИНДЕКСИРОВАТЬ ПО
	               |	Склад,
	               |	Менеджер
	               |	
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |ВЫБРАТЬ
	               |	ВыручкаПоКТСПомощь.Склад,
	               |	ВыручкаПоКТСПомощь.Менеджер,
	               |	ВыручкаПоКТСПомощь.СуммаВыручкиОборот КАК СуммаВыручкиОборот,
	               |	СУММА(ВыручкаПоКТСПомощьКопия.Позиция) + 1 КАК Позиция
	               |ПОМЕСТИТЬ ВыручкаПоКТСПомощиПоПозициям
	               |ИЗ
	               |	ВыручкаПоКТСПомощь КАК ВыручкаПоКТСПомощь
	               |		
				   |ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВыручкаПоКТСПомощь КАК ВыручкаПоКТСПомощьКопия
	               |ПО ВыручкаПоКТСПомощь.СуммаВыручкиОборот > ВыручкаПоКТСПомощьКопия.СуммаВыручкиОборот
	               |
	               |СГРУППИРОВАТЬ ПО
	               |	ВыручкаПоКТСПомощь.Склад,
	               |	ВыручкаПоКТСПомощь.Менеджер,
	               |	ВыручкаПоКТСПомощь.СуммаВыручкиОборот
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |ВЫБРАТЬ
	               |	ВыручкаПоКТСПомощь.Позиция КАК Позиция,
	               |	ВыручкаПоКТСПомощь.Склад КАК Склад,
	               |	ВыручкаПоКТСПомощь.Менеджер КАК Менеджер,
	               |	ВыручкаПоКТСПомощь.СуммаВыручкиОборот
	               |ПОМЕСТИТЬ РандПоВыручкаКТСПомощь
	               |ИЗ
	               |	ВыручкаПоКТСПомощь КАК ВыручкаПоКТСПомощь
	               |ГДЕ
	               |	(ВыручкаПоКТСПомощь.Склад, ВыручкаПоКТСПомощь.Менеджер) НЕ В
	               |				(ВЫБРАТЬ
	               |					ВыручкаПоКТСПомощиПоПозициям.Склад,
	               |					ВыручкаПоКТСПомощиПоПозициям.Менеджер
	               |				ИЗ
	               |					ВыручкаПоКТСПомощиПоПозициям КАК ВыручкаПоКТСПомощиПоПозициям)
	               |
	               |ОБЪЕДИНИТЬ ВСЕ
	               |
	               |ВЫБРАТЬ
	               |	ВыручкаПоКТСПомощиПоПозициям.Позиция,
	               |	ВыручкаПоКТСПомощиПоПозициям.Склад,
	               |	ВыручкаПоКТСПомощиПоПозициям.Менеджер,
	               |	ВыручкаПоКТСПомощиПоПозициям.СуммаВыручкиОборот
	               |ИЗ
	               |	ВыручкаПоКТСПомощиПоПозициям КАК ВыручкаПоКТСПомощиПоПозициям
	               |
	               |ИНДЕКСИРОВАТЬ ПО
	               |	Склад,
	               |	Менеджер
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |УНИЧТОЖИТЬ ВыручкаПоКТСПомощь
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |УНИЧТОЖИТЬ ВыручкаПоКТСПомощиПоПозициям
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |ВЫБРАТЬ
	               |	ВЫРАЗИТЬ(ДополнительныеСведения.Объект КАК Справочник.ВидыНоменклатуры) КАК ВидыНоменклатуры
	               |ПОМЕСТИТЬ ВидыНоменклатурыАксесуары
	               |ИЗ
	               |	РегистрСведений.ДополнительныеСведения КАК ДополнительныеСведения
	               |ГДЕ
	               |	ДополнительныеСведения.Свойство = &СвойствоВидНоменклатурыАксесуары
	               |	И ДополнительныеСведения.Значение = &ЗначениеАксесуары
	               |
	               |ИНДЕКСИРОВАТЬ ПО
	               |	ВидыНоменклатуры
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |ВЫБРАТЬ
	               |	Выручка.Склад,
	               |	Выручка.Менеджер,
	               |	СУММА(Выручка.СуммаВыручкиОборот) КАК СуммаВыручкиОборот,
	               |	1 КАК Позиция
	               |ПОМЕСТИТЬ ВыручкаПоАКС
	               |ИЗ
	               |	Выручка КАК Выручка
	               |ГДЕ
	               |	Выручка.ВидНоменклатуры В
	               |			(ВЫБРАТЬ РАЗЛИЧНЫЕ
	               |				ВидыНоменклатурыАксесуары.ВидыНоменклатуры
	               |			ИЗ
	               |				ВидыНоменклатурыАксесуары КАК ВидыНоменклатурыАксесуары)
	               |
	               |СГРУППИРОВАТЬ ПО
	               |	Выручка.Склад,
	               |	Выручка.Менеджер
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |ВЫБРАТЬ
	               |	ВыручкаПоАКС.Склад,
	               |	ВыручкаПоАКС.Менеджер,
	               |	ВыручкаПоАКС.СуммаВыручкиОборот КАК СуммаВыручкиОборот,
	               |	СУММА(ВыручкаПоАКСКопия.Позиция) + 1 КАК Позиция
	               |ПОМЕСТИТЬ ВыручкаПоАКСПоПозициям
	               |ИЗ
	               |	ВыручкаПоАКС КАК ВыручкаПоАКС
	               |		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВыручкаПоАКС КАК ВыручкаПоАКСКопия
	               |		ПО ВыручкаПоАКС.СуммаВыручкиОборот > ВыручкаПоАКСКопия.СуммаВыручкиОборот
	               |
	               |СГРУППИРОВАТЬ ПО
	               |	ВыручкаПоАКС.Склад,
	               |	ВыручкаПоАКС.Менеджер,
	               |	ВыручкаПоАКС.СуммаВыручкиОборот
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |ВЫБРАТЬ
	               |	ВыручкаПоАКС.Позиция КАК Позиция,
	               |	ВыручкаПоАКС.Склад КАК Склад,
	               |	ВыручкаПоАКС.Менеджер КАК Менеджер,
	               |	ВыручкаПоАКС.СуммаВыручкиОборот
	               |ПОМЕСТИТЬ РандПоВыручкаАКС
	               |ИЗ
	               |	ВыручкаПоАКС КАК ВыручкаПоАКС
	               |ГДЕ
	               |	(ВыручкаПоАКС.Склад, ВыручкаПоАКС.Менеджер) НЕ В
	               |				(ВЫБРАТЬ
	               |					ВыручкаПоАКСПоПозициям.Склад,
	               |					ВыручкаПоАКСПоПозициям.Менеджер
	               |				ИЗ
	               |					ВыручкаПоАКСПоПозициям КАК ВыручкаПоАКСПоПозициям)
	               |
	               |ОБЪЕДИНИТЬ ВСЕ
	               |
	               |ВЫБРАТЬ
	               |	ВыручкаПоАКСПоПозициям.Позиция,
	               |	ВыручкаПоАКСПоПозициям.Склад,
	               |	ВыручкаПоАКСПоПозициям.Менеджер,
	               |	ВыручкаПоАКСПоПозициям.СуммаВыручкиОборот
	               |ИЗ
	               |	ВыручкаПоАКСПоПозициям КАК ВыручкаПоАКСПоПозициям
	               |
	               |ИНДЕКСИРОВАТЬ ПО
	               |	Склад,
	               |	Менеджер
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |УНИЧТОЖИТЬ ВидыНоменклатурыАксесуары
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |УНИЧТОЖИТЬ ВыручкаПоАКС
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |УНИЧТОЖИТЬ ВыручкаПоАКСПоПозициям
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |ВЫБРАТЬ
	               |	АналитикаСкладМенеджер.Склад КАК Склад,
	               |	АналитикаСкладМенеджер.Менеджер КАК Менеджер,
	               |	ЕСТЬNULL(РандПоВыручкаТО.Позиция, 0) * 0.3 КАК РандПоТО,
	               |	ЕСТЬNULL(РандПоВыручкаАКС.Позиция, 0) * 0.35 КАК РандПоАКС,
	               |	ЕСТЬNULL(РандПоВыручкаКТСПомощь.Позиция, 0) * 0.35 КАК РандПоКТСПомощь,
	               |	ЕСТЬNULL(РандПоВыручкаАКС.Позиция, 0) * 0.35 + ЕСТЬNULL(РандПоВыручкаКТСПомощь.Позиция, 0) * 0.35 + ЕСТЬNULL(РандПоВыручкаТО.Позиция, 0) * 0.3 КАК Сумма,
	               |	1 КАК Рейтинг,
	               |	РандПоВыручкаАКС.СуммаВыручкиОборот КАК ВыручкаАКС,
	               |	РандПоВыручкаКТСПомощь.СуммаВыручкиОборот КАК ВыручкаКТСПомощь,
	               |	РандПоВыручкаТО.СуммаВыручкиОборот КАК ВыручкаТО
	               |ПОМЕСТИТЬ СуммаРандов
	               |ИЗ
	               |	АналитикаСкладМенеджер КАК АналитикаСкладМенеджер
	               |		ЛЕВОЕ СОЕДИНЕНИЕ РандПоВыручкаТО КАК РандПоВыручкаТО
	               |		ПО АналитикаСкладМенеджер.Склад = РандПоВыручкаТО.Склад
	               |			И АналитикаСкладМенеджер.Менеджер = РандПоВыручкаТО.Менеджер
	               |		ЛЕВОЕ СОЕДИНЕНИЕ РандПоВыручкаКТСПомощь КАК РандПоВыручкаКТСПомощь
	               |		ПО АналитикаСкладМенеджер.Склад = РандПоВыручкаКТСПомощь.Склад
	               |			И АналитикаСкладМенеджер.Менеджер = РандПоВыручкаКТСПомощь.Менеджер
	               |		ЛЕВОЕ СОЕДИНЕНИЕ РандПоВыручкаАКС КАК РандПоВыручкаАКС
	               |		ПО АналитикаСкладМенеджер.Склад = РандПоВыручкаАКС.Склад
	               |			И АналитикаСкладМенеджер.Менеджер = РандПоВыручкаАКС.Менеджер
	               |
	               |ИНДЕКСИРОВАТЬ ПО
	               |	Склад,
	               |	Менеджер
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |УНИЧТОЖИТЬ Выручка
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |УНИЧТОЖИТЬ АналитикаСкладМенеджер
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |ВЫБРАТЬ
	               |	СуммаРандов.Склад,
	               |	СуммаРандов.Менеджер,
	               |	СуммаРандов.Сумма КАК Сумма,
	               |	СУММА(СуммаРандовКопия.Рейтинг) + 1 КАК Рейтинг
	               |ПОМЕСТИТЬ РейтингПоПозициям
	               |ИЗ
	               |	СуммаРандов КАК СуммаРандов
	               |		ВНУТРЕННЕЕ СОЕДИНЕНИЕ СуммаРандов КАК СуммаРандовКопия
	               |		ПО СуммаРандов.Сумма < СуммаРандовКопия.Сумма
	               |
	               |СГРУППИРОВАТЬ ПО
	               |	СуммаРандов.Склад,
	               |	СуммаРандов.Менеджер,
	               |	СуммаРандов.Сумма
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |ВЫБРАТЬ
	               |	СуммаРандов.Склад КАК Склад,
	               |	СуммаРандов.Менеджер КАК Менеджер,
	               |	СуммаРандов.Сумма КАК Сумма,
	               |	СуммаРандов.Рейтинг
	               |ПОМЕСТИТЬ РандРейтинг
	               |ИЗ
	               |	СуммаРандов КАК СуммаРандов
	               |ГДЕ
	               |	(СуммаРандов.Склад, СуммаРандов.Менеджер) НЕ В
	               |				(ВЫБРАТЬ
	               |					РейтингПоПозициям.Склад,
	               |					РейтингПоПозициям.Менеджер
	               |				ИЗ
	               |					РейтингПоПозициям КАК РейтингПоПозициям)
	               |
	               |ОБЪЕДИНИТЬ ВСЕ
	               |
	               |ВЫБРАТЬ
	               |	РейтингПоПозициям.Склад,
	               |	РейтингПоПозициям.Менеджер,
	               |	РейтингПоПозициям.Сумма,
	               |	РейтингПоПозициям.Рейтинг
	               |ИЗ
	               |	РейтингПоПозициям КАК РейтингПоПозициям
	               |
	               |ИНДЕКСИРОВАТЬ ПО
	               |	Склад,
	               |	Менеджер
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |УНИЧТОЖИТЬ РандПоВыручкаТО
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |УНИЧТОЖИТЬ РандПоВыручкаКТСПомощь
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |УНИЧТОЖИТЬ РандПоВыручкаАКС
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |УНИЧТОЖИТЬ РейтингПоПозициям
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |ВЫБРАТЬ
	               |	СуммаРандов.Склад,
	               |	СуммаРандов.Менеджер,
	               |	СуммаРандов.ВыручкаАКС,
	               |	СуммаРандов.ВыручкаКТСПомощь,
	               |	СуммаРандов.ВыручкаТО,
	               |	СуммаРандов.РандПоТО,
	               |	СуммаРандов.РандПоАКС,
	               |	СуммаРандов.РандПоКТСПомощь,
	               |	СуммаРандов.Сумма,
	               |	РандРейтинг.Рейтинг КАК Рейтинг,
				   |	ВЫБОР
	               |		КОГДА ЕСТЬNULL(СуммаРандов.ВыручкаТО, 0) = 0
	               |			ТОГДА 0
	               |		ИНАЧЕ 100 * СуммаРандов.ВыручкаКТСПомощь / СуммаРандов.ВыручкаТО
	               |	КОНЕЦ КАК ПроцентКТСПомощь,
				   |    ВЫБОР
	               |		КОГДА ЕСТЬNULL(СуммаРандов.ВыручкаТО, 0) = 0
	               |			ТОГДА 0
	               |		ИНАЧЕ 100 * СуммаРандов.ВыручкаАКС /  ISnull(СуммаРандов.ВыручкаТО,1)
	               |	КОНЕЦ КАК ПроцентАКС
	               |ИЗ
	               |	СуммаРандов КАК СуммаРандов
	               |		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РандРейтинг КАК РандРейтинг
	               |		ПО СуммаРандов.Склад = РандРейтинг.Склад
	               |			И СуммаРандов.Менеджер = РандРейтинг.Менеджер
	               |
	               |УПОРЯДОЧИТЬ ПО
	               |	Рейтинг
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |УНИЧТОЖИТЬ СуммаРандов
	               |;
	               |
	               |////////////////////////////////////////////////////////////////////////////////
	               |УНИЧТОЖИТЬ РандРейтинг";
			
	Возврат ТекстЗапроса;
	
КонецФункции // ТекстЗапросаНабораДанных()

Функция ПолучитьЗначениеПараметра(ИмяПараметра)
	
	ПараметрДанных = КомпоновщикНастроек.Настройки.ПараметрыДанных.Элементы.Найти(ИмяПараметра);
   	Если ПараметрДанных <> Неопределено Тогда
    	ПараметрПользовательскойНастройки = КомпоновщикНастроек.ПользовательскиеНастройки.Элементы.Найти(ПараметрДанных.ИдентификаторПользовательскойНастройки);
   		Если ПараметрПользовательскойНастройки <> Неопределено Тогда
			Возврат ПараметрПользовательскойНастройки.Значение;
     	Иначе
       		Возврат ПараметрДанных.Значение;
		КонецЕсли;
	КонецЕсли;
	
	Возврат Неопределено;
	
КонецФункции

Функция ПроверитьПараметрыКомпоновщика()

	ПериодОтчета = ПолучитьЗначениеПараметра("ПериодОтчета");
	
	Если ТипЗнч(ПериодОтчета) <> Тип("СтандартныйПериод") Тогда
		ВызватьИсключение НСтр("ru='Для работы отчета необходимо установить период.'", ОбщегоНазначенияКлиентСервер.КодОсновногоЯзыка());
		Возврат Ложь;
	КонецЕсли;
	
	Если ПериодОтчета.ДатаНачала = Дата("00010101") Тогда
		ВызватьИсключение НСтр("ru='Необходимо задать дату начала выполнения отчета.'", ОбщегоНазначенияКлиентСервер.КодОсновногоЯзыка());
		Возврат Ложь;
	КонецЕсли;
	
	Если ПериодОтчета.ДатаОкончания = Дата("00010101") Тогда
		ВызватьИсключение НСтр("ru='Необходимо задать дату окончания выполнения отчета.'", ОбщегоНазначенияКлиентСервер.КодОсновногоЯзыка());
		Возврат Ложь;
	КонецЕсли;
	
	Если ПериодОтчета.ДатаОкончания < ПериодОтчета.ДатаНачала Тогда
		ВызватьИсключение НСтр("ru='Дата начала выполнения отчета должна быть больше даты окончания выполнения.'", ОбщегоНазначенияКлиентСервер.КодОсновногоЯзыка());
		Возврат Ложь;
	КонецЕсли;
	
	Если (ПериодОтчета.ДатаОкончания - ПериодОтчета.ДатаНачала) > 7889229 Тогда // Период не больше 3 месяцев, иначе труба
		ВызватьИсключение НСтр("ru='Пожалуйста, выберите период поменьше, поберегите себя и других пользователей.'", ОбщегоНазначенияКлиентСервер.КодОсновногоЯзыка());
		Возврат Ложь;
	КонецЕсли;
	
	
	СвойствоКлассификацияВидовНоменклатуры = ктс_ПредопределенныеЗначенияПовтИсп.СвойствоКлассификацияВидовНоменклатуры();
	
	Если ЗначениеЗаполнено(СвойствоКлассификацияВидовНоменклатуры) = ЛОЖЬ Тогда
		ВызватьИсключение НСтр("ru='Не заполнена константа СвойствоКлассификацияВидовНоменклатуры в справочнику КТС_Константи.'", ОбщегоНазначенияКлиентСервер.КодОсновногоЯзыка());
		Возврат Ложь;
	КонецЕсли;

	ВидНоменклатурыКТСПомощь = ктс_ПредопределенныеЗначенияПовтИсп.ВидНоменклатурыКТСПомощь();
	Если ЗначениеЗаполнено(ВидНоменклатурыКТСПомощь) = ЛОЖЬ Тогда
		ВызватьИсключение НСтр("ru='Не заполнена константа ВидНоменклатурыКТСПомощь в справочнику КТС_Константи.'", ОбщегоНазначенияКлиентСервер.КодОсновногоЯзыка());
		Возврат Ложь;
	КонецЕсли;  

	ЗначенияСвойствОбъектовАксесуары = ктс_ПредопределенныеЗначенияПовтИсп.ЗначенияСвойствОбъектовАксесуары();
	Если ЗначениеЗаполнено(ЗначенияСвойствОбъектовАксесуары) = ЛОЖЬ Тогда
		ВызватьИсключение НСтр("ru='Не заполнена константа ЗначенияСвойствОбъектовАксесуары в справочнику КТС_Константи.'", ОбщегоНазначенияКлиентСервер.КодОсновногоЯзыка());
		Возврат Ложь;
	КонецЕсли;

	
	Если ПроверитьВариантОтчетаНаОтборПоСкладам() = ИСТИНА Тогда
		Если ЕстьОтборПоСкладу() =ЛОЖЬ Тогда
			ВызватьИсключение НСтр("ru='Не заполненный отбор по складу.'", ОбщегоНазначенияКлиентСервер.КодОсновногоЯзыка());
			Возврат Ложь;     	
		КонецЕсли;
	КонецЕсли;
	Возврат Истина;

КонецФункции // ПроверитьПараметрыКомпоновщика()
 
Функция ПроверитьВариантОтчетаНаОтборПоСкладам()
	
	ДопольнительныеНастройки = КомпоновщикНастроек.Настройки.ДополнительныеСвойства;
	Если ТипЗнч(ДопольнительныеНастройки) <> Тип("Структура") Тогда
		Возврат ЛОЖЬ;	
	КонецЕсли;
	
	Если ДопольнительныеНастройки.Свойство("НаименованиеТекущегоВарианта") Тогда
		Если ДопольнительныеНастройки.НаименованиеТекущегоВарианта = "Анализ производительности продавцов по складам" Тогда
			Возврат Истина;		
		КонецЕсли;         	
	КонецЕсли;
	
	Возврат ЛОЖЬ;
КонецФункции

Функция ЕстьОтборПоСкладу()
	
	НастройкиОтчета = КомпоновщикНастроек.ПолучитьНастройки();
	ОтборыОтчета = НастройкиОтчета.Отбор.Элементы;
	
	Для каждого Отбор Из ОтборыОтчета Цикл
		Если Отбор.Использование = Истина 
			И Отбор.ИдентификаторПользовательскойНастройки = "58449244-fea3-4e46-8814-23d2845a39ab"
			И Отбор.ВидСравнения <>  ВидСравненияКомпоновкиДанных.Заполнено 
			И Отбор.ВидСравнения <>  ВидСравненияКомпоновкиДанных.НеЗаполнено  Тогда  
		    Возврат ЗначениеЗаполнено(Отбор.ПравоеЗначение);
		КонецЕсли;		
	КонецЦикла;
	
	Возврат ЛОЖЬ;
КонецФункции

Функция ПолучитьОтборПоСкладу()
	НастройкиОтчета = КомпоновщикНастроек.ПолучитьНастройки();
	ОтборыОтчета = НастройкиОтчета.Отбор.Элементы;
	
	Для каждого Отбор Из ОтборыОтчета Цикл
		Если Отбор.Использование = Истина 
			И Отбор.ИдентификаторПользовательскойНастройки = "58449244-fea3-4e46-8814-23d2845a39ab"  Тогда  
		    Возврат Отбор;
		КонецЕсли;		
	КонецЦикла;
	
	Возврат НЕопределено;	

КонецФункции // ПолучитьОтборПоСкладу()


#КонецОбласти

#Область СведенияОВнешнейОбработке

Функция СведенияОВнешнейОбработке() Экспорт
	
	Версия = "1.0.6";
	
	// Объявим переменную, в которой мы сохраним и вернем "наружу" необходимые данные
    ПараметрыРегистрации = Новый Структура;

    // Объявим еще одну переменную, которая нам потребуется ниже
    МассивНазначений = Новый Массив;
    
    // Первый параметр, который мы должны указать - это какой вид обработки системе должна зарегистрировать. 
    // Допустимые типы: ДополнительнаяОбработка, ДополнительныйОтчет, ЗаполнениеОбъекта, Отчет, ПечатнаяФорма, СозданиеСвязанныхОбъектов
    ПараметрыРегистрации.Вставить("Вид", "ДополнительныйОтчет");

    // Теперь нам необходимо передать в виде массива имен, к чему будет подключена наша ВПФ
    // Имейте ввиду, что можно задать имя в таком виде: Документ.* - в этом случае обработка будет подключена ко всем документам в системе, 
    // которые поддерживают механизм ВПФ
	//СчитатьДокументыНазначений(МассивНазначений);
	
	
	ПараметрыРегистрации.Вставить("Назначение", Новый Массив);
    
    // Теперь зададим имя, под которым ВПФ будет зарегистрирована в справочнике внешних обработок
    ПараметрыРегистрации.Вставить("Наименование", "Анализ производительности продавцов ["+Версия+"]");
    
    // Зададим право обработке на использование безопасного режима. Более подробно можно узнать в справке к платформе (метод УстановитьБезопасныйРежим)
    ПараметрыРегистрации.Вставить("БезопасныйРежим", Ложь);

    // Следующие два параметра играют больше информационную роль, т.е. это то, что будет видеть пользователь в информации к обработке
    ПараметрыРегистрации.Вставить("Версия", Версия);    
    ПараметрыРегистрации.Вставить("Информация", "Анализ производительности продавцов ["+Версия+"]");
    
    // Создадим таблицу команд (подробнее смотрим ниже)
    ТаблицаКоманд = ПолучитьТаблицуКоманд();
    
    // Добавим команду в таблицу
    ДобавитьКоманду(ТаблицаКоманд, "Анализ производительности продавцов ["+Версия+"]", "АПП", "ОткрытиеФормы", Ложь, "АПП");
    
    // Сохраним таблицу команд в параметры регистрации обработки
    ПараметрыРегистрации.Вставить("Команды", ТаблицаКоманд);
    
    // Теперь вернем системе наши параметры
    Возврат ПараметрыРегистрации;
	
КонецФункции

Процедура СчитатьДокументыНазначений(МассивНазначений)
	
	//Макет = ПолучитьМакет("МакетДокументыНазначений");
	//
	//Для Инд = 1 По Макет.ВысотаТаблицы Цикл
	//	МассивНазначений.Добавить(Макет.Область(Инд,1).Текст);
	//КонецЦикла;
	
КонецПроцедуры

Функция ПолучитьТаблицуКоманд()

   // Создадим пустую таблицу команд и колонки в ней
   Команды = Новый ТаблицаЗначений;

   // Как будет выглядеть описание печатной формы для пользователя
   Команды.Колонки.Добавить("Представление", Новый ОписаниеТипов("Строка")); 

   // Имя нашего макета, что бы могли отличить вызванную команду в обработке печати
   Команды.Колонки.Добавить("Идентификатор", Новый ОписаниеТипов("Строка"));

   // Тут задается, как должна вызваться команда обработки
   // Возможные варианты:
   // - ОткрытиеФормы - в этом случае в колонке идентификатор должно быть указано имя формы, которое должна будет открыть система
   // - ВызовКлиентскогоМетода - вызвать клиентскую экспортную процедуру из модуля формы обработки
   // - ВызовСерверногоМетода - вызвать серверную экспортную процедуру из модуля объекта обработки
   Команды.Колонки.Добавить("Использование", Новый ОписаниеТипов("Строка"));

   // Следующий параметр указывает, необходимо ли показывать оповещение при начале и завершению работы обработки. Не имеет смысла при открытии формы
   Команды.Колонки.Добавить("ПоказыватьОповещение", Новый ОписаниеТипов("Булево"));

   // Для печатной формы должен содержать строку ПечатьMXL 
   Команды.Колонки.Добавить("Модификатор", Новый ОписаниеТипов("Строка"));
   
   Возврат Команды;
   
КонецФункции

Процедура ДобавитьКоманду(ТаблицаКоманд, Представление, Идентификатор, Использование, ПоказыватьОповещение = Ложь, Модификатор = "")
	
  // Добавляем команду в таблицу команд по переданному описанию.
  // Параметры и их значения можно посмотреть в функции ПолучитьТаблицуКоманд
  НоваяКоманда = ТаблицаКоманд.Добавить();
  НоваяКоманда.Представление = Представление;
  НоваяКоманда.Идентификатор = Идентификатор;
  НоваяКоманда.Использование = Использование;
  НоваяКоманда.ПоказыватьОповещение = ПоказыватьОповещение;
  НоваяКоманда.Модификатор = Модификатор;

КонецПроцедуры
	
#КонецОбласти 