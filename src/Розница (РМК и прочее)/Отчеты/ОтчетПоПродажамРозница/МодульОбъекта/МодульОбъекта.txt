
#Область ИнтерфейсАвтоматическихТестов

&НаКлиенте
Перем ЮнитТест;

&НаКлиенте
Функция ПолучитьСписокТестов(ЮнитТестирование) Экспорт
	
	ЮнитТест = ЮнитТестирование;
	
	СписокТестов = Новый Массив;
	Возврат СписокТестов;
	
КонецФункции

#КонецОбласти

#Область ПрограммныйИнтерфейс
Процедура ПриКомпоновкеРезультата(ДокументРезультат, ДанныеРасшифровки, СтандартнаяОбработка)	
	
	СтандартнаяОбработка = Ложь;
	УстановитьПривилегированныйРежим(Истина);	
	
	ОтчетПоПрадажам 	= ПолучитьНаборДанных();
	ВнешниеНаборыДанных = Новый Структура;
    ВнешниеНаборыДанных.Вставить("ОтчетПоПрадажам",ОтчетПоПрадажам);
	
 	НастройкиОтчета = КомпоновщикНастроек.ПолучитьНастройки(); 

	КомпоновщикМакета = Новый КомпоновщикМакетаКомпоновкиДанных;
	МакетКомпоновки = КомпоновщикМакета.Выполнить(СхемаКомпоновкиДанных, НастройкиОтчета, ДанныеРасшифровки);

	Если МакетКомпоновки.НаборыДанных.Количество() = 0 Тогда
		ВызватьИсключение НСтр("ru= 'Отчет не сформирован. Включите хотя бы одну группировку в ""Элементы оформления и группировки"".'") ;
	КонецЕсли;
	
	ПроцессорКомпоновки = Новый ПроцессорКомпоновкиДанных;
	ПроцессорКомпоновки.Инициализировать(МакетКомпоновки, ВнешниеНаборыДанных, ДанныеРасшифровки);

	ПроцессорВывода = Новый ПроцессорВыводаРезультатаКомпоновкиДанныхВТабличныйДокумент;
	ПроцессорВывода.УстановитьДокумент(ДокументРезультат);
	ПроцессорВывода.Вывести(ПроцессорКомпоновки);
	
КонецПроцедуры
#КонецОбласти

#Область СлужебныеПроцедурыИФункции
Функция ПолучитьЗначениеПараметра(ИмяПараметра)

  ПараметрДанных = КомпоновщикНастроек.Настройки.ПараметрыДанных.Элементы.Найти(ИмяПараметра);
   Если ПараметрДанных <> Неопределено Тогда
     ПараметрПользовательскойНастройки = КомпоновщикНастроек.ПользовательскиеНастройки.Элементы.Найти(ПараметрДанных.ИдентификаторПользовательскойНастройки);
     Если ПараметрПользовательскойНастройки <> Неопределено Тогда
       Возврат ПараметрПользовательскойНастройки.Значение;
     Иначе
       Возврат ПараметрДанных.Значение;
     КонецЕсли;
   КонецЕсли;

  Возврат Неопределено;

КонецФункции

Функция ПолучитьНаборДанных()

	Перем ПроцентПродажыУслуги, ПроцентИсполненияУслуги, СвойствоПомощьКТС, ГруппаСертификаты, ПроцентОтПродажыСертификата;
	
	Настройки = ХранилищеНастроекДанныхФорм.Загрузить("ДополнительныеНастройкиПроцентовКТСПомощь", , , "ДополнительныеНастройкиПроцентовКТСПомощь");
	
	Если ТипЗнч(Настройки) <> Тип("Структура") Тогда
		Возврат Неопределено;
	КонецЕсли;
	
	Настройки.Свойство("ПроцентПродажыУслуги", ПроцентПродажыУслуги);
	Настройки.Свойство("ПроцентИсполненияУслуги", ПроцентИсполненияУслуги);
	Настройки.Свойство("СвойствоПомощьКТС", СвойствоПомощьКТС);
	Настройки.Свойство("ГруппаСертификаты", ГруппаСертификаты);
	Настройки.Свойство("ПроцентОтПродажыСертификата", ПроцентОтПродажыСертификата);
		
	Если ПроцентПродажыУслуги = Неопределено Тогда
		ВызватьИсключение "Не задан процент от продажы услуги КТС Помощь. Обратитесь на 777.";
		Возврат Неопределено;
	КонецЕсли;
	
	Если ПроцентИсполненияУслуги = Неопределено Тогда
		ВызватьИсключение "Не задан процент от исполнения услуги КТС Помощь. Обратитесь на 777.";
		Возврат Неопределено;
	КонецЕсли;
	
	Если СвойствоПомощьКТС = Неопределено Тогда
		ВызватьИсключение "Не задано свойство КТС Помощь. Обратитесь на 777.";
		Возврат Неопределено;
	КонецЕсли;
			
	Если ПроцентОтПродажыСертификата = Неопределено Тогда
		ВызватьИсключение "Не задан процент от продажы сертификата на дополнительное обслужывание. Обратитесь на 777.";
		Возврат Неопределено;
	КонецЕсли;

	
	Запрос 		 = Новый Запрос;
	Запрос.Текст = ПолучитьТекстЗапросаНаборДанных();
	
	ПериодОтчета = ПолучитьЗначениеПараметра("ПериодОтчета");
	
	Запрос.УстановитьПараметр("ВалютаРегламентированогоУчета", Константы.ВалютаРегламентированногоУчета.Получить());
	Запрос.УстановитьПараметр("ДатаНачало", ПериодОтчета.ДатаНачала);
	Запрос.УстановитьПараметр("ПроцентОтПродажыУслуги", ПроцентПродажыУслуги);
	Запрос.УстановитьПараметр("РозничнаяЦена", Справочники.ВидыЦен.ПолучитьСсылку(Новый УникальныйИдентификатор("8bdf84ff-404c-11e0-9f98-001517115d85")));
	Запрос.УстановитьПараметр("ПроцентОтИсполненияУслуги", ПроцентИсполненияУслуги);
	Запрос.УстановитьПараметр("ПроцентОтПродажыСертификата", ПроцентОтПродажыСертификата);
	Запрос.УстановитьПараметр("БезналЦена", Справочники.ВидыЦен.ПолучитьСсылку(Новый УникальныйИдентификатор("8bdf8500-404c-11e0-9f98-001517115d85")));
	Запрос.УстановитьПараметр("ПодменныйФонд", Справочники.ВидыНоменклатуры.ПолучитьСсылку(Новый УникальныйИдентификатор("70237c29-7f2b-11e2-8fd5-001e673c80fc")));
	Запрос.УстановитьПараметр("ВидНоменклатурыКТСПомощь", Справочники.ВидыНоменклатуры.ПолучитьСсылку(Новый УникальныйИдентификатор("91f45981-0c03-11e2-9d4d-001e673c80fc")));
	Запрос.УстановитьПараметр("ВидНоменклатурыСертификаты", Справочники.ВидыНоменклатуры.ПолучитьСсылку(Новый УникальныйИдентификатор("14f32bf2-1c56-11e2-9d4d-001e673c80fc")));
	Запрос.УстановитьПараметр("ДатаОкончания", ПериодОтчета.ДатаОкончания);
	Запрос.УстановитьПараметр("СвойствоКТСПомощь", СвойствоПомощьКТС);
	
	
	Возврат Запрос.Выполнить().Выгрузить();

КонецФункции // ПолучитьНаборДанных()
 
Функция ПолучитьТекстЗапросаНаборДанных()

	ТекстЗапроса = "
				|ВЫБРАТЬ
				|	Ссылка КАК Номенклатура
				|ПОМЕСТИТЬ КешДопустимаяНоменклатура
				|ИЗ
				|	Справочник.Номенклатура
				|ГДЕ
				|НЕ ЭтоГруппа
				|И НЕ ПометкаУдаления
				|И Родитель В ИЕРАРХИИ
				|			(ВЫБРАТЬ
				|				ktcНастройкиЗароботкаМенеджераГруппы.ГруппыНоменклатуры
				|			ИЗ
				|				РегистрСведений.ktcНастройкиЗароботкаМенеджераГруппы КАК ktcНастройкиЗароботкаМенеджераГруппы)

				|ИНДЕКСИРОВАТЬ ПО
				|	Номенклатура
				|;
				|
				|////////////////////////////////////////////////////////////////////////////////
				|ВЫБРАТЬ
				|	Ссылка КАК Номенклатура
				|ПОМЕСТИТЬ КешСертификаты
				|ИЗ
				|	Справочник.Номенклатура
				|ГДЕ
				|НЕ ЭтоГруппа
				|И НЕ ПометкаУдаления
				|И	ВидНоменклатуры = &ВидНоменклатурыСертификаты

				|ИНДЕКСИРОВАТЬ ПО
				|	Номенклатура
				|;
				|
				|////////////////////////////////////////////////////////////////////////////////
				|ВЫБРАТЬ
				|	Ссылка КАК Номенклатура
				|ПОМЕСТИТЬ КешНоменклатураКТСПомощь
				|ИЗ
				|	Справочник.Номенклатура
				|ГДЕ
				|НЕ ЭтоГруппа
				|И НЕ ПометкаУдаления
				|И	ВидНоменклатуры = &ВидНоменклатурыКТСПомощь
				|
				|ИНДЕКСИРОВАТЬ ПО
				|	Номенклатура
				|;
				|
				|////////////////////////////////////////////////////////////////////////////////
				|ВЫБРАТЬ
				|	ВЫРАЗИТЬ(ДополнительныеСведения.Объект КАК Документ.РеализацияТоваровУслуг) КАК Ссылка,
				|	ВЫРАЗИТЬ(ДополнительныеСведения.Значение КАК Справочник.Пользователи) КАК Значение
				|ПОМЕСТИТЬ КешКТСПомощьРеализации
				|ИЗ
				|	РегистрСведений.ДополнительныеСведения КАК ДополнительныеСведения
				|ГДЕ
				|	ДополнительныеСведения.Свойство = &СвойствоКТСПомощь

				|ИНДЕКСИРОВАТЬ ПО
				|	Ссылка
				|;

				|////////////////////////////////////////////////////////////////////////////////
				|ВЫБРАТЬ
				|	ВложенныйЗапрос.Период			КАК Период,
				|	ВложенныйЗапрос.Номенклатура 	КАК Номенклатура,
				|	ВложенныйЗапрос.Цена			КАК Цена
				|ПОМЕСТИТЬ ТаблицаРозничныхЦен
				|ИЗ
				|(
				|	ВЫБРАТЬ
				|		Период			КАК Период,
				|		Номенклатура 	КАК Номенклатура,
				|		Цена			КАК Цена
				|	ИЗ
				|		РегистрСведений.ЦеныНоменклатуры
				|	ГДЕ
				|		ВидЦены = &РозничнаяЦена
				|		И Период >= &ДатаНачало
				|		И Период < &ДатаОкончания
				|		
				|	ОБЪЕДИНИТЬ

				|	ВЫБРАТЬ
				|		Период			КАК Период,
				|		Номенклатура 	КАК Номенклатура,
				|		Цена			КАК Цена
				|	ИЗ
				|		РегистрСведений.ЦеныНоменклатуры.СрезПоследних(&ДатаНачало, ВидЦены = &РозничнаяЦена)
				|) КАК ВложенныйЗапрос
				|;

				|////////////////////////////////////////////////////////////////////////////////
				|ВЫБРАТЬ
				|  ТаблицаРозничныхЦен.Цена													КАК Цена,
				|  ТаблицаРозничныхЦен.Номенклатура											КАК Номенклатура,
				|  ТаблицаРозничныхЦен.Период 												КАК НачалоПериода,
				|  МИНИМУМ(ЕСТЬNULL(ТаблицаРозничныхЦенКопия.Период, ДАТАВРЕМЯ(3999, 1, 1))) КАК КонецПериода
				|ПОМЕСТИТЬ ТаблицаРозничныхЦенНаростающие
				|ИЗ
				|  ТаблицаРозничныхЦен КАК ТаблицаРозничныхЦен
				|	ЛЕВОЕ СОЕДИНЕНИЕ ТаблицаРозничныхЦен КАК ТаблицаРозничныхЦенКопия
				|	ПО ТаблицаРозничныхЦенКопия.Период		> ТаблицаРозничныхЦен.Период
				|	И ТаблицаРозничныхЦенКопия.Номенклатура = ТаблицаРозничныхЦен.Номенклатура
				|СГРУППИРОВАТЬ ПО
				|  ТаблицаРозничныхЦен.Период,
				|  ТаблицаРозничныхЦен.Цена,
				|  ТаблицаРозничныхЦен.Номенклатура
				|;

				|////////////////////////////////////////////////////////////////////////////////
				|ВЫБРАТЬ
				|	РеализацияТоваровУслугТовары.Ссылка.Дата КАК Период,
				|	РеализацияТоваровУслугТовары.Ссылка КАК Ссылка,
				|	РеализацияТоваровУслугТовары.Номенклатура КАК Номенклатура,
				|	РеализацияТоваровУслугТовары.Характеристика КАК Характеристика,
				|	ВЫБОР
				|		КОГДА РеализацияТоваровУслугТовары.Ссылка.Дата > ДАТАВРЕМЯ(2013, 11, 12, 0, 0, 0) И РеализацияТоваровУслугТовары.ВидЦены = &БезналЦена
				|			ТОГДА &РозничнаяЦена
				|		ИНАЧЕ РеализацияТоваровУслугТовары.ВидЦены
				|	КОНЕЦ КАК ВидЦены,
				|	РеализацияТоваровУслугТовары.Количество КАК Количество,
				|	РеализацияТоваровУслугТовары.Сумма КАК Сумма,
				|	ВЫБОР
				|		КОГДА РеализацияТоваровУслугТовары.Ссылка.Дата > ДАТАВРЕМЯ(2013, 11, 12, 0, 0, 0) И РеализацияТоваровУслугТовары.ВидЦены = &БезналЦена
				|			ТОГДА ИСТИНА
				|		ИНАЧЕ ЛОЖЬ
				|	КОНЕЦ КАК ПересчитатьСумму
				|ПОМЕСТИТЬ КешТоварыРеализацийПредварительная
				|ИЗ
				|	Документ.РеализацияТоваровУслуг.Товары КАК РеализацияТоваровУслугТовары
				|ГДЕ
				|	РеализацияТоваровУслугТовары.Ссылка.Проведен
				|	И РеализацияТоваровУслугТовары.Ссылка.Дата >= &ДатаНачало
				|	И РеализацияТоваровУслугТовары.Ссылка.Дата < &ДатаОкончания

				|ИНДЕКСИРОВАТЬ ПО
				|	Номенклатура,
				|	Характеристика
				|;

				|////////////////////////////////////////////////////////////////////////////////
				|ВЫБРАТЬ
				|	ТоварыРеализаций.Ссылка КАК Ссылка,
				|	ТоварыРеализаций.Номенклатура КАК Номенклатура,
				|	ТоварыРеализаций.Характеристика КАК Характеристика,
				|	ТоварыРеализаций.ВидЦены КАК ВидЦены,
				|	ТоварыРеализаций.Количество КАК Количество,
				|	ВЫБОР
				|		КОГДА ТоварыРеализаций.ПересчитатьСумму	
				|			ТОГДА ТоварыРеализаций.Количество * РозничныеЦены.Цена
				|		ИНАЧЕ ТоварыРеализаций.Сумма 
				|	КОНЕЦ КАК Сумма
				|ПОМЕСТИТЬ КешТоварыРеализаций
				|ИЗ
				|	КешТоварыРеализацийПредварительная КАК ТоварыРеализаций
				|		ЛЕВОЕ СОЕДИНЕНИЕ ТаблицаРозничныхЦенНаростающие КАК РозничныеЦены
				|		ПО ТоварыРеализаций.Номенклатура = РозничныеЦены.Номенклатура
				|			И ТоварыРеализаций.Период >= РозничныеЦены.НачалоПериода
				|			И ТоварыРеализаций.Период < РозничныеЦены.КонецПериода
				|;

				|////////////////////////////////////////////////////////////////////////////////
				|ВЫБРАТЬ
				|	ВозвратТоваровОтКлиентаТовары.Ссылка КАК Ссылка,
				|	ВозвратТоваровОтКлиентаТовары.Номенклатура КАК Номенклатура,
				|	ВозвратТоваровОтКлиентаТовары.Характеристика КАК Характеристика,
				|	-ВозвратТоваровОтКлиентаТовары.Количество КАК Количество,
				|	-ВозвратТоваровОтКлиентаТовары.Сумма КАК Сумма
				|ПОМЕСТИТЬ КешТоварыВозвратовПредварительные
				|ИЗ
				|	Документ.ВозвратТоваровОтКлиента.Товары КАК ВозвратТоваровОтКлиентаТовары
				|ГДЕ
				|	ВозвратТоваровОтКлиентаТовары.Ссылка.Проведен
				|	И ВозвратТоваровОтКлиентаТовары.Ссылка.Дата >= &ДатаНачало
				|	И ВозвратТоваровОтКлиентаТовары.Ссылка.Дата < &ДатаОкончания

				|ИНДЕКСИРОВАТЬ ПО
				|	Ссылка,
				|	Номенклатура,
				|	Характеристика
				|;

				|////////////////////////////////////////////////////////////////////////////////
				|ВЫБРАТЬ
				|	РасчетыСКлиентамиОстатки.ЗаказКлиента КАК ЗаказКлиента,
				|	РасчетыСКлиентамиОстатки.СуммаОстаток КАК СуммаОстаток
				|ПОМЕСТИТЬ КешРасчетыСКлиентами
				|ИЗ
				|	РегистрНакопления.РасчетыСКлиентами.Остатки КАК РасчетыСКлиентамиОстатки

				|ИНДЕКСИРОВАТЬ ПО
				|	ЗаказКлиента
				|;

				|////////////////////////////////////////////////////////////////////////////////
				|ВЫБРАТЬ
				|	РеализацияТоваровУслуг.Дата КАК Дата,
				|	РеализацияТоваровУслуг.Ссылка КАК Ссылка,
				|	РеализацияТоваровУслуг.Подразделение КАК Подразделение,
				|	ktcНастройкиЗароботкаМенеджераВидыЦен.ВидыЦен КАК ВидыЦен,
				|	РеализацияТоваровУслуг.Менеджер КАК Менеджер,
				|	ВЫБОР
				|		КОГДА РеализацияТоваровУслуг.СуммаВзаиморасчетов > 0
				|			ТОГДА ЕСТЬNULL(РасчетыСКлиентами.СуммаОстаток, 0)
				|		ИНАЧЕ 0
				|	КОНЕЦ КАК СуммаДолга,
				|	РеализацияТоваровУслуг.Валюта КАК Валюта
				|ПОМЕСТИТЬ КешДокументыПродажы
				|ИЗ
				|	Документ.РеализацияТоваровУслуг КАК РеализацияТоваровУслуг
				|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.ktcНастройкиЗароботкаМенеджераВидыЦен КАК ktcНастройкиЗароботкаМенеджераВидыЦен
				|		ПО РеализацияТоваровУслуг.Подразделение = ktcНастройкиЗароботкаМенеджераВидыЦен.Подразделение
				|		ЛЕВОЕ СОЕДИНЕНИЕ КешРасчетыСКлиентами КАК РасчетыСКлиентами
				|		ПО (ВЫБОР
				|				КОГДА РеализацияТоваровУслуг.ЗаказКлиента = ЗНАЧЕНИЕ(Документ.ЗаказКлиента.ПустаяСсылка)
				|					ТОГДА РеализацияТоваровУслуг.Ссылка
				|				ИНАЧЕ РеализацияТоваровУслуг.ЗаказКлиента
				|			КОНЕЦ = РасчетыСКлиентами.ЗаказКлиента)
				|ГДЕ
				|	РеализацияТоваровУслуг.Проведен
				|	И РеализацияТоваровУслуг.Дата >= &ДатаНачало
				|	И РеализацияТоваровУслуг.Дата <= &ДатаОкончания

				|ИНДЕКСИРОВАТЬ ПО
				|	Ссылка
				|;

				|////////////////////////////////////////////////////////////////////////////////
				|ВЫБРАТЬ
				|	ВЫБОР
				|		КОГДА ВозвратТоваровОтКлиента.ДокументРеализации В (ЗНАЧЕНИЕ(Документ.РеализацияТоваровУслуг.ПустаяСсылка), ЗНАЧЕНИЕ(Документ.ОтчетОРозничныхПродажах.ПустаяСсылка))
				|			ТОГДА ВозвратТоваровОтКлиента.Дата
				|		ИНАЧЕ ВозвратТоваровОтКлиента.ДокументРеализации.Дата
				|	КОНЕЦ КАК Дата,
				|	ВозвратТоваровОтКлиента.Ссылка КАК Ссылка,
				|	ВозвратТоваровОтКлиента.Подразделение КАК Подразделение,
				|	ktcНастройкиЗароботкаМенеджераВидыЦен.ВидыЦен КАК ВидыЦен,
				|	ВЫБОР
				|		КОГДА ВозвратТоваровОтКлиента.ДокументРеализации ССЫЛКА Документ.РеализацияТоваровУслуг
				|			ТОГДА ВозвратТоваровОтКлиента.ДокументРеализации.Менеджер
				|		КОГДА ВозвратТоваровОтКлиента.ДокументРеализации ССЫЛКА Документ.ОтчетОРозничныхПродажах
				|			ТОГДА ВозвратТоваровОтКлиента.ДокументРеализации.Ответственный
				|		ИНАЧЕ ВозвратТоваровОтКлиента.Менеджер
				|	КОНЕЦ КАК Менеджер,
				|	0 КАК СуммаДолга,
				|	ВозвратТоваровОтКлиента.Валюта КАК Валюта
				|ПОМЕСТИТЬ КешДокументыВозвраты
				|ИЗ
				|	Документ.ВозвратТоваровОтКлиента КАК ВозвратТоваровОтКлиента
				|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.ktcНастройкиЗароботкаМенеджераВидыЦен КАК ktcНастройкиЗароботкаМенеджераВидыЦен
				|		ПО ВозвратТоваровОтКлиента.Подразделение = ktcНастройкиЗароботкаМенеджераВидыЦен.Подразделение
				|ГДЕ
				|	ВозвратТоваровОтКлиента.Проведен
				|	И ВозвратТоваровОтКлиента.Дата >= &ДатаНачало
				|	И ВозвратТоваровОтКлиента.Дата <= &ДатаОкончания

				|ИНДЕКСИРОВАТЬ ПО
				|	Ссылка
				|;

				|////////////////////////////////////////////////////////////////////////////////
				|ВЫБРАТЬ
				|	ВЫРАЗИТЬ(КешДокументыВозвраты.Ссылка.ДокументРеализации КАК Документ.РеализацияТоваровУслуг) КАК ДокументРеализации
				|ПОМЕСТИТЬ КешРеализацииПоВозвратуПромежуточные
				|ИЗ
				|	КешДокументыВозвраты КАК КешДокументыВозвраты
				|ГДЕ
				|	(ВЫРАЗИТЬ(КешДокументыВозвраты.Ссылка.ДокументРеализации КАК Документ.РеализацияТоваровУслуг)) <> ЗНАЧЕНИЕ(Документ.РеализацияТоваровУслуг.ПустаяСсылка)
				|;

				|////////////////////////////////////////////////////////////////////////////////
				|ВЫБРАТЬ
				|	РеализацияТоваровУслугТовары.Ссылка.Дата КАК Период,
				|	РеализацияТоваровУслугТовары.Ссылка КАК Ссылка,
				|	РеализацияТоваровУслугТовары.Номенклатура КАК Номенклатура,
				|	РеализацияТоваровУслугТовары.Характеристика КАК Характеристика,
				|	ВЫБОР
				|		КОГДА РеализацияТоваровУслугТовары.Ссылка.Дата > ДАТАВРЕМЯ(2013, 11, 12, 0, 0, 0) И РеализацияТоваровУслугТовары.ВидЦены = &БезналЦена
				|			ТОГДА &РозничнаяЦена
				|		ИНАЧЕ РеализацияТоваровУслугТовары.ВидЦены
				|	КОНЕЦ КАК ВидЦены,
				|	ВЫБОР
				|		КОГДА РеализацияТоваровУслугТовары.Ссылка.Дата > ДАТАВРЕМЯ(2013, 11, 12, 0, 0, 0) И РеализацияТоваровУслугТовары.ВидЦены = &БезналЦена
				|			ТОГДА ИСТИНА
				|		ИНАЧЕ ЛОЖЬ
				|	КОНЕЦ КАК ПересчитатьСумму
				|ПОМЕСТИТЬ КешРеализацииПоВозвратуПредварительные
				|ИЗ
				|	Документ.РеализацияТоваровУслуг.Товары КАК РеализацияТоваровУслугТовары
				|ГДЕ
				|	РеализацияТоваровУслугТовары.Ссылка В
				|			(ВЫБРАТЬ
				|				КешРеализацииПоВозвратуПромежуточные.ДокументРеализации
				|			ИЗ
				|				КешРеализацииПоВозвратуПромежуточные)

				|ИНДЕКСИРОВАТЬ ПО
				|	Номенклатура,
				|	Характеристика
				|;

				|////////////////////////////////////////////////////////////////////////////////
				|ВЫБРАТЬ
				|	КешРеализации.Ссылка КАК Ссылка,
				|	КешРеализации.Номенклатура КАК Номенклатура,
				|	КешРеализации.Характеристика КАК Характеристика,
				|	КешРеализации.ВидЦены КАК ВидЦены,
				|	ТаблицаЦен.Цена КАК РозничнаяЦена,
				|	КешРеализации.ПересчитатьСумму КАК ПересчитатьСумму
				|ПОМЕСТИТЬ КешРеализацииПоВозврату
				|ИЗ
				|	КешРеализацииПоВозвратуПредварительные КАК КешРеализации
				|		ЛЕВОЕ СОЕДИНЕНИЕ ТаблицаРозничныхЦенНаростающие КАК ТаблицаЦен
				|		ПО КешРеализации.Номенклатура = ТаблицаЦен.Номенклатура
				|			И КешРеализации.Период >= ТаблицаЦен.НачалоПериода
				|			И КешРеализации.Период < ТаблицаЦен.КонецПериода
				|;

				|////////////////////////////////////////////////////////////////////////////////
				|УНИЧТОЖИТЬ КешРеализацииПоВозвратуПромежуточные
				|;

				|////////////////////////////////////////////////////////////////////////////////
				|ВЫБРАТЬ
				|	ТоварыВозвратов.Ссылка КАК Ссылка,
				|	ТоварыВозвратов.Номенклатура КАК Номенклатура,
				|	ТоварыВозвратов.Характеристика КАК Характеристика,
				|	ТоварыВозвратов.Количество КАК Количество,
				|	ВЫБОР
				|		КОГДА РеализацииПоВозврату.ПересчитатьСумму
				|			ТОГДА ТоварыВозвратов.Количество * РеализацииПоВозврату.РозничнаяЦена
				|		ИНАЧЕ ТоварыВозвратов.Сумма
				|	КОНЕЦ КАК Сумма,
				|	ЕСТЬNULL(РеализацииПоВозврату.ВидЦены, ЗНАЧЕНИЕ(Справочник.ВидыЦен.ПустаяСсылка)) КАК ВидЦены
				|ПОМЕСТИТЬ КешТоварыВозвратов
				|ИЗ
				|	КешТоварыВозвратовПредварительные КАК ТоварыВозвратов
				|		ЛЕВОЕ СОЕДИНЕНИЕ КешРеализацииПоВозврату КАК РеализацииПоВозврату
				|		ПО ТоварыВозвратов.Ссылка.ДокументРеализации = РеализацииПоВозврату.Ссылка
				|			И ТоварыВозвратов.Номенклатура = РеализацииПоВозврату.Номенклатура
				|			И ТоварыВозвратов.Характеристика = РеализацииПоВозврату.Характеристика
				|;

				|////////////////////////////////////////////////////////////////////////////////
				|УНИЧТОЖИТЬ КешТоварыВозвратовПредварительные
				|;

				|////////////////////////////////////////////////////////////////////////////////
				|ВЫБРАТЬ
				|	КешДокументы.Дата КАК Дата,
				|	КешДокументы.Ссылка КАК Ссылка,
				|	КешДокументы.Подразделение КАК Подразделение,
				|	КешДокументы.Менеджер КАК Менеджер,
				|	РТиУ.Номенклатура КАК Номенклатура,
				|	РТиУ.Характеристика КАК Характеристика,
				|	РТиУ.Количество КАК Количество,
				|	ВЫБОР
				|		КОГДА РТиУ.ВидЦены = &РозничнаяЦена
				|			ТОГДА РТиУ.Сумма
				|		КОГДА РТиУ.ВидЦены = &БезналЦена
				|			ТОГДА РТиУ.Сумма
				|		ИНАЧЕ 0
				|	КОНЕЦ КАК Сумма,
				|	0 КАК ПроцентНаценки,
				|	КешДокументы.СуммаДолга КАК СуммаДолга
				|ПОМЕСТИТЬ КешПродажыСертификатов
				|ИЗ
				|	КешДокументыПродажы КАК КешДокументы
				|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ КешТоварыРеализаций КАК РТиУ
				|		ПО КешДокументы.Ссылка = РТиУ.Ссылка
				|			И (РТиУ.Номенклатура В
				|				(ВЫБРАТЬ
				|					КешСертификаты.Номенклатура
				|				ИЗ
				|					КешСертификаты))

				|ИНДЕКСИРОВАТЬ ПО
				|	Ссылка,
				|	Номенклатура,
				|	Характеристика
				|;

				|////////////////////////////////////////////////////////////////////////////////
				|ВЫБРАТЬ
				|	КешДокументы.Дата КАК Дата,
				|	КешДокументы.Ссылка КАК Ссылка,
				|	КешДокументы.Подразделение КАК Подразделение,
				|	КешДокументы.Менеджер КАК Менеджер,
				|	ВТоК.Номенклатура КАК Номенклатура,
				|	ВТоК.Характеристика КАК Характеристика,
				|	ВТоК.Количество КАК Количество,
				|	ВТоК.Сумма КАК Сумма,
				|	0 КАК ПроцентНаценки,
				|	КешДокументы.СуммаДолга КАК СуммаДолга
				|ПОМЕСТИТЬ КешВозвратыСертификатов
				|ИЗ
				|	КешДокументыВозвраты КАК КешДокументы
				|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ КешТоварыВозвратов КАК ВТоК
				|		ПО КешДокументы.Ссылка = ВТоК.Ссылка
				|			И (ВТоК.Номенклатура В
				|				(ВЫБРАТЬ
				|					КешСертификаты.Номенклатура
				|				ИЗ
				|					КешСертификаты))

				|ИНДЕКСИРОВАТЬ ПО
				|	Ссылка,
				|	Номенклатура,
				|	Характеристика
				|;

				|////////////////////////////////////////////////////////////////////////////////
				|УНИЧТОЖИТЬ КешСертификаты
				|;

				|////////////////////////////////////////////////////////////////////////////////
				|ВЫБРАТЬ
				|	ТоварыРеализаций.Ссылка.Дата КАК Дата,
				|	ТоварыРеализаций.Ссылка КАК Ссылка,
				|	ТоварыРеализаций.Ссылка.Подразделение КАК Подразделение,
				|	ДополнительныеСведения.Значение КАК Менеджер,
				|	ТоварыРеализаций.Номенклатура КАК Номенклатура,
				|	ТоварыРеализаций.Характеристика КАК Характеристика,
				|	0 КАК Количество,
				|	0 КАК Сумма,
				|	ВЫБОР
				|		КОГДА ТоварыРеализаций.ВидЦены = &РозничнаяЦена
				|			ТОГДА ТоварыРеализаций.Сумма
				|		КОГДА ТоварыРеализаций.ВидЦены = &БезналЦена
				|			ТОГДА ТоварыРеализаций.Сумма
				|		ИНАЧЕ 0
				|	КОНЕЦ КАК СуммаПродажы,
				|	0 КАК ПроцентНаценки,
				|	ЕСТЬNULL(РасчетыСКлиентами.СуммаОстаток, 0) КАК СуммаДолга
				|ПОМЕСТИТЬ КешИсполнениеУслуги
				|ИЗ
				|	КешТоварыРеализаций КАК ТоварыРеализаций
				|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ КешКТСПомощьРеализации КАК ДополнительныеСведения
				|		ПО ТоварыРеализаций.Ссылка = ДополнительныеСведения.Ссылка
				|			И (ТоварыРеализаций.Номенклатура В
				|				(ВЫБРАТЬ
				|					КешНоменклатураКТСПомощь.Номенклатура
				|				ИЗ
				|					КешНоменклатураКТСПомощь))
				|		ЛЕВОЕ СОЕДИНЕНИЕ КешРасчетыСКлиентами КАК РасчетыСКлиентами
				|		ПО (ВЫБОР
				|				КОГДА ТоварыРеализаций.Ссылка.ЗаказКлиента = ЗНАЧЕНИЕ(Документ.ЗаказКлиента.ПустаяСсылка)
				|					ТОГДА ТоварыРеализаций.Ссылка
				|				ИНАЧЕ ТоварыРеализаций.Ссылка.ЗаказКлиента
				|			КОНЕЦ = РасчетыСКлиентами.ЗаказКлиента)

				|ИНДЕКСИРОВАТЬ ПО
				|	Ссылка,
				|	Номенклатура,
				|	Характеристика
				|;

				|////////////////////////////////////////////////////////////////////////////////
				|УНИЧТОЖИТЬ КешНоменклатураКТСПомощь
				|;

				|////////////////////////////////////////////////////////////////////////////////
				|ВЫБРАТЬ
				|	КешДокументы.Дата КАК Дата,
				|	КешДокументы.Ссылка КАК Ссылка,
				|	КешДокументы.Подразделение КАК Подразделение,
				|	КешДокументы.ВидыЦен КАК ВидыЦен,
				|	КешДокументы.Менеджер КАК Менеджер,
				|	КешДокументы.СуммаДолга КАК СуммаДолга,
				|	КешДокументы.Валюта КАК Валюта,
				|	ТоварыРеализаций.Номенклатура КАК Номенклатура,
				|	ТоварыРеализаций.Характеристика КАК Характеристика,
				|	ТоварыРеализаций.Количество КАК Количество,
				|	ВЫБОР
				|		КОГДА ТоварыРеализаций.ВидЦены = &РозничнаяЦена
				|			ТОГДА ТоварыРеализаций.Сумма
				|		КОГДА ТоварыРеализаций.ВидЦены = &БезналЦена
				|			ТОГДА ТоварыРеализаций.Сумма
				|		ИНАЧЕ 0
				|	КОНЕЦ КАК Сумма,
				|	ТоварыРеализаций.ВидЦены КАК ВидЦеныВДокументе
				|ПОМЕСТИТЬ КешДокументыРеализацийСНоменклатурой
				|ИЗ
				|	КешДокументыПродажы КАК КешДокументы
				|		ЛЕВОЕ СОЕДИНЕНИЕ КешТоварыРеализаций КАК ТоварыРеализаций
				|		ПО КешДокументы.Ссылка = ТоварыРеализаций.Ссылка
				|			И (ТоварыРеализаций.Номенклатура В
				|				(ВЫБРАТЬ
				|					КешДопустимаяНоменклатура.Номенклатура
				|				ИЗ
				|					КешДопустимаяНоменклатура))

				|ИНДЕКСИРОВАТЬ ПО
				|	Номенклатура,
				|	ВидыЦен,
				|	Характеристика
				|;

				|////////////////////////////////////////////////////////////////////////////////
				|УНИЧТОЖИТЬ КешДокументыПродажы
				|;

				|////////////////////////////////////////////////////////////////////////////////
				|//УНИЧТОЖИТЬ КешТоварыРеализаций
				|//;

				|////////////////////////////////////////////////////////////////////////////////
				|ВЫБРАТЬ
				|	КешДокументы.Дата КАК Дата,
				|	КешДокументы.Ссылка КАК Ссылка,
				|	КешДокументы.Подразделение КАК Подразделение,
				|	КешДокументы.ВидыЦен КАК ВидыЦен,
				|	КешДокументы.Менеджер КАК Менеджер,
				|	КешДокументы.СуммаДолга КАК СуммаДолга,
				|	КешДокументы.Валюта КАК Валюта,
				|	ТоварыВозвратов.Номенклатура КАК Номенклатура,
				|	ТоварыВозвратов.Характеристика КАК Характеристика,
				|	ТоварыВозвратов.Количество КАК Количество,
				|	ВЫБОР
				|		КОГДА ТоварыВозвратов.ВидЦены = &РозничнаяЦена
				|			ТОГДА ТоварыВозвратов.Сумма
				|		КОГДА ТоварыВозвратов.ВидЦены = &БезналЦена
				|			ТОГДА ТоварыВозвратов.Сумма
				|		ИНАЧЕ 0
				|	КОНЕЦ КАК Сумма,
				|	ТоварыВозвратов.ВидЦены КАК ВидЦеныВДокументе
				|ПОМЕСТИТЬ КешДокументыВозвратовСНоменклатурой
				|ИЗ
				|	КешДокументыВозвраты КАК КешДокументы
				|		ЛЕВОЕ СОЕДИНЕНИЕ КешТоварыВозвратов КАК ТоварыВозвратов
				|		ПО КешДокументы.Ссылка = ТоварыВозвратов.Ссылка
				|			И (ТоварыВозвратов.Номенклатура В
				|				(ВЫБРАТЬ
				|					КешДопустимаяНоменклатура.Номенклатура
				|				ИЗ
				|					КешДопустимаяНоменклатура))

				|ИНДЕКСИРОВАТЬ ПО
				|	Номенклатура,
				|	ВидыЦен,
				|	Характеристика
				|;

				|////////////////////////////////////////////////////////////////////////////////
				|УНИЧТОЖИТЬ КешДокументыВозвраты
				|;

				|////////////////////////////////////////////////////////////////////////////////
				|//УНИЧТОЖИТЬ КешТоварыВозвратов
				|//;

				|////////////////////////////////////////////////////////////////////////////////
				|УНИЧТОЖИТЬ КешДопустимаяНоменклатура
				|;

				|////////////////////////////////////////////////////////////////////////////////
				|ВЫБРАТЬ
				|	КурсыВалют.Курс / КурсыВалют.Кратность КАК Курс,
				|	КурсыВалют.Валюта КАК Валюта,
				|	КурсыВалют.Период КАК Период
				|ПОМЕСТИТЬ КурсыВалют
				|ИЗ
				|	РегистрСведений.КурсыВалют КАК КурсыВалют
				|;

				|////////////////////////////////////////////////////////////////////////////////
				|ВЫБРАТЬ РАЗРЕШЕННЫЕ
				|	КурсыВалют.Курс КАК Курс,
				|	КурсыВалют.Валюта КАК Валюта,
				|	КурсыВалют.Период КАК НачалоПериода,
				|	МИНИМУМ(ЕСТЬNULL(КурсыВалютКопия.Период, ДАТАВРЕМЯ(3999, 1, 1))) КАК КонецПериода
				|ПОМЕСТИТЬ ТаблицаКурсов
				|ИЗ
				|	КурсыВалют КАК КурсыВалют
				|		ЛЕВОЕ СОЕДИНЕНИЕ КурсыВалют КАК КурсыВалютКопия
				|		ПО (КурсыВалютКопия.Период > КурсыВалют.Период)
				|			И (КурсыВалютКопия.Валюта = КурсыВалют.Валюта)

				|СГРУППИРОВАТЬ ПО
				|	КурсыВалют.Период,
				|	КурсыВалют.Курс,
				|	КурсыВалют.Валюта
				|;

				|////////////////////////////////////////////////////////////////////////////////
				|ВЫБРАТЬ
				|	ДокументыСНоменклатурой.Дата КАК Дата,
				|	ДокументыСНоменклатурой.Ссылка КАК Ссылка,
				|	ДокументыСНоменклатурой.Подразделение КАК Подразделение,
				|	ДокументыСНоменклатурой.ВидыЦен КАК ВидыЦен,
				|	ДокументыСНоменклатурой.Менеджер КАК Менеджер,
				|	ДокументыСНоменклатурой.СуммаДолга КАК СуммаДолга,
				|	ДокументыСНоменклатурой.Номенклатура КАК Номенклатура,
				|	ДокументыСНоменклатурой.Характеристика КАК Характеристика,
				|	ДокументыСНоменклатурой.Количество КАК Количество,
				|	ДокументыСНоменклатурой.Сумма КАК Сумма,
				|	ДокументыСНоменклатурой.ВидЦеныВДокументе КАК ВидЦеныВДокументе,
				|	ДокументыСНоменклатурой.ВидыЦен.ВалютаЦены КАК ВалютаЦены,
				|	МАКСИМУМ(ЦеныНоменклатуры.Период) КАК ПериодЦены,
				|	ДокументыСНоменклатурой.Валюта КАК Валюта
				|ПОМЕСТИТЬ КешПериодыРеализаций
				|ИЗ
				|	КешДокументыРеализацийСНоменклатурой КАК ДокументыСНоменклатурой
				|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ЦеныНоменклатуры КАК ЦеныНоменклатуры
				|		ПО ДокументыСНоменклатурой.Номенклатура = ЦеныНоменклатуры.Номенклатура
				|			И ДокументыСНоменклатурой.ВидыЦен = ЦеныНоменклатуры.ВидЦены
				|			И ДокументыСНоменклатурой.Характеристика = ЦеныНоменклатуры.Характеристика
				|			И ДокументыСНоменклатурой.Дата >= ЦеныНоменклатуры.Период

				|СГРУППИРОВАТЬ ПО
				|	ДокументыСНоменклатурой.Дата,
				|	ДокументыСНоменклатурой.Ссылка,
				|	ДокументыСНоменклатурой.Подразделение,
				|	ДокументыСНоменклатурой.ВидыЦен,
				|	ДокументыСНоменклатурой.Менеджер,
				|	ДокументыСНоменклатурой.СуммаДолга,
				|	ДокументыСНоменклатурой.Номенклатура,
				|	ДокументыСНоменклатурой.Характеристика,
				|	ДокументыСНоменклатурой.Количество,
				|	ДокументыСНоменклатурой.Сумма,
				|	ДокументыСНоменклатурой.ВидЦеныВДокументе,
				|	ДокументыСНоменклатурой.Валюта,
				|	ДокументыСНоменклатурой.ВидыЦен.ВалютаЦены
				|;

				|////////////////////////////////////////////////////////////////////////////////
				|ВЫБРАТЬ
				|	ДокументыСНоменклатурой.Дата КАК Дата,
				|	ДокументыСНоменклатурой.Ссылка КАК Ссылка,
				|	ДокументыСНоменклатурой.Подразделение КАК Подразделение,
				|	ДокументыСНоменклатурой.ВидыЦен КАК ВидыЦен,
				|	ДокументыСНоменклатурой.Менеджер КАК Менеджер,
				|	ДокументыСНоменклатурой.СуммаДолга КАК СуммаДолга,
				|	ДокументыСНоменклатурой.Номенклатура КАК Номенклатура,
				|	ДокументыСНоменклатурой.Характеристика КАК Характеристика,
				|	ДокументыСНоменклатурой.Количество КАК Количество,
				|	ДокументыСНоменклатурой.Сумма КАК Сумма,
				|	ДокументыСНоменклатурой.ВидЦеныВДокументе КАК ВидЦеныВДокументе,
				|	ДокументыСНоменклатурой.ВидыЦен.ВалютаЦены КАК ВалютаЦены,
				|	МАКСИМУМ(ЦеныНоменклатуры.Период) КАК ПериодЦены,
				|	ДокументыСНоменклатурой.Валюта КАК Валюта
				|ПОМЕСТИТЬ КешПериодыВозвратов
				|ИЗ
				|	КешДокументыВозвратовСНоменклатурой КАК ДокументыСНоменклатурой
				|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ЦеныНоменклатуры КАК ЦеныНоменклатуры
				|		ПО ДокументыСНоменклатурой.Номенклатура = ЦеныНоменклатуры.Номенклатура
				|			И ДокументыСНоменклатурой.ВидыЦен = ЦеныНоменклатуры.ВидЦены
				|			И ДокументыСНоменклатурой.Характеристика = ЦеныНоменклатуры.Характеристика
				|			И ДокументыСНоменклатурой.Дата >= ЦеныНоменклатуры.Период

				|СГРУППИРОВАТЬ ПО
				|	ДокументыСНоменклатурой.Дата,
				|	ДокументыСНоменклатурой.Ссылка,
				|	ДокументыСНоменклатурой.Подразделение,
				|	ДокументыСНоменклатурой.ВидыЦен,
				|	ДокументыСНоменклатурой.Менеджер,
				|	ДокументыСНоменклатурой.СуммаДолга,
				|	ДокументыСНоменклатурой.Номенклатура,
				|	ДокументыСНоменклатурой.Характеристика,
				|	ДокументыСНоменклатурой.Количество,
				|	ДокументыСНоменклатурой.Сумма,
				|	ДокументыСНоменклатурой.ВидЦеныВДокументе,
				|	ДокументыСНоменклатурой.Валюта,
				|	ДокументыСНоменклатурой.ВидыЦен.ВалютаЦены
				|;

				|////////////////////////////////////////////////////////////////////////////////
				|ВЫБРАТЬ
				|	КешПериоды.Дата,
				|	КешПериоды.Ссылка,
				|	КешПериоды.Подразделение,
				|	КешПериоды.ВидыЦен,
				|	КешПериоды.Менеджер,
				|	КешПериоды.СуммаДолга,
				|	КешПериоды.Номенклатура,
				|	КешПериоды.Характеристика,
				|	КешПериоды.Количество,
				|	ВЫБОР
				|		КОГДА КурсыВалютДокумента.Валюта <> КурсыВалютРег.Валюта
				|			ТОГДА КешПериоды.Сумма * (КурсыВалютДокумента.Курс / КурсыВалютРег.Курс)
				|		ИНАЧЕ КешПериоды.Сумма
				|	КОНЕЦ КАК Сумма,
				|	КешПериоды.ВидЦеныВДокументе,
				|	ВЫБОР
				|		КОГДА ЕСТЬNULL(ЦеныНоменклатуры.Цена, 0) = 0
				|				ИЛИ ЕСТЬNULL(КешПериоды.Количество, 0) = 0
				|				ИЛИ ЕСТЬNULL(КешПериоды.Сумма, 0) = 0
				|			ТОГДА 0
				|		ИНАЧЕ (ВЫБОР
				|				КОГДА КурсыВалютДокумента.Валюта <> КурсыВалютРег.Валюта
				|					ТОГДА КешПериоды.Сумма * (КурсыВалютДокумента.Курс / КурсыВалютРег.Курс)
				|				ИНАЧЕ КешПериоды.Сумма
				|			КОНЕЦ / КешПериоды.Количество / ВЫБОР
				|				КОГДА КурсыВалютЦен.Валюта <> КурсыВалютРег.Валюта
				|					ТОГДА ЦеныНоменклатуры.Цена * (КурсыВалютЦен.Курс / КурсыВалютРег.Курс)
				|				ИНАЧЕ ЦеныНоменклатуры.Цена
				|			КОНЕЦ - 1) * 100
				|	КОНЕЦ КАК ПроцентНаценки,
				|	МАКСИМУМ(ktcПроцентыМенеджера.НижняяГраница) КАК НижняяГраница
				|ПОМЕСТИТЬ КешПроцентНаценкиПродаж
				|ИЗ
				|	КешПериодыРеализаций КАК КешПериоды
				|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ЦеныНоменклатуры КАК ЦеныНоменклатуры
				|		ПО КешПериоды.Номенклатура = ЦеныНоменклатуры.Номенклатура
				|			И КешПериоды.ВидыЦен = ЦеныНоменклатуры.ВидЦены
				|			И КешПериоды.Характеристика = ЦеныНоменклатуры.Характеристика
				|			И КешПериоды.ПериодЦены = ЦеныНоменклатуры.Период
				|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ТаблицаКурсов КАК КурсыВалютЦен
				|		ПО КешПериоды.ВалютаЦены = КурсыВалютЦен.Валюта
				|			И КешПериоды.Дата >= КурсыВалютЦен.НачалоПериода
				|			И КешПериоды.Дата < КурсыВалютЦен.КонецПериода
				|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ТаблицаКурсов КАК КурсыВалютДокумента
				|		ПО КешПериоды.Валюта = КурсыВалютДокумента.Валюта
				|			И КешПериоды.Дата >= КурсыВалютДокумента.НачалоПериода
				|			И КешПериоды.Дата < КурсыВалютДокумента.КонецПериода
				|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ТаблицаКурсов КАК КурсыВалютРег
				|		ПО (КурсыВалютРег.Валюта = &ВалютаРегламентированогоУчета)
				|			И КешПериоды.Дата >= КурсыВалютРег.НачалоПериода
				|			И КешПериоды.Дата < КурсыВалютРег.КонецПериода
				|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ktcПроцентыМенеджера КАК ktcПроцентыМенеджера
				|		ПО (ВЫБОР
				|				КОГДА ЕСТЬNULL(ЦеныНоменклатуры.Цена, 0) = 0
				|						ИЛИ ЕСТЬNULL(КешПериоды.Количество, 0) = 0
				|						ИЛИ ЕСТЬNULL(КешПериоды.Сумма, 0) = 0
				|					ТОГДА 0
				|				ИНАЧЕ (ВЫБОР
				|						КОГДА КурсыВалютДокумента.Валюта <> КурсыВалютРег.Валюта
				|							ТОГДА КешПериоды.Сумма * (КурсыВалютДокумента.Курс / КурсыВалютРег.Курс)
				|						ИНАЧЕ КешПериоды.Сумма
				|					КОНЕЦ / КешПериоды.Количество / ВЫБОР
				|						КОГДА КурсыВалютЦен.Валюта <> КурсыВалютРег.Валюта
				|							ТОГДА ЦеныНоменклатуры.Цена * (КурсыВалютЦен.Курс / КурсыВалютРег.Курс)
				|						ИНАЧЕ ЦеныНоменклатуры.Цена
				|					КОНЕЦ - 1) * 100
				|			КОНЕЦ > ktcПроцентыМенеджера.НижняяГраница)

				|СГРУППИРОВАТЬ ПО
				|	КешПериоды.Дата,
				|	КешПериоды.Ссылка,
				|	КешПериоды.Подразделение,
				|	КешПериоды.ВидыЦен,
				|	КешПериоды.Менеджер,
				|	КешПериоды.СуммаДолга,
				|	КешПериоды.Номенклатура,
				|	КешПериоды.Характеристика,
				|	КешПериоды.Количество,
				|	КешПериоды.ВидЦеныВДокументе,
				|	ВЫБОР
				|		КОГДА КурсыВалютДокумента.Валюта <> КурсыВалютРег.Валюта
				|			ТОГДА КешПериоды.Сумма * (КурсыВалютДокумента.Курс / КурсыВалютРег.Курс)
				|		ИНАЧЕ КешПериоды.Сумма
				|	КОНЕЦ,
				|	ВЫБОР
				|		КОГДА ЕСТЬNULL(ЦеныНоменклатуры.Цена, 0) = 0
				|				ИЛИ ЕСТЬNULL(КешПериоды.Количество, 0) = 0
				|				ИЛИ ЕСТЬNULL(КешПериоды.Сумма, 0) = 0
				|			ТОГДА 0
				|		ИНАЧЕ (ВЫБОР
				|				КОГДА КурсыВалютДокумента.Валюта <> КурсыВалютРег.Валюта
				|					ТОГДА КешПериоды.Сумма * (КурсыВалютДокумента.Курс / КурсыВалютРег.Курс)
				|				ИНАЧЕ КешПериоды.Сумма
				|			КОНЕЦ / КешПериоды.Количество / ВЫБОР
				|				КОГДА КурсыВалютЦен.Валюта <> КурсыВалютРег.Валюта
				|					ТОГДА ЦеныНоменклатуры.Цена * (КурсыВалютЦен.Курс / КурсыВалютРег.Курс)
				|				ИНАЧЕ ЦеныНоменклатуры.Цена
				|			КОНЕЦ - 1) * 100
				|	КОНЕЦ
				|;

				|////////////////////////////////////////////////////////////////////////////////
				|ВЫБРАТЬ
				|	КешПериоды.Дата,
				|	КешПериоды.Ссылка,
				|	КешПериоды.Подразделение,
				|	КешПериоды.ВидыЦен,
				|	КешПериоды.Менеджер,
				|	КешПериоды.СуммаДолга,
				|	КешПериоды.Номенклатура,
				|	КешПериоды.Характеристика,
				|	КешПериоды.Количество,
				|	ВЫБОР
				|		КОГДА КурсыВалютДокумента.Валюта <> КурсыВалютРег.Валюта
				|			ТОГДА КешПериоды.Сумма * (КурсыВалютДокумента.Курс / КурсыВалютРег.Курс)
				|		ИНАЧЕ КешПериоды.Сумма
				|	КОНЕЦ КАК Сумма,
				|	КешПериоды.ВидЦеныВДокументе,
				|	ВЫБОР
				|		КОГДА ЕСТЬNULL(ЦеныНоменклатуры.Цена, 0) = 0
				|				ИЛИ ЕСТЬNULL(КешПериоды.Количество, 0) = 0
				|				ИЛИ ЕСТЬNULL(КешПериоды.Сумма, 0) = 0
				|			ТОГДА 0
				|		ИНАЧЕ (ВЫБОР
				|				КОГДА КурсыВалютДокумента.Валюта <> КурсыВалютРег.Валюта
				|					ТОГДА КешПериоды.Сумма * (КурсыВалютДокумента.Курс / КурсыВалютРег.Курс)
				|				ИНАЧЕ КешПериоды.Сумма
				|			КОНЕЦ / КешПериоды.Количество / ВЫБОР
				|				КОГДА КурсыВалютЦен.Валюта <> КурсыВалютРег.Валюта
				|					ТОГДА ЦеныНоменклатуры.Цена * (КурсыВалютЦен.Курс / КурсыВалютРег.Курс)
				|				ИНАЧЕ ЦеныНоменклатуры.Цена
				|			КОНЕЦ - 1) * 100
				|	КОНЕЦ КАК ПроцентНаценки,
				|	МАКСИМУМ(ktcПроцентыМенеджера.НижняяГраница) КАК НижняяГраница
				|ПОМЕСТИТЬ КешПроцентНаценкиВозвратов
				|ИЗ
				|	КешПериодыВозвратов КАК КешПериоды
				|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ЦеныНоменклатуры КАК ЦеныНоменклатуры
				|		ПО КешПериоды.Номенклатура = ЦеныНоменклатуры.Номенклатура
				|			И КешПериоды.ВидыЦен = ЦеныНоменклатуры.ВидЦены
				|			И КешПериоды.Характеристика = ЦеныНоменклатуры.Характеристика
				|			И КешПериоды.ПериодЦены = ЦеныНоменклатуры.Период
				|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ТаблицаКурсов КАК КурсыВалютЦен
				|		ПО КешПериоды.ВалютаЦены = КурсыВалютЦен.Валюта
				|			И КешПериоды.Дата >= КурсыВалютЦен.НачалоПериода
				|			И КешПериоды.Дата < КурсыВалютЦен.КонецПериода
				|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ТаблицаКурсов КАК КурсыВалютДокумента
				|		ПО КешПериоды.Валюта = КурсыВалютДокумента.Валюта
				|			И КешПериоды.Дата >= КурсыВалютДокумента.НачалоПериода
				|			И КешПериоды.Дата < КурсыВалютДокумента.КонецПериода
				|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ТаблицаКурсов КАК КурсыВалютРег
				|		ПО (КурсыВалютРег.Валюта = &ВалютаРегламентированогоУчета)
				|			И КешПериоды.Дата >= КурсыВалютРег.НачалоПериода
				|			И КешПериоды.Дата < КурсыВалютРег.КонецПериода
				|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ktcПроцентыМенеджера КАК ktcПроцентыМенеджера
				|		ПО (ВЫБОР
				|				КОГДА ЕСТЬNULL(ЦеныНоменклатуры.Цена, 0) = 0
				|						ИЛИ ЕСТЬNULL(КешПериоды.Количество, 0) = 0
				|						ИЛИ ЕСТЬNULL(КешПериоды.Сумма, 0) = 0
				|					ТОГДА 0
				|				ИНАЧЕ (ВЫБОР
				|						КОГДА КурсыВалютДокумента.Валюта <> КурсыВалютРег.Валюта
				|							ТОГДА КешПериоды.Сумма * (КурсыВалютДокумента.Курс / КурсыВалютРег.Курс)
				|						ИНАЧЕ КешПериоды.Сумма
				|					КОНЕЦ / КешПериоды.Количество / ВЫБОР
				|						КОГДА КурсыВалютЦен.Валюта <> КурсыВалютРег.Валюта
				|							ТОГДА ЦеныНоменклатуры.Цена * (КурсыВалютЦен.Курс / КурсыВалютРег.Курс)
				|						ИНАЧЕ ЦеныНоменклатуры.Цена
				|					КОНЕЦ - 1) * 100
				|			КОНЕЦ > ktcПроцентыМенеджера.НижняяГраница)

				|СГРУППИРОВАТЬ ПО
				|	КешПериоды.Дата,
				|	КешПериоды.Ссылка,
				|	КешПериоды.Подразделение,
				|	КешПериоды.ВидыЦен,
				|	КешПериоды.Менеджер,
				|	КешПериоды.СуммаДолга,
				|	КешПериоды.Номенклатура,
				|	КешПериоды.Характеристика,
				|	КешПериоды.Количество,
				|	КешПериоды.ВидЦеныВДокументе,
				|	ВЫБОР
				|		КОГДА КурсыВалютДокумента.Валюта <> КурсыВалютРег.Валюта
				|			ТОГДА КешПериоды.Сумма * (КурсыВалютДокумента.Курс / КурсыВалютРег.Курс)
				|		ИНАЧЕ КешПериоды.Сумма
				|	КОНЕЦ,
				|	ВЫБОР
				|		КОГДА ЕСТЬNULL(ЦеныНоменклатуры.Цена, 0) = 0
				|				ИЛИ ЕСТЬNULL(КешПериоды.Количество, 0) = 0
				|				ИЛИ ЕСТЬNULL(КешПериоды.Сумма, 0) = 0
				|			ТОГДА 0
				|		ИНАЧЕ (ВЫБОР
				|				КОГДА КурсыВалютДокумента.Валюта <> КурсыВалютРег.Валюта
				|					ТОГДА КешПериоды.Сумма * (КурсыВалютДокумента.Курс / КурсыВалютРег.Курс)
				|				ИНАЧЕ КешПериоды.Сумма
				|			КОНЕЦ / КешПериоды.Количество / ВЫБОР
				|				КОГДА КурсыВалютЦен.Валюта <> КурсыВалютРег.Валюта
				|					ТОГДА ЦеныНоменклатуры.Цена * (КурсыВалютЦен.Курс / КурсыВалютРег.Курс)
				|				ИНАЧЕ ЦеныНоменклатуры.Цена
				|			КОНЕЦ - 1) * 100
				|	КОНЕЦ
				|;

				|////////////////////////////////////////////////////////////////////////////////
				|ВЫБРАТЬ
				|	ЗаработокМенеджераМножительПоМесяцам.НачалоПериода КАК ДатаСравнения,
				|	ЗаработокМенеджераМножительПоМесяцам.Коэффициент КАК Коэффициент
				|ПОМЕСТИТЬ КешКоэффициентов
				|ИЗ
				|	РегистрСведений.ЗаработокМенеджераМножительПоМесяцам КАК ЗаработокМенеджераМножительПоМесяцам
				|ГДЕ
				|	ЗаработокМенеджераМножительПоМесяцам.Период >= НАЧАЛОПЕРИОДА(&ДатаНачало, МЕСЯЦ)
				|	И ЗаработокМенеджераМножительПоМесяцам.Период <= &ДатаОкончания
				|;

				|////////////////////////////////////////////////////////////////////////////////
				|ВЫБРАТЬ
				|	КешПроцентНаценки.Дата,
				|	КешПроцентНаценки.Ссылка,
				|	КешПроцентНаценки.Подразделение,
				|	КешПроцентНаценки.Менеджер,
				|	КешПроцентНаценки.Номенклатура,
				|	КешПроцентНаценки.Характеристика,
				|	КешПроцентНаценки.Количество,
				|	КешПроцентНаценки.Сумма,
				|	КешПроцентНаценки.ПроцентНаценки,
				|	КешКоэффициентов.Коэффициент * ВЫБОР
				|		КОГДА КешПроцентНаценки.СуммаДолга <= 0
				|			ТОГДА ВЫБОР
				|					КОГДА КешПроцентНаценки.Номенклатура.ВидНоменклатуры = &ПодменныйФонд
				|						ТОГДА 0
				|					КОГДА КешПроцентНаценки.Номенклатура.ВидНоменклатуры = &ВидНоменклатурыКТСПомощь
				|						ТОГДА ВЫБОР
				|								КОГДА ЕСТЬNULL(КТСПомощь.Номенклатура, 0) = 0
				|									ТОГДА КешПроцентНаценки.Сумма * &ПроцентОтПродажыУслуги * 0.01
				|								ИНАЧЕ КешПроцентНаценки.Сумма * КТСПомощь.ПроцентПродажы * 0.01
				|							КОНЕЦ
				|					ИНАЧЕ ВЫБОР
				|							КОГДА ЕСТЬNULL(БонусыМенеджерам.БонусОборот, 0) = 0
				|								ТОГДА КешПроцентНаценки.Сумма / 100 * ЕСТЬNULL(ktcПроцентыМенеджера.ЗначениеПорога, 0)
				|							ИНАЧЕ ЕСТЬNULL(БонусыМенеджерам.БонусОборот, 0)
				|						КОНЕЦ
				|				КОНЕЦ
				|		ИНАЧЕ 0
				|	КОНЕЦ КАК Заработок,
				|	КешКоэффициентов.Коэффициент * ВЫБОР
				|		КОГДА КешПроцентНаценки.СуммаДолга > 0
				|			ТОГДА ВЫБОР
				|					КОГДА КешПроцентНаценки.Номенклатура.ВидНоменклатуры = &ПодменныйФонд
				|						ТОГДА 0
				|					КОГДА КешПроцентНаценки.Номенклатура.ВидНоменклатуры = &ВидНоменклатурыКТСПомощь
				|						ТОГДА ВЫБОР
				|								КОГДА ЕСТЬNULL(КТСПомощь.Номенклатура, 0) = 0
				|									ТОГДА КешПроцентНаценки.Сумма * &ПроцентОтПродажыУслуги * 0.01
				|								ИНАЧЕ КешПроцентНаценки.Сумма * КТСПомощь.ПроцентПродажы * 0.01
				|							КОНЕЦ
				|					ИНАЧЕ ВЫБОР
				|							КОГДА ЕСТЬNULL(БонусыМенеджерам.БонусОборот, 0) = 0
				|								ТОГДА КешПроцентНаценки.Сумма / 100 * ЕСТЬNULL(ktcПроцентыМенеджера.ЗначениеПорога, 0)
				|							ИНАЧЕ ЕСТЬNULL(БонусыМенеджерам.БонусОборот, 0)
				|						КОНЕЦ
				|				КОНЕЦ
				|		ИНАЧЕ 0
				|	КОНЕЦ КАК ВозможныйЗароботок
				|ИЗ
				|	КешПроцентНаценкиПродаж КАК КешПроцентНаценки
				|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.БонусыМенеджерамНачисленые.Обороты(&ДатаНачало, &ДатаОкончания, Регистратор, ) КАК БонусыМенеджерам
				|		ПО КешПроцентНаценки.Ссылка = БонусыМенеджерам.Регистратор
				|			И КешПроцентНаценки.Номенклатура = БонусыМенеджерам.Номенклатура
				|			И КешПроцентНаценки.Характеристика = БонусыМенеджерам.Характеристика
				|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ktcПроцентыМенеджера КАК ktcПроцентыМенеджера
				|		ПО КешПроцентНаценки.НижняяГраница = ktcПроцентыМенеджера.НижняяГраница
				|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.КТСПомощь КАК КТСПомощь
				|		ПО КешПроцентНаценки.Номенклатура = КТСПомощь.Номенклатура
				|		ЛЕВОЕ СОЕДИНЕНИЕ КешКоэффициентов КАК КешКоэффициентов
				|		ПО (НАЧАЛОПЕРИОДА(КешПроцентНаценки.Дата, МЕСЯЦ) = КешКоэффициентов.ДатаСравнения)

				|ОБЪЕДИНИТЬ ВСЕ

				|ВЫБРАТЬ
				|	КешПроцентНаценки.Дата,
				|	КешПроцентНаценки.Ссылка,
				|	КешПроцентНаценки.Подразделение,
				|	КешПроцентНаценки.Менеджер,
				|	КешПроцентНаценки.Номенклатура,
				|	КешПроцентНаценки.Характеристика,
				|	КешПроцентНаценки.Количество,
				|	КешПроцентНаценки.Сумма,
				|	КешПроцентНаценки.ПроцентНаценки,
				|	КешКоэффициентов.Коэффициент * ВЫБОР
				|		КОГДА КешПроцентНаценки.СуммаДолга <= 0
				|			ТОГДА ВЫБОР
				|					КОГДА КешПроцентНаценки.Номенклатура.ВидНоменклатуры = &ПодменныйФонд
				|						ТОГДА 0
				|					КОГДА КешПроцентНаценки.Номенклатура.ВидНоменклатуры = &ВидНоменклатурыКТСПомощь
				|						ТОГДА ВЫБОР
				|								КОГДА ЕСТЬNULL(КТСПомощь.Номенклатура, 0) = 0
				|									ТОГДА КешПроцентНаценки.Сумма * &ПроцентОтПродажыУслуги * 0.01
				|								ИНАЧЕ КешПроцентНаценки.Сумма * КТСПомощь.ПроцентПродажы * 0.01
				|							КОНЕЦ
				|					ИНАЧЕ ВЫБОР
				|							КОГДА ЕСТЬNULL(БонусыМенеджерам.БонусОборот, 0) = 0
				|								ТОГДА КешПроцентНаценки.Сумма / 100 * ЕСТЬNULL(ktcПроцентыМенеджера.ЗначениеПорога, 0)
				|							ИНАЧЕ ЕСТЬNULL(БонусыМенеджерам.БонусОборот, 0)
				|						КОНЕЦ
				|				КОНЕЦ
				|		ИНАЧЕ 0
				|	КОНЕЦ,
				|	КешКоэффициентов.Коэффициент * ВЫБОР
				|		КОГДА КешПроцентНаценки.СуммаДолга > 0
				|			ТОГДА ВЫБОР
				|					КОГДА КешПроцентНаценки.Номенклатура.ВидНоменклатуры = &ПодменныйФонд
				|						ТОГДА 0
				|					КОГДА КешПроцентНаценки.Номенклатура.ВидНоменклатуры = &ВидНоменклатурыКТСПомощь
				|						ТОГДА ВЫБОР
				|								КОГДА ЕСТЬNULL(КТСПомощь.Номенклатура, 0) = 0
				|									ТОГДА КешПроцентНаценки.Сумма * &ПроцентОтПродажыУслуги * 0.01
				|								ИНАЧЕ КешПроцентНаценки.Сумма * КТСПомощь.ПроцентПродажы * 0.01
				|							КОНЕЦ
				|					ИНАЧЕ ВЫБОР
				|							КОГДА ЕСТЬNULL(БонусыМенеджерам.БонусОборот, 0) = 0
				|								ТОГДА КешПроцентНаценки.Сумма / 100 * ЕСТЬNULL(ktcПроцентыМенеджера.ЗначениеПорога, 0)
				|							ИНАЧЕ ЕСТЬNULL(БонусыМенеджерам.БонусОборот, 0)
				|						КОНЕЦ
				|				КОНЕЦ
				|		ИНАЧЕ 0
				|	КОНЕЦ
				|ИЗ
				|	КешПроцентНаценкиВозвратов КАК КешПроцентНаценки
				|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.БонусыМенеджерамНачисленые.Обороты(&ДатаНачало, &ДатаОкончания, Регистратор, ) КАК БонусыМенеджерам
				|		ПО КешПроцентНаценки.Ссылка = БонусыМенеджерам.Регистратор
				|			И КешПроцентНаценки.Номенклатура = БонусыМенеджерам.Номенклатура
				|			И КешПроцентНаценки.Характеристика = БонусыМенеджерам.Характеристика
				|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ktcПроцентыМенеджера КАК ktcПроцентыМенеджера
				|		ПО КешПроцентНаценки.НижняяГраница = ktcПроцентыМенеджера.НижняяГраница
				|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.КТСПомощь КАК КТСПомощь
				|		ПО КешПроцентНаценки.Номенклатура = КТСПомощь.Номенклатура
				|		ЛЕВОЕ СОЕДИНЕНИЕ КешКоэффициентов КАК КешКоэффициентов
				|		ПО (НАЧАЛОПЕРИОДА(КешПроцентНаценки.Дата, МЕСЯЦ) = КешКоэффициентов.ДатаСравнения)

				|ОБЪЕДИНИТЬ ВСЕ

				|ВЫБРАТЬ
				|	КешИсполнениеУслуги.Дата,
				|	КешИсполнениеУслуги.Ссылка,
				|	КешИсполнениеУслуги.Подразделение,
				|	КешИсполнениеУслуги.Менеджер,
				|	КешИсполнениеУслуги.Номенклатура,
				|	КешИсполнениеУслуги.Характеристика,
				|	КешИсполнениеУслуги.Количество,
				|	КешИсполнениеУслуги.Сумма,
				|	КешИсполнениеУслуги.ПроцентНаценки,
				|	КешКоэффициентов.Коэффициент * ВЫБОР
				|		КОГДА КешИсполнениеУслуги.СуммаДолга <= 0
				|			ТОГДА ВЫБОР
				|					КОГДА ЕСТЬNULL(КТСПомощь.Номенклатура, 0) = 0
				|						ТОГДА КешИсполнениеУслуги.СуммаПродажы * &ПроцентОтИсполненияУслуги * 0.01
				|					ИНАЧЕ КешИсполнениеУслуги.СуммаПродажы * КТСПомощь.ПроцентИсполнения * 0.01
				|				КОНЕЦ
				|		ИНАЧЕ 0
				|	КОНЕЦ,
				|	КешКоэффициентов.Коэффициент * ВЫБОР
				|		КОГДА КешИсполнениеУслуги.СуммаДолга > 0
				|			ТОГДА ВЫБОР
				|					КОГДА ЕСТЬNULL(КТСПомощь.Номенклатура, 0) = 0
				|						ТОГДА КешИсполнениеУслуги.СуммаПродажы * &ПроцентОтИсполненияУслуги * 0.01
				|					ИНАЧЕ КешИсполнениеУслуги.СуммаПродажы * КТСПомощь.ПроцентИсполнения * 0.01
				|				КОНЕЦ
				|		ИНАЧЕ 0
				|	КОНЕЦ
				|ИЗ
				|	КешИсполнениеУслуги КАК КешИсполнениеУслуги
				|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.КТСПомощь КАК КТСПомощь
				|		ПО КешИсполнениеУслуги.Номенклатура = КТСПомощь.Номенклатура
				|		ЛЕВОЕ СОЕДИНЕНИЕ КешКоэффициентов КАК КешКоэффициентов
				|		ПО (НАЧАЛОПЕРИОДА(КешИсполнениеУслуги.Дата, МЕСЯЦ) = КешКоэффициентов.ДатаСравнения)

				|ОБЪЕДИНИТЬ ВСЕ

				|ВЫБРАТЬ
				|	ПродажыСертификатов.Дата,
				|	ПродажыСертификатов.Ссылка,
				|	ПродажыСертификатов.Подразделение,
				|	ПродажыСертификатов.Менеджер,
				|	ПродажыСертификатов.Номенклатура,
				|	ПродажыСертификатов.Характеристика,
				|	ПродажыСертификатов.Количество,
				|	ПродажыСертификатов.Сумма,
				|	ПродажыСертификатов.ПроцентНаценки,
				|	КешКоэффициентов.Коэффициент * ВЫБОР
				|		КОГДА ПродажыСертификатов.СуммаДолга <= 0
				|			ТОГДА ПродажыСертификатов.Сумма * &ПроцентОтПродажыСертификата * 0.01
				|		ИНАЧЕ 0
				|	КОНЕЦ,
				|	КешКоэффициентов.Коэффициент * ВЫБОР
				|		КОГДА ПродажыСертификатов.СуммаДолга > 0
				|			ТОГДА ПродажыСертификатов.Сумма * &ПроцентОтПродажыСертификата * 0.01
				|		ИНАЧЕ 0
				|	КОНЕЦ
				|ИЗ
				|	КешПродажыСертификатов КАК ПродажыСертификатов
				|		ЛЕВОЕ СОЕДИНЕНИЕ КешКоэффициентов КАК КешКоэффициентов
				|		ПО (НАЧАЛОПЕРИОДА(ПродажыСертификатов.Дата, МЕСЯЦ) = КешКоэффициентов.ДатаСравнения)

				|ОБЪЕДИНИТЬ ВСЕ

				|ВЫБРАТЬ
				|	КешВозвратыСертификатов.Дата,
				|	КешВозвратыСертификатов.Ссылка,
				|	КешВозвратыСертификатов.Подразделение,
				|	КешВозвратыСертификатов.Менеджер,
				|	КешВозвратыСертификатов.Номенклатура,
				|	КешВозвратыСертификатов.Характеристика,
				|	КешВозвратыСертификатов.Количество,
				|	КешВозвратыСертификатов.Сумма,
				|	КешВозвратыСертификатов.ПроцентНаценки,
				|	КешКоэффициентов.Коэффициент * ВЫБОР
				|		КОГДА КешВозвратыСертификатов.СуммаДолга >= 0
				|			ТОГДА КешВозвратыСертификатов.Сумма * &ПроцентОтПродажыСертификата * 0.01
				|		ИНАЧЕ 0
				|	КОНЕЦ,
				|	КешКоэффициентов.Коэффициент * ВЫБОР
				|		КОГДА КешВозвратыСертификатов.СуммаДолга < 0
				|			ТОГДА КешВозвратыСертификатов.Сумма * &ПроцентОтПродажыСертификата * 0.01
				|		ИНАЧЕ 0
				|	КОНЕЦ
				|ИЗ
				|	КешВозвратыСертификатов КАК КешВозвратыСертификатов
				|		ЛЕВОЕ СОЕДИНЕНИЕ КешКоэффициентов КАК КешКоэффициентов
				|		ПО (НАЧАЛОПЕРИОДА(КешВозвратыСертификатов.Дата, МЕСЯЦ) = КешКоэффициентов.ДатаСравнения)";
				
	Возврат ТекстЗапроса;

КонецФункции // ПолучитьТекстЗапросаНаборДанных()
 
#КонецОбласти



// Сведения о внешнем отчете

Функция СведенияОВнешнейОбработке() Экспорт
	
	Версия = "2.1.024";
	
	// Объявим переменную, в которой мы сохраним и вернем "наружу" необходимые данные
    ПараметрыРегистрации = Новый Структура;

    // Объявим еще одну переменную, которая нам потребуется ниже
    МассивНазначений = Новый Массив;
    
    // Первый параметр, который мы должны указать - это какой вид обработки системе должна зарегистрировать. 
    // Допустимые типы: ДополнительнаяОбработка, ДополнительныйОтчет, ЗаполнениеОбъекта, Отчет, ПечатнаяФорма, СозданиеСвязанныхОбъектов
    ПараметрыРегистрации.Вставить("Вид", "ДополнительныйОтчет");

    // Теперь нам необходимо передать в виде массива имен, к чему будет подключена наша ВПФ
    // Имейте ввиду, что можно задать имя в таком виде: Документ.* - в этом случае обработка будет подключена ко всем документам в системе, 
    // которые поддерживают механизм ВПФ
	//СчитатьДокументыНазначений(МассивНазначений);
	
	
	ПараметрыРегистрации.Вставить("Назначение", Новый Массив);
    
    // Теперь зададим имя, под которым ВПФ будет зарегистрирована в справочнике внешних обработок
    ПараметрыРегистрации.Вставить("Наименование", "Отчет по продажам (розница) ["+Версия+"]");
    
    // Зададим право обработке на использование безопасного режима. Более подробно можно узнать в справке к платформе (метод УстановитьБезопасныйРежим)
    ПараметрыРегистрации.Вставить("БезопасныйРежим", Ложь);

    // Следующие два параметра играют больше информационную роль, т.е. это то, что будет видеть пользователь в информации к обработке
    ПараметрыРегистрации.Вставить("Версия", Версия);    
    ПараметрыРегистрации.Вставить("Информация", "Отчет по продажам (розница) ["+Версия+"]");
    
    // Создадим таблицу команд (подробнее смотрим ниже)
    ТаблицаКоманд = ПолучитьТаблицуКоманд();
    
    // Добавим команду в таблицу
    ДобавитьКоманду(ТаблицаКоманд, "Отчет по продажам (розница) ["+Версия+"]", "ОДП", "ОткрытиеФормы", Ложь, "ОДП");
    
    // Сохраним таблицу команд в параметры регистрации обработки
    ПараметрыРегистрации.Вставить("Команды", ТаблицаКоманд);
    
    // Теперь вернем системе наши параметры
    Возврат ПараметрыРегистрации;
КонецФункции

Процедура СчитатьДокументыНазначений(МассивНазначений)
	
	//Макет = ПолучитьМакет("МакетДокументыНазначений");
	//
	//Для Инд = 1 По Макет.ВысотаТаблицы Цикл
	//	МассивНазначений.Добавить(Макет.Область(Инд,1).Текст);
	//КонецЦикла;
	
КонецПроцедуры

Функция ПолучитьТаблицуКоманд()

   // Создадим пустую таблицу команд и колонки в ней
   Команды = Новый ТаблицаЗначений;

   // Как будет выглядеть описание печатной формы для пользователя
   Команды.Колонки.Добавить("Представление", Новый ОписаниеТипов("Строка")); 

   // Имя нашего макета, что бы могли отличить вызванную команду в обработке печати
   Команды.Колонки.Добавить("Идентификатор", Новый ОписаниеТипов("Строка"));

   // Тут задается, как должна вызваться команда обработки
   // Возможные варианты:
   // - ОткрытиеФормы - в этом случае в колонке идентификатор должно быть указано имя формы, которое должна будет открыть система
   // - ВызовКлиентскогоМетода - вызвать клиентскую экспортную процедуру из модуля формы обработки
   // - ВызовСерверногоМетода - вызвать серверную экспортную процедуру из модуля объекта обработки
   Команды.Колонки.Добавить("Использование", Новый ОписаниеТипов("Строка"));

   // Следующий параметр указывает, необходимо ли показывать оповещение при начале и завершению работы обработки. Не имеет смысла при открытии формы
   Команды.Колонки.Добавить("ПоказыватьОповещение", Новый ОписаниеТипов("Булево"));

   // Для печатной формы должен содержать строку ПечатьMXL 
   Команды.Колонки.Добавить("Модификатор", Новый ОписаниеТипов("Строка"));
   
   Возврат Команды;
   
КонецФункции

Процедура ДобавитьКоманду(ТаблицаКоманд, Представление, Идентификатор, Использование, ПоказыватьОповещение = Ложь, Модификатор = "")
  // Добавляем команду в таблицу команд по переданному описанию.
  // Параметры и их значения можно посмотреть в функции ПолучитьТаблицуКоманд
  НоваяКоманда = ТаблицаКоманд.Добавить();
  НоваяКоманда.Представление = Представление;
  НоваяКоманда.Идентификатор = Идентификатор;
  НоваяКоманда.Использование = Использование;
  НоваяКоманда.ПоказыватьОповещение = ПоказыватьОповещение;
  НоваяКоманда.Модификатор = Модификатор;

КонецПроцедуры

