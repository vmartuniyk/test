
#Область ПрограммныйИнтерфейс

Процедура ПриКомпоновкеРезультата(ДокументРезультат, ДанныеРасшифровки, СтандартнаяОбработка)
	
	УстановитьПривилегированныйРежим(Истина);
	
	СтандартнаяОбработка 	  = Ложь;	
	ИерархияВидовНоменклатуры = РазвернутьИерархиюВидовНоменклатуры();
	НаборДанных				  = СформироватьНаборДанных();
	
	ВывестиОтчетВТабличныйДокумент(ДокументРезультат, ДанныеРасшифровки, НаборДанных);
	
КонецПроцедуры

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

#Область ИерархияВидовНоменклатуры

Функция РазвернутьИерархиюВидовНоменклатуры()

	ИерархияВидовНоменклатуры = ИнициализироватьРазвернутуюТаблицуВидоНоменклатуры();
	
	Запрос 			= Новый Запрос;
	Запрос.Текст    = ТекстЗапросаИерархияВидовНоменклатуры();
	
	ДеревоРезультатов	= Запрос.Выполнить().Выгрузить(ОбходРезультатаЗапроса.ПоГруппировкамСИерархией);
	Родители 			= Новый ФиксированныйМассив(Новый Массив);
		
	РекурсивноОбойтиИерархиюВидовНоменклатуры(ДеревоРезультатов, ИерархияВидовНоменклатуры, Родители);
	
	Возврат ИерархияВидовНоменклатуры;

КонецФункции

Процедура РекурсивноОбойтиИерархиюВидовНоменклатуры(ДеревоРезультатов, ИерархияВидовНоменклатуры, Родители)

	РодителиТекущейВетки = Новый Массив(Родители);
	
	Для каждого СтрокаДерева Из ДеревоРезультатов.Строки Цикл
	
		Если СтрокаДерева.ЭтоГруппа Тогда
			РодителиТекущейВетки.Добавить(СтрокаДерева.ВидНоменклатуры);
			РекурсивноОбойтиИерархиюВидовНоменклатуры(СтрокаДерева, ИерархияВидовНоменклатуры, Новый ФиксированныйМассив(РодителиТекущейВетки));
			РодителиТекущейВетки.Удалить(РодителиТекущейВетки.ВГраница());
		Иначе
			Индекс = 1;
			Для каждого Родитель Из РодителиТекущейВетки Цикл
				НоваяСтрока 				= ИерархияВидовНоменклатуры.Добавить();
				НоваяСтрока.ВидНоменклатуры = СтрокаДерева.ВидНоменклатуры;
				НоваяСтрока.Родитель 		= Родитель;
				НоваяСтрока.Индекс 			= Индекс;
				Индекс						= Индекс + 1;
			КонецЦикла;			
		КонецЕсли;
	
	КонецЦикла; 
	
КонецПроцедуры
 
Функция ТекстЗапросаИерархияВидовНоменклатуры()

	ТекстЗапроса = "
			|ВЫБРАТЬ
			|	Ссылка 		КАК ВидНоменклатуры,
			|	ЭтоГруппа   КАК ЭтоГруппа
			|ИЗ
			|	Справочник.ВидыНоменклатуры
			|ГДЕ
			|	НЕ ПометкаУдаления
			|ИТОГИ ПО
			|	Ссылка ИЕРАРХИЯ";
	
	Возврат ТекстЗапроса;

КонецФункции // ТекстЗапросаИерархияВидовНоменклатуры()
  
Функция ИнициализироватьРазвернутуюТаблицуВидоНоменклатуры()

	Таблица = Новый ТаблицаЗначений;
	Таблица.Колонки.Добавить("ВидНоменклатуры", Новый ОписаниеТипов("СправочникСсылка.ВидыНоменклатуры"));
	Таблица.Колонки.Добавить("Родитель", Новый ОписаниеТипов("СправочникСсылка.ВидыНоменклатуры"));
	Таблица.Колонки.Добавить("Индекс", Новый ОписаниеТипов("Число",,, Новый КвалификаторыЧисла(10, 0)));
	
	Возврат Таблица;

КонецФункции // ИнициализироватьРазвернутуюТаблицуВидоНоменклатуры()

#КонецОбласти 

#Область ГенерированиеНабораДанных

Функция СформироватьНаборДанных()

	ВнешниеНаборыДанных = Новый Структура;
	ВнешниеНаборыДанных.Вставить("ОтчетПоПрадажам", ПолучитьТаблицуПродаж());
	
	Возврат ВнешниеНаборыДанных;

КонецФункции // СформироватьНаборДанных()

Функция ПолучитьТаблицуПродаж()

	Перем ПроцентПродажыУслуги;
	Перем ПроцентИсполненияУслуги;
	Перем СвойствоПомощьКТС;
	Перем ГруппаСертификаты;
	Перем ПроцентОтПродажыСертификата;
	Перем ВидНоменклатурыСертификаты;
	
	Настройки = ХранилищеНастроекДанныхФорм.Загрузить("ДополнительныеНастройкиПроцентовКТСПомощь", , , "ДополнительныеНастройкиПроцентовКТСПомощь");
	
	Если ТипЗнч(Настройки) <> Тип("Структура") Тогда
		ВызватьИсключение НСтр("ru='Не удалось получить настройки «КТС Помощь». Обратитесь в службу технической поддрежки.'", ОбщегоНазначенияКлиентСервер.КодОсновногоЯзыка());
		Возврат Неопределено;
	КонецЕсли;
	
	Настройки.Свойство("ПроцентПродажыУслуги", ПроцентПродажыУслуги);
	Настройки.Свойство("ПроцентИсполненияУслуги", ПроцентИсполненияУслуги);
	Настройки.Свойство("СвойствоПомощьКТС", СвойствоПомощьКТС);
	Настройки.Свойство("ГруппаСертификаты", ГруппаСертификаты);
	Настройки.Свойство("ПроцентОтПродажыСертификата", ПроцентОтПродажыСертификата);
	Настройки.Свойство("ВидНоменклатурыСертификаты", ВидНоменклатурыСертификаты);
		
	Если ПроцентПродажыУслуги = Неопределено Тогда
		ВызватьИсключение НСтр("ru='Не задан процент от продажы услуги «КТС Помощь». Обратитесь в службу технической поддрежки.'", ОбщегоНазначенияКлиентСервер.КодОсновногоЯзыка());
		Возврат Неопределено;
	КонецЕсли;
	
	Если ПроцентИсполненияУслуги = Неопределено Тогда
		ВызватьИсключение НСтр("ru='Не задан процент от исполнения услуги «КТС Помощь». Обратитесь в службу технической поддрежки.'", ОбщегоНазначенияКлиентСервер.КодОсновногоЯзыка());
		Возврат Неопределено;
	КонецЕсли;
	
	Если СвойствоПомощьКТС = Неопределено Тогда
		ВызватьИсключение НСтр("ru='Не задано свойство «КТС Помощь». Обратитесь в службу технической поддрежки.'", ОбщегоНазначенияКлиентСервер.КодОсновногоЯзыка());
		Возврат Неопределено;
	КонецЕсли;
			
	Если ПроцентОтПродажыСертификата = Неопределено Тогда
		ВызватьИсключение НСтр("ru='Не задан процент от продажы сертификата на дополнительное обслужывание. Обратитесь в службу технической поддрежки.'", ОбщегоНазначенияКлиентСервер.КодОсновногоЯзыка());
		Возврат Неопределено;
	КонецЕсли;
	
	Если ВидНоменклатурыСертификаты = Неопределено Тогда
		ВызватьИсключение НСтр("ru='Вид номенкмлатуры сертификата на дополнительное обслужывание. Обратитесь в службу технической поддрежки.'", ОбщегоНазначенияКлиентСервер.КодОсновногоЯзыка());
		Возврат Неопределено;
	КонецЕсли;
	
	Запрос 		 = Новый Запрос;
	Запрос.Текст = ТекстЗапросаТаблицаПродаж();
	
	ПериодОтчета = ПолучитьЗначениеПараметра("ПериодОтчета");
	
	Запрос.УстановитьПараметр("ДатаНачало", ПериодОтчета.ДатаНачала);	
	Запрос.УстановитьПараметр("ДатаОкончание", ПериодОтчета.ДатаОкончания);
	Запрос.УстановитьПараметр("ВалютаРегламентированогоУчета", Константы.ВалютаУправленческогоУчета.Получить());
	Запрос.УстановитьПараметр("ВидНоменклатурыСертификаты", ВидНоменклатурыСертификаты);
	Запрос.УстановитьПараметр("РозничнаяЦена", Справочники.ВидыЦен.ПолучитьСсылку(Новый УникальныйИдентификатор("8bdf84ff-404c-11e0-9f98-001517115d85")));
	Запрос.УстановитьПараметр("БезналЦена", Справочники.ВидыЦен.ПолучитьСсылку(Новый УникальныйИдентификатор("8bdf8500-404c-11e0-9f98-001517115d85")));
	
	Возврат Запрос.Выполнить().Выгрузить();

КонецФункции // ПолучитьТаблицупоПродажам()

Функция ТекстЗапросаТаблицаПродаж()

	ТекстЗапроса = "
	
			// ПОДГОТОВКА ТАБЛИЦ КУРСОВ ВАЛЮТ ДЛЯ ИСПОЛЬЗОВАНИЯ
	
			|// Курсы валют.
			|////////////////////////////////////////////////////////////////////////////////
			|ВЫБРАТЬ
			|	ВЫРАЗИТЬ(КурсыВалют.Курс / КурсыВалют.Кратность КАК ЧИСЛО(15, 4)) КАК Курс,
			|	КурсыВалют.Валюта КАК Валюта,
			|	КурсыВалют.Период КАК Период
			|ПОМЕСТИТЬ КурсыВалют
			|ИЗ
			|	РегистрСведений.КурсыВалют КАК КурсыВалют
			|;
			|
			|// Курсы валют.
			|////////////////////////////////////////////////////////////////////////////////
			|ВЫБРАТЬ
			|  	КурсыВалют.Курс,
			|  	КурсыВалют.Валюта,
			|  	КурсыВалют.Период КАК НачалоПериода,
			|  	МИНИМУМ(ЕСТЬNULL(КурсыВалютКопия.Период, ДАТАВРЕМЯ(3999, 1, 1))) КАК КонецПериода
			|ПОМЕСТИТЬ ТаблицаКурсов
			|ИЗ
			|  	КурсыВалют КАК КурсыВалют
			|		
			|		ЛЕВОЕ СОЕДИНЕНИЕ КурсыВалют КАК КурсыВалютКопия
			|		ПО КурсыВалютКопия.Период > КурсыВалют.Период
			|			И КурсыВалютКопия.Валюта = КурсыВалют.Валюта
			|			
			|СГРУППИРОВАТЬ ПО
			|  	КурсыВалют.Период,
			|  	КурсыВалют.Курс,
			|  	КурсыВалют.Валюта
			|
			|ИНДЕКСИРОВАТЬ ПО 
			|	КурсыВалют.Валюта
			|;
			
			
			// ПОДГОТОВКА ДОПОЛНИТЕЛЬНЫХ ТАБЛИЦ ИЗ НОМЕНКЛАТУРОЙ (НОМЕНКЛАТУРА-СЕРТИФИКАТЫ И НОМЕНКЛАТУРА ЗА КОТОРУЮ НАЧИСЛЯЮТ З/П ПРОДАВЦАМ)						
			
			|// Получаем список номенклатура за которую менеджер получает зароботную плату.
			|////////////////////////////////////////////////////////////////////////////////
			|ВЫБРАТЬ
			|	Ссылка КАК Номенклатура
			|ПОМЕСТИТЬ КешДопустимаяНоменклатура
			|ИЗ
			|	Справочник.Номенклатура
			|ГДЕ
			|	НЕ ЭтоГруппа
			|	И НЕ ПометкаУдаления
			|	И Родитель В ИЕРАРХИИ (ВЫБРАТЬ ГруппыНоменклатуры ИЗ РегистрСведений.ktcНастройкиЗароботкаМенеджераГруппы)
			|
			|ИНДЕКСИРОВАТЬ ПО
			|	Номенклатура
			|;
			|
			|// Получаем таблицу номенклатуры сертификатов.
			|////////////////////////////////////////////////////////////////////////////////
			|ВЫБРАТЬ
			|	Ссылка КАК Номенклатура
			|ПОМЕСТИТЬ КешСертификаты
			|ИЗ
			|	Справочник.Номенклатура
			|ГДЕ
			|	НЕ ЭтоГруппа
			|	И НЕ ПометкаУдаления
			|	И ВидНоменклатуры = &ВидНоменклатурыСертификаты
			|
			|ИНДЕКСИРОВАТЬ ПО
			|	Номенклатура
			|;
			
			
			// ПОДГОТАВЛИВАЕМ ТАБЛИЦЫ РЕАЛИЗАЦИЙ И ВОЗВРАТОВ ИЗ НОМЕНКЛАТУРОЙ ДЛЯ ДАЛЬНЕЙШЕЙ ОБРАБОТКИ
			
			|
			|// Отсекаем документы реализации товаров и услуг по дате.
			|////////////////////////////////////////////////////////////////////////////////
			|ВЫБРАТЬ
			|	Период																КАК Дата,
			|	ВЫРАЗИТЬ(Регистратор КАК Документ.РеализацияТоваровИУслуг)			КАК Ссылка,
			|	ВЫРАЗИТЬ(Регистратор КАК Документ.РеализацияТоваровИУслуг).Валюта	КАК Валюта,
			|	Подразделение       												КАК Подразделение,
			|	Менеджер															КАК Менеджер
			|ПОМЕСТИТЬ ТаблицаРеализацийВОтчете
			|ИЗ
			|	РегистрНакопления.ВыручкаИСебестоимостьПродаж.Обороты(&ДатаНачало, &ДатаОкончание, Регистратор)
			|ГДЕ
			|	Регистратор ССЫЛКА Документ.РеализацияТоваровУслуг
			|ИНДЕКСИРОВАТЬ ПО
			|	Регистратор
			|;
			|
			|// Получаем все табличные части документов реализация товаров и услуг, нужно для того
			|// чтобы отсеч товары проданные по безналу и без установленной цены.
			|////////////////////////////////////////////////////////////////////////////////
			|ВЫБРАТЬ
			|	ТаблицаРеализацийВОтчете.Дата										КАК Дата,
			|	ТаблицаРеализацийВОтчете.Ссылка										КАК Ссылка,
			|	ТаблицаРеализацийВОтчете.Валюта										КАК Валюта,
			|	ТоварыРеализаций.Номенклатура										КАК Номенклатура,
			|	ТоварыРеализаций.Характеристика										КАК Характеристика,
			|	ТоварыРеализаций.Склад												КАК Склад,
			|	ТаблицаРеализацийВОтчете.Подразделение								КАК Подразделение,
			|	ТаблицаРеализацийВОтчете.Менеджер									КАК Менеджер,
			|	ТоварыРеализаций.Количество											КАК Количество,
			|	ТоварыРеализаций.СуммаСНДС											КАК Сумма,
			|	ТоварыРеализаций.СуммаАвтоматическойСкидки							КАК СуммаАвтоматическойСкидки,
			|	ТоварыРеализаций.СуммаРучнойСкидки									КАК СуммаРучнойСкидки,
			|	ТоварыРеализаций.ВидЦены											КАК ВидЦены
			|ПОМЕСТИТЬ КешТоварыРеализций
			|ИЗ
			|	ТаблицаРеализацийВОтчете КАК ТаблицаРеализацийВОтчете
			|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.РеализацияТоваровУслуг.Товары КАК ТоварыРеализаций
			|		ПО ТаблицаРеализацийВОтчете.Ссылка = ТоварыРеализаций.Ссылка
			|;
			
			
			
			// ПОДГОТОВКА ТАБЛИЦЫ РОЗНИЧНЫХ ЦЕН НОМЕНКЛАТУРЫ ДЛЯ КОТОРЫХ УСТАНОВЛЕНА ЦЕНА БЕЗНАЛ
			
			|// Формируем таблицу номенклатуры которая была продана по безналу.
			|////////////////////////////////////////////////////////////////////////////////
			|ВЫБРАТЬ
			|	Номенклатура КАК Номенклатура
			|ПОМЕСТИТЬ ТаблицаНоменклатурыБезнал
			|ИЗ
			|	КешТоварыРеализций
			|ГДЕ
			|	ВидЦены = &БезналЦена
			|;
			|
			|// Получаем розничные цены номенклактуры которая была продана по безналу.
			|////////////////////////////////////////////////////////////////////////////////
			|ВЫБРАТЬ
			|	ВложенныйЗапрос.Период			КАК Период,
			|	ВложенныйЗапрос.Номенклатура 	КАК Номенклатура,
			|	ВложенныйЗапрос.Цена			КАК Цена
			|ПОМЕСТИТЬ ТаблицаРозничныхЦен
			|ИЗ
			|(
			|	ВЫБРАТЬ
			|		Период			КАК Период,
			|		Номенклатура 	КАК Номенклатура,
			|		ВЫБОР
			|			КОГДА Упаковка = ЗНАЧЕНИЕ(Справочник.УпаковкиНоменклатуры.ПустаяСсылка)
			|				ТОГДА Цена
			|			ИНАЧЕ Цена * Упаковка.Коэффициент
			|		КОНЕЦ КАК Цена
			|	ИЗ
			|		РегистрСведений.ЦеныНоменклатуры
			|	ГДЕ
			|		ВидЦены 		= &РозничнаяЦена
			|		И Период 		>= &ДатаНачало
			|		И Период 		< &ДатаОкончание
			|		И Номенклатура  В (ВЫБРАТЬ Номенклатура ИЗ ТаблицаНоменклатурыБезнал)
			|		
			|	ОБЪЕДИНИТЬ

			|	ВЫБРАТЬ
			|		Период			КАК Период,
			|		Номенклатура 	КАК Номенклатура,
			|		ВЫБОР
			|			КОГДА Упаковка = ЗНАЧЕНИЕ(Справочник.УпаковкиНоменклатуры.ПустаяСсылка)
			|				ТОГДА Цена
			|			ИНАЧЕ Цена * Упаковка.Коэффициент
			|		КОНЕЦ КАК Цена
			|	ИЗ
			|		РегистрСведений.ЦеныНоменклатуры.СрезПоследних(&ДатаНачало, Номенклатура В (ВЫБРАТЬ Номенклатура ИЗ ТаблицаНоменклатурыБезнал) И ВидЦены = &РозничнаяЦена)
			|) КАК ВложенныйЗапрос
			|;
			|
			|// Наростающие итоги по розничным ценам, необходимые для того, чтиобы заменить 
			|// цены номенклатуры проданные по безналу.
			|////////////////////////////////////////////////////////////////////////////////
			|ВЫБРАТЬ
			|  ТаблицаРозничныхЦен.Цена													КАК Цена,
			|  ТаблицаРозничныхЦен.Номенклатура											КАК Номенклатура,
			|  ТаблицаРозничныхЦен.Период 												КАК НачалоПериода,
			|  МИНИМУМ(ЕСТЬNULL(ТаблицаРозничныхЦенКопия.Период, ДАТАВРЕМЯ(3999, 1, 1))) КАК КонецПериода
			|ПОМЕСТИТЬ ТаблицаРозничныхЦенНаростающие
			|ИЗ
			|  ТаблицаРозничныхЦен КАК ТаблицаРозничныхЦен
			|	ЛЕВОЕ СОЕДИНЕНИЕ ТаблицаРозничныхЦен КАК ТаблицаРозничныхЦенКопия
			|	ПО ТаблицаРозничныхЦенКопия.Период		> ТаблицаРозничныхЦен.Период
			|	И ТаблицаРозничныхЦенКопия.Номенклатура = ТаблицаРозничныхЦен.Номенклатура
			|СГРУППИРОВАТЬ ПО
			|  ТаблицаРозничныхЦен.Период,
			|  ТаблицаРозничныхЦен.Цена,
			|  ТаблицаРозничныхЦен.Номенклатура
			|;
			
			
			
			// ВЫПОЛНЯЕМ РАСЧЕТ ОКОНЧАТЕЛЬНОЙ СУММЫ КОТОРАЯ ДОЛЖНА СВЕТИТСЯ В ОТЧЕТЕ ПО ДОКУМЕНТАХ РЕАЛИЗАЦИИ
			// РАСЧЕТ СУММЫ ВКЛЮЧАЕТ ОБРАБОТКУ ВИДОВ ЦЕН ТАБЛИЧНОЙ ЧАСТИ:
			// - РОЗНИЦА - ПОЛНОСТЬЮ ПОПАДАЕТ В ОТЧЕТ
			// - БЕЗНАЛ  - ЦЕНА ПЕРЕСЧИТЫВАЕТСЯ В РОЗНИЦУ ПО ЦЕНАМ НА ДАТУ РЕАЛИЗАЦИИ, ЕСЛИ РОЗНИЦЫ НА МОМЕНТ НЕТУ - ПЕРЕСЧЕТ НА ТЕКУЩУЮ ДАТУ
			// - ДРУГОЙ ВИД ЦЕНЫ - 0
			//
			// ТАКЖЕ РАСЧЕТ СУММЫ УЧИТЫВАЕТ РУЧНЫЕ И АВТОМАТИЧЕСКИЕ СКИДКИ
			
			|// Если в реализации товаров продано по безнальной цене - выполняем пересчет в розничную.
			|////////////////////////////////////////////////////////////////////////////////
			|ВЫБРАТЬ
			|	ТоварыРеализаций.Дата										КАК Дата,
			|	ТоварыРеализаций.Ссылка										КАК Ссылка,
			|	ТоварыРеализаций.Валюта										КАК Валюта,
			|	ТоварыРеализаций.Номенклатура								КАК Номенклатура,
			|	ТоварыРеализаций.Характеристика								КАК Характеристика,
			|	ТоварыРеализаций.Склад										КАК Склад,
			|	ТоварыРеализаций.Подразделение								КАК Подразделение,
			|	ТоварыРеализаций.Менеджер									КАК Менеджер,
			|	ТоварыРеализаций.Количество									КАК Количество,
			|	ВЫБОР
			|		КОГДА ТоварыРеализаций.ВидЦены = &РозничнаяЦена
			|			ТОГДА ТоварыРеализаций.Сумма
			|		КОГДА ТоварыРеализаций.ВидЦены = &БезналЦена
			|			ТОГДА (ТоварыРеализаций.Количество * ЕСТЬNULL(ТаблицаРозничныхЦен.Цена, 0)) 
			|						+ (ТоварыРеализаций.Количество * ЕСТЬNULL(ТаблицаРозничныхЦен.Цена, 0)) * ТоварыРеализаций.СуммаАвтоматическойСкидки / ТоварыРеализаций.Сумма
			|						+ (ТоварыРеализаций.Количество * ЕСТЬNULL(ТаблицаРозничныхЦен.Цена, 0)) * ТоварыРеализаций.СуммаРучнойСкидки / ТоварыРеализаций.Сумма
			|		ИНАЧЕ 0 
			|	КОНЕЦ КАК Сумма
			|ПОМЕСТИТЬ ТаблицаРеализацийПоРозничнымЦенам
			|ИЗ
			|	КешТоварыРеализций КАК ТоварыРеализаций
			|		ЛЕВОЕ СОЕДИНЕНИЕ ТаблицаРозничныхЦенНаростающие КАК ТаблицаРозничныхЦен
			|		ПО ТоварыРеализаций.Номенклатура = ТаблицаРозничныхЦен.Номенклатура
			|			И ТоварыРеализаций.Дата >= ТаблицаРозничныхЦен.НачалоПериода
			|			И ТоварыРеализаций.Дата < ТаблицаРозничныхЦен.КонецПериода
			|;
			|
			|// Если реализация товаро проведена в другой валюте - необходимо пересчитать в валюту 
			|// регламентированого учета.	
			|////////////////////////////////////////////////////////////////////////////////
			|ВЫБРАТЬ
			|ИЗ
			|	ТаблицаРеализацийПоРозничнымЦенам КАК ТаблицаРеализаций
			|
			|		ЛЕВОЕ СОЕДИНЕНИЕ ТаблицаКурсов КАК ТаблицаКурсовРеализации
			|       ПО ТаблицаРеализаций.Валюта = ТаблицаКурсовРеализации.Валюта
			|			И ТаблицаРеализаций.Дата >= ТаблицаКурсовРеализации.НачалоПериода
			|			И ТаблицаРеализаций.Дата < ТаблицаКурсовРеализации.КонецПериода
			|
			|// 3. Получаем список всех документов возврат товаров от клиента за период.
			|////////////////////////////////////////////////////////////////////////////////
			|ВЫБРАТЬ
			|	Возвраты.Период																КАК Дата,
			|	ВЫРАЗИТЬ(Возвраты.Регистратор КАК Документ.ВозвратТоваровОтКлиента) 		КАК Регистратор,
			|	ВЫРАЗИТЬ(Возвраты.Регистратор КАК Документ.ВозвратТоваровОтКлиента).Валюта 	КАК Валюта,
			|	РегистрАналитикаНоменклатуры.Номенклатура									КАК Номенклатура,
			|	РегистрАналитикаНоменклатуры.Характеристика									КАК Характеристика,
			|	РегистрАналитикаНоменклатуры.Склад											КАК Склад,
			|	Возвраты.Подразделение														КАК Подразделение,
			|	Возвраты.Менеджер															КАК Менеджер,
			|	Возвраты.КоличествоОборот													КАК Количество,
			|	Возвраты.СуммаВыручкиРеглОборот												КАК Сумма
			|ПОМЕСТИТЬ ДокументыВозвратТоваровОтКлиента
			|ИЗ
			|	РегистрНакопления.ВыручкаИСебестоимостьПродаж.Обороты(&ДатаНачало, &ДатаОкончание, Регистратор, Подразделение В (ВЫБРАТЬ Подразделение ИЗ РегистрСведений.Лояльность_Настройки)) КАК Возвраты
			|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.АналитикаУчетаНоменклатуры КАК РегистрАналитикаНоменклатуры
			|		ПО Возвраты.АналитикаУчетаНоменклатуры = РегистрАналитикаНоменклатуры.КлючАналитики
			|ГДЕ
			|	Возвраты.Регистратор ССЫЛКА Документ.ВозвратТоваровОтКлиента
			|ИНДЕКСИРОВАТЬ ПО
			|	Регистратор,
			|	Номенклатура,
			|	Характеристика,
			|	Склад
			|;
			|
			|// 4. Необходимо получить реализации на основании которых были сделаны возвраты
			|//    для правильной подстановки зарплат менеджеров.
			|////////////////////////////////////////////////////////////////////////////////
			|ВЫБРАТЬ
			|	Товары.Ссылка.Дата		КАК Дата,
			|	Товары.Ссылка 			КАК Регистратор,
			|	Товары.Номенклатура     КАК Номенклатура,
			|	Товары.Характеристика	КАК Характеристика,
			|	Товары.Ссылка.Склад		КАК Склад,
			|	Товары.Количество		КАК Количество,
			|	ВЫБОР
			|		КОГДА Товары.Ссылка.Валюта = &ВалютаРегламентированогоУчета
			|			ТОГДА Товары.СуммаСНДС
			|		ИНАЧЕ Товары.СуммаСНДС * (ЕСТЬNULL(КурсыВозвратов.Курс, 0) / ЕСТЬNULL(КурсыРеглУчета.Курс, 1))
			|	КОНЕЦ КАК Сумма,
			|	ВЫРАЗИТЬ(Товары.ДокументРеализации КАК Документ.РеализацияТоваровУслуг).Менеджер 		КАК Менеджер,
			|	ВЫРАЗИТЬ(Товары.ДокументРеализации КАК Документ.РеализацияТоваровУслуг).Подразделение 	КАК Подразделение
			|ПОМЕСТИТЬ ТаблицаВозвратовНаОснованииРеализаций
			|ИЗ
			|	ДокументыВозвратТоваровОтКлиента КАК ДокументыВозвратТоваров
			|	
			|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ВозвратТоваровОтКлиента.Товары КАК Товары
			|		ПО ДокументыВозвратТоваров.Регистратор = Товары.Ссылка
			|			И ДокументыВозвратТоваров.Номенклатура = Товары.Номенклатура
			|			И ДокументыВозвратТоваров.Характеристика = Товары.Характеристика
			|			И ДокументыВозвратТоваров.Склад = Товары.Ссылка.Склад
			|		
			|		ЛЕВОЕ СОЕДИНЕНИЕ ТаблицаКурсов КАК КурсыВозвратов
			|		ПО КурсыВозвратов.Валюта = ДокументыВозвратТоваров.Валюта
			|			И КурсыВозвратов.НачалоПериода >= ДокументыВозвратТоваров.Дата
			|			И КурсыВозвратов.КонецПериода < ДокументыВозвратТоваров.Дата
			|		
			|		ЛЕВОЕ СОЕДИНЕНИЕ ТаблицаКурсов КАК КурсыРеглУчета
			|		ПО КурсыРеглУчета.Валюта = &ВалютаРегламентированогоУчета
			|			И КурсыРеглУчета.НачалоПериода >= ДокументыВозвратТоваров.Дата
			|			И КурсыРеглУчета.КонецПериода < ДокументыВозвратТоваров.Дата
			|		
			|ГДЕ
			|	Товары.ДокументРеализации ССЫЛКА Документ.РеализацияТоваровУслуг
			|	
			|ИНДЕКСИРОВАТЬ ПО
			|	Регистратор,
			|	Номенклатура,
			|	Характеристика,
			|	Склад
			|;
			|
			|// 5. Связать выборку из табличной части с таблицей возвратов для подстановки правильного
			|//    менеджера в отчет.
			|////////////////////////////////////////////////////////////////////////////////
			|ВЫБРАТЬ
			|	ДокументыВозвратТоваровОтКлиента.Дата			КАК Дата,
			|	ДокументыВозвратТоваровОтКлиента.Регистратор	КАК Регистратор,
			|	ДокументыВозвратТоваровОтКлиента.Номенклатура	КАК Номенклатура,
			|	ДокументыВозвратТоваровОтКлиента.Характеристика	КАК Характеристика,
			|	ДокументыВозвратТоваровОтКлиента.Склад			КАК Склад,
			|	ЕСТЬNULL(-ВозвратыНаОснованииРеализаций.Количество, ДокументыВозвратТоваровОтКлиента.Количество) 		КАК Количество,
			|	ЕСТЬNULL(-ВозвратыНаОснованииРеализаций.Сумма, ДокументыВозвратТоваровОтКлиента.Сумма) 					КАК Сумма,
			|	ЕСТЬNULL(ВозвратыНаОснованииРеализаций.Менеджер, ДокументыВозвратТоваровОтКлиента.Менеджер) 			КАК Менеджер,
			|	ЕСТЬNULL(ВозвратыНаОснованииРеализаций.Подразделение, ДокументыВозвратТоваровОтКлиента.Подразделение) 	КАК Подразделение
			|ПОМЕСТИТЬ ТаблицаВозвратов
			|ИЗ
			|	ДокументыВозвратТоваровОтКлиента КАК ДокументыВозвратТоваровОтКлиента
			|		ЛЕВОЕ СОЕДИНЕНИЕ ТаблицаВозвратовНаОснованииРеализаций КАК ВозвратыНаОснованииРеализаций
			|		ПО ДокументыВозвратТоваровОтКлиента.Регистратор 		= ВозвратыНаОснованииРеализаций.Регистратор
			|			И ДокументыВозвратТоваровОтКлиента.Номенклатура 	= ВозвратыНаОснованииРеализаций.Номенклатура
			|			И ДокументыВозвратТоваровОтКлиента.Характеристика 	= ВозвратыНаОснованииРеализаций.Характеристика
			|			И ДокументыВозвратТоваровОтКлиента.Склад 			= ВозвратыНаОснованииРеализаций.Склад
			|;
			//|
			//|// Результирующий запрос.
			//|////////////////////////////////////////////////////////////////////////////////
			//|ВЫБРАТЬ
			//|	ТаблицаРеализаций.Дата							КАК Дата,
			//|	ТаблицаРеализаций.Регистратор					КАК Ссылка,
			//|	ТаблицаРеализаций.Номенклатура					КАК Номенклатура,
			//|	ТаблицаРеализаций.Характеристика				КАК Характеристика,
			//|	ТаблицаРеализаций.Склад							КАК Склад,
			//|	ТаблицаРеализаций.Подразделение					КАК Подразделение,
			//|	ТаблицаРеализаций.Менеджер						КАК Менеджер,
			//|	ТаблицаРеализаций.Количество					КАК Количество,
			//|	ТаблицаРеализаций.Сумма							КАК Сумма,
			//|	0												КАК Заработок,
			//|	0												КАК ВозможныйЗароботок
			//|ИЗ
			//|	ТаблицаРеализаций
			|";
	
	Возврат ТекстЗапроса;

КонецФункции // ТекстЗапросаТаблицаПродаж()
 
#КонецОбласти 

#Область СхемаКомпановкиДанных

Процедура ВывестиОтчетВТабличныйДокумент(ДокументРезультат, ДанныеРасшифровки, НаборДанных)

	НастройкиОтчета = КомпоновщикНастроек.ПолучитьНастройки(); 

	КомпоновщикМакета = Новый КомпоновщикМакетаКомпоновкиДанных;
	МакетКомпоновки = КомпоновщикМакета.Выполнить(СхемаКомпоновкиДанных, НастройкиОтчета, ДанныеРасшифровки);

	Если МакетКомпоновки.НаборыДанных.Количество() = 0 Тогда
		ВызватьИсключение НСтр("ru= 'Отчет не сформирован. Включите хотя бы одну группировку в ""Элементы оформления и группировки"".'") ;
	КонецЕсли;
	
	ПроцессорКомпоновки = Новый ПроцессорКомпоновкиДанных;
	ПроцессорКомпоновки.Инициализировать(МакетКомпоновки, НаборДанных, ДанныеРасшифровки);

	ПроцессорВывода = Новый ПроцессорВыводаРезультатаКомпоновкиДанныхВТабличныйДокумент;
	ПроцессорВывода.УстановитьДокумент(ДокументРезультат);
	ПроцессорВывода.Вывести(ПроцессорКомпоновки);

КонецПроцедуры

Функция ПолучитьЗначениеПараметра(ИмяПараметра)

  ПараметрДанных = КомпоновщикНастроек.Настройки.ПараметрыДанных.Элементы.Найти(ИмяПараметра);
   Если ПараметрДанных <> Неопределено Тогда
     ПараметрПользовательскойНастройки = КомпоновщикНастроек.ПользовательскиеНастройки.Элементы.Найти(ПараметрДанных.ИдентификаторПользовательскойНастройки);
     Если ПараметрПользовательскойНастройки <> Неопределено Тогда
       Возврат ПараметрПользовательскойНастройки.Значение;
     Иначе
       Возврат ПараметрДанных.Значение;
     КонецЕсли;
   КонецЕсли;

  Возврат Неопределено;

КонецФункции
	
#КонецОбласти 

#Область НастройкиКТСПомощь

Функция ПолучитьНастройкиКТСПомощь()

	

КонецФункции // ПолучитьНастройкиКТСПомощь()
 
	
#КонецОбласти 

#КонецОбласти