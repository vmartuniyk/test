#Область ОбработчикиСобытийФормы&НаСервереПроцедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)	ЗагрузитьТаблицуКоэффициентов();КонецПроцедуры&НаКлиентеПроцедура ПередЗакрытием(Отказ, СтандартнаяОбработка)		Если Модифицированность Тогда		Отказ = Истина;		ОповещаниеЗакрытия = Новый ОписаниеОповещения("ОбработкаЗакрытияФормы", ЭтаФорма);		ТекстВопроса 	   = НСтр("ru='Данные были изменены, сохранить изменения?'");		ПоказатьВопрос(ОповещаниеЗакрытия, ТекстВопроса, РежимДиалогаВопрос.ДаНетОтмена);		Отказ = Истина;		Возврат;	КонецЕсли;	КонецПроцедуры&НаКлиентеПроцедура ОбработкаЗакрытияФормы(Результат, ПараметрыОповещания) Экспорт	Если Результат = КодВозвратаДиалога.Да Тогда		РезультатЗаписи = ЗаписатьТаблицуКоэффициентов();		Если РезультатЗаписи Тогда			Модифицированность = Ложь;			Закрыть();		КонецЕсли;	ИначеЕсли Результат = КодВозвратаДиалога.Нет Тогда		Модифицированность = Ложь;		Закрыть();	КонецЕсли;КонецПроцедуры // ОбработкаЗакрытияФормы()#КонецОбласти#Область ОбработчикиСобытийЭлементовТаблицыФормыТаблицаКоэффициентов&НаКлиентеПроцедура ТаблицаКоэффициентовНаименованиеПриИзменении(Элемент)	ТекущиеДанные = Элементы.ТаблицаКоэффициентов.ТекущиеДанные;	Если ТекущиеДанные = Неопределено Тогда		Возврат;	КонецЕсли;	ТекущиеДанные.ЗаписьИзменена = Истина;	Модифицированность = Истина;КонецПроцедуры&НаКлиентеПроцедура ТаблицаКоэффициентовКоэффициентПриИзменении(Элемент)	ТекущиеДанные = Элементы.ТаблицаКоэффициентов.ТекущиеДанные;	Если ТекущиеДанные = Неопределено Тогда		Возврат;	КонецЕсли;	ТекущиеДанные.ЗаписьИзменена = Истина;	Модифицированность = Истина;КонецПроцедуры&НаКлиентеПроцедура ТаблицаКоэффициентовКомментарийПриИзменении(Элемент)	ТекущиеДанные = Элементы.ТаблицаКоэффициентов.ТекущиеДанные;	Если ТекущиеДанные = Неопределено Тогда		Возврат;	КонецЕсли;	ТекущиеДанные.ЗаписьИзменена = Истина;	Модифицированность = Истина;КонецПроцедуры&НаКлиентеПроцедура ТаблицаКоэффициентовПередУдалением(Элемент, Отказ)	ТекущиеДанные = Элементы.ТаблицаКоэффициентов.ТекущиеДанные;	Если ТекущиеДанные = Неопределено Тогда		Возврат;	КонецЕсли;	Если ЗначениеЗаполнено(ТекущиеДанные.Ссылка) Тогда		ТекстСообщения = НСтр("ru='Данные уже записаны в базу - удалять нельзя.'");		Отказ = Истина;		Возврат;	КонецЕсли;КонецПроцедуры#КонецОбласти#Область ОбработчикиКомандФормы&НаКлиентеПроцедура ЗаписатьИЗакрыть(Команда)	РезультатЗаписи = ЗаписатьТаблицуКоэффициентов();	Если РезультатЗаписи Тогда		Модифицированность = Ложь;		Закрыть();	КонецЕсли;КонецПроцедуры#КонецОбласти#Область СлужебныеПроцедурыИФункции&НаСервереПроцедура ЗагрузитьТаблицуКоэффициентов()	УстановитьПривилегированныйРежим(Истина);		Запрос 			= Новый Запрос;	Запрос.Текст    = ТекстЗапросаЗагрузкаТаблицы();		ТаблицаКоэффициентов.Загрузить(Запрос.Выполнить().Выгрузить());КонецПроцедуры // ЗагрузитьТаблицуКоэффициентов() &НаСервереФункция ТекстЗапросаЗагрузкаТаблицы()	ТекстЗапроса = "ВЫБРАТЬ	               |	Ссылка			КАК Ссылка,	               |	Наименование	КАК Наименование,	               |	Коэффициент		КАК Коэффициент,	               |	Комментарий		КАК Комментарий,	               |	ЛОЖЬ 			КАК ЗаписьИзменена	               |ИЗ	               |	Справочник.КТС_КоэффициентыКомпетентностиМенеджеров	               |ГДЕ	               |	ПометкаУдаления = ЛОЖЬ";		Возврат ТекстЗапроса;КонецФункции // ТекстЗапросаЗагрузкаТаблицы()&НаСервереФункция ЗаписатьТаблицуКоэффициентов()	ОшибкиНайдены = Ложь;	НайденыИзмененныеЗаписи = Ложь;	Для каждого СтрокаТаблицы ИЗ ТаблицаКоэффициентов Цикл		Если ПустаяСтрока(СтрокаТаблицы.Наименование) Тогда			ТекстСообщения = НСтр("ru='Необходимо заполнить наименование коэффициента.'");			ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения, , "ТаблицаКоэффициентов[" + ТаблицаКоэффициентов.Индекс(СтрокаТаблицы) + "].Наименование");			ОшибкиНайдены = Истина;		КонецЕсли;		Если СтрокаТаблицы.ЗаписьИзменена Тогда			НайденыИзмененныеЗаписи = Истина;		КонецЕсли;	КонецЦикла;		Если ОшибкиНайдены Тогда		Возврат Ложь;	КонецЕсли;		Если НЕ НайденыИзмененныеЗаписи Тогда		Возврат Истина;	КонецЕсли;		УстановитьПривилегированныйРежим(Истина);		Запрос 			= Новый Запрос;	Запрос.Текст	= ТекстЗапросаЗаписьТаблицы();		Запрос.УстановитьПараметр("ТаблицаКоэффициентов", ТаблицаКоэффициентов.Выгрузить());		РезультатЗапроса = Запрос.ВыполнитьПакет();		ВыборкаНовыеЭлементы 		= РезультатЗапроса[РезультатЗапроса.ВГраница()-1].Выбрать();	ВыборкаИзмененныеЭлементы   = РезультатЗапроса[РезультатЗапроса.ВГраница()].Выбрать();		НачатьТранзакцию();		Пока ВыборкаНовыеЭлементы.Следующий() Цикл        СпрОбъект = Справочники.КТС_КоэффициентыКомпетентностиМенеджеров.СоздатьЭлемент();		ЗаполнитьЗначенияСвойств(СпрОбъект, ВыборкаНовыеЭлементы);		Попытка			СпрОбъект.Записать();		Исключение			ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ОписаниеОшибки());			ОтменитьТранзакцию();			Возврат Ложь;		КонецПопытки;	КонецЦикла;		Пока ВыборкаИзмененныеЭлементы.Следующий() Цикл		СпрОбъект = ВыборкаИзмененныеЭлементы.Ссылка.ПолучитьОбъект();		ЗаполнитьЗначенияСвойств(СпрОбъект, ВыборкаИзмененныеЭлементы, , "Ссылка");		Попытка			СпрОбъект.Записать();		Исключение			ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ОписаниеОшибки());			ОтменитьТранзакцию();			Возврат Ложь;		КонецПопытки;		РезультатИзменения = ИзменитьКоэффициентыЭффективностиПродавцов(ВыборкаИзмененныеЭлементы.Ссылка);		Если Не РезультатИзменения Тогда			ОтменитьТранзакцию();			Возврат Ложь;		КонецЕсли;	КонецЦикла;	ЗафиксироватьТранзакцию();		Возврат Истина;	КонецФункции // ЗаписатьТаблицуКоэффициентов()&НаСервереФункция ТекстЗапросаЗаписьТаблицы()	ТекстЗапроса = "ВЫБРАТЬ	               |	ТаблицаКоэффициентов.Ссылка,	               |	ТаблицаКоэффициентов.Наименование,	               |	ТаблицаКоэффициентов.Коэффициент,	               |	ТаблицаКоэффициентов.Комментарий,	               |	ТаблицаКоэффициентов.ЗаписьИзменена	               |ПОМЕСТИТЬ ТаблицаКоэффициентов	               |ИЗ	               |	&ТаблицаКоэффициентов КАК ТаблицаКоэффициентов	               |;	               |	               |////////////////////////////////////////////////////////////////////////////////	               |ВЫБРАТЬ	               |	ТаблицаКоэффициентов.Наименование,	               |	ТаблицаКоэффициентов.Коэффициент,	               |	ТаблицаКоэффициентов.Комментарий	               |ИЗ	               |	ТаблицаКоэффициентов КАК ТаблицаКоэффициентов	               |ГДЕ	               |	ТаблицаКоэффициентов.ЗаписьИзменена = ИСТИНА	               |	И ТаблицаКоэффициентов.Ссылка = ЗНАЧЕНИЕ(Справочник.КТС_КоэффициентыКомпетентностиМенеджеров.ПустаяСсылка)	               |;	               |	               |////////////////////////////////////////////////////////////////////////////////	               |ВЫБРАТЬ	               |	ТаблицаКоэффициентов.Ссылка,	               |	ТаблицаКоэффициентов.Наименование,	               |	ТаблицаКоэффициентов.Коэффициент,	               |	ТаблицаКоэффициентов.Комментарий	               |ИЗ	               |	ТаблицаКоэффициентов КАК ТаблицаКоэффициентов	               |ГДЕ	               |	ТаблицаКоэффициентов.ЗаписьИзменена = ИСТИНА	               |	И ТаблицаКоэффициентов.Ссылка <> ЗНАЧЕНИЕ(Справочник.КТС_КоэффициентыКомпетентностиМенеджеров.ПустаяСсылка)";		Возврат ТекстЗапроса;КонецФункции // ТекстЗапросаЗаписьТаблицы() &НаСервереФункция ИзменитьКоэффициентыЭффективностиПродавцов(Коэффициент)	Запрос = Новый Запрос;	Запрос.Текст = ТекстЗапросаИзменениеКоээфициентовПродавцов();		Запрос.УстановитьПараметр("ТекущаяДата", НачалоМесяца(ТекущаяДата()));	Запрос.УстановитьПараметр("Коэффициент", Коэффициент);		РезультатЗапроса = Запрос.Выполнить();		Если РезультатЗапроса.Пустой() Тогда		Возврат Истина;	КонецЕсли;		Блокировка = Новый БлокировкаДанных;	ЭлементБлокировки = Блокировка.Добавить("Регистрсведений.КТС_КоэффициентыЭффективностиПродавца");	ЭлементБлокировки.Режим = РежимБлокировкиДанных.Исключительный;	ЭлементБлокировки.ИсточникДанных = РезультатЗапроса;	ЭлементБлокировки.ИспользоватьИзИсточникаДанных("Период", 	"Период");	ЭлементБлокировки.ИспользоватьИзИсточникаДанных("Менеджер", "Менеджер");	Блокировка.Заблокировать();		Выборка = РезультатЗапроса.Выбрать();	Пока Выборка.Следующий() Цикл		НаборЗаписей = РегистрыСведений.КТС_КоэффициентыЭффективностиПродавца.СоздатьНаборЗаписей();		НаборЗаписей.Отбор.Период.Установить(Выборка.Период);		НаборЗаписей.Отбор.Менеджер.Установить(Выборка.Менеджер);		НаборЗаписей.Прочитать();		НаборЗаписей[0].Значения = Коэффициент.Коэффициент;		Попытка			НаборЗаписей.Записать();		Исключение			ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ОписаниеОшибки());			Возврат Ложь;		КонецПопытки;	КонецЦикла;		Возврат Истина;КонецФункции // ИзменитьКоэффициентыЕфективностиПродавцов()&НаСервереФункция ТекстЗапросаИзменениеКоээфициентовПродавцов()	ТекстЗапроса = "ВЫБРАТЬ	               |	Период						КАК Период,	               |	Менеджер					КАК Менеджер,	               |	КоэффициентЭффективности	КАК КоэффициентЭффективности,	               |	Значения 					КАК Значения	               |ИЗ	               |	РегистрСведений.КТС_КоэффициентыЭффективностиПродавца	               |ГДЕ	               |	Период >= &ТекущаяДата	               |	И КоэффициентЭффективности = &Коэффициент";		Возврат ТекстЗапроса;КонецФункции // ТекстЗапросаИзменениеКоээфициентовменеджера()&НаКлиентеПроцедура ТаблицаКоэффициентовПередНачаломДобавления(Элемент, Отказ, Копирование, Родитель, Группа, Параметр)	Отказ = Истина;	Модифицированность = Истина;	НоваяСтрока = ТаблицаКоэффициентов.Добавить();	НоваяСтрока.ЗаписьИзменена = Истина;КонецПроцедуры#КонецОбласти