Перем Версия;

Процедура ЗаписатьНастройкиОбработки()
	Если  ПрограммаDiff<>"" и НастройкаСтрокиЗапуска<>"" тогда
		ВыборDiff=Новый Структура;
		ВыборDiff.Вставить("ПутьПрограммы",ПрограммаDiff);
		ВыборDiff.Вставить("ИспользоватьМетки",ИспользоватьМетки);
		ВыборDiff.Вставить("СтрокаЗапуска",НастройкаСтрокиЗапуска);
	Иначе
		ВыборDiff=Неопределено;
	КонецЕсли;
	СохранитьЗначение("V8Reader|ВыборDiff",ВыборDiff);
	СохранитьЗначение("V8Reader|ПроверятьАктуальнуюВерсиюПриОткрытии",ПроверятьАктуальнуюВерсиюПриОткрытии);
	ЭтаФорма.ВладелецФормы.ИзменитьЗаголовокDiff();
	СохранитьЗначение("V8Reader|ИспользоватьКэш",ИспользоватьКэш);
	СохранитьЗначение("V8Reader|СтруктурноеСравнениеМодулей",СтруктурноеСравнениеМодулей);
	
КонецПроцедуры

Процедура ОсновныеДействияФормыЗаписатьИЗакрыть(Кнопка)
	ЗаписатьНастройкиОбработки();
	Закрыть();
КонецПроцедуры

Процедура ОсновныеДействияФормыЗаписать(Кнопка)
	ЗаписатьНастройкиОбработки();
КонецПроцедуры

Процедура ВыборDiffНачалоВыбора(Элемент, СтандартнаяОбработка)
	
	СтандартнаяОбработка = Ложь;
	ДиалогВыбора = Новый ДиалогВыбораФайла(РежимДиалогаВыбораФайла.Открытие);
	ДиалогВыбора.Фильтр = "Файлы приложений (*.exe)|*.exe"; 
	ДиалогВыбора.ПолноеИмяФайла=Элемент.Значение;
	ДиалогВыбора.Заголовок="Выберите приложение для трехуровневого сравнения файлов";
	Если ДиалогВыбора.Выбрать() Тогда
		ФайлDiff=Новый файл(ДиалогВыбора.ПолноеИмяФайла);
		Элемент.Значение = ДиалогВыбора.ПолноеИмяФайла;
		Если ФайлDiff.Имя="kdiff3.exe" или ФайлDiff.Имя="sgdm.exe" тогда
			ЭлементыФормы.ИспользоватьМетки.Видимость=истина;
			ИспользоватьМетки=Истина;
		Иначе
			ЭлементыФормы.ИспользоватьМетки.Видимость=ложь;
			ИспользоватьМетки=ложь;
		КонецЕсли;
		ЗапуститьКонструкторСтрокиЗапуска(ФайлDiff);
	КонецЕсли;
	
КонецПроцедуры

Процедура НастройкаСтрокиЗапускаНачалоВыбора(Элемент, СтандартнаяОбработка)
	ВвестиСтроку(НастройкаСтрокиЗапуска,"Строка запуска программы для 3-way diff",,истина);
КонецПроцедуры

Процедура ЗапуститьКонструкторСтрокиЗапуска(ФайлDiff)
	Если ФайлDiff.Имя="kdiff3.exe" тогда
		Если ИспользоватьМетки=Истина тогда
			НастройкаСтрокиЗапуска=""""+ФайлDiff.ПолноеИмя+""" ""%1"" -fname ""синоним%1 (первый файл)"" ""%2"" -fname ""синоним%2 (второй файл)"" ""%3"" -fname ""синоним%3 (третий файл)""";
		Иначе
			НастройкаСтрокиЗапуска=""""+ФайлDiff.ПолноеИмя+""" ""%1"" ""%2"" ""%3""";
		КонецЕсли;
		
	ИначеЕсли  ФайлDiff.Имя="sgdm.exe" тогда
		Если ИспользоватьМетки=Истина тогда
			НастройкаСтрокиЗапуска = """"+ФайлDiff.ПолноеИмя+""" /title1=""синоним%1 (первый файл)"" /title2=""синоним%2 (второй файл)"" /title3=""синоним%3 (третий файл)"" ""%1"" ""%2"" ""%3""";
		Иначе
			НастройкаСтрокиЗапуска=""""+ФайлDiff.ПолноеИмя+""" ""%1"" ""%2"" ""%3""";
		КонецЕсли;
	Иначе
		НастройкаСтрокиЗапуска=""""+ФайлDiff.ПолноеИмя+""" ""%1"" ""%2"" ""%3""";
	КонецЕсли;
КонецПроцедуры

Процедура ПриОткрытии()
	Если ВыборDiff<>Неопределено тогда
		Попытка
			ЭлементыФормы.ПрограммаDiff.Значение=ВыборDiff.ПутьПрограммы;
			ФайлDiff=Новый файл(ПрограммаDiff);
			Если ФайлDiff.Имя="kdiff3.exe" или ФайлDiff.Имя="sgdm.exe" тогда
				ЭлементыФормы.ИспользоватьМетки.Видимость=истина;
			КонецЕсли;
			ЭлементыФормы.ИспользоватьМетки.Значение=ВыборDiff.ИспользоватьМетки;
			ЭлементыФормы.НастройкаСтрокиЗапуска.Значение=ВыборDiff.СтрокаЗапуска;
		Исключение
		КонецПопытки;
	КонецЕсли;
КонецПроцедуры

Процедура ИспользоватьМеткиПриИзменении(Элемент)
	ФайлDiff=Новый Файл(ПрограммаDiff);
	ЗапуститьКонструкторСтрокиЗапуска(ФайлDiff);
КонецПроцедуры

Процедура ПроверитьСейчасНажатие(Элемент) Экспорт //из комментария http://forum.infostart.ru/forum24/topic62207/message684504/#message684504 от Жолтокнижниг
	
	Соединение=Новый HTTPСоединение("infostart.ru");
	Файл=ПолучитьИмяВременногоФайла();
	Соединение.Получить("public/106310/",файл);
	ТД=Новый ТекстовыйДокумент;
	ТД.Прочитать(Файл);
	РегулярноеВыражениеX=Новый COMОбъект("VBScript.RegExp");
	РегулярноеВыражениеX.Global = Истина;
	РегулярноеВыражениеX.IgnoreCase = Истина;
	РегулярноеВыражениеX.MultiLine = Истина;
	РегулярноеВыражениеX.Pattern="<span class=""tool mdate"">\[(.+?)\]</span>";
	Наборы=РегулярноеВыражениеX.Execute(ТД.ПолучитьТекст());
	ВерсияНовая=Наборы.Item(0).SubMatches(0);
	Если Дата(ВерсияНовая+":00")>Дата(Версия) Тогда
		ПоказатьОповещениеПользователя(,, "Обнаружена новая версия
			|от " + Лев(ВерсияНовая,10) + "
			|Ссылка на страницу разработки
			|находится в форме настройки.",
			ЭлементыФормы.ПолеКартинки1.Картинка);
	Иначе
		ПоказатьОповещениеПользователя(,, "Обработка V8Reader 
		|последней версии.
		|Обновление не требуется.",ЭлементыФормы.ПолеКартинки.Картинка);
	КонецЕсли;
	
КонецПроцедуры

Процедура ПерейтиНаСтраницуРазработкиНажатие(Элемент)
	ЗапуститьПриложение("http://infostart.ru/public/106310/");
КонецПроцедуры

СтраницаРазработки="http://infostart.ru/public/106310/";
Версия="13.02.2013 23:59:59";
ЭлементыФормы.АктуальнаяВерсия.Заголовок="V8Reader версия от "+Лев(Версия,10)+""