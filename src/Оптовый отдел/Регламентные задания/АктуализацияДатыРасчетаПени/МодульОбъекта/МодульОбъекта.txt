
#Область ИнтерфейсАвтоматическихТестов

Перем ЮнитТест;

Функция ПолучитьСписокТестов(ЮнитТестирование) Экспорт
	
	ЮнитТест = ЮнитТестирование;
	
	СпиокТестов = Новый Массив;	
	Возврат СпиокТестов;
	
КонецФункции

#КонецОбласти


#Область ПрограмнныйИнтерфейс

// Точка входа регламентного задания "Актуализация расчета даты расчета пени".
//
Процедура ВыполнитьАктуализацию() Экспорт
	
	Запрос 		 = Новый Запрос;
	Запрос.Текст = ТекстЗапросаАктуализации();
	
КонецПроцедуры

Процедура ВыполнитьАктуализацию2()
	
	Запрос = Новый Запрос("ВЫБРАТЬ
	                      |	КурсыВалютСрезПоследних.Валюта,
	                      |	КурсыВалютСрезПоследних.Курс / КурсыВалютСрезПоследних.Кратность КАК Курс
	                      |ПОМЕСТИТЬ КурсыВалют
	                      |ИЗ
	                      |	РегистрСведений.КурсыВалют.СрезПоследних КАК КурсыВалютСрезПоследних
	                      |;
	                      |
	                      |////////////////////////////////////////////////////////////////////////////////
	                      |ВЫБРАТЬ
	                      |	Аналитика.Партнер КАК Партнер,
	                      |	СУММА(ВЫБОР
	                      |			КОГДА ВалютаУправленческогоУчета.Значение = Долги.Валюта
	                      |				ТОГДА Долги.СуммаОстаток
	                      |			ИНАЧЕ Долги.СуммаОстаток / КурсыВалютУПР.Курс * КурсыВалют.Курс
	                      |		КОНЕЦ) КАК Долг
	                      |ПОМЕСТИТЬ Долги
	                      |ИЗ
	                      |	РегистрНакопления.РасчетыСКлиентами.Остатки(
	                      |			&ТекущаяДата,
	                      |			АналитикаУчетаПоПартнерам В
	                      |				(ВЫБРАТЬ
	                      |					АналитикаПоПартнерам.КлючАналитики КАК КлючАналитики
	                      |				ИЗ
	                      |					РегистрСведений.АналитикаУчетаПоПартнерам КАК АналитикаПоПартнерам
	                      |				ГДЕ
	                      |					АналитикаПоПартнерам.Организация = &Организация)) КАК Долги
	                      |		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.АналитикаУчетаПоПартнерам КАК Аналитика
	                      |		ПО Долги.АналитикаУчетаПоПартнерам = Аналитика.КлючАналитики
	                      |		ЛЕВОЕ СОЕДИНЕНИЕ Константа.ВалютаУправленческогоУчета КАК ВалютаУправленческогоУчета
	                      |		ПО (ИСТИНА)
	                      |		ЛЕВОЕ СОЕДИНЕНИЕ КурсыВалют КАК КурсыВалютУПР
	                      |		ПО (КурсыВалютУПР.Валюта = ВалютаУправленческогоУчета.Значение)
	                      |		ЛЕВОЕ СОЕДИНЕНИЕ КурсыВалют КАК КурсыВалют
	                      |		ПО (КурсыВалют.Валюта = Долги.Валюта)
	                      |
	                      |СГРУППИРОВАТЬ ПО
	                      |	Аналитика.Партнер
	                      |;
	                      |
	                      |////////////////////////////////////////////////////////////////////////////////
	                      |ВЫБРАТЬ
	                      |	ЗаказКлиентаЭтапыГрафикаОплаты.Ссылка,
	                      |	МИНИМУМ(ЗаказКлиентаЭтапыГрафикаОплаты.ДатаПлатежа) КАК ДатаПлатежа
	                      |ПОМЕСТИТЬ ГрафикОплат
	                      |ИЗ
	                      |	Документ.ЗаказКлиента.ЭтапыГрафикаОплаты КАК ЗаказКлиентаЭтапыГрафикаОплаты
	                      |ГДЕ
	                      |	ЗаказКлиентаЭтапыГрафикаОплаты.Ссылка.Организация = &Организация
	                      |
	                      |СГРУППИРОВАТЬ ПО
	                      |	ЗаказКлиентаЭтапыГрафикаОплаты.Ссылка
	                      |;
	                      |
	                      |////////////////////////////////////////////////////////////////////////////////
	                      |ВЫБРАТЬ
	                      |	Аналитика.Партнер КАК Партнер,
	                      |	Обороты.Регистратор,
	                      |	ДОБАВИТЬКДАТЕ(ДОБАВИТЬКДАТЕ(ДОБАВИТЬКДАТЕ(ВЫБОР
	                      |					КОГДА Обороты.Регистратор.ЗаказКлиента = ЗНАЧЕНИЕ(Документ.ЗаказКлиента.ПустаяСсылка)
	                      |							ИЛИ Обороты.Регистратор.ЗаказКлиента = НЕОПРЕДЕЛЕНО
	                      |							ИЛИ Обороты.Регистратор.ЗаказКлиента = NULL
	                      |						ТОГДА Обороты.Регистратор.ДатаПлатежа
	                      |					ИНАЧЕ ГрафикОплат.ДатаПлатежа
	                      |				КОНЕЦ, ЧАС, ЧАС(Обороты.Период)), МИНУТА, МИНУТА(Обороты.Период)), СЕКУНДА, СЕКУНДА(Обороты.Период)) КАК Период,
	                      |	ВЫБОР
	                      |		КОГДА ВалютаУправленческогоУчета.Значение = Обороты.Валюта
	                      |			ТОГДА Обороты.СуммаПриход
	                      |		ИНАЧЕ Обороты.СуммаПриход / КурсыВалютУПР.Курс * КурсыВалют.Курс
	                      |	КОНЕЦ КАК Сумма,
	                      |	ВЫБОР
	                      |		КОГДА ВалютаУправленческогоУчета.Значение = Обороты.Валюта
	                      |			ТОГДА Обороты.СуммаОборот
	                      |		ИНАЧЕ Обороты.СуммаОборот / КурсыВалютУПР.Курс * КурсыВалют.Курс
	                      |	КОНЕЦ КАК СуммаОборот
	                      |ПОМЕСТИТЬ ОборотыПоКлиенту
	                      |ИЗ
	                      |	РегистрНакопления.РасчетыСКлиентами.ОстаткиИОбороты(
	                      |			,
	                      |			&ТекущаяДата,
	                      |			Регистратор,
	                      |			,
	                      |			АналитикаУчетаПоПартнерам В
	                      |				(ВЫБРАТЬ
	                      |					АналитикаПоПартнерам.КлючАналитики КАК КлючАналитики
	                      |				ИЗ
	                      |					РегистрСведений.АналитикаУчетаПоПартнерам КАК АналитикаПоПартнерам
	                      |				ГДЕ
	                      |					АналитикаПоПартнерам.Организация = &Организация)) КАК Обороты
	                      |		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.АналитикаУчетаПоПартнерам КАК Аналитика
	                      |		ПО Обороты.АналитикаУчетаПоПартнерам = Аналитика.КлючАналитики
	                      |		ЛЕВОЕ СОЕДИНЕНИЕ ГрафикОплат КАК ГрафикОплат
	                      |		ПО (ГрафикОплат.Ссылка = Обороты.Регистратор.ЗаказКлиента)
	                      |		ЛЕВОЕ СОЕДИНЕНИЕ Константа.ВалютаУправленческогоУчета КАК ВалютаУправленческогоУчета
	                      |		ПО (ИСТИНА)
	                      |		ЛЕВОЕ СОЕДИНЕНИЕ КурсыВалют КАК КурсыВалютУПР
	                      |		ПО (КурсыВалютУПР.Валюта = ВалютаУправленческогоУчета.Значение)
	                      |		ЛЕВОЕ СОЕДИНЕНИЕ КурсыВалют КАК КурсыВалют
	                      |		ПО (КурсыВалют.Валюта = Обороты.Валюта)
	                      |ГДЕ
	                      |	ТИПЗНАЧЕНИЯ(Обороты.Регистратор) = ТИП(Документ.РеализацияТоваровУслуг)
	                      |	И Обороты.СуммаОборот <> 0
	                      |;
	                      |
	                      |////////////////////////////////////////////////////////////////////////////////
	                      |ВЫБРАТЬ
	                      |	ОборотыПоКлиенту.Партнер КАК Партнер,
	                      |	НАЧАЛОПЕРИОДА(ОборотыПоКлиенту.Период, МЕСЯЦ) КАК НачПериода,
	                      |	КОНЕЦПЕРИОДА(ОборотыПоКлиенту.Период, МЕСЯЦ) КАК КонПериода,
	                      |	СУММА(ОборотыПоКлиенту.СуммаОборот) КАК Сумма
	                      |ПОМЕСТИТЬ ОборотыПоМесяцам
	                      |ИЗ
	                      |	ОборотыПоКлиенту КАК ОборотыПоКлиенту
	                      |
	                      |СГРУППИРОВАТЬ ПО
	                      |	ОборотыПоКлиенту.Партнер,
	                      |	НАЧАЛОПЕРИОДА(ОборотыПоКлиенту.Период, МЕСЯЦ),
	                      |	КОНЕЦПЕРИОДА(ОборотыПоКлиенту.Период, МЕСЯЦ)
	                      |;
	                      |
	                      |////////////////////////////////////////////////////////////////////////////////
	                      |ВЫБРАТЬ
	                      |	ОборотыПоМесяцам.Партнер,
	                      |	ОборотыПоМесяцам.НачПериода,
	                      |	ОборотыПоМесяцам.КонПериода,
	                      |	ОборотыПоМесяцам.Сумма,
	                      |	СУММА(ОборотыПоМесяцамКопия.Сумма) КАК СуммаПосле,
	                      |	СУММА(ОборотыПоМесяцамКопия.Сумма) - ОборотыПоМесяцам.Сумма КАК СуммаДо
	                      |ПОМЕСТИТЬ ОборотыПоМесяцамНарастающие
	                      |ИЗ
	                      |	ОборотыПоМесяцам КАК ОборотыПоМесяцам
	                      |		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ОборотыПоМесяцам КАК ОборотыПоМесяцамКопия
	                      |		ПО ОборотыПоМесяцам.Партнер = ОборотыПоМесяцамКопия.Партнер
	                      |			И ОборотыПоМесяцам.НачПериода <= ОборотыПоМесяцамКопия.НачПериода
	                      |
	                      |СГРУППИРОВАТЬ ПО
	                      |	ОборотыПоМесяцам.НачПериода,
	                      |	ОборотыПоМесяцам.КонПериода,
	                      |	ОборотыПоМесяцам.Партнер,
	                      |	ОборотыПоМесяцам.Сумма
	                      |;
	                      |
	                      |////////////////////////////////////////////////////////////////////////////////
	                      |ВЫБРАТЬ
	                      |	Долги.Партнер,
	                      |	Долги.Долг,
	                      |	ОборотыПоМесНарастающие.НачПериода,
	                      |	ОборотыПоМесНарастающие.КонПериода,
	                      |	Долги.Долг - ОборотыПоМесНарастающие.СуммаДо КАК ОстатокДолга
	                      |ПОМЕСТИТЬ ДолгиПоВыбраннымМесяцам
	                      |ИЗ
	                      |	Долги КАК Долги
	                      |		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ОборотыПоМесяцамНарастающие КАК ОборотыПоМесНарастающие
	                      |		ПО Долги.Партнер = ОборотыПоМесНарастающие.Партнер
	                      |			И Долги.Долг > ОборотыПоМесНарастающие.СуммаДо
	                      |			И Долги.Долг <= ОборотыПоМесНарастающие.СуммаПосле
	                      |;
	                      |
	                      |////////////////////////////////////////////////////////////////////////////////
	                      |ВЫБРАТЬ
	                      |	Обороты.Партнер КАК Партнер,
	                      |	Обороты.Регистратор,
	                      |	Обороты.Период,
	                      |	ДолгиПоВыбМесяцам.Долг,
	                      |	ДолгиПоВыбМесяцам.ОстатокДолга,
	                      |	Обороты.Сумма,
	                      |	Обороты.Период КАК ДатаОтсрочки
	                      |ПОМЕСТИТЬ ДвиженияПоВыбраннымМесяцам
	                      |ИЗ
	                      |	ОборотыПоКлиенту КАК Обороты
	                      |		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ДолгиПоВыбраннымМесяцам КАК ДолгиПоВыбМесяцам
	                      |		ПО Обороты.Партнер = ДолгиПоВыбМесяцам.Партнер
	                      |			И Обороты.Период >= ДолгиПоВыбМесяцам.НачПериода
	                      |			И Обороты.Период <= ДолгиПоВыбМесяцам.КонПериода
	                      |;
	                      |
	                      |////////////////////////////////////////////////////////////////////////////////
	                      |ВЫБРАТЬ
	                      |	ДвиженияПоВыбМесяцам.Партнер,
	                      |	ДвиженияПоВыбМесяцам.Регистратор,
	                      |	ДвиженияПоВыбМесяцам.Период,
	                      |	ДвиженияПоВыбМесяцам.Сумма,
	                      |	СУММА(ДвиженияПоВыбМесяцамКопия.Сумма) КАК СуммаПосле,
	                      |	СУММА(ДвиженияПоВыбМесяцамКопия.Сумма) - ДвиженияПоВыбМесяцам.Сумма КАК СуммаДо,
	                      |	ДвиженияПоВыбМесяцам.ОстатокДолга,
	                      |	ДвиженияПоВыбМесяцам.ДатаОтсрочки
	                      |ПОМЕСТИТЬ ДвиженияПредварительные
	                      |ИЗ
	                      |	ДвиженияПоВыбраннымМесяцам КАК ДвиженияПоВыбМесяцам
	                      |		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ДвиженияПоВыбраннымМесяцам КАК ДвиженияПоВыбМесяцамКопия
	                      |		ПО ДвиженияПоВыбМесяцам.Партнер = ДвиженияПоВыбМесяцамКопия.Партнер
	                      |			И ДвиженияПоВыбМесяцам.Период <= ДвиженияПоВыбМесяцамКопия.Период
	                      |
	                      |СГРУППИРОВАТЬ ПО
	                      |	ДвиженияПоВыбМесяцам.Партнер,
	                      |	ДвиженияПоВыбМесяцам.Регистратор,
	                      |	ДвиженияПоВыбМесяцам.Период,
	                      |	ДвиженияПоВыбМесяцам.Сумма,
	                      |	ДвиженияПоВыбМесяцам.ОстатокДолга,
	                      |	ДвиженияПоВыбМесяцам.ДатаОтсрочки
	                      |;
	                      |
	                      |////////////////////////////////////////////////////////////////////////////////
	                      |ВЫБРАТЬ
	                      |	ДвиженияПредв.Партнер,
	                      |	ДвиженияПредв.Регистратор,
	                      |	ДвиженияПредв.Период,
	                      |	ДвиженияПредв.ОстатокДолга - ДвиженияПредв.СуммаДо КАК СуммаДолга,
	                      |	ДвиженияПредв.Сумма
	                      |ПОМЕСТИТЬ ДвиженияОкончательные
	                      |ИЗ
	                      |	ДвиженияПредварительные КАК ДвиженияПредв
	                      |ГДЕ
	                      |	ДвиженияПредв.ОстатокДолга > ДвиженияПредв.СуммаДо
	                      |	И ДвиженияПредв.ОстатокДолга <= ДвиженияПредв.СуммаПосле
	                      |;
	                      |
	                      |////////////////////////////////////////////////////////////////////////////////
	                      |ВЫБРАТЬ
	                      |	ВЫБОР
	                      |		КОГДА Обороты.Регистратор.ЗаказКлиента = ЗНАЧЕНИЕ(Документ.ЗаказКлиента.ПустаяСсылка)
	                      |			ТОГДА Обороты.Регистратор
	                      |		ИНАЧЕ Обороты.Регистратор.ЗаказКлиента
	                      |	КОНЕЦ КАК Документ
	                      |ПОМЕСТИТЬ КешДокументыИзЗадолженностью
	                      |ИЗ
	                      |	ОборотыПоКлиенту КАК Обороты
	                      |		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ДвиженияОкончательные КАК ДвиженияОконч
	                      |		ПО Обороты.Партнер = ДвиженияОконч.Партнер
	                      |			И Обороты.Период >= ДвиженияОконч.Период
	                      |ГДЕ
	                      |	ВЫБОР
	                      |			КОГДА Обороты.Регистратор.ЗаказКлиента = ЗНАЧЕНИЕ(Документ.ЗаказКлиента.ПустаяСсылка)
	                      |				ТОГДА Обороты.Регистратор.Дата > &ДатаЗапрета
	                      |			ИНАЧЕ Обороты.Регистратор.ЗаказКлиента.Дата > &ДатаЗапрета
	                      |		КОНЕЦ
	                      |
	                      |СГРУППИРОВАТЬ ПО
	                      |	ВЫБОР
	                      |		КОГДА Обороты.Регистратор.ЗаказКлиента = ЗНАЧЕНИЕ(Документ.ЗаказКлиента.ПустаяСсылка)
	                      |			ТОГДА Обороты.Регистратор
	                      |		ИНАЧЕ Обороты.Регистратор.ЗаказКлиента
	                      |	КОНЕЦ
	                      |;
	                      |
	                      |////////////////////////////////////////////////////////////////////////////////
	                      |ВЫБРАТЬ
	                      |	Заказы.ЗаказКлиента КАК Документ
	                      |ПОМЕСТИТЬ КешНеОтгруженныеДокументы
	                      |ИЗ
	                      |	РегистрНакопления.ЗаказыКлиентов.Обороты(, , , ЗаказКлиента.Организация = &Организация) КАК Заказы
	                      |ГДЕ
	                      |	Заказы.КОформлениюОборот <> 0
	                      |
	                      |ОБЪЕДИНИТЬ ВСЕ
	                      |
	                      |ВЫБРАТЬ
	                      |	ВЫБОР
	                      |		КОГДА ТоварыКОтгрузке.ДокументОтгрузки.ЗаказКлиента = ЗНАЧЕНИЕ(Документ.ЗаказКлиента.ПустаяСсылка)
	                      |			ТОГДА ТоварыКОтгрузке.ДокументОтгрузки
	                      |		ИНАЧЕ ТоварыКОтгрузке.ДокументОтгрузки.ЗаказКлиента
	                      |	КОНЕЦ
	                      |ИЗ
	                      |	РегистрНакопления.ТоварыКОтгрузке.Остатки КАК ТоварыКОтгрузке
	                      |ГДЕ
	                      |	ТоварыКОтгрузке.ДокументОтгрузки ССЫЛКА Документ.РеализацияТоваровУслуг
	                      |;
	                      |
	                      |////////////////////////////////////////////////////////////////////////////////
	                      |ВЫБРАТЬ
	                      |	КешДокументыИзЗадолженностью.Документ
	                      |ПОМЕСТИТЬ КешОтгруженныеДокументыСЗадолженностью
	                      |ИЗ
	                      |	КешДокументыИзЗадолженностью КАК КешДокументыИзЗадолженностью
	                      |ГДЕ
	                      |	НЕ КешДокументыИзЗадолженностью.Документ В
	                      |				(ВЫБРАТЬ
	                      |					КешНеОтгруженныеДокументы.Документ
	                      |				ИЗ
	                      |					КешНеОтгруженныеДокументы)
	                      |;
	                      |
	                      |////////////////////////////////////////////////////////////////////////////////
	                      |ВЫБРАТЬ
	                      |	ЗаказыКлиентов.ЗаказКлиента КАК ДокументОснование,
	                      |	ЗаказыКлиентов.Номенклатура КАК Номенклатура,
	                      |	ЗаказыКлиентов.Склад КАК Склад,
	                      |	ЗаказыКлиентов.Регистратор КАК ДокументРеализации,
	                      |	ЗаказыКлиентов.КОформлениюРасход КАК Количество
	                      |ПОМЕСТИТЬ КешДокументы
	                      |ИЗ
	                      |	РегистрНакопления.ЗаказыКлиентов.Обороты(
	                      |			,
	                      |			,
	                      |			Регистратор,
	                      |			ЗаказКлиента В
	                      |				(ВЫБРАТЬ
	                      |					КешОтгруженныеДокументыСЗадолженностью.Документ
	                      |				ИЗ
	                      |					КешОтгруженныеДокументыСЗадолженностью
	                      |				ГДЕ
	                      |					КешОтгруженныеДокументыСЗадолженностью.Документ ССЫЛКА Документ.ЗаказКлиента)) КАК ЗаказыКлиентов
	                      |ГДЕ
	                      |	ЗаказыКлиентов.Регистратор ССЫЛКА Документ.РеализацияТоваровУслуг
	                      |
	                      |ОБЪЕДИНИТЬ ВСЕ
	                      |
	                      |ВЫБРАТЬ
	                      |	РеализацииТоваров.ЗаказКлиента,
	                      |	АналитикаНоменклатуры.Номенклатура,
	                      |	АналитикаНоменклатуры.Склад,
	                      |	РеализацииТоваров.ЗаказКлиента,
	                      |	РеализацииТоваров.КоличествоОборот
	                      |ИЗ
	                      |	РегистрНакопления.ВыручкаИСебестоимостьПродаж.Обороты(
	                      |			,
	                      |			,
	                      |			,
	                      |			ЗаказКлиента В
	                      |				(ВЫБРАТЬ
	                      |					КешОтгруженныеДокументыСЗадолженностью.Документ
	                      |				ИЗ
	                      |					КешОтгруженныеДокументыСЗадолженностью
	                      |				ГДЕ
	                      |					КешОтгруженныеДокументыСЗадолженностью.Документ ССЫЛКА Документ.РеализацияТоваровУслуг)) КАК РеализацииТоваров
	                      |		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.АналитикаУчетаНоменклатуры КАК АналитикаНоменклатуры
	                      |		ПО РеализацииТоваров.АналитикаУчетаНоменклатуры = АналитикаНоменклатуры.КлючАналитики
	                      |;
	                      |
	                      |////////////////////////////////////////////////////////////////////////////////
	                      |ВЫБРАТЬ
	                      |	КешДокументы.ДокументОснование,
	                      |	КешДокументы.ДокументОснование.Дата КАК ДатаОснования,
	                      |	ВЫБОР
	                      |		КОГДА КешДокументы.Склад.ИспользоватьОрдернуюСхемуПриОтгрузке
	                      |			ТОГДА ТоварыКОтгрузкеОбороты.Регистратор
	                      |		ИНАЧЕ КешДокументы.ДокументРеализации
	                      |	КОНЕЦ КАК Документ,
	                      |	КешДокументы.Номенклатура КАК Номенклатура,
	                      |	КешДокументы.Склад КАК Склад,
	                      |	КешДокументы.Количество
	                      |ПОМЕСТИТЬ КешДокументыОтгрузки
	                      |ИЗ
	                      |	КешДокументы КАК КешДокументы
	                      |		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.ТоварыКОтгрузке.Обороты(
	                      |				,
	                      |				,
	                      |				Регистратор,
	                      |				(ДокументОтгрузки, Номенклатура, Склад) В
	                      |					(ВЫБРАТЬ
	                      |						КешДокументы.ДокументРеализации,
	                      |						КешДокументы.Номенклатура,
	                      |						КешДокументы.Склад
	                      |					ИЗ
	                      |						КешДокументы КАК КешДокументы)) КАК ТоварыКОтгрузкеОбороты
	                      |		ПО КешДокументы.ДокументРеализации = ТоварыКОтгрузкеОбороты.ДокументОтгрузки
	                      |			И КешДокументы.Номенклатура = ТоварыКОтгрузкеОбороты.Номенклатура
	                      |			И КешДокументы.Склад = ТоварыКОтгрузкеОбороты.Склад
	                      |			И (ТоварыКОтгрузкеОбороты.Регистратор ССЫЛКА Документ.РасходныйОрдерНаТовары)
	                      |;
	                      |
	                      |////////////////////////////////////////////////////////////////////////////////
	                      |ВЫБРАТЬ
	                      |	ЦеныНоменклатурыСрезПоследних.Номенклатура,
	                      |	ЦеныНоменклатурыСрезПоследних.Цена
	                      |ПОМЕСТИТЬ КешЦеныНоменклатуры
	                      |ИЗ
	                      |	РегистрСведений.ЦеныНоменклатуры.СрезПоследних(
	                      |			,
	                      |			ВидЦены В (&ВидЦеныВходная)
	                      |				И Номенклатура В
	                      |					(ВЫБРАТЬ
	                      |						КешДокументыОтгрузки.Номенклатура
	                      |					ИЗ
	                      |						КешДокументыОтгрузки КАК КешДокументыОтгрузки)) КАК ЦеныНоменклатурыСрезПоследних
	                      |;
	                      |
	                      |////////////////////////////////////////////////////////////////////////////////
	                      |ВЫБРАТЬ
	                      |	КешДокументыОтгрузки.ДокументОснование,
	                      |	СУММА(КешДокументыОтгрузки.Количество * ЕСТЬNULL(КешЦеныНоменклатуры.Цена, 1)) КАК Сумма,
	                      |	КешДокументыОтгрузки.ДокументОснование.Дата КАК ДатаДокумента
	                      |ПОМЕСТИТЬ КешСуммаОснования
	                      |ИЗ
	                      |	КешДокументыОтгрузки КАК КешДокументыОтгрузки
	                      |		ЛЕВОЕ СОЕДИНЕНИЕ КешЦеныНоменклатуры КАК КешЦеныНоменклатуры
	                      |		ПО КешДокументыОтгрузки.Номенклатура = КешЦеныНоменклатуры.Номенклатура
	                      |
	                      |СГРУППИРОВАТЬ ПО
	                      |	КешДокументыОтгрузки.ДокументОснование,
	                      |	КешДокументыОтгрузки.ДокументОснование.Дата
	                      |;
	                      |
	                      |////////////////////////////////////////////////////////////////////////////////
	                      |ВЫБРАТЬ
	                      |	КешДокументыОтгрузки.Документ КАК ДокументОтгрузки,
	                      |	СУММА(КешДокументыОтгрузки.Количество * ЕСТЬNULL(КешЦеныНоменклатуры.Цена, 1)) КАК Сумма,
	                      |	КешДокументыОтгрузки.Документ.Дата КАК ДатаДокумента
	                      |ПОМЕСТИТЬ КешСуммаОтгрузки
	                      |ИЗ
	                      |	КешДокументыОтгрузки КАК КешДокументыОтгрузки
	                      |		ЛЕВОЕ СОЕДИНЕНИЕ КешЦеныНоменклатуры КАК КешЦеныНоменклатуры
	                      |		ПО КешДокументыОтгрузки.Номенклатура = КешЦеныНоменклатуры.Номенклатура
	                      |
	                      |СГРУППИРОВАТЬ ПО
	                      |	КешДокументыОтгрузки.Документ,
	                      |	КешДокументыОтгрузки.Документ.Дата
	                      |;
	                      |
	                      |////////////////////////////////////////////////////////////////////////////////
	                      |ВЫБРАТЬ
	                      |	КешДокументыОтгрузки.ДокументОснование КАК ДокументОснование,
	                      |	КешДокументыОтгрузки.ДокументОснование.Соглашение.ГрафикОплаты КАК ГрафикОплаты,
	                      |	РАЗНОСТЬДАТ(КешСуммаОснования.ДатаДокумента, КешСуммаОтгрузки.ДатаДокумента, ДЕНЬ) * (КешСуммаОтгрузки.Сумма / КешСуммаОснования.Сумма) КАК ДобавитьДней,
	                      |	КешДокументыОтгрузки.ДатаОснования
	                      |ПОМЕСТИТЬ КешЗГрафикомОплатыСГруппировками
	                      |ИЗ
	                      |	КешДокументыОтгрузки КАК КешДокументыОтгрузки
	                      |		ВНУТРЕННЕЕ СОЕДИНЕНИЕ КешСуммаОснования КАК КешСуммаОснования
	                      |		ПО КешДокументыОтгрузки.ДокументОснование = КешСуммаОснования.ДокументОснование
	                      |		ВНУТРЕННЕЕ СОЕДИНЕНИЕ КешСуммаОтгрузки КАК КешСуммаОтгрузки
	                      |		ПО КешДокументыОтгрузки.Документ = КешСуммаОтгрузки.ДокументОтгрузки
	                      |
	                      |СГРУППИРОВАТЬ ПО
	                      |	КешДокументыОтгрузки.ДокументОснование,
	                      |	КешДокументыОтгрузки.ДатаОснования,
	                      |	КешДокументыОтгрузки.ДокументОснование.Соглашение.ГрафикОплаты,
	                      |	РАЗНОСТЬДАТ(КешСуммаОснования.ДатаДокумента, КешСуммаОтгрузки.ДатаДокумента, ДЕНЬ) * (КешСуммаОтгрузки.Сумма / КешСуммаОснования.Сумма)
	                      |;
	                      |
	                      |////////////////////////////////////////////////////////////////////////////////
	                      |ВЫБРАТЬ
	                      |	КешЗГрафикомОплатыСГруппировками.ДокументОснование КАК ДокументОснование,
	                      |	КешЗГрафикомОплатыСГруппировками.ГрафикОплаты КАК ГрафикОплаты,
	                      |	СУММА(КешЗГрафикомОплатыСГруппировками.ДобавитьДней) КАК ДобавитьДней,
	                      |	КешЗГрафикомОплатыСГруппировками.ДатаОснования КАК ДатаОснования
	                      |ПОМЕСТИТЬ КешЗГрафикомОплаты
	                      |ИЗ
	                      |	КешЗГрафикомОплатыСГруппировками КАК КешЗГрафикомОплатыСГруппировками
	                      |
	                      |СГРУППИРОВАТЬ ПО
	                      |	КешЗГрафикомОплатыСГруппировками.ДокументОснование,
	                      |	КешЗГрафикомОплатыСГруппировками.ДатаОснования,
	                      |	КешЗГрафикомОплатыСГруппировками.ГрафикОплаты
	                      |;
	                      |
	                      |////////////////////////////////////////////////////////////////////////////////
	                      |ВЫБРАТЬ
	                      |	КешЗГрафикомОплаты.ДокументОснование КАК ДокументОснование,
	                      |	ДОБАВИТЬКДАТЕ(КешЗГрафикомОплаты.ДатаОснования, ДЕНЬ, (ВЫРАЗИТЬ(КешЗГрафикомОплаты.ДобавитьДней КАК ЧИСЛО(10, 0))) + ГрафикиОплатыЭтапы.Сдвиг) КАК ДатаПлатежа,
	                      |	ГрафикиОплатыЭтапы.НомерСтроки КАК НомерСтроки
	                      |ПОМЕСТИТЬ КешДокументыСДатойПлатежа
	                      |ИЗ
	                      |	КешЗГрафикомОплаты КАК КешЗГрафикомОплаты
	                      |		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.ГрафикиОплаты.Этапы КАК ГрафикиОплатыЭтапы
	                      |		ПО КешЗГрафикомОплаты.ГрафикОплаты = ГрафикиОплатыЭтапы.Ссылка
	                      |			И (ГрафикиОплатыЭтапы.ВариантОплаты = ЗНАЧЕНИЕ(Перечисление.ВариантыОплатыКлиентом.КредитПослеОтгрузки))
	                      |;
	                      |
	                      |////////////////////////////////////////////////////////////////////////////////
	                      |ВЫБРАТЬ
	                      |	ДокументыСДатойПлатежа.ДокументОснование КАК ДокументОснование,
	                      |	ДокументыСДатойПлатежа.ДатаПлатежа КАК ДатаПлатежа,
	                      |	ДокументыСДатойПлатежа.НомерСтроки КАК НомерСтроки
	                      |ИЗ
	                      |	КешДокументыСДатойПлатежа КАК ДокументыСДатойПлатежа
	                      |		ЛЕВОЕ СОЕДИНЕНИЕ ГрафикОплат КАК ГрафикОплатЗаказов
	                      |		ПО (ГрафикОплатЗаказов.Ссылка = ДокументыСДатойПлатежа.ДокументОснование)
	                      |ГДЕ
	                      |	ВЫБОР
	                      |			КОГДА ДокументыСДатойПлатежа.ДокументОснование ССЫЛКА Документ.ЗаказКлиента
	                      |				ТОГДА НАЧАЛОПЕРИОДА(ДокументыСДатойПлатежа.ДатаПлатежа, ДЕНЬ) <> НАЧАЛОПЕРИОДА(ГрафикОплатЗаказов.ДатаПлатежа, ДЕНЬ)
	                      |			ИНАЧЕ НАЧАЛОПЕРИОДА(ДокументыСДатойПлатежа.ДатаПлатежа, ДЕНЬ) <> НАЧАЛОПЕРИОДА(ДокументыСДатойПлатежа.ДокументОснование.ДатаПлатежа, ДЕНЬ)
	                      |		КОНЕЦ
	                      |ИТОГИ
	                      |	МИНИМУМ(ДатаПлатежа)
	                      |ПО
	                      |	ДокументОснование");
						  
	ДатаЗапрета = ПолучитьДатуЗапрета();						  
						  
	Запрос.УстановитьПараметр("ВидЦеныВходная", Справочники.ВидыЦен.ПолучитьСсылку(Новый УникальныйИдентификатор("8bdf84fb-404c-11e0-9f98-001517115d85")));
	Запрос.УстановитьПараметр("Организация", Справочники.Организации.ПолучитьСсылку(Новый УникальныйИдентификатор("0fba8a92-4010-11e0-9f98-001517115d85")));
	Запрос.УстановитьПараметр("ТекущаяДата", КонецДня(ТекущаяДата())+1);
	Запрос.УстановитьПараметр("ДатаЗапрета", ДатаЗапрета);

	ВыборкаДокументОснование = Запрос.Выполнить().Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
	
	Пока ВыборкаДокументОснование.Следующий() Цикл
		
		ДокументОбъект = ВыборкаДокументОснование.ДокументОснование.ПолучитьОбъект();
		Если ТипЗнч(ДокументОбъект) = Тип("ДокументОбъект.РеализацияТоваровУслуг") Тогда
			ДокументОбъект.ДатаПлатежа = ВыборкаДокументОснование.ДатаПлатежа;
		КонецЕсли;
		
		Если ТипЗнч(ДокументОбъект) = Тип("ДокументОбъект.ЗаказКлиента") Тогда
			ВыборкаДетальныеЗаписи  = ВыборкаДокументОснование.Выбрать();
			Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
				ДокументОбъект.ЭтапыГрафикаОплаты[ВыборкаДетальныеЗаписи.НомерСтроки-1].ДатаПлатежа = ВыборкаДетальныеЗаписи.ДатаПлатежа;
			КонецЦикла;
		КонецЕсли;
		
		НачатьТранзакцию();
		Попытка
			ДокументОбъект.Записать(РежимЗаписиДокумента.Проведение);
		Исключение
			ВызватьИсключение ОписаниеОшибки();
			ОтменитьТранзакцию();
			Продолжить;
		КонецПопытки;
		
		ЗафиксироватьТранзакцию();
		
	КонецЦикла;
	
КонецПроцедуры

#КонецОбласти 


#Область СлужебныеПроцедурыИФункции

Функция ПолучитьДатуЗапрета()

	ДатаЗапрета = Дата('20121016000000');
	
	Запрос = Новый Запрос("ВЫБРАТЬ
	                      |	ДатыЗапрета.ДатаЗапрета КАК ДатаЗапрета
	                      |ИЗ
	                      |	РегистрСведений.ДатыЗапретаИзменения КАК ДатыЗапрета
	                      |ГДЕ
	                      |	ДатыЗапрета.Пользователь = ЗНАЧЕНИЕ(Перечисление.ВидыНазначенияДатЗапрета.ДляВсехПользователей)");
						  
	Выборка = Запрос.Выполнить().Выбрать();
	Если Выборка.Следующий() Тогда
		Если Выборка.ДатаЗапрета > ДатаЗапрета Тогда
			ДатаЗапрета = Выборка.ДатаЗапрета;
		КонецЕсли;
	КонецЕсли;
	
	Возврат ДатаЗапрета;

КонецФункции // ПолучитьДатуЗапрета()

// Получает текст запроса для выполнения актуализаци даты расчета пени.
//
// Возвращаемое значение:
//  Строка - Текст запроса.
Функция ТекстЗапросаАктуализации()

	ТекстЗапроса = "
					// 0. Партнеры для которых установлено галочка «Включить доступ к пене».
					////////////////////////////////////////////////////////////////////////////////
					|ВЫБРАТЬ
					|	Ссылка КАК Партнер
					|ПОМЕСТИТЬ ПартнерыОптовогоОтдела
					|ИЗ
					|	Справочник.Партнеры.ДополнительныеРеквизиты
					|ГДЕ 
					|	Свойство 	= &ДоступКПене
					|	И Значение  = ИСТИНА
					|;
					|
					// 1. Места которые были отгружены сегодня.
					////////////////////////////////////////////////////////////////////////////////
					|ВЫБРАТЬ
					|	Место КАК Место
					|ПОМЕСТИТЬ ОтгруженныеМеста
					|ИЗ
					|	РегистрСведений.ОтгрузкаМест.СрезПоследних(
					|			,
					|			Период >= &НачалоСегодняшнегоДня
					|				И Место.Владелец В
					|					(ВЫБРАТЬ
					|						Партнер
					|					ИЗ
					|						ПартнерыОптовогоОтдела))
					|ГДЕ
					|	СтатусОтгрузки = &СтатусОтгрузки
					|;
					|
					// 2.
					////////////////////////////////////////////////////////////////////////////////
					|УНИЧТОЖИТЬ ПартнерыОптовогоОтдела;
					|
					// 3. Документы, спомощью которых отгружались места: Расходный ордер на товары,
					//    Отгрузка товаров из безордерных складов
					////////////////////////////////////////////////////////////////////////////////
					|ВЫБРАТЬ
					|	МестаПоДокументам.Документ КАК Документ
					|ПОМЕСТИТЬ ДокументыОтгрузки
					|ИЗ
					|	ОтгруженныеМеста КАК ОтгруженныеМеста
					|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.МестаПоДокументам КАК МестаПоДокументам
					|		ПО ОтгруженныеМеста.Место = МестаПоДокументам.Место
					|;
					|
					// 4.
					////////////////////////////////////////////////////////////////////////////////
					|УНИЧТОЖИТЬ ОтгруженныеМеста;
					|
					// 5. На основании документов отгрузки получаем документы «Реализация товаров и услуг»
					////////////////////////////////////////////////////////////////////////////////
					|ВЫБРАТЬ
					|	ВЫБОР
					|		КОГДА Документ ССЫЛКА Документ.РасходныйОрдерНаТовары
					|			ТОГДА ВЫРАЗИТЬ(Документ КАК Документ.РасходныйОрдерНаТовары).Распоряжение
					|		КОГДА Документ ССЫЛКА Документ.КТС_ОтгрузкаТоваров
					|			ТОГДА ВЫРАЗИТЬ(Документ КАК Документ.РасходныйОрдерНаТовары).Распоряжение
					|	КОНЕЦ КАК ДокументРеализации
					|ПОМЕСТИТЬ ДокументыРеализации
					|ИЗ
					|	ДокументыОтгрузки
					|;
					|
					// 6.
					////////////////////////////////////////////////////////////////////////////////
					|УНИЧТОЖИТЬ ДокументыОтгрузки;
					|
					//7. Если реализации были созданы на основании заказа - получаем заказы.
					////////////////////////////////////////////////////////////////////////////////
					|ВЫБРАТЬ РАЗЛИЧНЫЕ
					|	ВЫБОР
					|		КОГДА ВЫРАЗИТЬ(ДокументРеализации КАК Документ.РеализацияТоваровУслуг).ЗаказКлиента = ЗНАЧЕНИЕ(Документ.ЗаказКлиента.ПустаяСсылка)
					|			ТОГДА ВЫРАЗИТЬ(ДокументРеализации КАК Документ.РеализацияТоваровУслуг)
					|		ИНАЧЕ ВЫРАЗИТЬ(ДокументРеализации КАК Документ.РеализацияТоваровУслуг).ЗаказКлиента
					|	КОНЕЦ КАК Документ
					|ПОМЕСТИТЬ ДокументыПродажы
					|ИЗ
					|	ДокументыРеализации
					|ГДЕ
					|	ДокументРеализации ССЫЛКА Документ.РеализацияТоваровУслуг
					|;
					|
					// 8.
					////////////////////////////////////////////////////////////////////////////////
					|УНИЧТОЖИТЬ ДокументыРеализации;
					|
					// 9. Получаем заказы клиентов, которые еще не были отгружены.
					|////////////////////////////////////////////////////////////////////////////////
					|ВЫБРАТЬ
					|	ЗаказКлиента КАК ЗаказКлиента
					|ПОМЕСТИТЬ НеОтгруженныеЗаказы
					|ИЗ
					|	РегистрНакопления.ЗаказыКлиентов.Остатки(
					|			,
					|			ЗаказКлиента В
					|				(ВЫБРАТЬ
					|					Документ
					|				ИЗ
					|					ДокументыПродажы
					|				ГДЕ
					|					Документ ССЫЛКА Документ.ЗаказКлиента))
					|;
					|
					// 10. Список полность отгруженных заказов клиента из ссылками на графики оплат.
					////////////////////////////////////////////////////////////////////////////////
					|ВЫБРАТЬ
					|	Документ КАК Документ,
					|	ВЫБОР
					|		КОГДА ВЫРАЗИТЬ(Документ КАК Документ.ЗаказКлиента).ГрафикОплаты = ЗНАЧЕНИЕ(Справочник.ГрафикиОплаты.ПустаяСсылка)
					|			ТОГДА ВЫРАЗИТЬ(Документ КАК Документ.ЗаказКлиента).Соглашение.ГрафикОплаты
					|		ИНАЧЕ ВЫРАЗИТЬ(Документ КАК Документ.ЗаказКлиента).ГрафикОплаты
					|	КОНЕЦ КАК ГрафикОплаты
					|ПОМЕСТИТЬ ОтгруженныеЗаказы
					|ИЗ
					|	ДокументыПродажы
					|ГДЕ
					|	Документ ССЫЛКА Документ.ЗаказКлиента
					|	И Документ НЕ В
					|				(ВЫБРАТЬ
					|					ЗаказКлиента
					|				ИЗ
					|					НеОтгруженныеЗаказы)
					|;
					|
					// 11.
					////////////////////////////////////////////////////////////////////////////////
					|УНИЧТОЖИТЬ НеОтгруженныеЗаказы;
					|
					// 12. Список неотгруженных реализаций.
					////////////////////////////////////////////////////////////////////////////////
					|ВЫБРАТЬ
					|	ВЫРАЗИТЬ(ДокументОтгрузки КАК Документ.РеализацияТоваровУслуг) КАК Документ
					|ПОМЕСТИТЬ НеОтгруженныеРеализации
					|ИЗ
					|	РегистрНакопления.ТоварыКОтгрузке.Остатки(
					|			,
					|			ДокументОтгрузки В
					|				(ВЫБРАТЬ
					|					Документ
					|				ИЗ
					|					ДокументыПродажы
					|				ГДЕ
					|					Документ ССЫЛКА Документ.РеализацияТоваровУслуг))
					|;
					|
					// 13. Список полностью отгруженных реализаций из графиками оплаты и датамы платежей.
					|////////////////////////////////////////////////////////////////////////////////
					|ВЫБРАТЬ
					|	Документ 							КАК Документ,
					|	Документ.Соглашение.ГрафикОплаты 	КАК ГрафикОплаты,
					|	Документ.ДатаПлатежа 				КАК ДатаПлатежа
					|ПОМЕСТИТЬ ОтгруженныеРеализации
					|ИЗ
					|	ДокументыПродажы
					|ГДЕ
					|	Документ ССЫЛКА Документ.РеализацияТоваровУслуг
					|	И НЕ ДокументыПродажы.Документ В
					|				(ВЫБРАТЬ
					|					Документ
					|				ИЗ
					|					НеОтгруженныеРеализации)
					|;
					|
					// 14.
					////////////////////////////////////////////////////////////////////////////////
					|УНИЧТОЖИТЬ ДокументыПродажы;
					|
					// 15.
					////////////////////////////////////////////////////////////////////////////////
					|УНИЧТОЖИТЬ НеОтгруженныеРеализации;
					|
					// 16. Получаем даты платежа по графику оплаты в реализациях которые были 
					//     сделаны не на основании заказов.
					////////////////////////////////////////////////////////////////////////////////
					|ВЫБРАТЬ
					|	ГрафикиОплатыЭтапы.Ссылка			КАК Ссылка,
					|	ГрафикиОплатыЭтапы.Ссылка.Календарь	КАК Календарь,
					|	МАКСИМУМ(ГрафикиОплатыЭтапы.Сдвиг) 	КАК Сдвиг,
					|	НАЧАЛОПЕРИОДА(ДОБАВИТЬКДАТЕ(&НачалоСегодняшнегоДня, ДЕНЬ, ЕСТЬNULL(МАКСИМУМ(ГрафикиОплатыЭтапы.Сдвиг), 0)), ДЕНЬ) КАК ДатаПлатежа
					|ПОМЕСТИТЬ ДатаОплатыРеализацийПоГрафику
					|	ИЗ
					|	ОтгруженныеРеализации КАК ОтгруженныеРеализации
					|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.ГрафикиОплаты.Этапы КАК ГрафикиОплатыЭтапы
					|		ПО ОтгруженныеРеализации.ГрафикОплаты = ГрафикиОплатыЭтапы.Ссылка
					|			И (ГрафикиОплатыЭтапы.ВариантОплаты = ЗНАЧЕНИЕ(Перечисление.ВариантыОплатыКлиентом.КредитПослеОтгрузки))
					|
					|СГРУППИРОВАТЬ ПО
					|	ГрафикиОплатыЭтапы.Ссылка,
					|	ГрафикиОплатыЭтапы.Ссылка.Календарь
					|;
					|
					// 17. Получаем крайние точки календарей (фактически получаем сколько рабочих дней в году).
					////////////////////////////////////////////////////////////////////////////////
					|ВЫБРАТЬ
					|	КалендарныеГрафики.Календарь									КАК Календарь,
					|	КалендарныеГрафики.Год											КАК Год,
					|	МАКСИМУМ(КалендарныеГрафики.КоличествоДнейВГрафикеСНачалаГода) 	КАК КоличествоДней
					|ПОМЕСТИТЬ КалендариКрайниеТочки
					|ИЗ
					|	РегистрСведений.КалендарныеГрафики КАК КалендарныеГрафики
					|ГДЕ
					|	КалендарныеГрафики.ДатаГрафика >= &НачалоСегодняшнегоДня
					|	И КалендарныеГрафики.ДеньВключенВГрафик
					|
					|СГРУППИРОВАТЬ ПО
					|	КалендарныеГрафики.Календарь,
					|	КалендарныеГрафики.Год
					|;
					|
					// 18. Для облегчения расчета даты платежа нам необходимо расчитать смещение,
					//     чтобы нумерация дней вы календаре начиналась с 0.
					////////////////////////////////////////////////////////////////////////////////
					|ВЫБРАТЬ
					|	КалендарныеГрафики.Календарь									КАК Календарь,
					|	МИНИМУМ(КалендарныеГрафики.КоличествоДнейВГрафикеСНачалаГода) 	КАК Смещение
					|ПОМЕСТИТЬ ТаблицаСмещений
					|ИЗ
					|	РегистрСведений.КалендарныеГрафики КАК КалендарныеГрафики
					|ГДЕ
					|	КалендарныеГрафики.ДатаГрафика > &НачалоСегодняшнегоДня
					|	И КалендарныеГрафики.ДеньВключенВГрафик
					|
					|СГРУППИРОВАТЬ ПО
					|	КалендарныеГрафики.Календарь
					|;
					|
					// 19. Сколько дней нужно добавить к дате платежа, если она попадает в следующий год.
					////////////////////////////////////////////////////////////////////////////////
					|ВЫБРАТЬ
					|	КалендариКрайниеТочки.Календарь									КАК Календарь,
					|	КалендариКрайниеТочки.Год										КАК Год,
					|	СУММА(ЕСТЬNULL(КалендариКрайниеТочкиКопия.КоличествоДней, 0)) 	КАК КоличествоДней
					|ПОМЕСТИТЬ КалендариНаростающие
					|ИЗ
					|	КалендариКрайниеТочки КАК КалендариКрайниеТочки
					|		ЛЕВОЕ СОЕДИНЕНИЕ КалендариКрайниеТочки КАК КалендариКрайниеТочкиКопия
					|		ПО КалендариКрайниеТочки.Календарь = КалендариКрайниеТочкиКопия.Календарь
					|			И КалендариКрайниеТочки.Год > КалендариКрайниеТочкиКопия.Год
					|
					|СГРУППИРОВАТЬ ПО
					|	КалендариКрайниеТочки.Календарь,
					|	КалендариКрайниеТочки.Год
					|;
					|
					// 20.
					////////////////////////////////////////////////////////////////////////////////
					|УНИЧТОЖИТЬ КалендариКрайниеТочки;
					|
					// 21. Получаем сколько дней от сегодняшней даты до любой даты в календаре.
					////////////////////////////////////////////////////////////////////////////////
					|ВЫБРАТЬ
					|	КалендарныеГрафики.Календарь		КАК Календарь,
					|	КалендарныеГрафики.ДатаГрафика		КАК ДатаГрафика,
					|	КалендарныеГрафики.КоличествоДнейВГрафикеСНачалаГода + КалендариНаростающие.КоличествоДней - ТаблицаСмещений.Смещение + 1 КАК КоличествоДней
					|ПОМЕСТИТЬ КалендариПоДням
					|ИЗ
					|	РегистрСведений.КалендарныеГрафики КАК КалендарныеГрафики
					|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ КалендариНаростающие КАК КалендариНаростающие
					|		ПО КалендарныеГрафики.Календарь = КалендариНаростающие.Календарь
					|			И КалендарныеГрафики.Год = КалендариНаростающие.Год
					|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ТаблицаСмещений КАК ТаблицаСмещений
					|		ПО КалендарныеГрафики.Календарь = ТаблицаСмещений.Календарь
					|ГДЕ
					|	КалендарныеГрафики.ДатаГрафика >= &НачалоСегодняшнегоДня
					|	И КалендарныеГрафики.ДеньВключенВГрафик
					|;
					|
					// 22.
					////////////////////////////////////////////////////////////////////////////////
					|УНИЧТОЖИТЬ КалендариНаростающие;
					|
					// 23.
					////////////////////////////////////////////////////////////////////////////////
					|УНИЧТОЖИТЬ ТаблицаСмещений;
					|
					// 24. Если в соглашении используют календари для расчета дата платежа,
					//     используем дату по календарю. 
					////////////////////////////////////////////////////////////////////////////////
					|ВЫБРАТЬ
					|	ДатаОплатыРеализацийПоГрафику.Ссылка КАК ГрафикОплат,
					|	ВЫБОР
					|		КОГДА ДатаОплатыРеализацийПоГрафику.Календарь = ЗНАЧЕНИЕ(Справочник.ПроизводственныеКалендари.ПустаяСсылка)
					|			ТОГДА ДатаОплатыРеализацийПоГрафику.ДатаПлатежа
					|		ИНАЧЕ КалендариПоДням.ДатаГрафика
					|	КОНЕЦ КАК ДатаПлатежа
					|ПОМЕСТИТЬ ДатыПлатежейРеализаций
					|ИЗ
					|	ДатаОплатыРеализацийПоГрафику КАК ДатаОплатыРеализацийПоГрафику
					|		ЛЕВОЕ СОЕДИНЕНИЕ КалендариПоДням КАК КалендариПоДням
					|		ПО ДатаОплатыРеализацийПоГрафику.Календарь = КалендариПоДням.Календарь
					|			И ДатаОплатыРеализацийПоГрафику.Сдвиг = КалендариПоДням.КоличествоДней
					|;
					|
					// 25.
					////////////////////////////////////////////////////////////////////////////////
					|УНИЧТОЖИТЬ ДатаОплатыРеализацийПоГрафику;
					|
					// 26. Отбираем только те реализции в которых нужно изменить дату платежа.
					////////////////////////////////////////////////////////////////////////////////
					|ВЫБРАТЬ
					|	ОтгруженныеРеализации.Документ КАК Документ,
					|	ВЫБОР
					|		КОГДА ДатыПлатежейРеализаций.ДатаПлатежа ЕСТЬ NULL 
					|			ТОГДА ОтгруженныеРеализации.ДатаПлатежа
					|		ИНАЧЕ ДатыПлатежейРеализаций.ДатаПлатежа
					|	КОНЕЦ КАК ДатаПлатежа
					|ИЗ
					|	ОтгруженныеРеализации КАК ОтгруженныеРеализации
					|		ЛЕВОЕ СОЕДИНЕНИЕ ДатыПлатежейРеализаций КАК ДатыПлатежейРеализаций
					|		ПО ОтгруженныеРеализации.ГрафикОплаты = ДатыПлатежейРеализаций.ГрафикОплат
					|ГДЕ
					|	ОтгруженныеРеализации.ДатаПлатежа <> ЕСТЬNULL(ДатыПлатежейРеализаций.ДатаПлатежа, ДАТАВРЕМЯ(1, 1, 1))
					|;
					|
					// 27.
					////////////////////////////////////////////////////////////////////////////////
					|УНИЧТОЖИТЬ ОтгруженныеРеализации;
					|
					// 28.
					////////////////////////////////////////////////////////////////////////////////
					|УНИЧТОЖИТЬ ДатыПлатежейРеализаций;
					|
					// 29. Получаем даты платежа по графикам оплаты из заказов клиента.
					////////////////////////////////////////////////////////////////////////////////
					|ВЫБРАТЬ
					|	ГрафикиОплатыЭтапы.Ссылка				КАК Ссылка,
					|	ГрафикиОплатыЭтапы.Ссылка.Календарь		КАК Календарь,
					|	МАКСИМУМ(ГрафикиОплатыЭтапы.Сдвиг) 		КАК Сдвиг,
					|	НАЧАЛОПЕРИОДА(ДОБАВИТЬКДАТЕ(&НачалоСегодняшнегоДня, ДЕНЬ, ЕСТЬNULL(МАКСИМУМ(ГрафикиОплатыЭтапы.Сдвиг), 0)), ДЕНЬ) КАК ДатаПлатежа
					|ПОМЕСТИТЬ ДатаОплатыЗаказовПоГрафику
					|ИЗ
					|	ОтгруженныеЗаказы КАК ОтгруженныеЗаказы
					|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.ГрафикиОплаты.Этапы КАК ГрафикиОплатыЭтапы
					|		ПО ОтгруженныеЗаказы.ГрафикОплаты = ГрафикиОплатыЭтапы.Ссылка
					|			И (ГрафикиОплатыЭтапы.ВариантОплаты = ЗНАЧЕНИЕ(Перечисление.ВариантыОплатыКлиентом.КредитПослеОтгрузки))
					|
					|СГРУППИРОВАТЬ ПО
					|	ГрафикиОплатыЭтапы.Ссылка,
					|	ГрафикиОплатыЭтапы.Ссылка.Календарь
					|;
					|
					// 30. Если в графику оплаты используется календарь для расчета даты оплаты - расчитываем по календарю.
					////////////////////////////////////////////////////////////////////////////////
					|ВЫБРАТЬ
					|	ДатаОплатыЗаказовПоГрафику.Ссылка КАК ГрафикОплат,
					|	ВЫБОР
					|		КОГДА ДатаОплатыЗаказовПоГрафику.Календарь = ЗНАЧЕНИЕ(Справочник.ПроизводственныеКалендари.ПустаяСсылка)
					|			ТОГДА ДатаОплатыЗаказовПоГрафику.ДатаПлатежа
					|		ИНАЧЕ КалендариПоДням.ДатаГрафика
					|	КОНЕЦ КАК ДатаПлатежа
					|ПОМЕСТИТЬ ДатыПлатежейЗаказов
					|ИЗ
					|	ДатаОплатыЗаказовПоГрафику КАК ДатаОплатыЗаказовПоГрафику
					|		ЛЕВОЕ СОЕДИНЕНИЕ КалендариПоДням КАК КалендариПоДням
					|		ПО ДатаОплатыЗаказовПоГрафику.Календарь = КалендариПоДням.Календарь
					|			И ДатаОплатыЗаказовПоГрафику.Сдвиг = КалендариПоДням.КоличествоДней
					|;
					|
					// 31.
					////////////////////////////////////////////////////////////////////////////////
					|УНИЧТОЖИТЬ КалендариПоДням;
					|
					// 32.
					////////////////////////////////////////////////////////////////////////////////
					|УНИЧТОЖИТЬ ДатаОплатыЗаказовПоГрафику;
					|
					// 33. Расчитываем новые даты платежей для заказов клиентов.
					////////////////////////////////////////////////////////////////////////////////
					|ВЫБРАТЬ
					|	ОтгруженныеЗаказы.Документ		КАК Документ,
					|	ДатыПлатежейЗаказов.ДатаПлатежа КАК ДатаПлатежа
					|ПОМЕСТИТЬ ДатыОплаченныхЗаказов
					|ИЗ
					|	ОтгруженныеЗаказы КАК ОтгруженныеЗаказы
					|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ДатыПлатежейЗаказов КАК ДатыПлатежейЗаказов
					|		ПО ОтгруженныеЗаказы.ГрафикОплаты = ДатыПлатежейЗаказов.ГрафикОплат
					|;
					|
					// 34.
					////////////////////////////////////////////////////////////////////////////////
					|УНИЧТОЖИТЬ ДатыПлатежейЗаказов;
					|
					// 35.
					////////////////////////////////////////////////////////////////////////////////
					|УНИЧТОЖИТЬ ОтгруженныеЗаказы;
					|
					// 36. Получаем уже установленные даты оплаты в документах-заказах.
					////////////////////////////////////////////////////////////////////////////////
					|ВЫБРАТЬ
					|	ДатыОплаченныхЗаказов.Документ						КАК Документ,
					|	МИНИМУМ(ЗаказКлиентаЭтапыГрафикаОплаты.ДатаПлатежа) КАК ДатаПлатежа
					|ПОМЕСТИТЬ ТекущиеДатыОплатПоЗаказам
					|ИЗ
					|	ДатыОплаченныхЗаказов КАК ДатыОплаченныхЗаказов
					|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ЗаказКлиента.ЭтапыГрафикаОплаты КАК ЗаказКлиентаЭтапыГрафикаОплаты
					|		ПО ДатыОплаченныхЗаказов.Документ = ЗаказКлиентаЭтапыГрафикаОплаты.Ссылка
					|			И (ЗаказКлиентаЭтапыГрафикаОплаты.ВариантОплаты = ЗНАЧЕНИЕ(Перечисление.ВариантыОплатыКлиентом.КредитПослеОтгрузки))
					|
					|СГРУППИРОВАТЬ ПО
					|	ДатыОплаченныхЗаказов.Документ
					|;
					|
					// 37. Получаем только те заказы, в которых нужно изменить даты платежей.
					////////////////////////////////////////////////////////////////////////////////
					|ВЫБРАТЬ
					|	ДатыОплаченныхЗаказов.Документ КАК Документ,
					|	ВЫБОР
					|		КОГДА ДатыОплаченныхЗаказов.ДатаПлатежа ЕСТЬ NULL 
					|			ТОГДА ТекущиеДатыОплатПоЗаказам.ДатаПлатежа
					|		ИНАЧЕ ДатыОплаченныхЗаказов.ДатаПлатежа
					|	КОНЕЦ КАК ДатаПлатежа
					|ИЗ
					|	ТекущиеДатыОплатПоЗаказам КАК ТекущиеДатыОплатПоЗаказам
					|		ЛЕВОЕ СОЕДИНЕНИЕ ДатыОплаченныхЗаказов КАК ДатыОплаченныхЗаказов
					|		ПО (ДатыОплаченныхЗаказов.Документ = ТекущиеДатыОплатПоЗаказам.Документ)
					|ГДЕ
					|	ЕСТЬNULL(ДатыОплаченныхЗаказов.ДатаПлатежа, ДАТАВРЕМЯ(1, 1, 1)) <> ТекущиеДатыОплатПоЗаказам.ДатаПлатежа
					|;
					|
					// 38.
					////////////////////////////////////////////////////////////////////////////////
					|УНИЧТОЖИТЬ ДатыОплаченныхЗаказов;
					|
					////////////////////////////////////////////////////////////////////////////////
					|УНИЧТОЖИТЬ ТекущиеДатыОплатПоЗаказам;";
	
	Возврат ТекстЗапроса;

КонецФункции // ПолучитьТекстЗапросаАктуализации()
 
 
#КонецОбласти


#Область СведенияОВнешнейОбработке

Функция СведенияОВнешнейОбработке() Экспорт
	
	Версия = "2.0.002";
	
	// Объявим переменную, в которой мы сохраним и вернем "наружу" необходимые данные
    ПараметрыРегистрации = Новый Структура;

    // Объявим еще одну переменную, которая нам потребуется ниже
    МассивНазначений = Новый Массив;
    
    // Первый параметр, который мы должны указать - это какой вид обработки системе должна зарегистрировать. 
    // Допустимые типы: ДополнительнаяОбработка, ДополнительныйОтчет, ЗаполнениеОбъекта, Отчет, ПечатнаяФорма, СозданиеСвязанныхОбъектов
    ПараметрыРегистрации.Вставить("Вид", "ДополнительнаяОбработка");	
	ПараметрыРегистрации.Вставить("Назначение", Новый Массив);
    
    // Теперь зададим имя, под которым ВПФ будет зарегистрирована в справочнике внешних обработок
    ПараметрыРегистрации.Вставить("Наименование", "Регл. актуализация даты расчета пени [" + Версия + "]");
    
    // Зададим право обработке на использование безопасного режима. Более подробно можно узнать в справке к платформе (метод УстановитьБезопасныйРежим)
    ПараметрыРегистрации.Вставить("БезопасныйРежим", Ложь);

    // Следующие два параметра играют больше информационную роль, т.е. это то, что будет видеть пользователь в информации к обработке
    ПараметрыРегистрации.Вставить("Версия", Версия);    
    ПараметрыРегистрации.Вставить("Информация", "Регл. актуализация даты расчета пени [" + Версия + "]");
    
    // Создадим таблицу команд (подробнее смотрим ниже)
    ТаблицаКоманд = ПолучитьТаблицуКоманд();
    
    // Добавим команду в таблицу
	ДобавитьКоманду(ТаблицаКоманд, "Регл. актуализация даты расчета пени [" + Версия + "]", "ВыполнитьАктуализацию();", "ВызовСерверногоМетода");
    
    // Сохраним таблицу команд в параметры регистрации обработки
    ПараметрыРегистрации.Вставить("Команды", ТаблицаКоманд);
    
    // Теперь вернем системе наши параметры
    Возврат ПараметрыРегистрации;
	
КонецФункции

Функция ПолучитьТаблицуКоманд()

   // Создадим пустую таблицу команд и колонки в ней
   Команды = Новый ТаблицаЗначений;

   // Как будет выглядеть описание печатной формы для пользователя
   Команды.Колонки.Добавить("Представление", Новый ОписаниеТипов("Строка")); 

   // Имя нашего макета, что бы могли отличить вызванную команду в обработке печати
   Команды.Колонки.Добавить("Идентификатор", Новый ОписаниеТипов("Строка"));

   // Тут задается, как должна вызваться команда обработки
   // Возможные варианты:
   // - ОткрытиеФормы - в этом случае в колонке идентификатор должно быть указано имя формы, которое должна будет открыть система
   // - ВызовКлиентскогоМетода - вызвать клиентскую экспортную процедуру из модуля формы обработки
   // - ВызовСерверногоМетода - вызвать серверную экспортную процедуру из модуля объекта обработки
   Команды.Колонки.Добавить("Использование", Новый ОписаниеТипов("Строка"));

   // Следующий параметр указывает, необходимо ли показывать оповещение при начале и завершению работы обработки. Не имеет смысла при открытии формы
   Команды.Колонки.Добавить("ПоказыватьОповещение", Новый ОписаниеТипов("Булево"));

   // Для печатной формы должен содержать строку ПечатьMXL 
   Команды.Колонки.Добавить("Модификатор", Новый ОписаниеТипов("Строка"));
   
   Возврат Команды;
   
КонецФункции

Процедура ДобавитьКоманду(ТаблицаКоманд, Представление, Идентификатор, Использование, ПоказыватьОповещение = Ложь, Модификатор = "")
  // Добавляем команду в таблицу команд по переданному описанию.
  // Параметры и их значения можно посмотреть в функции ПолучитьТаблицуКоманд
  НоваяКоманда = ТаблицаКоманд.Добавить();
  НоваяКоманда.Представление = Представление;
  НоваяКоманда.Идентификатор = Идентификатор;
  НоваяКоманда.Использование = Использование;
  НоваяКоманда.ПоказыватьОповещение = ПоказыватьОповещение;
  НоваяКоманда.Модификатор = Модификатор;

КонецПроцедуры

Процедура ВыполнитьКоманду(Индентификатор) Экспорт
	Выполнить(Индентификатор);	
КонецПроцедуры

#КонецОбласти 