
#Область ПрограммныйИнтерфейс

Процедура ВыполнитьОбновлениеРентабельности(Период = Неопределено) Экспорт
	
	Если Период <> Неопределено Тогда
		НачалоПериода = НачалоМесяца(Период);
		КонецПериода = КонецМесяца(Период);
	Иначе
		ТекущаяДата = ТекущаяДатаСеанса();
		НачалоПериода = НачалоМесяца(ТекущаяДата);
		КонецПериода = КонецМесяца(ТекущаяДата);
	КонецЕсли;
	
	Запрос = Новый Запрос;
	Запрос.Текст = ПолучитьТекстЗапросаРентабельностиЗаявокСервисногоЦентра();
	Запрос.УстановитьПараметр("НачалоПериода", НачалоПериода);
	Запрос.УстановитьПараметр("КонецПериода", КонецПериода);
	РезультатЗапроса = Запрос.Выполнить();
	
	Если РезультатЗапроса.Пустой() = Ложь Тогда
		
		Выборка = РезультатЗапроса.Выбрать();
		Пока Выборка.Следующий() Цикл
			
			НаборЗаписей = РегистрыНакопления.РентабельностьЗаявокСервисногоЦентра.СоздатьНаборЗаписей();
			НаборЗаписей.Отбор.Регистратор.Установить(Выборка.Регистратор);
			ЗаполнитьЗначенияСвойств(НаборЗаписей.Добавить(), Выборка);
			//НоваяЗапись.Период = 
			
			НаборЗаписей.Записать();
			
		КонецЦикла;
		
	КонецЕсли;
	
КонецПроцедуры // ВыполнитьОбновлениеРентабельности()

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

Функция ПолучитьТекстЗапросаРентабельностиЗаявокСервисногоЦентра()
	
	ТекстЗапроса = "
		////////////////////////////////////////////////////////////////////////////////////////////
		// 0. Удаленные заявки в выборку не попадают
		|ВЫБРАТЬ 
		|	*
		|ПОМЕСТИТЬ ЗаявкиСервисногоЦентраВПериоде
		|ИЗ
		|	РегистрСведений.ГНАТ_ЭтапыРаботЗаявокСервисногоЦентра.СрезПоследних КАК ЭтапыРабот
		|ГДЕ
		|	ЭтапыРабот.Период >= &НачалоПериода
		|И	ЭтапыРабот.Период <= &КонецПериода
		|
		|ИНДЕКСИРОВАТЬ ПО
		|	ЗаявкаСервисногоЦентра	
		|;
		////////////////////////////////////////////////////////////////////////////////////////////
		// 1. Получаем партнеров, по которым не считаем рентабельность документа "Заяка сервисного центра"
		|ВЫБРАТЬ
		|	Партнер
		|ПОМЕСТИТЬ КешВендоры
		|ИЗ
		|	РегистрСведений.ГНАТ_ВендорыСервисногоЦентра
		|ГДЕ
		|	УчитыватьПриРасчетеРентабельности = Ложь
		|	
		|ИНДЕКСИРОВАТЬ ПО
		|	Партнер	
		|;
		////////////////////////////////////////////////////////////////////////////////////////////
		// 2. Получаем список документов продаж по документам "Заявка сервисного центра"
		|ВЫБРАТЬ
		|	ЗаявкиСервисногоЦентраВПериоде.ЗаявкаСервисногоЦентра КАК ЗаявкаСервисногоЦентра,
		|	РТиУ.Ссылка	КАК Регистратор,
		|	ВЫБОР
		|		КОГДА IsNull(РТиУ.Соглашение.ИспользуютсяДоговорыКонтрагентов, Ложь) = Истина
		|		ТОГДА 	ВЫБОР
		|					КОГДА РТиУ.Договор.ПорядокРасчетов = ЗНАЧЕНИЕ(Перечисление.ПорядокРасчетов.ПоНакладным)
		|					ТОГДА РТиУ.Ссылка
		|					КОГДА РТиУ.Соглашение.ПорядокРасчетов = ЗНАЧЕНИЕ(Перечисление.ПорядокРасчетов.ПоЗаказамНакладным)
		|					ТОГДА  	ВЫБОР
		|								КОГДА РТиУ.ЗаказКлиента = ЗНАЧЕНИЕ(Документ.ЗаказКлиента.ПустаяСсылка)
		|					 			 ИЛИ  РТиУ.ЗаказКлиента = Неопределено
		|								ТОГДА РТиУ.Ссылка
		|								ИНАЧЕ РТиУ.ЗаказКлиента
		|							КОНЕЦ
		|					ИНАЧЕ РТиУ.Договор
		|				КОНЕЦ 
		|		КОГДА РТиУ.Соглашение.ПорядокРасчетов = ЗНАЧЕНИЕ(Перечисление.ПорядокРасчетов.ПоНакладным)
		|		ТОГДА РТиУ.Ссылка
		|		КОГДА РТиУ.Соглашение.ПорядокРасчетов = ЗНАЧЕНИЕ(Перечисление.ПорядокРасчетов.ПоЗаказамНакладным)
		|		ТОГДА 	ВЫБОР
		|					КОГДА РТиУ.ЗаказКлиента = ЗНАЧЕНИЕ(Документ.ЗаказКлиента.ПустаяСсылка)
		|					 ИЛИ  РТиУ.ЗаказКлиента = Неопределено
		|					ТОГДА РТиУ.Ссылка
		|					ИНАЧЕ РТиУ.ЗаказКлиента
		|				КОНЕЦ
		|	КОНЕЦ КАК ЗаказКлиента
		|	 
		|ПОМЕСТИТЬ КешДокументовПродаж
		|ИЗ
		|	Документ.РеализацияТоваровУслуг КАК РТиУ
		|	
		|ВНУТРЕННЕЕ СОЕДИНЕНИЕ ЗаявкиСервисногоЦентраВПериоде КАК ЗаявкиСервисногоЦентраВПериоде
		|ПО	ЗаявкиСервисногоЦентраВПериоде.ЗаявкаСервисногоЦентра = РТиУ.ЗаявкаСервисногоЦентра
		|
		|ГДЕ
		|	РТиУ.Проведен 		 = Истина
		|И	РТиУ.ПометкаУдаления = Ложь
		|И	РТиУ.Партнер НЕ В (ВЫБРАТЬ Партнер ИЗ КешВендоры)
		|
		|ИНДЕКСИРОВАТЬ ПО
		|	ЗаказКлиента		
		|;
		////////////////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ КешВендоры;
		////////////////////////////////////////////////////////////////////////////////////////////
		// 4.
		|ВЫБРАТЬ
		|	ДокументыПродаж.ЗаявкаСервисногоЦентра КАК ЗаявкаСервисногоЦентра,
		|	ДокументыПродаж.Регистратор КАК Регистратор,
		|	ДокументыПродаж.Регистратор.Дата КАК Период,
		|	ВЫРАЗИТЬ(ДокументыПродаж.ЗаказКлиента КАК Документ.РеализацияТоваровУслуг) КАК ЗаказКлиента,
		|	IsNull(ВИСП.СуммаВыручкиОборот, 0)		КАК ВыручкаUSD,
		|	IsNull(ВИСП.СебестоимостьОборот, 0)		КАК СебестоимостьUSD,
		|	IsNull(ВИСП.СуммаВыручкиРеглОборот, 0)	КАК ВыручкаUAH,
		|	IsNull(ВИСП.СебестоимостьРеглОборот, 0) КАК СебестоимостьUAH
	//|ПОМЕСТИТЬ ОплаченныеДокументыПоЗаказамНакладным
		|ИЗ
		|	КешДокументовПродаж	КАК ДокументыПродаж
		|	
		|ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.РасчетыСКлиентами.Остатки(, ЗаказКлиента В (	ВЫБРАТЬ 
		|																					ЗаказКлиента 
		|																				ИЗ 
		|																					КешДокументовПродаж
		|																				ГДЕ
		|																					ЗаказКлиента Ссылка Документ.РеализацияТоваровУслуг)) КАК РасчетыСКлиентами
		|ПО	РасчетыСКлиентами.ЗаказКлиента = ДокументыПродаж.ЗаказКлиента
		|
		|ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.ВыручкаИСебестоимостьПродаж.Обороты(, , , ЗаказКлиента В (	ВЫБРАТЬ 
		|																					ЗаказКлиента 
		|																				ИЗ 
		|																					КешДокументовПродаж
		|																				ГДЕ
		|																					ЗаказКлиента Ссылка Документ.РеализацияТоваровУслуг)) КАК ВИСП
		|ПО	ВЫРАЗИТЬ(ВИСП.ЗаказКлиента КАК Документ.РеализацияТоваровУслуг) = ВЫРАЗИТЬ(ДокументыПродаж.ЗаказКлиента КАК Документ.РеализацияТоваровУслуг)	 
		|
		|ГДЕ
		|	ДокументыПродаж.ЗаказКлиента Ссылка Документ.РеализацияТоваровУслуг
		|И	IsNull(РасчетыСКлиентами.КОплатеОстаток, 0) <= 0	
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ
		|	ДокументыПродаж.ЗаявкаСервисногоЦентра,
		|	ДокументыПродаж.Регистратор,
		|	ДокументыПродаж.Регистратор.Дата,
		|	ВЫРАЗИТЬ(ДокументыПродаж.ЗаказКлиента КАК Документ.ЗаказКлиента),
		|	IsNull(ВИСП.СуммаВыручкиОборот, 0),
		|	IsNull(ВИСП.СебестоимостьОборот, 0),
		|	IsNull(ВИСП.СуммаВыручкиРеглОборот, 0),
		|	IsNull(ВИСП.СебестоимостьРеглОборот, 0)
		|ИЗ
		|	КешДокументовПродаж	КАК ДокументыПродаж
		|	
		|ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.РасчетыСКлиентами.Остатки(, ЗаказКлиента В (	ВЫБРАТЬ 
		|																					ЗаказКлиента 
		|																				ИЗ 
		|																					КешДокументовПродаж
		|																				ГДЕ
		|																					ЗаказКлиента Ссылка Документ.ЗаказКлиента)) КАК РасчетыСКлиентами
		|ПО	РасчетыСКлиентами.ЗаказКлиента = ДокументыПродаж.ЗаказКлиента	 
		|
		|ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.ВыручкаИСебестоимостьПродаж.Обороты(, , , ЗаказКлиента В (	ВЫБРАТЬ 
		|																					ЗаказКлиента 
		|																				ИЗ 
		|																					КешДокументовПродаж
		|																				ГДЕ
		|																					ЗаказКлиента Ссылка Документ.ЗаказКлиента)) КАК ВИСП
		|ПО	ВЫРАЗИТЬ(ВИСП.ЗаказКлиента КАК Документ.ЗаказКлиента) = ВЫРАЗИТЬ(ДокументыПродаж.ЗаказКлиента КАК Документ.ЗаказКлиента)
		|
		|ГДЕ
		|	ДокументыПродаж.ЗаказКлиента Ссылка Документ.ЗаказКлиента
		|И	IsNull(РасчетыСКлиентами.КОплатеОстаток, 0) <= 0
		|
		|;
		////////////////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ КешДокументовПродаж;
		////////////////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ ЗаявкиСервисногоЦентраВПериоде;
		////////////////////////////////////////////////////////////////////////////////////////////
		|";
	Возврат ТекстЗапроса;
	
КонецФункции // ПолучитьТекстЗапросаРентабельностиЗаявокСервисногоЦентра()

#КонецОбласти

#Область  СведенияОВнешнейОбработке

Функция СведенияОВнешнейОбработке() Экспорт
	
	Версия = "0.0.2";
	
	// Объявим переменную, в которой мы сохраним и вернем "наружу" необходимые данные
    ПараметрыРегистрации = Новый Структура;

    // Объявим еще одну переменную, которая нам потребуется ниже
    МассивНазначений = Новый Массив;
    
    // Первый параметр, который мы должны указать - это какой вид обработки системе должна зарегистрировать. 
    // Допустимые типы: ДополнительнаяОбработка, ДополнительныйОтчет, ЗаполнениеОбъекта, Отчет, ПечатнаяФорма, СозданиеСвязанныхОбъектов
    ПараметрыРегистрации.Вставить("Вид", "ДополнительнаяОбработка");

    // Теперь нам необходимо передать в виде массива имен, к чему будет подключена наша ВПФ
    // Имейте ввиду, что можно задать имя в таком виде: Документ.* - в этом случае обработка будет подключена ко всем документам в системе, 
    // которые поддерживают механизм ВПФ
	//СчитатьДокументыНазначений(МассивНазначений);
	
	
	ПараметрыРегистрации.Вставить("Назначение", Новый Массив);
    
    // Теперь зададим имя, под которым ВПФ будет зарегистрирована в справочнике внешних обработок
    ПараметрыРегистрации.Вставить("Наименование", "Регл. обновление рентабельности ЗСЦ");
    
    // Зададим право обработке на использование безопасного режима. Более подробно можно узнать в справке к платформе (метод УстановитьБезопасныйРежим)
    ПараметрыРегистрации.Вставить("БезопасныйРежим", Ложь);

    // Следующие два параметра играют больше информационную роль, т.е. это то, что будет видеть пользователь в информации к обработке
    ПараметрыРегистрации.Вставить("Версия", Версия);    
    ПараметрыРегистрации.Вставить("Информация", "Обработка используется для регламентного обновление рентабельности ЗСЦ [" + Версия + "]");
    
    // Создадим таблицу команд (подробнее смотрим ниже)
    ТаблицаКоманд = ПолучитьТаблицуКоманд();
    
    // Добавим команду в таблицу
    ДобавитьКоманду(ТаблицаКоманд, "Форма обновления рентабельности ЗСЦ [" + Версия + "]", "РЗСЦ", "ОткрытиеФормы", Ложь, "РЗСЦ");
	ДобавитьКоманду(ТаблицаКоманд, "Регл. обновление рентабельности ЗСЦ [" + Версия + "]", "ВыполнитьОбновлениеРентабельности();", "ВызовСерверногоМетода");
    
    // Сохраним таблицу команд в параметры регистрации обработки
    ПараметрыРегистрации.Вставить("Команды", ТаблицаКоманд);
    
    // Теперь вернем системе наши параметры
    Возврат ПараметрыРегистрации;
КонецФункции

Функция ПолучитьТаблицуКоманд()

   // Создадим пустую таблицу команд и колонки в ней
   Команды = Новый ТаблицаЗначений;

   // Как будет выглядеть описание печатной формы для пользователя
   Команды.Колонки.Добавить("Представление", Новый ОписаниеТипов("Строка")); 

   // Имя нашего макета, что бы могли отличить вызванную команду в обработке печати
   Команды.Колонки.Добавить("Идентификатор", Новый ОписаниеТипов("Строка"));

   // Тут задается, как должна вызваться команда обработки
   // Возможные варианты:
   // - ОткрытиеФормы - в этом случае в колонке идентификатор должно быть указано имя формы, которое должна будет открыть система
   // - ВызовКлиентскогоМетода - вызвать клиентскую экспортную процедуру из модуля формы обработки
   // - ВызовСерверногоМетода - вызвать серверную экспортную процедуру из модуля объекта обработки
   Команды.Колонки.Добавить("Использование", Новый ОписаниеТипов("Строка"));

   // Следующий параметр указывает, необходимо ли показывать оповещение при начале и завершению работы обработки. Не имеет смысла при открытии формы
   Команды.Колонки.Добавить("ПоказыватьОповещение", Новый ОписаниеТипов("Булево"));

   // Для печатной формы должен содержать строку ПечатьMXL 
   Команды.Колонки.Добавить("Модификатор", Новый ОписаниеТипов("Строка"));
   
   Возврат Команды;
   
КонецФункции

Процедура ДобавитьКоманду(ТаблицаКоманд, Представление, Идентификатор, Использование, ПоказыватьОповещение = Ложь, Модификатор = "")
  // Добавляем команду в таблицу команд по переданному описанию.
  // Параметры и их значения можно посмотреть в функции ПолучитьТаблицуКоманд
  НоваяКоманда = ТаблицаКоманд.Добавить();
  НоваяКоманда.Представление = Представление;
  НоваяКоманда.Идентификатор = Идентификатор;
  НоваяКоманда.Использование = Использование;
  НоваяКоманда.ПоказыватьОповещение = ПоказыватьОповещение;
  НоваяКоманда.Модификатор = Модификатор;

КонецПроцедуры

Процедура ВыполнитьКоманду(Индентификатор) Экспорт
	Выполнить(Индентификатор);	
КонецПроцедуры

#КонецОбласти
