
&НаКлиенте
Процедура ПриИзмененииТЗТоваров(Элемент)
	
	Массив = Новый Массив;
	Массив.Добавить(Элемент);
	ВыполнитьДействиеПоУмолчанию(Элемент.Имя+"."+"ПриИзменении", Массив);
	ТекущиеДанные	= Элементы.Товары.ТекущиеДанные;
	
	Если ТекущиеДанные = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	ТоварыDDPПриИзмененииНаСервере(ТекущиеДанные.НомерСтроки-1);
	
	ОбновитьОтклоненияОтЗаказаВСтроке(ТекущиеДанные, Объект.ПоступлениеПоЗаказам);
	
	РассчитатьИтоговыеПоказателиПоступления(ЭтаФорма);
	
	Если Объект.ПоступлениеПоЗаказам Тогда
		ОбновитьНадписьОтклоненийОтЦенЗаказа();
	КонецЕсли;
	
	ОбновитьЗависимыеРеквизитыФормы();
	
КонецПроцедуры


&НаСервере
Процедура ТоварыDDPПриИзмененииНаСервере(НомерСтроки)  
	
	УслугаDDP 		= Справочники.Номенклатура.ПолучитьСсылку(Новый УникальныйИдентификатор("8014b949-4cca-4dc2-808e-e6fb286406d2"));	
	ВалютаDDP		= Справочники.Валюты.ПолучитьСсылку(Новый УникальныйИдентификатор("f255395e-a9e2-11e3-80c2-001e676b0174"));
	
	КурсыВалюты 	= РаботаСКурсамиВалют.ПолучитьКурсВалюты(ВалютаDDP, Объект.Дата);
	КурсDDP 		= КурсыВалюты.Курс / КурсыВалюты.Кратность;				
	
	КурсыВалюты		= РаботаСКурсамиВалют.ПолучитьКурсВалюты(Константы.ВалютаУправленческогоУчета.Получить(), Объект.Дата);
	КурсУпр 		= КурсыВалюты.Курс / КурсыВалюты.Кратность;	
	ТекущаяСтрока   = Объект.Товары[НомерСтроки];

	Если КурсDDP>=КурсУпр Тогда 
		ТекущаяСтрока.DDP = Не ТекущаяСтрока.DDP;
		Возврат;
	КонецЕсли;
	
	ТаблицаДляОброботки = ПолучитьДанныеДляИзменений();
	
	Для Каждого СтрокаТЧ Из ТаблицаДляОброботки Цикл 
	    ТекущаяСтрока = Объект.Товары[СтрокаТЧ.НомерСтроки-1];
		
		Если СтрокаТЧ.КурсоваяРазницаDDP <> 0 И СтрокаТЧ.СуммаСDDP <> 0 Тогда 
			Если Объект.НалогообложениеНДС = Перечисления.ТипыНалогообложенияНДС.ПродажаОблагаетсяНДС И Не Объект.ЦенаВключаетНДС  Тогда 
				ТекПроцентНДС		= ЦенообразованиеКлиентСервер.ПолучитьСтавкуНДСЧислом(ТекущаяСтрока.СтавкаНДС);
				СуммаНДС 			= ЦенообразованиеКлиентСервер.РассчитатьСуммуНДС(ТекущаяСтрока.СуммаСDDP, ТекПроцентНДС, Не Объект.ЦенаВключаетНДС);
				ТекущаяСтрока.Цена	= (ТекущаяСтрока.СуммаСDDP - СуммаНДС) / ТекущаяСтрока.КоличествоУпаковок;
			Иначе 
				ТекущаяСтрока.Цена	= ТекущаяСтрока.СуммаСDDP / ТекущаяСтрока.КоличествоУпаковок;
			КонецЕсли; 
			
			ПриИзменениеЦеныОбработатьСтрокуТЧ(ТекущаяСтрока);
			
			Если Не ТекущаяСтрока.DDP Тогда 
				ТекущаяСтрока.КурсоваяРазницаDDP 	= 0;
				ТекущаяСтрока.СуммаСDDP 			= 0;
				Продолжить;
			Иначе 
				УдалитьУслугуDDP(УслугаDDP);
			КонецЕсли;
		КонецЕсли;
		
		ТекущаяСтрока.СуммаСDDP 			= ТекущаяСтрока.СуммаСНДС;
		ТекущаяСтрока.Цена  				= ТекущаяСтрока.Цена*КурсDDP/КурсУпр;
		ПриИзменениеЦеныОбработатьСтрокуТЧ(ТекущаяСтрока);
		ТекущаяСтрока.КурсоваяРазницаDDP 	= ТекущаяСтрока.СуммаСDDP - ТекущаяСтрока.СуммаСНДС;
	КонецЦикла;
	УдалитьУслугуDDP(УслугаDDP);
КонецПроцедуры	

&НаСервере
Функция ПолучитьДанныеДляИзменений()
	Запрос = Новый Запрос("ВЫБРАТЬ
	                      |	ПоступлениеТоваровУслугТовары.НомерСтроки,
	                      |	ПоступлениеТоваровУслугТовары.DDP,
	                      |	ПоступлениеТоваровУслугТовары.КурсоваяРазницаDDP,
	                      |	ПоступлениеТоваровУслугТовары.СуммаСDDP
	                      |ПОМЕСТИТЬ КешТовары
	                      |ИЗ
	                      |	&Товары КАК ПоступлениеТоваровУслугТовары
	                      |;
	                      |
	                      |////////////////////////////////////////////////////////////////////////////////
	                      |ВЫБРАТЬ
	                      |	КешТовары.НомерСтроки,
	                      |	КешТовары.DDP,
	                      |	КешТовары.КурсоваяРазницаDDP,
	                      |	КешТовары.СуммаСDDP
	                      |ИЗ
	                      |	КешТовары КАК КешТовары
	                      |ГДЕ
	                      |	(НЕ КешТовары.DDP
	                      |				И КешТовары.СуммаСDDP <> 0
	                      |			ИЛИ КешТовары.DDP
	                      |				И КешТовары.СуммаСDDP = 0)");
					
	Запрос.УстановитьПараметр("Товары",Объект.Товары.Выгрузить());
	УслугаDDP = Справочники.Номенклатура.ПолучитьСсылку(Новый УникальныйИдентификатор("8014b949-4cca-4dc2-808e-e6fb286406d2"));	
	Запрос.УстановитьПараметр("Номенклатура",УслугаDDP);
	РезультатЗапроса = Запрос.Выполнить();
	ТаблицаИзРезультатаЗапроса = РезультатЗапроса.Выгрузить();
	
	Возврат ТаблицаИзРезультатаЗапроса;
	
КонецФункции

&НаСервере
Процедура УдалитьУслугуDDP(УслугаDDP) 
		КурсоваяРазницаDDP = Объект.Товары.Итог("КурсоваяРазницаDDP");
	
		Массив = Объект.Товары.НайтиСтроки(Новый	Структура("Номенклатура",УслугаDDP));
		Если Массив.Количество() Тогда
			СтрокаУслугаDDP 						= Массив[0]; 
		ИначеЕсли Не КурсоваяРазницаDDP = 0 Тогда
			СтрокаУслугаDDP = Объект.Товары.Добавить();
			СтрокаУслугаDDP.Номенклатура			= УслугаDDP;
			СтатьяРасходовУникальныйИдентификатор	= Новый УникальныйИдентификатор("c18cfac8-ae9b-11e3-80c2-001e676b0174");
			СтрокаУслугаDDP.СтатьяРасходов			= ПланыВидовХарактеристик.СтатьиРасходов.ПолучитьСсылку(СтатьяРасходовУникальныйИдентификатор);
		КонецЕсли;
		
		Если СтрокаУслугаDDP <> Неопределено Тогда 
			Если КурсоваяРазницаDDP = 0 Тогда
				Объект.Товары.Удалить(СтрокаУслугаDDP);
			КонецЕсли;
			СтрокаУслугаDDP.Цена  						= КурсоваяРазницаDDP;
			СтрокаУслугаDDP.СтавкаНДС					= Перечисления.СтавкиНДС.БезНДС;
			СтрокаУслугаDDP.КоличествоУпаковок			= 1;
			СтрокаУслугаDDP.Количество 					= 1;
			ПриИзменениеЦеныОбработатьСтрокуТЧ(СтрокаУслугаDDP);
		КонецЕсли;
КонецПроцедуры

